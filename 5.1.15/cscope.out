cscope 15 $HOME/0528/5.1.15               0000552648
	@core.c

7 
	~<löux/blkdev.h
>

8 
	~<löux/blk-mq.h
>

9 
	~<löux/dñay.h
>

10 
	~<löux/î∫o.h
>

11 
	~<löux/hdªg.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/moduÀ.h
>

14 
	~<löux/li°_s‹t.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/ty≥s.h
>

17 
	~<löux/¥.h
>

18 
	~<löux/±ø˚.h
>

19 
	~<löux/nvme_io˘l.h
>

20 
	~<löux/t10-pi.h
>

21 
	~<löux/pm_qos.h
>

22 
	~<asm/u«lig√d.h
>

24 
	#CREATE_TRACE_POINTS


	)

25 
	~"åa˚.h
"

27 
	~"nvme.h
"

28 
	~"Ábrics.h
"

30 
	#NVME_MINORS
 (1U << 
MINORBITS
)

	)

32 
	gadmö_timeout
 = 60;

33 
moduÀ_∑øm
(
admö_timeout
, 
uöt
, 0644);

34 
MODULE_PARM_DESC
(
admö_timeout
, "timeout in seconds forádmin commands");

35 
EXPORT_SYMBOL_GPL
(
admö_timeout
);

37 
	gnvme_io_timeout
 = 30;

38 
moduÀ_∑øm_«med
(
io_timeout
, 
nvme_io_timeout
, 
uöt
, 0644);

39 
MODULE_PARM_DESC
(
io_timeout
, "timeout in seconds for I/O");

40 
EXPORT_SYMBOL_GPL
(
nvme_io_timeout
);

42 
	gshutdown_timeout
 = 5;

43 
moduÀ_∑øm
(
shutdown_timeout
, 
byã
, 0644);

44 
MODULE_PARM_DESC
(
shutdown_timeout
, "timeout in seconds for controller shutdown");

46 
u8
 
	gnvme_max_ªåõs
 = 5;

47 
moduÀ_∑øm_«med
(
max_ªåõs
, 
nvme_max_ªåõs
, 
byã
, 0644);

48 
MODULE_PARM_DESC
(
max_ªåõs
, "maxÇumber ofÑetriesá command may have");

50 
	gdeÁu…_ps_max_œãncy_us
 = 100000;

51 
moduÀ_∑øm
(
deÁu…_ps_max_œãncy_us
, 
ul⁄g
, 0644);

52 
MODULE_PARM_DESC
(
deÁu…_ps_max_œãncy_us
,

55 
boﬁ
 
	gf‹˚_≠°
;

56 
moduÀ_∑øm
(
f‹˚_≠°
, 
boﬁ
, 0644);

57 
MODULE_PARM_DESC
(
f‹˚_≠°
, "allow APST forÇewlyÉnumerated devicesÉven if quirked off");

59 
boﬁ
 
	g°ªams
;

60 
moduÀ_∑øm
(
°ªams
, 
boﬁ
, 0644);

61 
MODULE_PARM_DESC
(
°ªams
, "turn on support for Streams write directives");

74 
w‹kqueue_°ru˘
 *
	gnvme_wq
;

75 
EXPORT_SYMBOL_GPL
(
nvme_wq
);

77 
w‹kqueue_°ru˘
 *
	gnvme_ª£t_wq
;

78 
EXPORT_SYMBOL_GPL
(
nvme_ª£t_wq
);

80 
w‹kqueue_°ru˘
 *
	gnvme_dñëe_wq
;

81 
EXPORT_SYMBOL_GPL
(
nvme_dñëe_wq
);

83 
DEFINE_IDA
(
nvme_subsy°ems_ida
);

84 
LIST_HEAD
(
nvme_subsy°ems
);

85 
DEFINE_MUTEX
(
nvme_subsy°ems_lock
);

87 
DEFINE_IDA
(
nvme_ö°™˚_ida
);

88 
dev_t
 
	gnvme_chr_devt
;

89 
˛ass
 *
	gnvme_˛ass
;

90 
˛ass
 *
	gnvme_subsys_˛ass
;

92 
nvme_ªvÆid©e_disk
(
gídisk
 *
disk
);

93 
nvme_put_subsy°em
(
nvme_subsy°em
 *
subsys
);

94 
nvme_ªmove_övÆid_«me•a˚s
(
nvme_˘æ
 *
˘æ
,

95 
nsid
);

97 
	$nvme_£t_queue_dyög
(
nvme_ns
 *
ns
)

103 i‡(!
ns
->
disk
 || 
	`ã°_™d_£t_bô
(
NVME_NS_DEAD
, &ns->
Êags
))

105 
	`ªvÆid©e_disk
(
ns
->
disk
);

106 
	`blk_£t_queue_dyög
(
ns
->
queue
);

108 
	`blk_mq_unquõs˚_queue
(
ns
->
queue
);

109 
	}
}

111 
	$nvme_queue_sˇn
(
nvme_˘æ
 *
˘æ
)

116 i‡(
˘æ
->
°©e
 =
NVME_CTRL_LIVE
)

117 
	`queue_w‹k
(
nvme_wq
, &
˘æ
->
sˇn_w‹k
);

118 
	}
}

120 
	$nvme_ª£t_˘æ
(
nvme_˘æ
 *
˘æ
)

122 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_RESETTING
))

123  -
EBUSY
;

124 i‡(!
	`queue_w‹k
(
nvme_ª£t_wq
, &
˘æ
->
ª£t_w‹k
))

125  -
EBUSY
;

127 
	}
}

128 
EXPORT_SYMBOL_GPL
(
nvme_ª£t_˘æ
);

130 
	$nvme_ª£t_˘æ_sync
(
nvme_˘æ
 *
˘æ
)

132 
ªt
;

134 
ªt
 = 
	`nvme_ª£t_˘æ
(
˘æ
);

135 i‡(!
ªt
) {

136 
	`Êush_w‹k
(&
˘æ
->
ª£t_w‹k
);

137 i‡(
˘æ
->
°©e
 !
NVME_CTRL_LIVE
 &&

138 
˘æ
->
°©e
 !
NVME_CTRL_ADMIN_ONLY
)

139 
ªt
 = -
ENETRESET
;

142  
ªt
;

143 
	}
}

144 
EXPORT_SYMBOL_GPL
(
nvme_ª£t_˘æ_sync
);

146 
	$nvme_do_dñëe_˘æ
(
nvme_˘æ
 *
˘æ
)

148 
	`dev_öfo
(
˘æ
->
devi˚
,

149 "Removög cål: NQN \"%s\"\n", 
˘æ
->
›ts
->
subsy¢qn
);

151 
	`Êush_w‹k
(&
˘æ
->
ª£t_w‹k
);

152 
	`nvme_°›_˘æ
(
˘æ
);

153 
	`nvme_ªmove_«me•a˚s
(
˘æ
);

154 
˘æ
->
›s
->
	`dñëe_˘æ
(ctrl);

155 
	`nvme_unöô_˘æ
(
˘æ
);

156 
	`nvme_put_˘æ
(
˘æ
);

157 
	}
}

159 
	$nvme_dñëe_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

161 
nvme_˘æ
 *
˘æ
 =

162 
	`c⁄èöî_of
(
w‹k
, 
nvme_˘æ
, 
dñëe_w‹k
);

164 
	`nvme_do_dñëe_˘æ
(
˘æ
);

165 
	}
}

167 
	$nvme_dñëe_˘æ
(
nvme_˘æ
 *
˘æ
)

169 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_DELETING
))

170  -
EBUSY
;

171 i‡(!
	`queue_w‹k
(
nvme_dñëe_wq
, &
˘æ
->
dñëe_w‹k
))

172  -
EBUSY
;

174 
	}
}

175 
EXPORT_SYMBOL_GPL
(
nvme_dñëe_˘æ
);

177 
	$nvme_dñëe_˘æ_sync
(
nvme_˘æ
 *
˘æ
)

179 
ªt
 = 0;

185 
	`nvme_gë_˘æ
(
˘æ
);

186 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_DELETING
))

187 
ªt
 = -
EBUSY
;

188 i‡(!
ªt
)

189 
	`nvme_do_dñëe_˘æ
(
˘æ
);

190 
	`nvme_put_˘æ
(
˘æ
);

191  
ªt
;

192 
	}
}

194 
ölöe
 
boﬁ
 
	$nvme_ns_has_pi
(
nvme_ns
 *
ns
)

196  
ns
->
pi_ty≥
 &&Çs->
ms
 =(
t10_pi_tu∂e
);

197 
	}
}

199 
blk_°©us_t
 
	$nvme_îr‹_°©us
(
ªque°
 *
ªq
)

201 
	`nvme_ªq
(
ªq
)->
°©us
 & 0x7ff) {

202 
NVME_SC_SUCCESS
:

203  
BLK_STS_OK
;

204 
NVME_SC_CAP_EXCEEDED
:

205  
BLK_STS_NOSPC
;

206 
NVME_SC_LBA_RANGE
:

207  
BLK_STS_TARGET
;

208 
NVME_SC_BAD_ATTRIBUTES
:

209 
NVME_SC_ONCS_NOT_SUPPORTED
:

210 
NVME_SC_INVALID_OPCODE
:

211 
NVME_SC_INVALID_FIELD
:

212 
NVME_SC_INVALID_NS
:

213  
BLK_STS_NOTSUPP
;

214 
NVME_SC_WRITE_FAULT
:

215 
NVME_SC_READ_ERROR
:

216 
NVME_SC_UNWRITTEN_BLOCK
:

217 
NVME_SC_ACCESS_DENIED
:

218 
NVME_SC_READ_ONLY
:

219 
NVME_SC_COMPARE_FAILED
:

220  
BLK_STS_MEDIUM
;

221 
NVME_SC_GUARD_CHECK
:

222 
NVME_SC_APPTAG_CHECK
:

223 
NVME_SC_REFTAG_CHECK
:

224 
NVME_SC_INVALID_PI
:

225  
BLK_STS_PROTECTION
;

226 
NVME_SC_RESERVATION_CONFLICT
:

227  
BLK_STS_NEXUS
;

229  
BLK_STS_IOERR
;

231 
	}
}

233 
ölöe
 
boﬁ
 
	$nvme_ªq_√eds_ªåy
(
ªque°
 *
ªq
)

235 i‡(
	`blk_n‹ëry_ªque°
(
ªq
))

236  
Ál£
;

237 i‡(
	`nvme_ªq
(
ªq
)->
°©us
 & 
NVME_SC_DNR
)

238  
Ál£
;

239 i‡(
	`nvme_ªq
(
ªq
)->
ªåõs
 >
nvme_max_ªåõs
)

240  
Ál£
;

241  
åue
;

242 
	}
}

244 
	$nvme_ªåy_ªq
(
ªque°
 *
ªq
)

246 
nvme_ns
 *
ns
 = 
ªq
->
q
->
queued©a
;

247 
dñay
 = 0;

248 
u16
 
¸d
;

251 
¸d
 = (
	`nvme_ªq
(
ªq
)->
°©us
 & 
NVME_SC_CRD
) >> 11;

252 i‡(
ns
 && 
¸d
)

253 
dñay
 = 
ns
->
˘æ
->
¸dt
[
¸d
 - 1] * 100;

255 
	`nvme_ªq
(
ªq
)->
ªåõs
++;

256 
	`blk_mq_ªqueue_ªque°
(
ªq
, 
Ál£
);

257 
	`blk_mq_dñay_kick_ªqueue_li°
(
ªq
->
q
, 
dñay
);

258 
	}
}

260 
	$nvme_com∂ëe_rq
(
ªque°
 *
ªq
)

262 
blk_°©us_t
 
°©us
 = 
	`nvme_îr‹_°©us
(
ªq
);

264 
	`åa˚_nvme_com∂ëe_rq
(
ªq
);

266 i‡(
	`nvme_ªq
(
ªq
)->
˘æ
->
kas
)

267 
	`nvme_ªq
(
ªq
)->
˘æ
->
comp_£í
 = 
åue
;

269 i‡(
	`u∆ikñy
(
°©us
 !
BLK_STS_OK
 && 
	`nvme_ªq_√eds_ªåy
(
ªq
))) {

270 i‡((
ªq
->
cmd_Êags
 & 
REQ_NVME_MPATH
) &&

271 
	`blk_∑th_îr‹
(
°©us
)) {

272 
	`nvme_Áûovî_ªq
(
ªq
);

276 i‡(!
	`blk_queue_dyög
(
ªq
->
q
)) {

277 
	`nvme_ªåy_ªq
(
ªq
);

281 
	`blk_mq_íd_ªque°
(
ªq
, 
°©us
);

282 
	}
}

283 
EXPORT_SYMBOL_GPL
(
nvme_com∂ëe_rq
);

285 
boﬁ
 
	$nvme_ˇn˚l_ªque°
(
ªque°
 *
ªq
, *
d©a
, 
boﬁ
 
ª£rved
)

287 
	`dev_dbg_øãlimôed
(((
nvme_˘æ
 *Ë
d©a
)->
devi˚
,

288 "C™˚Œög I/O %d", 
ªq
->
èg
);

290 
	`nvme_ªq
(
ªq
)->
°©us
 = 
NVME_SC_ABORT_REQ
;

291 
	`blk_mq_com∂ëe_ªque°_sync
(
ªq
);

292  
åue
;

293 
	}
}

294 
EXPORT_SYMBOL_GPL
(
nvme_ˇn˚l_ªque°
);

296 
boﬁ
 
	$nvme_ch™ge_˘æ_°©e
(
nvme_˘æ
 *
˘æ
,

297 
nvme_˘æ_°©e
 
√w_°©e
)

299 
nvme_˘æ_°©e
 
ﬁd_°©e
;

300 
Êags
;

301 
boﬁ
 
ch™ged
 = 
Ál£
;

303 
	`•ö_lock_úqßve
(&
˘æ
->
lock
, 
Êags
);

305 
ﬁd_°©e
 = 
˘æ
->
°©e
;

306 
√w_°©e
) {

307 
NVME_CTRL_ADMIN_ONLY
:

308 
ﬁd_°©e
) {

309 
NVME_CTRL_CONNECTING
:

310 
ch™ged
 = 
åue
;

316 
NVME_CTRL_LIVE
:

317 
ﬁd_°©e
) {

318 
NVME_CTRL_NEW
:

319 
NVME_CTRL_RESETTING
:

320 
NVME_CTRL_CONNECTING
:

321 
ch™ged
 = 
åue
;

327 
NVME_CTRL_RESETTING
:

328 
ﬁd_°©e
) {

329 
NVME_CTRL_NEW
:

330 
NVME_CTRL_LIVE
:

331 
NVME_CTRL_ADMIN_ONLY
:

332 
ch™ged
 = 
åue
;

338 
NVME_CTRL_CONNECTING
:

339 
ﬁd_°©e
) {

340 
NVME_CTRL_NEW
:

341 
NVME_CTRL_RESETTING
:

342 
ch™ged
 = 
åue
;

348 
NVME_CTRL_DELETING
:

349 
ﬁd_°©e
) {

350 
NVME_CTRL_LIVE
:

351 
NVME_CTRL_ADMIN_ONLY
:

352 
NVME_CTRL_RESETTING
:

353 
NVME_CTRL_CONNECTING
:

354 
ch™ged
 = 
åue
;

360 
NVME_CTRL_DEAD
:

361 
ﬁd_°©e
) {

362 
NVME_CTRL_DELETING
:

363 
ch™ged
 = 
åue
;

373 i‡(
ch™ged
)

374 
˘æ
->
°©e
 = 
√w_°©e
;

376 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
lock
, 
Êags
);

377 i‡(
ch™ged
 && 
˘æ
->
°©e
 =
NVME_CTRL_LIVE
)

378 
	`nvme_kick_ªqueue_li°s
(
˘æ
);

379  
ch™ged
;

380 
	}
}

381 
EXPORT_SYMBOL_GPL
(
nvme_ch™ge_˘æ_°©e
);

383 
	$nvme_‰ì_ns_hód
(
kªf
 *
ªf
)

385 
nvme_ns_hód
 *
hód
 =

386 
	`c⁄èöî_of
(
ªf
, 
nvme_ns_hód
,Ñef);

388 
	`nvme_m∑th_ªmove_disk
(
hód
);

389 
	`ida_sim∂e_ªmove
(&
hód
->
subsys
->
ns_ida
, hód->
ö°™˚
);

390 
	`li°_dñ_öô
(&
hód
->
íåy
);

391 
	`˛ónup_§cu_°ru˘_quõs˚d
(&
hód
->
§cu
);

392 
	`nvme_put_subsy°em
(
hód
->
subsys
);

393 
	`k‰ì
(
hód
);

394 
	}
}

396 
	$nvme_put_ns_hód
(
nvme_ns_hód
 *
hód
)

398 
	`kªf_put
(&
hód
->
ªf
, 
nvme_‰ì_ns_hód
);

399 
	}
}

401 
	$nvme_‰ì_ns
(
kªf
 *kref)

403 
nvme_ns
 *
ns
 = 
	`c⁄èöî_of
(
kªf
, nvme_ns, kref);

405 i‡(
ns
->
ndev
)

406 
	`nvme_nvm_uƒegi°î
(
ns
);

408 
	`put_disk
(
ns
->
disk
);

409 
	`nvme_put_ns_hód
(
ns
->
hód
);

410 
	`nvme_put_˘æ
(
ns
->
˘æ
);

411 
	`k‰ì
(
ns
);

412 
	}
}

414 
	$nvme_put_ns
(
nvme_ns
 *
ns
)

416 
	`kªf_put
(&
ns
->
kªf
, 
nvme_‰ì_ns
);

417 
	}
}

419 
ölöe
 
	$nvme_˛ór_nvme_ªque°
(
ªque°
 *
ªq
)

421 i‡(!(
ªq
->
rq_Êags
 & 
RQF_DONTPREP
)) {

422 
	`nvme_ªq
(
ªq
)->
ªåõs
 = 0;

423 
	`nvme_ªq
(
ªq
)->
Êags
 = 0;

424 
ªq
->
rq_Êags
 |
RQF_DONTPREP
;

426 
	}
}

428 
ªque°
 *
	$nvme_Æloc_ªque°
(
ªque°_queue
 *
q
,

429 
nvme_comm™d
 *
cmd
, 
blk_mq_ªq_Êags_t
 
Êags
, 
qid
)

431 
›
 = 
	`nvme_is_wrôe
(
cmd
Ë? 
REQ_OP_DRV_OUT
 : 
REQ_OP_DRV_IN
;

432 
ªque°
 *
ªq
;

434 i‡(
qid
 =
NVME_QID_ANY
) {

435 
ªq
 = 
	`blk_mq_Æloc_ªque°
(
q
, 
›
, 
Êags
);

437 
ªq
 = 
	`blk_mq_Æloc_ªque°_h˘x
(
q
, 
›
, 
Êags
,

438 
qid
 ? qid - 1 : 0);

440 i‡(
	`IS_ERR
(
ªq
))

441  
ªq
;

443 
ªq
->
cmd_Êags
 |
REQ_FAILFAST_DRIVER
;

444 
	`nvme_˛ór_nvme_ªque°
(
ªq
);

445 
	`nvme_ªq
(
ªq
)->
cmd
 = cmd;

447  
ªq
;

448 
	}
}

449 
EXPORT_SYMBOL_GPL
(
nvme_Æloc_ªque°
);

451 
	$nvme_toggÀ_°ªams
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
íabÀ
)

453 
nvme_comm™d
 
c
;

455 
	`mem£t
(&
c
, 0, (c));

457 
c
.
dúe˘ive
.
›code
 = 
nvme_admö_dúe˘ive_£nd
;

458 
c
.
dúe˘ive
.
nsid
 = 
	`˝u_to_À32
(
NVME_NSID_ALL
);

459 
c
.
dúe˘ive
.
d›î
 = 
NVME_DIR_SND_ID_OP_ENABLE
;

460 
c
.
dúe˘ive
.
dty≥
 = 
NVME_DIR_IDENTIFY
;

461 
c
.
dúe˘ive
.
tdty≥
 = 
NVME_DIR_STREAMS
;

462 
c
.
dúe˘ive
.
ídú
 = 
íabÀ
 ? 
NVME_DIR_ENDIR
 : 0;

464  
	`nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
c
, 
NULL
, 0);

465 
	}
}

467 
	$nvme_dißbÀ_°ªams
(
nvme_˘æ
 *
˘æ
)

469  
	`nvme_toggÀ_°ªams
(
˘æ
, 
Ál£
);

470 
	}
}

472 
	$nvme_íabÀ_°ªams
(
nvme_˘æ
 *
˘æ
)

474  
	`nvme_toggÀ_°ªams
(
˘æ
, 
åue
);

475 
	}
}

477 
	$nvme_gë_°ªam_∑øms
(
nvme_˘æ
 *
˘æ
,

478 
°ªams_dúe˘ive_∑øms
 *
s
, 
u32
 
nsid
)

480 
nvme_comm™d
 
c
;

482 
	`mem£t
(&
c
, 0, (c));

483 
	`mem£t
(
s
, 0, (*s));

485 
c
.
dúe˘ive
.
›code
 = 
nvme_admö_dúe˘ive_ªcv
;

486 
c
.
dúe˘ive
.
nsid
 = 
	`˝u_to_À32
(nsid);

487 
c
.
dúe˘ive
.
numd
 = 
	`˝u_to_À32
(((*
s
) >> 2) - 1);

488 
c
.
dúe˘ive
.
d›î
 = 
NVME_DIR_RCV_ST_OP_PARAM
;

489 
c
.
dúe˘ive
.
dty≥
 = 
NVME_DIR_STREAMS
;

491  
	`nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
c
, 
s
, (*s));

492 
	}
}

494 
	$nvme_c⁄figuª_dúe˘ives
(
nvme_˘æ
 *
˘æ
)

496 
°ªams_dúe˘ive_∑øms
 
s
;

497 
ªt
;

499 i‡(!(
˘æ
->
ﬂcs
 & 
NVME_CTRL_OACS_DIRECTIVES
))

501 i‡(!
°ªams
)

504 
ªt
 = 
	`nvme_íabÀ_°ªams
(
˘æ
);

505 i‡(
ªt
)

506  
ªt
;

508 
ªt
 = 
	`nvme_gë_°ªam_∑øms
(
˘æ
, &
s
, 
NVME_NSID_ALL
);

509 i‡(
ªt
)

510  
ªt
;

512 
˘æ
->
nsß
 = 
	`À16_to_˝u
(
s
.nssa);

513 i‡(
˘æ
->
nsß
 < 
BLK_MAX_WRITE_HINTS
 - 1) {

514 
	`dev_öfo
(
˘æ
->
devi˚
, "too few streams (%u)ávailable\n",

515 
˘æ
->
nsß
);

516 
	`nvme_dißbÀ_°ªams
(
˘æ
);

520 
˘æ
->
ƒ_°ªams
 = 
	`mö_t
(, cål->
nsß
, 
BLK_MAX_WRITE_HINTS
 - 1);

521 
	`dev_öfo
(
˘æ
->
devi˚
, "Usög %u såóms\n", cål->
ƒ_°ªams
);

523 
	}
}

529 
	$nvme_assign_wrôe_°ªam
(
nvme_˘æ
 *
˘æ
,

530 
ªque°
 *
ªq
, 
u16
 *
c⁄åﬁ
,

531 
u32
 *
dsmgmt
)

533 
rw_höt
 
°ªamid
 = 
ªq
->
wrôe_höt
;

535 i‡(
°ªamid
 =
WRITE_LIFE_NOT_SET
 || såómid =
WRITE_LIFE_NONE
)

536 
°ªamid
 = 0;

538 
°ªamid
--;

539 i‡(
	`WARN_ON_ONCE
(
°ªamid
 > 
˘æ
->
ƒ_°ªams
))

542 *
c⁄åﬁ
 |
NVME_RW_DTYPE_STREAMS
;

543 *
dsmgmt
 |
°ªamid
 << 16;

546 i‡(
°ªamid
 < 
	`ARRAY_SIZE
(
ªq
->
q
->
wrôe_höts
))

547 
ªq
->
q
->
wrôe_höts
[
°ªamid
] +
	`blk_rq_byãs
(req) >> 9;

548 
	}
}

550 
ölöe
 
	$nvme_£tup_Êush
(
nvme_ns
 *
ns
,

551 
nvme_comm™d
 *
cmnd
)

553 
cmnd
->
comm⁄
.
›code
 = 
nvme_cmd_Êush
;

554 
cmnd
->
comm⁄
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

555 
	}
}

557 
blk_°©us_t
 
	$nvme_£tup_disˇrd
(
nvme_ns
 *
ns
, 
ªque°
 *
ªq
,

558 
nvme_comm™d
 *
cmnd
)

560 
£gmíts
 = 
	`blk_rq_ƒ_disˇrd_£gmíts
(
ªq
), 
n
 = 0;

561 
nvme_dsm_ønge
 *
ønge
;

562 
bio
 *bio;

564 
ønge
 = 
	`kmÆloc_¨øy
(
£gmíts
, (*range),

565 
GFP_ATOMIC
 | 
__GFP_NOWARN
);

566 i‡(!
ønge
) {

572 i‡(
	`ã°_™d_£t_bô_lock
(0, &
ns
->
˘æ
->
disˇrd_∑ge_busy
))

573  
BLK_STS_RESOURCE
;

575 
ønge
 = 
	`∑ge_addªss
(
ns
->
˘æ
->
disˇrd_∑ge
);

578 
	`__rq_f‹_óch_bio
(
bio
, 
ªq
) {

579 
u64
 
¶ba
 = 
	`nvme_block_ƒ
(
ns
, 
bio
->
bi_ôî
.
bi_£˘‹
);

580 
u32
 
∆b
 = 
bio
->
bi_ôî
.
bi_size
 >> 
ns
->
lba_shi·
;

582 i‡(
n
 < 
£gmíts
) {

583 
ønge
[
n
].
ˇâr
 = 
	`˝u_to_À32
(0);

584 
ønge
[
n
].
∆b
 = 
	`˝u_to_À32
(nlb);

585 
ønge
[
n
].
¶ba
 = 
	`˝u_to_À64
(slba);

587 
n
++;

590 i‡(
	`WARN_ON_ONCE
(
n
 !
£gmíts
)) {

591 i‡(
	`vút_to_∑ge
(
ønge
Ë=
ns
->
˘æ
->
disˇrd_∑ge
)

592 
	`˛ór_bô_u∆ock
(0, &
ns
->
˘æ
->
disˇrd_∑ge_busy
);

594 
	`k‰ì
(
ønge
);

595  
BLK_STS_IOERR
;

598 
cmnd
->
dsm
.
›code
 = 
nvme_cmd_dsm
;

599 
cmnd
->
dsm
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

600 
cmnd
->
dsm
.
ƒ
 = 
	`˝u_to_À32
(
£gmíts
 - 1);

601 
cmnd
->
dsm
.
©åibuãs
 = 
	`˝u_to_À32
(
NVME_DSMGMT_AD
);

603 
ªq
->
•ecül_vec
.
bv_∑ge
 = 
	`vút_to_∑ge
(
ønge
);

604 
ªq
->
•ecül_vec
.
bv_off£t
 = 
	`off£t_ö_∑ge
(
ønge
);

605 
ªq
->
•ecül_vec
.
bv_Àn
 = (*
ønge
Ë* 
£gmíts
;

606 
ªq
->
rq_Êags
 |
RQF_SPECIAL_PAYLOAD
;

608  
BLK_STS_OK
;

609 
	}
}

611 
ölöe
 
blk_°©us_t
 
	$nvme_£tup_wrôe_zî€s
(
nvme_ns
 *
ns
,

612 
ªque°
 *
ªq
, 
nvme_comm™d
 *
cmnd
)

614 i‡(
ns
->
˘æ
->
quúks
 & 
NVME_QUIRK_DEALLOCATE_ZEROES
)

615  
	`nvme_£tup_disˇrd
(
ns
, 
ªq
, 
cmnd
);

617 
cmnd
->
wrôe_zî€s
.
›code
 = 
nvme_cmd_wrôe_zî€s
;

618 
cmnd
->
wrôe_zî€s
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

619 
cmnd
->
wrôe_zî€s
.
¶ba
 =

620 
	`˝u_to_À64
(
	`nvme_block_ƒ
(
ns
, 
	`blk_rq_pos
(
ªq
)));

621 
cmnd
->
wrôe_zî€s
.
Àngth
 =

622 
	`˝u_to_À16
((
	`blk_rq_byãs
(
ªq
Ë>> 
ns
->
lba_shi·
) - 1);

623 
cmnd
->
wrôe_zî€s
.
c⁄åﬁ
 = 0;

624  
BLK_STS_OK
;

625 
	}
}

627 
ölöe
 
blk_°©us_t
 
	$nvme_£tup_rw
(
nvme_ns
 *
ns
,

628 
ªque°
 *
ªq
, 
nvme_comm™d
 *
cmnd
)

630 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

631 
u16
 
c⁄åﬁ
 = 0;

632 
u32
 
dsmgmt
 = 0;

634 i‡(
ªq
->
cmd_Êags
 & 
REQ_FUA
)

635 
c⁄åﬁ
 |
NVME_RW_FUA
;

636 i‡(
ªq
->
cmd_Êags
 & (
REQ_FAILFAST_DEV
 | 
REQ_RAHEAD
))

637 
c⁄åﬁ
 |
NVME_RW_LR
;

639 i‡(
ªq
->
cmd_Êags
 & 
REQ_RAHEAD
)

640 
dsmgmt
 |
NVME_RW_DSM_FREQ_PREFETCH
;

642 
cmnd
->
rw
.
›code
 = (
	`rq_d©a_dú
(
ªq
Ë? 
nvme_cmd_wrôe
 : 
nvme_cmd_ªad
);

643 
cmnd
->
rw
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

644 
cmnd
->
rw
.
¶ba
 = 
	`˝u_to_À64
(
	`nvme_block_ƒ
(
ns
, 
	`blk_rq_pos
(
ªq
)));

645 
cmnd
->
rw
.
Àngth
 = 
	`˝u_to_À16
((
	`blk_rq_byãs
(
ªq
Ë>> 
ns
->
lba_shi·
) - 1);

647 i‡(
	`ªq_›
(
ªq
Ë=
REQ_OP_WRITE
 && 
˘æ
->
ƒ_°ªams
)

648 
	`nvme_assign_wrôe_°ªam
(
˘æ
, 
ªq
, &
c⁄åﬁ
, &
dsmgmt
);

650 i‡(
ns
->
ms
) {

657 i‡(!
	`blk_öãgrôy_rq
(
ªq
)) {

658 i‡(
	`WARN_ON_ONCE
(!
	`nvme_ns_has_pi
(
ns
)))

659  
BLK_STS_NOTSUPP
;

660 
c⁄åﬁ
 |
NVME_RW_PRINFO_PRACT
;

661 } i‡(
	`ªq_›
(
ªq
Ë=
REQ_OP_WRITE
) {

662 
	`t10_pi_¥ï¨e
(
ªq
, 
ns
->
pi_ty≥
);

665 
ns
->
pi_ty≥
) {

666 
NVME_NS_DPS_PI_TYPE3
:

667 
c⁄åﬁ
 |
NVME_RW_PRINFO_PRCHK_GUARD
;

669 
NVME_NS_DPS_PI_TYPE1
:

670 
NVME_NS_DPS_PI_TYPE2
:

671 
c⁄åﬁ
 |
NVME_RW_PRINFO_PRCHK_GUARD
 |

672 
NVME_RW_PRINFO_PRCHK_REF
;

673 
cmnd
->
rw
.
ª·ag
 = 
	`˝u_to_À32
(
	`t10_pi_ªf_èg
(
ªq
));

678 
cmnd
->
rw
.
c⁄åﬁ
 = 
	`˝u_to_À16
(control);

679 
cmnd
->
rw
.
dsmgmt
 = 
	`˝u_to_À32
(dsmgmt);

681 
	}
}

683 
	$nvme_˛ónup_cmd
(
ªque°
 *
ªq
)

685 i‡(
	`blk_öãgrôy_rq
(
ªq
Ë&& 
	`ªq_›
‘eqË=
REQ_OP_READ
 &&

686 
	`nvme_ªq
(
ªq
)->
°©us
 == 0) {

687 
nvme_ns
 *
ns
 = 
ªq
->
rq_disk
->
¥iv©e_d©a
;

689 
	`t10_pi_com∂ëe
(
ªq
, 
ns
->
pi_ty≥
,

690 
	`blk_rq_byãs
(
ªq
Ë>> 
ns
->
lba_shi·
);

692 i‡(
ªq
->
rq_Êags
 & 
RQF_SPECIAL_PAYLOAD
) {

693 
nvme_ns
 *
ns
 = 
ªq
->
rq_disk
->
¥iv©e_d©a
;

694 
∑ge
 *∑gê
ªq
->
•ecül_vec
.
bv_∑ge
;

696 i‡(
∑ge
 =
ns
->
˘æ
->
disˇrd_∑ge
)

697 
	`˛ór_bô_u∆ock
(0, &
ns
->
˘æ
->
disˇrd_∑ge_busy
);

699 
	`k‰ì
(
	`∑ge_addªss
(
∑ge
Ë+ 
ªq
->
•ecül_vec
.
bv_off£t
);

701 
	}
}

702 
EXPORT_SYMBOL_GPL
(
nvme_˛ónup_cmd
);

704 
blk_°©us_t
 
	$nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
ªque°
 *
ªq
,

705 
nvme_comm™d
 *
cmd
)

707 
blk_°©us_t
 
ªt
 = 
BLK_STS_OK
;

709 
	`nvme_˛ór_nvme_ªque°
(
ªq
);

711 
	`mem£t
(
cmd
, 0, (*cmd));

712 
	`ªq_›
(
ªq
)) {

713 
REQ_OP_DRV_IN
:

714 
REQ_OP_DRV_OUT
:

715 
	`mem˝y
(
cmd
, 
	`nvme_ªq
(
ªq
)->cmd, (*cmd));

717 
REQ_OP_FLUSH
:

718 
	`nvme_£tup_Êush
(
ns
, 
cmd
);

720 
REQ_OP_WRITE_ZEROES
:

721 
ªt
 = 
	`nvme_£tup_wrôe_zî€s
(
ns
, 
ªq
, 
cmd
);

723 
REQ_OP_DISCARD
:

724 
ªt
 = 
	`nvme_£tup_disˇrd
(
ns
, 
ªq
, 
cmd
);

726 
REQ_OP_READ
:

727 
REQ_OP_WRITE
:

728 
ªt
 = 
	`nvme_£tup_rw
(
ns
, 
ªq
, 
cmd
);

731 
	`WARN_ON_ONCE
(1);

732  
BLK_STS_IOERR
;

735 
cmd
->
comm⁄
.
comm™d_id
 = 
ªq
->
èg
;

736 
	`åa˚_nvme_£tup_cmd
(
ªq
, 
cmd
);

737  
ªt
;

738 
	}
}

739 
EXPORT_SYMBOL_GPL
(
nvme_£tup_cmd
);

741 
	$nvme_íd_sync_rq
(
ªque°
 *
rq
, 
blk_°©us_t
 
îr‹
)

743 
com∂ëi⁄
 *
waôög
 = 
rq
->
íd_io_d©a
;

745 
rq
->
íd_io_d©a
 = 
NULL
;

746 
	`com∂ëe
(
waôög
);

747 
	}
}

749 
	$nvme_execuã_rq_pﬁÀd
(
ªque°_queue
 *
q
,

750 
gídisk
 *
bd_disk
, 
ªque°
 *
rq
, 
©_hód
)

752 
	`DECLARE_COMPLETION_ONSTACK
(
waô
);

754 
	`WARN_ON_ONCE
(!
	`ã°_bô
(
QUEUE_FLAG_POLL
, &
q
->
queue_Êags
));

756 
rq
->
cmd_Êags
 |
REQ_HIPRI
;

757 
rq
->
íd_io_d©a
 = &
waô
;

758 
	`blk_execuã_rq_nowaô
(
q
, 
bd_disk
, 
rq
, 
©_hód
, 
nvme_íd_sync_rq
);

760 !
	`com∂ëi⁄_d⁄e
(&
waô
)) {

761 
	`blk_pﬁl
(
q
, 
	`ªque°_to_qc_t
(
rq
->
mq_h˘x
,Ñq), 
åue
);

762 
	`c⁄d_ªsched
();

764 
	}
}

770 
	$__nvme_submô_sync_cmd
(
ªque°_queue
 *
q
, 
nvme_comm™d
 *
cmd
,

771 
nvme_ªsu…
 *
ªsu…
, *
buf„r
, 
bufÊí
,

772 
timeout
, 
qid
, 
©_hód
,

773 
blk_mq_ªq_Êags_t
 
Êags
, 
boﬁ
 
pﬁl
)

775 
ªque°
 *
ªq
;

776 
ªt
;

778 
ªq
 = 
	`nvme_Æloc_ªque°
(
q
, 
cmd
, 
Êags
, 
qid
);

779 i‡(
	`IS_ERR
(
ªq
))

780  
	`PTR_ERR
(
ªq
);

782 
ªq
->
timeout
 =Åimeouà?Åimeouà: 
ADMIN_TIMEOUT
;

784 i‡(
buf„r
 && 
bufÊí
) {

785 
ªt
 = 
	`blk_rq_m≠_kîn
(
q
, 
ªq
, 
buf„r
, 
bufÊí
, 
GFP_KERNEL
);

786 i‡(
ªt
)

787 
out
;

790 i‡(
pﬁl
)

791 
	`nvme_execuã_rq_pﬁÀd
(
ªq
->
q
, 
NULL
,Ñeq, 
©_hód
);

793 
	`blk_execuã_rq
(
ªq
->
q
, 
NULL
,Ñeq, 
©_hód
);

794 i‡(
ªsu…
)

795 *
ªsu…
 = 
	`nvme_ªq
(
ªq
)->result;

796 i‡(
	`nvme_ªq
(
ªq
)->
Êags
 & 
NVME_REQ_CANCELLED
)

797 
ªt
 = -
EINTR
;

799 
ªt
 = 
	`nvme_ªq
(
ªq
)->
°©us
;

800 
out
:

801 
	`blk_mq_‰ì_ªque°
(
ªq
);

802  
ªt
;

803 
	}
}

804 
EXPORT_SYMBOL_GPL
(
__nvme_submô_sync_cmd
);

806 
	$nvme_submô_sync_cmd
(
ªque°_queue
 *
q
, 
nvme_comm™d
 *
cmd
,

807 *
buf„r
, 
bufÊí
)

809  
	`__nvme_submô_sync_cmd
(
q
, 
cmd
, 
NULL
, 
buf„r
, 
bufÊí
, 0,

810 
NVME_QID_ANY
, 0, 0, 
Ál£
);

811 
	}
}

812 
EXPORT_SYMBOL_GPL
(
nvme_submô_sync_cmd
);

814 *
	$nvme_add_u£r_mëad©a
(
bio
 *bio, 
__u£r
 *
ubuf
,

815 
Àn
, 
u32
 
£ed
, 
boﬁ
 
wrôe
)

817 
bio_öãgrôy_∑ylﬂd
 *
bù
;

818 
ªt
 = -
ENOMEM
;

819 *
buf
;

821 
buf
 = 
	`kmÆloc
(
Àn
, 
GFP_KERNEL
);

822 i‡(!
buf
)

823 
out
;

825 
ªt
 = -
EFAULT
;

826 i‡(
wrôe
 && 
	`c›y_‰om_u£r
(
buf
, 
ubuf
, 
Àn
))

827 
out_‰ì_mëa
;

829 
bù
 = 
	`bio_öãgrôy_Æloc
(
bio
, 
GFP_KERNEL
, 1);

830 i‡(
	`IS_ERR
(
bù
)) {

831 
ªt
 = 
	`PTR_ERR
(
bù
);

832 
out_‰ì_mëa
;

835 
bù
->
bù_ôî
.
bi_size
 = 
Àn
;

836 
bù
->
bù_ôî
.
bi_£˘‹
 = 
£ed
;

837 
ªt
 = 
	`bio_öãgrôy_add_∑ge
(
bio
, 
	`vút_to_∑ge
(
buf
), 
Àn
,

838 
	`off£t_ö_∑ge
(
buf
));

839 i‡(
ªt
 =
Àn
)

840  
buf
;

841 
ªt
 = -
ENOMEM
;

842 
out_‰ì_mëa
:

843 
	`k‰ì
(
buf
);

844 
out
:

845  
	`ERR_PTR
(
ªt
);

846 
	}
}

848 
	$nvme_submô_u£r_cmd
(
ªque°_queue
 *
q
,

849 
nvme_comm™d
 *
cmd
, 
__u£r
 *
ubuf„r
,

850 
bufÊí
, 
__u£r
 *
mëa_buf„r
, 
mëa_Àn
,

851 
u32
 
mëa_£ed
, u32 *
ªsu…
, 
timeout
)

853 
boﬁ
 
wrôe
 = 
	`nvme_is_wrôe
(
cmd
);

854 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

855 
gídisk
 *
disk
 = 
ns
 ?Çs->disk : 
NULL
;

856 
ªque°
 *
ªq
;

857 
bio
 *biÿ
NULL
;

858 *
mëa
 = 
NULL
;

859 
ªt
;

861 
ªq
 = 
	`nvme_Æloc_ªque°
(
q
, 
cmd
, 0, 
NVME_QID_ANY
);

862 i‡(
	`IS_ERR
(
ªq
))

863  
	`PTR_ERR
(
ªq
);

865 
ªq
->
timeout
 =Åimeouà?Åimeouà: 
ADMIN_TIMEOUT
;

866 
	`nvme_ªq
(
ªq
)->
Êags
 |
NVME_REQ_USERCMD
;

868 i‡(
ubuf„r
 && 
bufÊí
) {

869 
ªt
 = 
	`blk_rq_m≠_u£r
(
q
, 
ªq
, 
NULL
, 
ubuf„r
, 
bufÊí
,

870 
GFP_KERNEL
);

871 i‡(
ªt
)

872 
out
;

873 
bio
 = 
ªq
->bio;

874 
bio
->
bi_disk
 = 
disk
;

875 i‡(
disk
 && 
mëa_buf„r
 && 
mëa_Àn
) {

876 
mëa
 = 
	`nvme_add_u£r_mëad©a
(
bio
, 
mëa_buf„r
, 
mëa_Àn
,

877 
mëa_£ed
, 
wrôe
);

878 i‡(
	`IS_ERR
(
mëa
)) {

879 
ªt
 = 
	`PTR_ERR
(
mëa
);

880 
out_unm≠
;

882 
ªq
->
cmd_Êags
 |
REQ_INTEGRITY
;

886 
	`blk_execuã_rq
(
ªq
->
q
, 
disk
,Ñeq, 0);

887 i‡(
	`nvme_ªq
(
ªq
)->
Êags
 & 
NVME_REQ_CANCELLED
)

888 
ªt
 = -
EINTR
;

890 
ªt
 = 
	`nvme_ªq
(
ªq
)->
°©us
;

891 i‡(
ªsu…
)

892 *
ªsu…
 = 
	`À32_to_˝u
(
	`nvme_ªq
(
ªq
)->ªsu….
u32
);

893 i‡(
mëa
 && !
ªt
 && !
wrôe
) {

894 i‡(
	`c›y_to_u£r
(
mëa_buf„r
, 
mëa
, 
mëa_Àn
))

895 
ªt
 = -
EFAULT
;

897 
	`k‰ì
(
mëa
);

898 
out_unm≠
:

899 i‡(
bio
)

900 
	`blk_rq_unm≠_u£r
(
bio
);

901 
out
:

902 
	`blk_mq_‰ì_ªque°
(
ªq
);

903  
ªt
;

904 
	}
}

906 
	$nvme_kìp_Æive_íd_io
(
ªque°
 *
rq
, 
blk_°©us_t
 
°©us
)

908 
nvme_˘æ
 *
˘æ
 = 
rq
->
íd_io_d©a
;

909 
Êags
;

910 
boﬁ
 
°¨tka
 = 
Ál£
;

912 
	`blk_mq_‰ì_ªque°
(
rq
);

914 i‡(
°©us
) {

915 
	`dev_îr
(
˘æ
->
devi˚
,

917 
°©us
);

921 
˘æ
->
comp_£í
 = 
Ál£
;

922 
	`•ö_lock_úqßve
(&
˘æ
->
lock
, 
Êags
);

923 i‡(
˘æ
->
°©e
 =
NVME_CTRL_LIVE
 ||

924 
˘æ
->
°©e
 =
NVME_CTRL_CONNECTING
)

925 
°¨tka
 = 
åue
;

926 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
lock
, 
Êags
);

927 i‡(
°¨tka
)

928 
	`scheduÀ_dñayed_w‹k
(&
˘æ
->
ka_w‹k
, cål->
k©o
 * 
HZ
);

929 
	}
}

931 
	$nvme_kìp_Æive
(
nvme_˘æ
 *
˘æ
)

933 
ªque°
 *
rq
;

935 
rq
 = 
	`nvme_Æloc_ªque°
(
˘æ
->
admö_q
, &˘æ->
ka_cmd
, 
BLK_MQ_REQ_RESERVED
,

936 
NVME_QID_ANY
);

937 i‡(
	`IS_ERR
(
rq
))

938  
	`PTR_ERR
(
rq
);

940 
rq
->
timeout
 = 
˘æ
->
k©o
 * 
HZ
;

941 
rq
->
íd_io_d©a
 = 
˘æ
;

943 
	`blk_execuã_rq_nowaô
(
rq
->
q
, 
NULL
,Ñq, 0, 
nvme_kìp_Æive_íd_io
);

946 
	}
}

948 
	$nvme_kìp_Æive_w‹k
(
w‹k_°ru˘
 *
w‹k
)

950 
nvme_˘æ
 *
˘æ
 = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w‹k
),

951 
nvme_˘æ
, 
ka_w‹k
);

952 
boﬁ
 
comp_£í
 = 
˘æ
->comp_seen;

954 i‡((
˘æ
->
˘øâ
 & 
NVME_CTRL_ATTR_TBKAS
Ë&& 
comp_£í
) {

955 
	`dev_dbg
(
˘æ
->
devi˚
,

957 
˘æ
->
comp_£í
 = 
Ál£
;

958 
	`scheduÀ_dñayed_w‹k
(&
˘æ
->
ka_w‹k
, cål->
k©o
 * 
HZ
);

962 i‡(
	`nvme_kìp_Æive
(
˘æ
)) {

964 
	`dev_îr
(
˘æ
->
devi˚
, "keep-alive failed\n");

965 
	`nvme_ª£t_˘æ
(
˘æ
);

968 
	}
}

970 
	$nvme_°¨t_kìp_Æive
(
nvme_˘æ
 *
˘æ
)

972 i‡(
	`u∆ikñy
(
˘æ
->
k©o
 == 0))

975 
	`scheduÀ_dñayed_w‹k
(&
˘æ
->
ka_w‹k
, cål->
k©o
 * 
HZ
);

976 
	}
}

978 
	$nvme_°›_kìp_Æive
(
nvme_˘æ
 *
˘æ
)

980 i‡(
	`u∆ikñy
(
˘æ
->
k©o
 == 0))

983 
	`ˇn˚l_dñayed_w‹k_sync
(&
˘æ
->
ka_w‹k
);

984 
	}
}

985 
EXPORT_SYMBOL_GPL
(
nvme_°›_kìp_Æive
);

987 
	$nvme_idítify_˘æ
(
nvme_˘æ
 *
dev
, 
nvme_id_˘æ
 **
id
)

989 
nvme_comm™d
 
c
 = { };

990 
îr‹
;

993 
c
.
idítify
.
›code
 = 
nvme_admö_idítify
;

994 
c
.
idítify
.
˙s
 = 
NVME_ID_CNS_CTRL
;

996 *
id
 = 
	`kmÆloc
((
nvme_id_˘æ
), 
GFP_KERNEL
);

997 i‡(!*
id
)

998  -
ENOMEM
;

1000 
îr‹
 = 
	`nvme_submô_sync_cmd
(
dev
->
admö_q
, &
c
, *
id
,

1001 (
nvme_id_˘æ
));

1002 i‡(
îr‹
)

1003 
	`k‰ì
(*
id
);

1004  
îr‹
;

1005 
	}
}

1007 
	$nvme_idítify_ns_descs
(
nvme_˘æ
 *
˘æ
, 
nsid
,

1008 
nvme_ns_ids
 *
ids
)

1010 
nvme_comm™d
 
c
 = { };

1011 
°©us
;

1012 *
d©a
;

1013 
pos
;

1014 
Àn
;

1016 
c
.
idítify
.
›code
 = 
nvme_admö_idítify
;

1017 
c
.
idítify
.
nsid
 = 
	`˝u_to_À32
(nsid);

1018 
c
.
idítify
.
˙s
 = 
NVME_ID_CNS_NS_DESC_LIST
;

1020 
d©a
 = 
	`kzÆloc
(
NVME_IDENTIFY_DATA_SIZE
, 
GFP_KERNEL
);

1021 i‡(!
d©a
)

1022  -
ENOMEM
;

1024 
°©us
 = 
	`nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
c
, 
d©a
,

1025 
NVME_IDENTIFY_DATA_SIZE
);

1026 i‡(
°©us
)

1027 
‰ì_d©a
;

1029 
pos
 = 0;Öo†< 
NVME_IDENTIFY_DATA_SIZE
;Öo†+
Àn
) {

1030 
nvme_ns_id_desc
 *
cur
 = 
d©a
 + 
pos
;

1032 i‡(
cur
->
nidl
 == 0)

1035 
cur
->
nidt
) {

1036 
NVME_NIDT_EUI64
:

1037 i‡(
cur
->
nidl
 !
NVME_NIDT_EUI64_LEN
) {

1038 
	`dev_w¨n
(
˘æ
->
devi˚
,

1040 
cur
->
nidl
);

1041 
‰ì_d©a
;

1043 
Àn
 = 
NVME_NIDT_EUI64_LEN
;

1044 
	`mem˝y
(
ids
->
eui64
, 
d©a
 + 
pos
 + (*
cur
), 
Àn
);

1046 
NVME_NIDT_NGUID
:

1047 i‡(
cur
->
nidl
 !
NVME_NIDT_NGUID_LEN
) {

1048 
	`dev_w¨n
(
˘æ
->
devi˚
,

1050 
cur
->
nidl
);

1051 
‰ì_d©a
;

1053 
Àn
 = 
NVME_NIDT_NGUID_LEN
;

1054 
	`mem˝y
(
ids
->
nguid
, 
d©a
 + 
pos
 + (*
cur
), 
Àn
);

1056 
NVME_NIDT_UUID
:

1057 i‡(
cur
->
nidl
 !
NVME_NIDT_UUID_LEN
) {

1058 
	`dev_w¨n
(
˘æ
->
devi˚
,

1060 
cur
->
nidl
);

1061 
‰ì_d©a
;

1063 
Àn
 = 
NVME_NIDT_UUID_LEN
;

1064 
	`uuid_c›y
(&
ids
->
uuid
, 
d©a
 + 
pos
 + (*
cur
));

1068 
Àn
 = 
cur
->
nidl
;

1072 
Àn
 +(*
cur
);

1074 
‰ì_d©a
:

1075 
	`k‰ì
(
d©a
);

1076  
°©us
;

1077 
	}
}

1079 
	$nvme_idítify_ns_li°
(
nvme_˘æ
 *
dev
, 
nsid
, 
__À32
 *
ns_li°
)

1081 
nvme_comm™d
 
c
 = { };

1083 
c
.
idítify
.
›code
 = 
nvme_admö_idítify
;

1084 
c
.
idítify
.
˙s
 = 
NVME_ID_CNS_NS_ACTIVE_LIST
;

1085 
c
.
idítify
.
nsid
 = 
	`˝u_to_À32
(nsid);

1086  
	`nvme_submô_sync_cmd
(
dev
->
admö_q
, &
c
, 
ns_li°
,

1087 
NVME_IDENTIFY_DATA_SIZE
);

1088 
	}
}

1090 
nvme_id_ns
 *
	$nvme_idítify_ns
(
nvme_˘æ
 *
˘æ
,

1091 
nsid
)

1093 
nvme_id_ns
 *
id
;

1094 
nvme_comm™d
 
c
 = { };

1095 
îr‹
;

1098 
c
.
idítify
.
›code
 = 
nvme_admö_idítify
;

1099 
c
.
idítify
.
nsid
 = 
	`˝u_to_À32
(nsid);

1100 
c
.
idítify
.
˙s
 = 
NVME_ID_CNS_NS
;

1102 
id
 = 
	`kmÆloc
((*id), 
GFP_KERNEL
);

1103 i‡(!
id
)

1104  
NULL
;

1106 
îr‹
 = 
	`nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
c
, 
id
, (*id));

1107 i‡(
îr‹
) {

1108 
	`dev_w¨n
(
˘æ
->
devi˚
, "IdentifyÇamespace failed\n");

1109 
	`k‰ì
(
id
);

1110  
NULL
;

1113  
id
;

1114 
	}
}

1116 
	$nvme_£t_„©uªs
(
nvme_˘æ
 *
dev
, 
fid
, 
dw‹d11
,

1117 *
buf„r
, 
size_t
 
buÊí
, 
u32
 *
ªsu…
)

1119 
nvme_comm™d
 
c
;

1120 
nvme_ªsu…
 
ªs
;

1121 
ªt
;

1123 
	`mem£t
(&
c
, 0, (c));

1124 
c
.
„©uªs
.
›code
 = 
nvme_admö_£t_„©uªs
;

1125 
c
.
„©uªs
.
fid
 = 
	`˝u_to_À32
(fid);

1126 
c
.
„©uªs
.
dw‹d11
 = 
	`˝u_to_À32
(dword11);

1128 
ªt
 = 
	`__nvme_submô_sync_cmd
(
dev
->
admö_q
, &
c
, &
ªs
,

1129 
buf„r
, 
buÊí
, 0, 
NVME_QID_ANY
, 0, 0, 
Ál£
);

1130 i‡(
ªt
 >0 && 
ªsu…
)

1131 *
ªsu…
 = 
	`À32_to_˝u
(
ªs
.
u32
);

1132  
ªt
;

1133 
	}
}

1135 
	$nvme_£t_queue_cou¡
(
nvme_˘æ
 *
˘æ
, *
cou¡
)

1137 
u32
 
q_cou¡
 = (*
cou¡
 - 1) | ((*count - 1) << 16);

1138 
u32
 
ªsu…
;

1139 
°©us
, 
ƒ_io_queues
;

1141 
°©us
 = 
	`nvme_£t_„©uªs
(
˘æ
, 
NVME_FEAT_NUM_QUEUES
, 
q_cou¡
, 
NULL
, 0,

1142 &
ªsu…
);

1143 i‡(
°©us
 < 0)

1144  
°©us
;

1151 i‡(
°©us
 > 0) {

1152 
	`dev_îr
(
˘æ
->
devi˚
, "CouldÇŸ së queuêcou¡ (%d)\n", 
°©us
);

1153 *
cou¡
 = 0;

1155 
ƒ_io_queues
 = 
	`mö
(
ªsu…
 & 0xffff,Ñesult >> 16) + 1;

1156 *
cou¡
 = 
	`mö
(*cou¡, 
ƒ_io_queues
);

1160 
	}
}

1161 
EXPORT_SYMBOL_GPL
(
nvme_£t_queue_cou¡
);

1163 
	#NVME_AEN_SUPPORTED
 \

1164 (
NVME_AEN_CFG_NS_ATTR
 | 
NVME_AEN_CFG_FW_ACT
 | 
NVME_AEN_CFG_ANA_CHANGE
)

	)

1166 
	$nvme_íabÀ_´n
(
nvme_˘æ
 *
˘æ
)

1168 
u32
 
ªsu…
, 
suµ‹ãd_´ns
 = 
˘æ
->
ﬂes
 & 
NVME_AEN_SUPPORTED
;

1169 
°©us
;

1171 i‡(!
suµ‹ãd_´ns
)

1174 
°©us
 = 
	`nvme_£t_„©uªs
(
˘æ
, 
NVME_FEAT_ASYNC_EVENT
, 
suµ‹ãd_´ns
,

1175 
NULL
, 0, &
ªsu…
);

1176 i‡(
°©us
)

1177 
	`dev_w¨n
(
˘æ
->
devi˚
, "FailedÅo configure AEN (cfg %x)\n",

1178 
suµ‹ãd_´ns
);

1179 
	}
}

1181 
	$nvme_submô_io
(
nvme_ns
 *
ns
, 
nvme_u£r_io
 
__u£r
 *
uio
)

1183 
nvme_u£r_io
 
io
;

1184 
nvme_comm™d
 
c
;

1185 
Àngth
, 
mëa_Àn
;

1186 
__u£r
 *
mëad©a
;

1188 i‡(
	`c›y_‰om_u£r
(&
io
, 
uio
, (io)))

1189  -
EFAULT
;

1190 i‡(
io
.
Êags
)

1191  -
EINVAL
;

1193 
io
.
›code
) {

1194 
nvme_cmd_wrôe
:

1195 
nvme_cmd_ªad
:

1196 
nvme_cmd_com∑ª
:

1199  -
EINVAL
;

1202 
Àngth
 = (
io
.
nblocks
 + 1Ë<< 
ns
->
lba_shi·
;

1203 
mëa_Àn
 = (
io
.
nblocks
 + 1Ë* 
ns
->
ms
;

1204 
mëad©a
 = (
__u£r
 *)(
uöçå_t
)
io
.metadata;

1206 i‡(
ns
->
ext
) {

1207 
Àngth
 +
mëa_Àn
;

1208 
mëa_Àn
 = 0;

1209 } i‡(
mëa_Àn
) {

1210 i‡((
io
.
mëad©a
 & 3) || !io.metadata)

1211  -
EINVAL
;

1214 
	`mem£t
(&
c
, 0, (c));

1215 
c
.
rw
.
›code
 = 
io
.opcode;

1216 
c
.
rw
.
Êags
 = 
io
.flags;

1217 
c
.
rw
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

1218 
c
.
rw
.
¶ba
 = 
	`˝u_to_À64
(
io
.slba);

1219 
c
.
rw
.
Àngth
 = 
	`˝u_to_À16
(
io
.
nblocks
);

1220 
c
.
rw
.
c⁄åﬁ
 = 
	`˝u_to_À16
(
io
.control);

1221 
c
.
rw
.
dsmgmt
 = 
	`˝u_to_À32
(
io
.dsmgmt);

1222 
c
.
rw
.
ª·ag
 = 
	`˝u_to_À32
(
io
.reftag);

1223 
c
.
rw
.
≠±ag
 = 
	`˝u_to_À16
(
io
.apptag);

1224 
c
.
rw
.
≠pmask
 = 
	`˝u_to_À16
(
io
.appmask);

1226  
	`nvme_submô_u£r_cmd
(
ns
->
queue
, &
c
,

1227 (
__u£r
 *)(
uöçå_t
)
io
.
addr
, 
Àngth
,

1228 
mëad©a
, 
mëa_Àn
, 
	`lowî_32_bôs
(
io
.
¶ba
), 
NULL
, 0);

1229 
	}
}

1231 
u32
 
	$nvme_known_admö_ef„˘s
(
u8
 
›code
)

1233 
›code
) {

1234 
nvme_admö_f‹m©_nvm
:

1235  
NVME_CMD_EFFECTS_CSUPP
 | 
NVME_CMD_EFFECTS_LBCC
 |

1236 
NVME_CMD_EFFECTS_CSE_MASK
;

1237 
nvme_admö_ßnôize_nvm
:

1238  
NVME_CMD_EFFECTS_CSE_MASK
;

1243 
	}
}

1245 
u32
 
	$nvme_∑s°hru_°¨t
(
nvme_˘æ
 *
˘æ
, 
nvme_ns
 *
ns
,

1246 
u8
 
›code
)

1248 
u32
 
ef„˘s
 = 0;

1250 i‡(
ns
) {

1251 i‡(
˘æ
->
ef„˘s
)

1252 
ef„˘s
 = 
	`À32_to_˝u
(
˘æ
->ef„˘s->
iocs
[
›code
]);

1253 i‡(
ef„˘s
 & ~(
NVME_CMD_EFFECTS_CSUPP
 | 
NVME_CMD_EFFECTS_LBCC
))

1254 
	`dev_w¨n
(
˘æ
->
devi˚
,

1256 
›code
, 
ef„˘s
);

1260 i‡(
˘æ
->
ef„˘s
)

1261 
ef„˘s
 = 
	`À32_to_˝u
(
˘æ
->ef„˘s->
acs
[
›code
]);

1263 
ef„˘s
 = 
	`nvme_known_admö_ef„˘s
(
›code
);

1269 i‡(
ef„˘s
 & (
NVME_CMD_EFFECTS_LBCC
 | 
NVME_CMD_EFFECTS_CSE_MASK
)) {

1270 
	`muãx_lock
(&
˘æ
->
sˇn_lock
);

1271 
	`nvme_°¨t_‰ìze
(
˘æ
);

1272 
	`nvme_waô_‰ìze
(
˘æ
);

1274  
ef„˘s
;

1275 
	}
}

1277 
	$nvme_upd©e_f‹m©s
(
nvme_˘æ
 *
˘æ
)

1279 
nvme_ns
 *
ns
;

1281 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

1282 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

1283 i‡(
ns
->
disk
 && 
	`nvme_ªvÆid©e_disk
(ns->disk))

1284 
	`nvme_£t_queue_dyög
(
ns
);

1285 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

1287 
	`nvme_ªmove_övÆid_«me•a˚s
(
˘æ
, 
NVME_NSID_ALL
);

1288 
	}
}

1290 
	$nvme_∑s°hru_íd
(
nvme_˘æ
 *
˘æ
, 
u32
 
ef„˘s
)

1297 i‡(
ef„˘s
 & 
NVME_CMD_EFFECTS_LBCC
)

1298 
	`nvme_upd©e_f‹m©s
(
˘æ
);

1299 i‡(
ef„˘s
 & (
NVME_CMD_EFFECTS_LBCC
 | 
NVME_CMD_EFFECTS_CSE_MASK
)) {

1300 
	`nvme_un‰ìze
(
˘æ
);

1301 
	`muãx_u∆ock
(&
˘æ
->
sˇn_lock
);

1303 i‡(
ef„˘s
 & 
NVME_CMD_EFFECTS_CCC
)

1304 
	`nvme_öô_idítify
(
˘æ
);

1305 i‡(
ef„˘s
 & (
NVME_CMD_EFFECTS_NIC
 | 
NVME_CMD_EFFECTS_NCC
))

1306 
	`nvme_queue_sˇn
(
˘æ
);

1307 
	}
}

1309 
	$nvme_u£r_cmd
(
nvme_˘æ
 *
˘æ
, 
nvme_ns
 *
ns
,

1310 
nvme_∑s°hru_cmd
 
__u£r
 *
ucmd
)

1312 
nvme_∑s°hru_cmd
 
cmd
;

1313 
nvme_comm™d
 
c
;

1314 
timeout
 = 0;

1315 
u32
 
ef„˘s
;

1316 
°©us
;

1318 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1319  -
EACCES
;

1320 i‡(
	`c›y_‰om_u£r
(&
cmd
, 
ucmd
, (cmd)))

1321  -
EFAULT
;

1322 i‡(
cmd
.
Êags
)

1323  -
EINVAL
;

1325 
	`mem£t
(&
c
, 0, (c));

1326 
c
.
comm⁄
.
›code
 = 
cmd
.opcode;

1327 
c
.
comm⁄
.
Êags
 = 
cmd
.flags;

1328 
c
.
comm⁄
.
nsid
 = 
	`˝u_to_À32
(
cmd
.nsid);

1329 
c
.
comm⁄
.
cdw2
[0] = 
	`˝u_to_À32
(
cmd
.cdw2);

1330 
c
.
comm⁄
.
cdw2
[1] = 
	`˝u_to_À32
(
cmd
.
cdw3
);

1331 
c
.
comm⁄
.
cdw10
 = 
	`˝u_to_À32
(
cmd
.cdw10);

1332 
c
.
comm⁄
.
cdw11
 = 
	`˝u_to_À32
(
cmd
.cdw11);

1333 
c
.
comm⁄
.
cdw12
 = 
	`˝u_to_À32
(
cmd
.cdw12);

1334 
c
.
comm⁄
.
cdw13
 = 
	`˝u_to_À32
(
cmd
.cdw13);

1335 
c
.
comm⁄
.
cdw14
 = 
	`˝u_to_À32
(
cmd
.cdw14);

1336 
c
.
comm⁄
.
cdw15
 = 
	`˝u_to_À32
(
cmd
.cdw15);

1338 i‡(
cmd
.
timeout_ms
)

1339 
timeout
 = 
	`m£cs_to_jiffõs
(
cmd
.
timeout_ms
);

1341 
ef„˘s
 = 
	`nvme_∑s°hru_°¨t
(
˘æ
, 
ns
, 
cmd
.
›code
);

1342 
°©us
 = 
	`nvme_submô_u£r_cmd
(
ns
 ?Çs->
queue
 : 
˘æ
->
admö_q
, &
c
,

1343 (
__u£r
 *)(
uöçå_t
)
cmd
.
addr
, cmd.
d©a_Àn
,

1344 (
__u£r
 *)(
uöçå_t
)
cmd
.
mëad©a
, cmd.
mëad©a_Àn
,

1345 0, &
cmd
.
ªsu…
, 
timeout
);

1346 
	`nvme_∑s°hru_íd
(
˘æ
, 
ef„˘s
);

1348 i‡(
°©us
 >= 0) {

1349 i‡(
	`put_u£r
(
cmd
.
ªsu…
, &
ucmd
->result))

1350  -
EFAULT
;

1353  
°©us
;

1354 
	}
}

1360 
nvme_ns
 *
	$nvme_gë_ns_‰om_disk
(
gídisk
 *
disk
,

1361 
nvme_ns_hód
 **
hód
, *
§cu_idx
)

1363 #ifde‡
CONFIG_NVME_MULTIPATH


1364 i‡(
disk
->
f›s
 =&
nvme_ns_hód_›s
) {

1365 
nvme_ns
 *
ns
;

1367 *
hód
 = 
disk
->
¥iv©e_d©a
;

1368 *
§cu_idx
 = 
	`§cu_ªad_lock
(&(*
hód
)->
§cu
);

1369 
ns
 = 
	`nvme_föd_∑th
(*
hód
);

1370 i‡(!
ns
)

1371 
	`§cu_ªad_u∆ock
(&(*
hód
)->
§cu
, *
§cu_idx
);

1372  
ns
;

1375 *
hód
 = 
NULL
;

1376 *
§cu_idx
 = -1;

1377  
disk
->
¥iv©e_d©a
;

1378 
	}
}

1380 
	$nvme_put_ns_‰om_disk
(
nvme_ns_hód
 *
hód
, 
idx
)

1382 i‡(
hód
)

1383 
	`§cu_ªad_u∆ock
(&
hód
->
§cu
, 
idx
);

1384 
	}
}

1386 
	$nvme_io˘l
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
,

1387 
cmd
, 
¨g
)

1389 
nvme_ns_hód
 *
hód
 = 
NULL
;

1390 
__u£r
 *
¨gp
 = (__u£∏*)
¨g
;

1391 
nvme_ns
 *
ns
;

1392 
§cu_idx
, 
ªt
;

1394 
ns
 = 
	`nvme_gë_ns_‰om_disk
(
bdev
->
bd_disk
, &
hód
, &
§cu_idx
);

1395 i‡(
	`u∆ikñy
(!
ns
))

1396  -
EWOULDBLOCK
;

1403 i‡(
cmd
 =
NVME_IOCTL_ADMIN_CMD
 || 
	`is_£d_io˘l
(cmd)) {

1404 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

1406 
	`nvme_gë_˘æ
(
ns
->
˘æ
);

1407 
	`nvme_put_ns_‰om_disk
(
hód
, 
§cu_idx
);

1409 i‡(
cmd
 =
NVME_IOCTL_ADMIN_CMD
)

1410 
ªt
 = 
	`nvme_u£r_cmd
(
˘æ
, 
NULL
, 
¨gp
);

1412 
ªt
 = 
	`£d_io˘l
(
˘æ
->
›Æ_dev
, 
cmd
, 
¨gp
);

1414 
	`nvme_put_˘æ
(
˘æ
);

1415  
ªt
;

1418 
cmd
) {

1419 
NVME_IOCTL_ID
:

1420 
	`f‹˚_suc˚ssful_sysˇŒ_ªtu∫
();

1421 
ªt
 = 
ns
->
hód
->
ns_id
;

1423 
NVME_IOCTL_IO_CMD
:

1424 
ªt
 = 
	`nvme_u£r_cmd
(
ns
->
˘æ
,Çs, 
¨gp
);

1426 
NVME_IOCTL_SUBMIT_IO
:

1427 
ªt
 = 
	`nvme_submô_io
(
ns
, 
¨gp
);

1430 i‡(
ns
->
ndev
)

1431 
ªt
 = 
	`nvme_nvm_io˘l
(
ns
, 
cmd
, 
¨g
);

1433 
ªt
 = -
ENOTTY
;

1436 
	`nvme_put_ns_‰om_disk
(
hód
, 
§cu_idx
);

1437  
ªt
;

1438 
	}
}

1440 
	$nvme_›í
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
)

1442 
nvme_ns
 *
ns
 = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

1444 #ifde‡
CONFIG_NVME_MULTIPATH


1446 i‡(
	`WARN_ON_ONCE
(
ns
->
hód
->
disk
))

1447 
Áû
;

1449 i‡(!
	`kªf_gë_u∆ess_zîo
(&
ns
->
kªf
))

1450 
Áû
;

1451 i‡(!
	`åy_moduÀ_gë
(
ns
->
˘æ
->
›s
->
moduÀ
))

1452 
Áû_put_ns
;

1456 
Áû_put_ns
:

1457 
	`nvme_put_ns
(
ns
);

1458 
Áû
:

1459  -
ENXIO
;

1460 
	}
}

1462 
	$nvme_ªÀa£
(
gídisk
 *
disk
, 
fmode_t
 
mode
)

1464 
nvme_ns
 *
ns
 = 
disk
->
¥iv©e_d©a
;

1466 
	`moduÀ_put
(
ns
->
˘æ
->
›s
->
moduÀ
);

1467 
	`nvme_put_ns
(
ns
);

1468 
	}
}

1470 
	$nvme_gëgeo
(
block_devi˚
 *
bdev
, 
hd_geomëry
 *
geo
)

1473 
geo
->
hóds
 = 1 << 6;

1474 
geo
->
£˘‹s
 = 1 << 5;

1475 
geo
->
cylödîs
 = 
	`gë_ˇ∑côy
(
bdev
->
bd_disk
) >> 11;

1477 
	}
}

1479 #ifde‡
CONFIG_BLK_DEV_INTEGRITY


1480 
	$nvme_öô_öãgrôy
(
gídisk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty≥
)

1482 
blk_öãgrôy
 
öãgrôy
;

1484 
	`mem£t
(&
öãgrôy
, 0, (integrity));

1485 
pi_ty≥
) {

1486 
NVME_NS_DPS_PI_TYPE3
:

1487 
öãgrôy
.
¥ofûe
 = &
t10_pi_ty≥3_¸c
;

1488 
öãgrôy
.
èg_size
 = (
u16
Ë+ (
u32
);

1489 
öãgrôy
.
Êags
 |
BLK_INTEGRITY_DEVICE_CAPABLE
;

1491 
NVME_NS_DPS_PI_TYPE1
:

1492 
NVME_NS_DPS_PI_TYPE2
:

1493 
öãgrôy
.
¥ofûe
 = &
t10_pi_ty≥1_¸c
;

1494 
öãgrôy
.
èg_size
 = (
u16
);

1495 
öãgrôy
.
Êags
 |
BLK_INTEGRITY_DEVICE_CAPABLE
;

1498 
öãgrôy
.
¥ofûe
 = 
NULL
;

1501 
öãgrôy
.
tu∂e_size
 = 
ms
;

1502 
	`blk_öãgrôy_ªgi°î
(
disk
, &
öãgrôy
);

1503 
	`blk_queue_max_öãgrôy_£gmíts
(
disk
->
queue
, 1);

1504 
	}
}

1506 
	$nvme_öô_öãgrôy
(
gídisk
 *
disk
, 
u16
 
ms
, 
u8
 
pi_ty≥
)

1508 
	}
}

1511 
	$nvme_£t_chunk_size
(
nvme_ns
 *
ns
)

1513 
u32
 
chunk_size
 = (((u32)
ns
->
noiob
Ë<< (ns->
lba_shi·
 - 9));

1514 
	`blk_queue_chunk_£˘‹s
(
ns
->
queue
, 
	`rounddown_pow_of_two
(
chunk_size
));

1515 
	}
}

1517 
	$nvme_c⁄fig_disˇrd
(
gídisk
 *
disk
, 
nvme_ns
 *
ns
)

1519 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

1520 
ªque°_queue
 *
queue
 = 
disk
->queue;

1521 
u32
 
size
 = 
	`queue_logiˇl_block_size
(
queue
);

1523 i‡(!(
˘æ
->
⁄cs
 & 
NVME_CTRL_ONCS_DSM
)) {

1524 
	`blk_queue_Êag_˛ór
(
QUEUE_FLAG_DISCARD
, 
queue
);

1528 i‡(
˘æ
->
ƒ_°ªams
 && 
ns
->
sws
 &&Çs->
sgs
)

1529 
size
 *
ns
->
sws
 *Çs->
sgs
;

1531 
	`BUILD_BUG_ON
(
PAGE_SIZE
 / (
nvme_dsm_ønge
) <

1532 
NVME_DSM_MAX_RANGES
);

1534 
queue
->
limôs
.
disˇrd_Æignmít
 = 0;

1535 
queue
->
limôs
.
disˇrd_gønuœrôy
 = 
size
;

1538 i‡(
	`blk_queue_Êag_ã°_™d_£t
(
QUEUE_FLAG_DISCARD
, 
queue
))

1541 
	`blk_queue_max_disˇrd_£˘‹s
(
queue
, 
UINT_MAX
);

1542 
	`blk_queue_max_disˇrd_£gmíts
(
queue
, 
NVME_DSM_MAX_RANGES
);

1544 i‡(
˘æ
->
quúks
 & 
NVME_QUIRK_DEALLOCATE_ZEROES
)

1545 
	`blk_queue_max_wrôe_zî€s_£˘‹s
(
queue
, 
UINT_MAX
);

1546 
	}
}

1548 
	$nvme_c⁄fig_wrôe_zî€s
(
gídisk
 *
disk
, 
nvme_ns
 *
ns
)

1550 
u32
 
max_£˘‹s
;

1551 
bs
 = 1 << 
ns
->
lba_shi·
;

1553 i‡(!(
ns
->
˘æ
->
⁄cs
 & 
NVME_CTRL_ONCS_WRITE_ZEROES
) ||

1554 (
ns
->
˘æ
->
quúks
 & 
NVME_QUIRK_DISABLE_WRITE_ZEROES
))

1566 i‡(
ns
->
˘æ
->
max_hw_£˘‹s
 =
UINT_MAX
)

1567 
max_£˘‹s
 = ((
u32
)(
USHRT_MAX
 + 1Ë* 
bs
) >> 9;

1569 
max_£˘‹s
 = ((
u32
)(
ns
->
˘æ
->
max_hw_£˘‹s
 + 1Ë* 
bs
) >> 9;

1571 
	`blk_queue_max_wrôe_zî€s_£˘‹s
(
disk
->
queue
, 
max_£˘‹s
);

1572 
	}
}

1574 
	$nvme_ªp‹t_ns_ids
(
nvme_˘æ
 *
˘æ
, 
nsid
,

1575 
nvme_id_ns
 *
id
, 
nvme_ns_ids
 *
ids
)

1577 
	`mem£t
(
ids
, 0, (*ids));

1579 i‡(
˘æ
->
vs
 >
	`NVME_VS
(1, 1, 0))

1580 
	`mem˝y
(
ids
->
eui64
, 
id
->eui64, (id->eui64));

1581 i‡(
˘æ
->
vs
 >
	`NVME_VS
(1, 2, 0))

1582 
	`mem˝y
(
ids
->
nguid
, 
id
->nguid, (id->nguid));

1583 i‡(
˘æ
->
vs
 >
	`NVME_VS
(1, 3, 0)) {

1587 i‡(
	`nvme_idítify_ns_descs
(
˘æ
, 
nsid
, 
ids
))

1588 
	`dev_w¨n
(
˘æ
->
devi˚
,

1589 "%s: Idítify Des¸ùt‹†Áûed\n", 
__func__
);

1591 
	}
}

1593 
boﬁ
 
	$nvme_ns_ids_vÆid
(
nvme_ns_ids
 *
ids
)

1595  !
	`uuid_is_nuŒ
(&
ids
->
uuid
) ||

1596 
	`memchr_öv
(
ids
->
nguid
, 0, (ids->nguid)) ||

1597 
	`memchr_öv
(
ids
->
eui64
, 0, (ids->eui64));

1598 
	}
}

1600 
boﬁ
 
	$nvme_ns_ids_equÆ
(
nvme_ns_ids
 *
a
, nvme_ns_id†*
b
)

1602  
	`uuid_equÆ
(&
a
->
uuid
, &
b
->uuid) &&

1603 
	`memcmp
(&
a
->
nguid
, &
b
->nguid, (a->nguid)) == 0 &&

1604 
	`memcmp
(&
a
->
eui64
, &
b
->eui64, (a->eui64)) == 0;

1605 
	}
}

1607 
	$nvme_upd©e_disk_öfo
(
gídisk
 *
disk
,

1608 
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

1610 
£˘‹_t
 
ˇ∑côy
 = 
	`À64_to_˝up
(&
id
->
nsze
Ë<< (
ns
->
lba_shi·
 - 9);

1611 
bs
 = 1 << 
ns
->
lba_shi·
;

1613 i‡(
ns
->
lba_shi·
 > 
PAGE_SHIFT
) {

1615 
bs
 = (1 << 9);

1617 
	`blk_mq_‰ìze_queue
(
disk
->
queue
);

1618 
	`blk_öãgrôy_uƒegi°î
(
disk
);

1620 
	`blk_queue_logiˇl_block_size
(
disk
->
queue
, 
bs
);

1621 
	`blk_queue_physiˇl_block_size
(
disk
->
queue
, 
bs
);

1622 
	`blk_queue_io_mö
(
disk
->
queue
, 
bs
);

1624 i‡(
ns
->
ms
 && !ns->
ext
 &&

1625 (
ns
->
˘æ
->
›s
->
Êags
 & 
NVME_F_METADATA_SUPPORTED
))

1626 
	`nvme_öô_öãgrôy
(
disk
, 
ns
->
ms
,Çs->
pi_ty≥
);

1627 i‡((
ns
->
ms
 && !
	`nvme_ns_has_pi
“sË&& !
	`blk_gë_öãgrôy
(
disk
)) ||

1628 
ns
->
lba_shi·
 > 
PAGE_SHIFT
)

1629 
ˇ∑côy
 = 0;

1631 
	`£t_ˇ∑côy
(
disk
, 
ˇ∑côy
);

1633 
	`nvme_c⁄fig_disˇrd
(
disk
, 
ns
);

1634 
	`nvme_c⁄fig_wrôe_zî€s
(
disk
, 
ns
);

1636 i‡(
id
->
nßâr
 & (1 << 0))

1637 
	`£t_disk_ro
(
disk
, 
åue
);

1639 
	`£t_disk_ro
(
disk
, 
Ál£
);

1641 
	`blk_mq_un‰ìze_queue
(
disk
->
queue
);

1642 
	}
}

1644 
	$__nvme_ªvÆid©e_disk
(
gídisk
 *
disk
, 
nvme_id_ns
 *
id
)

1646 
nvme_ns
 *
ns
 = 
disk
->
¥iv©e_d©a
;

1652 
ns
->
lba_shi·
 = 
id
->
lbaf
[id->
Êbas
 & 
NVME_NS_FLBAS_LBA_MASK
].
ds
;

1653 i‡(
ns
->
lba_shi·
 == 0)

1654 
ns
->
lba_shi·
 = 9;

1655 
ns
->
noiob
 = 
	`À16_to_˝u
(
id
->noiob);

1656 
ns
->
ms
 = 
	`À16_to_˝u
(
id
->
lbaf
[id->
Êbas
 & 
NVME_NS_FLBAS_LBA_MASK
].ms);

1657 
ns
->
ext
 =Çs->
ms
 && (
id
->
Êbas
 & 
NVME_NS_FLBAS_META_EXT
);

1659 i‡(
ns
->
ms
 =(
t10_pi_tu∂e
))

1660 
ns
->
pi_ty≥
 = 
id
->
dps
 & 
NVME_NS_DPS_PI_MASK
;

1662 
ns
->
pi_ty≥
 = 0;

1664 i‡(
ns
->
noiob
)

1665 
	`nvme_£t_chunk_size
(
ns
);

1666 
	`nvme_upd©e_disk_öfo
(
disk
, 
ns
, 
id
);

1667 #ifde‡
CONFIG_NVME_MULTIPATH


1668 i‡(
ns
->
hód
->
disk
) {

1669 
	`nvme_upd©e_disk_öfo
(
ns
->
hód
->
disk
,Çs, 
id
);

1670 
	`blk_queue_°ack_limôs
(
ns
->
hód
->
disk
->
queue
,Çs->queue);

1673 
	}
}

1675 
	$nvme_ªvÆid©e_disk
(
gídisk
 *
disk
)

1677 
nvme_ns
 *
ns
 = 
disk
->
¥iv©e_d©a
;

1678 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

1679 
nvme_id_ns
 *
id
;

1680 
nvme_ns_ids
 
ids
;

1681 
ªt
 = 0;

1683 i‡(
	`ã°_bô
(
NVME_NS_DEAD
, &
ns
->
Êags
)) {

1684 
	`£t_ˇ∑côy
(
disk
, 0);

1685  -
ENODEV
;

1688 
id
 = 
	`nvme_idítify_ns
(
˘æ
, 
ns
->
hód
->
ns_id
);

1689 i‡(!
id
)

1690  -
ENODEV
;

1692 i‡(
id
->
nˇp
 == 0) {

1693 
ªt
 = -
ENODEV
;

1694 
out
;

1697 
	`__nvme_ªvÆid©e_disk
(
disk
, 
id
);

1698 
	`nvme_ªp‹t_ns_ids
(
˘æ
, 
ns
->
hód
->
ns_id
, 
id
, &
ids
);

1699 i‡(!
	`nvme_ns_ids_equÆ
(&
ns
->
hód
->
ids
, &ids)) {

1700 
	`dev_îr
(
˘æ
->
devi˚
,

1701 "idítifõr†ch™ged f‹Çsid %d\n", 
ns
->
hód
->
ns_id
);

1702 
ªt
 = -
ENODEV
;

1705 
out
:

1706 
	`k‰ì
(
id
);

1707  
ªt
;

1708 
	}
}

1710 
	$nvme_¥_ty≥
(
¥_ty≥
 
ty≥
)

1712 
ty≥
) {

1713 
PR_WRITE_EXCLUSIVE
:

1715 
PR_EXCLUSIVE_ACCESS
:

1717 
PR_WRITE_EXCLUSIVE_REG_ONLY
:

1719 
PR_EXCLUSIVE_ACCESS_REG_ONLY
:

1721 
PR_WRITE_EXCLUSIVE_ALL_REGS
:

1723 
PR_EXCLUSIVE_ACCESS_ALL_REGS
:

1728 
	}
};

1730 
	$nvme_¥_comm™d
(
block_devi˚
 *
bdev
, 
u32
 
cdw10
,

1731 
u64
 
key
, u64 
ß_key
, 
u8
 
›
)

1733 
nvme_ns_hód
 *
hód
 = 
NULL
;

1734 
nvme_ns
 *
ns
;

1735 
nvme_comm™d
 
c
;

1736 
§cu_idx
, 
ªt
;

1737 
u8
 
d©a
[16] = { 0, };

1739 
ns
 = 
	`nvme_gë_ns_‰om_disk
(
bdev
->
bd_disk
, &
hód
, &
§cu_idx
);

1740 i‡(
	`u∆ikñy
(!
ns
))

1741  -
EWOULDBLOCK
;

1743 
	`put_u«lig√d_À64
(
key
, &
d©a
[0]);

1744 
	`put_u«lig√d_À64
(
ß_key
, &
d©a
[8]);

1746 
	`mem£t
(&
c
, 0, (c));

1747 
c
.
comm⁄
.
›code
 = 
›
;

1748 
c
.
comm⁄
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

1749 
c
.
comm⁄
.
cdw10
 = 
	`˝u_to_À32
(cdw10);

1751 
ªt
 = 
	`nvme_submô_sync_cmd
(
ns
->
queue
, &
c
, 
d©a
, 16);

1752 
	`nvme_put_ns_‰om_disk
(
hód
, 
§cu_idx
);

1753  
ªt
;

1754 
	}
}

1756 
	$nvme_¥_ªgi°î
(
block_devi˚
 *
bdev
, 
u64
 
ﬁd
,

1757 
u64
 
√w
, 
Êags
)

1759 
u32
 
cdw10
;

1761 i‡(
Êags
 & ~
PR_FL_IGNORE_KEY
)

1762  -
EOPNOTSUPP
;

1764 
cdw10
 = 
ﬁd
 ? 2 : 0;

1765 
cdw10
 |(
Êags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0;

1766 
cdw10
 |= (1 << 30) | (1 << 31);

1767  
	`nvme_¥_comm™d
(
bdev
, 
cdw10
, 
ﬁd
, 
√w
, 
nvme_cmd_ªsv_ªgi°î
);

1768 
	}
}

1770 
	$nvme_¥_ª£rve
(
block_devi˚
 *
bdev
, 
u64
 
key
,

1771 
¥_ty≥
 
ty≥
, 
Êags
)

1773 
u32
 
cdw10
;

1775 i‡(
Êags
 & ~
PR_FL_IGNORE_KEY
)

1776  -
EOPNOTSUPP
;

1778 
cdw10
 = 
	`nvme_¥_ty≥
(
ty≥
) << 8;

1779 
cdw10
 |((
Êags
 & 
PR_FL_IGNORE_KEY
) ? 1 << 3 : 0);

1780  
	`nvme_¥_comm™d
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_ªsv_acquúe
);

1781 
	}
}

1783 
	$nvme_¥_¥ìm±
(
block_devi˚
 *
bdev
, 
u64
 
ﬁd
, u64 
√w
,

1784 
¥_ty≥
 
ty≥
, 
boﬁ
 
ab‹t
)

1786 
u32
 
cdw10
 = 
	`nvme_¥_ty≥
(
ty≥
Ë<< 8 | (
ab‹t
 ? 2 : 1);

1787  
	`nvme_¥_comm™d
(
bdev
, 
cdw10
, 
ﬁd
, 
√w
, 
nvme_cmd_ªsv_acquúe
);

1788 
	}
}

1790 
	$nvme_¥_˛ór
(
block_devi˚
 *
bdev
, 
u64
 
key
)

1792 
u32
 
cdw10
 = 1 | (
key
 ? 1 << 3 : 0);

1793  
	`nvme_¥_comm™d
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_ªsv_ªgi°î
);

1794 
	}
}

1796 
	$nvme_¥_ªÀa£
(
block_devi˚
 *
bdev
, 
u64
 
key
, 
¥_ty≥
 
ty≥
)

1798 
u32
 
cdw10
 = 
	`nvme_¥_ty≥
(
ty≥
Ë<< 8 | (
key
 ? 1 << 3 : 0);

1799  
	`nvme_¥_comm™d
(
bdev
, 
cdw10
, 
key
, 0, 
nvme_cmd_ªsv_ªÀa£
);

1800 
	}
}

1802 c⁄° 
¥_›s
 
	gnvme_¥_›s
 = {

1803 .
¥_ªgi°î
 = 
nvme_¥_ªgi°î
,

1804 .
	g¥_ª£rve
 = 
nvme_¥_ª£rve
,

1805 .
	g¥_ªÀa£
 = 
nvme_¥_ªÀa£
,

1806 .
	g¥_¥ìm±
 = 
nvme_¥_¥ìm±
,

1807 .
	g¥_˛ór
 = 
nvme_¥_˛ór
,

1810 #ifde‡
CONFIG_BLK_SED_OPAL


1811 
	$nvme_£c_submô
(*
d©a
, 
u16
 
••
, 
u8
 
£˝
, *
buf„r
, 
size_t
 
Àn
,

1812 
boﬁ
 
£nd
)

1814 
nvme_˘æ
 *
˘æ
 = 
d©a
;

1815 
nvme_comm™d
 
cmd
;

1817 
	`mem£t
(&
cmd
, 0, (cmd));

1818 i‡(
£nd
)

1819 
cmd
.
comm⁄
.
›code
 = 
nvme_admö_£curôy_£nd
;

1821 
cmd
.
comm⁄
.
›code
 = 
nvme_admö_£curôy_ªcv
;

1822 
cmd
.
comm⁄
.
nsid
 = 0;

1823 
cmd
.
comm⁄
.
cdw10
 = 
	`˝u_to_À32
(((
u32
)
£˝
Ë<< 24 | ((u32)
••
) << 8);

1824 
cmd
.
comm⁄
.
cdw11
 = 
	`˝u_to_À32
(
Àn
);

1826  
	`__nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
cmd
, 
NULL
, 
buf„r
, 
Àn
,

1827 
ADMIN_TIMEOUT
, 
NVME_QID_ANY
, 1, 0, 
Ál£
);

1828 
	}
}

1829 
EXPORT_SYMBOL_GPL
(
nvme_£c_submô
);

1832 c⁄° 
block_devi˚_›î©i⁄s
 
	gnvme_f›s
 = {

1833 .
ow√r
 = 
THIS_MODULE
,

1834 .
	gio˘l
 = 
nvme_io˘l
,

1835 .
	gcom∑t_io˘l
 = 
nvme_io˘l
,

1836 .
	g›í
 = 
nvme_›í
,

1837 .
	gªÀa£
 = 
nvme_ªÀa£
,

1838 .
	ggëgeo
 = 
nvme_gëgeo
,

1839 .
	gªvÆid©e_disk

nvme_ªvÆid©e_disk
,

1840 .
	g¥_›s
 = &
nvme_¥_›s
,

1843 #ifde‡
CONFIG_NVME_MULTIPATH


1844 
	$nvme_ns_hód_›í
(
block_devi˚
 *
bdev
, 
fmode_t
 
mode
)

1846 
nvme_ns_hód
 *
hód
 = 
bdev
->
bd_disk
->
¥iv©e_d©a
;

1848 i‡(!
	`kªf_gë_u∆ess_zîo
(&
hód
->
ªf
))

1849  -
ENXIO
;

1851 
	}
}

1853 
	$nvme_ns_hód_ªÀa£
(
gídisk
 *
disk
, 
fmode_t
 
mode
)

1855 
	`nvme_put_ns_hód
(
disk
->
¥iv©e_d©a
);

1856 
	}
}

1858 c⁄° 
block_devi˚_›î©i⁄s
 
	gnvme_ns_hód_›s
 = {

1859 .
ow√r
 = 
THIS_MODULE
,

1860 .
	g›í
 = 
nvme_ns_hód_›í
,

1861 .
	gªÀa£
 = 
nvme_ns_hód_ªÀa£
,

1862 .
	gio˘l
 = 
nvme_io˘l
,

1863 .
	gcom∑t_io˘l
 = 
nvme_io˘l
,

1864 .
	ggëgeo
 = 
nvme_gëgeo
,

1865 .
	g¥_›s
 = &
nvme_¥_›s
,

1869 
	$nvme_waô_ªady
(
nvme_˘æ
 *
˘æ
, 
u64
 
ˇp
, 
boﬁ
 
íabÀd
)

1871 
timeout
 =

1872 ((
	`NVME_CAP_TIMEOUT
(
ˇp
Ë+ 1Ë* 
HZ
 / 2Ë+ 
jiffõs
;

1873 
u32
 
c°s
, 
bô
 = 
íabÀd
 ? 
NVME_CSTS_RDY
 : 0;

1874 
ªt
;

1876 (
ªt
 = 
˘æ
->
›s
->
	`ªg_ªad32
(˘æ, 
NVME_REG_CSTS
, &
c°s
)) == 0) {

1877 i‡(
c°s
 == ~0)

1878  -
ENODEV
;

1879 i‡((
c°s
 & 
NVME_CSTS_RDY
Ë=
bô
)

1882 
	`m¶ìp
(100);

1883 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

1884  -
EINTR
;

1885 i‡(
	`time_a·î
(
jiffõs
, 
timeout
)) {

1886 
	`dev_îr
(
˘æ
->
devi˚
,

1887 "Devi˚ÇŸÑódy;áb‹tög %s\n", 
íabÀd
 ?

1889  -
ENODEV
;

1893  
ªt
;

1894 
	}
}

1902 
	$nvme_dißbÀ_˘æ
(
nvme_˘æ
 *
˘æ
, 
u64
 
ˇp
)

1904 
ªt
;

1906 
˘æ
->
˘æ_c⁄fig
 &~
NVME_CC_SHN_MASK
;

1907 
˘æ
->
˘æ_c⁄fig
 &~
NVME_CC_ENABLE
;

1909 
ªt
 = 
˘æ
->
›s
->
	`ªg_wrôe32
(˘æ, 
NVME_REG_CC
, cål->
˘æ_c⁄fig
);

1910 i‡(
ªt
)

1911  
ªt
;

1913 i‡(
˘æ
->
quúks
 & 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
)

1914 
	`m¶ìp
(
NVME_QUIRK_DELAY_AMOUNT
);

1916  
	`nvme_waô_ªady
(
˘æ
, 
ˇp
, 
Ál£
);

1917 
	}
}

1918 
EXPORT_SYMBOL_GPL
(
nvme_dißbÀ_˘æ
);

1920 
	$nvme_íabÀ_˘æ
(
nvme_˘æ
 *
˘æ
, 
u64
 
ˇp
)

1927 
dev_∑ge_mö
 = 
	`NVME_CAP_MPSMIN
(
ˇp
Ë+ 12, 
∑ge_shi·
 = 12;

1928 
ªt
;

1930 i‡(
∑ge_shi·
 < 
dev_∑ge_mö
) {

1931 
	`dev_îr
(
˘æ
->
devi˚
,

1933 1 << 
dev_∑ge_mö
, 1 << 
∑ge_shi·
);

1934  -
ENODEV
;

1937 
˘æ
->
∑ge_size
 = 1 << 
∑ge_shi·
;

1939 
˘æ
->
˘æ_c⁄fig
 = 
NVME_CC_CSS_NVM
;

1940 
˘æ
->
˘æ_c⁄fig
 |(
∑ge_shi·
 - 12Ë<< 
NVME_CC_MPS_SHIFT
;

1941 
˘æ
->
˘æ_c⁄fig
 |
NVME_CC_AMS_RR
 | 
NVME_CC_SHN_NONE
;

1942 
˘æ
->
˘æ_c⁄fig
 |
NVME_CC_IOSQES
 | 
NVME_CC_IOCQES
;

1943 
˘æ
->
˘æ_c⁄fig
 |
NVME_CC_ENABLE
;

1945 
ªt
 = 
˘æ
->
›s
->
	`ªg_wrôe32
(˘æ, 
NVME_REG_CC
, cål->
˘æ_c⁄fig
);

1946 i‡(
ªt
)

1947  
ªt
;

1948  
	`nvme_waô_ªady
(
˘æ
, 
ˇp
, 
åue
);

1949 
	}
}

1950 
EXPORT_SYMBOL_GPL
(
nvme_íabÀ_˘æ
);

1952 
	$nvme_shutdown_˘æ
(
nvme_˘æ
 *
˘æ
)

1954 
timeout
 = 
jiffõs
 + (
˘æ
->
shutdown_timeout
 * 
HZ
);

1955 
u32
 
c°s
;

1956 
ªt
;

1958 
˘æ
->
˘æ_c⁄fig
 &~
NVME_CC_SHN_MASK
;

1959 
˘æ
->
˘æ_c⁄fig
 |
NVME_CC_SHN_NORMAL
;

1961 
ªt
 = 
˘æ
->
›s
->
	`ªg_wrôe32
(˘æ, 
NVME_REG_CC
, cål->
˘æ_c⁄fig
);

1962 i‡(
ªt
)

1963  
ªt
;

1965 (
ªt
 = 
˘æ
->
›s
->
	`ªg_ªad32
(˘æ, 
NVME_REG_CSTS
, &
c°s
)) == 0) {

1966 i‡((
c°s
 & 
NVME_CSTS_SHST_MASK
Ë=
NVME_CSTS_SHST_CMPLT
)

1969 
	`m¶ìp
(100);

1970 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

1971  -
EINTR
;

1972 i‡(
	`time_a·î
(
jiffõs
, 
timeout
)) {

1973 
	`dev_îr
(
˘æ
->
devi˚
,

1975  -
ENODEV
;

1979  
ªt
;

1980 
	}
}

1981 
EXPORT_SYMBOL_GPL
(
nvme_shutdown_˘æ
);

1983 
	$nvme_£t_queue_limôs
(
nvme_˘æ
 *
˘æ
,

1984 
ªque°_queue
 *
q
)

1986 
boﬁ
 
vwc
 = 
Ál£
;

1988 i‡(
˘æ
->
max_hw_£˘‹s
) {

1989 
u32
 
max_£gmíts
 =

1990 (
˘æ
->
max_hw_£˘‹s
 / (˘æ->
∑ge_size
 >> 9)) + 1;

1992 
max_£gmíts
 = 
	`mö_nŸ_zîo
(max_£gmíts, 
˘æ
->max_segments);

1993 
	`blk_queue_max_hw_£˘‹s
(
q
, 
˘æ
->
max_hw_£˘‹s
);

1994 
	`blk_queue_max_£gmíts
(
q
, 
	`mö_t
(
u32
, 
max_£gmíts
, 
USHRT_MAX
));

1996 i‡((
˘æ
->
quúks
 & 
NVME_QUIRK_STRIPE_SIZE
) &&

1997 
	`is_powî_of_2
(
˘æ
->
max_hw_£˘‹s
))

1998 
	`blk_queue_chunk_£˘‹s
(
q
, 
˘æ
->
max_hw_£˘‹s
);

1999 
	`blk_queue_vút_bound¨y
(
q
, 
˘æ
->
∑ge_size
 - 1);

2000 i‡(
˘æ
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

2001 
vwc
 = 
åue
;

2002 
	`blk_queue_wrôe_ˇche
(
q
, 
vwc
, vwc);

2003 
	}
}

2005 
	$nvme_c⁄figuª_time°amp
(
nvme_˘æ
 *
˘æ
)

2007 
__À64
 
ts
;

2008 
ªt
;

2010 i‡(!(
˘æ
->
⁄cs
 & 
NVME_CTRL_ONCS_TIMESTAMP
))

2013 
ts
 = 
	`˝u_to_À64
(
	`ktime_to_ms
(
	`ktime_gë_ªÆ
()));

2014 
ªt
 = 
	`nvme_£t_„©uªs
(
˘æ
, 
NVME_FEAT_TIMESTAMP
, 0, &
ts
, (ts),

2015 
NULL
);

2016 i‡(
ªt
)

2017 
	`dev_w¨n_⁄˚
(
˘æ
->
devi˚
,

2018 "couldÇŸ sëÅime°am∞(%d)\n", 
ªt
);

2019  
ªt
;

2020 
	}
}

2022 
	$nvme_c⁄figuª_a¸e
(
nvme_˘æ
 *
˘æ
)

2024 
nvme_„©_ho°_behavi‹
 *
ho°
;

2025 
ªt
;

2028 i‡(!
˘æ
->
¸dt
[0])

2031 
ho°
 = 
	`kzÆloc
((*ho°), 
GFP_KERNEL
);

2032 i‡(!
ho°
)

2035 
ho°
->
a¸e
 = 
NVME_ENABLE_ACRE
;

2036 
ªt
 = 
	`nvme_£t_„©uªs
(
˘æ
, 
NVME_FEAT_HOST_BEHAVIOR
, 0,

2037 
ho°
, (*ho°), 
NULL
);

2038 
	`k‰ì
(
ho°
);

2039  
ªt
;

2040 
	}
}

2042 
	$nvme_c⁄figuª_≠°
(
nvme_˘æ
 *
˘æ
)

2060 
≠°e
;

2061 
nvme_„©_auto_p°
 *
èbÀ
;

2062 
u64
 
max_œt_us
 = 0;

2063 
max_ps
 = -1;

2064 
ªt
;

2070 i‡(!
˘æ
->
≠°a
)

2073 i‡(
˘æ
->
≈ss
 > 31) {

2074 
	`dev_w¨n
(
˘æ
->
devi˚
, "NPSS is invalid;Çot using APST\n");

2078 
èbÀ
 = 
	`kzÆloc
((*èbÀ), 
GFP_KERNEL
);

2079 i‡(!
èbÀ
)

2082 i‡(!
˘æ
->
≠°_íabÀd
 || cål->
ps_max_œãncy_us
 == 0) {

2084 
≠°e
 = 0;

2085 
	`dev_dbg
(
˘æ
->
devi˚
, "APST disabled\n");

2087 
__À64
 
èrgë
 = 
	`˝u_to_À64
(0);

2088 
°©e
;

2096 
°©e
 = ()
˘æ
->
≈ss
; state >= 0; state--) {

2097 
u64
 
tŸÆ_œãncy_us
, 
exô_œãncy_us
, 
å™sôi⁄_ms
;

2099 i‡(
èrgë
)

2100 
èbÀ
->
íåõs
[
°©e
] = 
èrgë
;

2106 i‡(
°©e
 =
˘æ
->
≈ss
 &&

2107 (
˘æ
->
quúks
 & 
NVME_QUIRK_NO_DEEPEST_PS
))

2114 i‡(!(
˘æ
->
psd
[
°©e
].
Êags
 &

2115 
NVME_PS_FLAGS_NON_OP_STATE
))

2118 
exô_œãncy_us
 =

2119 (
u64
)
	`À32_to_˝u
(
˘æ
->
psd
[
°©e
].
exô_œt
);

2120 i‡(
exô_œãncy_us
 > 
˘æ
->
ps_max_œãncy_us
)

2123 
tŸÆ_œãncy_us
 =

2124 
exô_œãncy_us
 +

2125 
	`À32_to_˝u
(
˘æ
->
psd
[
°©e
].
íåy_œt
);

2131 
å™sôi⁄_ms
 = 
tŸÆ_œãncy_us
 + 19;

2132 
	`do_div
(
å™sôi⁄_ms
, 20);

2133 i‡(
å™sôi⁄_ms
 > (1 << 24) - 1)

2134 
å™sôi⁄_ms
 = (1 << 24) - 1;

2136 
èrgë
 = 
	`˝u_to_À64
((
°©e
 << 3) |

2137 (
å™sôi⁄_ms
 << 8));

2139 i‡(
max_ps
 == -1)

2140 
max_ps
 = 
°©e
;

2142 i‡(
tŸÆ_œãncy_us
 > 
max_œt_us
)

2143 
max_œt_us
 = 
tŸÆ_œãncy_us
;

2146 
≠°e
 = 1;

2148 i‡(
max_ps
 == -1) {

2149 
	`dev_dbg
(
˘æ
->
devi˚
, "APSTÉnabled butÇoÇon-operational statesáreávailable\n");

2151 
	`dev_dbg
(
˘æ
->
devi˚
, "APSTÉnabled: max PS = %d, maxÑound-tripÜatency = %lluus,Åable = %*phN\n",

2152 
max_ps
, 
max_œt_us
, ()(*
èbÀ
),Åable);

2156 
ªt
 = 
	`nvme_£t_„©uªs
(
˘æ
, 
NVME_FEAT_AUTO_PST
, 
≠°e
,

2157 
èbÀ
, (*èbÀ), 
NULL
);

2158 i‡(
ªt
)

2159 
	`dev_îr
(
˘æ
->
devi˚
, "ÁûedÅÿ£àAPST fótuª (%d)\n", 
ªt
);

2161 
	`k‰ì
(
èbÀ
);

2162  
ªt
;

2163 
	}
}

2165 
	$nvme_£t_œãncy_tﬁî™˚
(
devi˚
 *
dev
, 
s32
 
vÆ
)

2167 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

2168 
u64
 
œãncy
;

2170 
vÆ
) {

2171 
PM_QOS_LATENCY_TOLERANCE_NO_CONSTRAINT
:

2172 
PM_QOS_LATENCY_ANY
:

2173 
œãncy
 = 
U64_MAX
;

2177 
œãncy
 = 
vÆ
;

2180 i‡(
˘æ
->
ps_max_œãncy_us
 !
œãncy
) {

2181 
˘æ
->
ps_max_œãncy_us
 = 
œãncy
;

2182 
	`nvme_c⁄figuª_≠°
(
˘æ
);

2184 
	}
}

2186 
	snvme_c‹e_quúk_íåy
 {

2192 
u16
 
	mvid
;

2193 c⁄° *
	mmn
;

2194 c⁄° *
	m‰
;

2195 
	mquúks
;

2198 c⁄° 
nvme_c‹e_quúk_íåy
 
	gc‹e_quúks
[] = {

2204 .
vid
 = 0x1179,

2205 .
	gmn
 = "THNSF5256GPUK TOSHIBA",

2206 .
	gquúks
 = 
NVME_QUIRK_NO_APST
,

2211 
boﬁ
 
	$°rög_m©ches
(c⁄° *
id°r
, c⁄° *
m©ch
, 
size_t
 
Àn
)

2213 
size_t
 
m©chÀn
;

2215 i‡(!
m©ch
)

2216  
åue
;

2218 
m©chÀn
 = 
	`°æí
(
m©ch
);

2219 
	`WARN_ON_ONCE
(
m©chÀn
 > 
Àn
);

2221 i‡(
	`memcmp
(
id°r
, 
m©ch
, 
m©chÀn
))

2222  
Ál£
;

2224 ; 
m©chÀn
 < 
Àn
; matchlen++)

2225 i‡(
id°r
[
m©chÀn
] != ' ')

2226  
Ál£
;

2228  
åue
;

2229 
	}
}

2231 
boﬁ
 
	$quúk_m©ches
(c⁄° 
nvme_id_˘æ
 *
id
,

2232 c⁄° 
nvme_c‹e_quúk_íåy
 *
q
)

2234  
q
->
vid
 =
	`À16_to_˝u
(
id
->vid) &&

2235 
	`°rög_m©ches
(
id
->
mn
, 
q
->mn, (id->mn)) &&

2236 
	`°rög_m©ches
(
id
->
‰
, 
q
->fr, (id->fr));

2237 
	}
}

2239 
	$nvme_öô_subnqn
(
nvme_subsy°em
 *
subsys
, 
nvme_˘æ
 *
˘æ
,

2240 
nvme_id_˘æ
 *
id
)

2242 
size_t
 
nq∆í
;

2243 
off
;

2245 if(!(
˘æ
->
quúks
 & 
NVME_QUIRK_IGNORE_DEV_SUBNQN
)) {

2246 
nq∆í
 = 
	`°∫Àn
(
id
->
subnqn
, 
NVMF_NQN_SIZE
);

2247 i‡(
nq∆í
 > 0 &&Çq∆í < 
NVMF_NQN_SIZE
) {

2248 
	`°æ˝y
(
subsys
->
subnqn
, 
id
->subnqn, 
NVMF_NQN_SIZE
);

2252 i‡(
˘æ
->
vs
 >
	`NVME_VS
(1, 2, 1))

2253 
	`dev_w¨n
(
˘æ
->
devi˚
, "missing or invalid SUBNQN field.\n");

2257 
off
 = 
	`¢¥ötf
(
subsys
->
subnqn
, 
NVMF_NQN_SIZE
,

2259 
	`À16_to_˝u
(
id
->
vid
),Üe16_to_˝u(id->
ssvid
));

2260 
	`mem˝y
(
subsys
->
subnqn
 + 
off
, 
id
->
¢
, (id->sn));

2261 
off
 +(
id
->
¢
);

2262 
	`mem˝y
(
subsys
->
subnqn
 + 
off
, 
id
->
mn
, (id->mn));

2263 
off
 +(
id
->
mn
);

2264 
	`mem£t
(
subsys
->
subnqn
 + 
off
, 0, (subsys->subnqn) - off);

2265 
	}
}

2267 
	$__nvme_ªÀa£_subsy°em
(
nvme_subsy°em
 *
subsys
)

2269 
	`ida_sim∂e_ªmove
(&
nvme_subsy°ems_ida
, 
subsys
->
ö°™˚
);

2270 
	`k‰ì
(
subsys
);

2271 
	}
}

2273 
	$nvme_ªÀa£_subsy°em
(
devi˚
 *
dev
)

2275 
	`__nvme_ªÀa£_subsy°em
(
	`c⁄èöî_of
(
dev
, 
nvme_subsy°em
, dev));

2276 
	}
}

2278 
	$nvme_de°roy_subsy°em
(
kªf
 *
ªf
)

2280 
nvme_subsy°em
 *
subsys
 =

2281 
	`c⁄èöî_of
(
ªf
, 
nvme_subsy°em
,Ñef);

2283 
	`muãx_lock
(&
nvme_subsy°ems_lock
);

2284 
	`li°_dñ
(&
subsys
->
íåy
);

2285 
	`muãx_u∆ock
(&
nvme_subsy°ems_lock
);

2287 
	`ida_de°roy
(&
subsys
->
ns_ida
);

2288 
	`devi˚_dñ
(&
subsys
->
dev
);

2289 
	`put_devi˚
(&
subsys
->
dev
);

2290 
	}
}

2292 
	$nvme_put_subsy°em
(
nvme_subsy°em
 *
subsys
)

2294 
	`kªf_put
(&
subsys
->
ªf
, 
nvme_de°roy_subsy°em
);

2295 
	}
}

2297 
nvme_subsy°em
 *
	$__nvme_föd_gë_subsy°em
(c⁄° *
subsy¢qn
)

2299 
nvme_subsy°em
 *
subsys
;

2301 
	`lockdï_as£π_hñd
(&
nvme_subsy°ems_lock
);

2303 
	`li°_f‹_óch_íåy
(
subsys
, &
nvme_subsy°ems
, 
íåy
) {

2304 i‡(
	`°rcmp
(
subsys
->
subnqn
, 
subsy¢qn
))

2306 i‡(!
	`kªf_gë_u∆ess_zîo
(&
subsys
->
ªf
))

2308  
subsys
;

2311  
NULL
;

2312 
	}
}

2314 
	#SUBSYS_ATTR_RO
(
_«me
, 
_mode
, 
_show
) \

2315 
devi˚_©åibuã
 
subsys_©å_
##
_«me
 = \

2316 
	`__ATTR
(
_«me
, 
_mode
, 
_show
, 
NULL
)

	)

2318 
ssize_t
 
	$nvme_subsys_show_nqn
(
devi˚
 *
dev
,

2319 
devi˚_©åibuã
 *
©å
,

2320 *
buf
)

2322 
nvme_subsy°em
 *
subsys
 =

2323 
	`c⁄èöî_of
(
dev
, 
nvme_subsy°em
, dev);

2325  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%s\n", 
subsys
->
subnqn
);

2326 
	}
}

2327 
SUBSYS_ATTR_RO
(
subsy¢qn
, 
S_IRUGO
, 
nvme_subsys_show_nqn
);

2329 
	#nvme_subsys_show_°r_fun˘i⁄
(
fõld
) \

2330 
ssize_t
 
subsys_
##
fõld
##
	`_show
(
devi˚
 *
dev
, \

2331 
devi˚_©åibuã
 *
©å
, *
buf
) \

2333 
nvme_subsy°em
 *
subsys
 = \

2334 
	`c⁄èöî_of
(
dev
, 
nvme_subsy°em
, dev); \

2335  
	`•rötf
(
buf
, "%.*s\n", \

2336 ()(
subsys
->
fõld
), subsys->field); \

2338 
	`SUBSYS_ATTR_RO
(
fõld
, 
S_IRUGO
, 
subsys_
##fõld##
_show
);

	)

2340 
nvme_subsys_show_°r_fun˘i⁄
(
modñ
);

2341 
nvme_subsys_show_°r_fun˘i⁄
(
£rül
);

2342 
nvme_subsys_show_°r_fun˘i⁄
(
fúmw¨e_ªv
);

2344 
©åibuã
 *
	gnvme_subsys_©ås
[] = {

2345 &
subsys_©å_modñ
.
©å
,

2346 &
subsys_©å_£rül
.
©å
,

2347 &
subsys_©å_fúmw¨e_ªv
.
©å
,

2348 &
subsys_©å_subsy¢qn
.
©å
,

2349 #ifde‡
CONFIG_NVME_MULTIPATH


2350 &
subsys_©å_i›ﬁicy
.
©å
,

2352 
NULL
,

2355 
©åibuã_group
 
	gnvme_subsys_©ås_group
 = {

2356 .
©ås
 = 
nvme_subsys_©ås
,

2359 c⁄° 
©åibuã_group
 *
	gnvme_subsys_©ås_groups
[] = {

2360 &
nvme_subsys_©ås_group
,

2361 
NULL
,

2364 
	$nvme_a˘ive_˘æs
(
nvme_subsy°em
 *
subsys
)

2366 
cou¡
 = 0;

2367 
nvme_˘æ
 *
˘æ
;

2369 
	`muãx_lock
(&
subsys
->
lock
);

2370 
	`li°_f‹_óch_íåy
(
˘æ
, &
subsys
->
˘æs
, 
subsys_íåy
) {

2371 i‡(
˘æ
->
°©e
 !
NVME_CTRL_DELETING
 &&

2372 
˘æ
->
°©e
 !
NVME_CTRL_DEAD
)

2373 
cou¡
++;

2375 
	`muãx_u∆ock
(&
subsys
->
lock
);

2377  
cou¡
;

2378 
	}
}

2380 
	$nvme_öô_subsy°em
(
nvme_˘æ
 *
˘æ
, 
nvme_id_˘æ
 *
id
)

2382 
nvme_subsy°em
 *
subsys
, *
found
;

2383 
ªt
;

2385 
subsys
 = 
	`kzÆloc
((*subsys), 
GFP_KERNEL
);

2386 i‡(!
subsys
)

2387  -
ENOMEM
;

2388 
ªt
 = 
	`ida_sim∂e_gë
(&
nvme_subsy°ems_ida
, 0, 0, 
GFP_KERNEL
);

2389 i‡(
ªt
 < 0) {

2390 
	`k‰ì
(
subsys
);

2391  
ªt
;

2393 
subsys
->
ö°™˚
 = 
ªt
;

2394 
	`muãx_öô
(&
subsys
->
lock
);

2395 
	`kªf_öô
(&
subsys
->
ªf
);

2396 
	`INIT_LIST_HEAD
(&
subsys
->
˘æs
);

2397 
	`INIT_LIST_HEAD
(&
subsys
->
nshóds
);

2398 
	`nvme_öô_subnqn
(
subsys
, 
˘æ
, 
id
);

2399 
	`mem˝y
(
subsys
->
£rül
, 
id
->
¢
, (subsys->serial));

2400 
	`mem˝y
(
subsys
->
modñ
, 
id
->
mn
, (subsys->model));

2401 
	`mem˝y
(
subsys
->
fúmw¨e_ªv
, 
id
->
‰
, (subsys->firmware_rev));

2402 
subsys
->
víd‹_id
 = 
	`À16_to_˝u
(
id
->
vid
);

2403 
subsys
->
cmic
 = 
id
->cmic;

2404 #ifde‡
CONFIG_NVME_MULTIPATH


2405 
subsys
->
i›ﬁicy
 = 
NVME_IOPOLICY_NUMA
;

2408 
subsys
->
dev
.
˛ass
 = 
nvme_subsys_˛ass
;

2409 
subsys
->
dev
.
ªÀa£
 = 
nvme_ªÀa£_subsy°em
;

2410 
subsys
->
dev
.
groups
 = 
nvme_subsys_©ås_groups
;

2411 
	`dev_£t_«me
(&
subsys
->
dev
, "nvme-subsys%d", subsys->
ö°™˚
);

2412 
	`devi˚_öôülize
(&
subsys
->
dev
);

2414 
	`muãx_lock
(&
nvme_subsy°ems_lock
);

2415 
found
 = 
	`__nvme_föd_gë_subsy°em
(
subsys
->
subnqn
);

2416 i‡(
found
) {

2421 i‡(!(
˘æ
->
›ts
 && cål->›ts->
discovîy_nqn
) &&

2422 
	`nvme_a˘ive_˘æs
(
found
Ë&& !(
id
->
cmic
 & (1 << 1))) {

2423 
	`dev_îr
(
˘æ
->
devi˚
,

2425 
found
->
subnqn
);

2426 
	`nvme_put_subsy°em
(
found
);

2427 
ªt
 = -
EINVAL
;

2428 
out_u∆ock
;

2431 
	`__nvme_ªÀa£_subsy°em
(
subsys
);

2432 
subsys
 = 
found
;

2434 
ªt
 = 
	`devi˚_add
(&
subsys
->
dev
);

2435 i‡(
ªt
) {

2436 
	`dev_îr
(
˘æ
->
devi˚
,

2438 
out_u∆ock
;

2440 
	`ida_öô
(&
subsys
->
ns_ida
);

2441 
	`li°_add_èû
(&
subsys
->
íåy
, &
nvme_subsy°ems
);

2444 
˘æ
->
subsys
 = subsys;

2445 
	`muãx_u∆ock
(&
nvme_subsy°ems_lock
);

2447 i‡(
	`sysfs_¸óã_lök
(&
subsys
->
dev
.
kobj
, &
˘æ
->
devi˚
->kobj,

2448 
	`dev_«me
(
˘æ
->
devi˚
))) {

2449 
	`dev_îr
(
˘æ
->
devi˚
,

2452  -
EINVAL
;

2455 
	`muãx_lock
(&
subsys
->
lock
);

2456 
	`li°_add_èû
(&
˘æ
->
subsys_íåy
, &
subsys
->
˘æs
);

2457 
	`muãx_u∆ock
(&
subsys
->
lock
);

2461 
out_u∆ock
:

2462 
	`muãx_u∆ock
(&
nvme_subsy°ems_lock
);

2463 
	`put_devi˚
(&
subsys
->
dev
);

2464  
ªt
;

2465 
	}
}

2467 
	$nvme_gë_log
(
nvme_˘æ
 *
˘æ
, 
u32
 
nsid
, 
u8
 
log_∑ge
, u8 
l•
,

2468 *
log
, 
size_t
 
size
, 
u64
 
off£t
)

2470 
nvme_comm™d
 
c
 = { };

2471 
dwÀn
 = 
size
 / 4 - 1;

2473 
c
.
gë_log_∑ge
.
›code
 = 
nvme_admö_gë_log_∑ge
;

2474 
c
.
gë_log_∑ge
.
nsid
 = 
	`˝u_to_À32
(nsid);

2475 
c
.
gë_log_∑ge
.
lid
 = 
log_∑ge
;

2476 
c
.
gë_log_∑ge
.
l•
 =Üsp;

2477 
c
.
gë_log_∑ge
.
numdl
 = 
	`˝u_to_À16
(
dwÀn
 & ((1 << 16) - 1));

2478 
c
.
gë_log_∑ge
.
numdu
 = 
	`˝u_to_À16
(
dwÀn
 >> 16);

2479 
c
.
gë_log_∑ge
.
Õﬁ
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
off£t
));

2480 
c
.
gë_log_∑ge
.
Õou
 = 
	`˝u_to_À32
(
	`uµî_32_bôs
(
off£t
));

2482  
	`nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
c
, 
log
, 
size
);

2483 
	}
}

2485 
	$nvme_gë_ef„˘s_log
(
nvme_˘æ
 *
˘æ
)

2487 
ªt
;

2489 i‡(!
˘æ
->
ef„˘s
)

2490 
˘æ
->
ef„˘s
 = 
	`kzÆloc
((*˘æ->ef„˘s), 
GFP_KERNEL
);

2492 i‡(!
˘æ
->
ef„˘s
)

2495 
ªt
 = 
	`nvme_gë_log
(
˘æ
, 
NVME_NSID_ALL
, 
NVME_LOG_CMD_EFFECTS
, 0,

2496 
˘æ
->
ef„˘s
, (*ctrl->effects), 0);

2497 i‡(
ªt
) {

2498 
	`k‰ì
(
˘æ
->
ef„˘s
);

2499 
˘æ
->
ef„˘s
 = 
NULL
;

2501  
ªt
;

2502 
	}
}

2509 
	$nvme_öô_idítify
(
nvme_˘æ
 *
˘æ
)

2511 
nvme_id_˘æ
 *
id
;

2512 
u64
 
ˇp
;

2513 
ªt
, 
∑ge_shi·
;

2514 
u32
 
max_hw_£˘‹s
;

2515 
boﬁ
 
¥ev_≠°_íabÀd
;

2517 
ªt
 = 
˘æ
->
›s
->
	`ªg_ªad32
(˘æ, 
NVME_REG_VS
, &˘æ->
vs
);

2518 i‡(
ªt
) {

2519 
	`dev_îr
(
˘æ
->
devi˚
, "Ródög VS faûed (%d)\n", 
ªt
);

2520  
ªt
;

2523 
ªt
 = 
˘æ
->
›s
->
	`ªg_ªad64
(˘æ, 
NVME_REG_CAP
, &
ˇp
);

2524 i‡(
ªt
) {

2525 
	`dev_îr
(
˘æ
->
devi˚
, "Ródög CAP faûed (%d)\n", 
ªt
);

2526  
ªt
;

2528 
∑ge_shi·
 = 
	`NVME_CAP_MPSMIN
(
ˇp
) + 12;

2530 i‡(
˘æ
->
vs
 >
	`NVME_VS
(1, 1, 0))

2531 
˘æ
->
subsy°em
 = 
	`NVME_CAP_NSSRC
(
ˇp
);

2533 
ªt
 = 
	`nvme_idítify_˘æ
(
˘æ
, &
id
);

2534 i‡(
ªt
) {

2535 
	`dev_îr
(
˘æ
->
devi˚
, "Idítify C⁄åﬁÀ∏Áûed (%d)\n", 
ªt
);

2536  -
EIO
;

2539 i‡(
id
->
Õa
 & 
NVME_CTRL_LPA_CMD_EFFECTS_LOG
) {

2540 
ªt
 = 
	`nvme_gë_ef„˘s_log
(
˘æ
);

2541 i‡(
ªt
 < 0)

2542 
out_‰ì
;

2545 i‡(!
˘æ
->
idítifõd
) {

2546 
i
;

2548 
ªt
 = 
	`nvme_öô_subsy°em
(
˘æ
, 
id
);

2549 i‡(
ªt
)

2550 
out_‰ì
;

2560 
i
 = 0; i < 
	`ARRAY_SIZE
(
c‹e_quúks
); i++) {

2561 i‡(
	`quúk_m©ches
(
id
, &
c‹e_quúks
[
i
]))

2562 
˘æ
->
quúks
 |
c‹e_quúks
[
i
].quirks;

2566 i‡(
f‹˚_≠°
 && (
˘æ
->
quúks
 & 
NVME_QUIRK_NO_DEEPEST_PS
)) {

2567 
	`dev_w¨n
(
˘æ
->
devi˚
, "forciblyállowingállÖower states dueÅoÇvme_core.force_apst -- useát your ownÑisk\n");

2568 
˘æ
->
quúks
 &~
NVME_QUIRK_NO_DEEPEST_PS
;

2571 
˘æ
->
¸dt
[0] = 
	`À16_to_˝u
(
id
->
¸dt1
);

2572 
˘æ
->
¸dt
[1] = 
	`À16_to_˝u
(
id
->
¸dt2
);

2573 
˘æ
->
¸dt
[2] = 
	`À16_to_˝u
(
id
->
¸dt3
);

2575 
˘æ
->
ﬂcs
 = 
	`À16_to_˝u
(
id
->oacs);

2576 
˘æ
->
⁄cs
 = 
	`À16_to_˝up
(&
id
->oncs);

2577 
˘æ
->
ﬂes
 = 
	`À32_to_˝u
(
id
->oaes);

2578 
	`©omic_£t
(&
˘æ
->
ab‹t_limô
, 
id
->
a˛
 + 1);

2579 
˘æ
->
vwc
 = 
id
->vwc;

2580 i‡(
id
->
mdts
)

2581 
max_hw_£˘‹s
 = 1 << (
id
->
mdts
 + 
∑ge_shi·
 - 9);

2583 
max_hw_£˘‹s
 = 
UINT_MAX
;

2584 
˘æ
->
max_hw_£˘‹s
 =

2585 
	`mö_nŸ_zîo
(
˘æ
->
max_hw_£˘‹s
, max_hw_sectors);

2587 
	`nvme_£t_queue_limôs
(
˘æ
, cål->
admö_q
);

2588 
˘æ
->
sgls
 = 
	`À32_to_˝u
(
id
->sgls);

2589 
˘æ
->
kas
 = 
	`À16_to_˝u
(
id
->kas);

2590 
˘æ
->
max_«me•a˚s
 = 
	`À32_to_˝u
(
id
->
m«n
);

2591 
˘æ
->
˘øâ
 = 
	`À32_to_˝u
(
id
->ctratt);

2593 i‡(
id
->
πd3e
) {

2595 
u32
 
å™sôi⁄_time
 = 
	`À32_to_˝u
(
id
->
πd3e
) / 1000000;

2597 
˘æ
->
shutdown_timeout
 = 
	`˛amp_t
(, 
å™sôi⁄_time
,

2598 
shutdown_timeout
, 60);

2600 i‡(
˘æ
->
shutdown_timeout
 != shutdown_timeout)

2601 
	`dev_öfo
(
˘æ
->
devi˚
,

2603 
˘æ
->
shutdown_timeout
);

2605 
˘æ
->
shutdown_timeout
 = shutdown_timeout;

2607 
˘æ
->
≈ss
 = 
id
->npss;

2608 
˘æ
->
≠°a
 = 
id
->apsta;

2609 
¥ev_≠°_íabÀd
 = 
˘æ
->
≠°_íabÀd
;

2610 i‡(
˘æ
->
quúks
 & 
NVME_QUIRK_NO_APST
) {

2611 i‡(
f‹˚_≠°
 && 
id
->
≠°a
) {

2612 
	`dev_w¨n
(
˘æ
->
devi˚
, "forciblyállowing APST dueÅoÇvme_core.force_apst -- useát your ownÑisk\n");

2613 
˘æ
->
≠°_íabÀd
 = 
åue
;

2615 
˘æ
->
≠°_íabÀd
 = 
Ál£
;

2618 
˘æ
->
≠°_íabÀd
 = 
id
->
≠°a
;

2620 
	`mem˝y
(
˘æ
->
psd
, 
id
->psd, (ctrl->psd));

2622 i‡(
˘æ
->
›s
->
Êags
 & 
NVME_F_FABRICS
) {

2623 
˘æ
->
icdoff
 = 
	`À16_to_˝u
(
id
->icdoff);

2624 
˘æ
->
ioccsz
 = 
	`À32_to_˝u
(
id
->ioccsz);

2625 
˘æ
->
i‹csz
 = 
	`À32_to_˝u
(
id
->iorcsz);

2626 
˘æ
->
maxcmd
 = 
	`À16_to_˝u
(
id
->maxcmd);

2632 i‡(
˘æ
->
˙éid
 !
	`À16_to_˝u
(
id
->cntlid)) {

2633 
ªt
 = -
EINVAL
;

2634 
out_‰ì
;

2637 i‡(!
˘æ
->
›ts
->
discovîy_nqn
 && !˘æ->
kas
) {

2638 
	`dev_îr
(
˘æ
->
devi˚
,

2640 
ªt
 = -
EINVAL
;

2641 
out_‰ì
;

2644 
˘æ
->
˙éid
 = 
	`À16_to_˝u
(
id
->cntlid);

2645 
˘æ
->
hm¥e
 = 
	`À32_to_˝u
(
id
->hmpre);

2646 
˘æ
->
hmmö
 = 
	`À32_to_˝u
(
id
->hmmin);

2647 
˘æ
->
hmmöds
 = 
	`À32_to_˝u
(
id
->hmminds);

2648 
˘æ
->
hmmaxd
 = 
	`À16_to_˝u
(
id
->hmmaxd);

2651 
ªt
 = 
	`nvme_m∑th_öô
(
˘æ
, 
id
);

2652 
	`k‰ì
(
id
);

2654 i‡(
ªt
 < 0)

2655  
ªt
;

2657 i‡(
˘æ
->
≠°_íabÀd
 && !
¥ev_≠°_íabÀd
)

2658 
	`dev_pm_qos_expo£_œãncy_tﬁî™˚
(
˘æ
->
devi˚
);

2659 i‡(!
˘æ
->
≠°_íabÀd
 && 
¥ev_≠°_íabÀd
)

2660 
	`dev_pm_qos_hide_œãncy_tﬁî™˚
(
˘æ
->
devi˚
);

2662 
ªt
 = 
	`nvme_c⁄figuª_≠°
(
˘æ
);

2663 i‡(
ªt
 < 0)

2664  
ªt
;

2666 
ªt
 = 
	`nvme_c⁄figuª_time°amp
(
˘æ
);

2667 i‡(
ªt
 < 0)

2668  
ªt
;

2670 
ªt
 = 
	`nvme_c⁄figuª_dúe˘ives
(
˘æ
);

2671 i‡(
ªt
 < 0)

2672  
ªt
;

2674 
ªt
 = 
	`nvme_c⁄figuª_a¸e
(
˘æ
);

2675 i‡(
ªt
 < 0)

2676  
ªt
;

2678 
˘æ
->
idítifõd
 = 
åue
;

2682 
out_‰ì
:

2683 
	`k‰ì
(
id
);

2684  
ªt
;

2685 
	}
}

2686 
EXPORT_SYMBOL_GPL
(
nvme_öô_idítify
);

2688 
	$nvme_dev_›í
(
öode
 *öode, 
fûe
 *file)

2690 
nvme_˘æ
 *
˘æ
 =

2691 
	`c⁄èöî_of
(
öode
->
i_cdev
, 
nvme_˘æ
, 
cdev
);

2693 
˘æ
->
°©e
) {

2694 
NVME_CTRL_LIVE
:

2695 
NVME_CTRL_ADMIN_ONLY
:

2698  -
EWOULDBLOCK
;

2701 
fûe
->
¥iv©e_d©a
 = 
˘æ
;

2703 
	}
}

2705 
	$nvme_dev_u£r_cmd
(
nvme_˘æ
 *
˘æ
, 
__u£r
 *
¨gp
)

2707 
nvme_ns
 *
ns
;

2708 
ªt
;

2710 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

2711 i‡(
	`li°_em±y
(&
˘æ
->
«me•a˚s
)) {

2712 
ªt
 = -
ENOTTY
;

2713 
out_u∆ock
;

2716 
ns
 = 
	`li°_fú°_íåy
(&
˘æ
->
«me•a˚s
, 
nvme_ns
, 
li°
);

2717 i‡(
ns
 !
	`li°_œ°_íåy
(&
˘æ
->
«me•a˚s
, 
nvme_ns
, 
li°
)) {

2718 
	`dev_w¨n
(
˘æ
->
devi˚
,

2720 
ªt
 = -
EINVAL
;

2721 
out_u∆ock
;

2724 
	`dev_w¨n
(
˘æ
->
devi˚
,

2726 
	`kªf_gë
(&
ns
->
kªf
);

2727 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

2729 
ªt
 = 
	`nvme_u£r_cmd
(
˘æ
, 
ns
, 
¨gp
);

2730 
	`nvme_put_ns
(
ns
);

2731  
ªt
;

2733 
out_u∆ock
:

2734 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

2735  
ªt
;

2736 
	}
}

2738 
	$nvme_dev_io˘l
(
fûe
 *fûe, 
cmd
,

2739 
¨g
)

2741 
nvme_˘æ
 *
˘æ
 = 
fûe
->
¥iv©e_d©a
;

2742 
__u£r
 *
¨gp
 = (__u£∏*)
¨g
;

2744 
cmd
) {

2745 
NVME_IOCTL_ADMIN_CMD
:

2746  
	`nvme_u£r_cmd
(
˘æ
, 
NULL
, 
¨gp
);

2747 
NVME_IOCTL_IO_CMD
:

2748  
	`nvme_dev_u£r_cmd
(
˘æ
, 
¨gp
);

2749 
NVME_IOCTL_RESET
:

2750 
	`dev_w¨n
(
˘æ
->
devi˚
, "resetting controller\n");

2751  
	`nvme_ª£t_˘æ_sync
(
˘æ
);

2752 
NVME_IOCTL_SUBSYS_RESET
:

2753  
	`nvme_ª£t_subsy°em
(
˘æ
);

2754 
NVME_IOCTL_RESCAN
:

2755 
	`nvme_queue_sˇn
(
˘æ
);

2758  -
ENOTTY
;

2760 
	}
}

2762 c⁄° 
fûe_›î©i⁄s
 
	gnvme_dev_f›s
 = {

2763 .
ow√r
 = 
THIS_MODULE
,

2764 .
	g›í
 = 
nvme_dev_›í
,

2765 .
	gu∆ocked_io˘l
 = 
nvme_dev_io˘l
,

2766 .
	gcom∑t_io˘l
 = 
nvme_dev_io˘l
,

2769 
ssize_t
 
	$nvme_sysfs_ª£t
(
devi˚
 *
dev
,

2770 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
,

2771 
size_t
 
cou¡
)

2773 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

2774 
ªt
;

2776 
ªt
 = 
	`nvme_ª£t_˘æ_sync
(
˘æ
);

2777 i‡(
ªt
 < 0)

2778  
ªt
;

2779  
cou¡
;

2780 
	}
}

2781 
DEVICE_ATTR
(
ª£t_c⁄åﬁÀr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_ª£t
);

2783 
ssize_t
 
	$nvme_sysfs_ªsˇn
(
devi˚
 *
dev
,

2784 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
,

2785 
size_t
 
cou¡
)

2787 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

2789 
	`nvme_queue_sˇn
(
˘æ
);

2790  
cou¡
;

2791 
	}
}

2792 
DEVICE_ATTR
(
ªsˇn_c⁄åﬁÀr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_ªsˇn
);

2794 
ölöe
 
nvme_ns_hód
 *
	$dev_to_ns_hód
(
devi˚
 *
dev
)

2796 
gídisk
 *
disk
 = 
	`dev_to_disk
(
dev
);

2798 i‡(
disk
->
f›s
 =&
nvme_f›s
)

2799  
	`nvme_gë_ns_‰om_dev
(
dev
)->
hód
;

2801  
disk
->
¥iv©e_d©a
;

2802 
	}
}

2804 
ssize_t
 
	$wwid_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

2805 *
buf
)

2807 
nvme_ns_hód
 *
hód
 = 
	`dev_to_ns_hód
(
dev
);

2808 
nvme_ns_ids
 *
ids
 = &
hód
->ids;

2809 
nvme_subsy°em
 *
subsys
 = 
hód
->subsys;

2810 
£rül_Àn
 = (
subsys
->
£rül
);

2811 
modñ_Àn
 = (
subsys
->
modñ
);

2813 i‡(!
	`uuid_is_nuŒ
(&
ids
->
uuid
))

2814  
	`•rötf
(
buf
, "uuid.%pU\n", &
ids
->
uuid
);

2816 i‡(
	`memchr_öv
(
ids
->
nguid
, 0, (ids->nguid)))

2817  
	`•rötf
(
buf
, "eui.%16phN\n", 
ids
->
nguid
);

2819 i‡(
	`memchr_öv
(
ids
->
eui64
, 0, (ids->eui64)))

2820  
	`•rötf
(
buf
, "eui.%8phN\n", 
ids
->
eui64
);

2822 
£rül_Àn
 > 0 && (
subsys
->
£rül
[serial_len - 1] == ' ' ||

2823 
subsys
->
£rül
[
£rül_Àn
 - 1] == '\0'))

2824 
£rül_Àn
--;

2825 
modñ_Àn
 > 0 && (
subsys
->
modñ
[model_len - 1] == ' ' ||

2826 
subsys
->
modñ
[
modñ_Àn
 - 1] == '\0'))

2827 
modñ_Àn
--;

2829  
	`•rötf
(
buf
, "nvme.%04x-%*phN-%*phN-%08x\n", 
subsys
->
víd‹_id
,

2830 
£rül_Àn
, 
subsys
->
£rül
, 
modñ_Àn
, subsys->
modñ
,

2831 
hód
->
ns_id
);

2832 
	}
}

2833 
DEVICE_ATTR_RO
(
wwid
);

2835 
ssize_t
 
	$nguid_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

2836 *
buf
)

2838  
	`•rötf
(
buf
, "%pU\n", 
	`dev_to_ns_hód
(
dev
)->
ids
.
nguid
);

2839 
	}
}

2840 
DEVICE_ATTR_RO
(
nguid
);

2842 
ssize_t
 
	$uuid_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

2843 *
buf
)

2845 
nvme_ns_ids
 *
ids
 = &
	`dev_to_ns_hód
(
dev
)->ids;

2850 i‡(
	`uuid_is_nuŒ
(&
ids
->
uuid
)) {

2851 
	`¥ötk_øãlimôed
(
KERN_WARNING


2853  
	`•rötf
(
buf
, "%pU\n", 
ids
->
nguid
);

2855  
	`•rötf
(
buf
, "%pU\n", &
ids
->
uuid
);

2856 
	}
}

2857 
DEVICE_ATTR_RO
(
uuid
);

2859 
ssize_t
 
	$eui_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

2860 *
buf
)

2862  
	`•rötf
(
buf
, "%8ph\n", 
	`dev_to_ns_hód
(
dev
)->
ids
.
eui64
);

2863 
	}
}

2864 
DEVICE_ATTR_RO
(
eui
);

2866 
ssize_t
 
	$nsid_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

2867 *
buf
)

2869  
	`•rötf
(
buf
, "%d\n", 
	`dev_to_ns_hód
(
dev
)->
ns_id
);

2870 
	}
}

2871 
DEVICE_ATTR_RO
(
nsid
);

2873 
©åibuã
 *
	gnvme_ns_id_©ås
[] = {

2874 &
dev_©å_wwid
.
©å
,

2875 &
dev_©å_uuid
.
©å
,

2876 &
dev_©å_nguid
.
©å
,

2877 &
dev_©å_eui
.
©å
,

2878 &
dev_©å_nsid
.
©å
,

2879 #ifde‡
CONFIG_NVME_MULTIPATH


2880 &
dev_©å_™a_gΩid
.
©å
,

2881 &
dev_©å_™a_°©e
.
©å
,

2883 
NULL
,

2886 
umode_t
 
	$nvme_ns_id_©ås_¨e_visibÀ
(
kobje˘
 *
kobj
,

2887 
©åibuã
 *
a
, 
n
)

2889 
devi˚
 *
dev
 = 
	`c⁄èöî_of
(
kobj
, device, kobj);

2890 
nvme_ns_ids
 *
ids
 = &
	`dev_to_ns_hód
(
dev
)->ids;

2892 i‡(
a
 =&
dev_©å_uuid
.
©å
) {

2893 i‡(
	`uuid_is_nuŒ
(&
ids
->
uuid
) &&

2894 !
	`memchr_öv
(
ids
->
nguid
, 0, (ids->nguid)))

2897 i‡(
a
 =&
dev_©å_nguid
.
©å
) {

2898 i‡(!
	`memchr_öv
(
ids
->
nguid
, 0, (ids->nguid)))

2901 i‡(
a
 =&
dev_©å_eui
.
©å
) {

2902 i‡(!
	`memchr_öv
(
ids
->
eui64
, 0, (ids->eui64)))

2905 #ifde‡
CONFIG_NVME_MULTIPATH


2906 i‡(
a
 =&
dev_©å_™a_gΩid
.
©å
 ||á =&
dev_©å_™a_°©e
.attr) {

2907 i‡(
	`dev_to_disk
(
dev
)->
f›s
 !&
nvme_f›s
)

2909 i‡(!
	`nvme_˘æ_u£_™a
(
	`nvme_gë_ns_‰om_dev
(
dev
)->
˘æ
))

2913  
a
->
mode
;

2914 
	}
}

2916 c⁄° 
©åibuã_group
 
	gnvme_ns_id_©å_group
 = {

2917 .
©ås
 = 
nvme_ns_id_©ås
,

2918 .
	gis_visibÀ
 = 
nvme_ns_id_©ås_¨e_visibÀ
,

2921 c⁄° 
©åibuã_group
 *
	gnvme_ns_id_©å_groups
[] = {

2922 &
nvme_ns_id_©å_group
,

2923 #ifde‡
CONFIG_NVM


2924 &
nvme_nvm_©å_group
,

2926 
NULL
,

2929 
	#nvme_show_°r_fun˘i⁄
(
fõld
) \

2930 
ssize_t
 
fõld
##
	`_show
(
devi˚
 *
dev
, \

2931 
devi˚_©åibuã
 *
©å
, *
buf
) \

2933 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
); \

2934  
	`•rötf
(
buf
, "%.*s\n", \

2935 ()(
˘æ
->
subsys
->
fõld
), ctrl->subsys->field); \

2937 
	`DEVICE_ATTR
(
fõld
, 
S_IRUGO
, fõld##
_show
, 
NULL
);

	)

2939 
nvme_show_°r_fun˘i⁄
(
modñ
);

2940 
nvme_show_°r_fun˘i⁄
(
£rül
);

2941 
nvme_show_°r_fun˘i⁄
(
fúmw¨e_ªv
);

2943 
	#nvme_show_öt_fun˘i⁄
(
fõld
) \

2944 
ssize_t
 
fõld
##
	`_show
(
devi˚
 *
dev
, \

2945 
devi˚_©åibuã
 *
©å
, *
buf
) \

2947 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
); \

2948  
	`•rötf
(
buf
, "%d\n", 
˘æ
->
fõld
); \

2950 
	`DEVICE_ATTR
(
fõld
, 
S_IRUGO
, fõld##
_show
, 
NULL
);

	)

2952 
nvme_show_öt_fun˘i⁄
(
˙éid
);

2953 
nvme_show_öt_fun˘i⁄
(
numa_node
);

2955 
ssize_t
 
	$nvme_sysfs_dñëe
(
devi˚
 *
dev
,

2956 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
,

2957 
size_t
 
cou¡
)

2959 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

2961 i‡(
	`devi˚_ªmove_fûe_£lf
(
dev
, 
©å
))

2962 
	`nvme_dñëe_˘æ_sync
(
˘æ
);

2963  
cou¡
;

2964 
	}
}

2965 
DEVICE_ATTR
(
dñëe_c⁄åﬁÀr
, 
S_IWUSR
, 
NULL
, 
nvme_sysfs_dñëe
);

2967 
ssize_t
 
	$nvme_sysfs_show_å™•‹t
(
devi˚
 *
dev
,

2968 
devi˚_©åibuã
 *
©å
,

2969 *
buf
)

2971 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

2973  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%s\n", 
˘æ
->
›s
->
«me
);

2974 
	}
}

2975 
DEVICE_ATTR
(
å™•‹t
, 
S_IRUGO
, 
nvme_sysfs_show_å™•‹t
, 
NULL
);

2977 
ssize_t
 
	$nvme_sysfs_show_°©e
(
devi˚
 *
dev
,

2978 
devi˚_©åibuã
 *
©å
,

2979 *
buf
)

2981 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

2982 c⁄° *c⁄° 
°©e_«me
[] = {

2983 [
NVME_CTRL_NEW
] = "new",

2984 [
NVME_CTRL_LIVE
] = "live",

2985 [
NVME_CTRL_ADMIN_ONLY
] = "only-admin",

2986 [
NVME_CTRL_RESETTING
] = "resetting",

2987 [
NVME_CTRL_CONNECTING
] = "connecting",

2988 [
NVME_CTRL_DELETING
] = "deleting",

2989 [
NVME_CTRL_DEAD
] = "dead",

2992 i‡(()
˘æ
->
°©e
 < 
	`ARRAY_SIZE
(
°©e_«me
) &&

2993 
°©e_«me
[
˘æ
->
°©e
])

2994  
	`•rötf
(
buf
, "%s\n", 
°©e_«me
[
˘æ
->
°©e
]);

2996  
	`•rötf
(
buf
, "unknown state\n");

2997 
	}
}

2999 
DEVICE_ATTR
(
°©e
, 
S_IRUGO
, 
nvme_sysfs_show_°©e
, 
NULL
);

3001 
ssize_t
 
	$nvme_sysfs_show_subsy¢qn
(
devi˚
 *
dev
,

3002 
devi˚_©åibuã
 *
©å
,

3003 *
buf
)

3005 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

3007  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%s\n", 
˘æ
->
subsys
->
subnqn
);

3008 
	}
}

3009 
DEVICE_ATTR
(
subsy¢qn
, 
S_IRUGO
, 
nvme_sysfs_show_subsy¢qn
, 
NULL
);

3011 
ssize_t
 
	$nvme_sysfs_show_addªss
(
devi˚
 *
dev
,

3012 
devi˚_©åibuã
 *
©å
,

3013 *
buf
)

3015 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

3017  
˘æ
->
›s
->
	`gë_addªss
(˘æ, 
buf
, 
PAGE_SIZE
);

3018 
	}
}

3019 
DEVICE_ATTR
(
addªss
, 
S_IRUGO
, 
nvme_sysfs_show_addªss
, 
NULL
);

3021 
©åibuã
 *
	gnvme_dev_©ås
[] = {

3022 &
dev_©å_ª£t_c⁄åﬁÀr
.
©å
,

3023 &
dev_©å_ªsˇn_c⁄åﬁÀr
.
©å
,

3024 &
dev_©å_modñ
.
©å
,

3025 &
dev_©å_£rül
.
©å
,

3026 &
dev_©å_fúmw¨e_ªv
.
©å
,

3027 &
dev_©å_˙éid
.
©å
,

3028 &
dev_©å_dñëe_c⁄åﬁÀr
.
©å
,

3029 &
dev_©å_å™•‹t
.
©å
,

3030 &
dev_©å_subsy¢qn
.
©å
,

3031 &
dev_©å_addªss
.
©å
,

3032 &
dev_©å_°©e
.
©å
,

3033 &
dev_©å_numa_node
.
©å
,

3034 
NULL


3037 
umode_t
 
	$nvme_dev_©ås_¨e_visibÀ
(
kobje˘
 *
kobj
,

3038 
©åibuã
 *
a
, 
n
)

3040 
devi˚
 *
dev
 = 
	`c⁄èöî_of
(
kobj
, device, kobj);

3041 
nvme_˘æ
 *
˘æ
 = 
	`dev_gë_drvd©a
(
dev
);

3043 i‡(
a
 =&
dev_©å_dñëe_c⁄åﬁÀr
.
©å
 && !
˘æ
->
›s
->
dñëe_˘æ
)

3045 i‡(
a
 =&
dev_©å_addªss
.
©å
 && !
˘æ
->
›s
->
gë_addªss
)

3048  
a
->
mode
;

3049 
	}
}

3051 
©åibuã_group
 
	gnvme_dev_©ås_group
 = {

3052 .
©ås
 = 
nvme_dev_©ås
,

3053 .
	gis_visibÀ
 = 
nvme_dev_©ås_¨e_visibÀ
,

3056 c⁄° 
©åibuã_group
 *
	gnvme_dev_©å_groups
[] = {

3057 &
nvme_dev_©ås_group
,

3058 
NULL
,

3061 
nvme_ns_hód
 *
	$__nvme_föd_ns_hód
(
nvme_subsy°em
 *
subsys
,

3062 
nsid
)

3064 
nvme_ns_hód
 *
h
;

3066 
	`lockdï_as£π_hñd
(&
subsys
->
lock
);

3068 
	`li°_f‹_óch_íåy
(
h
, &
subsys
->
nshóds
, 
íåy
) {

3069 i‡(
h
->
ns_id
 =
nsid
 && 
	`kªf_gë_u∆ess_zîo
(&h->
ªf
))

3070  
h
;

3073  
NULL
;

3074 
	}
}

3076 
	$__nvme_check_ids
(
nvme_subsy°em
 *
subsys
,

3077 
nvme_ns_hód
 *
√w
)

3079 
nvme_ns_hód
 *
h
;

3081 
	`lockdï_as£π_hñd
(&
subsys
->
lock
);

3083 
	`li°_f‹_óch_íåy
(
h
, &
subsys
->
nshóds
, 
íåy
) {

3084 i‡(
	`nvme_ns_ids_vÆid
(&
√w
->
ids
) &&

3085 !
	`li°_em±y
(&
h
->
li°
) &&

3086 
	`nvme_ns_ids_equÆ
(&
√w
->
ids
, &
h
->ids))

3087  -
EINVAL
;

3091 
	}
}

3093 
nvme_ns_hód
 *
	$nvme_Æloc_ns_hód
(
nvme_˘æ
 *
˘æ
,

3094 
nsid
, 
nvme_id_ns
 *
id
)

3096 
nvme_ns_hód
 *
hód
;

3097 
size_t
 
size
 = (*
hód
);

3098 
ªt
 = -
ENOMEM
;

3100 #ifde‡
CONFIG_NVME_MULTIPATH


3101 
size
 +
	`num_possibÀ_nodes
(Ë* (
nvme_ns
 *);

3104 
hód
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

3105 i‡(!
hód
)

3106 
out
;

3107 
ªt
 = 
	`ida_sim∂e_gë
(&
˘æ
->
subsys
->
ns_ida
, 1, 0, 
GFP_KERNEL
);

3108 i‡(
ªt
 < 0)

3109 
out_‰ì_hód
;

3110 
hód
->
ö°™˚
 = 
ªt
;

3111 
	`INIT_LIST_HEAD
(&
hód
->
li°
);

3112 
ªt
 = 
	`öô_§cu_°ru˘
(&
hód
->
§cu
);

3113 i‡(
ªt
)

3114 
out_ida_ªmove
;

3115 
hód
->
subsys
 = 
˘æ
->subsys;

3116 
hód
->
ns_id
 = 
nsid
;

3117 
	`kªf_öô
(&
hód
->
ªf
);

3119 
	`nvme_ªp‹t_ns_ids
(
˘æ
, 
nsid
, 
id
, &
hód
->
ids
);

3121 
ªt
 = 
	`__nvme_check_ids
(
˘æ
->
subsys
, 
hód
);

3122 i‡(
ªt
) {

3123 
	`dev_îr
(
˘æ
->
devi˚
,

3124 "du∂iˇã ID†f‹Çsid %d\n", 
nsid
);

3125 
out_˛ónup_§cu
;

3128 
ªt
 = 
	`nvme_m∑th_Æloc_disk
(
˘æ
, 
hód
);

3129 i‡(
ªt
)

3130 
out_˛ónup_§cu
;

3132 
	`li°_add_èû
(&
hód
->
íåy
, &
˘æ
->
subsys
->
nshóds
);

3134 
	`kªf_gë
(&
˘æ
->
subsys
->
ªf
);

3136  
hód
;

3137 
out_˛ónup_§cu
:

3138 
	`˛ónup_§cu_°ru˘
(&
hód
->
§cu
);

3139 
out_ida_ªmove
:

3140 
	`ida_sim∂e_ªmove
(&
˘æ
->
subsys
->
ns_ida
, 
hód
->
ö°™˚
);

3141 
out_‰ì_hód
:

3142 
	`k‰ì
(
hód
);

3143 
out
:

3144  
	`ERR_PTR
(
ªt
);

3145 
	}
}

3147 
	$nvme_öô_ns_hód
(
nvme_ns
 *
ns
, 
nsid
,

3148 
nvme_id_ns
 *
id
)

3150 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

3151 
boﬁ
 
is_sh¨ed
 = 
id
->
nmic
 & (1 << 0);

3152 
nvme_ns_hód
 *
hód
 = 
NULL
;

3153 
ªt
 = 0;

3155 
	`muãx_lock
(&
˘æ
->
subsys
->
lock
);

3156 i‡(
is_sh¨ed
)

3157 
hód
 = 
	`__nvme_föd_ns_hód
(
˘æ
->
subsys
, 
nsid
);

3158 i‡(!
hód
) {

3159 
hód
 = 
	`nvme_Æloc_ns_hód
(
˘æ
, 
nsid
, 
id
);

3160 i‡(
	`IS_ERR
(
hód
)) {

3161 
ªt
 = 
	`PTR_ERR
(
hód
);

3162 
out_u∆ock
;

3165 
nvme_ns_ids
 
ids
;

3167 
	`nvme_ªp‹t_ns_ids
(
˘æ
, 
nsid
, 
id
, &
ids
);

3168 i‡(!
	`nvme_ns_ids_equÆ
(&
hód
->
ids
, &ids)) {

3169 
	`dev_îr
(
˘æ
->
devi˚
,

3171 
nsid
);

3172 
ªt
 = -
EINVAL
;

3173 
out_u∆ock
;

3177 
	`li°_add_èû
(&
ns
->
siblögs
, &
hód
->
li°
);

3178 
ns
->
hód
 = head;

3180 
out_u∆ock
:

3181 
	`muãx_u∆ock
(&
˘æ
->
subsys
->
lock
);

3182  
ªt
;

3183 
	}
}

3185 
	$ns_cmp
(*
¥iv
, 
li°_hód
 *
a
, li°_hód *
b
)

3187 
nvme_ns
 *
nß
 = 
	`c⁄èöî_of
(
a
, nvme_ns, 
li°
);

3188 
nvme_ns
 *
nsb
 = 
	`c⁄èöî_of
(
b
, nvme_ns, 
li°
);

3190  
nß
->
hód
->
ns_id
 - 
nsb
->head->ns_id;

3191 
	}
}

3193 
nvme_ns
 *
	$nvme_föd_gë_ns
(
nvme_˘æ
 *
˘æ
, 
nsid
)

3195 
nvme_ns
 *
ns
, *
ªt
 = 
NULL
;

3197 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3198 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
) {

3199 i‡(
ns
->
hód
->
ns_id
 =
nsid
) {

3200 i‡(!
	`kªf_gë_u∆ess_zîo
(&
ns
->
kªf
))

3202 
ªt
 = 
ns
;

3205 i‡(
ns
->
hód
->
ns_id
 > 
nsid
)

3208 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3209  
ªt
;

3210 
	}
}

3212 
	$nvme_£tup_°ªams_ns
(
nvme_˘æ
 *
˘æ
, 
nvme_ns
 *
ns
)

3214 
°ªams_dúe˘ive_∑øms
 
s
;

3215 
ªt
;

3217 i‡(!
˘æ
->
ƒ_°ªams
)

3220 
ªt
 = 
	`nvme_gë_°ªam_∑øms
(
˘æ
, &
s
, 
ns
->
hód
->
ns_id
);

3221 i‡(
ªt
)

3222  
ªt
;

3224 
ns
->
sws
 = 
	`À32_to_˝u
(
s
.sws);

3225 
ns
->
sgs
 = 
	`À16_to_˝u
(
s
.sgs);

3227 i‡(
ns
->
sws
) {

3228 
bs
 = 1 << 
ns
->
lba_shi·
;

3230 
	`blk_queue_io_mö
(
ns
->
queue
, 
bs
 *Çs->
sws
);

3231 i‡(
ns
->
sgs
)

3232 
	`blk_queue_io_›t
(
ns
->
queue
, 
bs
 *Çs->
sws
 *Çs->
sgs
);

3236 
	}
}

3238 
	$nvme_Æloc_ns
(
nvme_˘æ
 *
˘æ
, 
nsid
)

3240 
nvme_ns
 *
ns
;

3241 
gídisk
 *
disk
;

3242 
nvme_id_ns
 *
id
;

3243 
disk_«me
[
DISK_NAME_LEN
];

3244 
node
 = 
˘æ
->
numa_node
, 
Êags
 = 
GENHD_FL_EXT_DEVT
, 
ªt
;

3246 
ns
 = 
	`kzÆloc_node
((*ns), 
GFP_KERNEL
, 
node
);

3247 i‡(!
ns
)

3248  -
ENOMEM
;

3250 
ns
->
queue
 = 
	`blk_mq_öô_queue
(
˘æ
->
èg£t
);

3251 i‡(
	`IS_ERR
(
ns
->
queue
)) {

3252 
ªt
 = 
	`PTR_ERR
(
ns
->
queue
);

3253 
out_‰ì_ns
;

3256 
	`blk_queue_Êag_£t
(
QUEUE_FLAG_NONROT
, 
ns
->
queue
);

3257 i‡(
˘æ
->
›s
->
Êags
 & 
NVME_F_PCI_P2PDMA
)

3258 
	`blk_queue_Êag_£t
(
QUEUE_FLAG_PCI_P2PDMA
, 
ns
->
queue
);

3260 
ns
->
queue
->
queued©a
 =Çs;

3261 
ns
->
˘æ
 = ctrl;

3263 
	`kªf_öô
(&
ns
->
kªf
);

3264 
ns
->
lba_shi·
 = 9;

3266 
	`blk_queue_logiˇl_block_size
(
ns
->
queue
, 1 <<Çs->
lba_shi·
);

3267 
	`nvme_£t_queue_limôs
(
˘æ
, 
ns
->
queue
);

3269 
id
 = 
	`nvme_idítify_ns
(
˘æ
, 
nsid
);

3270 i‡(!
id
) {

3271 
ªt
 = -
EIO
;

3272 
out_‰ì_queue
;

3275 i‡(
id
->
nˇp
 == 0) {

3276 
ªt
 = -
EINVAL
;

3277 
out_‰ì_id
;

3280 
ªt
 = 
	`nvme_öô_ns_hód
(
ns
, 
nsid
, 
id
);

3281 i‡(
ªt
)

3282 
out_‰ì_id
;

3283 
	`nvme_£tup_°ªams_ns
(
˘æ
, 
ns
);

3284 
	`nvme_£t_disk_«me
(
disk_«me
, 
ns
, 
˘æ
, &
Êags
);

3286 
disk
 = 
	`Æloc_disk_node
(0, 
node
);

3287 i‡(!
disk
) {

3288 
ªt
 = -
ENOMEM
;

3289 
out_u∆ök_ns
;

3292 
disk
->
f›s
 = &
nvme_f›s
;

3293 
disk
->
¥iv©e_d©a
 = 
ns
;

3294 
disk
->
queue
 = 
ns
->queue;

3295 
disk
->
Êags
 = flags;

3296 
	`mem˝y
(
disk
->
disk_«me
, disk_«me, 
DISK_NAME_LEN
);

3297 
ns
->
disk
 = disk;

3299 
	`__nvme_ªvÆid©e_disk
(
disk
, 
id
);

3301 i‡((
˘æ
->
quúks
 & 
NVME_QUIRK_LIGHTNVM
Ë&& 
id
->
vs
[0] == 0x1) {

3302 
ªt
 = 
	`nvme_nvm_ªgi°î
(
ns
, 
disk_«me
, 
node
);

3303 i‡(
ªt
) {

3304 
	`dev_w¨n
(
˘æ
->
devi˚
, "LightNVM init failure\n");

3305 
out_put_disk
;

3309 
	`down_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3310 
	`li°_add_èû
(&
ns
->
li°
, &
˘æ
->
«me•a˚s
);

3311 
	`up_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3313 
	`nvme_gë_˘æ
(
˘æ
);

3315 
	`devi˚_add_disk
(
˘æ
->
devi˚
, 
ns
->
disk
, 
nvme_ns_id_©å_groups
);

3317 
	`nvme_m∑th_add_disk
(
ns
, 
id
);

3318 
	`nvme_Áu…_öje˘_öô
(
ns
);

3319 
	`k‰ì
(
id
);

3322 
out_put_disk
:

3323 
	`put_disk
(
ns
->
disk
);

3324 
out_u∆ök_ns
:

3325 
	`muãx_lock
(&
˘æ
->
subsys
->
lock
);

3326 
	`li°_dñ_rcu
(&
ns
->
siblögs
);

3327 
	`muãx_u∆ock
(&
˘æ
->
subsys
->
lock
);

3328 
	`nvme_put_ns_hód
(
ns
->
hód
);

3329 
out_‰ì_id
:

3330 
	`k‰ì
(
id
);

3331 
out_‰ì_queue
:

3332 
	`blk_˛ónup_queue
(
ns
->
queue
);

3333 
out_‰ì_ns
:

3334 
	`k‰ì
(
ns
);

3335  
ªt
;

3336 
	}
}

3338 
	$nvme_ns_ªmove
(
nvme_ns
 *
ns
)

3340 i‡(
	`ã°_™d_£t_bô
(
NVME_NS_REMOVING
, &
ns
->
Êags
))

3343 
	`nvme_Áu…_öje˘_föi
(
ns
);

3344 i‡(
ns
->
disk
 &&Çs->disk->
Êags
 & 
GENHD_FL_UP
) {

3345 
	`dñ_gídisk
(
ns
->
disk
);

3346 
	`blk_˛ónup_queue
(
ns
->
queue
);

3347 i‡(
	`blk_gë_öãgrôy
(
ns
->
disk
))

3348 
	`blk_öãgrôy_uƒegi°î
(
ns
->
disk
);

3351 
	`muãx_lock
(&
ns
->
˘æ
->
subsys
->
lock
);

3352 
	`li°_dñ_rcu
(&
ns
->
siblögs
);

3353 
	`nvme_m∑th_˛ór_cuºít_∑th
(
ns
);

3354 
	`muãx_u∆ock
(&
ns
->
˘æ
->
subsys
->
lock
);

3356 
	`down_wrôe
(&
ns
->
˘æ
->
«me•a˚s_rw£m
);

3357 
	`li°_dñ_öô
(&
ns
->
li°
);

3358 
	`up_wrôe
(&
ns
->
˘æ
->
«me•a˚s_rw£m
);

3360 
	`synchr⁄ize_§cu
(&
ns
->
hód
->
§cu
);

3361 
	`nvme_m∑th_check_œ°_∑th
(
ns
);

3362 
	`nvme_put_ns
(
ns
);

3363 
	}
}

3365 
	$nvme_vÆid©e_ns
(
nvme_˘æ
 *
˘æ
, 
nsid
)

3367 
nvme_ns
 *
ns
;

3369 
ns
 = 
	`nvme_föd_gë_ns
(
˘æ
, 
nsid
);

3370 i‡(
ns
) {

3371 i‡(
ns
->
disk
 && 
	`ªvÆid©e_disk
(ns->disk))

3372 
	`nvme_ns_ªmove
(
ns
);

3373 
	`nvme_put_ns
(
ns
);

3375 
	`nvme_Æloc_ns
(
˘æ
, 
nsid
);

3376 
	}
}

3378 
	$nvme_ªmove_övÆid_«me•a˚s
(
nvme_˘æ
 *
˘æ
,

3379 
nsid
)

3381 
nvme_ns
 *
ns
, *
√xt
;

3382 
	`LIST_HEAD
(
rm_li°
);

3384 
	`down_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3385 
	`li°_f‹_óch_íåy_ß„
(
ns
, 
√xt
, &
˘æ
->
«me•a˚s
, 
li°
) {

3386 i‡(
ns
->
hód
->
ns_id
 > 
nsid
 || 
	`ã°_bô
(
NVME_NS_DEAD
, &ns->
Êags
))

3387 
	`li°_move_èû
(&
ns
->
li°
, &
rm_li°
);

3389 
	`up_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3391 
	`li°_f‹_óch_íåy_ß„
(
ns
, 
√xt
, &
rm_li°
, 
li°
)

3392 
	`nvme_ns_ªmove
(
ns
);

3394 
	}
}

3396 
	$nvme_sˇn_ns_li°
(
nvme_˘æ
 *
˘æ
, 
¬
)

3398 
nvme_ns
 *
ns
;

3399 
__À32
 *
ns_li°
;

3400 
i
, 
j
, 
nsid
, 
¥ev
 = 0;

3401 
num_li°s
 = 
	`DIV_ROUND_UP_ULL
((
u64
)
¬
, 1024);

3402 
ªt
 = 0;

3404 
ns_li°
 = 
	`kzÆloc
(
NVME_IDENTIFY_DATA_SIZE
, 
GFP_KERNEL
);

3405 i‡(!
ns_li°
)

3406  -
ENOMEM
;

3408 
i
 = 0; i < 
num_li°s
; i++) {

3409 
ªt
 = 
	`nvme_idítify_ns_li°
(
˘æ
, 
¥ev
, 
ns_li°
);

3410 i‡(
ªt
)

3411 
‰ì
;

3413 
j
 = 0; j < 
	`mö
(
¬
, 1024U); j++) {

3414 
nsid
 = 
	`À32_to_˝u
(
ns_li°
[
j
]);

3415 i‡(!
nsid
)

3416 
out
;

3418 
	`nvme_vÆid©e_ns
(
˘æ
, 
nsid
);

3420 ++
¥ev
 < 
nsid
) {

3421 
ns
 = 
	`nvme_föd_gë_ns
(
˘æ
, 
¥ev
);

3422 i‡(
ns
) {

3423 
	`nvme_ns_ªmove
(
ns
);

3424 
	`nvme_put_ns
(
ns
);

3428 
¬
 -
j
;

3430 
out
:

3431 
	`nvme_ªmove_övÆid_«me•a˚s
(
˘æ
, 
¥ev
);

3432 
‰ì
:

3433 
	`k‰ì
(
ns_li°
);

3434  
ªt
;

3435 
	}
}

3437 
	$nvme_sˇn_ns_£quítül
(
nvme_˘æ
 *
˘æ
, 
¬
)

3439 
i
;

3441 
i
 = 1; i <
¬
; i++)

3442 
	`nvme_vÆid©e_ns
(
˘æ
, 
i
);

3444 
	`nvme_ªmove_övÆid_«me•a˚s
(
˘æ
, 
¬
);

3445 
	}
}

3447 
	$nvme_˛ór_ch™ged_ns_log
(
nvme_˘æ
 *
˘æ
)

3449 
size_t
 
log_size
 = 
NVME_MAX_CHANGED_NAMESPACES
 * (
__À32
);

3450 
__À32
 *
log
;

3451 
îr‹
;

3453 
log
 = 
	`kzÆloc
(
log_size
, 
GFP_KERNEL
);

3454 i‡(!
log
)

3463 
îr‹
 = 
	`nvme_gë_log
(
˘æ
, 
NVME_NSID_ALL
, 
NVME_LOG_CHANGED_NS
, 0, 
log
,

3464 
log_size
, 0);

3465 i‡(
îr‹
)

3466 
	`dev_w¨n
(
˘æ
->
devi˚
,

3467 "ªadög ch™gedÇ†log faûed: %d\n", 
îr‹
);

3469 
	`k‰ì
(
log
);

3470 
	}
}

3472 
	$nvme_sˇn_w‹k
(
w‹k_°ru˘
 *
w‹k
)

3474 
nvme_˘æ
 *
˘æ
 =

3475 
	`c⁄èöî_of
(
w‹k
, 
nvme_˘æ
, 
sˇn_w‹k
);

3476 
nvme_id_˘æ
 *
id
;

3477 
¬
;

3479 i‡(
˘æ
->
°©e
 !
NVME_CTRL_LIVE
)

3482 
	`WARN_ON_ONCE
(!
˘æ
->
èg£t
);

3484 i‡(
	`ã°_™d_˛ór_bô
(
NVME_AER_NOTICE_NS_CHANGED
, &
˘æ
->
evíts
)) {

3485 
	`dev_öfo
(
˘æ
->
devi˚
, "rescanningÇamespaces.\n");

3486 
	`nvme_˛ór_ch™ged_ns_log
(
˘æ
);

3489 i‡(
	`nvme_idítify_˘æ
(
˘æ
, &
id
))

3492 
	`muãx_lock
(&
˘æ
->
sˇn_lock
);

3493 
¬
 = 
	`À32_to_˝u
(
id
->nn);

3494 i‡(
˘æ
->
vs
 >
	`NVME_VS
(1, 1, 0) &&

3495 !(
˘æ
->
quúks
 & 
NVME_QUIRK_IDENTIFY_CNS
)) {

3496 i‡(!
	`nvme_sˇn_ns_li°
(
˘æ
, 
¬
))

3497 
out_‰ì_id
;

3499 
	`nvme_sˇn_ns_£quítül
(
˘æ
, 
¬
);

3500 
out_‰ì_id
:

3501 
	`muãx_u∆ock
(&
˘æ
->
sˇn_lock
);

3502 
	`k‰ì
(
id
);

3503 
	`down_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3504 
	`li°_s‹t
(
NULL
, &
˘æ
->
«me•a˚s
, 
ns_cmp
);

3505 
	`up_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3506 
	}
}

3513 
	$nvme_ªmove_«me•a˚s
(
nvme_˘æ
 *
˘æ
)

3515 
nvme_ns
 *
ns
, *
√xt
;

3516 
	`LIST_HEAD
(
ns_li°
);

3519 
	`Êush_w‹k
(&
˘æ
->
sˇn_w‹k
);

3527 i‡(
˘æ
->
°©e
 =
NVME_CTRL_DEAD
)

3528 
	`nvme_kûl_queues
(
˘æ
);

3530 
	`down_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3531 
	`li°_•li˚_öô
(&
˘æ
->
«me•a˚s
, &
ns_li°
);

3532 
	`up_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

3534 
	`li°_f‹_óch_íåy_ß„
(
ns
, 
√xt
, &
ns_li°
, 
li°
)

3535 
	`nvme_ns_ªmove
(
ns
);

3536 
	}
}

3537 
EXPORT_SYMBOL_GPL
(
nvme_ªmove_«me•a˚s
);

3539 
	$nvme_´n_uevít
(
nvme_˘æ
 *
˘æ
)

3541 *
ívp
[2] = { 
NULL
, NULL };

3542 
u32
 
´n_ªsu…
 = 
˘æ
->aen_result;

3544 
˘æ
->
´n_ªsu…
 = 0;

3545 i‡(!
´n_ªsu…
)

3548 
ívp
[0] = 
	`ka•rötf
(
GFP_KERNEL
, "NVME_AEN=%#08x", 
´n_ªsu…
);

3549 i‡(!
ívp
[0])

3551 
	`kobje˘_uevít_ív
(&
˘æ
->
devi˚
->
kobj
, 
KOBJ_CHANGE
, 
ívp
);

3552 
	`k‰ì
(
ívp
[0]);

3553 
	}
}

3555 
	$nvme_async_evít_w‹k
(
w‹k_°ru˘
 *
w‹k
)

3557 
nvme_˘æ
 *
˘æ
 =

3558 
	`c⁄èöî_of
(
w‹k
, 
nvme_˘æ
, 
async_evít_w‹k
);

3560 
	`nvme_´n_uevít
(
˘æ
);

3561 
˘æ
->
›s
->
	`submô_async_evít
(ctrl);

3562 
	}
}

3564 
boﬁ
 
	$nvme_˘æ_µ_°©us
(
nvme_˘æ
 *
˘æ
)

3567 
u32
 
c°s
;

3569 i‡(
˘æ
->
›s
->
	`ªg_ªad32
(˘æ, 
NVME_REG_CSTS
, &
c°s
))

3570  
Ál£
;

3572 i‡(
c°s
 == ~0)

3573  
Ál£
;

3575  ((
˘æ
->
˘æ_c⁄fig
 & 
NVME_CC_ENABLE
Ë&& (
c°s
 & 
NVME_CSTS_PP
));

3576 
	}
}

3578 
	$nvme_gë_fw_¶Ÿ_öfo
(
nvme_˘æ
 *
˘æ
)

3580 
nvme_fw_¶Ÿ_öfo_log
 *
log
;

3582 
log
 = 
	`kmÆloc
((*log), 
GFP_KERNEL
);

3583 i‡(!
log
)

3586 i‡(
	`nvme_gë_log
(
˘æ
, 
NVME_NSID_ALL
, 0, 
NVME_LOG_FW_SLOT
, 
log
,

3587 (*
log
), 0))

3588 
	`dev_w¨n
(
˘æ
->
devi˚
, "Get FW SLOT INFOÜogÉrror\n");

3589 
	`k‰ì
(
log
);

3590 
	}
}

3592 
	$nvme_fw_a˘_w‹k
(
w‹k_°ru˘
 *
w‹k
)

3594 
nvme_˘æ
 *
˘æ
 = 
	`c⁄èöî_of
(
w‹k
,

3595 
nvme_˘æ
, 
fw_a˘_w‹k
);

3596 
fw_a˘_timeout
;

3598 i‡(
˘æ
->
mtÁ
)

3599 
fw_a˘_timeout
 = 
jiffõs
 +

3600 
	`m£cs_to_jiffõs
(
˘æ
->
mtÁ
 * 100);

3602 
fw_a˘_timeout
 = 
jiffõs
 +

3603 
	`m£cs_to_jiffõs
(
admö_timeout
 * 1000);

3605 
	`nvme_°›_queues
(
˘æ
);

3606 
	`nvme_˘æ_µ_°©us
(
˘æ
)) {

3607 i‡(
	`time_a·î
(
jiffõs
, 
fw_a˘_timeout
)) {

3608 
	`dev_w¨n
(
˘æ
->
devi˚
,

3610 
	`nvme_ª£t_˘æ
(
˘æ
);

3613 
	`m¶ìp
(100);

3616 i‡(
˘æ
->
°©e
 !
NVME_CTRL_LIVE
)

3619 
	`nvme_°¨t_queues
(
˘æ
);

3621 
	`nvme_gë_fw_¶Ÿ_öfo
(
˘æ
);

3622 
	}
}

3624 
	$nvme_h™dÀ_´n_nŸi˚
(
nvme_˘æ
 *
˘æ
, 
u32
 
ªsu…
)

3626 
u32
 
´r_nŸi˚_ty≥
 = (
ªsu…
 & 0xff00) >> 8;

3628 
´r_nŸi˚_ty≥
) {

3629 
NVME_AER_NOTICE_NS_CHANGED
:

3630 
	`åa˚_nvme_async_evít
(
˘æ
, 
´r_nŸi˚_ty≥
);

3631 
	`£t_bô
(
NVME_AER_NOTICE_NS_CHANGED
, &
˘æ
->
evíts
);

3632 
	`nvme_queue_sˇn
(
˘æ
);

3634 
NVME_AER_NOTICE_FW_ACT_STARTING
:

3635 
	`åa˚_nvme_async_evít
(
˘æ
, 
´r_nŸi˚_ty≥
);

3636 
	`queue_w‹k
(
nvme_wq
, &
˘æ
->
fw_a˘_w‹k
);

3638 #ifde‡
CONFIG_NVME_MULTIPATH


3639 
NVME_AER_NOTICE_ANA
:

3640 
	`åa˚_nvme_async_evít
(
˘æ
, 
´r_nŸi˚_ty≥
);

3641 i‡(!
˘æ
->
™a_log_buf
)

3643 
	`queue_w‹k
(
nvme_wq
, &
˘æ
->
™a_w‹k
);

3647 
	`dev_w¨n
(
˘æ
->
devi˚
, "asyn¯evíàªsu… %08x\n", 
ªsu…
);

3649 
	}
}

3651 
	$nvme_com∂ëe_async_evít
(
nvme_˘æ
 *
˘æ
, 
__À16
 
°©us
,

3652 vﬁ©ûê
nvme_ªsu…
 *
ªs
)

3654 
u32
 
ªsu…
 = 
	`À32_to_˝u
(
ªs
->u32);

3655 
u32
 
´r_ty≥
 = 
ªsu…
 & 0x07;

3657 i‡(
	`À16_to_˝u
(
°©us
Ë>> 1 !
NVME_SC_SUCCESS
)

3660 
´r_ty≥
) {

3661 
NVME_AER_NOTICE
:

3662 
	`nvme_h™dÀ_´n_nŸi˚
(
˘æ
, 
ªsu…
);

3664 
NVME_AER_ERROR
:

3665 
NVME_AER_SMART
:

3666 
NVME_AER_CSS
:

3667 
NVME_AER_VS
:

3668 
	`åa˚_nvme_async_evít
(
˘æ
, 
´r_ty≥
);

3669 
˘æ
->
´n_ªsu…
 = 
ªsu…
;

3674 
	`queue_w‹k
(
nvme_wq
, &
˘æ
->
async_evít_w‹k
);

3675 
	}
}

3676 
EXPORT_SYMBOL_GPL
(
nvme_com∂ëe_async_evít
);

3678 
	$nvme_°›_˘æ
(
nvme_˘æ
 *
˘æ
)

3680 
	`nvme_m∑th_°›
(
˘æ
);

3681 
	`nvme_°›_kìp_Æive
(
˘æ
);

3682 
	`Êush_w‹k
(&
˘æ
->
async_evít_w‹k
);

3683 
	`ˇn˚l_w‹k_sync
(&
˘æ
->
fw_a˘_w‹k
);

3684 
	}
}

3685 
EXPORT_SYMBOL_GPL
(
nvme_°›_˘æ
);

3687 
	$nvme_°¨t_˘æ
(
nvme_˘æ
 *
˘æ
)

3689 i‡(
˘æ
->
k©o
)

3690 
	`nvme_°¨t_kìp_Æive
(
˘æ
);

3692 i‡(
˘æ
->
queue_cou¡
 > 1) {

3693 
	`nvme_queue_sˇn
(
˘æ
);

3694 
	`nvme_íabÀ_´n
(
˘æ
);

3695 
	`queue_w‹k
(
nvme_wq
, &
˘æ
->
async_evít_w‹k
);

3696 
	`nvme_°¨t_queues
(
˘æ
);

3698 
	}
}

3699 
EXPORT_SYMBOL_GPL
(
nvme_°¨t_˘æ
);

3701 
	$nvme_unöô_˘æ
(
nvme_˘æ
 *
˘æ
)

3703 
	`dev_pm_qos_hide_œãncy_tﬁî™˚
(
˘æ
->
devi˚
);

3704 
	`cdev_devi˚_dñ
(&
˘æ
->
cdev
, cål->
devi˚
);

3705 
	}
}

3706 
EXPORT_SYMBOL_GPL
(
nvme_unöô_˘æ
);

3708 
	$nvme_‰ì_˘æ
(
devi˚
 *
dev
)

3710 
nvme_˘æ
 *
˘æ
 =

3711 
	`c⁄èöî_of
(
dev
, 
nvme_˘æ
, 
˘æ_devi˚
);

3712 
nvme_subsy°em
 *
subsys
 = 
˘æ
->subsys;

3714 
	`ida_sim∂e_ªmove
(&
nvme_ö°™˚_ida
, 
˘æ
->
ö°™˚
);

3715 
	`k‰ì
(
˘æ
->
ef„˘s
);

3716 
	`nvme_m∑th_unöô
(
˘æ
);

3717 
	`__‰ì_∑ge
(
˘æ
->
disˇrd_∑ge
);

3719 i‡(
subsys
) {

3720 
	`muãx_lock
(&
subsys
->
lock
);

3721 
	`li°_dñ
(&
˘æ
->
subsys_íåy
);

3722 
	`muãx_u∆ock
(&
subsys
->
lock
);

3723 
	`sysfs_ªmove_lök
(&
subsys
->
dev
.
kobj
, 
	`dev_«me
(
˘æ
->
devi˚
));

3726 
˘æ
->
›s
->
	`‰ì_˘æ
(ctrl);

3728 i‡(
subsys
)

3729 
	`nvme_put_subsy°em
(
subsys
);

3730 
	}
}

3737 
	$nvme_öô_˘æ
(
nvme_˘æ
 *
˘æ
, 
devi˚
 *
dev
,

3738 c⁄° 
nvme_˘æ_›s
 *
›s
, 
quúks
)

3740 
ªt
;

3742 
˘æ
->
°©e
 = 
NVME_CTRL_NEW
;

3743 
	`•ö_lock_öô
(&
˘æ
->
lock
);

3744 
	`muãx_öô
(&
˘æ
->
sˇn_lock
);

3745 
	`INIT_LIST_HEAD
(&
˘æ
->
«me•a˚s
);

3746 
	`öô_rw£m
(&
˘æ
->
«me•a˚s_rw£m
);

3747 
˘æ
->
dev
 = dev;

3748 
˘æ
->
›s
 = ops;

3749 
˘æ
->
quúks
 = quirks;

3750 
	`INIT_WORK
(&
˘æ
->
sˇn_w‹k
, 
nvme_sˇn_w‹k
);

3751 
	`INIT_WORK
(&
˘æ
->
async_evít_w‹k
, 
nvme_async_evít_w‹k
);

3752 
	`INIT_WORK
(&
˘æ
->
fw_a˘_w‹k
, 
nvme_fw_a˘_w‹k
);

3753 
	`INIT_WORK
(&
˘æ
->
dñëe_w‹k
, 
nvme_dñëe_˘æ_w‹k
);

3755 
	`INIT_DELAYED_WORK
(&
˘æ
->
ka_w‹k
, 
nvme_kìp_Æive_w‹k
);

3756 
	`mem£t
(&
˘æ
->
ka_cmd
, 0, (ctrl->ka_cmd));

3757 
˘æ
->
ka_cmd
.
comm⁄
.
›code
 = 
nvme_admö_kìp_Æive
;

3759 
	`BUILD_BUG_ON
(
NVME_DSM_MAX_RANGES
 * (
nvme_dsm_ønge
) >

3760 
PAGE_SIZE
);

3761 
˘æ
->
disˇrd_∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

3762 i‡(!
˘æ
->
disˇrd_∑ge
) {

3763 
ªt
 = -
ENOMEM
;

3764 
out
;

3767 
ªt
 = 
	`ida_sim∂e_gë
(&
nvme_ö°™˚_ida
, 0, 0, 
GFP_KERNEL
);

3768 i‡(
ªt
 < 0)

3769 
out
;

3770 
˘æ
->
ö°™˚
 = 
ªt
;

3772 
	`devi˚_öôülize
(&
˘æ
->
˘æ_devi˚
);

3773 
˘æ
->
devi˚
 = &˘æ->
˘æ_devi˚
;

3774 
˘æ
->
devi˚
->
devt
 = 
	`MKDEV
(
	`MAJOR
(
nvme_chr_devt
), cål->
ö°™˚
);

3775 
˘æ
->
devi˚
->
˛ass
 = 
nvme_˛ass
;

3776 
˘æ
->
devi˚
->
∑ª¡
 = cål->
dev
;

3777 
˘æ
->
devi˚
->
groups
 = 
nvme_dev_©å_groups
;

3778 
˘æ
->
devi˚
->
ªÀa£
 = 
nvme_‰ì_˘æ
;

3779 
	`dev_£t_drvd©a
(
˘æ
->
devi˚
, ctrl);

3780 
ªt
 = 
	`dev_£t_«me
(
˘æ
->
devi˚
, "nvme%d", cål->
ö°™˚
);

3781 i‡(
ªt
)

3782 
out_ªÀa£_ö°™˚
;

3784 
	`cdev_öô
(&
˘æ
->
cdev
, &
nvme_dev_f›s
);

3785 
˘æ
->
cdev
.
ow√r
 = 
›s
->
moduÀ
;

3786 
ªt
 = 
	`cdev_devi˚_add
(&
˘æ
->
cdev
, cål->
devi˚
);

3787 i‡(
ªt
)

3788 
out_‰ì_«me
;

3794 
˘æ
->
devi˚
->
powî
.
£t_œãncy_tﬁî™˚
 = 
nvme_£t_œãncy_tﬁî™˚
;

3795 
	`dev_pm_qos_upd©e_u£r_œãncy_tﬁî™˚
(
˘æ
->
devi˚
,

3796 
	`mö
(
deÁu…_ps_max_œãncy_us
, ()
S32_MAX
));

3799 
out_‰ì_«me
:

3800 
	`k‰ì_c⁄°
(
˘æ
->
devi˚
->
kobj
.
«me
);

3801 
out_ªÀa£_ö°™˚
:

3802 
	`ida_sim∂e_ªmove
(&
nvme_ö°™˚_ida
, 
˘æ
->
ö°™˚
);

3803 
out
:

3804 i‡(
˘æ
->
disˇrd_∑ge
)

3805 
	`__‰ì_∑ge
(
˘æ
->
disˇrd_∑ge
);

3806  
ªt
;

3807 
	}
}

3808 
EXPORT_SYMBOL_GPL
(
nvme_öô_˘æ
);

3817 
	$nvme_kûl_queues
(
nvme_˘æ
 *
˘æ
)

3819 
nvme_ns
 *
ns
;

3821 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3824 i‡(
˘æ
->
admö_q
 && !
	`blk_queue_dyög
(ctrl->admin_q))

3825 
	`blk_mq_unquõs˚_queue
(
˘æ
->
admö_q
);

3827 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

3828 
	`nvme_£t_queue_dyög
(
ns
);

3830 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3831 
	}
}

3832 
EXPORT_SYMBOL_GPL
(
nvme_kûl_queues
);

3834 
	$nvme_un‰ìze
(
nvme_˘æ
 *
˘æ
)

3836 
nvme_ns
 *
ns
;

3838 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3839 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

3840 
	`blk_mq_un‰ìze_queue
(
ns
->
queue
);

3841 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3842 
	}
}

3843 
EXPORT_SYMBOL_GPL
(
nvme_un‰ìze
);

3845 
	$nvme_waô_‰ìze_timeout
(
nvme_˘æ
 *
˘æ
, 
timeout
)

3847 
nvme_ns
 *
ns
;

3849 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3850 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
) {

3851 
timeout
 = 
	`blk_mq_‰ìze_queue_waô_timeout
(
ns
->
queue
,Åimeout);

3852 i‡(
timeout
 <= 0)

3855 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3856 
	}
}

3857 
EXPORT_SYMBOL_GPL
(
nvme_waô_‰ìze_timeout
);

3859 
	$nvme_waô_‰ìze
(
nvme_˘æ
 *
˘æ
)

3861 
nvme_ns
 *
ns
;

3863 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3864 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

3865 
	`blk_mq_‰ìze_queue_waô
(
ns
->
queue
);

3866 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3867 
	}
}

3868 
EXPORT_SYMBOL_GPL
(
nvme_waô_‰ìze
);

3870 
	$nvme_°¨t_‰ìze
(
nvme_˘æ
 *
˘æ
)

3872 
nvme_ns
 *
ns
;

3874 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3875 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

3876 
	`blk_‰ìze_queue_°¨t
(
ns
->
queue
);

3877 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3878 
	}
}

3879 
EXPORT_SYMBOL_GPL
(
nvme_°¨t_‰ìze
);

3881 
	$nvme_°›_queues
(
nvme_˘æ
 *
˘æ
)

3883 
nvme_ns
 *
ns
;

3885 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3886 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

3887 
	`blk_mq_quõs˚_queue
(
ns
->
queue
);

3888 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3889 
	}
}

3890 
EXPORT_SYMBOL_GPL
(
nvme_°›_queues
);

3892 
	$nvme_°¨t_queues
(
nvme_˘æ
 *
˘æ
)

3894 
nvme_ns
 *
ns
;

3896 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3897 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
)

3898 
	`blk_mq_unquõs˚_queue
(
ns
->
queue
);

3899 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

3900 
	}
}

3901 
EXPORT_SYMBOL_GPL
(
nvme_°¨t_queues
);

3903 
__öô
 
	$nvme_c‹e_öô
()

3905 
ªsu…
 = -
ENOMEM
;

3907 
nvme_wq
 = 
	`Æloc_w‹kqueue
("nvme-wq",

3908 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

3909 i‡(!
nvme_wq
)

3910 
out
;

3912 
nvme_ª£t_wq
 = 
	`Æloc_w‹kqueue
("nvme-reset-wq",

3913 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

3914 i‡(!
nvme_ª£t_wq
)

3915 
de°roy_wq
;

3917 
nvme_dñëe_wq
 = 
	`Æloc_w‹kqueue
("nvme-delete-wq",

3918 
WQ_UNBOUND
 | 
WQ_MEM_RECLAIM
 | 
WQ_SYSFS
, 0);

3919 i‡(!
nvme_dñëe_wq
)

3920 
de°roy_ª£t_wq
;

3922 
ªsu…
 = 
	`Æloc_chrdev_ªgi⁄
(&
nvme_chr_devt
, 0, 
NVME_MINORS
, "nvme");

3923 i‡(
ªsu…
 < 0)

3924 
de°roy_dñëe_wq
;

3926 
nvme_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "nvme");

3927 i‡(
	`IS_ERR
(
nvme_˛ass
)) {

3928 
ªsu…
 = 
	`PTR_ERR
(
nvme_˛ass
);

3929 
uƒegi°î_chrdev
;

3932 
nvme_subsys_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "nvme-subsystem");

3933 i‡(
	`IS_ERR
(
nvme_subsys_˛ass
)) {

3934 
ªsu…
 = 
	`PTR_ERR
(
nvme_subsys_˛ass
);

3935 
de°roy_˛ass
;

3939 
de°roy_˛ass
:

3940 
	`˛ass_de°roy
(
nvme_˛ass
);

3941 
uƒegi°î_chrdev
:

3942 
	`uƒegi°î_chrdev_ªgi⁄
(
nvme_chr_devt
, 
NVME_MINORS
);

3943 
de°roy_dñëe_wq
:

3944 
	`de°roy_w‹kqueue
(
nvme_dñëe_wq
);

3945 
de°roy_ª£t_wq
:

3946 
	`de°roy_w‹kqueue
(
nvme_ª£t_wq
);

3947 
de°roy_wq
:

3948 
	`de°roy_w‹kqueue
(
nvme_wq
);

3949 
out
:

3950  
ªsu…
;

3951 
	}
}

3953 
__exô
 
	$nvme_c‹e_exô
()

3955 
	`ida_de°roy
(&
nvme_subsy°ems_ida
);

3956 
	`˛ass_de°roy
(
nvme_subsys_˛ass
);

3957 
	`˛ass_de°roy
(
nvme_˛ass
);

3958 
	`uƒegi°î_chrdev_ªgi⁄
(
nvme_chr_devt
, 
NVME_MINORS
);

3959 
	`de°roy_w‹kqueue
(
nvme_dñëe_wq
);

3960 
	`de°roy_w‹kqueue
(
nvme_ª£t_wq
);

3961 
	`de°roy_w‹kqueue
(
nvme_wq
);

3962 
	}
}

3964 
MODULE_LICENSE
("GPL");

3965 
MODULE_VERSION
("1.0");

3966 
moduÀ_öô
(
nvme_c‹e_öô
);

3967 
moduÀ_exô
(
nvme_c‹e_exô
);

	@fabrics.c

6 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

7 
	~<löux/öô.h
>

8 
	~<löux/miscdevi˚.h
>

9 
	~<löux/moduÀ.h
>

10 
	~<löux/muãx.h
>

11 
	~<löux/∑r£r.h
>

12 
	~<löux/£q_fûe.h
>

13 
	~"nvme.h
"

14 
	~"Ábrics.h
"

16 
LIST_HEAD
(
nvmf_å™•‹ts
);

17 
DECLARE_RWSEM
(
nvmf_å™•‹ts_rw£m
);

19 
LIST_HEAD
(
nvmf_ho°s
);

20 
DEFINE_MUTEX
(
nvmf_ho°s_muãx
);

22 
nvmf_ho°
 *
	gnvmf_deÁu…_ho°
;

24 
nvmf_ho°
 *
	$__nvmf_ho°_föd
(c⁄° *
ho°nqn
)

26 
nvmf_ho°
 *
ho°
;

28 
	`li°_f‹_óch_íåy
(
ho°
, &
nvmf_ho°s
, 
li°
) {

29 i‡(!
	`°rcmp
(
ho°
->
nqn
, 
ho°nqn
))

30  
ho°
;

33  
NULL
;

34 
	}
}

36 
nvmf_ho°
 *
	$nvmf_ho°_add
(c⁄° *
ho°nqn
)

38 
nvmf_ho°
 *
ho°
;

40 
	`muãx_lock
(&
nvmf_ho°s_muãx
);

41 
ho°
 = 
	`__nvmf_ho°_föd
(
ho°nqn
);

42 i‡(
ho°
) {

43 
	`kªf_gë
(&
ho°
->
ªf
);

44 
out_u∆ock
;

47 
ho°
 = 
	`kmÆloc
((*ho°), 
GFP_KERNEL
);

48 i‡(!
ho°
)

49 
out_u∆ock
;

51 
	`kªf_öô
(&
ho°
->
ªf
);

52 
	`°æ˝y
(
ho°
->
nqn
, 
ho°nqn
, 
NVMF_NQN_SIZE
);

54 
	`li°_add_èû
(&
ho°
->
li°
, &
nvmf_ho°s
);

55 
out_u∆ock
:

56 
	`muãx_u∆ock
(&
nvmf_ho°s_muãx
);

57  
ho°
;

58 
	}
}

60 
nvmf_ho°
 *
	$nvmf_ho°_deÁu…
()

62 
nvmf_ho°
 *
ho°
;

64 
ho°
 = 
	`kmÆloc
((*ho°), 
GFP_KERNEL
);

65 i‡(!
ho°
)

66  
NULL
;

68 
	`kªf_öô
(&
ho°
->
ªf
);

69 
	`uuid_gí
(&
ho°
->
id
);

70 
	`¢¥ötf
(
ho°
->
nqn
, 
NVMF_NQN_SIZE
,

71 "nqn.2014-08.‹g.nvmex¥ess:uuid:%pUb", &
ho°
->
id
);

73 
	`muãx_lock
(&
nvmf_ho°s_muãx
);

74 
	`li°_add_èû
(&
ho°
->
li°
, &
nvmf_ho°s
);

75 
	`muãx_u∆ock
(&
nvmf_ho°s_muãx
);

77  
ho°
;

78 
	}
}

80 
	$nvmf_ho°_de°roy
(
kªf
 *
ªf
)

82 
nvmf_ho°
 *
ho°
 = 
	`c⁄èöî_of
(
ªf
, nvmf_host,Ñef);

84 
	`muãx_lock
(&
nvmf_ho°s_muãx
);

85 
	`li°_dñ
(&
ho°
->
li°
);

86 
	`muãx_u∆ock
(&
nvmf_ho°s_muãx
);

88 
	`k‰ì
(
ho°
);

89 
	}
}

91 
	$nvmf_ho°_put
(
nvmf_ho°
 *
ho°
)

93 i‡(
ho°
)

94 
	`kªf_put
(&
ho°
->
ªf
, 
nvmf_ho°_de°roy
);

95 
	}
}

103 
	$nvmf_gë_addªss
(
nvme_˘æ
 *
˘æ
, *
buf
, 
size
)

105 
Àn
 = 0;

107 i‡(
˘æ
->
›ts
->
mask
 & 
NVMF_OPT_TRADDR
)

108 
Àn
 +
	`¢¥ötf
(
buf
, 
size
, "åaddr=%s", 
˘æ
->
›ts
->
åaddr
);

109 i‡(
˘æ
->
›ts
->
mask
 & 
NVMF_OPT_TRSVCID
)

110 
Àn
 +
	`¢¥ötf
(
buf
 +Üí, 
size
 -Üen, "%strsvcid=%s",

111 (
Àn
Ë? "," : "", 
˘æ
->
›ts
->
åsvcid
);

112 i‡(
˘æ
->
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

113 
Àn
 +
	`¢¥ötf
(
buf
 +Üí, 
size
 -Üen, "%shost_traddr=%s",

114 (
Àn
Ë? "," : "", 
˘æ
->
›ts
->
ho°_åaddr
);

115 
Àn
 +
	`¢¥ötf
(
buf
 +Üí, 
size
 -Üen, "\n");

117  
Àn
;

118 
	}
}

119 
EXPORT_SYMBOL_GPL
(
nvmf_gë_addªss
);

142 
	$nvmf_ªg_ªad32
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, u32 *
vÆ
)

144 
nvme_comm™d
 
cmd
;

145 
nvme_ªsu…
 
ªs
;

146 
ªt
;

148 
	`mem£t
(&
cmd
, 0, (cmd));

149 
cmd
.
¥›_gë
.
›code
 = 
nvme_Ábrics_comm™d
;

150 
cmd
.
¥›_gë
.
f˘y≥
 = 
nvme_Ábrics_ty≥_¥›îty_gë
;

151 
cmd
.
¥›_gë
.
off£t
 = 
	`˝u_to_À32
(
off
);

153 
ªt
 = 
	`__nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
cmd
, &
ªs
, 
NULL
, 0, 0,

154 
NVME_QID_ANY
, 0, 0, 
Ál£
);

156 i‡(
ªt
 >= 0)

157 *
vÆ
 = 
	`À64_to_˝u
(
ªs
.
u64
);

158 i‡(
	`u∆ikñy
(
ªt
 != 0))

159 
	`dev_îr
(
˘æ
->
devi˚
,

161 
ªt
 > 0 ?Ñë & ~
NVME_SC_DNR
 :Ñë, 
off
);

163  
ªt
;

164 
	}
}

165 
EXPORT_SYMBOL_GPL
(
nvmf_ªg_ªad32
);

188 
	$nvmf_ªg_ªad64
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, 
u64
 *
vÆ
)

190 
nvme_comm™d
 
cmd
;

191 
nvme_ªsu…
 
ªs
;

192 
ªt
;

194 
	`mem£t
(&
cmd
, 0, (cmd));

195 
cmd
.
¥›_gë
.
›code
 = 
nvme_Ábrics_comm™d
;

196 
cmd
.
¥›_gë
.
f˘y≥
 = 
nvme_Ábrics_ty≥_¥›îty_gë
;

197 
cmd
.
¥›_gë
.
©åib
 = 1;

198 
cmd
.
¥›_gë
.
off£t
 = 
	`˝u_to_À32
(
off
);

200 
ªt
 = 
	`__nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
cmd
, &
ªs
, 
NULL
, 0, 0,

201 
NVME_QID_ANY
, 0, 0, 
Ál£
);

203 i‡(
ªt
 >= 0)

204 *
vÆ
 = 
	`À64_to_˝u
(
ªs
.
u64
);

205 i‡(
	`u∆ikñy
(
ªt
 != 0))

206 
	`dev_îr
(
˘æ
->
devi˚
,

208 
ªt
 > 0 ?Ñë & ~
NVME_SC_DNR
 :Ñë, 
off
);

209  
ªt
;

210 
	}
}

211 
EXPORT_SYMBOL_GPL
(
nvmf_ªg_ªad64
);

234 
	$nvmf_ªg_wrôe32
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, u32 
vÆ
)

236 
nvme_comm™d
 
cmd
;

237 
ªt
;

239 
	`mem£t
(&
cmd
, 0, (cmd));

240 
cmd
.
¥›_£t
.
›code
 = 
nvme_Ábrics_comm™d
;

241 
cmd
.
¥›_£t
.
f˘y≥
 = 
nvme_Ábrics_ty≥_¥›îty_£t
;

242 
cmd
.
¥›_£t
.
©åib
 = 0;

243 
cmd
.
¥›_£t
.
off£t
 = 
	`˝u_to_À32
(
off
);

244 
cmd
.
¥›_£t
.
vÆue
 = 
	`˝u_to_À64
(
vÆ
);

246 
ªt
 = 
	`__nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
cmd
, 
NULL
, NULL, 0, 0,

247 
NVME_QID_ANY
, 0, 0, 
Ál£
);

248 i‡(
	`u∆ikñy
(
ªt
))

249 
	`dev_îr
(
˘æ
->
devi˚
,

251 
ªt
 > 0 ?Ñë & ~
NVME_SC_DNR
 :Ñë, 
off
);

252  
ªt
;

253 
	}
}

254 
EXPORT_SYMBOL_GPL
(
nvmf_ªg_wrôe32
);

271 
	$nvmf_log_c⁄√˘_îr‹
(
nvme_˘æ
 *
˘æ
,

272 
îrvÆ
, 
off£t
, 
nvme_comm™d
 *
cmd
,

273 
nvmf_c⁄√˘_d©a
 *
d©a
)

275 
îr_s˘y≥
 = 
îrvÆ
 & (~
NVME_SC_DNR
);

277 
îr_s˘y≥
) {

279 (
NVME_SC_CONNECT_INVALID_PARAM
):

280 i‡(
off£t
 >> 16) {

281 *
öv_d©a
 = "Connect Invalid Data Parameter";

283 
off£t
 & 0xffff) {

284 (
	`off£tof
(
nvmf_c⁄√˘_d©a
, 
˙éid
)):

285 
	`dev_îr
(
˘æ
->
devi˚
,

287 
öv_d©a
, 
d©a
->
˙éid
);

289 (
	`off£tof
(
nvmf_c⁄√˘_d©a
, 
ho°nqn
)):

290 
	`dev_îr
(
˘æ
->
devi˚
,

292 
öv_d©a
, 
d©a
->
ho°nqn
);

294 (
	`off£tof
(
nvmf_c⁄√˘_d©a
, 
subsy¢qn
)):

295 
	`dev_îr
(
˘æ
->
devi˚
,

297 
öv_d©a
, 
d©a
->
subsy¢qn
);

300 
	`dev_îr
(
˘æ
->
devi˚
,

302 
öv_d©a
, 
off£t
 & 0xffff);

306 *
öv_sqe
 = "Connect Invalid SQE Parameter";

308 
off£t
) {

309 (
	`off£tof
(
nvmf_c⁄√˘_comm™d
, 
qid
)):

310 
	`dev_îr
(
˘æ
->
devi˚
,

312 
öv_sqe
, 
cmd
->
c⁄√˘
.
qid
);

315 
	`dev_îr
(
˘æ
->
devi˚
,

317 
öv_sqe
, 
off£t
);

322 
NVME_SC_CONNECT_INVALID_HOST
:

323 
	`dev_îr
(
˘æ
->
devi˚
,

325 
d©a
->
subsy¢qn
, d©a->
ho°nqn
);

328 
NVME_SC_CONNECT_CTRL_BUSY
:

329 
	`dev_îr
(
˘æ
->
devi˚
,

333 
NVME_SC_CONNECT_FORMAT
:

334 
	`dev_îr
(
˘æ
->
devi˚
,

336 
cmd
->
c⁄√˘
.
ªcfmt
);

340 
	`dev_îr
(
˘æ
->
devi˚
,

342 
îr_s˘y≥
);

345 
	}
}

367 
	$nvmf_c⁄√˘_admö_queue
(
nvme_˘æ
 *
˘æ
)

369 
nvme_comm™d
 
cmd
;

370 
nvme_ªsu…
 
ªs
;

371 
nvmf_c⁄√˘_d©a
 *
d©a
;

372 
ªt
;

374 
	`mem£t
(&
cmd
, 0, (cmd));

375 
cmd
.
c⁄√˘
.
›code
 = 
nvme_Ábrics_comm™d
;

376 
cmd
.
c⁄√˘
.
f˘y≥
 = 
nvme_Ábrics_ty≥_c⁄√˘
;

377 
cmd
.
c⁄√˘
.
qid
 = 0;

378 
cmd
.
c⁄√˘
.
sqsize
 = 
	`˝u_to_À16
(
NVME_AQ_DEPTH
 - 1);

384 
cmd
.
c⁄√˘
.
k©o
 = 
˘æ
->
›ts
->
discovîy_nqn
 ? 0 :

385 
	`˝u_to_À32
((
˘æ
->
k©o
 + 
NVME_KATO_GRACE
) * 1000);

387 i‡(
˘æ
->
›ts
->
dißbÀ_sqÊow
)

388 
cmd
.
c⁄√˘
.
ˇâr
 |
NVME_CONNECT_DISABLE_SQFLOW
;

390 
d©a
 = 
	`kzÆloc
((*d©a), 
GFP_KERNEL
);

391 i‡(!
d©a
)

392  -
ENOMEM
;

394 
	`uuid_c›y
(&
d©a
->
ho°id
, &
˘æ
->
›ts
->
ho°
->
id
);

395 
d©a
->
˙éid
 = 
	`˝u_to_À16
(0xffff);

396 
	`°∫˝y
(
d©a
->
subsy¢qn
, 
˘æ
->
›ts
->subsy¢qn, 
NVMF_NQN_SIZE
);

397 
	`°∫˝y
(
d©a
->
ho°nqn
, 
˘æ
->
›ts
->
ho°
->
nqn
, 
NVMF_NQN_SIZE
);

399 
ªt
 = 
	`__nvme_submô_sync_cmd
(
˘æ
->
admö_q
, &
cmd
, &
ªs
,

400 
d©a
, (*d©a), 0, 
NVME_QID_ANY
, 1,

401 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
, 
Ál£
);

402 i‡(
ªt
) {

403 
	`nvmf_log_c⁄√˘_îr‹
(
˘æ
, 
ªt
, 
	`À32_to_˝u
(
ªs
.
u32
),

404 &
cmd
, 
d©a
);

405 
out_‰ì_d©a
;

408 
˘æ
->
˙éid
 = 
	`À16_to_˝u
(
ªs
.
u16
);

410 
out_‰ì_d©a
:

411 
	`k‰ì
(
d©a
);

412  
ªt
;

413 
	}
}

414 
EXPORT_SYMBOL_GPL
(
nvmf_c⁄√˘_admö_queue
);

437 
	$nvmf_c⁄√˘_io_queue
(
nvme_˘æ
 *
˘æ
, 
u16
 
qid
, 
boﬁ
 
pﬁl
)

439 
nvme_comm™d
 
cmd
;

440 
nvmf_c⁄√˘_d©a
 *
d©a
;

441 
nvme_ªsu…
 
ªs
;

442 
ªt
;

444 
	`mem£t
(&
cmd
, 0, (cmd));

445 
cmd
.
c⁄√˘
.
›code
 = 
nvme_Ábrics_comm™d
;

446 
cmd
.
c⁄√˘
.
f˘y≥
 = 
nvme_Ábrics_ty≥_c⁄√˘
;

447 
cmd
.
c⁄√˘
.
qid
 = 
	`˝u_to_À16
(qid);

448 
cmd
.
c⁄√˘
.
sqsize
 = 
	`˝u_to_À16
(
˘æ
->sqsize);

450 i‡(
˘æ
->
›ts
->
dißbÀ_sqÊow
)

451 
cmd
.
c⁄√˘
.
ˇâr
 |
NVME_CONNECT_DISABLE_SQFLOW
;

453 
d©a
 = 
	`kzÆloc
((*d©a), 
GFP_KERNEL
);

454 i‡(!
d©a
)

455  -
ENOMEM
;

457 
	`uuid_c›y
(&
d©a
->
ho°id
, &
˘æ
->
›ts
->
ho°
->
id
);

458 
d©a
->
˙éid
 = 
	`˝u_to_À16
(
˘æ
->cntlid);

459 
	`°∫˝y
(
d©a
->
subsy¢qn
, 
˘æ
->
›ts
->subsy¢qn, 
NVMF_NQN_SIZE
);

460 
	`°∫˝y
(
d©a
->
ho°nqn
, 
˘æ
->
›ts
->
ho°
->
nqn
, 
NVMF_NQN_SIZE
);

462 
ªt
 = 
	`__nvme_submô_sync_cmd
(
˘æ
->
c⁄√˘_q
, &
cmd
, &
ªs
,

463 
d©a
, (*d©a), 0, 
qid
, 1,

464 
BLK_MQ_REQ_RESERVED
 | 
BLK_MQ_REQ_NOWAIT
, 
pﬁl
);

465 i‡(
ªt
) {

466 
	`nvmf_log_c⁄√˘_îr‹
(
˘æ
, 
ªt
, 
	`À32_to_˝u
(
ªs
.
u32
),

467 &
cmd
, 
d©a
);

469 
	`k‰ì
(
d©a
);

470  
ªt
;

471 
	}
}

472 
EXPORT_SYMBOL_GPL
(
nvmf_c⁄√˘_io_queue
);

474 
boﬁ
 
	$nvmf_should_ªc⁄√˘
(
nvme_˘æ
 *
˘æ
)

476 i‡(
˘æ
->
›ts
->
max_ªc⁄√˘s
 == -1 ||

477 
˘æ
->
ƒ_ªc⁄√˘s
 < cål->
›ts
->
max_ªc⁄√˘s
)

478  
åue
;

480  
Ál£
;

481 
	}
}

482 
EXPORT_SYMBOL_GPL
(
nvmf_should_ªc⁄√˘
);

493 
	$nvmf_ªgi°î_å™•‹t
(
nvmf_å™•‹t_›s
 *
›s
)

495 i‡(!
›s
->
¸óã_˘æ
)

496  -
EINVAL
;

498 
	`down_wrôe
(&
nvmf_å™•‹ts_rw£m
);

499 
	`li°_add_èû
(&
›s
->
íåy
, &
nvmf_å™•‹ts
);

500 
	`up_wrôe
(&
nvmf_å™•‹ts_rw£m
);

503 
	}
}

504 
EXPORT_SYMBOL_GPL
(
nvmf_ªgi°î_å™•‹t
);

515 
	$nvmf_uƒegi°î_å™•‹t
(
nvmf_å™•‹t_›s
 *
›s
)

517 
	`down_wrôe
(&
nvmf_å™•‹ts_rw£m
);

518 
	`li°_dñ
(&
›s
->
íåy
);

519 
	`up_wrôe
(&
nvmf_å™•‹ts_rw£m
);

520 
	}
}

521 
EXPORT_SYMBOL_GPL
(
nvmf_uƒegi°î_å™•‹t
);

523 
nvmf_å™•‹t_›s
 *
	$nvmf_lookup_å™•‹t
(

524 
nvmf_˘æ_›ti⁄s
 *
›ts
)

526 
nvmf_å™•‹t_›s
 *
›s
;

528 
	`lockdï_as£π_hñd
(&
nvmf_å™•‹ts_rw£m
);

530 
	`li°_f‹_óch_íåy
(
›s
, &
nvmf_å™•‹ts
, 
íåy
) {

531 i‡(
	`°rcmp
(
›s
->
«me
, 
›ts
->
å™•‹t
) == 0)

532  
›s
;

535  
NULL
;

536 
	}
}

547 
blk_°©us_t
 
	$nvmf_Áû_n⁄ªady_comm™d
(
nvme_˘æ
 *
˘æ
,

548 
ªque°
 *
rq
)

550 i‡(
˘æ
->
°©e
 !
NVME_CTRL_DELETING
 &&

551 
˘æ
->
°©e
 !
NVME_CTRL_DEAD
 &&

552 !
	`blk_n‹ëry_ªque°
(
rq
Ë&& !‘q->
cmd_Êags
 & 
REQ_NVME_MPATH
))

553  
BLK_STS_RESOURCE
;

555 
	`nvme_ªq
(
rq
)->
°©us
 = 
NVME_SC_HOST_PATH_ERROR
;

556 
	`blk_mq_°¨t_ªque°
(
rq
);

557 
	`nvme_com∂ëe_rq
(
rq
);

558  
BLK_STS_OK
;

559 
	}
}

560 
EXPORT_SYMBOL_GPL
(
nvmf_Áû_n⁄ªady_comm™d
);

562 
boﬁ
 
	$__nvmf_check_ªady
(
nvme_˘æ
 *
˘æ
, 
ªque°
 *
rq
,

563 
boﬁ
 
queue_live
)

565 
nvme_ªque°
 *
ªq
 = 
	`nvme_ªq
(
rq
);

571 i‡(!
	`blk_rq_is_∑s°hrough
(
rq
Ë|| (
ªq
->
Êags
 & 
NVME_REQ_USERCMD
))

572  
Ál£
;

578 
˘æ
->
°©e
) {

579 
NVME_CTRL_NEW
:

580 
NVME_CTRL_CONNECTING
:

581 i‡(
ªq
->
cmd
->
comm⁄
.
›code
 =
nvme_Ábrics_comm™d
 &&

582 
ªq
->
cmd
->
Ábrics
.
f˘y≥
 =
nvme_Ábrics_ty≥_c⁄√˘
)

583  
åue
;

587 
NVME_CTRL_DEAD
:

588  
Ál£
;

591  
queue_live
;

592 
	}
}

593 
EXPORT_SYMBOL_GPL
(
__nvmf_check_ªady
);

595 c⁄° 
m©ch_èbÀ_t
 
	g›t_tokís
 = {

596 { 
NVMF_OPT_TRANSPORT
, "transport=%s" },

597 { 
NVMF_OPT_TRADDR
, "traddr=%s" },

598 { 
NVMF_OPT_TRSVCID
, "trsvcid=%s" },

599 { 
NVMF_OPT_NQN
, "nqn=%s" },

600 { 
NVMF_OPT_QUEUE_SIZE
, "queue_size=%d" },

601 { 
NVMF_OPT_NR_IO_QUEUES
, "nr_io_queues=%d" },

602 { 
NVMF_OPT_RECONNECT_DELAY
, "reconnect_delay=%d" },

603 { 
NVMF_OPT_CTRL_LOSS_TMO
, "ctrl_loss_tmo=%d" },

604 { 
NVMF_OPT_KATO
, "keep_alive_tmo=%d" },

605 { 
NVMF_OPT_HOSTNQN
, "hostnqn=%s" },

606 { 
NVMF_OPT_HOST_TRADDR
, "host_traddr=%s" },

607 { 
NVMF_OPT_HOST_ID
, "hostid=%s" },

608 { 
NVMF_OPT_DUP_CONNECT
, "duplicate_connect" },

609 { 
NVMF_OPT_DISABLE_SQFLOW
, "disable_sqflow" },

610 { 
NVMF_OPT_HDR_DIGEST
, "hdr_digest" },

611 { 
NVMF_OPT_DATA_DIGEST
, "data_digest" },

612 { 
NVMF_OPT_NR_WRITE_QUEUES
, "nr_write_queues=%d" },

613 { 
NVMF_OPT_NR_POLL_QUEUES
, "nr_poll_queues=%d" },

614 { 
NVMF_OPT_ERR
, 
NULL
 }

617 
	$nvmf_∑r£_›ti⁄s
(
nvmf_˘æ_›ti⁄s
 *
›ts
,

618 c⁄° *
buf
)

620 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

621 *
›ti⁄s
, *
o
, *
p
;

622 
tokí
, 
ªt
 = 0;

623 
size_t
 
nq∆í
 = 0;

624 
˘æ_loss_tmo
 = 
NVMF_DEF_CTRL_LOSS_TMO
;

625 
uuid_t
 
ho°id
;

628 
›ts
->
queue_size
 = 
NVMF_DEF_QUEUE_SIZE
;

629 
›ts
->
ƒ_io_queues
 = 
	`num_⁄löe_˝us
();

630 
›ts
->
ªc⁄√˘_dñay
 = 
NVMF_DEF_RECONNECT_DELAY
;

631 
›ts
->
k©o
 = 
NVME_DEFAULT_KATO
;

632 
›ts
->
du∂iˇã_c⁄√˘
 = 
Ál£
;

633 
›ts
->
hdr_dige°
 = 
Ál£
;

634 
›ts
->
d©a_dige°
 = 
Ál£
;

636 
›ti⁄s
 = 
o
 = 
	`k°rdup
(
buf
, 
GFP_KERNEL
);

637 i‡(!
›ti⁄s
)

638  -
ENOMEM
;

640 
	`uuid_gí
(&
ho°id
);

642 (
p
 = 
	`°r£p
(&
o
, ",\n")Ë!
NULL
) {

643 i‡(!*
p
)

646 
tokí
 = 
	`m©ch_tokí
(
p
, 
›t_tokís
, 
¨gs
);

647 
›ts
->
mask
 |
tokí
;

648 
tokí
) {

649 
NVMF_OPT_TRANSPORT
:

650 
p
 = 
	`m©ch_°rdup
(
¨gs
);

651 i‡(!
p
) {

652 
ªt
 = -
ENOMEM
;

653 
out
;

655 
	`k‰ì
(
›ts
->
å™•‹t
);

656 
›ts
->
å™•‹t
 = 
p
;

658 
NVMF_OPT_NQN
:

659 
p
 = 
	`m©ch_°rdup
(
¨gs
);

660 i‡(!
p
) {

661 
ªt
 = -
ENOMEM
;

662 
out
;

664 
	`k‰ì
(
›ts
->
subsy¢qn
);

665 
›ts
->
subsy¢qn
 = 
p
;

666 
nq∆í
 = 
	`°æí
(
›ts
->
subsy¢qn
);

667 i‡(
nq∆í
 >
NVMF_NQN_SIZE
) {

668 
	`¥_îr
("%sÇeedsÅo be < %d bytes\n",

669 
›ts
->
subsy¢qn
, 
NVMF_NQN_SIZE
);

670 
ªt
 = -
EINVAL
;

671 
out
;

673 
›ts
->
discovîy_nqn
 =

674 !(
	`°rcmp
(
›ts
->
subsy¢qn
,

675 
NVME_DISC_SUBSYS_NAME
));

677 
NVMF_OPT_TRADDR
:

678 
p
 = 
	`m©ch_°rdup
(
¨gs
);

679 i‡(!
p
) {

680 
ªt
 = -
ENOMEM
;

681 
out
;

683 
	`k‰ì
(
›ts
->
åaddr
);

684 
›ts
->
åaddr
 = 
p
;

686 
NVMF_OPT_TRSVCID
:

687 
p
 = 
	`m©ch_°rdup
(
¨gs
);

688 i‡(!
p
) {

689 
ªt
 = -
ENOMEM
;

690 
out
;

692 
	`k‰ì
(
›ts
->
åsvcid
);

693 
›ts
->
åsvcid
 = 
p
;

695 
NVMF_OPT_QUEUE_SIZE
:

696 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

697 
ªt
 = -
EINVAL
;

698 
out
;

700 i‡(
tokí
 < 
NVMF_MIN_QUEUE_SIZE
 ||

701 
tokí
 > 
NVMF_MAX_QUEUE_SIZE
) {

702 
	`¥_îr
("InvÆid queue_sizê%d\n", 
tokí
);

703 
ªt
 = -
EINVAL
;

704 
out
;

706 
›ts
->
queue_size
 = 
tokí
;

708 
NVMF_OPT_NR_IO_QUEUES
:

709 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

710 
ªt
 = -
EINVAL
;

711 
out
;

713 i‡(
tokí
 <= 0) {

714 
	`¥_îr
("InvÆidÇumbî o‡IOQ†%d\n", 
tokí
);

715 
ªt
 = -
EINVAL
;

716 
out
;

718 i‡(
›ts
->
discovîy_nqn
) {

719 
	`¥_debug
("IgnoringÇr_io_queues value for discovery controller\n");

723 
›ts
->
ƒ_io_queues
 = 
	`mö_t
(,

724 
	`num_⁄löe_˝us
(), 
tokí
);

726 
NVMF_OPT_KATO
:

727 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

728 
ªt
 = -
EINVAL
;

729 
out
;

732 i‡(
tokí
 < 0) {

733 
	`¥_îr
("InvÆid kìp_Æive_tmÿ%d\n", 
tokí
);

734 
ªt
 = -
EINVAL
;

735 
out
;

736 } i‡(
tokí
 =0 && !
›ts
->
discovîy_nqn
) {

738 
	`¥_w¨n
("keep_alive_tmo 0 won'tÉxecute keepálives!!!\n");

740 
›ts
->
k©o
 = 
tokí
;

742 i‡(
›ts
->
discovîy_nqn
 && o±s->
k©o
) {

743 
	`¥_îr
("Discovery controllers cannotáccept KATO != 0\n");

744 
ªt
 = -
EINVAL
;

745 
out
;

749 
NVMF_OPT_CTRL_LOSS_TMO
:

750 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

751 
ªt
 = -
EINVAL
;

752 
out
;

755 i‡(
tokí
 < 0)

756 
	`¥_w¨n
("ctrl_loss_tmo < 0 willÑeconnect forever\n");

757 
˘æ_loss_tmo
 = 
tokí
;

759 
NVMF_OPT_HOSTNQN
:

760 i‡(
›ts
->
ho°
) {

761 
	`¥_îr
("hostnqnálready user-assigned: %s\n",

762 
›ts
->
ho°
->
nqn
);

763 
ªt
 = -
EADDRINUSE
;

764 
out
;

766 
p
 = 
	`m©ch_°rdup
(
¨gs
);

767 i‡(!
p
) {

768 
ªt
 = -
ENOMEM
;

769 
out
;

771 
nq∆í
 = 
	`°æí
(
p
);

772 i‡(
nq∆í
 >
NVMF_NQN_SIZE
) {

773 
	`¥_îr
("%sÇeedsÅo be < %d bytes\n",

774 
p
, 
NVMF_NQN_SIZE
);

775 
	`k‰ì
(
p
);

776 
ªt
 = -
EINVAL
;

777 
out
;

779 
	`nvmf_ho°_put
(
›ts
->
ho°
);

780 
›ts
->
ho°
 = 
	`nvmf_ho°_add
(
p
);

781 
	`k‰ì
(
p
);

782 i‡(!
›ts
->
ho°
) {

783 
ªt
 = -
ENOMEM
;

784 
out
;

787 
NVMF_OPT_RECONNECT_DELAY
:

788 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

789 
ªt
 = -
EINVAL
;

790 
out
;

792 i‡(
tokí
 <= 0) {

793 
	`¥_îr
("InvÆidÑec⁄√˘_dñay %d\n", 
tokí
);

794 
ªt
 = -
EINVAL
;

795 
out
;

797 
›ts
->
ªc⁄√˘_dñay
 = 
tokí
;

799 
NVMF_OPT_HOST_TRADDR
:

800 
p
 = 
	`m©ch_°rdup
(
¨gs
);

801 i‡(!
p
) {

802 
ªt
 = -
ENOMEM
;

803 
out
;

805 
	`k‰ì
(
›ts
->
ho°_åaddr
);

806 
›ts
->
ho°_åaddr
 = 
p
;

808 
NVMF_OPT_HOST_ID
:

809 
p
 = 
	`m©ch_°rdup
(
¨gs
);

810 i‡(!
p
) {

811 
ªt
 = -
ENOMEM
;

812 
out
;

814 
ªt
 = 
	`uuid_∑r£
(
p
, &
ho°id
);

815 i‡(
ªt
) {

816 
	`¥_îr
("InvÆid ho°id %s\n", 
p
);

817 
ªt
 = -
EINVAL
;

818 
	`k‰ì
(
p
);

819 
out
;

821 
	`k‰ì
(
p
);

823 
NVMF_OPT_DUP_CONNECT
:

824 
›ts
->
du∂iˇã_c⁄√˘
 = 
åue
;

826 
NVMF_OPT_DISABLE_SQFLOW
:

827 
›ts
->
dißbÀ_sqÊow
 = 
åue
;

829 
NVMF_OPT_HDR_DIGEST
:

830 
›ts
->
hdr_dige°
 = 
åue
;

832 
NVMF_OPT_DATA_DIGEST
:

833 
›ts
->
d©a_dige°
 = 
åue
;

835 
NVMF_OPT_NR_WRITE_QUEUES
:

836 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

837 
ªt
 = -
EINVAL
;

838 
out
;

840 i‡(
tokí
 <= 0) {

841 
	`¥_îr
("InvÆidÇr_wrôe_queue†%d\n", 
tokí
);

842 
ªt
 = -
EINVAL
;

843 
out
;

845 
›ts
->
ƒ_wrôe_queues
 = 
tokí
;

847 
NVMF_OPT_NR_POLL_QUEUES
:

848 i‡(
	`m©ch_öt
(
¨gs
, &
tokí
)) {

849 
ªt
 = -
EINVAL
;

850 
out
;

852 i‡(
tokí
 <= 0) {

853 
	`¥_îr
("InvÆidÇr_pﬁl_queue†%d\n", 
tokí
);

854 
ªt
 = -
EINVAL
;

855 
out
;

857 
›ts
->
ƒ_pﬁl_queues
 = 
tokí
;

860 
	`¥_w¨n
("unknownÖarameter or missing value '%s' in ctrl creationÑequest\n",

861 
p
);

862 
ªt
 = -
EINVAL
;

863 
out
;

867 i‡(
›ts
->
discovîy_nqn
) {

868 
›ts
->
k©o
 = 0;

869 
›ts
->
ƒ_io_queues
 = 0;

870 
›ts
->
ƒ_wrôe_queues
 = 0;

871 
›ts
->
ƒ_pﬁl_queues
 = 0;

872 
›ts
->
du∂iˇã_c⁄√˘
 = 
åue
;

874 i‡(
˘æ_loss_tmo
 < 0)

875 
›ts
->
max_ªc⁄√˘s
 = -1;

877 
›ts
->
max_ªc⁄√˘s
 = 
	`DIV_ROUND_UP
(
˘æ_loss_tmo
,

878 
›ts
->
ªc⁄√˘_dñay
);

880 i‡(!
›ts
->
ho°
) {

881 
	`kªf_gë
(&
nvmf_deÁu…_ho°
->
ªf
);

882 
›ts
->
ho°
 = 
nvmf_deÁu…_ho°
;

885 
	`uuid_c›y
(&
›ts
->
ho°
->
id
, &
ho°id
);

887 
out
:

888 
	`k‰ì
(
›ti⁄s
);

889  
ªt
;

890 
	}
}

892 
	$nvmf_check_ªquúed_›ts
(
nvmf_˘æ_›ti⁄s
 *
›ts
,

893 
ªquúed_›ts
)

895 i‡((
›ts
->
mask
 & 
ªquúed_›ts
) !=Ñequired_opts) {

896 
i
;

898 
i
 = 0; i < 
	`ARRAY_SIZE
(
›t_tokís
); i++) {

899 i‡((
›t_tokís
[
i
].
tokí
 & 
ªquúed_›ts
) &&

900 !(
›t_tokís
[
i
].
tokí
 & 
›ts
->
mask
)) {

901 
	`¥_w¨n
("missingÖarameter '%s'\n",

902 
›t_tokís
[
i
].
∑âîn
);

906  -
EINVAL
;

910 
	}
}

912 
boﬁ
 
	$nvmf_ù_›ti⁄s_m©ch
(
nvme_˘æ
 *
˘æ
,

913 
nvmf_˘æ_›ti⁄s
 *
›ts
)

915 i‡(!
	`nvmf_˘Ã_m©ches_ba£›ts
(
˘æ
, 
›ts
) ||

916 
	`°rcmp
(
›ts
->
åaddr
, 
˘æ
->opts->traddr) ||

917 
	`°rcmp
(
›ts
->
åsvcid
, 
˘æ
->opts->trsvcid))

918  
Ál£
;

929 i‡((
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) &&

930 (
˘æ
->
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)) {

931 i‡(
	`°rcmp
(
›ts
->
ho°_åaddr
, 
˘æ
->opts->host_traddr))

932  
Ál£
;

933 } i‡((
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) ||

934 (
˘æ
->
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)) {

935  
Ál£
;

938  
åue
;

939 
	}
}

940 
EXPORT_SYMBOL_GPL
(
nvmf_ù_›ti⁄s_m©ch
);

942 
	$nvmf_check_Ælowed_›ts
(
nvmf_˘æ_›ti⁄s
 *
›ts
,

943 
Ælowed_›ts
)

945 i‡(
›ts
->
mask
 & ~
Ælowed_›ts
) {

946 
i
;

948 
i
 = 0; i < 
	`ARRAY_SIZE
(
›t_tokís
); i++) {

949 i‡((
›t_tokís
[
i
].
tokí
 & 
›ts
->
mask
) &&

950 (
›t_tokís
[
i
].
tokí
 & ~
Ælowed_›ts
)) {

951 
	`¥_w¨n
("invalidÖarameter '%s'\n",

952 
›t_tokís
[
i
].
∑âîn
);

956  -
EINVAL
;

960 
	}
}

962 
	$nvmf_‰ì_›ti⁄s
(
nvmf_˘æ_›ti⁄s
 *
›ts
)

964 
	`nvmf_ho°_put
(
›ts
->
ho°
);

965 
	`k‰ì
(
›ts
->
å™•‹t
);

966 
	`k‰ì
(
›ts
->
åaddr
);

967 
	`k‰ì
(
›ts
->
åsvcid
);

968 
	`k‰ì
(
›ts
->
subsy¢qn
);

969 
	`k‰ì
(
›ts
->
ho°_åaddr
);

970 
	`k‰ì
(
›ts
);

971 
	}
}

972 
EXPORT_SYMBOL_GPL
(
nvmf_‰ì_›ti⁄s
);

974 
	#NVMF_REQUIRED_OPTS
 (
NVMF_OPT_TRANSPORT
 | 
NVMF_OPT_NQN
)

	)

975 
	#NVMF_ALLOWED_OPTS
 (
NVMF_OPT_QUEUE_SIZE
 | 
NVMF_OPT_NR_IO_QUEUES
 | \

976 
NVMF_OPT_KATO
 | 
NVMF_OPT_HOSTNQN
 | \

977 
NVMF_OPT_HOST_ID
 | 
NVMF_OPT_DUP_CONNECT
 |\

978 
NVMF_OPT_DISABLE_SQFLOW
)

	)

980 
nvme_˘æ
 *

981 
	$nvmf_¸óã_˘æ
(
devi˚
 *
dev
, c⁄° *
buf
, 
size_t
 
cou¡
)

983 
nvmf_˘æ_›ti⁄s
 *
›ts
;

984 
nvmf_å™•‹t_›s
 *
›s
;

985 
nvme_˘æ
 *
˘æ
;

986 
ªt
;

988 
›ts
 = 
	`kzÆloc
((*›ts), 
GFP_KERNEL
);

989 i‡(!
›ts
)

990  
	`ERR_PTR
(-
ENOMEM
);

992 
ªt
 = 
	`nvmf_∑r£_›ti⁄s
(
›ts
, 
buf
);

993 i‡(
ªt
)

994 
out_‰ì_›ts
;

997 
	`ªque°_moduÀ
("nvme-%s", 
›ts
->
å™•‹t
);

1004 
ªt
 = 
	`nvmf_check_ªquúed_›ts
(
›ts
, 
NVMF_REQUIRED_OPTS
);

1005 i‡(
ªt
)

1006 
out_‰ì_›ts
;

1007 
›ts
->
mask
 &~
NVMF_REQUIRED_OPTS
;

1009 
	`down_ªad
(&
nvmf_å™•‹ts_rw£m
);

1010 
›s
 = 
	`nvmf_lookup_å™•‹t
(
›ts
);

1011 i‡(!
›s
) {

1012 
	`¥_öfo
("no handler found forÅransport %s.\n",

1013 
›ts
->
å™•‹t
);

1014 
ªt
 = -
EINVAL
;

1015 
out_u∆ock
;

1018 i‡(!
	`åy_moduÀ_gë
(
›s
->
moduÀ
)) {

1019 
ªt
 = -
EBUSY
;

1020 
out_u∆ock
;

1022 
	`up_ªad
(&
nvmf_å™•‹ts_rw£m
);

1024 
ªt
 = 
	`nvmf_check_ªquúed_›ts
(
›ts
, 
›s
->
ªquúed_›ts
);

1025 i‡(
ªt
)

1026 
out_moduÀ_put
;

1027 
ªt
 = 
	`nvmf_check_Ælowed_›ts
(
›ts
, 
NVMF_ALLOWED_OPTS
 |

1028 
›s
->
Ælowed_›ts
 | ops->
ªquúed_›ts
);

1029 i‡(
ªt
)

1030 
out_moduÀ_put
;

1032 
˘æ
 = 
›s
->
	`¸óã_˘æ
(
dev
, 
›ts
);

1033 i‡(
	`IS_ERR
(
˘æ
)) {

1034 
ªt
 = 
	`PTR_ERR
(
˘æ
);

1035 
out_moduÀ_put
;

1038 
	`moduÀ_put
(
›s
->
moduÀ
);

1039  
˘æ
;

1041 
out_moduÀ_put
:

1042 
	`moduÀ_put
(
›s
->
moduÀ
);

1043 
out_‰ì_›ts
;

1044 
out_u∆ock
:

1045 
	`up_ªad
(&
nvmf_å™•‹ts_rw£m
);

1046 
out_‰ì_›ts
:

1047 
	`nvmf_‰ì_›ti⁄s
(
›ts
);

1048  
	`ERR_PTR
(
ªt
);

1049 
	}
}

1051 
˛ass
 *
	gnvmf_˛ass
;

1052 
devi˚
 *
	gnvmf_devi˚
;

1053 
DEFINE_MUTEX
(
nvmf_dev_muãx
);

1055 
ssize_t
 
	$nvmf_dev_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
ubuf
,

1056 
size_t
 
cou¡
, 
loff_t
 *
pos
)

1058 
£q_fûe
 *£q_fûê
fûe
->
¥iv©e_d©a
;

1059 
nvme_˘æ
 *
˘æ
;

1060 c⁄° *
buf
;

1061 
ªt
 = 0;

1063 i‡(
cou¡
 > 
PAGE_SIZE
)

1064  -
ENOMEM
;

1066 
buf
 = 
	`memdup_u£r_nul
(
ubuf
, 
cou¡
);

1067 i‡(
	`IS_ERR
(
buf
))

1068  
	`PTR_ERR
(
buf
);

1070 
	`muãx_lock
(&
nvmf_dev_muãx
);

1071 i‡(
£q_fûe
->
¥iv©e
) {

1072 
ªt
 = -
EINVAL
;

1073 
out_u∆ock
;

1076 
˘æ
 = 
	`nvmf_¸óã_˘æ
(
nvmf_devi˚
, 
buf
, 
cou¡
);

1077 i‡(
	`IS_ERR
(
˘æ
)) {

1078 
ªt
 = 
	`PTR_ERR
(
˘æ
);

1079 
out_u∆ock
;

1082 
£q_fûe
->
¥iv©e
 = 
˘æ
;

1084 
out_u∆ock
:

1085 
	`muãx_u∆ock
(&
nvmf_dev_muãx
);

1086 
	`k‰ì
(
buf
);

1087  
ªt
 ?Ñë : 
cou¡
;

1088 
	}
}

1090 
	$nvmf_dev_show
(
£q_fûe
 *£q_fûe, *
¥iv©e
)

1092 
nvme_˘æ
 *
˘æ
;

1093 
ªt
 = 0;

1095 
	`muãx_lock
(&
nvmf_dev_muãx
);

1096 
˘æ
 = 
£q_fûe
->
¥iv©e
;

1097 i‡(!
˘æ
) {

1098 
ªt
 = -
EINVAL
;

1099 
out_u∆ock
;

1102 
	`£q_¥ötf
(
£q_fûe
, "instance=%d,cntlid=%d\n",

1103 
˘æ
->
ö°™˚
, cål->
˙éid
);

1105 
out_u∆ock
:

1106 
	`muãx_u∆ock
(&
nvmf_dev_muãx
);

1107  
ªt
;

1108 
	}
}

1110 
	$nvmf_dev_›í
(
öode
 *öode, 
fûe
 *file)

1116 
fûe
->
¥iv©e_d©a
 = 
NULL
;

1117  
	`sögÀ_›í
(
fûe
, 
nvmf_dev_show
, 
NULL
);

1118 
	}
}

1120 
	$nvmf_dev_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1122 
£q_fûe
 *£q_fûê
fûe
->
¥iv©e_d©a
;

1123 
nvme_˘æ
 *
˘æ
 = 
£q_fûe
->
¥iv©e
;

1125 i‡(
˘æ
)

1126 
	`nvme_put_˘æ
(
˘æ
);

1127  
	`sögÀ_ªÀa£
(
öode
, 
fûe
);

1128 
	}
}

1130 c⁄° 
fûe_›î©i⁄s
 
	gnvmf_dev_f›s
 = {

1131 .
ow√r
 = 
THIS_MODULE
,

1132 .
	gwrôe
 = 
nvmf_dev_wrôe
,

1133 .
	gªad
 = 
£q_ªad
,

1134 .
	g›í
 = 
nvmf_dev_›í
,

1135 .
	gªÀa£
 = 
nvmf_dev_ªÀa£
,

1138 
miscdevi˚
 
	gnvmf_misc
 = {

1139 .
mö‹
 = 
MISC_DYNAMIC_MINOR
,

1140 .
	g«me
 = "nvme-fabrics",

1141 .
	gf›s
 = &
nvmf_dev_f›s
,

1144 
__öô
 
	$nvmf_öô
()

1146 
ªt
;

1148 
nvmf_deÁu…_ho°
 = 
	`nvmf_ho°_deÁu…
();

1149 i‡(!
nvmf_deÁu…_ho°
)

1150  -
ENOMEM
;

1152 
nvmf_˛ass
 = 
	`˛ass_¸óã
(
THIS_MODULE
, "nvme-fabrics");

1153 i‡(
	`IS_ERR
(
nvmf_˛ass
)) {

1154 
	`¥_îr
("couldn'tÑegister classÇvme-fabrics\n");

1155 
ªt
 = 
	`PTR_ERR
(
nvmf_˛ass
);

1156 
out_‰ì_ho°
;

1159 
nvmf_devi˚
 =

1160 
	`devi˚_¸óã
(
nvmf_˛ass
, 
NULL
, 
	`MKDEV
(0, 0), NULL, "ctl");

1161 i‡(
	`IS_ERR
(
nvmf_devi˚
)) {

1162 
	`¥_îr
("couldn't createÇvme-fabris device!\n");

1163 
ªt
 = 
	`PTR_ERR
(
nvmf_devi˚
);

1164 
out_de°roy_˛ass
;

1167 
ªt
 = 
	`misc_ªgi°î
(&
nvmf_misc
);

1168 i‡(
ªt
) {

1169 
	`¥_îr
("couldn'àªgi°î mis¯devi˚: %d\n", 
ªt
);

1170 
out_de°roy_devi˚
;

1175 
out_de°roy_devi˚
:

1176 
	`devi˚_de°roy
(
nvmf_˛ass
, 
	`MKDEV
(0, 0));

1177 
out_de°roy_˛ass
:

1178 
	`˛ass_de°roy
(
nvmf_˛ass
);

1179 
out_‰ì_ho°
:

1180 
	`nvmf_ho°_put
(
nvmf_deÁu…_ho°
);

1181  
ªt
;

1182 
	}
}

1184 
__exô
 
	$nvmf_exô
()

1186 
	`misc_dîegi°î
(&
nvmf_misc
);

1187 
	`devi˚_de°roy
(
nvmf_˛ass
, 
	`MKDEV
(0, 0));

1188 
	`˛ass_de°roy
(
nvmf_˛ass
);

1189 
	`nvmf_ho°_put
(
nvmf_deÁu…_ho°
);

1191 
	`BUILD_BUG_ON
((
nvmf_c⁄√˘_comm™d
) != 64);

1192 
	`BUILD_BUG_ON
((
nvmf_¥›îty_gë_comm™d
) != 64);

1193 
	`BUILD_BUG_ON
((
nvmf_¥›îty_£t_comm™d
) != 64);

1194 
	`BUILD_BUG_ON
((
nvmf_c⁄√˘_d©a
) != 1024);

1195 
	}
}

1197 
MODULE_LICENSE
("GPL v2");

1199 
moduÀ_öô
(
nvmf_öô
);

1200 
moduÀ_exô
(
nvmf_exô
);

	@fabrics.h

6 #i‚de‡
_NVME_FABRICS_H


7 
	#_NVME_FABRICS_H
 1

	)

9 
	~<löux/ö.h
>

10 
	~<löux/öë.h
>

12 
	#NVMF_MIN_QUEUE_SIZE
 16

	)

13 
	#NVMF_MAX_QUEUE_SIZE
 1024

	)

14 
	#NVMF_DEF_QUEUE_SIZE
 128

	)

15 
	#NVMF_DEF_RECONNECT_DELAY
 10

	)

17 
	#NVMF_DEF_CTRL_LOSS_TMO
 600

	)

27 
	snvmf_ho°
 {

28 
kªf
 
	mªf
;

29 
li°_hód
 
	mli°
;

30 
	mnqn
[
NVMF_NQN_SIZE
];

31 
uuid_t
 
	mid
;

38 
	mNVMF_OPT_ERR
 = 0,

39 
	mNVMF_OPT_TRANSPORT
 = 1 << 0,

40 
	mNVMF_OPT_NQN
 = 1 << 1,

41 
	mNVMF_OPT_TRADDR
 = 1 << 2,

42 
	mNVMF_OPT_TRSVCID
 = 1 << 3,

43 
	mNVMF_OPT_QUEUE_SIZE
 = 1 << 4,

44 
	mNVMF_OPT_NR_IO_QUEUES
 = 1 << 5,

45 
	mNVMF_OPT_TL_RETRY_COUNT
 = 1 << 6,

46 
	mNVMF_OPT_KATO
 = 1 << 7,

47 
	mNVMF_OPT_HOSTNQN
 = 1 << 8,

48 
	mNVMF_OPT_RECONNECT_DELAY
 = 1 << 9,

49 
	mNVMF_OPT_HOST_TRADDR
 = 1 << 10,

50 
	mNVMF_OPT_CTRL_LOSS_TMO
 = 1 << 11,

51 
	mNVMF_OPT_HOST_ID
 = 1 << 12,

52 
	mNVMF_OPT_DUP_CONNECT
 = 1 << 13,

53 
	mNVMF_OPT_DISABLE_SQFLOW
 = 1 << 14,

54 
	mNVMF_OPT_HDR_DIGEST
 = 1 << 15,

55 
	mNVMF_OPT_DATA_DIGEST
 = 1 << 16,

56 
	mNVMF_OPT_NR_WRITE_QUEUES
 = 1 << 17,

57 
	mNVMF_OPT_NR_POLL_QUEUES
 = 1 << 18,

91 
	snvmf_˘æ_›ti⁄s
 {

92 
	mmask
;

93 *
	må™•‹t
;

94 *
	msubsy¢qn
;

95 *
	måaddr
;

96 *
	måsvcid
;

97 *
	mho°_åaddr
;

98 
size_t
 
	mqueue_size
;

99 
	mƒ_io_queues
;

100 
	mªc⁄√˘_dñay
;

101 
boﬁ
 
	mdiscovîy_nqn
;

102 
boﬁ
 
	mdu∂iˇã_c⁄√˘
;

103 
	mk©o
;

104 
nvmf_ho°
 *
	mho°
;

105 
	mmax_ªc⁄√˘s
;

106 
boﬁ
 
	mdißbÀ_sqÊow
;

107 
boﬁ
 
	mhdr_dige°
;

108 
boﬁ
 
	md©a_dige°
;

109 
	mƒ_wrôe_queues
;

110 
	mƒ_pﬁl_queues
;

138 
	snvmf_å™•‹t_›s
 {

139 
li°_hód
 
	míåy
;

140 
moduÀ
 *
	mmoduÀ
;

141 c⁄° *
	m«me
;

142 
	mªquúed_›ts
;

143 
	mÆlowed_›ts
;

144 
	mnvme_˘æ
 *(*
	m¸óã_˘æ
)(
devi˚
 *
	mdev
,

145 
nvmf_˘æ_›ti⁄s
 *
	m›ts
);

148 
ölöe
 
boﬁ


149 
	$nvmf_˘Ã_m©ches_ba£›ts
(
nvme_˘æ
 *
˘æ
,

150 
nvmf_˘æ_›ti⁄s
 *
›ts
)

152 i‡(
˘æ
->
°©e
 =
NVME_CTRL_DELETING
 ||

153 
˘æ
->
°©e
 =
NVME_CTRL_DEAD
 ||

154 
	`°rcmp
(
›ts
->
subsy¢qn
, 
˘æ
->opts->subsysnqn) ||

155 
	`°rcmp
(
›ts
->
ho°
->
nqn
, 
˘æ
->opts->host->nqn) ||

156 
	`memcmp
(&
›ts
->
ho°
->
id
, &
˘æ
->›ts->ho°->id, (
uuid_t
)))

157  
Ál£
;

159  
åue
;

160 
	}
}

162 
nvmf_ªg_ªad32
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, u32 *
vÆ
);

163 
nvmf_ªg_ªad64
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, 
u64
 *
vÆ
);

164 
nvmf_ªg_wrôe32
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, u32 
vÆ
);

165 
nvmf_c⁄√˘_admö_queue
(
nvme_˘æ
 *
˘æ
);

166 
nvmf_c⁄√˘_io_queue
(
nvme_˘æ
 *
˘æ
, 
u16
 
qid
, 
boﬁ
 
pﬁl
);

167 
nvmf_ªgi°î_å™•‹t
(
nvmf_å™•‹t_›s
 *
›s
);

168 
nvmf_uƒegi°î_å™•‹t
(
nvmf_å™•‹t_›s
 *
›s
);

169 
nvmf_‰ì_›ti⁄s
(
nvmf_˘æ_›ti⁄s
 *
›ts
);

170 
nvmf_gë_addªss
(
nvme_˘æ
 *
˘æ
, *
buf
, 
size
);

171 
boﬁ
 
nvmf_should_ªc⁄√˘
(
nvme_˘æ
 *
˘æ
);

172 
blk_°©us_t
 
nvmf_Áû_n⁄ªady_comm™d
(
nvme_˘æ
 *
˘æ
,

173 
ªque°
 *
rq
);

174 
boﬁ
 
__nvmf_check_ªady
(
nvme_˘æ
 *
˘æ
, 
ªque°
 *
rq
,

175 
boﬁ
 
queue_live
);

176 
boﬁ
 
nvmf_ù_›ti⁄s_m©ch
(
nvme_˘æ
 *
˘æ
,

177 
nvmf_˘æ_›ti⁄s
 *
›ts
);

179 
ölöe
 
boﬁ
 
	$nvmf_check_ªady
(
nvme_˘æ
 *
˘æ
, 
ªque°
 *
rq
,

180 
boﬁ
 
queue_live
)

182 i‡(
	`likñy
(
˘æ
->
°©e
 =
NVME_CTRL_LIVE
 ||

183 
˘æ
->
°©e
 =
NVME_CTRL_ADMIN_ONLY
))

184  
åue
;

185  
	`__nvmf_check_ªady
(
˘æ
, 
rq
, 
queue_live
);

186 
	}
}

	@fault_inject.c

8 
	~<löux/moduÀ∑øm.h
>

9 
	~"nvme.h
"

11 
DECLARE_FAULT_ATTR
(
Áû_deÁu…_©å
);

15 *
	gÁû_ªque°
;

16 
moduÀ_∑øm
(
Áû_ªque°
, 
ch¨p
, 0000);

18 
	$nvme_Áu…_öje˘_öô
(
nvme_ns
 *
ns
)

20 
díåy
 *
dú
, *
∑ª¡
;

21 *
«me
 = 
ns
->
disk
->
disk_«me
;

22 
nvme_Áu…_öje˘
 *
Áu…_öj
 = &
ns
->
Áu…_öje˘
;

23 
Áu…_©å
 *
©å
 = &
Áu…_öj
->attr;

26 i‡(
Áû_ªque°
)

27 
	`£tup_Áu…_©å
(&
Áû_deÁu…_©å
, 
Áû_ªque°
);

30 
∑ª¡
 = 
	`debugfs_¸óã_dú
(
«me
, 
NULL
);

31 i‡(!
∑ª¡
) {

32 
	`¥_w¨n
("%s: faûedÅÿ¸óã debugf†dúe˘‹y\n", 
«me
);

36 *
©å
 = 
Áû_deÁu…_©å
;

37 
dú
 = 
	`Áu…_¸óã_debugfs_©å
("Áu…_öje˘", 
∑ª¡
, 
©å
);

38 i‡(
	`IS_ERR
(
dú
)) {

39 
	`¥_w¨n
("%s: faûedÅÿ¸óã debugf†©å\n", 
«me
);

40 
	`debugfs_ªmove_ªcursive
(
∑ª¡
);

43 
ns
->
Áu…_öje˘
.
∑ª¡
 =Öarent;

46 
Áu…_öj
->
°©us
 = 
NVME_SC_INVALID_OPCODE
;

47 
Áu…_öj
->
d⁄t_ªåy
 = 
åue
;

48 
	`debugfs_¸óã_x16
("°©us", 0600, 
dú
, &
Áu…_öj
->
°©us
);

49 
	`debugfs_¸óã_boﬁ
("d⁄t_ªåy", 0600, 
dú
, &
Áu…_öj
->
d⁄t_ªåy
);

50 
	}
}

52 
	$nvme_Áu…_öje˘_föi
(
nvme_ns
 *
ns
)

55 
	`debugfs_ªmove_ªcursive
(
ns
->
Áu…_öje˘
.
∑ª¡
);

56 
	}
}

58 
	$nvme_should_Áû
(
ªque°
 *
ªq
)

60 
gídisk
 *
disk
 = 
ªq
->
rq_disk
;

61 
nvme_ns
 *
ns
 = 
NULL
;

62 
u16
 
°©us
;

67 i‡(!
disk
)

70 
ns
 = 
disk
->
¥iv©e_d©a
;

71 i‡(
ns
 && 
	`should_Áû
(&ns->
Áu…_öje˘
.
©å
, 1)) {

73 
°©us
 = 
ns
->
Áu…_öje˘
.status;

74 i‡(
ns
->
Áu…_öje˘
.
d⁄t_ªåy
)

75 
°©us
 |
NVME_SC_DNR
;

76 
	`nvme_ªq
(
ªq
)->
°©us
 = status;

78 
	}
}

79 
EXPORT_SYMBOL_GPL
(
nvme_should_Áû
);

	@fc.c

5 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

6 
	~<löux/moduÀ.h
>

7 
	~<löux/∑r£r.h
>

8 
	~<u≠i/scsi/fc/fc_fs.h
>

9 
	~<u≠i/scsi/fc/fc_ñs.h
>

10 
	~<löux/dñay.h
>

11 
	~<löux/ovîÊow.h
>

13 
	~"nvme.h
"

14 
	~"Ábrics.h
"

15 
	~<löux/nvme-fc-drivî.h
>

16 
	~<löux/nvme-fc.h
>

22 
	envme_fc_queue_Êags
 {

23 
	mNVME_FC_Q_CONNECTED
 = 0,

24 
	mNVME_FC_Q_LIVE
,

27 
	#NVME_FC_DEFAULT_DEV_LOSS_TMO
 60

	)

29 
	snvme_fc_queue
 {

30 
nvme_fc_˘æ
 *
	m˘æ
;

31 
devi˚
 *
	mdev
;

32 
blk_mq_hw_˘x
 *
	mh˘x
;

33 *
	mŒdd_h™dÀ
;

34 
size_t
 
	mcmnd_ˇpsuÀ_Àn
;

35 
u32
 
	mqnum
;

36 
u32
 
	mrq˙t
;

37 
u32
 
	m£qno
;

39 
u64
 
	mc⁄√˘i⁄_id
;

40 
©omic_t
 
	mc¢
;

42 
	mÊags
;

43 } 
__Æig√d
((
u64
));

45 
	envme_fc›_Êags
 {

46 
	mFCOP_FLAGS_TERMIO
 = (1 << 0),

47 
	mFCOP_FLAGS_AEN
 = (1 << 1),

50 
	snvmefc_ls_ªq_›
 {

51 
nvmefc_ls_ªq
 
	mls_ªq
;

53 
nvme_fc_Ω‹t
 *
	mΩ‹t
;

54 
nvme_fc_queue
 *
	mqueue
;

55 
ªque°
 *
	mrq
;

56 
u32
 
	mÊags
;

58 
	mls_îr‹
;

59 
com∂ëi⁄
 
	mls_d⁄e
;

60 
li°_hód
 
	ml§eq_li°
;

61 
boﬁ
 
	mªq_queued
;

64 
	envme_f˝›_°©e
 {

65 
	mFCPOP_STATE_UNINIT
 = 0,

66 
	mFCPOP_STATE_IDLE
 = 1,

67 
	mFCPOP_STATE_ACTIVE
 = 2,

68 
	mFCPOP_STATE_ABORTED
 = 3,

69 
	mFCPOP_STATE_COMPLETE
 = 4,

72 
	snvme_fc_f˝_›
 {

73 
nvme_ªque°
 
	mƒeq
;

81 
nvmefc_f˝_ªq
 
	mf˝_ªq
;

83 
nvme_fc_˘æ
 *
	m˘æ
;

84 
nvme_fc_queue
 *
	mqueue
;

85 
ªque°
 *
	mrq
;

87 
©omic_t
 
	m°©e
;

88 
u32
 
	mÊags
;

89 
u32
 
	mrqno
;

90 
u32
 
	m√¡s
;

92 
nvme_fc_cmd_iu
 
	mcmd_iu
;

93 
nvme_fc_î•_iu
 
	mr•_iu
;

96 
	snvme_f˝_›_w_sgl
 {

97 
nvme_fc_f˝_›
 
	m›
;

98 
sˇâîli°
 
	msgl
[
SG_CHUNK_SIZE
];

99 
uöt8_t
 
	m¥iv
[0];

102 
	snvme_fc_Õ‹t
 {

103 
nvme_fc_loˇl_p‹t
 
	mloˇÕ‹t
;

105 
ida
 
	mídp_˙t
;

106 
li°_hód
 
	mp‹t_li°
;

107 
li°_hód
 
	mídp_li°
;

108 
devi˚
 *
	mdev
;

109 
nvme_fc_p‹t_ãm∂©e
 *
	m›s
;

110 
kªf
 
	mªf
;

111 
©omic_t
 
	ma˘_Ω‹t_˙t
;

112 } 
__Æig√d
((
u64
));

114 
	snvme_fc_Ω‹t
 {

115 
nvme_fc_ªmŸe_p‹t
 
	mªmŸï‹t
;

117 
li°_hód
 
	mídp_li°
;

118 
li°_hód
 
	m˘æ_li°
;

119 
li°_hód
 
	mls_ªq_li°
;

120 
li°_hód
 
	mdisc_li°
;

121 
devi˚
 *
	mdev
;

122 
nvme_fc_Õ‹t
 *
	mÕ‹t
;

123 
•ölock_t
 
	mlock
;

124 
kªf
 
	mªf
;

125 
©omic_t
 
	ma˘_˘æ_˙t
;

126 
	mdev_loss_íd
;

127 } 
__Æig√d
((
u64
));

129 
	envme_fc˘æ_Êags
 {

130 
	mFCCTRL_TERMIO
 = (1 << 0),

133 
	snvme_fc_˘æ
 {

134 
•ölock_t
 
	mlock
;

135 
nvme_fc_queue
 *
	mqueues
;

136 
devi˚
 *
	mdev
;

137 
nvme_fc_Õ‹t
 *
	mÕ‹t
;

138 
nvme_fc_Ω‹t
 *
	mΩ‹t
;

139 
u32
 
	m˙um
;

141 
boﬁ
 
	mioq_live
;

142 
boﬁ
 
	massoc_a˘ive
;

143 
©omic_t
 
	mîr_w‹k_a˘ive
;

144 
u64
 
	massocüti⁄_id
;

146 
li°_hód
 
	m˘æ_li°
;

148 
blk_mq_èg_£t
 
	madmö_èg_£t
;

149 
blk_mq_èg_£t
 
	mèg_£t
;

151 
dñayed_w‹k
 
	mc⁄√˘_w‹k
;

152 
w‹k_°ru˘
 
	mîr_w‹k
;

154 
kªf
 
	mªf
;

155 
u32
 
	mÊags
;

156 
u32
 
	mio˙t
;

157 
waô_queue_hód_t
 
	miﬂb‹t_waô
;

159 
nvme_fc_f˝_›
 
	m´n_›s
[
NVME_NR_AEN_COMMANDS
];

161 
nvme_˘æ
 
	m˘æ
;

164 
ölöe
 
nvme_fc_˘æ
 *

165 
	$to_fc_˘æ
(
nvme_˘æ
 *
˘æ
)

167  
	`c⁄èöî_of
(
˘æ
, 
nvme_fc_˘æ
, ctrl);

168 
	}
}

170 
ölöe
 
nvme_fc_Õ‹t
 *

171 
	$loˇÕ‹t_to_Õ‹t
(
nvme_fc_loˇl_p‹t
 *
p‹çå
)

173  
	`c⁄èöî_of
(
p‹çå
, 
nvme_fc_Õ‹t
, 
loˇÕ‹t
);

174 
	}
}

176 
ölöe
 
nvme_fc_Ω‹t
 *

177 
	$ªmŸï‹t_to_Ω‹t
(
nvme_fc_ªmŸe_p‹t
 *
p‹çå
)

179  
	`c⁄èöî_of
(
p‹çå
, 
nvme_fc_Ω‹t
, 
ªmŸï‹t
);

180 
	}
}

182 
ölöe
 
nvmefc_ls_ªq_›
 *

183 
	$ls_ªq_to_ls›
(
nvmefc_ls_ªq
 *
l§eq
)

185  
	`c⁄èöî_of
(
l§eq
, 
nvmefc_ls_ªq_›
, 
ls_ªq
);

186 
	}
}

188 
ölöe
 
nvme_fc_f˝_›
 *

189 
	$f˝_ªq_to_f˝_›
(
nvmefc_f˝_ªq
 *
f˝ªq
)

191  
	`c⁄èöî_of
(
f˝ªq
, 
nvme_fc_f˝_›
, 
f˝_ªq
);

192 
	}
}

199 
DEFINE_SPINLOCK
(
nvme_fc_lock
);

201 
LIST_HEAD
(
nvme_fc_Õ‹t_li°
);

202 
DEFINE_IDA
(
nvme_fc_loˇl_p‹t_˙t
);

203 
DEFINE_IDA
(
nvme_fc_˘æ_˙t
);

211 
devi˚
 *
	gfc_udev_devi˚
;

216 
__nvme_fc_dñëe_hw_queue
(
nvme_fc_˘æ
 *,

217 
nvme_fc_queue
 *, );

220 
	$nvme_fc_‰ì_Õ‹t
(
kªf
 *
ªf
)

222 
nvme_fc_Õ‹t
 *
Õ‹t
 =

223 
	`c⁄èöî_of
(
ªf
, 
nvme_fc_Õ‹t
,Ñef);

224 
Êags
;

226 
	`WARN_ON
(
Õ‹t
->
loˇÕ‹t
.
p‹t_°©e
 !
FC_OBJSTATE_DELETED
);

227 
	`WARN_ON
(!
	`li°_em±y
(&
Õ‹t
->
ídp_li°
));

230 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

231 
	`li°_dñ
(&
Õ‹t
->
p‹t_li°
);

232 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

234 
	`ida_sim∂e_ªmove
(&
nvme_fc_loˇl_p‹t_˙t
, 
Õ‹t
->
loˇÕ‹t
.
p‹t_num
);

235 
	`ida_de°roy
(&
Õ‹t
->
ídp_˙t
);

237 
	`put_devi˚
(
Õ‹t
->
dev
);

239 
	`k‰ì
(
Õ‹t
);

240 
	}
}

243 
	$nvme_fc_Õ‹t_put
(
nvme_fc_Õ‹t
 *
Õ‹t
)

245 
	`kªf_put
(&
Õ‹t
->
ªf
, 
nvme_fc_‰ì_Õ‹t
);

246 
	}
}

249 
	$nvme_fc_Õ‹t_gë
(
nvme_fc_Õ‹t
 *
Õ‹t
)

251  
	`kªf_gë_u∆ess_zîo
(&
Õ‹t
->
ªf
);

252 
	}
}

255 
nvme_fc_Õ‹t
 *

256 
	$nvme_fc_©èch_to_uƒeg_Õ‹t
(
nvme_fc_p‹t_öfo
 *
pöfo
,

257 
nvme_fc_p‹t_ãm∂©e
 *
›s
,

258 
devi˚
 *
dev
)

260 
nvme_fc_Õ‹t
 *
Õ‹t
;

261 
Êags
;

263 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

265 
	`li°_f‹_óch_íåy
(
Õ‹t
, &
nvme_fc_Õ‹t_li°
, 
p‹t_li°
) {

266 i‡(
Õ‹t
->
loˇÕ‹t
.
node_«me
 !
pöfo
->node_name ||

267 
Õ‹t
->
loˇÕ‹t
.
p‹t_«me
 !
pöfo
->port_name)

270 i‡(
Õ‹t
->
dev
 != dev) {

271 
Õ‹t
 = 
	`ERR_PTR
(-
EXDEV
);

272 
out_d⁄e
;

275 i‡(
Õ‹t
->
loˇÕ‹t
.
p‹t_°©e
 !
FC_OBJSTATE_DELETED
) {

276 
Õ‹t
 = 
	`ERR_PTR
(-
EEXIST
);

277 
out_d⁄e
;

280 i‡(!
	`nvme_fc_Õ‹t_gë
(
Õ‹t
)) {

285 
Õ‹t
 = 
NULL
;

286 
out_d⁄e
;

291 
Õ‹t
->
›s
 = ops;

292 
Õ‹t
->
loˇÕ‹t
.
p‹t_rﬁe
 = 
pöfo
->port_role;

293 
Õ‹t
->
loˇÕ‹t
.
p‹t_id
 = 
pöfo
->port_id;

294 
Õ‹t
->
loˇÕ‹t
.
p‹t_°©e
 = 
FC_OBJSTATE_ONLINE
;

296 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

298  
Õ‹t
;

301 
Õ‹t
 = 
NULL
;

303 
out_d⁄e
:

304 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

306  
Õ‹t
;

307 
	}
}

327 
	$nvme_fc_ªgi°î_loˇÕ‹t
(
nvme_fc_p‹t_öfo
 *
pöfo
,

328 
nvme_fc_p‹t_ãm∂©e
 *
ãm∂©e
,

329 
devi˚
 *
dev
,

330 
nvme_fc_loˇl_p‹t
 **
p‹çå
)

332 
nvme_fc_Õ‹t
 *
√wªc
;

333 
Êags
;

334 
ªt
, 
idx
;

336 i‡(!
ãm∂©e
->
loˇÕ‹t_dñëe
 || !ãm∂©e->
ªmŸï‹t_dñëe
 ||

337 !
ãm∂©e
->
ls_ªq
 || !ãm∂©e->
f˝_io
 ||

338 !
ãm∂©e
->
ls_ab‹t
 || !ãm∂©e->
f˝_ab‹t
 ||

339 !
ãm∂©e
->
max_hw_queues
 || !ãm∂©e->
max_sgl_£gmíts
 ||

340 !
ãm∂©e
->
max_dif_sgl_£gmíts
 || !ãm∂©e->
dma_bound¨y
) {

341 
ªt
 = -
EINVAL
;

342 
out_ªgho°_Áûed
;

352 
√wªc
 = 
	`nvme_fc_©èch_to_uƒeg_Õ‹t
(
pöfo
, 
ãm∂©e
, 
dev
);

355 i‡(
	`IS_ERR
(
√wªc
)) {

356 
ªt
 = 
	`PTR_ERR
(
√wªc
);

357 
out_ªgho°_Áûed
;

360 } i‡(
√wªc
) {

361 *
p‹çå
 = &
√wªc
->
loˇÕ‹t
;

367 
√wªc
 = 
	`kmÆloc
(((*√wªcË+ 
ãm∂©e
->
loˇl_¥iv_sz
),

368 
GFP_KERNEL
);

369 i‡(!
√wªc
) {

370 
ªt
 = -
ENOMEM
;

371 
out_ªgho°_Áûed
;

374 
idx
 = 
	`ida_sim∂e_gë
(&
nvme_fc_loˇl_p‹t_˙t
, 0, 0, 
GFP_KERNEL
);

375 i‡(
idx
 < 0) {

376 
ªt
 = -
ENOSPC
;

377 
out_Áû_k‰ì
;

380 i‡(!
	`gë_devi˚
(
dev
) && dev) {

381 
ªt
 = -
ENODEV
;

382 
out_ida_put
;

385 
	`INIT_LIST_HEAD
(&
√wªc
->
p‹t_li°
);

386 
	`INIT_LIST_HEAD
(&
√wªc
->
ídp_li°
);

387 
	`kªf_öô
(&
√wªc
->
ªf
);

388 
	`©omic_£t
(&
√wªc
->
a˘_Ω‹t_˙t
, 0);

389 
√wªc
->
›s
 = 
ãm∂©e
;

390 
√wªc
->
dev
 = dev;

391 
	`ida_öô
(&
√wªc
->
ídp_˙t
);

392 
√wªc
->
loˇÕ‹t
.
¥iv©e
 = &newrec[1];

393 
√wªc
->
loˇÕ‹t
.
node_«me
 = 
pöfo
->node_name;

394 
√wªc
->
loˇÕ‹t
.
p‹t_«me
 = 
pöfo
->port_name;

395 
√wªc
->
loˇÕ‹t
.
p‹t_rﬁe
 = 
pöfo
->port_role;

396 
√wªc
->
loˇÕ‹t
.
p‹t_id
 = 
pöfo
->port_id;

397 
√wªc
->
loˇÕ‹t
.
p‹t_°©e
 = 
FC_OBJSTATE_ONLINE
;

398 
√wªc
->
loˇÕ‹t
.
p‹t_num
 = 
idx
;

400 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

401 
	`li°_add_èû
(&
√wªc
->
p‹t_li°
, &
nvme_fc_Õ‹t_li°
);

402 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

404 i‡(
dev
)

405 
	`dma_£t_£g_bound¨y
(
dev
, 
ãm∂©e
->
dma_bound¨y
);

407 *
p‹çå
 = &
√wªc
->
loˇÕ‹t
;

410 
out_ida_put
:

411 
	`ida_sim∂e_ªmove
(&
nvme_fc_loˇl_p‹t_˙t
, 
idx
);

412 
out_Áû_k‰ì
:

413 
	`k‰ì
(
√wªc
);

414 
out_ªgho°_Áûed
:

415 *
p‹çå
 = 
NULL
;

417  
ªt
;

418 
	}
}

419 
EXPORT_SYMBOL_GPL
(
nvme_fc_ªgi°î_loˇÕ‹t
);

432 
	$nvme_fc_uƒegi°î_loˇÕ‹t
(
nvme_fc_loˇl_p‹t
 *
p‹çå
)

434 
nvme_fc_Õ‹t
 *
Õ‹t
 = 
	`loˇÕ‹t_to_Õ‹t
(
p‹çå
);

435 
Êags
;

437 i‡(!
p‹çå
)

438  -
EINVAL
;

440 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

442 i‡(
p‹çå
->
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
) {

443 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

444  -
EINVAL
;

446 
p‹çå
->
p‹t_°©e
 = 
FC_OBJSTATE_DELETED
;

448 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

450 i‡(
	`©omic_ªad
(&
Õ‹t
->
a˘_Ω‹t_˙t
) == 0)

451 
Õ‹t
->
›s
->
	`loˇÕ‹t_dñëe
(&Õ‹t->
loˇÕ‹t
);

453 
	`nvme_fc_Õ‹t_put
(
Õ‹t
);

456 
	}
}

457 
EXPORT_SYMBOL_GPL
(
nvme_fc_uƒegi°î_loˇÕ‹t
);

467 
	#FCNVME_TRADDR_LENGTH
 64

	)

470 
	$nvme_fc_sig«l_discovîy_sˇn
(
nvme_fc_Õ‹t
 *
Õ‹t
,

471 
nvme_fc_Ω‹t
 *
Ω‹t
)

473 
ho°addr
[
FCNVME_TRADDR_LENGTH
];

474 
tgèddr
[
FCNVME_TRADDR_LENGTH
];

475 *
ívp
[4] = { "FC_EVENTÚvmediscovîy", 
ho°addr
, 
tgèddr
, 
NULL
 };

477 i‡(!(
Ω‹t
->
ªmŸï‹t
.
p‹t_rﬁe
 & 
FC_PORT_ROLE_NVME_DISCOVERY
))

480 
	`¢¥ötf
(
ho°addr
, (hostaddr),

482 
Õ‹t
->
loˇÕ‹t
.
node_«me
,Üp‹t->loˇÕ‹t.
p‹t_«me
);

483 
	`¢¥ötf
(
tgèddr
, (tgtaddr),

485 
Ω‹t
->
ªmŸï‹t
.
node_«me
,Ñp‹t->ªmŸï‹t.
p‹t_«me
);

486 
	`kobje˘_uevít_ív
(&
fc_udev_devi˚
->
kobj
, 
KOBJ_CHANGE
, 
ívp
);

487 
	}
}

490 
	$nvme_fc_‰ì_Ω‹t
(
kªf
 *
ªf
)

492 
nvme_fc_Ω‹t
 *
Ω‹t
 =

493 
	`c⁄èöî_of
(
ªf
, 
nvme_fc_Ω‹t
,Ñef);

494 
nvme_fc_Õ‹t
 *
Õ‹t
 =

495 
	`loˇÕ‹t_to_Õ‹t
(
Ω‹t
->
ªmŸï‹t
.
loˇÕ‹t
);

496 
Êags
;

498 
	`WARN_ON
(
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 !
FC_OBJSTATE_DELETED
);

499 
	`WARN_ON
(!
	`li°_em±y
(&
Ω‹t
->
˘æ_li°
));

502 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

503 
	`li°_dñ
(&
Ω‹t
->
ídp_li°
);

504 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

506 
	`WARN_ON
(!
	`li°_em±y
(&
Ω‹t
->
disc_li°
));

507 
	`ida_sim∂e_ªmove
(&
Õ‹t
->
ídp_˙t
, 
Ω‹t
->
ªmŸï‹t
.
p‹t_num
);

509 
	`k‰ì
(
Ω‹t
);

511 
	`nvme_fc_Õ‹t_put
(
Õ‹t
);

512 
	}
}

515 
	$nvme_fc_Ω‹t_put
(
nvme_fc_Ω‹t
 *
Ω‹t
)

517 
	`kªf_put
(&
Ω‹t
->
ªf
, 
nvme_fc_‰ì_Ω‹t
);

518 
	}
}

521 
	$nvme_fc_Ω‹t_gë
(
nvme_fc_Ω‹t
 *
Ω‹t
)

523  
	`kªf_gë_u∆ess_zîo
(&
Ω‹t
->
ªf
);

524 
	}
}

527 
	$nvme_fc_ªsume_c⁄åﬁÀr
(
nvme_fc_˘æ
 *
˘æ
)

529 
˘æ
->˘æ.
°©e
) {

530 
NVME_CTRL_NEW
:

531 
NVME_CTRL_CONNECTING
:

536 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

538 "Aâem±ögÑec⁄√˘\n", 
˘æ
->
˙um
);

540 
	`queue_dñayed_w‹k
(
nvme_wq
, &
˘æ
->
c⁄√˘_w‹k
, 0);

543 
NVME_CTRL_RESETTING
:

555 
	}
}

557 
nvme_fc_Ω‹t
 *

558 
	$nvme_fc_©èch_to_su•íded_Ω‹t
(
nvme_fc_Õ‹t
 *
Õ‹t
,

559 
nvme_fc_p‹t_öfo
 *
pöfo
)

561 
nvme_fc_Ω‹t
 *
Ω‹t
;

562 
nvme_fc_˘æ
 *
˘æ
;

563 
Êags
;

565 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

567 
	`li°_f‹_óch_íåy
(
Ω‹t
, &
Õ‹t
->
ídp_li°
,Éndp_list) {

568 i‡(
Ω‹t
->
ªmŸï‹t
.
node_«me
 !
pöfo
->node_name ||

569 
Ω‹t
->
ªmŸï‹t
.
p‹t_«me
 !
pöfo
->port_name)

572 i‡(!
	`nvme_fc_Ω‹t_gë
(
Ω‹t
)) {

573 
Ω‹t
 = 
	`ERR_PTR
(-
ENOLCK
);

574 
out_d⁄e
;

577 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

579 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

582 i‡(
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 !
FC_OBJSTATE_DELETED
) {

584 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

585 
	`nvme_fc_Ω‹t_put
(
Ω‹t
);

586  
	`ERR_PTR
(-
ESTALE
);

589 
Ω‹t
->
ªmŸï‹t
.
p‹t_rﬁe
 = 
pöfo
->port_role;

590 
Ω‹t
->
ªmŸï‹t
.
p‹t_id
 = 
pöfo
->port_id;

591 
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 = 
FC_OBJSTATE_ONLINE
;

592 
Ω‹t
->
dev_loss_íd
 = 0;

598 
	`li°_f‹_óch_íåy
(
˘æ
, &
Ω‹t
->
˘æ_li°
, ctrl_list)

599 
	`nvme_fc_ªsume_c⁄åﬁÀr
(
˘æ
);

601 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

603  
Ω‹t
;

606 
Ω‹t
 = 
NULL
;

608 
out_d⁄e
:

609 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

611  
Ω‹t
;

612 
	}
}

614 
ölöe
 

615 
	$__nvme_fc_£t_dev_loss_tmo
(
nvme_fc_Ω‹t
 *
Ω‹t
,

616 
nvme_fc_p‹t_öfo
 *
pöfo
)

618 i‡(
pöfo
->
dev_loss_tmo
)

619 
Ω‹t
->
ªmŸï‹t
.
dev_loss_tmo
 = 
pöfo
->dev_loss_tmo;

621 
Ω‹t
->
ªmŸï‹t
.
dev_loss_tmo
 = 
NVME_FC_DEFAULT_DEV_LOSS_TMO
;

622 
	}
}

641 
	$nvme_fc_ªgi°î_ªmŸï‹t
(
nvme_fc_loˇl_p‹t
 *
loˇÕ‹t
,

642 
nvme_fc_p‹t_öfo
 *
pöfo
,

643 
nvme_fc_ªmŸe_p‹t
 **
p‹çå
)

645 
nvme_fc_Õ‹t
 *
Õ‹t
 = 
	`loˇÕ‹t_to_Õ‹t
(
loˇÕ‹t
);

646 
nvme_fc_Ω‹t
 *
√wªc
;

647 
Êags
;

648 
ªt
, 
idx
;

650 i‡(!
	`nvme_fc_Õ‹t_gë
(
Õ‹t
)) {

651 
ªt
 = -
ESHUTDOWN
;

652 
out_ªgho°_Áûed
;

660 
√wªc
 = 
	`nvme_fc_©èch_to_su•íded_Ω‹t
(
Õ‹t
, 
pöfo
);

663 i‡(
	`IS_ERR
(
√wªc
)) {

664 
ªt
 = 
	`PTR_ERR
(
√wªc
);

665 
out_Õ‹t_put
;

668 } i‡(
√wªc
) {

669 
	`nvme_fc_Õ‹t_put
(
Õ‹t
);

670 
	`__nvme_fc_£t_dev_loss_tmo
(
√wªc
, 
pöfo
);

671 
	`nvme_fc_sig«l_discovîy_sˇn
(
Õ‹t
, 
√wªc
);

672 *
p‹çå
 = &
√wªc
->
ªmŸï‹t
;

678 
√wªc
 = 
	`kmÆloc
(((*√wªcË+ 
Õ‹t
->
›s
->
ªmŸe_¥iv_sz
),

679 
GFP_KERNEL
);

680 i‡(!
√wªc
) {

681 
ªt
 = -
ENOMEM
;

682 
out_Õ‹t_put
;

685 
idx
 = 
	`ida_sim∂e_gë
(&
Õ‹t
->
ídp_˙t
, 0, 0, 
GFP_KERNEL
);

686 i‡(
idx
 < 0) {

687 
ªt
 = -
ENOSPC
;

688 
out_k‰ì_Ω‹t
;

691 
	`INIT_LIST_HEAD
(&
√wªc
->
ídp_li°
);

692 
	`INIT_LIST_HEAD
(&
√wªc
->
˘æ_li°
);

693 
	`INIT_LIST_HEAD
(&
√wªc
->
ls_ªq_li°
);

694 
	`INIT_LIST_HEAD
(&
√wªc
->
disc_li°
);

695 
	`kªf_öô
(&
√wªc
->
ªf
);

696 
	`©omic_£t
(&
√wªc
->
a˘_˘æ_˙t
, 0);

697 
	`•ö_lock_öô
(&
√wªc
->
lock
);

698 
√wªc
->
ªmŸï‹t
.
loˇÕ‹t
 = &
Õ‹t
->localport;

699 
√wªc
->
dev
 = 
Õ‹t
->dev;

700 
√wªc
->
Õ‹t
 =Üport;

701 
√wªc
->
ªmŸï‹t
.
¥iv©e
 = &newrec[1];

702 
√wªc
->
ªmŸï‹t
.
p‹t_rﬁe
 = 
pöfo
->port_role;

703 
√wªc
->
ªmŸï‹t
.
node_«me
 = 
pöfo
->node_name;

704 
√wªc
->
ªmŸï‹t
.
p‹t_«me
 = 
pöfo
->port_name;

705 
√wªc
->
ªmŸï‹t
.
p‹t_id
 = 
pöfo
->port_id;

706 
√wªc
->
ªmŸï‹t
.
p‹t_°©e
 = 
FC_OBJSTATE_ONLINE
;

707 
√wªc
->
ªmŸï‹t
.
p‹t_num
 = 
idx
;

708 
	`__nvme_fc_£t_dev_loss_tmo
(
√wªc
, 
pöfo
);

710 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

711 
	`li°_add_èû
(&
√wªc
->
ídp_li°
, &
Õ‹t
->endp_list);

712 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

714 
	`nvme_fc_sig«l_discovîy_sˇn
(
Õ‹t
, 
√wªc
);

716 *
p‹çå
 = &
√wªc
->
ªmŸï‹t
;

719 
out_k‰ì_Ω‹t
:

720 
	`k‰ì
(
√wªc
);

721 
out_Õ‹t_put
:

722 
	`nvme_fc_Õ‹t_put
(
Õ‹t
);

723 
out_ªgho°_Áûed
:

724 *
p‹çå
 = 
NULL
;

725  
ªt
;

726 
	}
}

727 
EXPORT_SYMBOL_GPL
(
nvme_fc_ªgi°î_ªmŸï‹t
);

730 
	$nvme_fc_ab‹t_ls›s
(
nvme_fc_Ω‹t
 *
Ω‹t
)

732 
nvmefc_ls_ªq_›
 *
ls›
;

733 
Êags
;

735 
ª°¨t
:

736 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

738 
	`li°_f‹_óch_íåy
(
ls›
, &
Ω‹t
->
ls_ªq_li°
, 
l§eq_li°
) {

739 i‡(!(
ls›
->
Êags
 & 
FCOP_FLAGS_TERMIO
)) {

740 
ls›
->
Êags
 |
FCOP_FLAGS_TERMIO
;

741 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

742 
Ω‹t
->
Õ‹t
->
›s
->
	`ls_ab‹t
(&Ω‹t->Õ‹t->
loˇÕ‹t
,

743 &
Ω‹t
->
ªmŸï‹t
,

744 &
ls›
->
ls_ªq
);

745 
ª°¨t
;

748 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

751 
	}
}

754 
	$nvme_fc_˘æ_c⁄√˘ivôy_loss
(
nvme_fc_˘æ
 *
˘æ
)

756 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

758 "Rec⁄√˘", 
˘æ
->
˙um
);

760 
˘æ
->˘æ.
°©e
) {

761 
NVME_CTRL_NEW
:

762 
NVME_CTRL_LIVE
:

770 i‡(
	`nvme_ª£t_˘æ
(&
˘æ
->ctrl)) {

771 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

773 
˘æ
->
˙um
);

774 
	`nvme_dñëe_˘æ
(&
˘æ
->ctrl);

778 
NVME_CTRL_CONNECTING
:

788 
NVME_CTRL_RESETTING
:

797 
NVME_CTRL_DELETING
:

802 
	}
}

816 
	$nvme_fc_uƒegi°î_ªmŸï‹t
(
nvme_fc_ªmŸe_p‹t
 *
p‹çå
)

818 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
	`ªmŸï‹t_to_Ω‹t
(
p‹çå
);

819 
nvme_fc_˘æ
 *
˘æ
;

820 
Êags
;

822 i‡(!
p‹çå
)

823  -
EINVAL
;

825 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

827 i‡(
p‹çå
->
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
) {

828 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

829  -
EINVAL
;

831 
p‹çå
->
p‹t_°©e
 = 
FC_OBJSTATE_DELETED
;

833 
Ω‹t
->
dev_loss_íd
 = 
jiffõs
 + (
p‹çå
->
dev_loss_tmo
 * 
HZ
);

835 
	`li°_f‹_óch_íåy
(
˘æ
, &
Ω‹t
->
˘æ_li°
, ctrl_list) {

837 i‡(!
p‹çå
->
dev_loss_tmo
) {

838 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

840 
˘æ
->
˙um
);

841 
	`nvme_dñëe_˘æ
(&
˘æ
->ctrl);

843 
	`nvme_fc_˘æ_c⁄√˘ivôy_loss
(
˘æ
);

846 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

848 
	`nvme_fc_ab‹t_ls›s
(
Ω‹t
);

850 i‡(
	`©omic_ªad
(&
Ω‹t
->
a˘_˘æ_˙t
) == 0)

851 
Ω‹t
->
Õ‹t
->
›s
->
	`ªmŸï‹t_dñëe
(
p‹çå
);

858 
	`nvme_fc_Ω‹t_put
(
Ω‹t
);

861 
	}
}

862 
EXPORT_SYMBOL_GPL
(
nvme_fc_uƒegi°î_ªmŸï‹t
);

873 
	$nvme_fc_ªsˇn_ªmŸï‹t
(
nvme_fc_ªmŸe_p‹t
 *
ªmŸï‹t
)

875 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
	`ªmŸï‹t_to_Ω‹t
(
ªmŸï‹t
);

877 
	`nvme_fc_sig«l_discovîy_sˇn
(
Ω‹t
->
Õ‹t
,Ñport);

878 
	}
}

879 
EXPORT_SYMBOL_GPL
(
nvme_fc_ªsˇn_ªmŸï‹t
);

882 
	$nvme_fc_£t_ªmŸï‹t_devloss
(
nvme_fc_ªmŸe_p‹t
 *
p‹çå
,

883 
u32
 
dev_loss_tmo
)

885 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
	`ªmŸï‹t_to_Ω‹t
(
p‹çå
);

886 
Êags
;

888 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

890 i‡(
p‹çå
->
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
) {

891 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

892  -
EINVAL
;

896 
Ω‹t
->
ªmŸï‹t
.
dev_loss_tmo
 = dev_loss_tmo;

898 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

901 
	}
}

902 
EXPORT_SYMBOL_GPL
(
nvme_fc_£t_ªmŸï‹t_devloss
);

923 
ölöe
 
dma_addr_t


924 
	$fc_dma_m≠_sögÀ
(
devi˚
 *
dev
, *
±r
, 
size_t
 
size
,

925 
dma_d©a_dúe˘i⁄
 
dú
)

927  
dev
 ? 
	`dma_m≠_sögÀ
(dev, 
±r
, 
size
, 
dú
Ë: (
dma_addr_t
)0L;

928 
	}
}

930 
ölöe
 

931 
	$fc_dma_m≠pög_îr‹
(
devi˚
 *
dev
, 
dma_addr_t
 
dma_addr
)

933  
dev
 ? 
	`dma_m≠pög_îr‹
(dev, 
dma_addr
) : 0;

934 
	}
}

936 
ölöe
 

937 
	$fc_dma_unm≠_sögÀ
(
devi˚
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

938 
dma_d©a_dúe˘i⁄
 
dú
)

940 i‡(
dev
)

941 
	`dma_unm≠_sögÀ
(
dev
, 
addr
, 
size
, 
dú
);

942 
	}
}

944 
ölöe
 

945 
	$fc_dma_sync_sögÀ_f‹_˝u
(
devi˚
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

946 
dma_d©a_dúe˘i⁄
 
dú
)

948 i‡(
dev
)

949 
	`dma_sync_sögÀ_f‹_˝u
(
dev
, 
addr
, 
size
, 
dú
);

950 
	}
}

952 
ölöe
 

953 
	$fc_dma_sync_sögÀ_f‹_devi˚
(
devi˚
 *
dev
, 
dma_addr_t
 
addr
, 
size_t
 
size
,

954 
dma_d©a_dúe˘i⁄
 
dú
)

956 i‡(
dev
)

957 
	`dma_sync_sögÀ_f‹_devi˚
(
dev
, 
addr
, 
size
, 
dú
);

958 
	}
}

962 
	$fc_m≠_sg
(
sˇâîli°
 *
sg
, 
√¡s
)

964 
sˇâîli°
 *
s
;

965 
i
;

967 
	`WARN_ON
(
√¡s
 =0 || 
sg
[0].
Àngth
 == 0);

969 
	`f‹_óch_sg
(
sg
, 
s
, 
√¡s
, 
i
) {

970 
s
->
dma_addªss
 = 0L;

971 #ifde‡
CONFIG_NEED_SG_DMA_LENGTH


972 
s
->
dma_Àngth
 = s->
Àngth
;

975  
√¡s
;

976 
	}
}

978 
ölöe
 

979 
	$fc_dma_m≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

980 
dma_d©a_dúe˘i⁄
 
dú
)

982  
dev
 ? 
	`dma_m≠_sg
(dev, 
sg
, 
√¡s
, 
dú
Ë: 
	`fc_m≠_sg
(sg,Çents);

983 
	}
}

985 
ölöe
 

986 
	$fc_dma_unm≠_sg
(
devi˚
 *
dev
, 
sˇâîli°
 *
sg
, 
√¡s
,

987 
dma_d©a_dúe˘i⁄
 
dú
)

989 i‡(
dev
)

990 
	`dma_unm≠_sg
(
dev
, 
sg
, 
√¡s
, 
dú
);

991 
	}
}

995 
nvme_fc_˘æ_put
(
nvme_fc_˘æ
 *);

996 
nvme_fc_˘æ_gë
(
nvme_fc_˘æ
 *);

1000 
	$__nvme_fc_föish_ls_ªq
(
nvmefc_ls_ªq_›
 *
ls›
)

1002 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
ls›
->rport;

1003 
nvmefc_ls_ªq
 *
l§eq
 = &
ls›
->
ls_ªq
;

1004 
Êags
;

1006 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

1008 i‡(!
ls›
->
ªq_queued
) {

1009 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

1013 
	`li°_dñ
(&
ls›
->
l§eq_li°
);

1015 
ls›
->
ªq_queued
 = 
Ál£
;

1017 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

1019 
	`fc_dma_unm≠_sögÀ
(
Ω‹t
->
dev
, 
l§eq
->
rq°dma
,

1020 (
l§eq
->
rq°Àn
 +Ü§eq->
r•Àn
),

1021 
DMA_BIDIRECTIONAL
);

1023 
	`nvme_fc_Ω‹t_put
(
Ω‹t
);

1024 
	}
}

1027 
	$__nvme_fc_£nd_ls_ªq
(
nvme_fc_Ω‹t
 *
Ω‹t
,

1028 
nvmefc_ls_ªq_›
 *
ls›
,

1029 (*
d⁄e
)(
nvmefc_ls_ªq
 *
ªq
, 
°©us
))

1031 
nvmefc_ls_ªq
 *
l§eq
 = &
ls›
->
ls_ªq
;

1032 
Êags
;

1033 
ªt
 = 0;

1035 i‡(
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
)

1036  -
ECONNREFUSED
;

1038 i‡(!
	`nvme_fc_Ω‹t_gë
(
Ω‹t
))

1039  -
ESHUTDOWN
;

1041 
l§eq
->
d⁄e
 = done;

1042 
ls›
->
Ω‹t
 =Ñport;

1043 
ls›
->
ªq_queued
 = 
Ál£
;

1044 
	`INIT_LIST_HEAD
(&
ls›
->
l§eq_li°
);

1045 
	`öô_com∂ëi⁄
(&
ls›
->
ls_d⁄e
);

1047 
l§eq
->
rq°dma
 = 
	`fc_dma_m≠_sögÀ
(
Ω‹t
->
dev
,Ü§eq->
rq°addr
,

1048 
l§eq
->
rq°Àn
 +Ü§eq->
r•Àn
,

1049 
DMA_BIDIRECTIONAL
);

1050 i‡(
	`fc_dma_m≠pög_îr‹
(
Ω‹t
->
dev
, 
l§eq
->
rq°dma
)) {

1051 
ªt
 = -
EFAULT
;

1052 
out_puåp‹t
;

1054 
l§eq
->
r•dma
 =Ü§eq->
rq°dma
 +Ü§eq->
rq°Àn
;

1056 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

1058 
	`li°_add_èû
(&
ls›
->
l§eq_li°
, &
Ω‹t
->
ls_ªq_li°
);

1060 
ls›
->
ªq_queued
 = 
åue
;

1062 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

1064 
ªt
 = 
Ω‹t
->
Õ‹t
->
›s
->
	`ls_ªq
(&Ω‹t->Õ‹t->
loˇÕ‹t
,

1065 &
Ω‹t
->
ªmŸï‹t
, 
l§eq
);

1066 i‡(
ªt
)

1067 
out_u∆ök
;

1071 
out_u∆ök
:

1072 
ls›
->
ls_îr‹
 = 
ªt
;

1073 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

1074 
ls›
->
ªq_queued
 = 
Ál£
;

1075 
	`li°_dñ
(&
ls›
->
l§eq_li°
);

1076 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

1077 
	`fc_dma_unm≠_sögÀ
(
Ω‹t
->
dev
, 
l§eq
->
rq°dma
,

1078 (
l§eq
->
rq°Àn
 +Ü§eq->
r•Àn
),

1079 
DMA_BIDIRECTIONAL
);

1080 
out_puåp‹t
:

1081 
	`nvme_fc_Ω‹t_put
(
Ω‹t
);

1083  
ªt
;

1084 
	}
}

1087 
	$nvme_fc_£nd_ls_ªq_d⁄e
(
nvmefc_ls_ªq
 *
l§eq
, 
°©us
)

1089 
nvmefc_ls_ªq_›
 *
ls›
 = 
	`ls_ªq_to_ls›
(
l§eq
);

1091 
ls›
->
ls_îr‹
 = 
°©us
;

1092 
	`com∂ëe
(&
ls›
->
ls_d⁄e
);

1093 
	}
}

1096 
	$nvme_fc_£nd_ls_ªq
(
nvme_fc_Ω‹t
 *
Ω‹t
, 
nvmefc_ls_ªq_›
 *
ls›
)

1098 
nvmefc_ls_ªq
 *
l§eq
 = &
ls›
->
ls_ªq
;

1099 
f˙vme_ls_rjt
 *
rjt
 = 
l§eq
->
r•addr
;

1100 
ªt
;

1102 
ªt
 = 
	`__nvme_fc_£nd_ls_ªq
(
Ω‹t
, 
ls›
, 
nvme_fc_£nd_ls_ªq_d⁄e
);

1104 i‡(!
ªt
) {

1111 
	`waô_f‹_com∂ëi⁄
(&
ls›
->
ls_d⁄e
);

1113 
	`__nvme_fc_föish_ls_ªq
(
ls›
);

1115 
ªt
 = 
ls›
->
ls_îr‹
;

1118 i‡(
ªt
)

1119  
ªt
;

1122 i‡(
rjt
->
w0
.
ls_cmd
 =
FCNVME_LS_RJT
)

1123  -
ENXIO
;

1126 
	}
}

1129 
	$nvme_fc_£nd_ls_ªq_async
(
nvme_fc_Ω‹t
 *
Ω‹t
,

1130 
nvmefc_ls_ªq_›
 *
ls›
,

1131 (*
d⁄e
)(
nvmefc_ls_ªq
 *
ªq
, 
°©us
))

1135  
	`__nvme_fc_£nd_ls_ªq
(
Ω‹t
, 
ls›
, 
d⁄e
);

1136 
	}
}

1140 
	mVERR_NO_ERROR
 = 0,

1141 
	mVERR_LSACC
 = 1,

1142 
	mVERR_LSDESC_RQST
 = 2,

1143 
	mVERR_LSDESC_RQST_LEN
 = 3,

1144 
	mVERR_ASSOC_ID
 = 4,

1145 
	mVERR_ASSOC_ID_LEN
 = 5,

1146 
	mVERR_CONN_ID
 = 6,

1147 
	mVERR_CONN_ID_LEN
 = 7,

1148 
	mVERR_CR_ASSOC
 = 8,

1149 
	mVERR_CR_ASSOC_ACC_LEN
 = 9,

1150 
	mVERR_CR_CONN
 = 10,

1151 
	mVERR_CR_CONN_ACC_LEN
 = 11,

1152 
	mVERR_DISCONN
 = 12,

1153 
	mVERR_DISCONN_ACC_LEN
 = 13,

1156 *
	gvÆid©i⁄_îr‹s
[] = {

1174 
	$nvme_fc_c⁄√˘_admö_queue
(
nvme_fc_˘æ
 *
˘æ
,

1175 
nvme_fc_queue
 *
queue
, 
u16
 
qsize
, u16 
î•_øtio
)

1177 
nvmefc_ls_ªq_›
 *
ls›
;

1178 
nvmefc_ls_ªq
 *
l§eq
;

1179 
f˙vme_ls_¸_assoc_rq°
 *
assoc_rq°
;

1180 
f˙vme_ls_¸_assoc_acc
 *
assoc_acc
;

1181 
ªt
, 
f¸ë
 = 0;

1183 
ls›
 = 
	`kzÆloc
(((*lsop) +

1184 
˘æ
->
Õ‹t
->
›s
->
l§q°_¥iv_sz
 +

1185 (*
assoc_rq°
Ë+ (*
assoc_acc
)), 
GFP_KERNEL
);

1186 i‡(!
ls›
) {

1187 
ªt
 = -
ENOMEM
;

1188 
out_no_mem‹y
;

1190 
l§eq
 = &
ls›
->
ls_ªq
;

1192 
l§eq
->
¥iv©e
 = (*)&
ls›
[1];

1193 
assoc_rq°
 = (
f˙vme_ls_¸_assoc_rq°
 *)

1194 (
l§eq
->
¥iv©e
 + 
˘æ
->
Õ‹t
->
›s
->
l§q°_¥iv_sz
);

1195 
assoc_acc
 = (
f˙vme_ls_¸_assoc_acc
 *)&
assoc_rq°
[1];

1197 
assoc_rq°
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_ASSOCIATION
;

1198 
assoc_rq°
->
desc_li°_Àn
 =

1199 
	`˝u_to_be32
((
f˙vme_lsdesc_¸_assoc_cmd
));

1201 
assoc_rq°
->
assoc_cmd
.
desc_èg
 =

1202 
	`˝u_to_be32
(
FCNVME_LSDESC_CREATE_ASSOC_CMD
);

1203 
assoc_rq°
->
assoc_cmd
.
desc_Àn
 =

1204 
	`f˙vme_lsdesc_Àn
(

1205 (
f˙vme_lsdesc_¸_assoc_cmd
));

1207 
assoc_rq°
->
assoc_cmd
.
î•_øtio
 = 
	`˝u_to_be16
(ersp_ratio);

1208 
assoc_rq°
->
assoc_cmd
.
sqsize
 = 
	`˝u_to_be16
(
qsize
 - 1);

1210 
assoc_rq°
->
assoc_cmd
.
˙éid
 = 
	`˝u_to_be16
(0xffff);

1211 
	`uuid_c›y
(&
assoc_rq°
->
assoc_cmd
.
ho°id
, &
˘æ
->˘æ.
›ts
->
ho°
->
id
);

1212 
	`°∫˝y
(
assoc_rq°
->
assoc_cmd
.
ho°nqn
, 
˘æ
->˘æ.
›ts
->
ho°
->
nqn
,

1213 
	`mö
(
FCNVME_ASSOC_HOSTNQN_LEN
, 
NVMF_NQN_SIZE
));

1214 
	`°∫˝y
(
assoc_rq°
->
assoc_cmd
.
subnqn
, 
˘æ
->˘æ.
›ts
->
subsy¢qn
,

1215 
	`mö
(
FCNVME_ASSOC_SUBNQN_LEN
, 
NVMF_NQN_SIZE
));

1217 
ls›
->
queue
 = queue;

1218 
l§eq
->
rq°addr
 = 
assoc_rq°
;

1219 
l§eq
->
rq°Àn
 = (*
assoc_rq°
);

1220 
l§eq
->
r•addr
 = 
assoc_acc
;

1221 
l§eq
->
r•Àn
 = (*
assoc_acc
);

1222 
l§eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1224 
ªt
 = 
	`nvme_fc_£nd_ls_ªq
(
˘æ
->
Ω‹t
, 
ls›
);

1225 i‡(
ªt
)

1226 
out_‰ì_buf„r
;

1231 i‡(
assoc_acc
->
hdr
.
w0
.
ls_cmd
 !
FCNVME_LS_ACC
)

1232 
f¸ë
 = 
VERR_LSACC
;

1233 i‡(
assoc_acc
->
hdr
.
desc_li°_Àn
 !=

1234 
	`f˙vme_lsdesc_Àn
(

1235 (
f˙vme_ls_¸_assoc_acc
)))

1236 
f¸ë
 = 
VERR_CR_ASSOC_ACC_LEN
;

1237 i‡(
assoc_acc
->
hdr
.
rq°
.
desc_èg
 !=

1238 
	`˝u_to_be32
(
FCNVME_LSDESC_RQST
))

1239 
f¸ë
 = 
VERR_LSDESC_RQST
;

1240 i‡(
assoc_acc
->
hdr
.
rq°
.
desc_Àn
 !=

1241 
	`f˙vme_lsdesc_Àn
((
f˙vme_lsdesc_rq°
)))

1242 
f¸ë
 = 
VERR_LSDESC_RQST_LEN
;

1243 i‡(
assoc_acc
->
hdr
.
rq°
.
w0
.
ls_cmd
 !
FCNVME_LS_CREATE_ASSOCIATION
)

1244 
f¸ë
 = 
VERR_CR_ASSOC
;

1245 i‡(
assoc_acc
->
associd
.
desc_èg
 !=

1246 
	`˝u_to_be32
(
FCNVME_LSDESC_ASSOC_ID
))

1247 
f¸ë
 = 
VERR_ASSOC_ID
;

1248 i‡(
assoc_acc
->
associd
.
desc_Àn
 !=

1249 
	`f˙vme_lsdesc_Àn
(

1250 (
f˙vme_lsdesc_assoc_id
)))

1251 
f¸ë
 = 
VERR_ASSOC_ID_LEN
;

1252 i‡(
assoc_acc
->
c⁄√˘id
.
desc_èg
 !=

1253 
	`˝u_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1254 
f¸ë
 = 
VERR_CONN_ID
;

1255 i‡(
assoc_acc
->
c⁄√˘id
.
desc_Àn
 !=

1256 
	`f˙vme_lsdesc_Àn
((
f˙vme_lsdesc_c⁄n_id
)))

1257 
f¸ë
 = 
VERR_CONN_ID_LEN
;

1259 i‡(
f¸ë
) {

1260 
ªt
 = -
EBADF
;

1261 
	`dev_îr
(
˘æ
->
dev
,

1263 
queue
->
qnum
, 
vÆid©i⁄_îr‹s
[
f¸ë
]);

1265 
˘æ
->
assocüti⁄_id
 =

1266 
	`be64_to_˝u
(
assoc_acc
->
associd
.
assocüti⁄_id
);

1267 
queue
->
c⁄√˘i⁄_id
 =

1268 
	`be64_to_˝u
(
assoc_acc
->
c⁄√˘id
.
c⁄√˘i⁄_id
);

1269 
	`£t_bô
(
NVME_FC_Q_CONNECTED
, &
queue
->
Êags
);

1272 
out_‰ì_buf„r
:

1273 
	`k‰ì
(
ls›
);

1274 
out_no_mem‹y
:

1275 i‡(
ªt
)

1276 
	`dev_îr
(
˘æ
->
dev
,

1278 
queue
->
qnum
, 
ªt
);

1279  
ªt
;

1280 
	}
}

1283 
	$nvme_fc_c⁄√˘_queue
(
nvme_fc_˘æ
 *
˘æ
, 
nvme_fc_queue
 *
queue
,

1284 
u16
 
qsize
, u16 
î•_øtio
)

1286 
nvmefc_ls_ªq_›
 *
ls›
;

1287 
nvmefc_ls_ªq
 *
l§eq
;

1288 
f˙vme_ls_¸_c⁄n_rq°
 *
c⁄n_rq°
;

1289 
f˙vme_ls_¸_c⁄n_acc
 *
c⁄n_acc
;

1290 
ªt
, 
f¸ë
 = 0;

1292 
ls›
 = 
	`kzÆloc
(((*lsop) +

1293 
˘æ
->
Õ‹t
->
›s
->
l§q°_¥iv_sz
 +

1294 (*
c⁄n_rq°
Ë+ (*
c⁄n_acc
)), 
GFP_KERNEL
);

1295 i‡(!
ls›
) {

1296 
ªt
 = -
ENOMEM
;

1297 
out_no_mem‹y
;

1299 
l§eq
 = &
ls›
->
ls_ªq
;

1301 
l§eq
->
¥iv©e
 = (*)&
ls›
[1];

1302 
c⁄n_rq°
 = (
f˙vme_ls_¸_c⁄n_rq°
 *)

1303 (
l§eq
->
¥iv©e
 + 
˘æ
->
Õ‹t
->
›s
->
l§q°_¥iv_sz
);

1304 
c⁄n_acc
 = (
f˙vme_ls_¸_c⁄n_acc
 *)&
c⁄n_rq°
[1];

1306 
c⁄n_rq°
->
w0
.
ls_cmd
 = 
FCNVME_LS_CREATE_CONNECTION
;

1307 
c⁄n_rq°
->
desc_li°_Àn
 = 
	`˝u_to_be32
(

1308 (
f˙vme_lsdesc_assoc_id
) +

1309 (
f˙vme_lsdesc_¸_c⁄n_cmd
));

1311 
c⁄n_rq°
->
associd
.
desc_èg
 = 
	`˝u_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1312 
c⁄n_rq°
->
associd
.
desc_Àn
 =

1313 
	`f˙vme_lsdesc_Àn
(

1314 (
f˙vme_lsdesc_assoc_id
));

1315 
c⁄n_rq°
->
associd
.
assocüti⁄_id
 = 
	`˝u_to_be64
(
˘æ
->association_id);

1316 
c⁄n_rq°
->
c⁄√˘_cmd
.
desc_èg
 =

1317 
	`˝u_to_be32
(
FCNVME_LSDESC_CREATE_CONN_CMD
);

1318 
c⁄n_rq°
->
c⁄√˘_cmd
.
desc_Àn
 =

1319 
	`f˙vme_lsdesc_Àn
(

1320 (
f˙vme_lsdesc_¸_c⁄n_cmd
));

1321 
c⁄n_rq°
->
c⁄√˘_cmd
.
î•_øtio
 = 
	`˝u_to_be16
(ersp_ratio);

1322 
c⁄n_rq°
->
c⁄√˘_cmd
.
qid
 = 
	`˝u_to_be16
(
queue
->
qnum
);

1323 
c⁄n_rq°
->
c⁄√˘_cmd
.
sqsize
 = 
	`˝u_to_be16
(
qsize
 - 1);

1325 
ls›
->
queue
 = queue;

1326 
l§eq
->
rq°addr
 = 
c⁄n_rq°
;

1327 
l§eq
->
rq°Àn
 = (*
c⁄n_rq°
);

1328 
l§eq
->
r•addr
 = 
c⁄n_acc
;

1329 
l§eq
->
r•Àn
 = (*
c⁄n_acc
);

1330 
l§eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1332 
ªt
 = 
	`nvme_fc_£nd_ls_ªq
(
˘æ
->
Ω‹t
, 
ls›
);

1333 i‡(
ªt
)

1334 
out_‰ì_buf„r
;

1339 i‡(
c⁄n_acc
->
hdr
.
w0
.
ls_cmd
 !
FCNVME_LS_ACC
)

1340 
f¸ë
 = 
VERR_LSACC
;

1341 i‡(
c⁄n_acc
->
hdr
.
desc_li°_Àn
 !=

1342 
	`f˙vme_lsdesc_Àn
((
f˙vme_ls_¸_c⁄n_acc
)))

1343 
f¸ë
 = 
VERR_CR_CONN_ACC_LEN
;

1344 i‡(
c⁄n_acc
->
hdr
.
rq°
.
desc_èg
 !
	`˝u_to_be32
(
FCNVME_LSDESC_RQST
))

1345 
f¸ë
 = 
VERR_LSDESC_RQST
;

1346 i‡(
c⁄n_acc
->
hdr
.
rq°
.
desc_Àn
 !=

1347 
	`f˙vme_lsdesc_Àn
((
f˙vme_lsdesc_rq°
)))

1348 
f¸ë
 = 
VERR_LSDESC_RQST_LEN
;

1349 i‡(
c⁄n_acc
->
hdr
.
rq°
.
w0
.
ls_cmd
 !
FCNVME_LS_CREATE_CONNECTION
)

1350 
f¸ë
 = 
VERR_CR_CONN
;

1351 i‡(
c⁄n_acc
->
c⁄√˘id
.
desc_èg
 !=

1352 
	`˝u_to_be32
(
FCNVME_LSDESC_CONN_ID
))

1353 
f¸ë
 = 
VERR_CONN_ID
;

1354 i‡(
c⁄n_acc
->
c⁄√˘id
.
desc_Àn
 !=

1355 
	`f˙vme_lsdesc_Àn
((
f˙vme_lsdesc_c⁄n_id
)))

1356 
f¸ë
 = 
VERR_CONN_ID_LEN
;

1358 i‡(
f¸ë
) {

1359 
ªt
 = -
EBADF
;

1360 
	`dev_îr
(
˘æ
->
dev
,

1362 
queue
->
qnum
, 
vÆid©i⁄_îr‹s
[
f¸ë
]);

1364 
queue
->
c⁄√˘i⁄_id
 =

1365 
	`be64_to_˝u
(
c⁄n_acc
->
c⁄√˘id
.
c⁄√˘i⁄_id
);

1366 
	`£t_bô
(
NVME_FC_Q_CONNECTED
, &
queue
->
Êags
);

1369 
out_‰ì_buf„r
:

1370 
	`k‰ì
(
ls›
);

1371 
out_no_mem‹y
:

1372 i‡(
ªt
)

1373 
	`dev_îr
(
˘æ
->
dev
,

1375 
queue
->
qnum
, 
ªt
);

1376  
ªt
;

1377 
	}
}

1380 
	$nvme_fc_disc⁄√˘_assoc_d⁄e
(
nvmefc_ls_ªq
 *
l§eq
, 
°©us
)

1382 
nvmefc_ls_ªq_›
 *
ls›
 = 
	`ls_ªq_to_ls›
(
l§eq
);

1384 
	`__nvme_fc_föish_ls_ªq
(
ls›
);

1388 
	`k‰ì
(
ls›
);

1389 
	}
}

1409 
	$nvme_fc_xmt_disc⁄√˘_assoc
(
nvme_fc_˘æ
 *
˘æ
)

1411 
f˙vme_ls_disc⁄√˘_rq°
 *
disc⁄_rq°
;

1412 
f˙vme_ls_disc⁄√˘_acc
 *
disc⁄_acc
;

1413 
nvmefc_ls_ªq_›
 *
ls›
;

1414 
nvmefc_ls_ªq
 *
l§eq
;

1415 
ªt
;

1417 
ls›
 = 
	`kzÆloc
(((*lsop) +

1418 
˘æ
->
Õ‹t
->
›s
->
l§q°_¥iv_sz
 +

1419 (*
disc⁄_rq°
Ë+ (*
disc⁄_acc
)),

1420 
GFP_KERNEL
);

1421 i‡(!
ls›
)

1425 
l§eq
 = &
ls›
->
ls_ªq
;

1427 
l§eq
->
¥iv©e
 = (*)&
ls›
[1];

1428 
disc⁄_rq°
 = (
f˙vme_ls_disc⁄√˘_rq°
 *)

1429 (
l§eq
->
¥iv©e
 + 
˘æ
->
Õ‹t
->
›s
->
l§q°_¥iv_sz
);

1430 
disc⁄_acc
 = (
f˙vme_ls_disc⁄√˘_acc
 *)&
disc⁄_rq°
[1];

1432 
disc⁄_rq°
->
w0
.
ls_cmd
 = 
FCNVME_LS_DISCONNECT
;

1433 
disc⁄_rq°
->
desc_li°_Àn
 = 
	`˝u_to_be32
(

1434 (
f˙vme_lsdesc_assoc_id
) +

1435 (
f˙vme_lsdesc_disc⁄n_cmd
));

1437 
disc⁄_rq°
->
associd
.
desc_èg
 = 
	`˝u_to_be32
(
FCNVME_LSDESC_ASSOC_ID
);

1438 
disc⁄_rq°
->
associd
.
desc_Àn
 =

1439 
	`f˙vme_lsdesc_Àn
(

1440 (
f˙vme_lsdesc_assoc_id
));

1442 
disc⁄_rq°
->
associd
.
assocüti⁄_id
 = 
	`˝u_to_be64
(
˘æ
->association_id);

1444 
disc⁄_rq°
->
disc⁄_cmd
.
desc_èg
 = 
	`˝u_to_be32
(

1445 
FCNVME_LSDESC_DISCONN_CMD
);

1446 
disc⁄_rq°
->
disc⁄_cmd
.
desc_Àn
 =

1447 
	`f˙vme_lsdesc_Àn
(

1448 (
f˙vme_lsdesc_disc⁄n_cmd
));

1449 
disc⁄_rq°
->
disc⁄_cmd
.
sc›e
 = 
FCNVME_DISCONN_ASSOCIATION
;

1450 
disc⁄_rq°
->
disc⁄_cmd
.
id
 = 
	`˝u_to_be64
(
˘æ
->
assocüti⁄_id
);

1452 
l§eq
->
rq°addr
 = 
disc⁄_rq°
;

1453 
l§eq
->
rq°Àn
 = (*
disc⁄_rq°
);

1454 
l§eq
->
r•addr
 = 
disc⁄_acc
;

1455 
l§eq
->
r•Àn
 = (*
disc⁄_acc
);

1456 
l§eq
->
timeout
 = 
NVME_FC_CONNECT_TIMEOUT_SEC
;

1458 
ªt
 = 
	`nvme_fc_£nd_ls_ªq_async
(
˘æ
->
Ω‹t
, 
ls›
,

1459 
nvme_fc_disc⁄√˘_assoc_d⁄e
);

1460 i‡(
ªt
)

1461 
	`k‰ì
(
ls›
);

1464 
˘æ
->
assocüti⁄_id
 = 0;

1465 
	}
}

1470 
nvme_fc_îr‹_ªcovîy
(
nvme_fc_˘æ
 *
˘æ
, *
îrmsg
);

1473 
	$__nvme_fc_exô_ªque°
(
nvme_fc_˘æ
 *
˘æ
,

1474 
nvme_fc_f˝_›
 *
›
)

1476 
	`fc_dma_unm≠_sögÀ
(
˘æ
->
Õ‹t
->
dev
, 
›
->
f˝_ªq
.
r•dma
,

1477 (
›
->
r•_iu
), 
DMA_FROM_DEVICE
);

1478 
	`fc_dma_unm≠_sögÀ
(
˘æ
->
Õ‹t
->
dev
, 
›
->
f˝_ªq
.
cmddma
,

1479 (
›
->
cmd_iu
), 
DMA_TO_DEVICE
);

1481 
	`©omic_£t
(&
›
->
°©e
, 
FCPOP_STATE_UNINIT
);

1482 
	}
}

1485 
	$nvme_fc_exô_ªque°
(
blk_mq_èg_£t
 *
£t
, 
ªque°
 *
rq
,

1486 
h˘x_idx
)

1488 
nvme_fc_f˝_›
 *
›
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1490  
	`__nvme_fc_exô_ªque°
(
£t
->
drivî_d©a
, 
›
);

1491 
	}
}

1494 
	$__nvme_fc_ab‹t_›
(
nvme_fc_˘æ
 *
˘æ
, 
nvme_fc_f˝_›
 *
›
)

1496 
Êags
;

1497 
›°©e
;

1499 
	`•ö_lock_úqßve
(&
˘æ
->
lock
, 
Êags
);

1500 
›°©e
 = 
	`©omic_xchg
(&
›
->
°©e
, 
FCPOP_STATE_ABORTED
);

1501 i‡(
›°©e
 !
FCPOP_STATE_ACTIVE
)

1502 
	`©omic_£t
(&
›
->
°©e
, 
›°©e
);

1503 i‡(
˘æ
->
Êags
 & 
FCCTRL_TERMIO
)

1504 
˘æ
->
io˙t
++;

1505 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
lock
, 
Êags
);

1507 i‡(
›°©e
 !
FCPOP_STATE_ACTIVE
)

1508  -
ECANCELED
;

1510 
˘æ
->
Õ‹t
->
›s
->
	`f˝_ab‹t
(&˘æ->Õ‹t->
loˇÕ‹t
,

1511 &
˘æ
->
Ω‹t
->
ªmŸï‹t
,

1512 
›
->
queue
->
Œdd_h™dÀ
,

1513 &
›
->
f˝_ªq
);

1516 
	}
}

1519 
	$nvme_fc_ab‹t_´n_›s
(
nvme_fc_˘æ
 *
˘æ
)

1521 
nvme_fc_f˝_›
 *
´n_›
 = 
˘æ
->
´n_›s
;

1522 
i
;

1525 i‡(!(
´n_›
->
Êags
 & 
FCOP_FLAGS_AEN
))

1528 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
´n_›
++)

1529 
	`__nvme_fc_ab‹t_›
(
˘æ
, 
´n_›
);

1530 
	}
}

1532 
ölöe
 

1533 
	$__nvme_fc_f˝›_chk_ã¨downs
(
nvme_fc_˘æ
 *
˘æ
,

1534 
nvme_fc_f˝_›
 *
›
, 
›°©e
)

1536 
Êags
;

1538 i‡(
›°©e
 =
FCPOP_STATE_ABORTED
) {

1539 
	`•ö_lock_úqßve
(&
˘æ
->
lock
, 
Êags
);

1540 i‡(
˘æ
->
Êags
 & 
FCCTRL_TERMIO
) {

1541 i‡(!--
˘æ
->
io˙t
)

1542 
	`wake_up
(&
˘æ
->
iﬂb‹t_waô
);

1544 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
lock
, 
Êags
);

1546 
	}
}

1549 
	$nvme_fc_f˝io_d⁄e
(
nvmefc_f˝_ªq
 *
ªq
)

1551 
nvme_fc_f˝_›
 *
›
 = 
	`f˝_ªq_to_f˝_›
(
ªq
);

1552 
ªque°
 *
rq
 = 
›
->rq;

1553 
nvmefc_f˝_ªq
 *
‰eq
 = &
›
->
f˝_ªq
;

1554 
nvme_fc_˘æ
 *
˘æ
 = 
›
->ctrl;

1555 
nvme_fc_queue
 *
queue
 = 
›
->queue;

1556 
nvme_com∂ëi⁄
 *
cqe
 = &
›
->
r•_iu
.cqe;

1557 
nvme_comm™d
 *
sqe
 = &
›
->
cmd_iu
.sqe;

1558 
__À16
 
°©us
 = 
	`˝u_to_À16
(
NVME_SC_SUCCESS
 << 1);

1559 
nvme_ªsu…
 
ªsu…
;

1560 
boﬁ
 
ãrmö©e_assoc
 = 
åue
;

1561 
›°©e
;

1600 
›°©e
 = 
	`©omic_xchg
(&
›
->
°©e
, 
FCPOP_STATE_COMPLETE
);

1602 
	`fc_dma_sync_sögÀ_f‹_˝u
(
˘æ
->
Õ‹t
->
dev
, 
›
->
f˝_ªq
.
r•dma
,

1603 (
›
->
r•_iu
), 
DMA_FROM_DEVICE
);

1605 i‡(
›°©e
 =
FCPOP_STATE_ABORTED
)

1606 
°©us
 = 
	`˝u_to_À16
(
NVME_SC_ABORT_REQ
 << 1);

1607 i‡(
‰eq
->
°©us
)

1608 
°©us
 = 
	`˝u_to_À16
(
NVME_SC_INTERNAL
 << 1);

1615 i‡(
°©us
)

1616 
d⁄e
;

1625 
‰eq
->
rcv_r•Àn
) {

1628 
NVME_FC_SIZEOF_ZEROS_RSP
:

1634 i‡(
‰eq
->
å™s„ºed_Àngth
 !=

1635 
	`be32_to_˝u
(
›
->
cmd_iu
.
d©a_Àn
)) {

1636 
°©us
 = 
	`˝u_to_À16
(
NVME_SC_INTERNAL
 << 1);

1637 
d⁄e
;

1639 
ªsu…
.
u64
 = 0;

1642 (
nvme_fc_î•_iu
):

1647 i‡(
	`u∆ikñy
(
	`be16_to_˝u
(
›
->
r•_iu
.
iu_Àn
) !=

1648 (
‰eq
->
rcv_r•Àn
 / 4) ||

1649 
	`be32_to_˝u
(
›
->
r•_iu
.
x‰d_Àn
) !=

1650 
‰eq
->
å™s„ºed_Àngth
 ||

1651 
›
->
r•_iu
.
°©us_code
 ||

1652 
sqe
->
comm⁄
.
comm™d_id
 !
cqe
->command_id)) {

1653 
°©us
 = 
	`˝u_to_À16
(
NVME_SC_INTERNAL
 << 1);

1654 
d⁄e
;

1656 
ªsu…
 = 
cqe
->result;

1657 
°©us
 = 
cqe
->status;

1661 
°©us
 = 
	`˝u_to_À16
(
NVME_SC_INTERNAL
 << 1);

1662 
d⁄e
;

1665 
ãrmö©e_assoc
 = 
Ál£
;

1667 
d⁄e
:

1668 i‡(
›
->
Êags
 & 
FCOP_FLAGS_AEN
) {

1669 
	`nvme_com∂ëe_async_evít
(&
queue
->
˘æ
->˘æ, 
°©us
, &
ªsu…
);

1670 
	`__nvme_fc_f˝›_chk_ã¨downs
(
˘æ
, 
›
, 
›°©e
);

1671 
	`©omic_£t
(&
›
->
°©e
, 
FCPOP_STATE_IDLE
);

1672 
›
->
Êags
 = 
FCOP_FLAGS_AEN
;

1673 
	`nvme_fc_˘æ_put
(
˘æ
);

1674 
check_îr‹
;

1677 
	`__nvme_fc_f˝›_chk_ã¨downs
(
˘æ
, 
›
, 
›°©e
);

1678 
	`nvme_íd_ªque°
(
rq
, 
°©us
, 
ªsu…
);

1680 
check_îr‹
:

1681 i‡(
ãrmö©e_assoc
)

1682 
	`nvme_fc_îr‹_ªcovîy
(
˘æ
, "transport detected ioÉrror");

1683 
	}
}

1686 
	$__nvme_fc_öô_ªque°
(
nvme_fc_˘æ
 *
˘æ
,

1687 
nvme_fc_queue
 *
queue
, 
nvme_fc_f˝_›
 *
›
,

1688 
ªque°
 *
rq
, 
u32
 
rqno
)

1690 
nvme_f˝_›_w_sgl
 *
›_w_sgl
 =

1691 
	`c⁄èöî_of
(
›
, 
	`ty≥of
(*
›_w_sgl
), op);

1692 
nvme_fc_cmd_iu
 *
cmdiu
 = &
›
->
cmd_iu
;

1693 
ªt
 = 0;

1695 
	`mem£t
(
›
, 0, (*op));

1696 
›
->
f˝_ªq
.
cmdaddr
 = &›->
cmd_iu
;

1697 
›
->
f˝_ªq
.
cmdÀn
 = (›->
cmd_iu
);

1698 
›
->
f˝_ªq
.
r•addr
 = &›->
r•_iu
;

1699 
›
->
f˝_ªq
.
r•Àn
 = (›->
r•_iu
);

1700 
›
->
f˝_ªq
.
d⁄e
 = 
nvme_fc_f˝io_d⁄e
;

1701 
›
->
˘æ
 = ctrl;

1702 
›
->
queue
 = queue;

1703 
›
->
rq
 =Ñq;

1704 
›
->
rqno
 =Ñqno;

1706 
cmdiu
->
scsi_id
 = 
NVME_CMD_SCSI_ID
;

1707 
cmdiu
->
fc_id
 = 
NVME_CMD_FC_ID
;

1708 
cmdiu
->
iu_Àn
 = 
	`˝u_to_be16
((*cmdiuË/ (
u32
));

1710 
›
->
f˝_ªq
.
cmddma
 = 
	`fc_dma_m≠_sögÀ
(
˘æ
->
Õ‹t
->
dev
,

1711 &
›
->
cmd_iu
, (›->cmd_iu), 
DMA_TO_DEVICE
);

1712 i‡(
	`fc_dma_m≠pög_îr‹
(
˘æ
->
Õ‹t
->
dev
, 
›
->
f˝_ªq
.
cmddma
)) {

1713 
	`dev_îr
(
˘æ
->
dev
,

1715 
ªt
 = 
EFAULT
;

1716 
out_⁄_îr‹
;

1719 
›
->
f˝_ªq
.
r•dma
 = 
	`fc_dma_m≠_sögÀ
(
˘æ
->
Õ‹t
->
dev
,

1720 &
›
->
r•_iu
, (op->rsp_iu),

1721 
DMA_FROM_DEVICE
);

1722 i‡(
	`fc_dma_m≠pög_îr‹
(
˘æ
->
Õ‹t
->
dev
, 
›
->
f˝_ªq
.
r•dma
)) {

1723 
	`dev_îr
(
˘æ
->
dev
,

1725 
ªt
 = 
EFAULT
;

1728 
	`©omic_£t
(&
›
->
°©e
, 
FCPOP_STATE_IDLE
);

1729 
out_⁄_îr‹
:

1730  
ªt
;

1731 
	}
}

1734 
	$nvme_fc_öô_ªque°
(
blk_mq_èg_£t
 *
£t
, 
ªque°
 *
rq
,

1735 
h˘x_idx
, 
numa_node
)

1737 
nvme_fc_˘æ
 *
˘æ
 = 
£t
->
drivî_d©a
;

1738 
nvme_f˝_›_w_sgl
 *
›
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1739 
queue_idx
 = (
£t
 =&
˘æ
->
èg_£t
Ë? 
h˘x_idx
 + 1 : 0;

1740 
nvme_fc_queue
 *
queue
 = &
˘æ
->
queues
[
queue_idx
];

1741 
ªs
;

1743 
ªs
 = 
	`__nvme_fc_öô_ªque°
(
˘æ
, 
queue
, &
›
->›, 
rq
, queue->
rq˙t
++);

1744 i‡(
ªs
)

1745  
ªs
;

1746 
›
->›.
f˝_ªq
.
fú°_sgl
 = &›->
sgl
[0];

1747 
›
->›.
f˝_ªq
.
¥iv©e
 = &›->
¥iv
[0];

1748 
	`nvme_ªq
(
rq
)->
˘æ
 = &ctrl->ctrl;

1749  
ªs
;

1750 
	}
}

1753 
	$nvme_fc_öô_´n_›s
(
nvme_fc_˘æ
 *
˘æ
)

1755 
nvme_fc_f˝_›
 *
´n_›
;

1756 
nvme_fc_cmd_iu
 *
cmdiu
;

1757 
nvme_comm™d
 *
sqe
;

1758 *
¥iv©e
;

1759 
i
, 
ªt
;

1761 
´n_›
 = 
˘æ
->
´n_›s
;

1762 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
´n_›
++) {

1763 
¥iv©e
 = 
	`kzÆloc
(
˘æ
->
Õ‹t
->
›s
->
f˝rq°_¥iv_sz
,

1764 
GFP_KERNEL
);

1765 i‡(!
¥iv©e
)

1766  -
ENOMEM
;

1768 
cmdiu
 = &
´n_›
->
cmd_iu
;

1769 
sqe
 = &
cmdiu
->sqe;

1770 
ªt
 = 
	`__nvme_fc_öô_ªque°
(
˘æ
, &˘æ->
queues
[0],

1771 
´n_›
, (
ªque°
 *)
NULL
,

1772 (
NVME_AQ_BLK_MQ_DEPTH
 + 
i
));

1773 i‡(
ªt
) {

1774 
	`k‰ì
(
¥iv©e
);

1775  
ªt
;

1778 
´n_›
->
Êags
 = 
FCOP_FLAGS_AEN
;

1779 
´n_›
->
f˝_ªq
.
¥iv©e
 =Örivate;

1781 
	`mem£t
(
sqe
, 0, (*sqe));

1782 
sqe
->
comm⁄
.
›code
 = 
nvme_admö_async_evít
;

1784 
sqe
->
comm⁄
.
comm™d_id
 = 
NVME_AQ_BLK_MQ_DEPTH
 + 
i
;

1787 
	}
}

1790 
	$nvme_fc_ãrm_´n_›s
(
nvme_fc_˘æ
 *
˘æ
)

1792 
nvme_fc_f˝_›
 *
´n_›
;

1793 
i
;

1795 
´n_›
 = 
˘æ
->
´n_›s
;

1796 
i
 = 0; i < 
NVME_NR_AEN_COMMANDS
; i++, 
´n_›
++) {

1797 i‡(!
´n_›
->
f˝_ªq
.
¥iv©e
)

1800 
	`__nvme_fc_exô_ªque°
(
˘æ
, 
´n_›
);

1802 
	`k‰ì
(
´n_›
->
f˝_ªq
.
¥iv©e
);

1803 
´n_›
->
f˝_ªq
.
¥iv©e
 = 
NULL
;

1805 
	}
}

1807 
ölöe
 

1808 
	$__nvme_fc_öô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, 
nvme_fc_˘æ
 *
˘æ
,

1809 
qidx
)

1811 
nvme_fc_queue
 *
queue
 = &
˘æ
->
queues
[
qidx
];

1813 
h˘x
->
drivî_d©a
 = 
queue
;

1814 
queue
->
h˘x
 = hctx;

1815 
	}
}

1818 
	$nvme_fc_öô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

1819 
h˘x_idx
)

1821 
nvme_fc_˘æ
 *
˘æ
 = 
d©a
;

1823 
	`__nvme_fc_öô_h˘x
(
h˘x
, 
˘æ
, 
h˘x_idx
 + 1);

1826 
	}
}

1829 
	$nvme_fc_öô_admö_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

1830 
h˘x_idx
)

1832 
nvme_fc_˘æ
 *
˘æ
 = 
d©a
;

1834 
	`__nvme_fc_öô_h˘x
(
h˘x
, 
˘æ
, 
h˘x_idx
);

1837 
	}
}

1840 
	$nvme_fc_öô_queue
(
nvme_fc_˘æ
 *
˘æ
, 
idx
)

1842 
nvme_fc_queue
 *
queue
;

1844 
queue
 = &
˘æ
->
queues
[
idx
];

1845 
	`mem£t
(
queue
, 0, (*queue));

1846 
queue
->
˘æ
 = ctrl;

1847 
queue
->
qnum
 = 
idx
;

1848 
	`©omic_£t
(&
queue
->
c¢
, 0);

1849 
queue
->
dev
 = 
˘æ
->dev;

1851 i‡(
idx
 > 0)

1852 
queue
->
cmnd_ˇpsuÀ_Àn
 = 
˘æ
->˘æ.
ioccsz
 * 16;

1854 
queue
->
cmnd_ˇpsuÀ_Àn
 = (
nvme_comm™d
);

1866 
	}
}

1877 
	$nvme_fc_‰ì_queue
(
nvme_fc_queue
 *
queue
)

1879 i‡(!
	`ã°_™d_˛ór_bô
(
NVME_FC_Q_CONNECTED
, &
queue
->
Êags
))

1882 
	`˛ór_bô
(
NVME_FC_Q_LIVE
, &
queue
->
Êags
);

1889 
queue
->
c⁄√˘i⁄_id
 = 0;

1890 
	`©omic_£t
(&
queue
->
c¢
, 0);

1891 
	}
}

1894 
	$__nvme_fc_dñëe_hw_queue
(
nvme_fc_˘æ
 *
˘æ
,

1895 
nvme_fc_queue
 *
queue
, 
qidx
)

1897 i‡(
˘æ
->
Õ‹t
->
›s
->
dñëe_queue
)

1898 
˘æ
->
Õ‹t
->
›s
->
	`dñëe_queue
(&˘æ->Õ‹t->
loˇÕ‹t
, 
qidx
,

1899 
queue
->
Œdd_h™dÀ
);

1900 
queue
->
Œdd_h™dÀ
 = 
NULL
;

1901 
	}
}

1904 
	$nvme_fc_‰ì_io_queues
(
nvme_fc_˘æ
 *
˘æ
)

1906 
i
;

1908 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++)

1909 
	`nvme_fc_‰ì_queue
(&
˘æ
->
queues
[
i
]);

1910 
	}
}

1913 
	$__nvme_fc_¸óã_hw_queue
(
nvme_fc_˘æ
 *
˘æ
,

1914 
nvme_fc_queue
 *
queue
, 
qidx
, 
u16
 
qsize
)

1916 
ªt
 = 0;

1918 
queue
->
Œdd_h™dÀ
 = 
NULL
;

1919 i‡(
˘æ
->
Õ‹t
->
›s
->
¸óã_queue
)

1920 
ªt
 = 
˘æ
->
Õ‹t
->
›s
->
	`¸óã_queue
(&˘æ->Õ‹t->
loˇÕ‹t
,

1921 
qidx
, 
qsize
, &
queue
->
Œdd_h™dÀ
);

1923  
ªt
;

1924 
	}
}

1927 
	$nvme_fc_dñëe_hw_io_queues
(
nvme_fc_˘æ
 *
˘æ
)

1929 
nvme_fc_queue
 *
queue
 = &
˘æ
->
queues
[˘æ->˘æ.
queue_cou¡
 - 1];

1930 
i
;

1932 
i
 = 
˘æ
->˘æ.
queue_cou¡
 - 1; i >1; i--, 
queue
--)

1933 
	`__nvme_fc_dñëe_hw_queue
(
˘æ
, 
queue
, 
i
);

1934 
	}
}

1937 
	$nvme_fc_¸óã_hw_io_queues
(
nvme_fc_˘æ
 *
˘æ
, 
u16
 
qsize
)

1939 
nvme_fc_queue
 *
queue
 = &
˘æ
->
queues
[1];

1940 
i
, 
ªt
;

1942 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++, 
queue
++) {

1943 
ªt
 = 
	`__nvme_fc_¸óã_hw_queue
(
˘æ
, 
queue
, 
i
, 
qsize
);

1944 i‡(
ªt
)

1945 
dñëe_queues
;

1950 
dñëe_queues
:

1951 ; 
i
 >= 0; i--)

1952 
	`__nvme_fc_dñëe_hw_queue
(
˘æ
, &˘æ->
queues
[
i
], i);

1953  
ªt
;

1954 
	}
}

1957 
	$nvme_fc_c⁄√˘_io_queues
(
nvme_fc_˘æ
 *
˘æ
, 
u16
 
qsize
)

1959 
i
, 
ªt
 = 0;

1961 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++) {

1962 
ªt
 = 
	`nvme_fc_c⁄√˘_queue
(
˘æ
, &˘æ->
queues
[
i
], 
qsize
,

1963 (
qsize
 / 5));

1964 i‡(
ªt
)

1966 
ªt
 = 
	`nvmf_c⁄√˘_io_queue
(&
˘æ
->˘æ, 
i
, 
Ál£
);

1967 i‡(
ªt
)

1970 
	`£t_bô
(
NVME_FC_Q_LIVE
, &
˘æ
->
queues
[
i
].
Êags
);

1973  
ªt
;

1974 
	}
}

1977 
	$nvme_fc_öô_io_queues
(
nvme_fc_˘æ
 *
˘æ
)

1979 
i
;

1981 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++)

1982 
	`nvme_fc_öô_queue
(
˘æ
, 
i
);

1983 
	}
}

1986 
	$nvme_fc_˘æ_‰ì
(
kªf
 *
ªf
)

1988 
nvme_fc_˘æ
 *
˘æ
 =

1989 
	`c⁄èöî_of
(
ªf
, 
nvme_fc_˘æ
,Ñef);

1990 
Êags
;

1992 i‡(
˘æ
->˘æ.
èg£t
) {

1993 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
c⁄√˘_q
);

1994 
	`blk_mq_‰ì_èg_£t
(&
˘æ
->
èg_£t
);

1998 
	`•ö_lock_úqßve
(&
˘æ
->
Ω‹t
->
lock
, 
Êags
);

1999 
	`li°_dñ
(&
˘æ
->
˘æ_li°
);

2000 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
Ω‹t
->
lock
, 
Êags
);

2002 
	`blk_mq_unquõs˚_queue
(
˘æ
->˘æ.
admö_q
);

2003 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
admö_q
);

2004 
	`blk_mq_‰ì_èg_£t
(&
˘æ
->
admö_èg_£t
);

2006 
	`k‰ì
(
˘æ
->
queues
);

2008 
	`put_devi˚
(
˘æ
->
dev
);

2009 
	`nvme_fc_Ω‹t_put
(
˘æ
->
Ω‹t
);

2011 
	`ida_sim∂e_ªmove
(&
nvme_fc_˘æ_˙t
, 
˘æ
->
˙um
);

2012 i‡(
˘æ
->˘æ.
›ts
)

2013 
	`nvmf_‰ì_›ti⁄s
(
˘æ
->˘æ.
›ts
);

2014 
	`k‰ì
(
˘æ
);

2015 
	}
}

2018 
	$nvme_fc_˘æ_put
(
nvme_fc_˘æ
 *
˘æ
)

2020 
	`kªf_put
(&
˘æ
->
ªf
, 
nvme_fc_˘æ_‰ì
);

2021 
	}
}

2024 
	$nvme_fc_˘æ_gë
(
nvme_fc_˘æ
 *
˘æ
)

2026  
	`kªf_gë_u∆ess_zîo
(&
˘æ
->
ªf
);

2027 
	}
}

2034 
	$nvme_fc_nvme_˘æ_‰ìd
(
nvme_˘æ
 *
n˘æ
)

2036 
nvme_fc_˘æ
 *
˘æ
 = 
	`to_fc_˘æ
(
n˘æ
);

2038 
	`WARN_ON
(
n˘æ
 !&
˘æ
->ctrl);

2040 
	`nvme_fc_˘æ_put
(
˘æ
);

2041 
	}
}

2044 
	$nvme_fc_îr‹_ªcovîy
(
nvme_fc_˘æ
 *
˘æ
, *
îrmsg
)

2046 
a˘ive
;

2055 i‡(
˘æ
->˘æ.
°©e
 =
NVME_CTRL_CONNECTING
) {

2056 
a˘ive
 = 
	`©omic_xchg
(&
˘æ
->
îr_w‹k_a˘ive
, 1);

2057 i‡(!
a˘ive
 && !
	`scheduÀ_w‹k
(&
˘æ
->
îr_w‹k
)) {

2058 
	`©omic_£t
(&
˘æ
->
îr_w‹k_a˘ive
, 0);

2059 
	`WARN_ON
(1);

2065 i‡(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_LIVE
)

2068 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2070 
˘æ
->
˙um
, 
îrmsg
);

2071 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2072 "NVME-FC{%d}:Ñe£âög c⁄åﬁÀr\n", 
˘æ
->
˙um
);

2074 
	`nvme_ª£t_˘æ
(&
˘æ
->ctrl);

2075 
	}
}

2077 
blk_eh_timî_ªtu∫


2078 
	$nvme_fc_timeout
(
ªque°
 *
rq
, 
boﬁ
 
ª£rved
)

2080 
nvme_fc_f˝_›
 *
›
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2081 
nvme_fc_˘æ
 *
˘æ
 = 
›
->ctrl;

2090 
	`nvme_fc_îr‹_ªcovîy
(
˘æ
, "ioÅimeoutÉrror");

2097  
BLK_EH_RESET_TIMER
;

2098 
	}
}

2101 
	$nvme_fc_m≠_d©a
(
nvme_fc_˘æ
 *
˘æ
, 
ªque°
 *
rq
,

2102 
nvme_fc_f˝_›
 *
›
)

2104 
nvmefc_f˝_ªq
 *
‰eq
 = &
›
->
f˝_ªq
;

2105 
dma_d©a_dúe˘i⁄
 
dú
;

2106 
ªt
;

2108 
‰eq
->
sg_˙t
 = 0;

2110 i‡(!
	`blk_rq_ƒ_phys_£gmíts
(
rq
))

2113 
‰eq
->
sg_èbÀ
.
sgl
 = fªq->
fú°_sgl
;

2114 
ªt
 = 
	`sg_Æloc_èbÀ_chaöed
(&
‰eq
->
sg_èbÀ
,

2115 
	`blk_rq_ƒ_phys_£gmíts
(
rq
), 
‰eq
->
sg_èbÀ
.
sgl
);

2116 i‡(
ªt
)

2117  -
ENOMEM
;

2119 
›
->
√¡s
 = 
	`blk_rq_m≠_sg
(
rq
->
q
,Ñq, 
‰eq
->
sg_èbÀ
.
sgl
);

2120 
	`WARN_ON
(
›
->
√¡s
 > 
	`blk_rq_ƒ_phys_£gmíts
(
rq
));

2121 
dú
 = (
	`rq_d©a_dú
(
rq
Ë=
WRITE
Ë? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

2122 
‰eq
->
sg_˙t
 = 
	`fc_dma_m≠_sg
(
˘æ
->
Õ‹t
->
dev
, fªq->
sg_èbÀ
.
sgl
,

2123 
›
->
√¡s
, 
dú
);

2124 i‡(
	`u∆ikñy
(
‰eq
->
sg_˙t
 <= 0)) {

2125 
	`sg_‰ì_èbÀ_chaöed
(&
‰eq
->
sg_èbÀ
, 
åue
);

2126 
‰eq
->
sg_˙t
 = 0;

2127  -
EFAULT
;

2134 
	}
}

2137 
	$nvme_fc_unm≠_d©a
(
nvme_fc_˘æ
 *
˘æ
, 
ªque°
 *
rq
,

2138 
nvme_fc_f˝_›
 *
›
)

2140 
nvmefc_f˝_ªq
 *
‰eq
 = &
›
->
f˝_ªq
;

2142 i‡(!
‰eq
->
sg_˙t
)

2145 
	`fc_dma_unm≠_sg
(
˘æ
->
Õ‹t
->
dev
, 
‰eq
->
sg_èbÀ
.
sgl
, 
›
->
√¡s
,

2146 ((
	`rq_d©a_dú
(
rq
Ë=
WRITE
) ?

2147 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
));

2149 
	`nvme_˛ónup_cmd
(
rq
);

2151 
	`sg_‰ì_èbÀ_chaöed
(&
‰eq
->
sg_èbÀ
, 
åue
);

2153 
‰eq
->
sg_˙t
 = 0;

2154 
	}
}

2179 
blk_°©us_t


2180 
	$nvme_fc_°¨t_f˝_›
(
nvme_fc_˘æ
 *
˘æ
, 
nvme_fc_queue
 *
queue
,

2181 
nvme_fc_f˝_›
 *
›
, 
u32
 
d©a_Àn
,

2182 
nvmefc_f˝_d©adú
 
io_dú
)

2184 
nvme_fc_cmd_iu
 *
cmdiu
 = &
›
->
cmd_iu
;

2185 
nvme_comm™d
 *
sqe
 = &
cmdiu
->sqe;

2186 
ªt
, 
›°©e
;

2192 i‡(
˘æ
->
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
)

2193  
BLK_STS_RESOURCE
;

2195 i‡(!
	`nvme_fc_˘æ_gë
(
˘æ
))

2196  
BLK_STS_IOERR
;

2199 
cmdiu
->
c⁄√˘i⁄_id
 = 
	`˝u_to_be64
(
queue
->connection_id);

2200 
cmdiu
->
d©a_Àn
 = 
	`˝u_to_be32
(data_len);

2201 
io_dú
) {

2202 
NVMEFC_FCP_WRITE
:

2203 
cmdiu
->
Êags
 = 
FCNVME_CMD_FLAGS_WRITE
;

2205 
NVMEFC_FCP_READ
:

2206 
cmdiu
->
Êags
 = 
FCNVME_CMD_FLAGS_READ
;

2208 
NVMEFC_FCP_NODATA
:

2209 
cmdiu
->
Êags
 = 0;

2212 
›
->
f˝_ªq
.
∑ylﬂd_Àngth
 = 
d©a_Àn
;

2213 
›
->
f˝_ªq
.
io_dú
 = io_dir;

2214 
›
->
f˝_ªq
.
å™s„ºed_Àngth
 = 0;

2215 
›
->
f˝_ªq
.
rcv_r•Àn
 = 0;

2216 
›
->
f˝_ªq
.
°©us
 = 
NVME_SC_SUCCESS
;

2217 
›
->
f˝_ªq
.
sqid
 = 
	`˝u_to_À16
(
queue
->
qnum
);

2223 
	`WARN_ON_ONCE
(
sqe
->
comm⁄
.
mëad©a
);

2224 
sqe
->
comm⁄
.
Êags
 |
NVME_CMD_SGL_METABUF
;

2233 
sqe
->
rw
.
d±r
.
sgl
.
ty≥
 = (
NVME_TRANSPORT_SGL_DATA_DESC
 << 4) |

2234 
NVME_SGL_FMT_TRANSPORT_A
;

2235 
sqe
->
rw
.
d±r
.
sgl
.
Àngth
 = 
	`˝u_to_À32
(
d©a_Àn
);

2236 
sqe
->
rw
.
d±r
.
sgl
.
addr
 = 0;

2238 i‡(!(
›
->
Êags
 & 
FCOP_FLAGS_AEN
)) {

2239 
ªt
 = 
	`nvme_fc_m≠_d©a
(
˘æ
, 
›
->
rq
, op);

2240 i‡(
ªt
 < 0) {

2241 
	`nvme_˛ónup_cmd
(
›
->
rq
);

2242 
	`nvme_fc_˘æ_put
(
˘æ
);

2243 i‡(
ªt
 =-
ENOMEM
 ||Ñë =-
EAGAIN
)

2244  
BLK_STS_RESOURCE
;

2245  
BLK_STS_IOERR
;

2249 
	`fc_dma_sync_sögÀ_f‹_devi˚
(
˘æ
->
Õ‹t
->
dev
, 
›
->
f˝_ªq
.
cmddma
,

2250 (
›
->
cmd_iu
), 
DMA_TO_DEVICE
);

2252 
	`©omic_£t
(&
›
->
°©e
, 
FCPOP_STATE_ACTIVE
);

2254 i‡(!(
›
->
Êags
 & 
FCOP_FLAGS_AEN
))

2255 
	`blk_mq_°¨t_ªque°
(
›
->
rq
);

2257 
cmdiu
->
c¢
 = 
	`˝u_to_be32
(
	`©omic_öc_ªtu∫
(&
queue
->csn));

2258 
ªt
 = 
˘æ
->
Õ‹t
->
›s
->
	`f˝_io
(&˘æ->Õ‹t->
loˇÕ‹t
,

2259 &
˘æ
->
Ω‹t
->
ªmŸï‹t
,

2260 
queue
->
Œdd_h™dÀ
, &
›
->
f˝_ªq
);

2262 i‡(
ªt
) {

2275 
›°©e
 = 
	`©omic_xchg
(&
›
->
°©e
, 
FCPOP_STATE_COMPLETE
);

2276 
	`__nvme_fc_f˝›_chk_ã¨downs
(
˘æ
, 
›
, 
›°©e
);

2278 i‡(!(
›
->
Êags
 & 
FCOP_FLAGS_AEN
))

2279 
	`nvme_fc_unm≠_d©a
(
˘æ
, 
›
->
rq
, op);

2281 
	`nvme_fc_˘æ_put
(
˘æ
);

2283 i‡(
˘æ
->
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 =
FC_OBJSTATE_ONLINE
 &&

2284 
ªt
 !-
EBUSY
)

2285  
BLK_STS_IOERR
;

2287  
BLK_STS_RESOURCE
;

2290  
BLK_STS_OK
;

2291 
	}
}

2293 
blk_°©us_t


2294 
	$nvme_fc_queue_rq
(
blk_mq_hw_˘x
 *
h˘x
,

2295 c⁄° 
blk_mq_queue_d©a
 *
bd
)

2297 
nvme_ns
 *
ns
 = 
h˘x
->
queue
->
queued©a
;

2298 
nvme_fc_queue
 *
queue
 = 
h˘x
->
drivî_d©a
;

2299 
nvme_fc_˘æ
 *
˘æ
 = 
queue
->ctrl;

2300 
ªque°
 *
rq
 = 
bd
->rq;

2301 
nvme_fc_f˝_›
 *
›
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2302 
nvme_fc_cmd_iu
 *
cmdiu
 = &
›
->
cmd_iu
;

2303 
nvme_comm™d
 *
sqe
 = &
cmdiu
->sqe;

2304 
nvmefc_f˝_d©adú
 
io_dú
;

2305 
boﬁ
 
queue_ªady
 = 
	`ã°_bô
(
NVME_FC_Q_LIVE
, &
queue
->
Êags
);

2306 
u32
 
d©a_Àn
;

2307 
blk_°©us_t
 
ªt
;

2309 i‡(
˘æ
->
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
 ||

2310 !
	`nvmf_check_ªady
(&
queue
->
˘æ
->˘æ, 
rq
, 
queue_ªady
))

2311  
	`nvmf_Áû_n⁄ªady_comm™d
(&
queue
->
˘æ
->˘æ, 
rq
);

2313 
ªt
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
sqe
);

2314 i‡(
ªt
)

2315  
ªt
;

2325 i‡(
	`blk_rq_ƒ_phys_£gmíts
(
rq
)) {

2326 
d©a_Àn
 = 
	`blk_rq_∑ylﬂd_byãs
(
rq
);

2327 
io_dú
 = ((
	`rq_d©a_dú
(
rq
Ë=
WRITE
) ?

2328 
NVMEFC_FCP_WRITE
 : 
NVMEFC_FCP_READ
);

2330 
d©a_Àn
 = 0;

2331 
io_dú
 = 
NVMEFC_FCP_NODATA
;

2335  
	`nvme_fc_°¨t_f˝_›
(
˘æ
, 
queue
, 
›
, 
d©a_Àn
, 
io_dú
);

2336 
	}
}

2339 
	$nvme_fc_submô_async_evít
(
nvme_˘æ
 *
¨g
)

2341 
nvme_fc_˘æ
 *
˘æ
 = 
	`to_fc_˘æ
(
¨g
);

2342 
nvme_fc_f˝_›
 *
´n_›
;

2343 
Êags
;

2344 
boﬁ
 
ãrmö©ög
 = 
Ál£
;

2345 
blk_°©us_t
 
ªt
;

2347 
	`•ö_lock_úqßve
(&
˘æ
->
lock
, 
Êags
);

2348 i‡(
˘æ
->
Êags
 & 
FCCTRL_TERMIO
)

2349 
ãrmö©ög
 = 
åue
;

2350 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
lock
, 
Êags
);

2352 i‡(
ãrmö©ög
)

2355 
´n_›
 = &
˘æ
->
´n_›s
[0];

2357 
ªt
 = 
	`nvme_fc_°¨t_f˝_›
(
˘æ
, 
´n_›
->
queue
,áen_op, 0,

2358 
NVMEFC_FCP_NODATA
);

2359 i‡(
ªt
)

2360 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

2362 
	}
}

2365 
	$nvme_fc_com∂ëe_rq
(
ªque°
 *
rq
)

2367 
nvme_fc_f˝_›
 *
›
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2368 
nvme_fc_˘æ
 *
˘æ
 = 
›
->ctrl;

2370 
	`©omic_£t
(&
›
->
°©e
, 
FCPOP_STATE_IDLE
);

2372 
	`nvme_fc_unm≠_d©a
(
˘æ
, 
rq
, 
›
);

2373 
	`nvme_com∂ëe_rq
(
rq
);

2374 
	`nvme_fc_˘æ_put
(
˘æ
);

2375 
	}
}

2390 
boﬁ


2391 
	$nvme_fc_ãrmö©e_exch™ge
(
ªque°
 *
ªq
, *
d©a
, 
boﬁ
 
ª£rved
)

2393 
nvme_˘æ
 *
n˘æ
 = 
d©a
;

2394 
nvme_fc_˘æ
 *
˘æ
 = 
	`to_fc_˘æ
(
n˘æ
);

2395 
nvme_fc_f˝_›
 *
›
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

2397 
	`__nvme_fc_ab‹t_›
(
˘æ
, 
›
);

2398  
åue
;

2399 
	}
}

2402 c⁄° 
blk_mq_›s
 
	gnvme_fc_mq_›s
 = {

2403 .
queue_rq
 = 
nvme_fc_queue_rq
,

2404 .
	gcom∂ëe
 = 
nvme_fc_com∂ëe_rq
,

2405 .
	göô_ªque°
 = 
nvme_fc_öô_ªque°
,

2406 .
	gexô_ªque°
 = 
nvme_fc_exô_ªque°
,

2407 .
	göô_h˘x
 = 
nvme_fc_öô_h˘x
,

2408 .
	gtimeout
 = 
nvme_fc_timeout
,

2412 
	$nvme_fc_¸óã_io_queues
(
nvme_fc_˘æ
 *
˘æ
)

2414 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->ctrl.opts;

2415 
ƒ_io_queues
;

2416 
ªt
;

2418 
ƒ_io_queues
 = 
	`mö
(mö(
›ts
->ƒ_io_queues, 
	`num_⁄löe_˝us
()),

2419 
˘æ
->
Õ‹t
->
›s
->
max_hw_queues
);

2420 
ªt
 = 
	`nvme_£t_queue_cou¡
(&
˘æ
->˘æ, &
ƒ_io_queues
);

2421 i‡(
ªt
) {

2422 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2423 "£t_queue_cou¡ faûed: %d\n", 
ªt
);

2424  
ªt
;

2427 
˘æ
->˘æ.
queue_cou¡
 = 
ƒ_io_queues
 + 1;

2428 i‡(!
ƒ_io_queues
)

2431 
	`nvme_fc_öô_io_queues
(
˘æ
);

2433 
	`mem£t
(&
˘æ
->
èg_£t
, 0, (ctrl->tag_set));

2434 
˘æ
->
èg_£t
.
›s
 = &
nvme_fc_mq_›s
;

2435 
˘æ
->
èg_£t
.
queue_dïth
 = cål->˘æ.
›ts
->
queue_size
;

2436 
˘æ
->
èg_£t
.
ª£rved_ègs
 = 1;

2437 
˘æ
->
èg_£t
.
numa_node
 = ctrl->ctrl.numa_node;

2438 
˘æ
->
èg_£t
.
Êags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2439 
˘æ
->
èg_£t
.
cmd_size
 =

2440 
	`°ru˘_size
((
nvme_f˝_›_w_sgl
 *)
NULL
, 
¥iv
,

2441 
˘æ
->
Õ‹t
->
›s
->
f˝rq°_¥iv_sz
);

2442 
˘æ
->
èg_£t
.
drivî_d©a
 = ctrl;

2443 
˘æ
->
èg_£t
.
ƒ_hw_queues
 = cål->˘æ.
queue_cou¡
 - 1;

2444 
˘æ
->
èg_£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2446 
ªt
 = 
	`blk_mq_Æloc_èg_£t
(&
˘æ
->
èg_£t
);

2447 i‡(
ªt
)

2448  
ªt
;

2450 
˘æ
->˘æ.
èg£t
 = &˘æ->
èg_£t
;

2452 
˘æ
->˘æ.
c⁄√˘_q
 = 
	`blk_mq_öô_queue
(&˘æ->
èg_£t
);

2453 i‡(
	`IS_ERR
(
˘æ
->˘æ.
c⁄√˘_q
)) {

2454 
ªt
 = 
	`PTR_ERR
(
˘æ
->˘æ.
c⁄√˘_q
);

2455 
out_‰ì_èg_£t
;

2458 
ªt
 = 
	`nvme_fc_¸óã_hw_io_queues
(
˘æ
, cål->˘æ.
sqsize
 + 1);

2459 i‡(
ªt
)

2460 
out_˛ónup_blk_queue
;

2462 
ªt
 = 
	`nvme_fc_c⁄√˘_io_queues
(
˘æ
, cål->˘æ.
sqsize
 + 1);

2463 i‡(
ªt
)

2464 
out_dñëe_hw_queues
;

2466 
˘æ
->
ioq_live
 = 
åue
;

2470 
out_dñëe_hw_queues
:

2471 
	`nvme_fc_dñëe_hw_io_queues
(
˘æ
);

2472 
out_˛ónup_blk_queue
:

2473 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
c⁄√˘_q
);

2474 
out_‰ì_èg_£t
:

2475 
	`blk_mq_‰ì_èg_£t
(&
˘æ
->
èg_£t
);

2476 
	`nvme_fc_‰ì_io_queues
(
˘æ
);

2479 
˘æ
->˘æ.
èg£t
 = 
NULL
;

2481  
ªt
;

2482 
	}
}

2485 
	$nvme_fc_ª¸óã_io_queues
(
nvme_fc_˘æ
 *
˘æ
)

2487 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->ctrl.opts;

2488 
u32
 
¥i‹_ioq_˙t
 = 
˘æ
->˘æ.
queue_cou¡
 - 1;

2489 
ƒ_io_queues
;

2490 
ªt
;

2492 
ƒ_io_queues
 = 
	`mö
(mö(
›ts
->ƒ_io_queues, 
	`num_⁄löe_˝us
()),

2493 
˘æ
->
Õ‹t
->
›s
->
max_hw_queues
);

2494 
ªt
 = 
	`nvme_£t_queue_cou¡
(&
˘æ
->˘æ, &
ƒ_io_queues
);

2495 i‡(
ªt
) {

2496 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2497 "£t_queue_cou¡ faûed: %d\n", 
ªt
);

2498  
ªt
;

2501 i‡(!
ƒ_io_queues
 && 
¥i‹_ioq_˙t
) {

2502 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2504 "ªquúed (wa†%d)\n", 
¥i‹_ioq_˙t
);

2505  -
ENOSPC
;

2508 
˘æ
->˘æ.
queue_cou¡
 = 
ƒ_io_queues
 + 1;

2510 i‡(
˘æ
->˘æ.
queue_cou¡
 == 1)

2513 
ªt
 = 
	`nvme_fc_¸óã_hw_io_queues
(
˘æ
, cål->˘æ.
sqsize
 + 1);

2514 i‡(
ªt
)

2515 
out_‰ì_io_queues
;

2517 
ªt
 = 
	`nvme_fc_c⁄√˘_io_queues
(
˘æ
, cål->˘æ.
sqsize
 + 1);

2518 i‡(
ªt
)

2519 
out_dñëe_hw_queues
;

2521 i‡(
¥i‹_ioq_˙t
 !
ƒ_io_queues
)

2522 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2524 
¥i‹_ioq_˙t
, 
ƒ_io_queues
);

2525 
	`blk_mq_upd©e_ƒ_hw_queues
(&
˘æ
->
èg_£t
, 
ƒ_io_queues
);

2529 
out_dñëe_hw_queues
:

2530 
	`nvme_fc_dñëe_hw_io_queues
(
˘æ
);

2531 
out_‰ì_io_queues
:

2532 
	`nvme_fc_‰ì_io_queues
(
˘æ
);

2533  
ªt
;

2534 
	}
}

2537 
	$nvme_fc_Ω‹t_a˘ive_⁄_Õ‹t
(
nvme_fc_Ω‹t
 *
Ω‹t
)

2539 
nvme_fc_Õ‹t
 *
Õ‹t
 = 
Ω‹t
->lport;

2541 
	`©omic_öc
(&
Õ‹t
->
a˘_Ω‹t_˙t
);

2542 
	}
}

2545 
	$nvme_fc_Ω‹t_öa˘ive_⁄_Õ‹t
(
nvme_fc_Ω‹t
 *
Ω‹t
)

2547 
nvme_fc_Õ‹t
 *
Õ‹t
 = 
Ω‹t
->lport;

2548 
u32
 
˙t
;

2550 
˙t
 = 
	`©omic_dec_ªtu∫
(&
Õ‹t
->
a˘_Ω‹t_˙t
);

2551 i‡(
˙t
 =0 && 
Õ‹t
->
loˇÕ‹t
.
p‹t_°©e
 =
FC_OBJSTATE_DELETED
)

2552 
Õ‹t
->
›s
->
	`loˇÕ‹t_dñëe
(&Õ‹t->
loˇÕ‹t
);

2553 
	}
}

2556 
	$nvme_fc_˘Ã_a˘ive_⁄_Ω‹t
(
nvme_fc_˘æ
 *
˘æ
)

2558 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
˘æ
->rport;

2559 
u32
 
˙t
;

2561 i‡(
˘æ
->
assoc_a˘ive
)

2564 
˘æ
->
assoc_a˘ive
 = 
åue
;

2565 
˙t
 = 
	`©omic_öc_ªtu∫
(&
Ω‹t
->
a˘_˘æ_˙t
);

2566 i‡(
˙t
 == 1)

2567 
	`nvme_fc_Ω‹t_a˘ive_⁄_Õ‹t
(
Ω‹t
);

2570 
	}
}

2573 
	$nvme_fc_˘Ã_öa˘ive_⁄_Ω‹t
(
nvme_fc_˘æ
 *
˘æ
)

2575 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
˘æ
->rport;

2576 
nvme_fc_Õ‹t
 *
Õ‹t
 = 
Ω‹t
->lport;

2577 
u32
 
˙t
;

2581 
˙t
 = 
	`©omic_dec_ªtu∫
(&
Ω‹t
->
a˘_˘æ_˙t
);

2582 i‡(
˙t
 == 0) {

2583 i‡(
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 =
FC_OBJSTATE_DELETED
)

2584 
Õ‹t
->
›s
->
	`ªmŸï‹t_dñëe
(&
Ω‹t
->
ªmŸï‹t
);

2585 
	`nvme_fc_Ω‹t_öa˘ive_⁄_Õ‹t
(
Ω‹t
);

2589 
	}
}

2596 
	$nvme_fc_¸óã_assocüti⁄
(
nvme_fc_˘æ
 *
˘æ
)

2598 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->ctrl.opts;

2599 
ªt
;

2600 
boﬁ
 
ch™ged
;

2602 ++
˘æ
->˘æ.
ƒ_ªc⁄√˘s
;

2604 i‡(
˘æ
->
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 !
FC_OBJSTATE_ONLINE
)

2605  -
ENODEV
;

2607 i‡(
	`nvme_fc_˘Ã_a˘ive_⁄_Ω‹t
(
˘æ
))

2608  -
ENOTUNIQ
;

2614 
ªt
 = 
	`__nvme_fc_¸óã_hw_queue
(
˘æ
, &˘æ->
queues
[0], 0,

2615 
NVME_AQ_DEPTH
);

2616 i‡(
ªt
)

2617 
out_‰ì_queue
;

2619 
ªt
 = 
	`nvme_fc_c⁄√˘_admö_queue
(
˘æ
, &˘æ->
queues
[0],

2620 
NVME_AQ_DEPTH
, (NVME_AQ_DEPTH / 4));

2621 i‡(
ªt
)

2622 
out_dñëe_hw_queue
;

2624 
	`blk_mq_unquõs˚_queue
(
˘æ
->˘æ.
admö_q
);

2626 
ªt
 = 
	`nvmf_c⁄√˘_admö_queue
(&
˘æ
->ctrl);

2627 i‡(
ªt
)

2628 
out_disc⁄√˘_admö_queue
;

2630 
	`£t_bô
(
NVME_FC_Q_LIVE
, &
˘æ
->
queues
[0].
Êags
);

2639 
ªt
 = 
	`nvmf_ªg_ªad64
(&
˘æ
->˘æ, 
NVME_REG_CAP
, &˘æ->˘æ.
ˇp
);

2640 i‡(
ªt
) {

2641 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

2643 
out_disc⁄√˘_admö_queue
;

2646 
˘æ
->˘æ.
sqsize
 =

2647 
	`mö_t
(, 
	`NVME_CAP_MQES
(
˘æ
->˘æ.
ˇp
), cål->˘æ.
sqsize
);

2649 
ªt
 = 
	`nvme_íabÀ_˘æ
(&
˘æ
->˘æ, cål->˘æ.
ˇp
);

2650 i‡(
ªt
)

2651 
out_disc⁄√˘_admö_queue
;

2653 
˘æ
->˘æ.
max_hw_£˘‹s
 =

2654 (
˘æ
->
Õ‹t
->
›s
->
max_sgl_£gmíts
 - 1Ë<< (
PAGE_SHIFT
 - 9);

2656 
ªt
 = 
	`nvme_öô_idítify
(&
˘æ
->ctrl);

2657 i‡(
ªt
)

2658 
out_disc⁄√˘_admö_queue
;

2663 i‡(
˘æ
->˘æ.
icdoff
) {

2664 
	`dev_îr
(
˘æ
->˘æ.
devi˚
, "icdoff %d isÇot supported!\n",

2665 
˘æ
->˘æ.
icdoff
);

2666 
out_disc⁄√˘_admö_queue
;

2671 i‡(
›ts
->
queue_size
 > 
˘æ
->˘æ.
maxcmd
) {

2673 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2676 
›ts
->
queue_size
, 
˘æ
->˘æ.
maxcmd
);

2677 
›ts
->
queue_size
 = 
˘æ
->˘æ.
maxcmd
;

2680 i‡(
›ts
->
queue_size
 > 
˘æ
->˘æ.
sqsize
 + 1) {

2682 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2684 
›ts
->
queue_size
, 
˘æ
->˘æ.
sqsize
 + 1);

2685 
›ts
->
queue_size
 = 
˘æ
->˘æ.
sqsize
 + 1;

2688 
ªt
 = 
	`nvme_fc_öô_´n_›s
(
˘æ
);

2689 i‡(
ªt
)

2690 
out_ãrm_´n_›s
;

2696 i‡(
˘æ
->˘æ.
queue_cou¡
 > 1) {

2697 i‡(!
˘æ
->
ioq_live
)

2698 
ªt
 = 
	`nvme_fc_¸óã_io_queues
(
˘æ
);

2700 
ªt
 = 
	`nvme_fc_ª¸óã_io_queues
(
˘æ
);

2701 i‡(
ªt
)

2702 
out_ãrm_´n_›s
;

2705 
ch™ged
 = 
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_LIVE
);

2707 
˘æ
->˘æ.
ƒ_ªc⁄√˘s
 = 0;

2709 i‡(
ch™ged
)

2710 
	`nvme_°¨t_˘æ
(&
˘æ
->ctrl);

2714 
out_ãrm_´n_›s
:

2715 
	`nvme_fc_ãrm_´n_›s
(
˘æ
);

2716 
out_disc⁄√˘_admö_queue
:

2718 
	`nvme_fc_xmt_disc⁄√˘_assoc
(
˘æ
);

2719 
out_dñëe_hw_queue
:

2720 
	`__nvme_fc_dñëe_hw_queue
(
˘æ
, &˘æ->
queues
[0], 0);

2721 
out_‰ì_queue
:

2722 
	`nvme_fc_‰ì_queue
(&
˘æ
->
queues
[0]);

2723 
˘æ
->
assoc_a˘ive
 = 
Ál£
;

2724 
	`nvme_fc_˘Ã_öa˘ive_⁄_Ω‹t
(
˘æ
);

2726  
ªt
;

2727 
	}
}

2736 
	$nvme_fc_dñëe_assocüti⁄
(
nvme_fc_˘æ
 *
˘æ
)

2738 
Êags
;

2740 i‡(!
˘æ
->
assoc_a˘ive
)

2742 
˘æ
->
assoc_a˘ive
 = 
Ál£
;

2744 
	`•ö_lock_úqßve
(&
˘æ
->
lock
, 
Êags
);

2745 
˘æ
->
Êags
 |
FCCTRL_TERMIO
;

2746 
˘æ
->
io˙t
 = 0;

2747 
	`•ö_u∆ock_úqª°‹e
(&
˘æ
->
lock
, 
Êags
);

2761 i‡(
˘æ
->˘æ.
queue_cou¡
 > 1) {

2762 
	`nvme_°›_queues
(&
˘æ
->ctrl);

2763 
	`blk_mq_èg£t_busy_ôî
(&
˘æ
->
èg_£t
,

2764 
nvme_fc_ãrmö©e_exch™ge
, &
˘æ
->ctrl);

2784 
	`blk_mq_quõs˚_queue
(
˘æ
->˘æ.
admö_q
);

2785 
	`blk_mq_èg£t_busy_ôî
(&
˘æ
->
admö_èg_£t
,

2786 
nvme_fc_ãrmö©e_exch™ge
, &
˘æ
->ctrl);

2789 
	`nvme_fc_ab‹t_´n_›s
(
˘æ
);

2792 
	`•ö_lock_úq
(&
˘æ
->
lock
);

2793 
	`waô_evít_lock_úq
(
˘æ
->
iﬂb‹t_waô
, cål->
io˙t
 =0, cål->
lock
);

2794 
˘æ
->
Êags
 &~
FCCTRL_TERMIO
;

2795 
	`•ö_u∆ock_úq
(&
˘æ
->
lock
);

2797 
	`nvme_fc_ãrm_´n_›s
(
˘æ
);

2805 i‡(
˘æ
->
assocüti⁄_id
)

2806 
	`nvme_fc_xmt_disc⁄√˘_assoc
(
˘æ
);

2808 i‡(
˘æ
->˘æ.
èg£t
) {

2809 
	`nvme_fc_dñëe_hw_io_queues
(
˘æ
);

2810 
	`nvme_fc_‰ì_io_queues
(
˘æ
);

2813 
	`__nvme_fc_dñëe_hw_queue
(
˘æ
, &˘æ->
queues
[0], 0);

2814 
	`nvme_fc_‰ì_queue
(&
˘æ
->
queues
[0]);

2817 
	`blk_mq_unquõs˚_queue
(
˘æ
->˘æ.
admö_q
);

2820 
	`nvme_°¨t_queues
(&
˘æ
->ctrl);

2822 
	`nvme_fc_˘Ã_öa˘ive_⁄_Ω‹t
(
˘æ
);

2823 
	}
}

2826 
	$nvme_fc_dñëe_˘æ
(
nvme_˘æ
 *
n˘æ
)

2828 
nvme_fc_˘æ
 *
˘æ
 = 
	`to_fc_˘æ
(
n˘æ
);

2830 
	`ˇn˚l_w‹k_sync
(&
˘æ
->
îr_w‹k
);

2831 
	`ˇn˚l_dñayed_w‹k_sync
(&
˘æ
->
c⁄√˘_w‹k
);

2836 
	`nvme_fc_dñëe_assocüti⁄
(
˘æ
);

2837 
	}
}

2840 
	$nvme_fc_ªc⁄√˘_‹_dñëe
(
nvme_fc_˘æ
 *
˘æ
, 
°©us
)

2842 
nvme_fc_Ω‹t
 *
Ω‹t
 = 
˘æ
->rport;

2843 
nvme_fc_ªmŸe_p‹t
 *
p‹çå
 = &
Ω‹t
->
ªmŸï‹t
;

2844 
ªc⁄_dñay
 = 
˘æ
->˘æ.
›ts
->
ªc⁄√˘_dñay
 * 
HZ
;

2845 
boﬁ
 
ªc⁄
 = 
åue
;

2847 i‡(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_CONNECTING
)

2850 i‡(
p‹çå
->
p‹t_°©e
 =
FC_OBJSTATE_ONLINE
)

2851 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2853 
˘æ
->
˙um
, 
°©us
);

2854 i‡(
	`time_a·î_eq
(
jiffõs
, 
Ω‹t
->
dev_loss_íd
))

2855 
ªc⁄
 = 
Ál£
;

2857 i‡(
ªc⁄
 && 
	`nvmf_should_ªc⁄√˘
(&
˘æ
->ctrl)) {

2858 i‡(
p‹çå
->
p‹t_°©e
 =
FC_OBJSTATE_ONLINE
)

2859 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2862 
˘æ
->
˙um
, 
ªc⁄_dñay
 / 
HZ
);

2863 i‡(
	`time_a·î
(
jiffõs
 + 
ªc⁄_dñay
, 
Ω‹t
->
dev_loss_íd
))

2864 
ªc⁄_dñay
 = 
Ω‹t
->
dev_loss_íd
 - 
jiffõs
;

2866 
	`queue_dñayed_w‹k
(
nvme_wq
, &
˘æ
->
c⁄√˘_w‹k
, 
ªc⁄_dñay
);

2868 i‡(
p‹çå
->
p‹t_°©e
 =
FC_OBJSTATE_ONLINE
)

2869 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2872 
˘æ
->
˙um
, cål->˘æ.
ƒ_ªc⁄√˘s
);

2874 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2877 
˘æ
->
˙um
, 
p‹çå
->
dev_loss_tmo
);

2878 
	`WARN_ON
(
	`nvme_dñëe_˘æ
(&
˘æ
->ctrl));

2880 
	}
}

2883 
	$__nvme_fc_ãrmö©e_io
(
nvme_fc_˘æ
 *
˘æ
)

2885 
	`nvme_°›_kìp_Æive
(&
˘æ
->ctrl);

2888 
	`nvme_fc_dñëe_assocüti⁄
(
˘æ
);

2890 i‡(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_CONNECTING
 &&

2891 !
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_CONNECTING
))

2892 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

2894 "tÿCONNECTING\n", 
˘æ
->
˙um
);

2895 
	}
}

2898 
	$nvme_fc_ª£t_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2900 
nvme_fc_˘æ
 *
˘æ
 =

2901 
	`c⁄èöî_of
(
w‹k
, 
nvme_fc_˘æ
, 
˘æ
.
ª£t_w‹k
);

2902 
ªt
;

2904 
	`__nvme_fc_ãrmö©e_io
(
˘æ
);

2906 
	`nvme_°›_˘æ
(&
˘æ
->ctrl);

2908 i‡(
˘æ
->
Ω‹t
->
ªmŸï‹t
.
p‹t_°©e
 =
FC_OBJSTATE_ONLINE
)

2909 
ªt
 = 
	`nvme_fc_¸óã_assocüti⁄
(
˘æ
);

2911 
ªt
 = -
ENOTCONN
;

2913 i‡(
ªt
)

2914 
	`nvme_fc_ªc⁄√˘_‹_dñëe
(
˘æ
, 
ªt
);

2916 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2918 
˘æ
->
˙um
);

2919 
	}
}

2922 
	$nvme_fc_c⁄√˘_îr_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2924 
nvme_fc_˘æ
 *
˘æ
 =

2925 
	`c⁄èöî_of
(
w‹k
, 
nvme_fc_˘æ
, 
îr_w‹k
);

2927 
	`__nvme_fc_ãrmö©e_io
(
˘æ
);

2929 
	`©omic_£t
(&
˘æ
->
îr_w‹k_a˘ive
, 0);

2937 
	}
}

2939 c⁄° 
nvme_˘æ_›s
 
	gnvme_fc_˘æ_›s
 = {

2940 .
«me
 = "fc",

2941 .
	gmoduÀ
 = 
THIS_MODULE
,

2942 .
	gÊags
 = 
NVME_F_FABRICS
,

2943 .
	gªg_ªad32
 = 
nvmf_ªg_ªad32
,

2944 .
	gªg_ªad64
 = 
nvmf_ªg_ªad64
,

2945 .
	gªg_wrôe32
 = 
nvmf_ªg_wrôe32
,

2946 .
	g‰ì_˘æ
 = 
nvme_fc_nvme_˘æ_‰ìd
,

2947 .
	gsubmô_async_evít
 = 
nvme_fc_submô_async_evít
,

2948 .
	gdñëe_˘æ
 = 
nvme_fc_dñëe_˘æ
,

2949 .
	ggë_addªss
 = 
nvmf_gë_addªss
,

2953 
	$nvme_fc_c⁄√˘_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2955 
ªt
;

2957 
nvme_fc_˘æ
 *
˘æ
 =

2958 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w‹k
),

2959 
nvme_fc_˘æ
, 
c⁄√˘_w‹k
);

2961 
ªt
 = 
	`nvme_fc_¸óã_assocüti⁄
(
˘æ
);

2962 i‡(
ªt
)

2963 
	`nvme_fc_ªc⁄√˘_‹_dñëe
(
˘æ
, 
ªt
);

2965 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2967 
˘æ
->
˙um
);

2968 
	}
}

2971 c⁄° 
blk_mq_›s
 
	gnvme_fc_admö_mq_›s
 = {

2972 .
queue_rq
 = 
nvme_fc_queue_rq
,

2973 .
	gcom∂ëe
 = 
nvme_fc_com∂ëe_rq
,

2974 .
	göô_ªque°
 = 
nvme_fc_öô_ªque°
,

2975 .
	gexô_ªque°
 = 
nvme_fc_exô_ªque°
,

2976 .
	göô_h˘x
 = 
nvme_fc_öô_admö_h˘x
,

2977 .
	gtimeout
 = 
nvme_fc_timeout
,

2989 
boﬁ


2990 
	$nvme_fc_exi°ög_c⁄åﬁÀr
(
nvme_fc_Ω‹t
 *
Ω‹t
,

2991 
nvmf_˘æ_›ti⁄s
 *
›ts
)

2993 
nvme_fc_˘æ
 *
˘æ
;

2994 
Êags
;

2995 
boﬁ
 
found
 = 
Ál£
;

2997 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

2998 
	`li°_f‹_óch_íåy
(
˘æ
, &
Ω‹t
->
˘æ_li°
, ctrl_list) {

2999 
found
 = 
	`nvmf_˘Ã_m©ches_ba£›ts
(&
˘æ
->˘æ, 
›ts
);

3000 i‡(
found
)

3003 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

3005  
found
;

3006 
	}
}

3008 
nvme_˘æ
 *

3009 
	$nvme_fc_öô_˘æ
(
devi˚
 *
dev
, 
nvmf_˘æ_›ti⁄s
 *
›ts
,

3010 
nvme_fc_Õ‹t
 *
Õ‹t
, 
nvme_fc_Ω‹t
 *
Ω‹t
)

3012 
nvme_fc_˘æ
 *
˘æ
;

3013 
Êags
;

3014 
ªt
, 
idx
;

3016 i‡(!(
Ω‹t
->
ªmŸï‹t
.
p‹t_rﬁe
 &

3017 (
FC_PORT_ROLE_NVME_DISCOVERY
 | 
FC_PORT_ROLE_NVME_TARGET
))) {

3018 
ªt
 = -
EBADR
;

3019 
out_Áû
;

3022 i‡(!
›ts
->
du∂iˇã_c⁄√˘
 &&

3023 
	`nvme_fc_exi°ög_c⁄åﬁÀr
(
Ω‹t
, 
›ts
)) {

3024 
ªt
 = -
EALREADY
;

3025 
out_Áû
;

3028 
˘æ
 = 
	`kzÆloc
((*˘æ), 
GFP_KERNEL
);

3029 i‡(!
˘æ
) {

3030 
ªt
 = -
ENOMEM
;

3031 
out_Áû
;

3034 
idx
 = 
	`ida_sim∂e_gë
(&
nvme_fc_˘æ_˙t
, 0, 0, 
GFP_KERNEL
);

3035 i‡(
idx
 < 0) {

3036 
ªt
 = -
ENOSPC
;

3037 
out_‰ì_˘æ
;

3040 
˘æ
->˘æ.
›ts
 = opts;

3041 
˘æ
->˘æ.
ƒ_ªc⁄√˘s
 = 0;

3042 i‡(
Õ‹t
->
dev
)

3043 
˘æ
->˘æ.
numa_node
 = 
	`dev_to_node
(
Õ‹t
->
dev
);

3045 
˘æ
->˘æ.
numa_node
 = 
NUMA_NO_NODE
;

3046 
	`INIT_LIST_HEAD
(&
˘æ
->
˘æ_li°
);

3047 
˘æ
->
Õ‹t
 =Üport;

3048 
˘æ
->
Ω‹t
 =Ñport;

3049 
˘æ
->
dev
 = 
Õ‹t
->dev;

3050 
˘æ
->
˙um
 = 
idx
;

3051 
˘æ
->
ioq_live
 = 
Ál£
;

3052 
˘æ
->
assoc_a˘ive
 = 
Ál£
;

3053 
	`©omic_£t
(&
˘æ
->
îr_w‹k_a˘ive
, 0);

3054 
	`öô_waôqueue_hód
(&
˘æ
->
iﬂb‹t_waô
);

3056 
	`gë_devi˚
(
˘æ
->
dev
);

3057 
	`kªf_öô
(&
˘æ
->
ªf
);

3059 
	`INIT_WORK
(&
˘æ
->˘æ.
ª£t_w‹k
, 
nvme_fc_ª£t_˘æ_w‹k
);

3060 
	`INIT_DELAYED_WORK
(&
˘æ
->
c⁄√˘_w‹k
, 
nvme_fc_c⁄√˘_˘æ_w‹k
);

3061 
	`INIT_WORK
(&
˘æ
->
îr_w‹k
, 
nvme_fc_c⁄√˘_îr_w‹k
);

3062 
	`•ö_lock_öô
(&
˘æ
->
lock
);

3065 
˘æ
->˘æ.
queue_cou¡
 = 
	`mö_t
(,

3066 
›ts
->
ƒ_io_queues
,

3067 
Õ‹t
->
›s
->
max_hw_queues
);

3068 
˘æ
->˘æ.
queue_cou¡
++;

3070 
˘æ
->˘æ.
sqsize
 = 
›ts
->
queue_size
 - 1;

3071 
˘æ
->˘æ.
k©o
 = 
›ts
->kato;

3072 
˘æ
->˘æ.
˙éid
 = 0xffff;

3074 
ªt
 = -
ENOMEM
;

3075 
˘æ
->
queues
 = 
	`kˇŒoc
(˘æ->˘æ.
queue_cou¡
,

3076 (
nvme_fc_queue
), 
GFP_KERNEL
);

3077 i‡(!
˘æ
->
queues
)

3078 
out_‰ì_ida
;

3080 
	`nvme_fc_öô_queue
(
˘æ
, 0);

3082 
	`mem£t
(&
˘æ
->
admö_èg_£t
, 0, (ctrl->admin_tag_set));

3083 
˘æ
->
admö_èg_£t
.
›s
 = &
nvme_fc_admö_mq_›s
;

3084 
˘æ
->
admö_èg_£t
.
queue_dïth
 = 
NVME_AQ_MQ_TAG_DEPTH
;

3085 
˘æ
->
admö_èg_£t
.
ª£rved_ègs
 = 2;

3086 
˘æ
->
admö_èg_£t
.
numa_node
 = ctrl->ctrl.numa_node;

3087 
˘æ
->
admö_èg_£t
.
cmd_size
 =

3088 
	`°ru˘_size
((
nvme_f˝_›_w_sgl
 *)
NULL
, 
¥iv
,

3089 
˘æ
->
Õ‹t
->
›s
->
f˝rq°_¥iv_sz
);

3090 
˘æ
->
admö_èg_£t
.
drivî_d©a
 = ctrl;

3091 
˘æ
->
admö_èg_£t
.
ƒ_hw_queues
 = 1;

3092 
˘æ
->
admö_èg_£t
.
timeout
 = 
ADMIN_TIMEOUT
;

3093 
˘æ
->
admö_èg_£t
.
Êags
 = 
BLK_MQ_F_NO_SCHED
;

3095 
ªt
 = 
	`blk_mq_Æloc_èg_£t
(&
˘æ
->
admö_èg_£t
);

3096 i‡(
ªt
)

3097 
out_‰ì_queues
;

3098 
˘æ
->˘æ.
admö_èg£t
 = &˘æ->
admö_èg_£t
;

3100 
˘æ
->˘æ.
admö_q
 = 
	`blk_mq_öô_queue
(&˘æ->
admö_èg_£t
);

3101 i‡(
	`IS_ERR
(
˘æ
->˘æ.
admö_q
)) {

3102 
ªt
 = 
	`PTR_ERR
(
˘æ
->˘æ.
admö_q
);

3103 
out_‰ì_admö_èg_£t
;

3113 
ªt
 = 
	`nvme_öô_˘æ
(&
˘æ
->˘æ, 
dev
, &
nvme_fc_˘æ_›s
, 0);

3114 i‡(
ªt
)

3115 
out_˛ónup_admö_q
;

3119 
	`•ö_lock_úqßve
(&
Ω‹t
->
lock
, 
Êags
);

3120 
	`li°_add_èû
(&
˘æ
->
˘æ_li°
, &
Ω‹t
->ctrl_list);

3121 
	`•ö_u∆ock_úqª°‹e
(&
Ω‹t
->
lock
, 
Êags
);

3123 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_RESETTING
) ||

3124 !
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_CONNECTING
)) {

3125 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

3126 "NVME-FC{%d}: faûedÅÿöô cå»°©e\n", 
˘æ
->
˙um
);

3127 
Áû_˘æ
;

3130 
	`nvme_gë_˘æ
(&
˘æ
->ctrl);

3132 i‡(!
	`queue_dñayed_w‹k
(
nvme_wq
, &
˘æ
->
c⁄√˘_w‹k
, 0)) {

3133 
	`nvme_put_˘æ
(&
˘æ
->ctrl);

3134 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

3136 
˘æ
->
˙um
);

3137 
Áû_˘æ
;

3140 
	`Êush_dñayed_w‹k
(&
˘æ
->
c⁄√˘_w‹k
);

3142 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

3144 
˘æ
->
˙um
, cål->˘æ.
›ts
->
subsy¢qn
);

3146  &
˘æ
->ctrl;

3148 
Áû_˘æ
:

3149 
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_DELETING
);

3150 
	`ˇn˚l_w‹k_sync
(&
˘æ
->˘æ.
ª£t_w‹k
);

3151 
	`ˇn˚l_w‹k_sync
(&
˘æ
->
îr_w‹k
);

3152 
	`ˇn˚l_dñayed_w‹k_sync
(&
˘æ
->
c⁄√˘_w‹k
);

3154 
˘æ
->˘æ.
›ts
 = 
NULL
;

3157 
	`nvme_unöô_˘æ
(&
˘æ
->ctrl);

3160 
	`nvme_put_˘æ
(&
˘æ
->ctrl);

3169 
	`nvme_fc_Ω‹t_gë
(
Ω‹t
);

3171  
	`ERR_PTR
(-
EIO
);

3173 
out_˛ónup_admö_q
:

3174 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
admö_q
);

3175 
out_‰ì_admö_èg_£t
:

3176 
	`blk_mq_‰ì_èg_£t
(&
˘æ
->
admö_èg_£t
);

3177 
out_‰ì_queues
:

3178 
	`k‰ì
(
˘æ
->
queues
);

3179 
out_‰ì_ida
:

3180 
	`put_devi˚
(
˘æ
->
dev
);

3181 
	`ida_sim∂e_ªmove
(&
nvme_fc_˘æ_˙t
, 
˘æ
->
˙um
);

3182 
out_‰ì_˘æ
:

3183 
	`k‰ì
(
˘æ
);

3184 
out_Áû
:

3186  
	`ERR_PTR
(
ªt
);

3187 
	}
}

3190 
	snvmë_fc_åaddr
 {

3191 
u64
 
	m¬
;

3192 
u64
 
	m≤
;

3196 
	$__nvme_fc_∑r£_u64
(
sub°rög_t
 *
s°r
, 
u64
 *
vÆ
)

3198 
u64
 
tokí64
;

3200 i‡(
	`m©ch_u64
(
s°r
, &
tokí64
))

3201  -
EINVAL
;

3202 *
vÆ
 = 
tokí64
;

3205 
	}
}

3213 
	$nvme_fc_∑r£_åaddr
(
nvmë_fc_åaddr
 *
åaddr
, *
buf
, 
size_t
 
bÀn
)

3215 
«me
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
 + 1];

3216 
sub°rög_t
 
wwn
 = { 
«me
, &name[(name)-1] };

3217 
¬off£t
, 
≤off£t
;

3220 i‡(
	`°∫Àn
(
buf
, 
bÀn
Ë=
NVME_FC_TRADDR_MAXLENGTH
 &&

3221 !
	`°∫cmp
(
buf
, "¬-0x", 
NVME_FC_TRADDR_OXNNLEN
) &&

3222 !
	`°∫cmp
(&
buf
[
NVME_FC_TRADDR_MAX_PN_OFFSET
],

3223 "≤-0x", 
NVME_FC_TRADDR_OXNNLEN
)) {

3224 
¬off£t
 = 
NVME_FC_TRADDR_OXNNLEN
;

3225 
≤off£t
 = 
NVME_FC_TRADDR_MAX_PN_OFFSET
 +

3226 
NVME_FC_TRADDR_OXNNLEN
;

3227 } i‡((
	`°∫Àn
(
buf
, 
bÀn
Ë=
NVME_FC_TRADDR_MINLENGTH
 &&

3228 !
	`°∫cmp
(
buf
, "¬-", 
NVME_FC_TRADDR_NNLEN
) &&

3229 !
	`°∫cmp
(&
buf
[
NVME_FC_TRADDR_MIN_PN_OFFSET
],

3230 "≤-", 
NVME_FC_TRADDR_NNLEN
))) {

3231 
¬off£t
 = 
NVME_FC_TRADDR_NNLEN
;

3232 
≤off£t
 = 
NVME_FC_TRADDR_MIN_PN_OFFSET
 + 
NVME_FC_TRADDR_NNLEN
;

3234 
out_eövÆ
;

3236 
«me
[0] = '0';

3237 
«me
[1] = 'x';

3238 
«me
[2 + 
NVME_FC_TRADDR_HEXNAMELEN
] = 0;

3240 
	`mem˝y
(&
«me
[2], &
buf
[
¬off£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

3241 i‡(
	`__nvme_fc_∑r£_u64
(&
wwn
, &
åaddr
->
¬
))

3242 
out_eövÆ
;

3244 
	`mem˝y
(&
«me
[2], &
buf
[
≤off£t
], 
NVME_FC_TRADDR_HEXNAMELEN
);

3245 i‡(
	`__nvme_fc_∑r£_u64
(&
wwn
, &
åaddr
->
≤
))

3246 
out_eövÆ
;

3250 
out_eövÆ
:

3251 
	`¥_w¨n
("%s: badÅødd∏°rög\n", 
__func__
);

3252  -
EINVAL
;

3253 
	}
}

3255 
nvme_˘æ
 *

3256 
	$nvme_fc_¸óã_˘æ
(
devi˚
 *
dev
, 
nvmf_˘æ_›ti⁄s
 *
›ts
)

3258 
nvme_fc_Õ‹t
 *
Õ‹t
;

3259 
nvme_fc_Ω‹t
 *
Ω‹t
;

3260 
nvme_˘æ
 *
˘æ
;

3261 
nvmë_fc_åaddr
 
œddr
 = { 0L, 0L };

3262 
nvmë_fc_åaddr
 
øddr
 = { 0L, 0L };

3263 
Êags
;

3264 
ªt
;

3266 
ªt
 = 
	`nvme_fc_∑r£_åaddr
(&
øddr
, 
›ts
->
åaddr
, 
NVMF_TRADDR_SIZE
);

3267 i‡(
ªt
 || !
øddr
.
¬
 || !øddr.
≤
)

3268  
	`ERR_PTR
(-
EINVAL
);

3270 
ªt
 = 
	`nvme_fc_∑r£_åaddr
(&
œddr
, 
›ts
->
ho°_åaddr
, 
NVMF_TRADDR_SIZE
);

3271 i‡(
ªt
 || !
œddr
.
¬
 || !œddr.
≤
)

3272  
	`ERR_PTR
(-
EINVAL
);

3275 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

3276 
	`li°_f‹_óch_íåy
(
Õ‹t
, &
nvme_fc_Õ‹t_li°
, 
p‹t_li°
) {

3277 i‡(
Õ‹t
->
loˇÕ‹t
.
node_«me
 !
œddr
.
¬
 ||

3278 
Õ‹t
->
loˇÕ‹t
.
p‹t_«me
 !
œddr
.
≤
)

3281 
	`li°_f‹_óch_íåy
(
Ω‹t
, &
Õ‹t
->
ídp_li°
,Éndp_list) {

3282 i‡(
Ω‹t
->
ªmŸï‹t
.
node_«me
 !
øddr
.
¬
 ||

3283 
Ω‹t
->
ªmŸï‹t
.
p‹t_«me
 !
øddr
.
≤
)

3287 i‡(!
	`nvme_fc_Ω‹t_gë
(
Ω‹t
))

3290 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

3292 
˘æ
 = 
	`nvme_fc_öô_˘æ
(
dev
, 
›ts
, 
Õ‹t
, 
Ω‹t
);

3293 i‡(
	`IS_ERR
(
˘æ
))

3294 
	`nvme_fc_Ω‹t_put
(
Ω‹t
);

3295  
˘æ
;

3298 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

3300 
	`¥_w¨n
("%s: %s - %s combinationÇot found\n",

3301 
__func__
, 
›ts
->
åaddr
, o±s->
ho°_åaddr
);

3302  
	`ERR_PTR
(-
ENOENT
);

3303 
	}
}

3306 
nvmf_å™•‹t_›s
 
	gnvme_fc_å™•‹t
 = {

3307 .
«me
 = "fc",

3308 .
	gmoduÀ
 = 
THIS_MODULE
,

3309 .
	gªquúed_›ts
 = 
NVMF_OPT_TRADDR
 | 
NVMF_OPT_HOST_TRADDR
,

3310 .
	gÆlowed_›ts
 = 
NVMF_OPT_RECONNECT_DELAY
 | 
NVMF_OPT_CTRL_LOSS_TMO
,

3311 .
	g¸óã_˘æ
 = 
nvme_fc_¸óã_˘æ
,

3315 
	#DISCOVERY_MAX_FAIL
 20

	)

3317 
ssize_t
 
	$nvme_fc_nvme_discovîy_°‹e
(
devi˚
 *
dev
,

3318 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
, 
size_t
 
cou¡
)

3320 
Êags
;

3321 
	`LIST_HEAD
(
loˇl_disc_li°
);

3322 
nvme_fc_Õ‹t
 *
Õ‹t
;

3323 
nvme_fc_Ω‹t
 *
Ω‹t
;

3324 
Áû˙t
 = 0;

3326 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

3327 
ª°¨t
:

3328 
	`li°_f‹_óch_íåy
(
Õ‹t
, &
nvme_fc_Õ‹t_li°
, 
p‹t_li°
) {

3329 
	`li°_f‹_óch_íåy
(
Ω‹t
, &
Õ‹t
->
ídp_li°
,Éndp_list) {

3330 i‡(!
	`nvme_fc_Õ‹t_gë
(
Õ‹t
))

3332 i‡(!
	`nvme_fc_Ω‹t_gë
(
Ω‹t
)) {

3342 
	`nvme_fc_Õ‹t_put
(
Õ‹t
);

3344 i‡(
Áû˙t
++ < 
DISCOVERY_MAX_FAIL
)

3345 
ª°¨t
;

3347 
	`¥_îr
("nvme_discovery:Åoo manyÑeference "

3349 
¥o˚ss_loˇl_li°
;

3351 i‡(
	`li°_em±y
(&
Ω‹t
->
disc_li°
))

3352 
	`li°_add_èû
(&
Ω‹t
->
disc_li°
,

3353 &
loˇl_disc_li°
);

3357 
¥o˚ss_loˇl_li°
:

3358 !
	`li°_em±y
(&
loˇl_disc_li°
)) {

3359 
Ω‹t
 = 
	`li°_fú°_íåy
(&
loˇl_disc_li°
,

3360 
nvme_fc_Ω‹t
, 
disc_li°
);

3361 
	`li°_dñ_öô
(&
Ω‹t
->
disc_li°
);

3362 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

3364 
Õ‹t
 = 
Ω‹t
->lport;

3366 
	`nvme_fc_sig«l_discovîy_sˇn
(
Õ‹t
, 
Ω‹t
);

3367 
	`nvme_fc_Ω‹t_put
(
Ω‹t
);

3368 
	`nvme_fc_Õ‹t_put
(
Õ‹t
);

3370 
	`•ö_lock_úqßve
(&
nvme_fc_lock
, 
Êags
);

3372 
	`•ö_u∆ock_úqª°‹e
(&
nvme_fc_lock
, 
Êags
);

3374  
cou¡
;

3375 
	}
}

3376 
DEVICE_ATTR
(
nvme_discovîy
, 0200, 
NULL
, 
nvme_fc_nvme_discovîy_°‹e
);

3378 
©åibuã
 *
	gnvme_fc_©ås
[] = {

3379 &
dev_©å_nvme_discovîy
.
©å
,

3380 
NULL


3383 
©åibuã_group
 
	gnvme_fc_©å_group
 = {

3384 .
©ås
 = 
nvme_fc_©ås
,

3387 c⁄° 
©åibuã_group
 *
	gnvme_fc_©å_groups
[] = {

3388 &
nvme_fc_©å_group
,

3389 
NULL


3392 
˛ass
 
	gfc_˛ass
 = {

3393 .
«me
 = "fc",

3394 .
	gdev_groups
 = 
nvme_fc_©å_groups
,

3395 .
	gow√r
 = 
THIS_MODULE
,

3398 
__öô
 
	$nvme_fc_öô_moduÀ
()

3400 
ªt
;

3416 
ªt
 = 
	`˛ass_ªgi°î
(&
fc_˛ass
);

3417 i‡(
ªt
) {

3418 
	`¥_îr
("couldn'tÑegister class fc\n");

3419  
ªt
;

3425 
fc_udev_devi˚
 = 
	`devi˚_¸óã
(&
fc_˛ass
, 
NULL
, 
	`MKDEV
(0, 0), NULL,

3427 i‡(
	`IS_ERR
(
fc_udev_devi˚
)) {

3428 
	`¥_îr
("couldn't create fc_udev device!\n");

3429 
ªt
 = 
	`PTR_ERR
(
fc_udev_devi˚
);

3430 
out_de°roy_˛ass
;

3433 
ªt
 = 
	`nvmf_ªgi°î_å™•‹t
(&
nvme_fc_å™•‹t
);

3434 i‡(
ªt
)

3435 
out_de°roy_devi˚
;

3439 
out_de°roy_devi˚
:

3440 
	`devi˚_de°roy
(&
fc_˛ass
, 
	`MKDEV
(0, 0));

3441 
out_de°roy_˛ass
:

3442 
	`˛ass_uƒegi°î
(&
fc_˛ass
);

3443  
ªt
;

3444 
	}
}

3446 
__exô
 
	$nvme_fc_exô_moduÀ
()

3449 i‡(!
	`li°_em±y
(&
nvme_fc_Õ‹t_li°
))

3450 
	`¥_w¨n
("%s:ÜoˇÕ‹àli°ÇŸÉm±y\n", 
__func__
);

3452 
	`nvmf_uƒegi°î_å™•‹t
(&
nvme_fc_å™•‹t
);

3454 
	`ida_de°roy
(&
nvme_fc_loˇl_p‹t_˙t
);

3455 
	`ida_de°roy
(&
nvme_fc_˘æ_˙t
);

3457 
	`devi˚_de°roy
(&
fc_˛ass
, 
	`MKDEV
(0, 0));

3458 
	`˛ass_uƒegi°î
(&
fc_˛ass
);

3459 
	}
}

3461 
moduÀ_öô
(
nvme_fc_öô_moduÀ
);

3462 
moduÀ_exô
(
nvme_fc_exô_moduÀ
);

3464 
MODULE_LICENSE
("GPL v2");

	@lightnvm.c

9 
	~"nvme.h
"

11 
	~<löux/nvme.h
>

12 
	~<löux/bô›s.h
>

13 
	~<löux/lighävm.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/sched/sys˘l.h
>

16 
	~<u≠i/löux/lighävm.h
>

18 
	envme_nvm_admö_›code
 {

19 
	mnvme_nvm_admö_idítôy
 = 0xe2,

20 
	mnvme_nvm_admö_gë_bb_tbl
 = 0xf2,

21 
	mnvme_nvm_admö_£t_bb_tbl
 = 0xf1,

24 
	envme_nvm_log_∑ge
 {

25 
	mNVME_NVM_LOG_REPORT_CHUNK
 = 0xca,

28 
	snvme_nvm_ph_rw
 {

29 
__u8
 
	m›code
;

30 
__u8
 
	mÊags
;

31 
__u16
 
	mcomm™d_id
;

32 
__À32
 
	mnsid
;

33 
__u64
 
	mrsvd2
;

34 
__À64
 
	mmëad©a
;

35 
__À64
 
	m¥p1
;

36 
__À64
 
	m¥p2
;

37 
__À64
 
	m•ba
;

38 
__À16
 
	mÀngth
;

39 
__À16
 
	mc⁄åﬁ
;

40 
__À32
 
	mdsmgmt
;

41 
__À64
 
	mªsv
;

44 
	snvme_nvm_îa£_blk
 {

45 
__u8
 
	m›code
;

46 
__u8
 
	mÊags
;

47 
__u16
 
	mcomm™d_id
;

48 
__À32
 
	mnsid
;

49 
__u64
 
	mrsvd
[2];

50 
__À64
 
	m¥p1
;

51 
__À64
 
	m¥p2
;

52 
__À64
 
	m•ba
;

53 
__À16
 
	mÀngth
;

54 
__À16
 
	mc⁄åﬁ
;

55 
__À32
 
	mdsmgmt
;

56 
__À64
 
	mªsv
;

59 
	snvme_nvm_idítôy
 {

60 
__u8
 
	m›code
;

61 
__u8
 
	mÊags
;

62 
__u16
 
	mcomm™d_id
;

63 
__À32
 
	mnsid
;

64 
__u64
 
	mrsvd
[2];

65 
__À64
 
	m¥p1
;

66 
__À64
 
	m¥p2
;

67 
__u32
 
	mrsvd11
[6];

70 
	snvme_nvm_gëbbtbl
 {

71 
__u8
 
	m›code
;

72 
__u8
 
	mÊags
;

73 
__u16
 
	mcomm™d_id
;

74 
__À32
 
	mnsid
;

75 
__u64
 
	mrsvd
[2];

76 
__À64
 
	m¥p1
;

77 
__À64
 
	m¥p2
;

78 
__À64
 
	m•ba
;

79 
__u32
 
	mrsvd4
[4];

82 
	snvme_nvm_£tbbtbl
 {

83 
__u8
 
	m›code
;

84 
__u8
 
	mÊags
;

85 
__u16
 
	mcomm™d_id
;

86 
__À32
 
	mnsid
;

87 
__À64
 
	mrsvd
[2];

88 
__À64
 
	m¥p1
;

89 
__À64
 
	m¥p2
;

90 
__À64
 
	m•ba
;

91 
__À16
 
	m∆b
;

92 
__u8
 
	mvÆue
;

93 
__u8
 
	mrsvd3
;

94 
__u32
 
	mrsvd4
[3];

97 
	snvme_nvm_comm™d
 {

99 
nvme_comm⁄_comm™d
 
	mcomm⁄
;

100 
nvme_nvm_ph_rw
 
	mph_rw
;

101 
nvme_nvm_îa£_blk
 
	mîa£
;

102 
nvme_nvm_idítôy
 
	midítôy
;

103 
nvme_nvm_gëbbtbl
 
	mgë_bb
;

104 
nvme_nvm_£tbbtbl
 
	m£t_bb
;

108 
	snvme_nvm_id12_gΩ
 {

109 
__u8
 
	mmty≥
;

110 
__u8
 
	mfmty≥
;

111 
__À16
 
	mªs16
;

112 
__u8
 
	mnum_ch
;

113 
__u8
 
	mnum_lun
;

114 
__u8
 
	mnum_∂n
;

115 
__u8
 
	mrsvd1
;

116 
__À16
 
	mnum_chk
;

117 
__À16
 
	mnum_pg
;

118 
__À16
 
	mÂg_sz
;

119 
__À16
 
	mc£cs
;

120 
__À16
 
	msos
;

121 
__À16
 
	mrsvd2
;

122 
__À32
 
	mådt
;

123 
__À32
 
	mådm
;

124 
__À32
 
	mçπ
;

125 
__À32
 
	mçrm
;

126 
__À32
 
	mtbë
;

127 
__À32
 
	mtbem
;

128 
__À32
 
	mmpos
;

129 
__À32
 
	mmcˇp
;

130 
__À16
 
	m˝¨
;

131 
__u8
 
	mª£rved
[906];

132 } 
	g__∑cked
;

134 
	snvme_nvm_id12_addrf
 {

135 
__u8
 
	mch_off£t
;

136 
__u8
 
	mch_Àn
;

137 
__u8
 
	mlun_off£t
;

138 
__u8
 
	mlun_Àn
;

139 
__u8
 
	m∂n_off£t
;

140 
__u8
 
	m∂n_Àn
;

141 
__u8
 
	mblk_off£t
;

142 
__u8
 
	mblk_Àn
;

143 
__u8
 
	mpg_off£t
;

144 
__u8
 
	mpg_Àn
;

145 
__u8
 
	m£c_off£t
;

146 
__u8
 
	m£c_Àn
;

147 
__u8
 
	mªs
[4];

148 } 
	g__∑cked
;

150 
	snvme_nvm_id12
 {

151 
__u8
 
	mvî_id
;

152 
__u8
 
	mvm¡
;

153 
__u8
 
	mcgΩs
;

154 
__u8
 
	mªs
;

155 
__À32
 
	mˇp
;

156 
__À32
 
	mdom
;

157 
nvme_nvm_id12_addrf
 
	mµaf
;

158 
__u8
 
	mªsv
[228];

159 
nvme_nvm_id12_gΩ
 
	mgΩ
;

160 
__u8
 
	mªsv2
[2880];

161 } 
	g__∑cked
;

163 
	snvme_nvm_bb_tbl
 {

164 
__u8
 
	mtblid
[4];

165 
__À16
 
	mvîid
;

166 
__À16
 
	mªvid
;

167 
__À32
 
	mrvsd1
;

168 
__À32
 
	mtblks
;

169 
__À32
 
	mtÁ˘
;

170 
__À32
 
	mtgrown
;

171 
__À32
 
	mtdªsv
;

172 
__À32
 
	mthªsv
;

173 
__À32
 
	mrsvd2
[8];

174 
__u8
 
	mblk
[0];

177 
	snvme_nvm_id20_addrf
 {

178 
__u8
 
	mgΩ_Àn
;

179 
__u8
 
	mpu_Àn
;

180 
__u8
 
	mchk_Àn
;

181 
__u8
 
	mlba_Àn
;

182 
__u8
 
	mªsv
[4];

185 
	snvme_nvm_id20
 {

186 
__u8
 
	mmjr
;

187 
__u8
 
	mmƒ
;

188 
__u8
 
	mªsv
[6];

190 
nvme_nvm_id20_addrf
 
	mlbaf
;

192 
__À32
 
	mmcˇp
;

193 
__u8
 
	mªsv2
[12];

195 
__u8
 
	mwô
;

196 
__u8
 
	mªsv3
[31];

199 
__À16
 
	mnum_gΩ
;

200 
__À16
 
	mnum_pu
;

201 
__À32
 
	mnum_chk
;

202 
__À32
 
	m˛ba
;

203 
__u8
 
	mªsv4
[52];

206 
__À32
 
	mws_mö
;

207 
__À32
 
	mws_›t
;

208 
__À32
 
	mmw_cunôs
;

209 
__À32
 
	mmaxoc
;

210 
__À32
 
	mmaxo˝u
;

211 
__u8
 
	mªsv5
[44];

214 
__À32
 
	mådt
;

215 
__À32
 
	mådm
;

216 
__À32
 
	mtwπ
;

217 
__À32
 
	mtwrm
;

218 
__À32
 
	mt¸°
;

219 
__À32
 
	mt¸sm
;

220 
__u8
 
	mªsv6
[40];

223 
__u8
 
	mªsv7
[2816];

226 
__u8
 
	mvs
[1024];

229 
	snvme_nvm_chk_mëa
 {

230 
__u8
 
	m°©e
;

231 
__u8
 
	mty≥
;

232 
__u8
 
	mwi
;

233 
__u8
 
	mrsvd
[5];

234 
__À64
 
	m¶ba
;

235 
__À64
 
	m˙lb
;

236 
__À64
 
	mwp
;

242 
ölöe
 
	$_nvme_nvm_check_size
()

244 
	`BUILD_BUG_ON
((
nvme_nvm_idítôy
) != 64);

245 
	`BUILD_BUG_ON
((
nvme_nvm_ph_rw
) != 64);

246 
	`BUILD_BUG_ON
((
nvme_nvm_îa£_blk
) != 64);

247 
	`BUILD_BUG_ON
((
nvme_nvm_gëbbtbl
) != 64);

248 
	`BUILD_BUG_ON
((
nvme_nvm_£tbbtbl
) != 64);

249 
	`BUILD_BUG_ON
((
nvme_nvm_id12_gΩ
) != 960);

250 
	`BUILD_BUG_ON
((
nvme_nvm_id12_addrf
) != 16);

251 
	`BUILD_BUG_ON
((
nvme_nvm_id12
Ë!
NVME_IDENTIFY_DATA_SIZE
);

252 
	`BUILD_BUG_ON
((
nvme_nvm_bb_tbl
) != 64);

253 
	`BUILD_BUG_ON
((
nvme_nvm_id20_addrf
) != 8);

254 
	`BUILD_BUG_ON
((
nvme_nvm_id20
Ë!
NVME_IDENTIFY_DATA_SIZE
);

255 
	`BUILD_BUG_ON
((
nvme_nvm_chk_mëa
) != 32);

256 
	`BUILD_BUG_ON
((
nvme_nvm_chk_mëa
) !=

257 (
nvm_chk_mëa
));

258 
	}
}

260 
	$nvme_nvm_£t_addr_12
(
nvm_addrf_12
 *
d°
,

261 
nvme_nvm_id12_addrf
 *
§c
)

263 
d°
->
ch_Àn
 = 
§c
->ch_len;

264 
d°
->
lun_Àn
 = 
§c
->lun_len;

265 
d°
->
blk_Àn
 = 
§c
->blk_len;

266 
d°
->
pg_Àn
 = 
§c
->pg_len;

267 
d°
->
∂n_Àn
 = 
§c
->pln_len;

268 
d°
->
£c_Àn
 = 
§c
->sec_len;

270 
d°
->
ch_off£t
 = 
§c
->ch_offset;

271 
d°
->
lun_off£t
 = 
§c
->lun_offset;

272 
d°
->
blk_off£t
 = 
§c
->blk_offset;

273 
d°
->
pg_off£t
 = 
§c
->pg_offset;

274 
d°
->
∂n_off£t
 = 
§c
->pln_offset;

275 
d°
->
£c_off£t
 = 
§c
->sec_offset;

277 
d°
->
ch_mask
 = ((1ULL << d°->
ch_Àn
Ë- 1Ë<< d°->
ch_off£t
;

278 
d°
->
lun_mask
 = ((1ULL << d°->
lun_Àn
Ë- 1Ë<< d°->
lun_off£t
;

279 
d°
->
blk_mask
 = ((1ULL << d°->
blk_Àn
Ë- 1Ë<< d°->
blk_off£t
;

280 
d°
->
pg_mask
 = ((1ULL << d°->
pg_Àn
Ë- 1Ë<< d°->
pg_off£t
;

281 
d°
->
∂n_mask
 = ((1ULL << d°->
∂n_Àn
Ë- 1Ë<< d°->
∂n_off£t
;

282 
d°
->
£c_mask
 = ((1ULL << d°->
£c_Àn
Ë- 1Ë<< d°->
£c_off£t
;

283 
	}
}

285 
	$nvme_nvm_£tup_12
(
nvme_nvm_id12
 *
id
,

286 
nvm_geo
 *
geo
)

288 
nvme_nvm_id12_gΩ
 *
§c
;

289 
£c_≥r_pg
, 
£c_≥r_∂
, 
pg_≥r_blk
;

291 i‡(
id
->
cgΩs
 != 1)

292  -
EINVAL
;

294 
§c
 = &
id
->
gΩ
;

296 i‡(
§c
->
mty≥
 != 0) {

297 
	`¥_îr
("nvm: memoryÅypeÇot supported\n");

298  -
EINVAL
;

302 
geo
->
maj‹_vî_id
 = 
id
->
vî_id
;

303 
geo
->
mö‹_vî_id
 = 2;

306 
geo
->
vîsi⁄
 = 
NVM_OCSSD_SPEC_12
;

308 
geo
->
num_ch
 = 
§c
->num_ch;

309 
geo
->
num_lun
 = 
§c
->num_lun;

310 
geo
->
Æl_luns
 = geo->
num_ch
 * geo->
num_lun
;

312 
geo
->
num_chk
 = 
	`À16_to_˝u
(
§c
->num_chk);

314 
geo
->
c£cs
 = 
	`À16_to_˝u
(
§c
->csecs);

315 
geo
->
sos
 = 
	`À16_to_˝u
(
§c
->sos);

317 
pg_≥r_blk
 = 
	`À16_to_˝u
(
§c
->
num_pg
);

318 
£c_≥r_pg
 = 
	`À16_to_˝u
(
§c
->
Âg_sz
Ë/ 
geo
->
c£cs
;

319 
£c_≥r_∂
 = 
£c_≥r_pg
 * 
§c
->
num_∂n
;

320 
geo
->
˛ba
 = 
£c_≥r_∂
 * 
pg_≥r_blk
;

322 
geo
->
Æl_chunks
 = geo->
Æl_luns
 * geo->
num_chk
;

323 
geo
->
tŸÆ_£cs
 = geo->
˛ba
 * geo->
Æl_chunks
;

325 
geo
->
ws_mö
 = 
£c_≥r_pg
;

326 
geo
->
ws_›t
 = 
£c_≥r_pg
;

327 
geo
->
mw_cunôs
 = geo->
ws_›t
 << 3;

333 
geo
->
maxoc
 = geo->
Æl_luns
 * geo->
num_chk
;

334 
geo
->
maxo˝u
 = geo->
num_chk
;

336 
geo
->
mcˇp
 = 
	`À32_to_˝u
(
§c
->mccap);

338 
geo
->
ådt
 = 
	`À32_to_˝u
(
§c
->trdt);

339 
geo
->
ådm
 = 
	`À32_to_˝u
(
§c
->trdm);

340 
geo
->
çπ
 = 
	`À32_to_˝u
(
§c
->tprt);

341 
geo
->
çrm
 = 
	`À32_to_˝u
(
§c
->tprm);

342 
geo
->
tbë
 = 
	`À32_to_˝u
(
§c
->tbet);

343 
geo
->
tbem
 = 
	`À32_to_˝u
(
§c
->tbem);

346 
geo
->
vm¡
 = 
id
->vmnt;

347 
geo
->
ˇp
 = 
	`À32_to_˝u
(
id
->cap);

348 
geo
->
dom
 = 
	`À32_to_˝u
(
id
->dom);

350 
geo
->
mty≥
 = 
§c
->mtype;

351 
geo
->
fmty≥
 = 
§c
->fmtype;

353 
geo
->
˝¨
 = 
	`À16_to_˝u
(
§c
->cpar);

354 
geo
->
mpos
 = 
	`À32_to_˝u
(
§c
->mpos);

356 
geo
->
∂n_mode
 = 
NVM_PLANE_SINGLE
;

358 i‡(
geo
->
mpos
 & 0x020202) {

359 
geo
->
∂n_mode
 = 
NVM_PLANE_DOUBLE
;

360 
geo
->
ws_›t
 <<= 1;

361 } i‡(
geo
->
mpos
 & 0x040404) {

362 
geo
->
∂n_mode
 = 
NVM_PLANE_QUAD
;

363 
geo
->
ws_›t
 <<= 2;

366 
geo
->
num_∂n
 = 
§c
->num_pln;

367 
geo
->
num_pg
 = 
	`À16_to_˝u
(
§c
->num_pg);

368 
geo
->
Âg_sz
 = 
	`À16_to_˝u
(
§c
->fpg_sz);

370 
	`nvme_nvm_£t_addr_12
((
nvm_addrf_12
 *)&
geo
->
addrf
, &
id
->
µaf
);

373 
	}
}

375 
	$nvme_nvm_£t_addr_20
(
nvm_addrf
 *
d°
,

376 
nvme_nvm_id20_addrf
 *
§c
)

378 
d°
->
ch_Àn
 = 
§c
->
gΩ_Àn
;

379 
d°
->
lun_Àn
 = 
§c
->
pu_Àn
;

380 
d°
->
chk_Àn
 = 
§c
->chk_len;

381 
d°
->
£c_Àn
 = 
§c
->
lba_Àn
;

383 
d°
->
£c_off£t
 = 0;

384 
d°
->
chk_off£t
 = d°->
£c_Àn
;

385 
d°
->
lun_off£t
 = d°->
chk_off£t
 + d°->
chk_Àn
;

386 
d°
->
ch_off£t
 = d°->
lun_off£t
 + d°->
lun_Àn
;

388 
d°
->
ch_mask
 = ((1ULL << d°->
ch_Àn
Ë- 1Ë<< d°->
ch_off£t
;

389 
d°
->
lun_mask
 = ((1ULL << d°->
lun_Àn
Ë- 1Ë<< d°->
lun_off£t
;

390 
d°
->
chk_mask
 = ((1ULL << d°->
chk_Àn
Ë- 1Ë<< d°->
chk_off£t
;

391 
d°
->
£c_mask
 = ((1ULL << d°->
£c_Àn
Ë- 1Ë<< d°->
£c_off£t
;

392 
	}
}

394 
	$nvme_nvm_£tup_20
(
nvme_nvm_id20
 *
id
,

395 
nvm_geo
 *
geo
)

397 
geo
->
maj‹_vî_id
 = 
id
->
mjr
;

398 
geo
->
mö‹_vî_id
 = 
id
->
mƒ
;

401 
geo
->
vîsi⁄
 = 
NVM_OCSSD_SPEC_20
;

403 
geo
->
num_ch
 = 
	`À16_to_˝u
(
id
->
num_gΩ
);

404 
geo
->
num_lun
 = 
	`À16_to_˝u
(
id
->
num_pu
);

405 
geo
->
Æl_luns
 = geo->
num_ch
 * geo->
num_lun
;

407 
geo
->
num_chk
 = 
	`À32_to_˝u
(
id
->num_chk);

408 
geo
->
˛ba
 = 
	`À32_to_˝u
(
id
->clba);

410 
geo
->
Æl_chunks
 = geo->
Æl_luns
 * geo->
num_chk
;

411 
geo
->
tŸÆ_£cs
 = geo->
˛ba
 * geo->
Æl_chunks
;

413 
geo
->
ws_mö
 = 
	`À32_to_˝u
(
id
->ws_min);

414 
geo
->
ws_›t
 = 
	`À32_to_˝u
(
id
->ws_opt);

415 
geo
->
mw_cunôs
 = 
	`À32_to_˝u
(
id
->mw_cunits);

416 
geo
->
maxoc
 = 
	`À32_to_˝u
(
id
->maxoc);

417 
geo
->
maxo˝u
 = 
	`À32_to_˝u
(
id
->maxocpu);

419 
geo
->
ådt
 = 
	`À32_to_˝u
(
id
->trdt);

420 
geo
->
ådm
 = 
	`À32_to_˝u
(
id
->trdm);

421 
geo
->
çπ
 = 
	`À32_to_˝u
(
id
->
twπ
);

422 
geo
->
çrm
 = 
	`À32_to_˝u
(
id
->
twrm
);

423 
geo
->
tbë
 = 
	`À32_to_˝u
(
id
->
t¸°
);

424 
geo
->
tbem
 = 
	`À32_to_˝u
(
id
->
t¸sm
);

426 
	`nvme_nvm_£t_addr_20
(&
geo
->
addrf
, &
id
->
lbaf
);

429 
	}
}

431 
	$nvme_nvm_idítôy
(
nvm_dev
 *
nvmdev
)

433 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

434 
nvme_nvm_id12
 *
id
;

435 
nvme_nvm_comm™d
 
c
 = {};

436 
ªt
;

438 
c
.
idítôy
.
›code
 = 
nvme_nvm_admö_idítôy
;

439 
c
.
idítôy
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

441 
id
 = 
	`kmÆloc
((
nvme_nvm_id12
), 
GFP_KERNEL
);

442 i‡(!
id
)

443  -
ENOMEM
;

445 
ªt
 = 
	`nvme_submô_sync_cmd
(
ns
->
˘æ
->
admö_q
, (
nvme_comm™d
 *)&
c
,

446 
id
, (
nvme_nvm_id12
));

447 i‡(
ªt
) {

448 
ªt
 = -
EIO
;

449 
out
;

456 
id
->
vî_id
) {

458 
ªt
 = 
	`nvme_nvm_£tup_12
(
id
, &
nvmdev
->
geo
);

461 
ªt
 = 
	`nvme_nvm_£tup_20
((
nvme_nvm_id20
 *)
id
,

462 &
nvmdev
->
geo
);

465 
	`dev_îr
(
ns
->
˘æ
->
devi˚
, "OCSSDÑevisionÇot supported (%d)\n",

466 
id
->
vî_id
);

467 
ªt
 = -
EINVAL
;

470 
out
:

471 
	`k‰ì
(
id
);

472  
ªt
;

473 
	}
}

475 
	$nvme_nvm_gë_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 
µa
,

476 
u8
 *
blks
)

478 
ªque°_queue
 *
q
 = 
nvmdev
->q;

479 
nvm_geo
 *
geo
 = &
nvmdev
->geo;

480 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

481 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

482 
nvme_nvm_comm™d
 
c
 = {};

483 
nvme_nvm_bb_tbl
 *
bb_tbl
;

484 
ƒ_blks
 = 
geo
->
num_chk
 * geo->
num_∂n
;

485 
tblsz
 = (
nvme_nvm_bb_tbl
Ë+ 
ƒ_blks
;

486 
ªt
 = 0;

488 
c
.
gë_bb
.
›code
 = 
nvme_nvm_admö_gë_bb_tbl
;

489 
c
.
gë_bb
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

490 
c
.
gë_bb
.
•ba
 = 
	`˝u_to_À64
(
µa
.ppa);

492 
bb_tbl
 = 
	`kzÆloc
(
tblsz
, 
GFP_KERNEL
);

493 i‡(!
bb_tbl
)

494  -
ENOMEM
;

496 
ªt
 = 
	`nvme_submô_sync_cmd
(
˘æ
->
admö_q
, (
nvme_comm™d
 *)&
c
,

497 
bb_tbl
, 
tblsz
);

498 i‡(
ªt
) {

499 
	`dev_îr
(
˘æ
->
devi˚
, "gë bad blockÅabÀ faûed (%d)\n", 
ªt
);

500 
ªt
 = -
EIO
;

501 
out
;

504 i‡(
bb_tbl
->
tblid
[0] != 'B' || bb_tbl->tblid[1] != 'B' ||

505 
bb_tbl
->
tblid
[2] != 'L' || bb_tbl->tblid[3] != 'T') {

506 
	`dev_îr
(
˘æ
->
devi˚
, "bbt format mismatch\n");

507 
ªt
 = -
EINVAL
;

508 
out
;

511 i‡(
	`À16_to_˝u
(
bb_tbl
->
vîid
) != 1) {

512 
ªt
 = -
EINVAL
;

513 
	`dev_îr
(
˘æ
->
devi˚
, "bbt versionÇot supported\n");

514 
out
;

517 i‡(
	`À32_to_˝u
(
bb_tbl
->
tblks
Ë!
ƒ_blks
) {

518 
ªt
 = -
EINVAL
;

519 
	`dev_îr
(
˘æ
->
devi˚
,

521 
	`À32_to_˝u
(
bb_tbl
->
tblks
), 
ƒ_blks
);

522 
out
;

525 
	`mem˝y
(
blks
, 
bb_tbl
->
blk
, 
geo
->
num_chk
 * geo->
num_∂n
);

526 
out
:

527 
	`k‰ì
(
bb_tbl
);

528  
ªt
;

529 
	}
}

531 
	$nvme_nvm_£t_bb_tbl
(
nvm_dev
 *
nvmdev
, 
µa_addr
 *
µas
,

532 
ƒ_µas
, 
ty≥
)

534 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

535 
nvme_nvm_comm™d
 
c
 = {};

536 
ªt
 = 0;

538 
c
.
£t_bb
.
›code
 = 
nvme_nvm_admö_£t_bb_tbl
;

539 
c
.
£t_bb
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

540 
c
.
£t_bb
.
•ba
 = 
	`˝u_to_À64
(
µas
->
µa
);

541 
c
.
£t_bb
.
∆b
 = 
	`˝u_to_À16
(
ƒ_µas
 - 1);

542 
c
.
£t_bb
.
vÆue
 = 
ty≥
;

544 
ªt
 = 
	`nvme_submô_sync_cmd
(
ns
->
˘æ
->
admö_q
, (
nvme_comm™d
 *)&
c
,

545 
NULL
, 0);

546 i‡(
ªt
)

547 
	`dev_îr
(
ns
->
˘æ
->
devi˚
, "set bad blockÅable failed (%d)\n",

548 
ªt
);

549  
ªt
;

550 
	}
}

555 
	$nvme_nvm_gë_chk_mëa
(
nvm_dev
 *
ndev
,

556 
£˘‹_t
 
¶ba
, 
nchks
,

557 
nvm_chk_mëa
 *
mëa
)

559 
nvm_geo
 *
geo
 = &
ndev
->geo;

560 
nvme_ns
 *
ns
 = 
ndev
->
q
->
queued©a
;

561 
nvme_˘æ
 *
˘æ
 = 
ns
->ctrl;

562 
nvme_nvm_chk_mëa
 *
dev_mëa
, *
dev_mëa_off
;

563 
µa_addr
 
µa
;

564 
size_t
 
À·
 = 
nchks
 * (
nvme_nvm_chk_mëa
);

565 
size_t
 
log_pos
, 
off£t
, 
Àn
;

566 
i
, 
max_Àn
;

567 
ªt
 = 0;

573 
max_Àn
 = 
	`mö_t
(, 
˘æ
->
max_hw_£˘‹s
 << 9, 256 * 1024);

575 
dev_mëa
 = 
	`kmÆloc
(
max_Àn
, 
GFP_KERNEL
);

576 i‡(!
dev_mëa
)

577  -
ENOMEM
;

580 
µa
.µ®
¶ba
;

581 
µa
 = 
	`dev_to_gíîic_addr
(
ndev
,Öpa);

583 
log_pos
 = 
µa
.
m
.
chk
;

584 
log_pos
 +
µa
.
m
.
pu
 * 
geo
->
num_chk
;

585 
log_pos
 +
µa
.
m
.
gΩ
 * 
geo
->
num_lun
 * geo->
num_chk
;

587 
off£t
 = 
log_pos
 * (
nvme_nvm_chk_mëa
);

589 
À·
) {

590 
Àn
 = 
	`mö_t
(, 
À·
, 
max_Àn
);

592 
	`mem£t
(
dev_mëa
, 0, 
max_Àn
);

593 
dev_mëa_off
 = 
dev_mëa
;

595 
ªt
 = 
	`nvme_gë_log
(
˘æ
, 
ns
->
hód
->
ns_id
,

596 
NVME_NVM_LOG_REPORT_CHUNK
, 0, 
dev_mëa
, 
Àn
,

597 
off£t
);

598 i‡(
ªt
) {

599 
	`dev_îr
(
˘æ
->
devi˚
, "Get REPORT CHUNKÜogÉrror\n");

603 
i
 = 0; i < 
Àn
; i +(
nvme_nvm_chk_mëa
)) {

604 
mëa
->
°©e
 = 
dev_mëa_off
->state;

605 
mëa
->
ty≥
 = 
dev_mëa_off
->type;

606 
mëa
->
wi
 = 
dev_mëa_off
->wi;

607 
mëa
->
¶ba
 = 
	`À64_to_˝u
(
dev_mëa_off
->slba);

608 
mëa
->
˙lb
 = 
	`À64_to_˝u
(
dev_mëa_off
->cnlb);

609 
mëa
->
wp
 = 
	`À64_to_˝u
(
dev_mëa_off
->wp);

611 
mëa
++;

612 
dev_mëa_off
++;

615 
off£t
 +
Àn
;

616 
À·
 -
Àn
;

619 
	`k‰ì
(
dev_mëa
);

621  
ªt
;

622 
	}
}

624 
ölöe
 
	$nvme_nvm_rqtocmd
(
nvm_rq
 *
rqd
, 
nvme_ns
 *
ns
,

625 
nvme_nvm_comm™d
 *
c
)

627 
c
->
ph_rw
.
›code
 = 
rqd
->opcode;

628 
c
->
ph_rw
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

629 
c
->
ph_rw
.
•ba
 = 
	`˝u_to_À64
(
rqd
->
µa_addr
.
µa
);

630 
c
->
ph_rw
.
mëad©a
 = 
	`˝u_to_À64
(
rqd
->
dma_mëa_li°
);

631 
c
->
ph_rw
.
c⁄åﬁ
 = 
	`˝u_to_À16
(
rqd
->
Êags
);

632 
c
->
ph_rw
.
Àngth
 = 
	`˝u_to_À16
(
rqd
->
ƒ_µas
 - 1);

633 
	}
}

635 
	$nvme_nvm_íd_io
(
ªque°
 *
rq
, 
blk_°©us_t
 
°©us
)

637 
nvm_rq
 *
rqd
 = 
rq
->
íd_io_d©a
;

639 
rqd
->
µa_°©us
 = 
	`À64_to_˝u
(
	`nvme_ªq
(
rq
)->
ªsu…
.
u64
);

640 
rqd
->
îr‹
 = 
	`nvme_ªq
(
rq
)->
°©us
;

641 
	`nvm_íd_io
(
rqd
);

643 
	`k‰ì
(
	`nvme_ªq
(
rq
)->
cmd
);

644 
	`blk_mq_‰ì_ªque°
(
rq
);

645 
	}
}

647 
ªque°
 *
	$nvme_nvm_Æloc_ªque°
(
ªque°_queue
 *
q
,

648 
nvm_rq
 *
rqd
,

649 
nvme_nvm_comm™d
 *
cmd
)

651 
nvme_ns
 *
ns
 = 
q
->
queued©a
;

652 
ªque°
 *
rq
;

654 
	`nvme_nvm_rqtocmd
(
rqd
, 
ns
, 
cmd
);

656 
rq
 = 
	`nvme_Æloc_ªque°
(
q
, (
nvme_comm™d
 *)
cmd
, 0, 
NVME_QID_ANY
);

657 i‡(
	`IS_ERR
(
rq
))

658  
rq
;

660 
rq
->
cmd_Êags
 &~
REQ_FAILFAST_DRIVER
;

662 i‡(
rqd
->
bio
)

663 
	`blk_öô_ªque°_‰om_bio
(
rq
, 
rqd
->
bio
);

665 
rq
->
i›rio
 = 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
IOPRIO_NORM
);

667  
rq
;

668 
	}
}

670 
	$nvme_nvm_submô_io
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

672 
ªque°_queue
 *
q
 = 
dev
->q;

673 
nvme_nvm_comm™d
 *
cmd
;

674 
ªque°
 *
rq
;

676 
cmd
 = 
	`kzÆloc
((
nvme_nvm_comm™d
), 
GFP_KERNEL
);

677 i‡(!
cmd
)

678  -
ENOMEM
;

680 
rq
 = 
	`nvme_nvm_Æloc_ªque°
(
q
, 
rqd
, 
cmd
);

681 i‡(
	`IS_ERR
(
rq
)) {

682 
	`k‰ì
(
cmd
);

683  
	`PTR_ERR
(
rq
);

686 
rq
->
íd_io_d©a
 = 
rqd
;

688 
	`blk_execuã_rq_nowaô
(
q
, 
NULL
, 
rq
, 0, 
nvme_nvm_íd_io
);

691 
	}
}

693 
	$nvme_nvm_submô_io_sync
(
nvm_dev
 *
dev
, 
nvm_rq
 *
rqd
)

695 
ªque°_queue
 *
q
 = 
dev
->q;

696 
ªque°
 *
rq
;

697 
nvme_nvm_comm™d
 
cmd
;

698 
ªt
 = 0;

700 
	`mem£t
(&
cmd
, 0, (
nvme_nvm_comm™d
));

702 
rq
 = 
	`nvme_nvm_Æloc_ªque°
(
q
, 
rqd
, &
cmd
);

703 i‡(
	`IS_ERR
(
rq
))

704  
	`PTR_ERR
(
rq
);

709 
	`blk_execuã_rq
(
q
, 
NULL
, 
rq
, 0);

710 i‡(
	`nvme_ªq
(
rq
)->
Êags
 & 
NVME_REQ_CANCELLED
)

711 
ªt
 = -
EINTR
;

713 
rqd
->
µa_°©us
 = 
	`À64_to_˝u
(
	`nvme_ªq
(
rq
)->
ªsu…
.
u64
);

714 
rqd
->
îr‹
 = 
	`nvme_ªq
(
rq
)->
°©us
;

716 
	`blk_mq_‰ì_ªque°
(
rq
);

718  
ªt
;

719 
	}
}

721 *
	$nvme_nvm_¸óã_dma_poﬁ
(
nvm_dev
 *
nvmdev
, *
«me
,

722 
size
)

724 
nvme_ns
 *
ns
 = 
nvmdev
->
q
->
queued©a
;

726  
	`dma_poﬁ_¸óã
(
«me
, 
ns
->
˘æ
->
dev
, 
size
, 
PAGE_SIZE
, 0);

727 
	}
}

729 
	$nvme_nvm_de°roy_dma_poﬁ
(*
poﬁ
)

731 
dma_poﬁ
 *dma_poﬁ = 
poﬁ
;

733 
	`dma_poﬁ_de°roy
(
dma_poﬁ
);

734 
	}
}

736 *
	$nvme_nvm_dev_dma_Æloc
(
nvm_dev
 *
dev
, *
poﬁ
,

737 
gÂ_t
 
mem_Êags
, 
dma_addr_t
 *
dma_h™dÀr
)

739  
	`dma_poﬁ_Æloc
(
poﬁ
, 
mem_Êags
, 
dma_h™dÀr
);

740 
	}
}

742 
	$nvme_nvm_dev_dma_‰ì
(*
poﬁ
, *
addr
,

743 
dma_addr_t
 
dma_h™dÀr
)

745 
	`dma_poﬁ_‰ì
(
poﬁ
, 
addr
, 
dma_h™dÀr
);

746 
	}
}

748 
nvm_dev_›s
 
	gnvme_nvm_dev_›s
 = {

749 .
idítôy
 = 
nvme_nvm_idítôy
,

751 .
	ggë_bb_tbl
 = 
nvme_nvm_gë_bb_tbl
,

752 .
	g£t_bb_tbl
 = 
nvme_nvm_£t_bb_tbl
,

754 .
	ggë_chk_mëa
 = 
nvme_nvm_gë_chk_mëa
,

756 .
	gsubmô_io
 = 
nvme_nvm_submô_io
,

757 .
	gsubmô_io_sync
 = 
nvme_nvm_submô_io_sync
,

759 .
	g¸óã_dma_poﬁ
 = 
nvme_nvm_¸óã_dma_poﬁ
,

760 .
	gde°roy_dma_poﬁ
 = 
nvme_nvm_de°roy_dma_poﬁ
,

761 .
	gdev_dma_Æloc
 = 
nvme_nvm_dev_dma_Æloc
,

762 .
	gdev_dma_‰ì
 = 
nvme_nvm_dev_dma_‰ì
,

765 
	$nvme_nvm_submô_u£r_cmd
(
ªque°_queue
 *
q
,

766 
nvme_ns
 *
ns
,

767 
nvme_nvm_comm™d
 *
vcmd
,

768 
__u£r
 *
ubuf
, 
bufÊí
,

769 
__u£r
 *
mëa_buf
, 
mëa_Àn
,

770 
__u£r
 *
µa_buf
, 
µa_Àn
,

771 
u32
 *
ªsu…
, 
u64
 *
°©us
, 
timeout
)

773 
boﬁ
 
wrôe
 = 
	`nvme_is_wrôe
((
nvme_comm™d
 *)
vcmd
);

774 
nvm_dev
 *
dev
 = 
ns
->
ndev
;

775 
gídisk
 *
disk
 = 
ns
->disk;

776 
ªque°
 *
rq
;

777 
bio
 *biÿ
NULL
;

778 
__À64
 *
µa_li°
 = 
NULL
;

779 
dma_addr_t
 
µa_dma
;

780 
__À64
 *
mëad©a
 = 
NULL
;

781 
dma_addr_t
 
mëad©a_dma
;

782 
	`DECLARE_COMPLETION_ONSTACK
(
waô
);

783 
ªt
 = 0;

785 
rq
 = 
	`nvme_Æloc_ªque°
(
q
, (
nvme_comm™d
 *)
vcmd
, 0,

786 
NVME_QID_ANY
);

787 i‡(
	`IS_ERR
(
rq
)) {

788 
ªt
 = -
ENOMEM
;

789 
îr_cmd
;

792 
rq
->
timeout
 =Åimeouà?Åimeouà: 
ADMIN_TIMEOUT
;

794 i‡(
µa_buf
 && 
µa_Àn
) {

795 
µa_li°
 = 
	`dma_poﬁ_Æloc
(
dev
->
dma_poﬁ
, 
GFP_KERNEL
, &
µa_dma
);

796 i‡(!
µa_li°
) {

797 
ªt
 = -
ENOMEM
;

798 
îr_rq
;

800 i‡(
	`c›y_‰om_u£r
(
µa_li°
, (
__u£r
 *)
µa_buf
,

801 (
u64
Ë* (
µa_Àn
 + 1))) {

802 
ªt
 = -
EFAULT
;

803 
îr_µa
;

805 
vcmd
->
ph_rw
.
•ba
 = 
	`˝u_to_À64
(
µa_dma
);

807 
vcmd
->
ph_rw
.
•ba
 = 
	`˝u_to_À64
((
uöçå_t
)
µa_buf
);

810 i‡(
ubuf
 && 
bufÊí
) {

811 
ªt
 = 
	`blk_rq_m≠_u£r
(
q
, 
rq
, 
NULL
, 
ubuf
, 
bufÊí
, 
GFP_KERNEL
);

812 i‡(
ªt
)

813 
îr_µa
;

814 
bio
 = 
rq
->bio;

816 i‡(
mëa_buf
 && 
mëa_Àn
) {

817 
mëad©a
 = 
	`dma_poﬁ_Æloc
(
dev
->
dma_poﬁ
, 
GFP_KERNEL
,

818 &
mëad©a_dma
);

819 i‡(!
mëad©a
) {

820 
ªt
 = -
ENOMEM
;

821 
îr_m≠
;

824 i‡(
wrôe
) {

825 i‡(
	`c›y_‰om_u£r
(
mëad©a
,

826 (
__u£r
 *)
mëa_buf
,

827 
mëa_Àn
)) {

828 
ªt
 = -
EFAULT
;

829 
îr_mëa
;

832 
vcmd
->
ph_rw
.
mëad©a
 = 
	`˝u_to_À64
(
mëad©a_dma
);

835 
bio
->
bi_disk
 = 
disk
;

838 
	`blk_execuã_rq
(
q
, 
NULL
, 
rq
, 0);

840 i‡(
	`nvme_ªq
(
rq
)->
Êags
 & 
NVME_REQ_CANCELLED
)

841 
ªt
 = -
EINTR
;

842 i‡(
	`nvme_ªq
(
rq
)->
°©us
 & 0x7ff)

843 
ªt
 = -
EIO
;

844 i‡(
ªsu…
)

845 *
ªsu…
 = 
	`nvme_ªq
(
rq
)->
°©us
 & 0x7ff;

846 i‡(
°©us
)

847 *
°©us
 = 
	`À64_to_˝u
(
	`nvme_ªq
(
rq
)->
ªsu…
.
u64
);

849 i‡(
mëad©a
 && !
ªt
 && !
wrôe
) {

850 i‡(
	`c›y_to_u£r
(
mëa_buf
, (*)
mëad©a
, 
mëa_Àn
))

851 
ªt
 = -
EFAULT
;

853 
îr_mëa
:

854 i‡(
mëa_buf
 && 
mëa_Àn
)

855 
	`dma_poﬁ_‰ì
(
dev
->
dma_poﬁ
, 
mëad©a
, 
mëad©a_dma
);

856 
îr_m≠
:

857 i‡(
bio
)

858 
	`blk_rq_unm≠_u£r
(
bio
);

859 
îr_µa
:

860 i‡(
µa_buf
 && 
µa_Àn
)

861 
	`dma_poﬁ_‰ì
(
dev
->
dma_poﬁ
, 
µa_li°
, 
µa_dma
);

862 
îr_rq
:

863 
	`blk_mq_‰ì_ªque°
(
rq
);

864 
îr_cmd
:

865  
ªt
;

866 
	}
}

868 
	$nvme_nvm_submô_vio
(
nvme_ns
 *
ns
,

869 
nvm_u£r_vio
 
__u£r
 *
uvio
)

871 
nvm_u£r_vio
 
vio
;

872 
nvme_nvm_comm™d
 
c
;

873 
Àngth
;

874 
ªt
;

876 i‡(
	`c›y_‰om_u£r
(&
vio
, 
uvio
, (vio)))

877  -
EFAULT
;

878 i‡(
vio
.
Êags
)

879  -
EINVAL
;

881 
	`mem£t
(&
c
, 0, (c));

882 
c
.
ph_rw
.
›code
 = 
vio
.opcode;

883 
c
.
ph_rw
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

884 
c
.
ph_rw
.
c⁄åﬁ
 = 
	`˝u_to_À16
(
vio
.control);

885 
c
.
ph_rw
.
Àngth
 = 
	`˝u_to_À16
(
vio
.
≈∑s
);

887 
Àngth
 = (
vio
.
≈∑s
 + 1Ë<< 
ns
->
lba_shi·
;

889 
ªt
 = 
	`nvme_nvm_submô_u£r_cmd
(
ns
->
queue
,Çs, &
c
,

890 (
__u£r
 *)(
uöçå_t
)
vio
.
addr
, 
Àngth
,

891 (
__u£r
 *)(
uöçå_t
)
vio
.
mëad©a
,

892 
vio
.
mëad©a_Àn
,

893 (
__u£r
 *)(
uöçå_t
)
vio
.
µa_li°
, vio.
≈∑s
,

894 &
vio
.
ªsu…
, &vio.
°©us
, 0);

896 i‡(
ªt
 && 
	`c›y_to_u£r
(
uvio
, &
vio
, (vio)))

897  -
EFAULT
;

899  
ªt
;

900 
	}
}

902 
	$nvme_nvm_u£r_vcmd
(
nvme_ns
 *
ns
, 
admö
,

903 
nvm_∑s°hru_vio
 
__u£r
 *
uvcmd
)

905 
nvm_∑s°hru_vio
 
vcmd
;

906 
nvme_nvm_comm™d
 
c
;

907 
ªque°_queue
 *
q
;

908 
timeout
 = 0;

909 
ªt
;

911 i‡(
	`c›y_‰om_u£r
(&
vcmd
, 
uvcmd
, (vcmd)))

912  -
EFAULT
;

913 i‡((
vcmd
.
›code
 !0xF2Ë&& (!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)))

914  -
EACCES
;

915 i‡(
vcmd
.
Êags
)

916  -
EINVAL
;

918 
	`mem£t
(&
c
, 0, (c));

919 
c
.
comm⁄
.
›code
 = 
vcmd
.opcode;

920 
c
.
comm⁄
.
nsid
 = 
	`˝u_to_À32
(
ns
->
hód
->
ns_id
);

921 
c
.
comm⁄
.
cdw2
[0] = 
	`˝u_to_À32
(
vcmd
.cdw2);

922 
c
.
comm⁄
.
cdw2
[1] = 
	`˝u_to_À32
(
vcmd
.
cdw3
);

924 
c
.
ph_rw
.
Àngth
 = 
	`˝u_to_À16
(
vcmd
.
≈∑s
);

925 
c
.
ph_rw
.
c⁄åﬁ
 = 
	`˝u_to_À16
(
vcmd
.control);

926 
c
.
comm⁄
.
cdw13
 = 
	`˝u_to_À32
(
vcmd
.cdw13);

927 
c
.
comm⁄
.
cdw14
 = 
	`˝u_to_À32
(
vcmd
.cdw14);

928 
c
.
comm⁄
.
cdw15
 = 
	`˝u_to_À32
(
vcmd
.cdw15);

930 i‡(
vcmd
.
timeout_ms
)

931 
timeout
 = 
	`m£cs_to_jiffõs
(
vcmd
.
timeout_ms
);

933 
q
 = 
admö
 ? 
ns
->
˘æ
->
admö_q
 :Çs->
queue
;

935 
ªt
 = 
	`nvme_nvm_submô_u£r_cmd
(
q
, 
ns
,

936 (
nvme_nvm_comm™d
 *)&
c
,

937 (
__u£r
 *)(
uöçå_t
)
vcmd
.
addr
, vcmd.
d©a_Àn
,

938 (
__u£r
 *)(
uöçå_t
)
vcmd
.
mëad©a
,

939 
vcmd
.
mëad©a_Àn
,

940 (
__u£r
 *)(
uöçå_t
)
vcmd
.
µa_li°
, vcmd.
≈∑s
,

941 &
vcmd
.
ªsu…
, &vcmd.
°©us
, 
timeout
);

943 i‡(
ªt
 && 
	`c›y_to_u£r
(
uvcmd
, &
vcmd
, (vcmd)))

944  -
EFAULT
;

946  
ªt
;

947 
	}
}

949 
	$nvme_nvm_io˘l
(
nvme_ns
 *
ns
, 
cmd
, 
¨g
)

951 
cmd
) {

952 
NVME_NVM_IOCTL_ADMIN_VIO
:

953  
	`nvme_nvm_u£r_vcmd
(
ns
, 1, (
__u£r
 *)
¨g
);

954 
NVME_NVM_IOCTL_IO_VIO
:

955  
	`nvme_nvm_u£r_vcmd
(
ns
, 0, (
__u£r
 *)
¨g
);

956 
NVME_NVM_IOCTL_SUBMIT_VIO
:

957  
	`nvme_nvm_submô_vio
(
ns
, (
__u£r
 *)
¨g
);

959  -
ENOTTY
;

961 
	}
}

963 
	$nvme_nvm_ªgi°î
(
nvme_ns
 *
ns
, *
disk_«me
, 
node
)

965 
ªque°_queue
 *
q
 = 
ns
->
queue
;

966 
nvm_dev
 *
dev
;

967 
nvm_geo
 *
geo
;

969 
	`_nvme_nvm_check_size
();

971 
dev
 = 
	`nvm_Æloc_dev
(
node
);

972 i‡(!
dev
)

973  -
ENOMEM
;

976 
geo
 = &
dev
->geo;

977 
geo
->
c£cs
 = 1 << 
ns
->
lba_shi·
;

978 
geo
->
sos
 = 
ns
->
ms
;

979 
geo
->
ext
 = 
ns
->ext;

981 
dev
->
q
 = q;

982 
	`mem˝y
(
dev
->
«me
, 
disk_«me
, 
DISK_NAME_LEN
);

983 
dev
->
›s
 = &
nvme_nvm_dev_›s
;

984 
dev
->
¥iv©e_d©a
 = 
ns
;

985 
ns
->
ndev
 = 
dev
;

987  
	`nvm_ªgi°î
(
dev
);

988 
	}
}

990 
	$nvme_nvm_uƒegi°î
(
nvme_ns
 *
ns
)

992 
	`nvm_uƒegi°î
(
ns
->
ndev
);

993 
	}
}

995 
ssize_t
 
	$nvm_dev_©å_show
(
devi˚
 *
dev
,

996 
devi˚_©åibuã
 *
d©å
, *
∑ge
)

998 
nvme_ns
 *
ns
 = 
	`nvme_gë_ns_‰om_dev
(
dev
);

999 
nvm_dev
 *
ndev
 = 
ns
->ndev;

1000 
nvm_geo
 *
geo
 = &
ndev
->geo;

1001 
©åibuã
 *
©å
;

1003 i‡(!
ndev
)

1006 
©å
 = &
d©å
->attr;

1008 i‡(
	`°rcmp
(
©å
->
«me
, "version") == 0) {

1009 i‡(
geo
->
maj‹_vî_id
 == 1)

1010  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n",

1011 
geo
->
maj‹_vî_id
);

1013  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u.%u\n",

1014 
geo
->
maj‹_vî_id
,

1015 
geo
->
mö‹_vî_id
);

1016 } i‡(
	`°rcmp
(
©å
->
«me
, "capabilities") == 0) {

1017  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
ˇp
);

1018 } i‡(
	`°rcmp
(
©å
->
«me
, "read_typ") == 0) {

1019  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
ådt
);

1020 } i‡(
	`°rcmp
(
©å
->
«me
, "read_max") == 0) {

1021  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
ådm
);

1023  
	`s˙¥ötf
(
∑ge
,

1024 
PAGE_SIZE
,

1026 
©å
->
«me
, 
__func__
);

1028 
	}
}

1030 
ssize_t
 
	$nvm_dev_©å_show_µaf
(
nvm_addrf_12
 *
µaf
, *
∑ge
)

1032  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
,

1034 
µaf
->
ch_off£t
,Ö∑f->
ch_Àn
,

1035 
µaf
->
lun_off£t
,Ö∑f->
lun_Àn
,

1036 
µaf
->
∂n_off£t
,Ö∑f->
∂n_Àn
,

1037 
µaf
->
blk_off£t
,Ö∑f->
blk_Àn
,

1038 
µaf
->
pg_off£t
,Ö∑f->
pg_Àn
,

1039 
µaf
->
£c_off£t
,Ö∑f->
£c_Àn
);

1040 
	}
}

1042 
ssize_t
 
	$nvm_dev_©å_show_12
(
devi˚
 *
dev
,

1043 
devi˚_©åibuã
 *
d©å
, *
∑ge
)

1045 
nvme_ns
 *
ns
 = 
	`nvme_gë_ns_‰om_dev
(
dev
);

1046 
nvm_dev
 *
ndev
 = 
ns
->ndev;

1047 
nvm_geo
 *
geo
 = &
ndev
->geo;

1048 
©åibuã
 *
©å
;

1050 i‡(!
ndev
)

1053 
©å
 = &
d©å
->attr;

1055 i‡(
	`°rcmp
(
©å
->
«me
, "vendor_opcode") == 0) {

1056  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
vm¡
);

1057 } i‡(
	`°rcmp
(
©å
->
«me
, "device_mode") == 0) {

1058  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
dom
);

1060 } i‡(
	`°rcmp
(
©å
->
«me
, "media_manager") == 0) {

1061  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%s\n", "gennvm");

1062 } i‡(
	`°rcmp
(
©å
->
«me
, "ppa_format") == 0) {

1063  
	`nvm_dev_©å_show_µaf
((*)&
geo
->
addrf
, 
∑ge
);

1064 } i‡(
	`°rcmp
(
©å
->
«me
, "media_type") == 0) {

1065  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
mty≥
);

1066 } i‡(
	`°rcmp
(
©å
->
«me
, "flash_media_type") == 0) {

1067  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
fmty≥
);

1068 } i‡(
	`°rcmp
(
©å
->
«me
, "num_channels") == 0) {

1069  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_ch
);

1070 } i‡(
	`°rcmp
(
©å
->
«me
, "num_luns") == 0) {

1071  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_lun
);

1072 } i‡(
	`°rcmp
(
©å
->
«me
, "num_planes") == 0) {

1073  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_∂n
);

1074 } i‡(
	`°rcmp
(
©å
->
«me
, "num_blocks") == 0) {

1075  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_chk
);

1076 } i‡(
	`°rcmp
(
©å
->
«me
, "num_pages") == 0) {

1077  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_pg
);

1078 } i‡(
	`°rcmp
(
©å
->
«me
, "page_size") == 0) {

1079  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
Âg_sz
);

1080 } i‡(
	`°rcmp
(
©å
->
«me
, "hw_sector_size") == 0) {

1081  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
c£cs
);

1082 } i‡(
	`°rcmp
(
©å
->
«me
, "oob_sector_size") == 0) {

1083  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
sos
);

1084 } i‡(
	`°rcmp
(
©å
->
«me
, "prog_typ") == 0) {

1085  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
çπ
);

1086 } i‡(
	`°rcmp
(
©å
->
«me
, "prog_max") == 0) {

1087  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
çrm
);

1088 } i‡(
	`°rcmp
(
©å
->
«me
, "erase_typ") == 0) {

1089  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
tbë
);

1090 } i‡(
	`°rcmp
(
©å
->
«me
, "erase_max") == 0) {

1091  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
tbem
);

1092 } i‡(
	`°rcmp
(
©å
->
«me
, "multiplane_modes") == 0) {

1093  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "0x%08x\n", 
geo
->
mpos
);

1094 } i‡(
	`°rcmp
(
©å
->
«me
, "media_capabilities") == 0) {

1095  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "0x%08x\n", 
geo
->
mcˇp
);

1096 } i‡(
	`°rcmp
(
©å
->
«me
, "max_phys_secs") == 0) {

1097  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
NVM_MAX_VLBA
);

1099  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
,

1101 
©å
->
«me
, 
__func__
);

1103 
	}
}

1105 
ssize_t
 
	$nvm_dev_©å_show_20
(
devi˚
 *
dev
,

1106 
devi˚_©åibuã
 *
d©å
, *
∑ge
)

1108 
nvme_ns
 *
ns
 = 
	`nvme_gë_ns_‰om_dev
(
dev
);

1109 
nvm_dev
 *
ndev
 = 
ns
->ndev;

1110 
nvm_geo
 *
geo
 = &
ndev
->geo;

1111 
©åibuã
 *
©å
;

1113 i‡(!
ndev
)

1116 
©å
 = &
d©å
->attr;

1118 i‡(
	`°rcmp
(
©å
->
«me
, "groups") == 0) {

1119  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_ch
);

1120 } i‡(
	`°rcmp
(
©å
->
«me
, "punits") == 0) {

1121  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_lun
);

1122 } i‡(
	`°rcmp
(
©å
->
«me
, "chunks") == 0) {

1123  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
num_chk
);

1124 } i‡(
	`°rcmp
(
©å
->
«me
, "clba") == 0) {

1125  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
˛ba
);

1126 } i‡(
	`°rcmp
(
©å
->
«me
, "ws_min") == 0) {

1127  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
ws_mö
);

1128 } i‡(
	`°rcmp
(
©å
->
«me
, "ws_opt") == 0) {

1129  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
ws_›t
);

1130 } i‡(
	`°rcmp
(
©å
->
«me
, "maxoc") == 0) {

1131  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
maxoc
);

1132 } i‡(
	`°rcmp
(
©å
->
«me
, "maxocpu") == 0) {

1133  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
maxo˝u
);

1134 } i‡(
	`°rcmp
(
©å
->
«me
, "mw_cunits") == 0) {

1135  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
mw_cunôs
);

1136 } i‡(
	`°rcmp
(
©å
->
«me
, "write_typ") == 0) {

1137  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
çπ
);

1138 } i‡(
	`°rcmp
(
©å
->
«me
, "write_max") == 0) {

1139  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
çrm
);

1140 } i‡(
	`°rcmp
(
©å
->
«me
, "reset_typ") == 0) {

1141  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
tbë
);

1142 } i‡(
	`°rcmp
(
©å
->
«me
, "reset_max") == 0) {

1143  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
, "%u\n", 
geo
->
tbem
);

1145  
	`s˙¥ötf
(
∑ge
, 
PAGE_SIZE
,

1147 
©å
->
«me
, 
__func__
);

1149 
	}
}

1151 
	#NVM_DEV_ATTR_RO
(
_«me
) \

1152 
	`DEVICE_ATTR
(
_«me
, 
S_IRUGO
, 
nvm_dev_©å_show
, 
NULL
)

	)

1153 
	#NVM_DEV_ATTR_12_RO
(
_«me
) \

1154 
	`DEVICE_ATTR
(
_«me
, 
S_IRUGO
, 
nvm_dev_©å_show_12
, 
NULL
)

	)

1155 
	#NVM_DEV_ATTR_20_RO
(
_«me
) \

1156 
	`DEVICE_ATTR
(
_«me
, 
S_IRUGO
, 
nvm_dev_©å_show_20
, 
NULL
)

	)

1159 
NVM_DEV_ATTR_RO
(
vîsi⁄
);

1160 
NVM_DEV_ATTR_RO
(
ˇ∑bûôõs
);

1162 
NVM_DEV_ATTR_RO
(
ªad_typ
);

1163 
NVM_DEV_ATTR_RO
(
ªad_max
);

1166 
NVM_DEV_ATTR_12_RO
(
víd‹_›code
);

1167 
NVM_DEV_ATTR_12_RO
(
devi˚_mode
);

1168 
NVM_DEV_ATTR_12_RO
(
µa_f‹m©
);

1169 
NVM_DEV_ATTR_12_RO
(
medü_m™agî
);

1170 
NVM_DEV_ATTR_12_RO
(
medü_ty≥
);

1171 
NVM_DEV_ATTR_12_RO
(
Êash_medü_ty≥
);

1172 
NVM_DEV_ATTR_12_RO
(
num_ch™√ls
);

1173 
NVM_DEV_ATTR_12_RO
(
num_luns
);

1174 
NVM_DEV_ATTR_12_RO
(
num_∂™es
);

1175 
NVM_DEV_ATTR_12_RO
(
num_blocks
);

1176 
NVM_DEV_ATTR_12_RO
(
num_∑ges
);

1177 
NVM_DEV_ATTR_12_RO
(
∑ge_size
);

1178 
NVM_DEV_ATTR_12_RO
(
hw_£˘‹_size
);

1179 
NVM_DEV_ATTR_12_RO
(
oob_£˘‹_size
);

1180 
NVM_DEV_ATTR_12_RO
(
¥og_typ
);

1181 
NVM_DEV_ATTR_12_RO
(
¥og_max
);

1182 
NVM_DEV_ATTR_12_RO
(
îa£_typ
);

1183 
NVM_DEV_ATTR_12_RO
(
îa£_max
);

1184 
NVM_DEV_ATTR_12_RO
(
mu…ùœ√_modes
);

1185 
NVM_DEV_ATTR_12_RO
(
medü_ˇ∑bûôõs
);

1186 
NVM_DEV_ATTR_12_RO
(
max_phys_£cs
);

1189 
NVM_DEV_ATTR_20_RO
(
groups
);

1190 
NVM_DEV_ATTR_20_RO
(
punôs
);

1191 
NVM_DEV_ATTR_20_RO
(
chunks
);

1192 
NVM_DEV_ATTR_20_RO
(
˛ba
);

1193 
NVM_DEV_ATTR_20_RO
(
ws_mö
);

1194 
NVM_DEV_ATTR_20_RO
(
ws_›t
);

1195 
NVM_DEV_ATTR_20_RO
(
maxoc
);

1196 
NVM_DEV_ATTR_20_RO
(
maxo˝u
);

1197 
NVM_DEV_ATTR_20_RO
(
mw_cunôs
);

1198 
NVM_DEV_ATTR_20_RO
(
wrôe_typ
);

1199 
NVM_DEV_ATTR_20_RO
(
wrôe_max
);

1200 
NVM_DEV_ATTR_20_RO
(
ª£t_typ
);

1201 
NVM_DEV_ATTR_20_RO
(
ª£t_max
);

1203 
©åibuã
 *
	gnvm_dev_©ås
[] = {

1205 &
dev_©å_vîsi⁄
.
©å
,

1206 &
dev_©å_ˇ∑bûôõs
.
©å
,

1207 &
dev_©å_ªad_typ
.
©å
,

1208 &
dev_©å_ªad_max
.
©å
,

1211 &
dev_©å_víd‹_›code
.
©å
,

1212 &
dev_©å_devi˚_mode
.
©å
,

1213 &
dev_©å_medü_m™agî
.
©å
,

1214 &
dev_©å_µa_f‹m©
.
©å
,

1215 &
dev_©å_medü_ty≥
.
©å
,

1216 &
dev_©å_Êash_medü_ty≥
.
©å
,

1217 &
dev_©å_num_ch™√ls
.
©å
,

1218 &
dev_©å_num_luns
.
©å
,

1219 &
dev_©å_num_∂™es
.
©å
,

1220 &
dev_©å_num_blocks
.
©å
,

1221 &
dev_©å_num_∑ges
.
©å
,

1222 &
dev_©å_∑ge_size
.
©å
,

1223 &
dev_©å_hw_£˘‹_size
.
©å
,

1224 &
dev_©å_oob_£˘‹_size
.
©å
,

1225 &
dev_©å_¥og_typ
.
©å
,

1226 &
dev_©å_¥og_max
.
©å
,

1227 &
dev_©å_îa£_typ
.
©å
,

1228 &
dev_©å_îa£_max
.
©å
,

1229 &
dev_©å_mu…ùœ√_modes
.
©å
,

1230 &
dev_©å_medü_ˇ∑bûôõs
.
©å
,

1231 &
dev_©å_max_phys_£cs
.
©å
,

1234 &
dev_©å_groups
.
©å
,

1235 &
dev_©å_punôs
.
©å
,

1236 &
dev_©å_chunks
.
©å
,

1237 &
dev_©å_˛ba
.
©å
,

1238 &
dev_©å_ws_mö
.
©å
,

1239 &
dev_©å_ws_›t
.
©å
,

1240 &
dev_©å_maxoc
.
©å
,

1241 &
dev_©å_maxo˝u
.
©å
,

1242 &
dev_©å_mw_cunôs
.
©å
,

1244 &
dev_©å_wrôe_typ
.
©å
,

1245 &
dev_©å_wrôe_max
.
©å
,

1246 &
dev_©å_ª£t_typ
.
©å
,

1247 &
dev_©å_ª£t_max
.
©å
,

1249 
NULL
,

1252 
umode_t
 
	$nvm_dev_©ås_visibÀ
(
kobje˘
 *
kobj
,

1253 
©åibuã
 *
©å
, 
ödex
)

1255 
devi˚
 *
dev
 = 
	`c⁄èöî_of
(
kobj
, device, kobj);

1256 
gídisk
 *
disk
 = 
	`dev_to_disk
(
dev
);

1257 
nvme_ns
 *
ns
 = 
disk
->
¥iv©e_d©a
;

1258 
nvm_dev
 *
ndev
 = 
ns
->ndev;

1259 
devi˚_©åibuã
 *
dev_©å
 =

1260 
	`c⁄èöî_of
(
©å
, 
	`ty≥of
(*
dev_©å
),áttr);

1262 i‡(!
ndev
)

1265 i‡(
dev_©å
->
show
 =
nvm_dev_©å_show
)

1266  
©å
->
mode
;

1268 
ndev
->
geo
.
maj‹_vî_id
) {

1270 i‡(
dev_©å
->
show
 =
nvm_dev_©å_show_12
)

1271  
©å
->
mode
;

1274 i‡(
dev_©å
->
show
 =
nvm_dev_©å_show_20
)

1275  
©å
->
mode
;

1280 
	}
}

1282 c⁄° 
©åibuã_group
 
	gnvme_nvm_©å_group
 = {

1283 .
«me
 = "lightnvm",

1284 .
	g©ås
 = 
nvm_dev_©ås
,

1285 .
	gis_visibÀ
 = 
nvm_dev_©ås_visibÀ
,

	@multipath.c

6 
	~<löux/moduÀ∑øm.h
>

7 
	~<åa˚/evíts/block.h
>

8 
	~"nvme.h
"

10 
boﬁ
 
	gmu…ù©h
 = 
åue
;

11 
moduÀ_∑øm
(
mu…ù©h
, 
boﬁ
, 0444);

12 
MODULE_PARM_DESC
(
mu…ù©h
,

15 
ölöe
 
boﬁ
 
	$nvme_˘æ_u£_™a
(
nvme_˘æ
 *
˘æ
)

17  
mu…ù©h
 && 
˘æ
->
subsys
 && (˘æ->subsys->
cmic
 & (1 << 3));

18 
	}
}

27 
	$nvme_£t_disk_«me
(*
disk_«me
, 
nvme_ns
 *
ns
,

28 
nvme_˘æ
 *
˘æ
, *
Êags
)

30 i‡(!
mu…ù©h
) {

31 
	`•rötf
(
disk_«me
, "nvme%dn%d", 
˘æ
->
ö°™˚
, 
ns
->
hód
->instance);

32 } i‡(
ns
->
hód
->
disk
) {

33 
	`•rötf
(
disk_«me
, "nvme%dc%dn%d", 
˘æ
->
subsys
->
ö°™˚
,

34 
˘æ
->
˙éid
, 
ns
->
hód
->
ö°™˚
);

35 *
Êags
 = 
GENHD_FL_HIDDEN
;

37 
	`•rötf
(
disk_«me
, "nvme%dn%d", 
˘æ
->
subsys
->
ö°™˚
,

38 
ns
->
hód
->
ö°™˚
);

40 
	}
}

42 
	$nvme_Áûovî_ªq
(
ªque°
 *
ªq
)

44 
nvme_ns
 *
ns
 = 
ªq
->
q
->
queued©a
;

45 
u16
 
°©us
 = 
	`nvme_ªq
(
ªq
)->status;

46 
Êags
;

48 
	`•ö_lock_úqßve
(&
ns
->
hód
->
ªqueue_lock
, 
Êags
);

49 
	`blk_°ól_bios
(&
ns
->
hód
->
ªqueue_li°
, 
ªq
);

50 
	`•ö_u∆ock_úqª°‹e
(&
ns
->
hód
->
ªqueue_lock
, 
Êags
);

51 
	`blk_mq_íd_ªque°
(
ªq
, 0);

53 
°©us
 & 0x7ff) {

54 
NVME_SC_ANA_TRANSITION
:

55 
NVME_SC_ANA_INACCESSIBLE
:

56 
NVME_SC_ANA_PERSISTENT_LOSS
:

66 
	`nvme_m∑th_˛ór_cuºít_∑th
(
ns
);

67 i‡(
ns
->
˘æ
->
™a_log_buf
) {

68 
	`£t_bô
(
NVME_NS_ANA_PENDING
, &
ns
->
Êags
);

69 
	`queue_w‹k
(
nvme_wq
, &
ns
->
˘æ
->
™a_w‹k
);

72 
NVME_SC_HOST_PATH_ERROR
:

77 
	`nvme_m∑th_˛ór_cuºít_∑th
(
ns
);

84 
	`nvme_ª£t_˘æ
(
ns
->
˘æ
);

88 
	`kblockd_scheduÀ_w‹k
(&
ns
->
hód
->
ªqueue_w‹k
);

89 
	}
}

91 
	$nvme_kick_ªqueue_li°s
(
nvme_˘æ
 *
˘æ
)

93 
nvme_ns
 *
ns
;

95 
	`down_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

96 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
) {

97 i‡(
ns
->
hód
->
disk
)

98 
	`kblockd_scheduÀ_w‹k
(&
ns
->
hód
->
ªqueue_w‹k
);

100 
	`up_ªad
(&
˘æ
->
«me•a˚s_rw£m
);

101 
	}
}

103 c⁄° *
	gnvme_™a_°©e_«mes
[] = {

105 [
NVME_ANA_OPTIMIZED
] = "optimized",

106 [
NVME_ANA_NONOPTIMIZED
] = "non-optimized",

107 [
NVME_ANA_INACCESSIBLE
] = "inaccessible",

108 [
NVME_ANA_PERSISTENT_LOSS
] = "persistent-loss",

109 [
NVME_ANA_CHANGE
] = "change",

112 
	$nvme_m∑th_˛ór_cuºít_∑th
(
nvme_ns
 *
ns
)

114 
nvme_ns_hód
 *
hód
 = 
ns
->head;

115 
node
;

117 i‡(!
hód
)

120 
	`f‹_óch_node
(
node
) {

121 i‡(
ns
 =
	`rcu_ac˚ss_poöãr
(
hód
->
cuºít_∑th
[
node
]))

122 
	`rcu_assign_poöãr
(
hód
->
cuºít_∑th
[
node
], 
NULL
);

124 
	}
}

126 
nvme_ns
 *
	$__nvme_föd_∑th
(
nvme_ns_hód
 *
hód
, 
node
)

128 
found_di°™˚
 = 
INT_MAX
, 
ÁŒback_di°™˚
 = INT_MAX, 
di°™˚
;

129 
nvme_ns
 *
found
 = 
NULL
, *
ÁŒback
 = NULL, *
ns
;

131 
	`li°_f‹_óch_íåy_rcu
(
ns
, &
hód
->
li°
, 
siblögs
) {

132 i‡(
ns
->
˘æ
->
°©e
 !
NVME_CTRL_LIVE
 ||

133 
	`ã°_bô
(
NVME_NS_ANA_PENDING
, &
ns
->
Êags
))

136 i‡(
	`READ_ONCE
(
hód
->
subsys
->
i›ﬁicy
Ë=
NVME_IOPOLICY_NUMA
)

137 
di°™˚
 = 
	`node_di°™˚
(
node
, 
ns
->
˘æ
->
numa_node
);

139 
di°™˚
 = 
LOCAL_DISTANCE
;

141 
ns
->
™a_°©e
) {

142 
NVME_ANA_OPTIMIZED
:

143 i‡(
di°™˚
 < 
found_di°™˚
) {

144 
found_di°™˚
 = 
di°™˚
;

145 
found
 = 
ns
;

148 
NVME_ANA_NONOPTIMIZED
:

149 i‡(
di°™˚
 < 
ÁŒback_di°™˚
) {

150 
ÁŒback_di°™˚
 = 
di°™˚
;

151 
ÁŒback
 = 
ns
;

159 i‡(!
found
)

160 
found
 = 
ÁŒback
;

161 i‡(
found
)

162 
	`rcu_assign_poöãr
(
hód
->
cuºít_∑th
[
node
], 
found
);

163  
found
;

164 
	}
}

166 
nvme_ns
 *
	$nvme_√xt_ns
(
nvme_ns_hód
 *
hód
,

167 
nvme_ns
 *
ns
)

169 
ns
 = 
	`li°_√xt_‹_nuŒ_rcu
(&
hód
->
li°
, &ns->
siblögs
, 
nvme_ns
,

170 
siblögs
);

171 i‡(
ns
)

172  
ns
;

173  
	`li°_fú°_‹_nuŒ_rcu
(&
hód
->
li°
, 
nvme_ns
, 
siblögs
);

174 
	}
}

176 
nvme_ns
 *
	$nvme_round_robö_∑th
(
nvme_ns_hód
 *
hód
,

177 
node
, 
nvme_ns
 *
ﬁd
)

179 
nvme_ns
 *
ns
, *
found
, *
ÁŒback
 = 
NULL
;

181 i‡(
	`li°_is_söguœr
(&
hód
->
li°
))

182  
ﬁd
;

184 
ns
 = 
	`nvme_√xt_ns
(
hód
, 
ﬁd
);

185 
ns
 !
ﬁd
;

186 
ns
 = 
	`nvme_√xt_ns
(
hód
,Çs)) {

187 i‡(
ns
->
˘æ
->
°©e
 !
NVME_CTRL_LIVE
 ||

188 
	`ã°_bô
(
NVME_NS_ANA_PENDING
, &
ns
->
Êags
))

191 i‡(
ns
->
™a_°©e
 =
NVME_ANA_OPTIMIZED
) {

192 
found
 = 
ns
;

193 
out
;

195 i‡(
ns
->
™a_°©e
 =
NVME_ANA_NONOPTIMIZED
)

196 
ÁŒback
 = 
ns
;

199 i‡(!
ÁŒback
)

200  
NULL
;

201 
found
 = 
ÁŒback
;

202 
out
:

203 
	`rcu_assign_poöãr
(
hód
->
cuºít_∑th
[
node
], 
found
);

204  
found
;

205 
	}
}

207 
ölöe
 
boﬁ
 
	$nvme_∑th_is_›timized
(
nvme_ns
 *
ns
)

209  
ns
->
˘æ
->
°©e
 =
NVME_CTRL_LIVE
 &&

210 
ns
->
™a_°©e
 =
NVME_ANA_OPTIMIZED
;

211 
	}
}

213 
ölöe
 
nvme_ns
 *
	$nvme_föd_∑th
(
nvme_ns_hód
 *
hód
)

215 
node
 = 
	`numa_node_id
();

216 
nvme_ns
 *
ns
;

218 
ns
 = 
	`§cu_dîe„ªn˚
(
hód
->
cuºít_∑th
[
node
], &hód->
§cu
);

219 i‡(
	`READ_ONCE
(
hód
->
subsys
->
i›ﬁicy
Ë=
NVME_IOPOLICY_RR
 && 
ns
)

220 
ns
 = 
	`nvme_round_robö_∑th
(
hód
, 
node
,Çs);

221 i‡(
	`u∆ikñy
(!
ns
 || !
	`nvme_∑th_is_›timized
(ns)))

222 
ns
 = 
	`__nvme_föd_∑th
(
hód
, 
node
);

223  
ns
;

224 
	}
}

226 
blk_qc_t
 
	$nvme_ns_hód_make_ªque°
(
ªque°_queue
 *
q
,

227 
bio
 *bio)

229 
nvme_ns_hód
 *
hód
 = 
q
->
queued©a
;

230 
devi˚
 *
dev
 = 
	`disk_to_dev
(
hód
->
disk
);

231 
nvme_ns
 *
ns
;

232 
blk_qc_t
 
ªt
 = 
BLK_QC_T_NONE
;

233 
§cu_idx
;

235 
§cu_idx
 = 
	`§cu_ªad_lock
(&
hód
->
§cu
);

236 
ns
 = 
	`nvme_föd_∑th
(
hód
);

237 i‡(
	`likñy
(
ns
)) {

238 
bio
->
bi_disk
 = 
ns
->
disk
;

239 
bio
->
bi_›f
 |
REQ_NVME_MPATH
;

240 
	`åa˚_block_bio_ªm≠
(
bio
->
bi_disk
->
queue
, bio,

241 
	`disk_devt
(
ns
->
hód
->
disk
),

242 
bio
->
bi_ôî
.
bi_£˘‹
);

243 
ªt
 = 
	`dúe˘_make_ªque°
(
bio
);

244 } i‡(!
	`li°_em±y_ˇªful
(&
hód
->
li°
)) {

245 
	`dev_w¨n_øãlimôed
(
dev
, "noÖathávailable -Ñequeuing I/O\n");

247 
	`•ö_lock_úq
(&
hód
->
ªqueue_lock
);

248 
	`bio_li°_add
(&
hód
->
ªqueue_li°
, 
bio
);

249 
	`•ö_u∆ock_úq
(&
hód
->
ªqueue_lock
);

251 
	`dev_w¨n_øãlimôed
(
dev
, "noÖath - failing I/O\n");

253 
bio
->
bi_°©us
 = 
BLK_STS_IOERR
;

254 
	`bio_ídio
(
bio
);

257 
	`§cu_ªad_u∆ock
(&
hód
->
§cu
, 
§cu_idx
);

258  
ªt
;

259 
	}
}

261 
	$nvme_ªqueue_w‹k
(
w‹k_°ru˘
 *
w‹k
)

263 
nvme_ns_hód
 *
hód
 =

264 
	`c⁄èöî_of
(
w‹k
, 
nvme_ns_hód
, 
ªqueue_w‹k
);

265 
bio
 *bio, *
√xt
;

267 
	`•ö_lock_úq
(&
hód
->
ªqueue_lock
);

268 
√xt
 = 
	`bio_li°_gë
(&
hód
->
ªqueue_li°
);

269 
	`•ö_u∆ock_úq
(&
hód
->
ªqueue_lock
);

271 (
bio
 = 
√xt
Ë!
NULL
) {

272 
√xt
 = 
bio
->
bi_√xt
;

273 
bio
->
bi_√xt
 = 
NULL
;

279 
bio
->
bi_disk
 = 
hód
->
disk
;

280 
	`gíîic_make_ªque°
(
bio
);

282 
	}
}

284 
	$nvme_m∑th_Æloc_disk
(
nvme_˘æ
 *
˘æ
, 
nvme_ns_hód
 *
hód
)

286 
ªque°_queue
 *
q
;

287 
boﬁ
 
vwc
 = 
Ál£
;

289 
	`muãx_öô
(&
hód
->
lock
);

290 
	`bio_li°_öô
(&
hód
->
ªqueue_li°
);

291 
	`•ö_lock_öô
(&
hód
->
ªqueue_lock
);

292 
	`INIT_WORK
(&
hód
->
ªqueue_w‹k
, 
nvme_ªqueue_w‹k
);

299 i‡(!(
˘æ
->
subsys
->
cmic
 & (1 << 1)Ë|| !
mu…ù©h
)

302 
q
 = 
	`blk_Æloc_queue_node
(
GFP_KERNEL
, 
˘æ
->
numa_node
);

303 i‡(!
q
)

304 
out
;

305 
q
->
queued©a
 = 
hód
;

306 
	`blk_queue_make_ªque°
(
q
, 
nvme_ns_hód_make_ªque°
);

307 
	`blk_queue_Êag_£t
(
QUEUE_FLAG_NONROT
, 
q
);

309 
	`blk_queue_logiˇl_block_size
(
q
, 512);

310 
	`blk_£t_°ackög_limôs
(&
q
->
limôs
);

313 i‡(
˘æ
->
vwc
 & 
NVME_CTRL_VWC_PRESENT
)

314 
vwc
 = 
åue
;

315 
	`blk_queue_wrôe_ˇche
(
q
, 
vwc
, vwc);

317 
hód
->
disk
 = 
	`Æloc_disk
(0);

318 i‡(!
hód
->
disk
)

319 
out_˛ónup_queue
;

320 
hód
->
disk
->
f›s
 = &
nvme_ns_hód_›s
;

321 
hód
->
disk
->
¥iv©e_d©a
 = head;

322 
hód
->
disk
->
queue
 = 
q
;

323 
hód
->
disk
->
Êags
 = 
GENHD_FL_EXT_DEVT
;

324 
	`•rötf
(
hód
->
disk
->
disk_«me
, "nvme%dn%d",

325 
˘æ
->
subsys
->
ö°™˚
, 
hód
->instance);

328 
out_˛ónup_queue
:

329 
	`blk_˛ónup_queue
(
q
);

330 
out
:

331  -
ENOMEM
;

332 
	}
}

334 
	$nvme_m∑th_£t_live
(
nvme_ns
 *
ns
)

336 
nvme_ns_hód
 *
hód
 = 
ns
->head;

338 
	`lockdï_as£π_hñd
(&
ns
->
hód
->
lock
);

340 i‡(!
hód
->
disk
)

343 i‡(!(
hód
->
disk
->
Êags
 & 
GENHD_FL_UP
))

344 
	`devi˚_add_disk
(&
hód
->
subsys
->
dev
, hód->
disk
,

345 
nvme_ns_id_©å_groups
);

347 i‡(
	`nvme_∑th_is_›timized
(
ns
)) {

348 
node
, 
§cu_idx
;

350 
§cu_idx
 = 
	`§cu_ªad_lock
(&
hód
->
§cu
);

351 
	`f‹_óch_node
(
node
)

352 
	`__nvme_föd_∑th
(
hód
, 
node
);

353 
	`§cu_ªad_u∆ock
(&
hód
->
§cu
, 
§cu_idx
);

356 
	`kblockd_scheduÀ_w‹k
(&
ns
->
hód
->
ªqueue_w‹k
);

357 
	}
}

359 
	$nvme_∑r£_™a_log
(
nvme_˘æ
 *
˘æ
, *
d©a
,

360 (*
cb
)(
nvme_˘æ
 *
˘æ
, 
nvme_™a_group_desc
 *,

363 *
ba£
 = 
˘æ
->
™a_log_buf
;

364 
size_t
 
off£t
 = (
nvme_™a_r•_hdr
);

365 
îr‹
, 
i
;

367 
	`lockdï_as£π_hñd
(&
˘æ
->
™a_lock
);

369 
i
 = 0; i < 
	`À16_to_˝u
(
˘æ
->
™a_log_buf
->
ngΩs
); i++) {

370 
nvme_™a_group_desc
 *
desc
 = 
ba£
 + 
off£t
;

371 
u32
 
ƒ_nsids
 = 
	`À32_to_˝u
(
desc
->
¬sids
);

372 
size_t
 
nsid_buf_size
 = 
ƒ_nsids
 * (
__À32
);

374 i‡(
	`WARN_ON_ONCE
(
desc
->
gΩid
 == 0))

375  -
EINVAL
;

376 i‡(
	`WARN_ON_ONCE
(
	`À32_to_˝u
(
desc
->
gΩid
Ë> 
˘æ
->
™agΩmax
))

377  -
EINVAL
;

378 i‡(
	`WARN_ON_ONCE
(
desc
->
°©e
 == 0))

379  -
EINVAL
;

380 i‡(
	`WARN_ON_ONCE
(
desc
->
°©e
 > 
NVME_ANA_CHANGE
))

381  -
EINVAL
;

383 
off£t
 +(*
desc
);

384 i‡(
	`WARN_ON_ONCE
(
off£t
 > 
˘æ
->
™a_log_size
 - 
nsid_buf_size
))

385  -
EINVAL
;

387 
îr‹
 = 
	`cb
(
˘æ
, 
desc
, 
d©a
);

388 i‡(
îr‹
)

389  
îr‹
;

391 
off£t
 +
nsid_buf_size
;

392 i‡(
	`WARN_ON_ONCE
(
off£t
 > 
˘æ
->
™a_log_size
 - (*
desc
)))

393  -
EINVAL
;

397 
	}
}

399 
ölöe
 
boﬁ
 
	$nvme_°©e_is_live
(
nvme_™a_°©e
 
°©e
)

401  
°©e
 =
NVME_ANA_OPTIMIZED
 || sèã =
NVME_ANA_NONOPTIMIZED
;

402 
	}
}

404 
	$nvme_upd©e_ns_™a_°©e
(
nvme_™a_group_desc
 *
desc
,

405 
nvme_ns
 *
ns
)

407 
	`muãx_lock
(&
ns
->
hód
->
lock
);

408 
ns
->
™a_gΩid
 = 
	`À32_to_˝u
(
desc
->
gΩid
);

409 
ns
->
™a_°©e
 = 
desc
->
°©e
;

410 
	`˛ór_bô
(
NVME_NS_ANA_PENDING
, &
ns
->
Êags
);

412 i‡(
	`nvme_°©e_is_live
(
ns
->
™a_°©e
))

413 
	`nvme_m∑th_£t_live
(
ns
);

414 
	`muãx_u∆ock
(&
ns
->
hód
->
lock
);

415 
	}
}

417 
	$nvme_upd©e_™a_°©e
(
nvme_˘æ
 *
˘æ
,

418 
nvme_™a_group_desc
 *
desc
, *
d©a
)

420 
u32
 
ƒ_nsids
 = 
	`À32_to_˝u
(
desc
->
¬sids
), 
n
 = 0;

421 *
ƒ_ch™ge_groups
 = 
d©a
;

422 
nvme_ns
 *
ns
;

424 
	`dev_öfo
(
˘æ
->
devi˚
, "ANA group %d: %s.\n",

425 
	`À32_to_˝u
(
desc
->
gΩid
),

426 
nvme_™a_°©e_«mes
[
desc
->
°©e
]);

428 i‡(
desc
->
°©e
 =
NVME_ANA_CHANGE
)

429 (*
ƒ_ch™ge_groups
)++;

431 i‡(!
ƒ_nsids
)

434 
	`down_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

435 
	`li°_f‹_óch_íåy
(
ns
, &
˘æ
->
«me•a˚s
, 
li°
) {

436 i‡(
ns
->
hód
->
ns_id
 !
	`À32_to_˝u
(
desc
->
nsids
[
n
]))

438 
	`nvme_upd©e_ns_™a_°©e
(
desc
, 
ns
);

439 i‡(++
n
 =
ƒ_nsids
)

442 
	`up_wrôe
(&
˘æ
->
«me•a˚s_rw£m
);

443 
	`WARN_ON_ONCE
(
n
 < 
ƒ_nsids
);

445 
	}
}

447 
	$nvme_ªad_™a_log
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
groups_⁄ly
)

449 
u32
 
ƒ_ch™ge_groups
 = 0;

450 
îr‹
;

452 
	`muãx_lock
(&
˘æ
->
™a_lock
);

453 
îr‹
 = 
	`nvme_gë_log
(
˘æ
, 
NVME_NSID_ALL
, 
NVME_LOG_ANA
,

454 
groups_⁄ly
 ? 
NVME_ANA_LOG_RGO
 : 0,

455 
˘æ
->
™a_log_buf
, cål->
™a_log_size
, 0);

456 i‡(
îr‹
) {

457 
	`dev_w¨n
(
˘æ
->
devi˚
, "FaûedÅÿgë ANAÜog: %d\n", 
îr‹
);

458 
out_u∆ock
;

461 
îr‹
 = 
	`nvme_∑r£_™a_log
(
˘æ
, &
ƒ_ch™ge_groups
,

462 
nvme_upd©e_™a_°©e
);

463 i‡(
îr‹
)

464 
out_u∆ock
;

477 i‡(
ƒ_ch™ge_groups
)

478 
	`mod_timî
(&
˘æ
->
™©t_timî
, cål->
™©t
 * 
HZ
 * 2 + 
jiffõs
);

480 
	`dñ_timî_sync
(&
˘æ
->
™©t_timî
);

481 
out_u∆ock
:

482 
	`muãx_u∆ock
(&
˘æ
->
™a_lock
);

483  
îr‹
;

484 
	}
}

486 
	$nvme_™a_w‹k
(
w‹k_°ru˘
 *
w‹k
)

488 
nvme_˘æ
 *
˘æ
 = 
	`c⁄èöî_of
(
w‹k
, nvme_˘æ, 
™a_w‹k
);

490 
	`nvme_ªad_™a_log
(
˘æ
, 
Ál£
);

491 
	}
}

493 
	$nvme_™©t_timeout
(
timî_li°
 *
t
)

495 
nvme_˘æ
 *
˘æ
 = 
	`‰om_timî
(˘æ, 
t
, 
™©t_timî
);

497 
	`dev_öfo
(
˘æ
->
devi˚
, "ANATTÅimeout,Ñesetting controller.\n");

498 
	`nvme_ª£t_˘æ
(
˘æ
);

499 
	}
}

501 
	$nvme_m∑th_°›
(
nvme_˘æ
 *
˘æ
)

503 i‡(!
	`nvme_˘æ_u£_™a
(
˘æ
))

505 
	`dñ_timî_sync
(&
˘æ
->
™©t_timî
);

506 
	`ˇn˚l_w‹k_sync
(&
˘æ
->
™a_w‹k
);

507 
	}
}

509 
	#SUBSYS_ATTR_RW
(
_«me
, 
_mode
, 
_show
, 
_°‹e
) \

510 
devi˚_©åibuã
 
subsys_©å_
##
_«me
 = \

511 
	`__ATTR
(
_«me
, 
_mode
, 
_show
, 
_°‹e
)

	)

513 c⁄° *
	gnvme_i›ﬁicy_«mes
[] = {

514 [
NVME_IOPOLICY_NUMA
] = "numa",

515 [
NVME_IOPOLICY_RR
] = "round-robin",

518 
ssize_t
 
	$nvme_subsys_i›ﬁicy_show
(
devi˚
 *
dev
,

519 
devi˚_©åibuã
 *
©å
, *
buf
)

521 
nvme_subsy°em
 *
subsys
 =

522 
	`c⁄èöî_of
(
dev
, 
nvme_subsy°em
, dev);

524  
	`•rötf
(
buf
, "%s\n",

525 
nvme_i›ﬁicy_«mes
[
	`READ_ONCE
(
subsys
->
i›ﬁicy
)]);

526 
	}
}

528 
ssize_t
 
	$nvme_subsys_i›ﬁicy_°‹e
(
devi˚
 *
dev
,

529 
devi˚_©åibuã
 *
©å
, c⁄° *
buf
, 
size_t
 
cou¡
)

531 
nvme_subsy°em
 *
subsys
 =

532 
	`c⁄èöî_of
(
dev
, 
nvme_subsy°em
, dev);

533 
i
;

535 
i
 = 0; i < 
	`ARRAY_SIZE
(
nvme_i›ﬁicy_«mes
); i++) {

536 i‡(
	`sysfs_°ªq
(
buf
, 
nvme_i›ﬁicy_«mes
[
i
])) {

537 
	`WRITE_ONCE
(
subsys
->
i›ﬁicy
, 
i
);

538  
cou¡
;

542  -
EINVAL
;

543 
	}
}

544 
SUBSYS_ATTR_RW
(
i›ﬁicy
, 
S_IRUGO
 | 
S_IWUSR
,

545 
nvme_subsys_i›ﬁicy_show
, 
nvme_subsys_i›ﬁicy_°‹e
);

547 
ssize_t
 
	$™a_gΩid_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

548 *
buf
)

550  
	`•rötf
(
buf
, "%d\n", 
	`nvme_gë_ns_‰om_dev
(
dev
)->
™a_gΩid
);

551 
	}
}

552 
DEVICE_ATTR_RO
(
™a_gΩid
);

554 
ssize_t
 
	$™a_°©e_show
(
devi˚
 *
dev
, 
devi˚_©åibuã
 *
©å
,

555 *
buf
)

557 
nvme_ns
 *
ns
 = 
	`nvme_gë_ns_‰om_dev
(
dev
);

559  
	`•rötf
(
buf
, "%s\n", 
nvme_™a_°©e_«mes
[
ns
->
™a_°©e
]);

560 
	}
}

561 
DEVICE_ATTR_RO
(
™a_°©e
);

563 
	$nvme_£t_ns_™a_°©e
(
nvme_˘æ
 *
˘æ
,

564 
nvme_™a_group_desc
 *
desc
, *
d©a
)

566 
nvme_ns
 *
ns
 = 
d©a
;

568 i‡(
ns
->
™a_gΩid
 =
	`À32_to_˝u
(
desc
->
gΩid
)) {

569 
	`nvme_upd©e_ns_™a_°©e
(
desc
, 
ns
);

570  -
ENXIO
;

574 
	}
}

576 
	$nvme_m∑th_add_disk
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
)

578 i‡(
	`nvme_˘æ_u£_™a
(
ns
->
˘æ
)) {

579 
	`muãx_lock
(&
ns
->
˘æ
->
™a_lock
);

580 
ns
->
™a_gΩid
 = 
	`À32_to_˝u
(
id
->
™agΩid
);

581 
	`nvme_∑r£_™a_log
(
ns
->
˘æ
,Çs, 
nvme_£t_ns_™a_°©e
);

582 
	`muãx_u∆ock
(&
ns
->
˘æ
->
™a_lock
);

584 
	`muãx_lock
(&
ns
->
hód
->
lock
);

585 
ns
->
™a_°©e
 = 
NVME_ANA_OPTIMIZED
;

586 
	`nvme_m∑th_£t_live
(
ns
);

587 
	`muãx_u∆ock
(&
ns
->
hód
->
lock
);

589 
	}
}

591 
	$nvme_m∑th_ªmove_disk
(
nvme_ns_hód
 *
hód
)

593 i‡(!
hód
->
disk
)

595 i‡(
hód
->
disk
->
Êags
 & 
GENHD_FL_UP
)

596 
	`dñ_gídisk
(
hód
->
disk
);

597 
	`blk_£t_queue_dyög
(
hód
->
disk
->
queue
);

599 
	`kblockd_scheduÀ_w‹k
(&
hód
->
ªqueue_w‹k
);

600 
	`Êush_w‹k
(&
hód
->
ªqueue_w‹k
);

601 
	`blk_˛ónup_queue
(
hód
->
disk
->
queue
);

602 
	`put_disk
(
hód
->
disk
);

603 
	}
}

605 
	$nvme_m∑th_öô
(
nvme_˘æ
 *
˘æ
, 
nvme_id_˘æ
 *
id
)

607 
îr‹
;

609 i‡(!
	`nvme_˘æ_u£_™a
(
˘æ
))

612 
˘æ
->
™aˇp
 = 
id
->anacap;

613 
˘æ
->
™©t
 = 
id
->anatt;

614 
˘æ
->
««gΩid
 = 
	`À32_to_˝u
(
id
->nanagrpid);

615 
˘æ
->
™agΩmax
 = 
	`À32_to_˝u
(
id
->anagrpmax);

617 
	`muãx_öô
(&
˘æ
->
™a_lock
);

618 
	`timî_£tup
(&
˘æ
->
™©t_timî
, 
nvme_™©t_timeout
, 0);

619 
˘æ
->
™a_log_size
 = (
nvme_™a_r•_hdr
) +

620 
˘æ
->
««gΩid
 * (
nvme_™a_group_desc
);

621 
˘æ
->
™a_log_size
 +˘æ->
max_«me•a˚s
 * (
__À32
);

623 i‡(
˘æ
->
™a_log_size
 > cål->
max_hw_£˘‹s
 << 
SECTOR_SHIFT
) {

624 
	`dev_îr
(
˘æ
->
devi˚
,

626 
˘æ
->
™a_log_size
,

627 
˘æ
->
max_hw_£˘‹s
 << 
SECTOR_SHIFT
);

628 
	`dev_îr
(
˘æ
->
devi˚
, "disabling ANA support.\n");

632 
	`INIT_WORK
(&
˘æ
->
™a_w‹k
, 
nvme_™a_w‹k
);

633 
˘æ
->
™a_log_buf
 = 
	`kmÆloc
(˘æ->
™a_log_size
, 
GFP_KERNEL
);

634 i‡(!
˘æ
->
™a_log_buf
) {

635 
îr‹
 = -
ENOMEM
;

636 
out
;

639 
îr‹
 = 
	`nvme_ªad_™a_log
(
˘æ
, 
åue
);

640 i‡(
îr‹
)

641 
out_‰ì_™a_log_buf
;

643 
out_‰ì_™a_log_buf
:

644 
	`k‰ì
(
˘æ
->
™a_log_buf
);

645 
˘æ
->
™a_log_buf
 = 
NULL
;

646 
out
:

647  
îr‹
;

648 
	}
}

650 
	$nvme_m∑th_unöô
(
nvme_˘æ
 *
˘æ
)

652 
	`k‰ì
(
˘æ
->
™a_log_buf
);

653 
˘æ
->
™a_log_buf
 = 
NULL
;

654 
	}
}

	@nvme-core.mod.c

1 
	~<löux/buûd-ß….h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/vîmagic.h
>

4 
	~<löux/compûî.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

11 
__visibÀ
 
moduÀ
 
__this_moduÀ


12 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

13 .
«me
 = 
KBUILD_MODNAME
,

14 .
	göô
 = 
öô_moduÀ
,

15 #ifde‡
CONFIG_MODULE_UNLOAD


16 .
	gexô
 = 
˛ónup_moduÀ
,

18 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

21 #ifde‡
CONFIG_RETPOLINE


22 
MODULE_INFO
(
ªçﬁöe
, "Y");

25 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

26 
__u£d


27 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

215 c⁄° 
	g__moduÀ_dïíds
[]

216 
__u£d


217 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

221 
MODULE_INFO
(
§cvîsi⁄
, "4E1A71A7CC8449B6B3F63C2");

	@nvme.h

6 #i‚de‡
_NVME_H


7 
	#_NVME_H


	)

9 
	~<löux/nvme.h
>

10 
	~<löux/cdev.h
>

11 
	~<löux/pci.h
>

12 
	~<löux/kªf.h
>

13 
	~<löux/blk-mq.h
>

14 
	~<löux/lighävm.h
>

15 
	~<löux/£d-›Æ.h
>

16 
	~<löux/Áu…-öje˘.h
>

17 
	~<löux/rcupd©e.h
>

19 
nvme_io_timeout
;

20 
	#NVME_IO_TIMEOUT
 (
nvme_io_timeout
 * 
HZ
)

	)

22 
admö_timeout
;

23 
	#ADMIN_TIMEOUT
 (
admö_timeout
 * 
HZ
)

	)

25 
	#NVME_DEFAULT_KATO
 5

	)

26 
	#NVME_KATO_GRACE
 10

	)

28 
w‹kqueue_°ru˘
 *
nvme_wq
;

29 
w‹kqueue_°ru˘
 *
nvme_ª£t_wq
;

30 
w‹kqueue_°ru˘
 *
nvme_dñëe_wq
;

33 
	mNVME_NS_LBA
 = 0,

34 
	mNVME_NS_LIGHTNVM
 = 1,

41 
	envme_quúks
 {

46 
	mNVME_QUIRK_STRIPE_SIZE
 = (1 << 0),

52 
	mNVME_QUIRK_IDENTIFY_CNS
 = (1 << 1),

58 
	mNVME_QUIRK_DEALLOCATE_ZEROES
 = (1 << 2),

64 
	mNVME_QUIRK_DELAY_BEFORE_CHK_RDY
 = (1 << 3),

69 
	mNVME_QUIRK_NO_APST
 = (1 << 4),

74 
	mNVME_QUIRK_NO_DEEPEST_PS
 = (1 << 5),

79 
	mNVME_QUIRK_LIGHTNVM
 = (1 << 6),

84 
	mNVME_QUIRK_MEDIUM_PRIO_SQ
 = (1 << 7),

89 
	mNVME_QUIRK_IGNORE_DEV_SUBNQN
 = (1 << 8),

94 
	mNVME_QUIRK_DISABLE_WRITE_ZEROES
 = (1 << 9),

101 
	snvme_ªque°
 {

102 
nvme_comm™d
 *
	mcmd
;

103 
nvme_ªsu…
 
	mªsu…
;

104 
u8
 
	mªåõs
;

105 
u8
 
	mÊags
;

106 
u16
 
	m°©us
;

107 
nvme_˘æ
 *
	m˘æ
;

113 
	#REQ_NVME_MPATH
 
REQ_DRV


	)

116 
	mNVME_REQ_CANCELLED
 = (1 << 0),

117 
	mNVME_REQ_USERCMD
 = (1 << 1),

120 
ölöe
 
nvme_ªque°
 *
	$nvme_ªq
(
ªque°
 *
ªq
)

122  
	`blk_mq_rq_to_pdu
(
ªq
);

123 
	}
}

125 
ölöe
 
u16
 
	$nvme_ªq_qid
(
ªque°
 *
ªq
)

127 i‡(!
ªq
->
rq_disk
)

129  
	`blk_mq_unique_èg_to_hwq
(
	`blk_mq_unique_èg
(
ªq
)) + 1;

130 
	}
}

137 
	#NVME_QUIRK_DELAY_AMOUNT
 2300

	)

139 
	envme_˘æ_°©e
 {

140 
	mNVME_CTRL_NEW
,

141 
	mNVME_CTRL_LIVE
,

142 
	mNVME_CTRL_ADMIN_ONLY
,

143 
	mNVME_CTRL_RESETTING
,

144 
	mNVME_CTRL_CONNECTING
,

145 
	mNVME_CTRL_DELETING
,

146 
	mNVME_CTRL_DEAD
,

149 
	snvme_˘æ
 {

150 
boﬁ
 
	mcomp_£í
;

151 
nvme_˘æ_°©e
 
	m°©e
;

152 
boﬁ
 
	midítifõd
;

153 
•ölock_t
 
	mlock
;

154 
muãx
 
	msˇn_lock
;

155 c⁄° 
nvme_˘æ_›s
 *
	m›s
;

156 
ªque°_queue
 *
	madmö_q
;

157 
ªque°_queue
 *
	mc⁄√˘_q
;

158 
devi˚
 *
	mdev
;

159 
	mö°™˚
;

160 
	mnuma_node
;

161 
blk_mq_èg_£t
 *
	mèg£t
;

162 
blk_mq_èg_£t
 *
	madmö_èg£t
;

163 
li°_hód
 
	m«me•a˚s
;

164 
rw_£m≠h‹e
 
	m«me•a˚s_rw£m
;

165 
devi˚
 
	m˘æ_devi˚
;

166 
devi˚
 *
	mdevi˚
;

167 
cdev
 
	mcdev
;

168 
w‹k_°ru˘
 
	mª£t_w‹k
;

169 
w‹k_°ru˘
 
	mdñëe_w‹k
;

171 
nvme_subsy°em
 *
	msubsys
;

172 
li°_hód
 
	msubsys_íåy
;

174 
›Æ_dev
 *
	m›Æ_dev
;

176 
	m«me
[12];

177 
u16
 
	m˙éid
;

179 
u32
 
	m˘æ_c⁄fig
;

180 
u16
 
	mmtÁ
;

181 
u32
 
	mqueue_cou¡
;

183 
u64
 
	mˇp
;

184 
u32
 
	m∑ge_size
;

185 
u32
 
	mmax_hw_£˘‹s
;

186 
u32
 
	mmax_£gmíts
;

187 
u16
 
	m¸dt
[3];

188 
u16
 
	m⁄cs
;

189 
u16
 
	mﬂcs
;

190 
u16
 
	mnsß
;

191 
u16
 
	mƒ_°ªams
;

192 
u32
 
	mmax_«me•a˚s
;

193 
©omic_t
 
	mab‹t_limô
;

194 
u8
 
	mvwc
;

195 
u32
 
	mvs
;

196 
u32
 
	msgls
;

197 
u16
 
	mkas
;

198 
u8
 
	m≈ss
;

199 
u8
 
	m≠°a
;

200 
u32
 
	mﬂes
;

201 
u32
 
	m´n_ªsu…
;

202 
u32
 
	m˘øâ
;

203 
	mshutdown_timeout
;

204 
	mk©o
;

205 
boﬁ
 
	msubsy°em
;

206 
	mquúks
;

207 
nvme_id_powî_°©e
 
	mpsd
[32];

208 
nvme_ef„˘s_log
 *
	mef„˘s
;

209 
w‹k_°ru˘
 
	msˇn_w‹k
;

210 
w‹k_°ru˘
 
	masync_evít_w‹k
;

211 
dñayed_w‹k
 
	mka_w‹k
;

212 
nvme_comm™d
 
	mka_cmd
;

213 
w‹k_°ru˘
 
	mfw_a˘_w‹k
;

214 
	mevíts
;

216 #ifde‡
CONFIG_NVME_MULTIPATH


218 
u8
 
	m™aˇp
;

219 
u8
 
	m™©t
;

220 
u32
 
	m™agΩmax
;

221 
u32
 
	m««gΩid
;

222 
muãx
 
	m™a_lock
;

223 
nvme_™a_r•_hdr
 *
	m™a_log_buf
;

224 
size_t
 
	m™a_log_size
;

225 
timî_li°
 
	m™©t_timî
;

226 
w‹k_°ru˘
 
	m™a_w‹k
;

230 
u64
 
	mps_max_œãncy_us
;

231 
boﬁ
 
	m≠°_íabÀd
;

234 
u32
 
	mhm¥e
;

235 
u32
 
	mhmmö
;

236 
u32
 
	mhmmöds
;

237 
u16
 
	mhmmaxd
;

240 
u16
 
	msqsize
;

241 
u32
 
	mioccsz
;

242 
u32
 
	mi‹csz
;

243 
u16
 
	micdoff
;

244 
u16
 
	mmaxcmd
;

245 
	mƒ_ªc⁄√˘s
;

246 
nvmf_˘æ_›ti⁄s
 *
	m›ts
;

248 
∑ge
 *
	mdisˇrd_∑ge
;

249 
	mdisˇrd_∑ge_busy
;

252 
	envme_i›ﬁicy
 {

253 
	mNVME_IOPOLICY_NUMA
,

254 
	mNVME_IOPOLICY_RR
,

257 
	snvme_subsy°em
 {

258 
	mö°™˚
;

259 
devi˚
 
	mdev
;

264 
kªf
 
	mªf
;

265 
li°_hód
 
	míåy
;

266 
muãx
 
	mlock
;

267 
li°_hód
 
	m˘æs
;

268 
li°_hód
 
	mnshóds
;

269 
	msubnqn
[
NVMF_NQN_SIZE
];

270 
	m£rül
[20];

271 
	mmodñ
[40];

272 
	mfúmw¨e_ªv
[8];

273 
u8
 
	mcmic
;

274 
u16
 
	mvíd‹_id
;

275 
ida
 
	mns_ida
;

276 #ifde‡
CONFIG_NVME_MULTIPATH


277 
nvme_i›ﬁicy
 
	mi›ﬁicy
;

284 
	snvme_ns_ids
 {

285 
u8
 
	meui64
[8];

286 
u8
 
	mnguid
[16];

287 
uuid_t
 
	muuid
;

297 
	snvme_ns_hód
 {

298 
li°_hód
 
	mli°
;

299 
§cu_°ru˘
 
	m§cu
;

300 
nvme_subsy°em
 *
	msubsys
;

301 
	mns_id
;

302 
nvme_ns_ids
 
	mids
;

303 
li°_hód
 
	míåy
;

304 
kªf
 
	mªf
;

305 
	mö°™˚
;

306 #ifde‡
CONFIG_NVME_MULTIPATH


307 
gídisk
 *
	mdisk
;

308 
bio_li°
 
	mªqueue_li°
;

309 
•ölock_t
 
	mªqueue_lock
;

310 
w‹k_°ru˘
 
	mªqueue_w‹k
;

311 
muãx
 
	mlock
;

312 
nvme_ns
 
__rcu
 *
	mcuºít_∑th
[];

316 #ifde‡
CONFIG_FAULT_INJECTION_DEBUG_FS


317 
	snvme_Áu…_öje˘
 {

318 
Áu…_©å
 
	m©å
;

319 
díåy
 *
	m∑ª¡
;

320 
boﬁ
 
	md⁄t_ªåy
;

321 
u16
 
	m°©us
;

325 
	snvme_ns
 {

326 
li°_hód
 
	mli°
;

328 
nvme_˘æ
 *
	m˘æ
;

329 
ªque°_queue
 *
	mqueue
;

330 
gídisk
 *
	mdisk
;

331 #ifde‡
CONFIG_NVME_MULTIPATH


332 
nvme_™a_°©e
 
	m™a_°©e
;

333 
u32
 
	m™a_gΩid
;

335 
li°_hód
 
	msiblögs
;

336 
nvm_dev
 *
	mndev
;

337 
kªf
 
	mkªf
;

338 
nvme_ns_hód
 *
	mhód
;

340 
	mlba_shi·
;

341 
u16
 
	mms
;

342 
u16
 
	msgs
;

343 
u32
 
	msws
;

344 
boﬁ
 
	mext
;

345 
u8
 
	mpi_ty≥
;

346 
	mÊags
;

347 
	#NVME_NS_REMOVING
 0

	)

348 
	#NVME_NS_DEAD
 1

	)

349 
	#NVME_NS_ANA_PENDING
 2

	)

350 
u16
 
	mnoiob
;

352 #ifde‡
CONFIG_FAULT_INJECTION_DEBUG_FS


353 
nvme_Áu…_öje˘
 
	mÁu…_öje˘
;

358 
	snvme_˘æ_›s
 {

359 c⁄° *
	m«me
;

360 
moduÀ
 *
	mmoduÀ
;

361 
	mÊags
;

362 
	#NVME_F_FABRICS
 (1 << 0)

	)

363 
	#NVME_F_METADATA_SUPPORTED
 (1 << 1)

	)

364 
	#NVME_F_PCI_P2PDMA
 (1 << 2)

	)

365 (*
	mªg_ªad32
)(
nvme_˘æ
 *
	m˘æ
, 
u32
 
	moff
, u32 *
	mvÆ
);

366 (*
	mªg_wrôe32
)(
nvme_˘æ
 *
	m˘æ
, 
u32
 
	moff
, u32 
	mvÆ
);

367 (*
	mªg_ªad64
)(
nvme_˘æ
 *
	m˘æ
, 
u32
 
	moff
, 
u64
 *
	mvÆ
);

368 (*
	m‰ì_˘æ
)(
nvme_˘æ
 *
	m˘æ
);

369 (*
	msubmô_async_evít
)(
nvme_˘æ
 *
	m˘æ
);

370 (*
	mdñëe_˘æ
)(
nvme_˘æ
 *
	m˘æ
);

371 (*
	mgë_addªss
)(
nvme_˘æ
 *
	m˘æ
, *
	mbuf
, 
	msize
);

374 #ifde‡
CONFIG_FAULT_INJECTION_DEBUG_FS


375 
nvme_Áu…_öje˘_öô
(
nvme_ns
 *
ns
);

376 
nvme_Áu…_öje˘_föi
(
nvme_ns
 *
ns
);

377 
nvme_should_Áû
(
ªque°
 *
ªq
);

379 
ölöe
 
	$nvme_Áu…_öje˘_öô
(
nvme_ns
 *
ns
Ë{
	}
}

380 
ölöe
 
	$nvme_Áu…_öje˘_föi
(
nvme_ns
 *
ns
Ë{
	}
}

381 
ölöe
 
	$nvme_should_Áû
(
ªque°
 *
ªq
Ë{
	}
}

384 
ölöe
 
	$nvme_ª£t_subsy°em
(
nvme_˘æ
 *
˘æ
)

386 i‡(!
˘æ
->
subsy°em
)

387  -
ENOTTY
;

388  
˘æ
->
›s
->
	`ªg_wrôe32
(˘æ, 
NVME_REG_NSSR
, 0x4E564D65);

389 
	}
}

391 
ölöe
 
u64
 
	$nvme_block_ƒ
(
nvme_ns
 *
ns
, 
£˘‹_t
 
£˘‹
)

393  (
£˘‹
 >> (
ns
->
lba_shi·
 - 9));

394 
	}
}

396 
ölöe
 
	$nvme_íd_ªque°
(
ªque°
 *
ªq
, 
__À16
 
°©us
,

397 
nvme_ªsu…
 
ªsu…
)

399 
nvme_ªque°
 *
rq
 = 
	`nvme_ªq
(
ªq
);

401 
rq
->
°©us
 = 
	`À16_to_˝u
(status) >> 1;

402 
rq
->
ªsu…
 =Ñesult;

404 
	`nvme_should_Áû
(
ªq
);

405 
	`blk_mq_com∂ëe_ªque°
(
ªq
);

406 
	}
}

408 
ölöe
 
	$nvme_gë_˘æ
(
nvme_˘æ
 *
˘æ
)

410 
	`gë_devi˚
(
˘æ
->
devi˚
);

411 
	}
}

413 
ölöe
 
	$nvme_put_˘æ
(
nvme_˘æ
 *
˘æ
)

415 
	`put_devi˚
(
˘æ
->
devi˚
);

416 
	}
}

418 
nvme_com∂ëe_rq
(
ªque°
 *
ªq
);

419 
boﬁ
 
nvme_ˇn˚l_ªque°
(
ªque°
 *
ªq
, *
d©a
, boﬁ 
ª£rved
);

420 
boﬁ
 
nvme_ch™ge_˘æ_°©e
(
nvme_˘æ
 *
˘æ
,

421 
nvme_˘æ_°©e
 
√w_°©e
);

422 
nvme_dißbÀ_˘æ
(
nvme_˘æ
 *
˘æ
, 
u64
 
ˇp
);

423 
nvme_íabÀ_˘æ
(
nvme_˘æ
 *
˘æ
, 
u64
 
ˇp
);

424 
nvme_shutdown_˘æ
(
nvme_˘æ
 *
˘æ
);

425 
nvme_öô_˘æ
(
nvme_˘æ
 *
˘æ
, 
devi˚
 *
dev
,

426 c⁄° 
nvme_˘æ_›s
 *
›s
, 
quúks
);

427 
nvme_unöô_˘æ
(
nvme_˘æ
 *
˘æ
);

428 
nvme_°¨t_˘æ
(
nvme_˘æ
 *
˘æ
);

429 
nvme_°›_˘æ
(
nvme_˘æ
 *
˘æ
);

430 
nvme_put_˘æ
(
nvme_˘æ
 *
˘æ
);

431 
nvme_öô_idítify
(
nvme_˘æ
 *
˘æ
);

433 
nvme_ªmove_«me•a˚s
(
nvme_˘æ
 *
˘æ
);

435 
nvme_£c_submô
(*
d©a
, 
u16
 
••
, 
u8
 
£˝
, *
buf„r
, 
size_t
 
Àn
,

436 
boﬁ
 
£nd
);

438 
nvme_com∂ëe_async_evít
(
nvme_˘æ
 *
˘æ
, 
__À16
 
°©us
,

439 vﬁ©ûê
nvme_ªsu…
 *
ªs
);

441 
nvme_°›_queues
(
nvme_˘æ
 *
˘æ
);

442 
nvme_°¨t_queues
(
nvme_˘æ
 *
˘æ
);

443 
nvme_kûl_queues
(
nvme_˘æ
 *
˘æ
);

444 
nvme_un‰ìze
(
nvme_˘æ
 *
˘æ
);

445 
nvme_waô_‰ìze
(
nvme_˘æ
 *
˘æ
);

446 
nvme_waô_‰ìze_timeout
(
nvme_˘æ
 *
˘æ
, 
timeout
);

447 
nvme_°¨t_‰ìze
(
nvme_˘æ
 *
˘æ
);

449 
	#NVME_QID_ANY
 -1

	)

450 
ªque°
 *
nvme_Æloc_ªque°
(
ªque°_queue
 *
q
,

451 
nvme_comm™d
 *
cmd
, 
blk_mq_ªq_Êags_t
 
Êags
, 
qid
);

452 
nvme_˛ónup_cmd
(
ªque°
 *
ªq
);

453 
blk_°©us_t
 
nvme_£tup_cmd
(
nvme_ns
 *
ns
, 
ªque°
 *
ªq
,

454 
nvme_comm™d
 *
cmd
);

455 
nvme_submô_sync_cmd
(
ªque°_queue
 *
q
, 
nvme_comm™d
 *
cmd
,

456 *
buf
, 
bufÊí
);

457 
__nvme_submô_sync_cmd
(
ªque°_queue
 *
q
, 
nvme_comm™d
 *
cmd
,

458 
nvme_ªsu…
 *
ªsu…
, *
buf„r
, 
bufÊí
,

459 
timeout
, 
qid
, 
©_hód
,

460 
blk_mq_ªq_Êags_t
 
Êags
, 
boﬁ
 
pﬁl
);

461 
nvme_£t_queue_cou¡
(
nvme_˘æ
 *
˘æ
, *
cou¡
);

462 
nvme_°›_kìp_Æive
(
nvme_˘æ
 *
˘æ
);

463 
nvme_ª£t_˘æ
(
nvme_˘æ
 *
˘æ
);

464 
nvme_ª£t_˘æ_sync
(
nvme_˘æ
 *
˘æ
);

465 
nvme_dñëe_˘æ
(
nvme_˘æ
 *
˘æ
);

467 
nvme_gë_log
(
nvme_˘æ
 *
˘æ
, 
u32
 
nsid
, 
u8
 
log_∑ge
, u8 
l•
,

468 *
log
, 
size_t
 
size
, 
u64
 
off£t
);

470 c⁄° 
©åibuã_group
 *
nvme_ns_id_©å_groups
[];

471 c⁄° 
block_devi˚_›î©i⁄s
 
nvme_ns_hód_›s
;

473 #ifde‡
CONFIG_NVME_MULTIPATH


474 
boﬁ
 
nvme_˘æ_u£_™a
(
nvme_˘æ
 *
˘æ
);

475 
nvme_£t_disk_«me
(*
disk_«me
, 
nvme_ns
 *
ns
,

476 
nvme_˘æ
 *
˘æ
, *
Êags
);

477 
nvme_Áûovî_ªq
(
ªque°
 *
ªq
);

478 
nvme_kick_ªqueue_li°s
(
nvme_˘æ
 *
˘æ
);

479 
nvme_m∑th_Æloc_disk
(
nvme_˘æ
 *
˘æ
,
nvme_ns_hód
 *
hód
);

480 
nvme_m∑th_add_disk
(
nvme_ns
 *
ns
, 
nvme_id_ns
 *
id
);

481 
nvme_m∑th_ªmove_disk
(
nvme_ns_hód
 *
hód
);

482 
nvme_m∑th_öô
(
nvme_˘æ
 *
˘æ
, 
nvme_id_˘æ
 *
id
);

483 
nvme_m∑th_unöô
(
nvme_˘æ
 *
˘æ
);

484 
nvme_m∑th_°›
(
nvme_˘æ
 *
˘æ
);

485 
nvme_m∑th_˛ór_cuºít_∑th
(
nvme_ns
 *
ns
);

486 
nvme_ns
 *
nvme_föd_∑th
(
nvme_ns_hód
 *
hód
);

488 
ölöe
 
	$nvme_m∑th_check_œ°_∑th
(
nvme_ns
 *
ns
)

490 
nvme_ns_hód
 *
hód
 = 
ns
->head;

492 i‡(
hód
->
disk
 && 
	`li°_em±y
(&hód->
li°
))

493 
	`kblockd_scheduÀ_w‹k
(&
hód
->
ªqueue_w‹k
);

494 
	}
}

496 
devi˚_©åibuã
 
dev_©å_™a_gΩid
;

497 
devi˚_©åibuã
 
dev_©å_™a_°©e
;

498 
devi˚_©åibuã
 
subsys_©å_i›ﬁicy
;

501 
ölöe
 
boﬁ
 
	$nvme_˘æ_u£_™a
(
nvme_˘æ
 *
˘æ
)

503  
Ál£
;

504 
	}
}

509 
ölöe
 
	$nvme_£t_disk_«me
(*
disk_«me
, 
nvme_ns
 *
ns
,

510 
nvme_˘æ
 *
˘æ
, *
Êags
)

512 
	`•rötf
(
disk_«me
, "nvme%dn%d", 
˘æ
->
ö°™˚
, 
ns
->
hód
->instance);

513 
	}
}

515 
ölöe
 
	$nvme_Áûovî_ªq
(
ªque°
 *
ªq
)

517 
	}
}

518 
ölöe
 
	$nvme_kick_ªqueue_li°s
(
nvme_˘æ
 *
˘æ
)

520 
	}
}

521 
ölöe
 
	$nvme_m∑th_Æloc_disk
(
nvme_˘æ
 *
˘æ
,

522 
nvme_ns_hód
 *
hód
)

525 
	}
}

526 
ölöe
 
	$nvme_m∑th_add_disk
(
nvme_ns
 *
ns
,

527 
nvme_id_ns
 *
id
)

529 
	}
}

530 
ölöe
 
	$nvme_m∑th_ªmove_disk
(
nvme_ns_hód
 *
hód
)

532 
	}
}

533 
ölöe
 
	$nvme_m∑th_˛ór_cuºít_∑th
(
nvme_ns
 *
ns
)

535 
	}
}

536 
ölöe
 
	$nvme_m∑th_check_œ°_∑th
(
nvme_ns
 *
ns
)

538 
	}
}

539 
ölöe
 
	$nvme_m∑th_öô
(
nvme_˘æ
 *
˘æ
,

540 
nvme_id_˘æ
 *
id
)

542 i‡(
˘æ
->
subsys
->
cmic
 & (1 << 3))

543 
	`dev_w¨n
(
˘æ
->
devi˚
,

546 
	}
}

547 
ölöe
 
	$nvme_m∑th_unöô
(
nvme_˘æ
 *
˘æ
)

549 
	}
}

550 
ölöe
 
	$nvme_m∑th_°›
(
nvme_˘æ
 *
˘æ
)

552 
	}
}

555 #ifde‡
CONFIG_NVM


556 
nvme_nvm_ªgi°î
(
nvme_ns
 *
ns
, *
disk_«me
, 
node
);

557 
nvme_nvm_uƒegi°î
(
nvme_ns
 *
ns
);

558 c⁄° 
©åibuã_group
 
nvme_nvm_©å_group
;

559 
nvme_nvm_io˘l
(
nvme_ns
 *
ns
, 
cmd
, 
¨g
);

561 
ölöe
 
	$nvme_nvm_ªgi°î
(
nvme_ns
 *
ns
, *
disk_«me
,

562 
node
)

565 
	}
}

567 
ölöe
 
	$nvme_nvm_uƒegi°î
(
nvme_ns
 *
ns
Ë{
	}
};

568 
ölöe
 
	$nvme_nvm_io˘l
(
nvme_ns
 *
ns
, 
cmd
,

569 
¨g
)

571  -
ENOTTY
;

572 
	}
}

575 
ölöe
 
nvme_ns
 *
	$nvme_gë_ns_‰om_dev
(
devi˚
 *
dev
)

577  
	`dev_to_disk
(
dev
)->
¥iv©e_d©a
;

578 
	}
}

580 
__öô
 
nvme_c‹e_öô
();

581 
__exô
 
nvme_c‹e_exô
();

	@nvme.mod.c

1 
	~<löux/buûd-ß….h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/vîmagic.h
>

4 
	~<löux/compûî.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

11 
__visibÀ
 
moduÀ
 
__this_moduÀ


12 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

13 .
«me
 = 
KBUILD_MODNAME
,

14 .
	göô
 = 
öô_moduÀ
,

15 #ifde‡
CONFIG_MODULE_UNLOAD


16 .
	gexô
 = 
˛ónup_moduÀ
,

18 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

21 #ifde‡
CONFIG_RETPOLINE


22 
MODULE_INFO
(
ªçﬁöe
, "Y");

25 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

26 
__u£d


27 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

175 c⁄° 
	g__moduÀ_dïíds
[]

176 
__u£d


177 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

180 
MODULE_ALIAS
("pci:v00008086d00000953sv*sd*bc*sc*i*");

181 
MODULE_ALIAS
("pci:v00008086d00000A53sv*sd*bc*sc*i*");

182 
MODULE_ALIAS
("pci:v00008086d00000A54sv*sd*bc*sc*i*");

183 
MODULE_ALIAS
("pci:v00008086d00000A55sv*sd*bc*sc*i*");

184 
MODULE_ALIAS
("pci:v00008086d0000F1A5sv*sd*bc*sc*i*");

185 
MODULE_ALIAS
("pci:v00008086d0000F1A6sv*sd*bc*sc*i*");

186 
MODULE_ALIAS
("pci:v00008086d00005845sv*sd*bc*sc*i*");

187 
MODULE_ALIAS
("pci:v00001BB1d00000100sv*sd*bc*sc*i*");

188 
MODULE_ALIAS
("pci:v00001C58d00000003sv*sd*bc*sc*i*");

189 
MODULE_ALIAS
("pci:v00001C58d00000023sv*sd*bc*sc*i*");

190 
MODULE_ALIAS
("pci:v00001C5Fd00000540sv*sd*bc*sc*i*");

191 
MODULE_ALIAS
("pci:v0000144Dd0000A821sv*sd*bc*sc*i*");

192 
MODULE_ALIAS
("pci:v0000144Dd0000A822sv*sd*bc*sc*i*");

193 
MODULE_ALIAS
("pci:v00001D1Dd00001F1Fsv*sd*bc*sc*i*");

194 
MODULE_ALIAS
("pci:v00001D1Dd00002807sv*sd*bc*sc*i*");

195 
MODULE_ALIAS
("pci:v00001D1Dd00002601sv*sd*bc*sc*i*");

196 
MODULE_ALIAS
("pci:v*d*sv*sd*bc01sc08i02*");

197 
MODULE_ALIAS
("pci:v0000106Bd00002001sv*sd*bc*sc*i*");

198 
MODULE_ALIAS
("pci:v0000106Bd00002003sv*sd*bc*sc*i*");

200 
MODULE_INFO
(
§cvîsi⁄
, "66E8DF0A5D30B2DE0E87074");

	@pci.c

7 
	~<löux/´r.h
>

8 
	~<löux/async.h
>

9 
	~<löux/blkdev.h
>

10 
	~<löux/blk-mq.h
>

11 
	~<löux/blk-mq-pci.h
>

12 
	~<löux/dmi.h
>

13 
	~<löux/öô.h
>

14 
	~<löux/öãºu±.h
>

15 
	~<löux/io.h
>

16 
	~<löux/mm.h
>

17 
	~<löux/moduÀ.h
>

18 
	~<löux/muãx.h
>

19 
	~<löux/⁄˚.h
>

20 
	~<löux/pci.h
>

21 
	~<löux/t10-pi.h
>

22 
	~<löux/ty≥s.h
>

23 
	~<löux/io-64-n⁄©omic-lo-hi.h
>

24 
	~<löux/£d-›Æ.h
>

25 
	~<löux/pci-p2pdma.h
>

27 
	~"åa˚.h
"

28 
	~"nvme.h
"

30 
	#SQ_SIZE
(
dïth
Ë(dïth * (
nvme_comm™d
))

	)

31 
	#CQ_SIZE
(
dïth
Ë(dïth * (
nvme_com∂ëi⁄
))

	)

33 
	#SGES_PER_PAGE
 (
PAGE_SIZE
 / (
nvme_sgl_desc
))

	)

39 
	#NVME_MAX_KB_SZ
 4096

	)

40 
	#NVME_MAX_SEGS
 127

	)

43 
	g£q_£˘‹_num
 = 0;

44 
•ölock_t
 
	grb_lock
;

46 
	gu£_thªaded_öãºu±s
;

47 
moduÀ_∑øm
(
u£_thªaded_öãºu±s
, , 0);

49 
boﬁ
 
	gu£_cmb_sqes
 = 
åue
;

50 
moduÀ_∑øm
(
u£_cmb_sqes
, 
boﬁ
, 0444);

51 
MODULE_PARM_DESC
(
u£_cmb_sqes
, "use controller's memory buffer for I/O SQes");

53 
	gmax_ho°_mem_size_mb
 = 128;

54 
moduÀ_∑øm
(
max_ho°_mem_size_mb
, 
uöt
, 0444);

55 
MODULE_PARM_DESC
(
max_ho°_mem_size_mb
,

58 
	gsgl_thªshﬁd
 = 
SZ_32K
;

59 
moduÀ_∑øm
(
sgl_thªshﬁd
, 
uöt
, 0644);

60 
MODULE_PARM_DESC
(
sgl_thªshﬁd
,

64 
io_queue_dïth_£t
(c⁄° *
vÆ
, c⁄° 
kî√l_∑øm
 *
kp
);

65 c⁄° 
kî√l_∑øm_›s
 
	gio_queue_dïth_›s
 = {

66 .
£t
 = 
io_queue_dïth_£t
,

67 .
	ggë
 = 
∑øm_gë_öt
,

70 
	gio_queue_dïth
 = 1024;

71 
moduÀ_∑øm_cb
(
io_queue_dïth
, &
io_queue_dïth_›s
, &io_queue_depth, 0644);

72 
MODULE_PARM_DESC
(
io_queue_dïth
, "set io queue depth, should >= 2");

74 
queue_cou¡_£t
(c⁄° *
vÆ
, c⁄° 
kî√l_∑øm
 *
kp
);

75 c⁄° 
kî√l_∑øm_›s
 
	gqueue_cou¡_›s
 = {

76 .
£t
 = 
queue_cou¡_£t
,

77 .
	ggë
 = 
∑øm_gë_öt
,

80 
	gwrôe_queues
;

81 
moduÀ_∑øm_cb
(
wrôe_queues
, &
queue_cou¡_›s
, &write_queues, 0644);

82 
MODULE_PARM_DESC
(
wrôe_queues
,

86 
	gpﬁl_queues
 = 0;

87 
moduÀ_∑øm_cb
(
pﬁl_queues
, &
queue_cou¡_›s
, &poll_queues, 0644);

88 
MODULE_PARM_DESC
(
pﬁl_queues
, "Number of queuesÅo use forÖolled IO.");

90 
	gnvme_dev
;

91 
	gnvme_queue
;

93 
nvme_dev_dißbÀ
(
nvme_dev
 *
dev
, 
boﬁ
 
shutdown
);

94 
boﬁ
 
__nvme_dißbÀ_io_queues
(
nvme_dev
 *
dev
, 
u8
 
›code
);

99 
	snvme_dev
 {

100 
nvme_queue
 *
	mqueues
;

101 
blk_mq_èg_£t
 
	mèg£t
;

102 
blk_mq_èg_£t
 
	madmö_èg£t
;

103 
u32
 
__iomem
 *
	mdbs
;

104 
devi˚
 *
	mdev
;

105 
dma_poﬁ
 *
	m¥p_∑ge_poﬁ
;

106 
dma_poﬁ
 *
	m¥p_smÆl_poﬁ
;

107 
	m⁄löe_queues
;

108 
	mmax_qid
;

109 
	mio_queues
[
HCTX_MAX_TYPES
];

110 
	mnum_vecs
;

111 
	mq_dïth
;

112 
u32
 
	mdb_°ride
;

113 
__iomem
 *
	mb¨
;

114 
	mb¨_m≠≥d_size
;

115 
w‹k_°ru˘
 
	mªmove_w‹k
;

116 
muãx
 
	mshutdown_lock
;

117 
boﬁ
 
	msubsy°em
;

118 
u64
 
	mcmb_size
;

119 
boﬁ
 
	mcmb_u£_sqes
;

120 
u32
 
	mcmbsz
;

121 
u32
 
	mcmbloc
;

122 
nvme_˘æ
 
	m˘æ
;

124 
mempoﬁ_t
 *
	miod_mempoﬁ
;

127 
u32
 *
	mdbbuf_dbs
;

128 
dma_addr_t
 
	mdbbuf_dbs_dma_addr
;

129 
u32
 *
	mdbbuf_eis
;

130 
dma_addr_t
 
	mdbbuf_eis_dma_addr
;

133 
u64
 
	mho°_mem_size
;

134 
u32
 
	mƒ_ho°_mem_descs
;

135 
dma_addr_t
 
	mho°_mem_descs_dma
;

136 
nvme_ho°_mem_buf_desc
 *
	mho°_mem_descs
;

137 **
	mho°_mem_desc_bufs
;

140 
	$io_queue_dïth_£t
(c⁄° *
vÆ
, c⁄° 
kî√l_∑øm
 *
kp
)

142 
n
 = 0, 
ªt
;

144 
ªt
 = 
	`k°πoöt
(
vÆ
, 10, &
n
);

145 i‡(
ªt
 !0 || 
n
 < 2)

146  -
EINVAL
;

148  
	`∑øm_£t_öt
(
vÆ
, 
kp
);

149 
	}
}

151 
	$queue_cou¡_£t
(c⁄° *
vÆ
, c⁄° 
kî√l_∑øm
 *
kp
)

153 
n
 = 0, 
ªt
;

155 
ªt
 = 
	`k°πoöt
(
vÆ
, 10, &
n
);

156 i‡(
ªt
)

157  
ªt
;

158 i‡(
n
 > 
	`num_possibÀ_˝us
())

159 
n
 = 
	`num_possibÀ_˝us
();

161  
	`∑øm_£t_öt
(
vÆ
, 
kp
);

162 
	}
}

164 
ölöe
 
	$sq_idx
(
qid
, 
u32
 
°ride
)

166  
qid
 * 2 * 
°ride
;

167 
	}
}

169 
ölöe
 
	$cq_idx
(
qid
, 
u32
 
°ride
)

171  (
qid
 * 2 + 1Ë* 
°ride
;

172 
	}
}

174 
ölöe
 
nvme_dev
 *
	$to_nvme_dev
(
nvme_˘æ
 *
˘æ
)

176  
	`c⁄èöî_of
(
˘æ
, 
nvme_dev
, ctrl);

177 
	}
}

183 
	snvme_queue
 {

184 
devi˚
 *
	mq_dmadev
;

185 
nvme_dev
 *
	mdev
;

186 
•ölock_t
 
	msq_lock
;

187 
nvme_comm™d
 *
	msq_cmds
;

189 
•ölock_t
 
cq_pﬁl_lock
 
	m____ˇchñöe_Æig√d_ö_smp
;

190 vﬁ©ûê
nvme_com∂ëi⁄
 *
	mcqes
;

191 
blk_mq_ègs
 **
	mègs
;

192 
dma_addr_t
 
	msq_dma_addr
;

193 
dma_addr_t
 
	mcq_dma_addr
;

194 
u32
 
__iomem
 *
	mq_db
;

195 
u16
 
	mq_dïth
;

196 
s16
 
	mcq_ve˘‹
;

197 
u16
 
	msq_èû
;

198 
u16
 
	mœ°_sq_èû
;

199 
u16
 
	mcq_hód
;

200 
u16
 
	mœ°_cq_hód
;

201 
u16
 
	mqid
;

202 
u8
 
	mcq_pha£
;

203 
	mÊags
;

204 
	#NVMEQ_ENABLED
 0

	)

205 
	#NVMEQ_SQ_CMB
 1

	)

206 
	#NVMEQ_DELETE_ERROR
 2

	)

207 
u32
 *
	mdbbuf_sq_db
;

208 
u32
 *
	mdbbuf_cq_db
;

209 
u32
 *
	mdbbuf_sq_ei
;

210 
u32
 *
	mdbbuf_cq_ei
;

211 
com∂ëi⁄
 
	mdñëe_d⁄e
;

220 
	snvme_iod
 {

221 
nvme_ªque°
 
	mªq
;

222 
nvme_queue
 *
	mnvmeq
;

223 
boﬁ
 
	mu£_sgl
;

224 
	mab‹ãd
;

225 
	m≈ages
;

226 
	m√¡s
;

227 
	mÀngth
;

228 
dma_addr_t
 
	mfú°_dma
;

229 
sˇâîli°
 
	mmëa_sg
;

230 
sˇâîli°
 *
	msg
;

231 
sˇâîli°
 
	mölöe_sg
[0];

237 
ölöe
 
	$_nvme_check_size
()

239 
	`BUILD_BUG_ON
((
nvme_rw_comm™d
) != 64);

240 
	`BUILD_BUG_ON
((
nvme_¸óã_cq
) != 64);

241 
	`BUILD_BUG_ON
((
nvme_¸óã_sq
) != 64);

242 
	`BUILD_BUG_ON
((
nvme_dñëe_queue
) != 64);

243 
	`BUILD_BUG_ON
((
nvme_„©uªs
) != 64);

244 
	`BUILD_BUG_ON
((
nvme_f‹m©_cmd
) != 64);

245 
	`BUILD_BUG_ON
((
nvme_ab‹t_cmd
) != 64);

246 
	`BUILD_BUG_ON
((
nvme_comm™d
) != 64);

247 
	`BUILD_BUG_ON
((
nvme_id_˘æ
Ë!
NVME_IDENTIFY_DATA_SIZE
);

248 
	`BUILD_BUG_ON
((
nvme_id_ns
Ë!
NVME_IDENTIFY_DATA_SIZE
);

249 
	`BUILD_BUG_ON
((
nvme_lba_ønge_ty≥
) != 64);

250 
	`BUILD_BUG_ON
((
nvme_sm¨t_log
) != 512);

251 
	`BUILD_BUG_ON
((
nvme_dbbuf
) != 64);

252 
	}
}

254 
	$max_io_queues
()

256  
	`num_possibÀ_˝us
(Ë+ 
wrôe_queues
 + 
pﬁl_queues
;

257 
	}
}

259 
	$max_queue_cou¡
()

262  1 + 
	`max_io_queues
();

263 
	}
}

265 
ölöe
 
	$nvme_dbbuf_size
(
u32
 
°ride
)

267  (
	`max_queue_cou¡
(Ë* 8 * 
°ride
);

268 
	}
}

270 
	$nvme_dbbuf_dma_Æloc
(
nvme_dev
 *
dev
)

272 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_°ride
);

274 i‡(
dev
->
dbbuf_dbs
)

277 
dev
->
dbbuf_dbs
 = 
	`dma_Æloc_cohîít
(dev->dev, 
mem_size
,

278 &
dev
->
dbbuf_dbs_dma_addr
,

279 
GFP_KERNEL
);

280 i‡(!
dev
->
dbbuf_dbs
)

281  -
ENOMEM
;

282 
dev
->
dbbuf_eis
 = 
	`dma_Æloc_cohîít
(dev->dev, 
mem_size
,

283 &
dev
->
dbbuf_eis_dma_addr
,

284 
GFP_KERNEL
);

285 i‡(!
dev
->
dbbuf_eis
) {

286 
	`dma_‰ì_cohîít
(
dev
->dev, 
mem_size
,

287 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

288 
dev
->
dbbuf_dbs
 = 
NULL
;

289  -
ENOMEM
;

293 
	}
}

295 
	$nvme_dbbuf_dma_‰ì
(
nvme_dev
 *
dev
)

297 
mem_size
 = 
	`nvme_dbbuf_size
(
dev
->
db_°ride
);

299 i‡(
dev
->
dbbuf_dbs
) {

300 
	`dma_‰ì_cohîít
(
dev
->dev, 
mem_size
,

301 
dev
->
dbbuf_dbs
, dev->
dbbuf_dbs_dma_addr
);

302 
dev
->
dbbuf_dbs
 = 
NULL
;

304 i‡(
dev
->
dbbuf_eis
) {

305 
	`dma_‰ì_cohîít
(
dev
->dev, 
mem_size
,

306 
dev
->
dbbuf_eis
, dev->
dbbuf_eis_dma_addr
);

307 
dev
->
dbbuf_eis
 = 
NULL
;

309 
	}
}

311 
	$nvme_dbbuf_öô
(
nvme_dev
 *
dev
,

312 
nvme_queue
 *
nvmeq
, 
qid
)

314 i‡(!
dev
->
dbbuf_dbs
 || !
qid
)

317 
nvmeq
->
dbbuf_sq_db
 = &
dev
->
dbbuf_dbs
[
	`sq_idx
(
qid
, dev->
db_°ride
)];

318 
nvmeq
->
dbbuf_cq_db
 = &
dev
->
dbbuf_dbs
[
	`cq_idx
(
qid
, dev->
db_°ride
)];

319 
nvmeq
->
dbbuf_sq_ei
 = &
dev
->
dbbuf_eis
[
	`sq_idx
(
qid
, dev->
db_°ride
)];

320 
nvmeq
->
dbbuf_cq_ei
 = &
dev
->
dbbuf_eis
[
	`cq_idx
(
qid
, dev->
db_°ride
)];

321 
	}
}

323 
	$nvme_dbbuf_£t
(
nvme_dev
 *
dev
)

325 
nvme_comm™d
 
c
;

327 i‡(!
dev
->
dbbuf_dbs
)

330 
	`mem£t
(&
c
, 0, (c));

331 
c
.
dbbuf
.
›code
 = 
nvme_admö_dbbuf
;

332 
c
.
dbbuf
.
¥p1
 = 
	`˝u_to_À64
(
dev
->
dbbuf_dbs_dma_addr
);

333 
c
.
dbbuf
.
¥p2
 = 
	`˝u_to_À64
(
dev
->
dbbuf_eis_dma_addr
);

335 i‡(
	`nvme_submô_sync_cmd
(
dev
->
˘æ
.
admö_q
, &
c
, 
NULL
, 0)) {

336 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
, "unableÅo set dbbuf\n");

338 
	`nvme_dbbuf_dma_‰ì
(
dev
);

340 
	}
}

342 
ölöe
 
	$nvme_dbbuf_√ed_evít
(
u16
 
evít_idx
, u16 
√w_idx
, u16 
ﬁd
)

344  (
u16
)(
√w_idx
 - 
evít_idx
 - 1Ë< (u16)“ew_idx - 
ﬁd
);

345 
	}
}

348 
boﬁ
 
	$nvme_dbbuf_upd©e_™d_check_evít
(
u16
 
vÆue
, 
u32
 *
dbbuf_db
,

349 vﬁ©ûê
u32
 *
dbbuf_ei
)

351 i‡(
dbbuf_db
) {

352 
u16
 
ﬁd_vÆue
;

358 
	`wmb
();

360 
ﬁd_vÆue
 = *
dbbuf_db
;

361 *
dbbuf_db
 = 
vÆue
;

369 
	`mb
();

371 i‡(!
	`nvme_dbbuf_√ed_evít
(*
dbbuf_ei
, 
vÆue
, 
ﬁd_vÆue
))

372  
Ál£
;

375  
åue
;

376 
	}
}

381 
	#NVME_INT_PAGES
 2

	)

382 
	#NVME_INT_BYTES
(
dev
Ë(
NVME_INT_PAGES
 * (dev)->
˘æ
.
∑ge_size
)

	)

389 
	$nvme_≈ages
(
size
, 
nvme_dev
 *
dev
)

391 
≈Ωs
 = 
	`DIV_ROUND_UP
(
size
 + 
dev
->
˘æ
.
∑ge_size
,

392 
dev
->
˘æ
.
∑ge_size
);

393  
	`DIV_ROUND_UP
(8 * 
≈Ωs
, 
PAGE_SIZE
 - 8);

394 
	}
}

400 
	$nvme_pci_≈ages_sgl
(
num_£g
)

402  
	`DIV_ROUND_UP
(
num_£g
 * (
nvme_sgl_desc
), 
PAGE_SIZE
);

403 
	}
}

405 
	$nvme_pci_iod_Æloc_size
(
nvme_dev
 *
dev
,

406 
size
, 
n£g
, 
boﬁ
 
u£_sgl
)

408 
size_t
 
Æloc_size
;

410 i‡(
u£_sgl
)

411 
Æloc_size
 = (
__À64
 *Ë* 
	`nvme_pci_≈ages_sgl
(
n£g
);

413 
Æloc_size
 = (
__À64
 *Ë* 
	`nvme_≈ages
(
size
, 
dev
);

415  
Æloc_size
 + (
sˇâîli°
Ë* 
n£g
;

416 
	}
}

418 
	$nvme_pci_cmd_size
(
nvme_dev
 *
dev
, 
boﬁ
 
u£_sgl
)

420 
Æloc_size
 = 
	`nvme_pci_iod_Æloc_size
(
dev
,

421 
	`NVME_INT_BYTES
(
dev
), 
NVME_INT_PAGES
,

422 
u£_sgl
);

424  (
nvme_iod
Ë+ 
Æloc_size
;

425 
	}
}

427 
	$nvme_admö_öô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

428 
h˘x_idx
)

430 
nvme_dev
 *
dev
 = 
d©a
;

431 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

433 
	`WARN_ON
(
h˘x_idx
 != 0);

434 
	`WARN_ON
(
dev
->
admö_èg£t
.
ègs
[0] !
h˘x
->tags);

435 
	`WARN_ON
(
nvmeq
->
ègs
);

437 
h˘x
->
drivî_d©a
 = 
nvmeq
;

438 
nvmeq
->
ègs
 = &
dev
->
admö_èg£t
.tags[0];

440 
	}
}

442 
	$nvme_admö_exô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, 
h˘x_idx
)

444 
nvme_queue
 *
nvmeq
 = 
h˘x
->
drivî_d©a
;

446 
nvmeq
->
ègs
 = 
NULL
;

447 
	}
}

449 
	$nvme_öô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

450 
h˘x_idx
)

452 
nvme_dev
 *
dev
 = 
d©a
;

453 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
h˘x_idx
 + 1];

455 i‡(!
nvmeq
->
ègs
)

456 
nvmeq
->
ègs
 = &
dev
->
èg£t
.ègs[
h˘x_idx
];

458 
	`WARN_ON
(
dev
->
èg£t
.
ègs
[
h˘x_idx
] !
h˘x
->tags);

459 
h˘x
->
drivî_d©a
 = 
nvmeq
;

461 
	}
}

463 
	$nvme_öô_ªque°
(
blk_mq_èg_£t
 *
£t
, 
ªque°
 *
ªq
,

464 
h˘x_idx
, 
numa_node
)

466 
nvme_dev
 *
dev
 = 
£t
->
drivî_d©a
;

467 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

468 
queue_idx
 = (
£t
 =&
dev
->
èg£t
Ë? 
h˘x_idx
 + 1 : 0;

469 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
queue_idx
];

471 
	`BUG_ON
(!
nvmeq
);

472 
iod
->
nvmeq
 =Çvmeq;

474 
	`nvme_ªq
(
ªq
)->
˘æ
 = &
dev
->ctrl;

476 
	}
}

478 
	$queue_úq_off£t
(
nvme_dev
 *
dev
)

481 i‡(
dev
->
num_vecs
 > 1)

485 
	}
}

487 
	$nvme_pci_m≠_queues
(
blk_mq_èg_£t
 *
£t
)

489 
nvme_dev
 *
dev
 = 
£t
->
drivî_d©a
;

490 
i
, 
qoff
, 
off£t
;

492 
off£t
 = 
	`queue_úq_off£t
(
dev
);

493 
i
 = 0, 
qoff
 = 0; i < 
£t
->
ƒ_m≠s
; i++) {

494 
blk_mq_queue_m≠
 *
m≠
 = &
£t
->m≠[
i
];

496 
m≠
->
ƒ_queues
 = 
dev
->
io_queues
[
i
];

497 i‡(!
m≠
->
ƒ_queues
) {

498 
	`BUG_ON
(
i
 =
HCTX_TYPE_DEFAULT
);

506 
m≠
->
queue_off£t
 = 
qoff
;

507 i‡(
i
 !
HCTX_TYPE_POLL
 && 
off£t
)

508 
	`blk_mq_pci_m≠_queues
(
m≠
, 
	`to_pci_dev
(
dev
->dev), 
off£t
);

510 
	`blk_mq_m≠_queues
(
m≠
);

511 
qoff
 +
m≠
->
ƒ_queues
;

512 
off£t
 +
m≠
->
ƒ_queues
;

516 
	}
}

521 
ölöe
 
	$nvme_wrôe_sq_db
(
nvme_queue
 *
nvmeq
, 
boﬁ
 
wrôe_sq
)

523 i‡(!
wrôe_sq
) {

524 
u16
 
√xt_èû
 = 
nvmeq
->
sq_èû
 + 1;

526 i‡(
√xt_èû
 =
nvmeq
->
q_dïth
)

527 
√xt_èû
 = 0;

528 i‡(
√xt_èû
 !
nvmeq
->
œ°_sq_èû
)

532 i‡(
	`nvme_dbbuf_upd©e_™d_check_evít
(
nvmeq
->
sq_èû
,

533 
nvmeq
->
dbbuf_sq_db
,Çvmeq->
dbbuf_sq_ei
))

534 
	`wrôñ
(
nvmeq
->
sq_èû
,Çvmeq->
q_db
);

535 
nvmeq
->
œ°_sq_èû
 =Çvmeq->
sq_èû
;

536 
	}
}

544 
	$nvme_submô_cmd
(
nvme_queue
 *
nvmeq
, 
nvme_comm™d
 *
cmd
,

545 
boﬁ
 
wrôe_sq
)

547 
	`•ö_lock
(&
nvmeq
->
sq_lock
);

548 
	`mem˝y
(&
nvmeq
->
sq_cmds
[nvmeq->
sq_èû
], 
cmd
, (*cmd));

549 i‡(++
nvmeq
->
sq_èû
 =nvmeq->
q_dïth
)

550 
nvmeq
->
sq_èû
 = 0;

551 
	`nvme_wrôe_sq_db
(
nvmeq
, 
wrôe_sq
);

552 
	`•ö_u∆ock
(&
nvmeq
->
sq_lock
);

553 
	}
}

555 
	$nvme_commô_rqs
(
blk_mq_hw_˘x
 *
h˘x
)

557 
nvme_queue
 *
nvmeq
 = 
h˘x
->
drivî_d©a
;

559 
	`•ö_lock
(&
nvmeq
->
sq_lock
);

560 i‡(
nvmeq
->
sq_èû
 !nvmeq->
œ°_sq_èû
)

561 
	`nvme_wrôe_sq_db
(
nvmeq
, 
åue
);

562 
	`•ö_u∆ock
(&
nvmeq
->
sq_lock
);

563 
	}
}

565 **
	$nvme_pci_iod_li°
(
ªque°
 *
ªq
)

567 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

568  (**)(
iod
->
sg
 + 
	`blk_rq_ƒ_phys_£gmíts
(
ªq
));

569 
	}
}

571 
ölöe
 
boﬁ
 
	$nvme_pci_u£_sgls
(
nvme_dev
 *
dev
, 
ªque°
 *
ªq
)

573 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

574 
n£g
 = 
	`blk_rq_ƒ_phys_£gmíts
(
ªq
);

575 
avg_£g_size
;

577 i‡(
n£g
 == 0)

578  
Ál£
;

580 
avg_£g_size
 = 
	`DIV_ROUND_UP
(
	`blk_rq_∑ylﬂd_byãs
(
ªq
), 
n£g
);

582 i‡(!(
dev
->
˘æ
.
sgls
 & ((1 << 0) | (1 << 1))))

583  
Ál£
;

584 i‡(!
iod
->
nvmeq
->
qid
)

585  
Ál£
;

586 i‡(!
sgl_thªshﬁd
 || 
avg_£g_size
 < sgl_threshold)

587  
Ál£
;

588  
åue
;

589 
	}
}

591 
blk_°©us_t
 
	$nvme_öô_iod
(
ªque°
 *
rq
, 
nvme_dev
 *
dev
)

593 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
rq
);

594 
n£g
 = 
	`blk_rq_ƒ_phys_£gmíts
(
rq
);

595 
size
 = 
	`blk_rq_∑ylﬂd_byãs
(
rq
);

597 
iod
->
u£_sgl
 = 
	`nvme_pci_u£_sgls
(
dev
, 
rq
);

599 i‡(
n£g
 > 
NVME_INT_PAGES
 || 
size
 > 
	`NVME_INT_BYTES
(
dev
)) {

600 
iod
->
sg
 = 
	`mempoﬁ_Æloc
(
dev
->
iod_mempoﬁ
, 
GFP_ATOMIC
);

601 i‡(!
iod
->
sg
)

602  
BLK_STS_RESOURCE
;

604 
iod
->
sg
 = iod->
ölöe_sg
;

607 
iod
->
ab‹ãd
 = 0;

608 
iod
->
≈ages
 = -1;

609 
iod
->
√¡s
 = 0;

610 
iod
->
Àngth
 = 
size
;

612  
BLK_STS_OK
;

613 
	}
}

615 
	$nvme_‰ì_iod
(
nvme_dev
 *
dev
, 
ªque°
 *
ªq
)

617 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

618 c⁄° 
œ°_¥p
 = 
dev
->
˘æ
.
∑ge_size
 / (
__À64
) - 1;

619 
dma_addr_t
 
dma_addr
 = 
iod
->
fú°_dma
, 
√xt_dma_addr
;

621 
i
;

623 i‡(
iod
->
≈ages
 == 0)

624 
	`dma_poﬁ_‰ì
(
dev
->
¥p_smÆl_poﬁ
, 
	`nvme_pci_iod_li°
(
ªq
)[0],

625 
dma_addr
);

627 
i
 = 0; i < 
iod
->
≈ages
; i++) {

628 *
addr
 = 
	`nvme_pci_iod_li°
(
ªq
)[
i
];

630 i‡(
iod
->
u£_sgl
) {

631 
nvme_sgl_desc
 *
sg_li°
 = 
addr
;

633 
√xt_dma_addr
 =

634 
	`À64_to_˝u
((
sg_li°
[
SGES_PER_PAGE
 - 1]).
addr
);

636 
__À64
 *
¥p_li°
 = 
addr
;

638 
√xt_dma_addr
 = 
	`À64_to_˝u
(
¥p_li°
[
œ°_¥p
]);

641 
	`dma_poﬁ_‰ì
(
dev
->
¥p_∑ge_poﬁ
, 
addr
, 
dma_addr
);

642 
dma_addr
 = 
√xt_dma_addr
;

645 i‡(
iod
->
sg
 !iod->
ölöe_sg
)

646 
	`mempoﬁ_‰ì
(
iod
->
sg
, 
dev
->
iod_mempoﬁ
);

647 
	}
}

649 
	$nvme_¥öt_sgl
(
sˇâîli°
 *
sgl
, 
√¡s
)

651 
i
;

652 
sˇâîli°
 *
sg
;

654 
	`f‹_óch_sg
(
sgl
, 
sg
, 
√¡s
, 
i
) {

655 
dma_addr_t
 
phys
 = 
	`sg_phys
(
sg
);

656 
	`¥_w¨n
("sg[%d]Öhys_addr:%pad offset:%dÜength:%d "

658 
i
, &
phys
, 
sg
->
off£t
, sg->
Àngth
, &
	`sg_dma_addªss
(sg),

659 
	`sg_dma_Àn
(
sg
));

661 
	}
}

663 
blk_°©us_t
 
	$nvme_pci_£tup_¥ps
(
nvme_dev
 *
dev
,

664 
ªque°
 *
ªq
, 
nvme_rw_comm™d
 *
cmnd
)

666 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

667 
dma_poﬁ
 *
poﬁ
;

668 
Àngth
 = 
	`blk_rq_∑ylﬂd_byãs
(
ªq
);

669 
sˇâîli°
 *
sg
 = 
iod
->sg;

670 
dma_Àn
 = 
	`sg_dma_Àn
(
sg
);

671 
u64
 
dma_addr
 = 
	`sg_dma_addªss
(
sg
);

672 
u32
 
∑ge_size
 = 
dev
->
˘æ
.page_size;

673 
off£t
 = 
dma_addr
 & (
∑ge_size
 - 1);

674 
__À64
 *
¥p_li°
;

675 **
li°
 = 
	`nvme_pci_iod_li°
(
ªq
);

676 
dma_addr_t
 
¥p_dma
;

677 
≈Ωs
, 
i
;

679 
Àngth
 -(
∑ge_size
 - 
off£t
);

680 i‡(
Àngth
 <= 0) {

681 
iod
->
fú°_dma
 = 0;

682 
d⁄e
;

685 
dma_Àn
 -(
∑ge_size
 - 
off£t
);

686 i‡(
dma_Àn
) {

687 
dma_addr
 +(
∑ge_size
 - 
off£t
);

689 
sg
 = 
	`sg_√xt
(sg);

690 
dma_addr
 = 
	`sg_dma_addªss
(
sg
);

691 
dma_Àn
 = 
	`sg_dma_Àn
(
sg
);

694 i‡(
Àngth
 <
∑ge_size
) {

695 
iod
->
fú°_dma
 = 
dma_addr
;

696 
d⁄e
;

699 
≈Ωs
 = 
	`DIV_ROUND_UP
(
Àngth
, 
∑ge_size
);

700 i‡(
≈Ωs
 <= (256 / 8)) {

701 
poﬁ
 = 
dev
->
¥p_smÆl_poﬁ
;

702 
iod
->
≈ages
 = 0;

704 
poﬁ
 = 
dev
->
¥p_∑ge_poﬁ
;

705 
iod
->
≈ages
 = 1;

708 
¥p_li°
 = 
	`dma_poﬁ_Æloc
(
poﬁ
, 
GFP_ATOMIC
, &
¥p_dma
);

709 i‡(!
¥p_li°
) {

710 
iod
->
fú°_dma
 = 
dma_addr
;

711 
iod
->
≈ages
 = -1;

712  
BLK_STS_RESOURCE
;

714 
li°
[0] = 
¥p_li°
;

715 
iod
->
fú°_dma
 = 
¥p_dma
;

716 
i
 = 0;

718 i‡(
i
 =
∑ge_size
 >> 3) {

719 
__À64
 *
ﬁd_¥p_li°
 = 
¥p_li°
;

720 
¥p_li°
 = 
	`dma_poﬁ_Æloc
(
poﬁ
, 
GFP_ATOMIC
, &
¥p_dma
);

721 i‡(!
¥p_li°
)

722  
BLK_STS_RESOURCE
;

723 
li°
[
iod
->
≈ages
++] = 
¥p_li°
;

724 
¥p_li°
[0] = 
ﬁd_¥p_li°
[
i
 - 1];

725 
ﬁd_¥p_li°
[
i
 - 1] = 
	`˝u_to_À64
(
¥p_dma
);

726 
i
 = 1;

728 
¥p_li°
[
i
++] = 
	`˝u_to_À64
(
dma_addr
);

729 
dma_Àn
 -
∑ge_size
;

730 
dma_addr
 +
∑ge_size
;

731 
Àngth
 -
∑ge_size
;

732 i‡(
Àngth
 <= 0)

734 i‡(
dma_Àn
 > 0)

736 i‡(
	`u∆ikñy
(
dma_Àn
 < 0))

737 
bad_sgl
;

738 
sg
 = 
	`sg_√xt
(sg);

739 
dma_addr
 = 
	`sg_dma_addªss
(
sg
);

740 
dma_Àn
 = 
	`sg_dma_Àn
(
sg
);

743 
d⁄e
:

744 
cmnd
->
d±r
.
¥p1
 = 
	`˝u_to_À64
(
	`sg_dma_addªss
(
iod
->
sg
));

745 
cmnd
->
d±r
.
¥p2
 = 
	`˝u_to_À64
(
iod
->
fú°_dma
);

747  
BLK_STS_OK
;

749 
bad_sgl
:

750 
	`WARN
(
	`DO_ONCE
(
nvme_¥öt_sgl
, 
iod
->
sg
, iod->
√¡s
),

752 
	`blk_rq_∑ylﬂd_byãs
(
ªq
), 
iod
->
√¡s
);

753  
BLK_STS_IOERR
;

754 
	}
}

756 
	$nvme_pci_sgl_£t_d©a
(
nvme_sgl_desc
 *
sge
,

757 
sˇâîli°
 *
sg
)

759 
sge
->
addr
 = 
	`˝u_to_À64
(
	`sg_dma_addªss
(
sg
));

760 
sge
->
Àngth
 = 
	`˝u_to_À32
(
	`sg_dma_Àn
(
sg
));

761 
sge
->
ty≥
 = 
NVME_SGL_FMT_DATA_DESC
 << 4;

762 
	}
}

764 
	$nvme_pci_sgl_£t_£g
(
nvme_sgl_desc
 *
sge
,

765 
dma_addr_t
 
dma_addr
, 
íåõs
)

767 
sge
->
addr
 = 
	`˝u_to_À64
(
dma_addr
);

768 i‡(
íåõs
 < 
SGES_PER_PAGE
) {

769 
sge
->
Àngth
 = 
	`˝u_to_À32
(
íåõs
 * (*sge));

770 
sge
->
ty≥
 = 
NVME_SGL_FMT_LAST_SEG_DESC
 << 4;

772 
sge
->
Àngth
 = 
	`˝u_to_À32
(
PAGE_SIZE
);

773 
sge
->
ty≥
 = 
NVME_SGL_FMT_SEG_DESC
 << 4;

775 
	}
}

777 
blk_°©us_t
 
	$nvme_pci_£tup_sgls
(
nvme_dev
 *
dev
,

778 
ªque°
 *
ªq
, 
nvme_rw_comm™d
 *
cmd
, 
íåõs
)

780 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

781 
dma_poﬁ
 *
poﬁ
;

782 
nvme_sgl_desc
 *
sg_li°
;

783 
sˇâîli°
 *
sg
 = 
iod
->sg;

784 
dma_addr_t
 
sgl_dma
;

785 
i
 = 0;

788 
cmd
->
Êags
 = 
NVME_CMD_SGL_METABUF
;

790 i‡(
íåõs
 == 1) {

791 
	`nvme_pci_sgl_£t_d©a
(&
cmd
->
d±r
.
sgl
, 
sg
);

792  
BLK_STS_OK
;

795 i‡(
íåõs
 <(256 / (
nvme_sgl_desc
))) {

796 
poﬁ
 = 
dev
->
¥p_smÆl_poﬁ
;

797 
iod
->
≈ages
 = 0;

799 
poﬁ
 = 
dev
->
¥p_∑ge_poﬁ
;

800 
iod
->
≈ages
 = 1;

803 
sg_li°
 = 
	`dma_poﬁ_Æloc
(
poﬁ
, 
GFP_ATOMIC
, &
sgl_dma
);

804 i‡(!
sg_li°
) {

805 
iod
->
≈ages
 = -1;

806  
BLK_STS_RESOURCE
;

809 
	`nvme_pci_iod_li°
(
ªq
)[0] = 
sg_li°
;

810 
iod
->
fú°_dma
 = 
sgl_dma
;

812 
	`nvme_pci_sgl_£t_£g
(&
cmd
->
d±r
.
sgl
, 
sgl_dma
, 
íåõs
);

815 i‡(
i
 =
SGES_PER_PAGE
) {

816 
nvme_sgl_desc
 *
ﬁd_sg_desc
 = 
sg_li°
;

817 
nvme_sgl_desc
 *
lök
 = &
ﬁd_sg_desc
[
i
 - 1];

819 
sg_li°
 = 
	`dma_poﬁ_Æloc
(
poﬁ
, 
GFP_ATOMIC
, &
sgl_dma
);

820 i‡(!
sg_li°
)

821  
BLK_STS_RESOURCE
;

823 
i
 = 0;

824 
	`nvme_pci_iod_li°
(
ªq
)[
iod
->
≈ages
++] = 
sg_li°
;

825 
sg_li°
[
i
++] = *
lök
;

826 
	`nvme_pci_sgl_£t_£g
(
lök
, 
sgl_dma
, 
íåõs
);

829 
	`nvme_pci_sgl_£t_d©a
(&
sg_li°
[
i
++], 
sg
);

830 
sg
 = 
	`sg_√xt
(sg);

831 } --
íåõs
 > 0);

833  
BLK_STS_OK
;

834 
	}
}

836 
blk_°©us_t
 
	$nvme_m≠_d©a
(
nvme_dev
 *
dev
, 
ªque°
 *
ªq
,

837 
nvme_comm™d
 *
cmnd
)

839 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

840 
ªque°_queue
 *
q
 = 
ªq
->q;

841 
dma_d©a_dúe˘i⁄
 
dma_dú
 = 
	`rq_d©a_dú
(
ªq
) ?

842 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

843 
blk_°©us_t
 
ªt
 = 
BLK_STS_IOERR
;

844 
ƒ_m≠≥d
;

846 
	`sg_öô_èbÀ
(
iod
->
sg
, 
	`blk_rq_ƒ_phys_£gmíts
(
ªq
));

847 
iod
->
√¡s
 = 
	`blk_rq_m≠_sg
(
q
, 
ªq
, iod->
sg
);

848 i‡(!
iod
->
√¡s
)

849 
out
;

851 
ªt
 = 
BLK_STS_RESOURCE
;

853 i‡(
	`is_pci_p2pdma_∑ge
(
	`sg_∑ge
(
iod
->
sg
)))

854 
ƒ_m≠≥d
 = 
	`pci_p2pdma_m≠_sg
(
dev
->dev, 
iod
->
sg
, iod->
√¡s
,

855 
dma_dú
);

857 
ƒ_m≠≥d
 = 
	`dma_m≠_sg_©ås
(
dev
->dev, 
iod
->
sg
, iod->
√¡s
,

858 
dma_dú
, 
DMA_ATTR_NO_WARN
);

859 i‡(!
ƒ_m≠≥d
)

860 
out
;

862 i‡(
iod
->
u£_sgl
)

863 
ªt
 = 
	`nvme_pci_£tup_sgls
(
dev
, 
ªq
, &
cmnd
->
rw
, 
ƒ_m≠≥d
);

865 
ªt
 = 
	`nvme_pci_£tup_¥ps
(
dev
, 
ªq
, &
cmnd
->
rw
);

867 i‡(
ªt
 !
BLK_STS_OK
)

868 
out_unm≠
;

870 
ªt
 = 
BLK_STS_IOERR
;

871 i‡(
	`blk_öãgrôy_rq
(
ªq
)) {

872 i‡(
	`blk_rq_cou¡_öãgrôy_sg
(
q
, 
ªq
->
bio
) != 1)

873 
out_unm≠
;

875 
	`sg_öô_èbÀ
(&
iod
->
mëa_sg
, 1);

876 i‡(
	`blk_rq_m≠_öãgrôy_sg
(
q
, 
ªq
->
bio
, &
iod
->
mëa_sg
) != 1)

877 
out_unm≠
;

879 i‡(!
	`dma_m≠_sg
(
dev
->dev, &
iod
->
mëa_sg
, 1, 
dma_dú
))

880 
out_unm≠
;

882 
cmnd
->
rw
.
mëad©a
 = 
	`˝u_to_À64
(
	`sg_dma_addªss
(&
iod
->
mëa_sg
));

885  
BLK_STS_OK
;

887 
out_unm≠
:

888 
	`dma_unm≠_sg
(
dev
->dev, 
iod
->
sg
, iod->
√¡s
, 
dma_dú
);

889 
out
:

890  
ªt
;

891 
	}
}

893 
	$nvme_unm≠_d©a
(
nvme_dev
 *
dev
, 
ªque°
 *
ªq
)

895 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

896 
dma_d©a_dúe˘i⁄
 
dma_dú
 = 
	`rq_d©a_dú
(
ªq
) ?

897 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
;

899 i‡(
iod
->
√¡s
) {

901 i‡(!
	`is_pci_p2pdma_∑ge
(
	`sg_∑ge
(
iod
->
sg
)))

902 
	`dma_unm≠_sg
(
dev
->dev, 
iod
->
sg
, iod->
√¡s
, 
dma_dú
);

904 i‡(
	`blk_öãgrôy_rq
(
ªq
))

905 
	`dma_unm≠_sg
(
dev
->dev, &
iod
->
mëa_sg
, 1, 
dma_dú
);

908 
	`nvme_˛ónup_cmd
(
ªq
);

909 
	`nvme_‰ì_iod
(
dev
, 
ªq
);

910 
	}
}

915 
blk_°©us_t
 
	$nvme_queue_rq
(
blk_mq_hw_˘x
 *
h˘x
,

916 c⁄° 
blk_mq_queue_d©a
 *
bd
)

918 
nvme_ns
 *
ns
 = 
h˘x
->
queue
->
queued©a
;

919 
nvme_queue
 *
nvmeq
 = 
h˘x
->
drivî_d©a
;

920 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

921 
ªque°
 *
ªq
 = 
bd
->
rq
;

922 
nvme_comm™d
 
cmnd
;

923 
blk_°©us_t
 
ªt
;

926 if(!
ªq
)

927 
ajs_íd_£q
;

928 if(!
ªq
->
bio
)

929 
ajs_íd_£q
;

932 i‡(
	`ªq_›
(
ªq
Ë=
REQ_OP_WRITE
){

933 
	`•ö_lock
(&
rb_lock
);

934 
ªq
->
__£˘‹
 = 
£q_£˘‹_num
;

935 
ªq
->
bio
->
bi_ôî
.
bi_£˘‹
 = 
£q_£˘‹_num
;

936 
	`__sync_„tch_™d_add
(&
£q_£˘‹_num
,8);

937 
	`•ö_u∆ock
(&
rb_lock
);

940 
ajs_íd_£q
:

945 i‡(
	`u∆ikñy
(!
	`ã°_bô
(
NVMEQ_ENABLED
, &
nvmeq
->
Êags
)))

946  
BLK_STS_IOERR
;

948 
ªt
 = 
	`nvme_£tup_cmd
(
ns
, 
ªq
, &
cmnd
);

949 i‡(
ªt
)

950  
ªt
;

952 
ªt
 = 
	`nvme_öô_iod
(
ªq
, 
dev
);

953 i‡(
ªt
)

954 
out_‰ì_cmd
;

956 i‡(
	`blk_rq_ƒ_phys_£gmíts
(
ªq
)) {

957 
ªt
 = 
	`nvme_m≠_d©a
(
dev
, 
ªq
, &
cmnd
);

958 i‡(
ªt
)

959 
out_˛ónup_iod
;

964 
	`blk_mq_°¨t_ªque°
(
ªq
);

965 
	`nvme_submô_cmd
(
nvmeq
, &
cmnd
, 
bd
->
œ°
);

966  
BLK_STS_OK
;

967 
out_˛ónup_iod
:

968 
	`nvme_‰ì_iod
(
dev
, 
ªq
);

969 
out_‰ì_cmd
:

970 
	`nvme_˛ónup_cmd
(
ªq
);

971  
ªt
;

972 
	}
}

974 
	$nvme_pci_com∂ëe_rq
(
ªque°
 *
ªq
)

976 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

978 
	`nvme_unm≠_d©a
(
iod
->
nvmeq
->
dev
, 
ªq
);

979 
	`nvme_com∂ëe_rq
(
ªq
);

980 
	}
}

983 
ölöe
 
boﬁ
 
	$nvme_cqe_≥ndög
(
nvme_queue
 *
nvmeq
)

985  (
	`À16_to_˝u
(
nvmeq
->
cqes
[nvmeq->
cq_hód
].
°©us
) & 1) ==

986 
nvmeq
->
cq_pha£
;

987 
	}
}

989 
ölöe
 
	$nvme_rög_cq_do‹bñl
(
nvme_queue
 *
nvmeq
)

991 
u16
 
hód
 = 
nvmeq
->
cq_hód
;

993 i‡(
	`nvme_dbbuf_upd©e_™d_check_evít
(
hód
, 
nvmeq
->
dbbuf_cq_db
,

994 
nvmeq
->
dbbuf_cq_ei
))

995 
	`wrôñ
(
hód
, 
nvmeq
->
q_db
 +Çvmeq->
dev
->
db_°ride
);

996 
	}
}

998 
ölöe
 
	$nvme_h™dÀ_cqe
(
nvme_queue
 *
nvmeq
, 
u16
 
idx
)

1000 vﬁ©ûê
nvme_com∂ëi⁄
 *
cqe
 = &
nvmeq
->
cqes
[
idx
];

1001 
ªque°
 *
ªq
;

1003 i‡(
	`u∆ikñy
(
cqe
->
comm™d_id
 >
nvmeq
->
q_dïth
)) {

1004 
	`dev_w¨n
(
nvmeq
->
dev
->
˘æ
.
devi˚
,

1006 
cqe
->
comm™d_id
, 
	`À16_to_˝u
(cqe->
sq_id
));

1016 i‡(
	`u∆ikñy
(
nvmeq
->
qid
 == 0 &&

1017 
cqe
->
comm™d_id
 >
NVME_AQ_BLK_MQ_DEPTH
)) {

1018 
	`nvme_com∂ëe_async_evít
(&
nvmeq
->
dev
->
˘æ
,

1019 
cqe
->
°©us
, &cqe->
ªsu…
);

1023 
ªq
 = 
	`blk_mq_èg_to_rq
(*
nvmeq
->
ègs
, 
cqe
->
comm™d_id
);

1024 
	`åa˚_nvme_sq
(
ªq
, 
cqe
->
sq_hód
, 
nvmeq
->
sq_èû
);

1025 
	`nvme_íd_ªque°
(
ªq
, 
cqe
->
°©us
, cqe->
ªsu…
);

1026 
	}
}

1028 
	$nvme_com∂ëe_cqes
(
nvme_queue
 *
nvmeq
, 
u16
 
°¨t
, u16 
íd
)

1030 
°¨t
 !
íd
) {

1031 
	`nvme_h™dÀ_cqe
(
nvmeq
, 
°¨t
);

1032 i‡(++
°¨t
 =
nvmeq
->
q_dïth
)

1033 
°¨t
 = 0;

1035 
	}
}

1037 
ölöe
 
	$nvme_upd©e_cq_hód
(
nvme_queue
 *
nvmeq
)

1039 i‡(
nvmeq
->
cq_hód
 =nvmeq->
q_dïth
 - 1) {

1040 
nvmeq
->
cq_hód
 = 0;

1041 
nvmeq
->
cq_pha£
 = !nvmeq->cq_phase;

1043 
nvmeq
->
cq_hód
++;

1045 
	}
}

1047 
ölöe
 
	$nvme_¥o˚ss_cq
(
nvme_queue
 *
nvmeq
, 
u16
 *
°¨t
,

1048 
u16
 *
íd
, 
èg
)

1050 
found
 = 0;

1052 *
°¨t
 = 
nvmeq
->
cq_hód
;

1053 
	`nvme_cqe_≥ndög
(
nvmeq
)) {

1054 i‡(
èg
 =-1U || 
nvmeq
->
cqes
[nvmeq->
cq_hód
].
comm™d_id
 ==Åag)

1055 
found
++;

1056 
	`nvme_upd©e_cq_hód
(
nvmeq
);

1058 *
íd
 = 
nvmeq
->
cq_hód
;

1060 i‡(*
°¨t
 !*
íd
)

1061 
	`nvme_rög_cq_do‹bñl
(
nvmeq
);

1062  
found
;

1063 
	}
}

1065 
úqªtu∫_t
 
	$nvme_úq
(
úq
, *
d©a
)

1067 
nvme_queue
 *
nvmeq
 = 
d©a
;

1068 
úqªtu∫_t
 
ªt
 = 
IRQ_NONE
;

1069 
u16
 
°¨t
, 
íd
;

1075 
	`rmb
();

1076 i‡(
nvmeq
->
cq_hód
 !nvmeq->
œ°_cq_hód
)

1077 
ªt
 = 
IRQ_HANDLED
;

1078 
	`nvme_¥o˚ss_cq
(
nvmeq
, &
°¨t
, &
íd
, -1);

1079 
nvmeq
->
œ°_cq_hód
 =Çvmeq->
cq_hód
;

1080 
	`wmb
();

1082 i‡(
°¨t
 !
íd
) {

1083 
	`nvme_com∂ëe_cqes
(
nvmeq
, 
°¨t
, 
íd
);

1084  
IRQ_HANDLED
;

1087  
ªt
;

1088 
	}
}

1090 
úqªtu∫_t
 
	$nvme_úq_check
(
úq
, *
d©a
)

1092 
nvme_queue
 *
nvmeq
 = 
d©a
;

1093 i‡(
	`nvme_cqe_≥ndög
(
nvmeq
))

1094  
IRQ_WAKE_THREAD
;

1095  
IRQ_NONE
;

1096 
	}
}

1102 
	$nvme_pﬁl_úqdißbÀ
(
nvme_queue
 *
nvmeq
, 
èg
)

1104 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
nvmeq
->
dev
->dev);

1105 
u16
 
°¨t
, 
íd
;

1106 
found
;

1113 i‡(
nvmeq
->
cq_ve˘‹
 == -1) {

1114 
	`•ö_lock
(&
nvmeq
->
cq_pﬁl_lock
);

1115 
found
 = 
	`nvme_¥o˚ss_cq
(
nvmeq
, &
°¨t
, &
íd
, 
èg
);

1116 
	`•ö_u∆ock
(&
nvmeq
->
cq_pﬁl_lock
);

1118 
	`dißbÀ_úq
(
	`pci_úq_ve˘‹
(
pdev
, 
nvmeq
->
cq_ve˘‹
));

1119 
found
 = 
	`nvme_¥o˚ss_cq
(
nvmeq
, &
°¨t
, &
íd
, 
èg
);

1120 
	`íabÀ_úq
(
	`pci_úq_ve˘‹
(
pdev
, 
nvmeq
->
cq_ve˘‹
));

1123 
	`nvme_com∂ëe_cqes
(
nvmeq
, 
°¨t
, 
íd
);

1124  
found
;

1125 
	}
}

1127 
	$nvme_pﬁl
(
blk_mq_hw_˘x
 *
h˘x
)

1129 
nvme_queue
 *
nvmeq
 = 
h˘x
->
drivî_d©a
;

1130 
u16
 
°¨t
, 
íd
;

1131 
boﬁ
 
found
;

1133 i‡(!
	`nvme_cqe_≥ndög
(
nvmeq
))

1136 
	`•ö_lock
(&
nvmeq
->
cq_pﬁl_lock
);

1137 
found
 = 
	`nvme_¥o˚ss_cq
(
nvmeq
, &
°¨t
, &
íd
, -1);

1138 
	`•ö_u∆ock
(&
nvmeq
->
cq_pﬁl_lock
);

1140 
	`nvme_com∂ëe_cqes
(
nvmeq
, 
°¨t
, 
íd
);

1141  
found
;

1142 
	}
}

1144 
	$nvme_pci_submô_async_evít
(
nvme_˘æ
 *
˘æ
)

1146 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
˘æ
);

1147 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

1148 
nvme_comm™d
 
c
;

1150 
	`mem£t
(&
c
, 0, (c));

1151 
c
.
comm⁄
.
›code
 = 
nvme_admö_async_evít
;

1152 
c
.
comm⁄
.
comm™d_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1153 
	`nvme_submô_cmd
(
nvmeq
, &
c
, 
åue
);

1154 
	}
}

1156 
	$ad≠ãr_dñëe_queue
(
nvme_dev
 *
dev
, 
u8
 
›code
, 
u16
 
id
)

1158 
nvme_comm™d
 
c
;

1160 
	`mem£t
(&
c
, 0, (c));

1161 
c
.
dñëe_queue
.
›code
 = opcode;

1162 
c
.
dñëe_queue
.
qid
 = 
	`˝u_to_À16
(
id
);

1164  
	`nvme_submô_sync_cmd
(
dev
->
˘æ
.
admö_q
, &
c
, 
NULL
, 0);

1165 
	}
}

1167 
	$ad≠ãr_Æloc_cq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1168 
nvme_queue
 *
nvmeq
, 
s16
 
ve˘‹
)

1170 
nvme_comm™d
 
c
;

1171 
Êags
 = 
NVME_QUEUE_PHYS_CONTIG
;

1173 i‡(
ve˘‹
 != -1)

1174 
Êags
 |
NVME_CQ_IRQ_ENABLED
;

1180 
	`mem£t
(&
c
, 0, (c));

1181 
c
.
¸óã_cq
.
›code
 = 
nvme_admö_¸óã_cq
;

1182 
c
.
¸óã_cq
.
¥p1
 = 
	`˝u_to_À64
(
nvmeq
->
cq_dma_addr
);

1183 
c
.
¸óã_cq
.
cqid
 = 
	`˝u_to_À16
(
qid
);

1184 
c
.
¸óã_cq
.
qsize
 = 
	`˝u_to_À16
(
nvmeq
->
q_dïth
 - 1);

1185 
c
.
¸óã_cq
.
cq_Êags
 = 
	`˝u_to_À16
(
Êags
);

1186 i‡(
ve˘‹
 != -1)

1187 
c
.
¸óã_cq
.
úq_ve˘‹
 = 
	`˝u_to_À16
(
ve˘‹
);

1189 
c
.
¸óã_cq
.
úq_ve˘‹
 = 0;

1191  
	`nvme_submô_sync_cmd
(
dev
->
˘æ
.
admö_q
, &
c
, 
NULL
, 0);

1192 
	}
}

1194 
	$ad≠ãr_Æloc_sq
(
nvme_dev
 *
dev
, 
u16
 
qid
,

1195 
nvme_queue
 *
nvmeq
)

1197 
nvme_˘æ
 *
˘æ
 = &
dev
->ctrl;

1198 
nvme_comm™d
 
c
;

1199 
Êags
 = 
NVME_QUEUE_PHYS_CONTIG
;

1206 i‡(
˘æ
->
quúks
 & 
NVME_QUIRK_MEDIUM_PRIO_SQ
)

1207 
Êags
 |
NVME_SQ_PRIO_MEDIUM
;

1213 
	`mem£t
(&
c
, 0, (c));

1214 
c
.
¸óã_sq
.
›code
 = 
nvme_admö_¸óã_sq
;

1215 
c
.
¸óã_sq
.
¥p1
 = 
	`˝u_to_À64
(
nvmeq
->
sq_dma_addr
);

1216 
c
.
¸óã_sq
.
sqid
 = 
	`˝u_to_À16
(
qid
);

1217 
c
.
¸óã_sq
.
qsize
 = 
	`˝u_to_À16
(
nvmeq
->
q_dïth
 - 1);

1218 
c
.
¸óã_sq
.
sq_Êags
 = 
	`˝u_to_À16
(
Êags
);

1219 
c
.
¸óã_sq
.
cqid
 = 
	`˝u_to_À16
(
qid
);

1221  
	`nvme_submô_sync_cmd
(
dev
->
˘æ
.
admö_q
, &
c
, 
NULL
, 0);

1222 
	}
}

1224 
	$ad≠ãr_dñëe_cq
(
nvme_dev
 *
dev
, 
u16
 
cqid
)

1226  
	`ad≠ãr_dñëe_queue
(
dev
, 
nvme_admö_dñëe_cq
, 
cqid
);

1227 
	}
}

1229 
	$ad≠ãr_dñëe_sq
(
nvme_dev
 *
dev
, 
u16
 
sqid
)

1231  
	`ad≠ãr_dñëe_queue
(
dev
, 
nvme_admö_dñëe_sq
, 
sqid
);

1232 
	}
}

1234 
	$ab‹t_ídio
(
ªque°
 *
ªq
, 
blk_°©us_t
 
îr‹
)

1236 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

1237 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1239 
	`dev_w¨n
(
nvmeq
->
dev
->
˘æ
.
devi˚
,

1240 "Ab‹à°©us: 0x%x", 
	`nvme_ªq
(
ªq
)->
°©us
);

1241 
	`©omic_öc
(&
nvmeq
->
dev
->
˘æ
.
ab‹t_limô
);

1242 
	`blk_mq_‰ì_ªque°
(
ªq
);

1243 
	}
}

1245 
boﬁ
 
	$nvme_should_ª£t
(
nvme_dev
 *
dev
, 
u32
 
c°s
)

1251 
boﬁ
 
ns§o
 = 
dev
->
subsy°em
 && (
c°s
 & 
NVME_CSTS_NSSRO
);

1254 
dev
->
˘æ
.
°©e
) {

1255 
NVME_CTRL_RESETTING
:

1256 
NVME_CTRL_CONNECTING
:

1257  
Ál£
;

1265 i‡(!(
c°s
 & 
NVME_CSTS_CFS
Ë&& !
ns§o
)

1266  
Ál£
;

1268  
åue
;

1269 
	}
}

1271 
	$nvme_w¨n_ª£t
(
nvme_dev
 *
dev
, 
u32
 
c°s
)

1274 
u16
 
pci_°©us
;

1275 
ªsu…
;

1277 
ªsu…
 = 
	`pci_ªad_c⁄fig_w‹d
(
	`to_pci_dev
(
dev
->dev), 
PCI_STATUS
,

1278 &
pci_°©us
);

1279 i‡(
ªsu…
 =
PCIBIOS_SUCCESSFUL
)

1280 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1282 
c°s
, 
pci_°©us
);

1284 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1286 
c°s
, 
ªsu…
);

1287 
	}
}

1289 
blk_eh_timî_ªtu∫
 
	$nvme_timeout
(
ªque°
 *
ªq
, 
boﬁ
 
ª£rved
)

1291 
nvme_iod
 *
iod
 = 
	`blk_mq_rq_to_pdu
(
ªq
);

1292 
nvme_queue
 *
nvmeq
 = 
iod
->nvmeq;

1293 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1294 
ªque°
 *
ab‹t_ªq
;

1295 
nvme_comm™d
 
cmd
;

1296 
boﬁ
 
shutdown
 = 
Ál£
;

1297 
u32
 
c°s
 = 
	`ªadl
(
dev
->
b¨
 + 
NVME_REG_CSTS
);

1302 
	`mb
();

1303 i‡(
	`pci_ch™√l_ofÊöe
(
	`to_pci_dev
(
dev
->dev)))

1304  
BLK_EH_RESET_TIMER
;

1309 i‡(
	`nvme_should_ª£t
(
dev
, 
c°s
)) {

1310 
	`nvme_w¨n_ª£t
(
dev
, 
c°s
);

1311 
	`nvme_dev_dißbÀ
(
dev
, 
Ál£
);

1312 
	`nvme_ª£t_˘æ
(&
dev
->
˘æ
);

1313  
BLK_EH_DONE
;

1319 i‡(
	`nvme_pﬁl_úqdißbÀ
(
nvmeq
, 
ªq
->
èg
)) {

1320 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1322 
ªq
->
èg
, 
nvmeq
->
qid
);

1323  
BLK_EH_DONE
;

1332 
dev
->
˘æ
.
°©e
) {

1333 
NVME_CTRL_DELETING
:

1334 
shutdown
 = 
åue
;

1335 
NVME_CTRL_CONNECTING
:

1336 
NVME_CTRL_RESETTING
:

1337 
	`dev_w¨n_øãlimôed
(
dev
->
˘æ
.
devi˚
,

1339 
ªq
->
èg
, 
nvmeq
->
qid
);

1340 
	`nvme_dev_dißbÀ
(
dev
, 
shutdown
);

1341 
	`nvme_ªq
(
ªq
)->
Êags
 |
NVME_REQ_CANCELLED
;

1342  
BLK_EH_DONE
;

1352 i‡(!
nvmeq
->
qid
 || 
iod
->
ab‹ãd
) {

1353 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1355 
ªq
->
èg
, 
nvmeq
->
qid
);

1356 
	`nvme_dev_dißbÀ
(
dev
, 
Ál£
);

1357 
	`nvme_ª£t_˘æ
(&
dev
->
˘æ
);

1359 
	`nvme_ªq
(
ªq
)->
Êags
 |
NVME_REQ_CANCELLED
;

1360  
BLK_EH_DONE
;

1363 i‡(
	`©omic_dec_ªtu∫
(&
dev
->
˘æ
.
ab‹t_limô
) < 0) {

1364 
	`©omic_öc
(&
dev
->
˘æ
.
ab‹t_limô
);

1365  
BLK_EH_RESET_TIMER
;

1367 
iod
->
ab‹ãd
 = 1;

1369 
	`mem£t
(&
cmd
, 0, (cmd));

1370 
cmd
.
ab‹t
.
›code
 = 
nvme_admö_ab‹t_cmd
;

1371 
cmd
.
ab‹t
.
cid
 = 
ªq
->
èg
;

1372 
cmd
.
ab‹t
.
sqid
 = 
	`˝u_to_À16
(
nvmeq
->
qid
);

1374 
	`dev_w¨n
(
nvmeq
->
dev
->
˘æ
.
devi˚
,

1376 
ªq
->
èg
, 
nvmeq
->
qid
);

1378 
ab‹t_ªq
 = 
	`nvme_Æloc_ªque°
(
dev
->
˘æ
.
admö_q
, &
cmd
,

1379 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

1380 i‡(
	`IS_ERR
(
ab‹t_ªq
)) {

1381 
	`©omic_öc
(&
dev
->
˘æ
.
ab‹t_limô
);

1382  
BLK_EH_RESET_TIMER
;

1385 
ab‹t_ªq
->
timeout
 = 
ADMIN_TIMEOUT
;

1386 
ab‹t_ªq
->
íd_io_d©a
 = 
NULL
;

1387 
	`blk_execuã_rq_nowaô
(
ab‹t_ªq
->
q
, 
NULL
,áb‹t_ªq, 0, 
ab‹t_ídio
);

1394  
BLK_EH_RESET_TIMER
;

1395 
	}
}

1397 
	$nvme_‰ì_queue
(
nvme_queue
 *
nvmeq
)

1399 
	`dma_‰ì_cohîít
(
nvmeq
->
q_dmadev
, 
	`CQ_SIZE
“vmeq->
q_dïth
),

1400 (*)
nvmeq
->
cqes
,Çvmeq->
cq_dma_addr
);

1401 i‡(!
nvmeq
->
sq_cmds
)

1404 i‡(
	`ã°_™d_˛ór_bô
(
NVMEQ_SQ_CMB
, &
nvmeq
->
Êags
)) {

1405 
	`pci_‰ì_p2pmem
(
	`to_pci_dev
(
nvmeq
->
q_dmadev
),

1406 
nvmeq
->
sq_cmds
, 
	`SQ_SIZE
“vmeq->
q_dïth
));

1408 
	`dma_‰ì_cohîít
(
nvmeq
->
q_dmadev
, 
	`SQ_SIZE
“vmeq->
q_dïth
),

1409 
nvmeq
->
sq_cmds
,Çvmeq->
sq_dma_addr
);

1411 
	}
}

1413 
	$nvme_‰ì_queues
(
nvme_dev
 *
dev
, 
lowe°
)

1415 
i
;

1417 
i
 = 
dev
->
˘æ
.
queue_cou¡
 - 1; i >
lowe°
; i--) {

1418 
dev
->
˘æ
.
queue_cou¡
--;

1419 
	`nvme_‰ì_queue
(&
dev
->
queues
[
i
]);

1421 
	}
}

1427 
	$nvme_su•íd_queue
(
nvme_queue
 *
nvmeq
)

1429 i‡(!
	`ã°_™d_˛ór_bô
(
NVMEQ_ENABLED
, &
nvmeq
->
Êags
))

1433 
	`mb
();

1435 
nvmeq
->
dev
->
⁄löe_queues
--;

1436 i‡(!
nvmeq
->
qid
 &&Çvmeq->
dev
->
˘æ
.
admö_q
)

1437 
	`blk_mq_quõs˚_queue
(
nvmeq
->
dev
->
˘æ
.
admö_q
);

1438 i‡(
nvmeq
->
cq_ve˘‹
 == -1)

1440 
	`pci_‰ì_úq
(
	`to_pci_dev
(
nvmeq
->
dev
->dev),Çvmeq->
cq_ve˘‹
,Çvmeq);

1441 
nvmeq
->
cq_ve˘‹
 = -1;

1443 
	}
}

1445 
	$nvme_su•íd_io_queues
(
nvme_dev
 *
dev
)

1447 
i
;

1449 
i
 = 
dev
->
˘æ
.
queue_cou¡
 - 1; i > 0; i--)

1450 
	`nvme_su•íd_queue
(&
dev
->
queues
[
i
]);

1451 
	}
}

1453 
	$nvme_dißbÀ_admö_queue
(
nvme_dev
 *
dev
, 
boﬁ
 
shutdown
)

1455 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[0];

1457 i‡(
shutdown
)

1458 
	`nvme_shutdown_˘æ
(&
dev
->
˘æ
);

1460 
	`nvme_dißbÀ_˘æ
(&
dev
->
˘æ
, dev->˘æ.
ˇp
);

1462 
	`nvme_pﬁl_úqdißbÀ
(
nvmeq
, -1);

1463 
	}
}

1465 
	$nvme_cmb_qdïth
(
nvme_dev
 *
dev
, 
ƒ_io_queues
,

1466 
íåy_size
)

1468 
q_dïth
 = 
dev
->q_depth;

1469 
q_size_Æig√d
 = 
	`roundup
(
q_dïth
 * 
íåy_size
,

1470 
dev
->
˘æ
.
∑ge_size
);

1472 i‡(
q_size_Æig√d
 * 
ƒ_io_queues
 > 
dev
->
cmb_size
) {

1473 
u64
 
mem_≥r_q
 = 
	`div_u64
(
dev
->
cmb_size
, 
ƒ_io_queues
);

1474 
mem_≥r_q
 = 
	`round_down
(mem_≥r_q, 
dev
->
˘æ
.
∑ge_size
);

1475 
q_dïth
 = 
	`div_u64
(
mem_≥r_q
, 
íåy_size
);

1482 i‡(
q_dïth
 < 64)

1483  -
ENOMEM
;

1486  
q_dïth
;

1487 
	}
}

1489 
	$nvme_Æloc_sq_cmds
(
nvme_dev
 *
dev
, 
nvme_queue
 *
nvmeq
,

1490 
qid
, 
dïth
)

1492 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1494 i‡(
qid
 && 
dev
->
cmb_u£_sqes
 && (dev->
cmbsz
 & 
NVME_CMBSZ_SQS
)) {

1495 
nvmeq
->
sq_cmds
 = 
	`pci_Æloc_p2pmem
(
pdev
, 
	`SQ_SIZE
(
dïth
));

1496 
nvmeq
->
sq_dma_addr
 = 
	`pci_p2pmem_vút_to_bus
(
pdev
,

1497 
nvmeq
->
sq_cmds
);

1498 i‡(
nvmeq
->
sq_dma_addr
) {

1499 
	`£t_bô
(
NVMEQ_SQ_CMB
, &
nvmeq
->
Êags
);

1504 
nvmeq
->
sq_cmds
 = 
	`dma_Æloc_cohîít
(
dev
->dev, 
	`SQ_SIZE
(
dïth
),

1505 &
nvmeq
->
sq_dma_addr
, 
GFP_KERNEL
);

1506 i‡(!
nvmeq
->
sq_cmds
)

1507  -
ENOMEM
;

1509 
	}
}

1511 
	$nvme_Æloc_queue
(
nvme_dev
 *
dev
, 
qid
, 
dïth
)

1513 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
qid
];

1515 i‡(
dev
->
˘æ
.
queue_cou¡
 > 
qid
)

1518 
nvmeq
->
cqes
 = 
	`dma_Æloc_cohîít
(
dev
->dev, 
	`CQ_SIZE
(
dïth
),

1519 &
nvmeq
->
cq_dma_addr
, 
GFP_KERNEL
);

1520 i‡(!
nvmeq
->
cqes
)

1521 
‰ì_nvmeq
;

1523 i‡(
	`nvme_Æloc_sq_cmds
(
dev
, 
nvmeq
, 
qid
, 
dïth
))

1524 
‰ì_cqdma
;

1526 
nvmeq
->
q_dmadev
 = 
dev
->dev;

1527 
nvmeq
->
dev
 = dev;

1528 
	`•ö_lock_öô
(&
nvmeq
->
sq_lock
);

1529 
	`•ö_lock_öô
(&
nvmeq
->
cq_pﬁl_lock
);

1530 
nvmeq
->
cq_hód
 = 0;

1531 
nvmeq
->
cq_pha£
 = 1;

1532 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_°ride
];

1533 
nvmeq
->
q_dïth
 = 
dïth
;

1534 
nvmeq
->
qid
 = qid;

1535 
nvmeq
->
cq_ve˘‹
 = -1;

1536 
dev
->
˘æ
.
queue_cou¡
++;

1540 
‰ì_cqdma
:

1541 
	`dma_‰ì_cohîít
(
dev
->dev, 
	`CQ_SIZE
(
dïth
), (*)
nvmeq
->
cqes
,

1542 
nvmeq
->
cq_dma_addr
);

1543 
‰ì_nvmeq
:

1544  -
ENOMEM
;

1545 
	}
}

1547 
	$queue_ªque°_úq
(
nvme_queue
 *
nvmeq
)

1549 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
nvmeq
->
dev
->dev);

1550 
ƒ
 = 
nvmeq
->
dev
->
˘æ
.
ö°™˚
;

1552 i‡(
u£_thªaded_öãºu±s
) {

1553  
	`pci_ªque°_úq
(
pdev
, 
nvmeq
->
cq_ve˘‹
, 
nvme_úq_check
,

1554 
nvme_úq
, 
nvmeq
, "nvme%dq%d", 
ƒ
,Çvmeq->
qid
);

1556  
	`pci_ªque°_úq
(
pdev
, 
nvmeq
->
cq_ve˘‹
, 
nvme_úq
,

1557 
NULL
, 
nvmeq
, "nvme%dq%d", 
ƒ
,Çvmeq->
qid
);

1559 
	}
}

1561 
	$nvme_öô_queue
(
nvme_queue
 *
nvmeq
, 
u16
 
qid
)

1563 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1565 
nvmeq
->
sq_èû
 = 0;

1566 
nvmeq
->
œ°_sq_èû
 = 0;

1567 
nvmeq
->
cq_hód
 = 0;

1568 
nvmeq
->
cq_pha£
 = 1;

1569 
nvmeq
->
q_db
 = &
dev
->
dbs
[
qid
 * 2 * dev->
db_°ride
];

1570 
	`mem£t
((*)
nvmeq
->
cqes
, 0, 
	`CQ_SIZE
“vmeq->
q_dïth
));

1571 
	`nvme_dbbuf_öô
(
dev
, 
nvmeq
, 
qid
);

1572 
dev
->
⁄löe_queues
++;

1573 
	`wmb
();

1574 
	}
}

1576 
	$nvme_¸óã_queue
(
nvme_queue
 *
nvmeq
, 
qid
, 
boﬁ
 
pﬁÀd
)

1578 
nvme_dev
 *
dev
 = 
nvmeq
->dev;

1579 
ªsu…
;

1580 
s16
 
ve˘‹
;

1582 
	`˛ór_bô
(
NVMEQ_DELETE_ERROR
, &
nvmeq
->
Êags
);

1588 i‡(!
pﬁÀd
)

1589 
ve˘‹
 = 
dev
->
num_vecs
 =1 ? 0 : 
qid
;

1591 
ve˘‹
 = -1;

1593 
ªsu…
 = 
	`ad≠ãr_Æloc_cq
(
dev
, 
qid
, 
nvmeq
, 
ve˘‹
);

1594 i‡(
ªsu…
)

1595  
ªsu…
;

1597 
ªsu…
 = 
	`ad≠ãr_Æloc_sq
(
dev
, 
qid
, 
nvmeq
);

1598 i‡(
ªsu…
 < 0)

1599  
ªsu…
;

1600 i‡(
ªsu…
)

1601 
ªÀa£_cq
;

1603 
nvmeq
->
cq_ve˘‹
 = 
ve˘‹
;

1604 
	`nvme_öô_queue
(
nvmeq
, 
qid
);

1606 i‡(
ve˘‹
 != -1) {

1607 
ªsu…
 = 
	`queue_ªque°_úq
(
nvmeq
);

1608 i‡(
ªsu…
 < 0)

1609 
ªÀa£_sq
;

1612 
	`£t_bô
(
NVMEQ_ENABLED
, &
nvmeq
->
Êags
);

1613  
ªsu…
;

1615 
ªÀa£_sq
:

1616 
nvmeq
->
cq_ve˘‹
 = -1;

1617 
dev
->
⁄löe_queues
--;

1618 
	`ad≠ãr_dñëe_sq
(
dev
, 
qid
);

1619 
ªÀa£_cq
:

1620 
	`ad≠ãr_dñëe_cq
(
dev
, 
qid
);

1621  
ªsu…
;

1622 
	}
}

1624 c⁄° 
blk_mq_›s
 
	gnvme_mq_admö_›s
 = {

1625 .
queue_rq
 = 
nvme_queue_rq
,

1626 .
	gcom∂ëe
 = 
nvme_pci_com∂ëe_rq
,

1627 .
	göô_h˘x
 = 
nvme_admö_öô_h˘x
,

1628 .
	gexô_h˘x
 = 
nvme_admö_exô_h˘x
,

1629 .
	göô_ªque°
 = 
nvme_öô_ªque°
,

1630 .
	gtimeout
 = 
nvme_timeout
,

1633 c⁄° 
blk_mq_›s
 
	gnvme_mq_›s
 = {

1634 .
queue_rq
 = 
nvme_queue_rq
,

1635 .
	gcom∂ëe
 = 
nvme_pci_com∂ëe_rq
,

1636 .
	gcommô_rqs
 = 
nvme_commô_rqs
,

1637 .
	göô_h˘x
 = 
nvme_öô_h˘x
,

1638 .
	göô_ªque°
 = 
nvme_öô_ªque°
,

1639 .
	gm≠_queues
 = 
nvme_pci_m≠_queues
,

1640 .
	gtimeout
 = 
nvme_timeout
,

1641 .
	gpﬁl
 = 
nvme_pﬁl
,

1644 
	$nvme_dev_ªmove_admö
(
nvme_dev
 *
dev
)

1646 i‡(
dev
->
˘æ
.
admö_q
 && !
	`blk_queue_dyög
(dev->ctrl.admin_q)) {

1652 
	`blk_mq_unquõs˚_queue
(
dev
->
˘æ
.
admö_q
);

1653 
	`blk_˛ónup_queue
(
dev
->
˘æ
.
admö_q
);

1654 
	`blk_mq_‰ì_èg_£t
(&
dev
->
admö_èg£t
);

1656 
	}
}

1658 
	$nvme_Æloc_admö_ègs
(
nvme_dev
 *
dev
)

1660 i‡(!
dev
->
˘æ
.
admö_q
) {

1661 
dev
->
admö_èg£t
.
›s
 = &
nvme_mq_admö_›s
;

1662 
dev
->
admö_èg£t
.
ƒ_hw_queues
 = 1;

1664 
dev
->
admö_èg£t
.
queue_dïth
 = 
NVME_AQ_MQ_TAG_DEPTH
;

1665 
dev
->
admö_èg£t
.
timeout
 = 
ADMIN_TIMEOUT
;

1666 
dev
->
admö_èg£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

1667 
dev
->
admö_èg£t
.
cmd_size
 = 
	`nvme_pci_cmd_size
(dev, 
Ál£
);

1668 
dev
->
admö_èg£t
.
Êags
 = 
BLK_MQ_F_NO_SCHED
;

1669 
dev
->
admö_èg£t
.
drivî_d©a
 = dev;

1671 i‡(
	`blk_mq_Æloc_èg_£t
(&
dev
->
admö_èg£t
))

1672  -
ENOMEM
;

1673 
dev
->
˘æ
.
admö_èg£t
 = &dev->admin_tagset;

1675 
dev
->
˘æ
.
admö_q
 = 
	`blk_mq_öô_queue
(&dev->
admö_èg£t
);

1676 i‡(
	`IS_ERR
(
dev
->
˘æ
.
admö_q
)) {

1677 
	`blk_mq_‰ì_èg_£t
(&
dev
->
admö_èg£t
);

1678  -
ENOMEM
;

1680 i‡(!
	`blk_gë_queue
(
dev
->
˘æ
.
admö_q
)) {

1681 
	`nvme_dev_ªmove_admö
(
dev
);

1682 
dev
->
˘æ
.
admö_q
 = 
NULL
;

1683  -
ENODEV
;

1686 
	`blk_mq_unquõs˚_queue
(
dev
->
˘æ
.
admö_q
);

1689 
	}
}

1691 
	$db_b¨_size
(
nvme_dev
 *
dev
, 
ƒ_io_queues
)

1693  
NVME_REG_DBS
 + ((
ƒ_io_queues
 + 1Ë* 8 * 
dev
->
db_°ride
);

1694 
	}
}

1696 
	$nvme_ªm≠_b¨
(
nvme_dev
 *
dev
, 
size
)

1698 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1700 i‡(
size
 <
dev
->
b¨_m≠≥d_size
)

1702 i‡(
size
 > 
	`pci_ªsour˚_Àn
(
pdev
, 0))

1703  -
ENOMEM
;

1704 i‡(
dev
->
b¨
)

1705 
	`iounm≠
(
dev
->
b¨
);

1706 
dev
->
b¨
 = 
	`i‹em≠
(
	`pci_ªsour˚_°¨t
(
pdev
, 0), 
size
);

1707 i‡(!
dev
->
b¨
) {

1708 
dev
->
b¨_m≠≥d_size
 = 0;

1709  -
ENOMEM
;

1711 
dev
->
b¨_m≠≥d_size
 = 
size
;

1712 
dev
->
dbs
 = dev->
b¨
 + 
NVME_REG_DBS
;

1715 
	}
}

1717 
	$nvme_pci_c⁄figuª_admö_queue
(
nvme_dev
 *
dev
)

1719 
ªsu…
;

1720 
u32
 
aqa
;

1721 
nvme_queue
 *
nvmeq
;

1723 
ªsu…
 = 
	`nvme_ªm≠_b¨
(
dev
, 
	`db_b¨_size
(dev, 0));

1724 i‡(
ªsu…
 < 0)

1725  
ªsu…
;

1727 
dev
->
subsy°em
 = 
	`ªadl
(dev->
b¨
 + 
NVME_REG_VS
Ë>
	`NVME_VS
(1, 1, 0) ?

1728 
	`NVME_CAP_NSSRC
(
dev
->
˘æ
.
ˇp
) : 0;

1730 i‡(
dev
->
subsy°em
 &&

1731 (
	`ªadl
(
dev
->
b¨
 + 
NVME_REG_CSTS
Ë& 
NVME_CSTS_NSSRO
))

1732 
	`wrôñ
(
NVME_CSTS_NSSRO
, 
dev
->
b¨
 + 
NVME_REG_CSTS
);

1734 
ªsu…
 = 
	`nvme_dißbÀ_˘æ
(&
dev
->
˘æ
, dev->˘æ.
ˇp
);

1735 i‡(
ªsu…
 < 0)

1736  
ªsu…
;

1738 
ªsu…
 = 
	`nvme_Æloc_queue
(
dev
, 0, 
NVME_AQ_DEPTH
);

1739 i‡(
ªsu…
)

1740  
ªsu…
;

1742 
nvmeq
 = &
dev
->
queues
[0];

1743 
aqa
 = 
nvmeq
->
q_dïth
 - 1;

1744 
aqa
 |=áqa << 16;

1746 
	`wrôñ
(
aqa
, 
dev
->
b¨
 + 
NVME_REG_AQA
);

1747 
	`lo_hi_wrôeq
(
nvmeq
->
sq_dma_addr
, 
dev
->
b¨
 + 
NVME_REG_ASQ
);

1748 
	`lo_hi_wrôeq
(
nvmeq
->
cq_dma_addr
, 
dev
->
b¨
 + 
NVME_REG_ACQ
);

1750 
ªsu…
 = 
	`nvme_íabÀ_˘æ
(&
dev
->
˘æ
, dev->˘æ.
ˇp
);

1751 i‡(
ªsu…
)

1752  
ªsu…
;

1754 
nvmeq
->
cq_ve˘‹
 = 0;

1755 
	`nvme_öô_queue
(
nvmeq
, 0);

1756 
ªsu…
 = 
	`queue_ªque°_úq
(
nvmeq
);

1757 i‡(
ªsu…
) {

1758 
nvmeq
->
cq_ve˘‹
 = -1;

1759  
ªsu…
;

1762 
	`£t_bô
(
NVMEQ_ENABLED
, &
nvmeq
->
Êags
);

1763  
ªsu…
;

1764 
	}
}

1766 
	$nvme_¸óã_io_queues
(
nvme_dev
 *
dev
)

1768 
i
, 
max
, 
rw_queues
;

1769 
ªt
 = 0;

1771 
i
 = 
dev
->
˘æ
.
queue_cou¡
; i <dev->
max_qid
; i++) {

1772 i‡(
	`nvme_Æloc_queue
(
dev
, 
i
, dev->
q_dïth
)) {

1773 
ªt
 = -
ENOMEM
;

1778 
max
 = 
	`mö
(
dev
->
max_qid
, dev->
˘æ
.
queue_cou¡
 - 1);

1779 i‡(
max
 !1 && 
dev
->
io_queues
[
HCTX_TYPE_POLL
]) {

1780 
rw_queues
 = 
dev
->
io_queues
[
HCTX_TYPE_DEFAULT
] +

1781 
dev
->
io_queues
[
HCTX_TYPE_READ
];

1783 
rw_queues
 = 
max
;

1786 
i
 = 
dev
->
⁄löe_queues
; i <
max
; i++) {

1787 
boﬁ
 
pﬁÀd
 = 
i
 > 
rw_queues
;

1789 
ªt
 = 
	`nvme_¸óã_queue
(&
dev
->
queues
[
i
], i, 
pﬁÀd
);

1790 i‡(
ªt
)

1800  
ªt
 >= 0 ? 0 :Ñet;

1801 
	}
}

1803 
ssize_t
 
	$nvme_cmb_show
(
devi˚
 *
dev
,

1804 
devi˚_©åibuã
 *
©å
,

1805 *
buf
)

1807 
nvme_dev
 *
ndev
 = 
	`to_nvme_dev
(
	`dev_gë_drvd©a
(
dev
));

1809  
	`s˙¥ötf
(
buf
, 
PAGE_SIZE
, "cmbloc : x%08x\ncmbsz : x%08x\n",

1810 
ndev
->
cmbloc
,Çdev->
cmbsz
);

1811 
	}
}

1812 
DEVICE_ATTR
(
cmb
, 
S_IRUGO
, 
nvme_cmb_show
, 
NULL
);

1814 
u64
 
	$nvme_cmb_size_unô
(
nvme_dev
 *
dev
)

1816 
u8
 
szu
 = (
dev
->
cmbsz
 >> 
NVME_CMBSZ_SZU_SHIFT
Ë& 
NVME_CMBSZ_SZU_MASK
;

1818  1ULL << (12 + 4 * 
szu
);

1819 
	}
}

1821 
u32
 
	$nvme_cmb_size
(
nvme_dev
 *
dev
)

1823  (
dev
->
cmbsz
 >> 
NVME_CMBSZ_SZ_SHIFT
Ë& 
NVME_CMBSZ_SZ_MASK
;

1824 
	}
}

1826 
	$nvme_m≠_cmb
(
nvme_dev
 *
dev
)

1828 
u64
 
size
, 
off£t
;

1829 
ªsour˚_size_t
 
b¨_size
;

1830 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

1831 
b¨
;

1833 i‡(
dev
->
cmb_size
)

1836 
dev
->
cmbsz
 = 
	`ªadl
(dev->
b¨
 + 
NVME_REG_CMBSZ
);

1837 i‡(!
dev
->
cmbsz
)

1839 
dev
->
cmbloc
 = 
	`ªadl
(dev->
b¨
 + 
NVME_REG_CMBLOC
);

1841 
size
 = 
	`nvme_cmb_size_unô
(
dev
Ë* 
	`nvme_cmb_size
(dev);

1842 
off£t
 = 
	`nvme_cmb_size_unô
(
dev
Ë* 
	`NVME_CMB_OFST
(dev->
cmbloc
);

1843 
b¨
 = 
	`NVME_CMB_BIR
(
dev
->
cmbloc
);

1844 
b¨_size
 = 
	`pci_ªsour˚_Àn
(
pdev
, 
b¨
);

1846 i‡(
off£t
 > 
b¨_size
)

1854 i‡(
size
 > 
b¨_size
 - 
off£t
)

1855 
size
 = 
b¨_size
 - 
off£t
;

1857 i‡(
	`pci_p2pdma_add_ªsour˚
(
pdev
, 
b¨
, 
size
, 
off£t
)) {

1858 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1863 
dev
->
cmb_size
 = 
size
;

1864 
dev
->
cmb_u£_sqes
 = 
u£_cmb_sqes
 && (dev->
cmbsz
 & 
NVME_CMBSZ_SQS
);

1866 i‡((
dev
->
cmbsz
 & (
NVME_CMBSZ_WDS
 | 
NVME_CMBSZ_RDS
)) ==

1867 (
NVME_CMBSZ_WDS
 | 
NVME_CMBSZ_RDS
))

1868 
	`pci_p2pmem_publish
(
pdev
, 
åue
);

1870 i‡(
	`sysfs_add_fûe_to_group
(&
dev
->
˘æ
.
devi˚
->
kobj
,

1871 &
dev_©å_cmb
.
©å
, 
NULL
))

1872 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1874 
	}
}

1876 
ölöe
 
	$nvme_ªÀa£_cmb
(
nvme_dev
 *
dev
)

1878 i‡(
dev
->
cmb_size
) {

1879 
	`sysfs_ªmove_fûe_‰om_group
(&
dev
->
˘æ
.
devi˚
->
kobj
,

1880 &
dev_©å_cmb
.
©å
, 
NULL
);

1881 
dev
->
cmb_size
 = 0;

1883 
	}
}

1885 
	$nvme_£t_ho°_mem
(
nvme_dev
 *
dev
, 
u32
 
bôs
)

1887 
u64
 
dma_addr
 = 
dev
->
ho°_mem_descs_dma
;

1888 
nvme_comm™d
 
c
;

1889 
ªt
;

1891 
	`mem£t
(&
c
, 0, (c));

1892 
c
.
„©uªs
.
›code
 = 
nvme_admö_£t_„©uªs
;

1893 
c
.
„©uªs
.
fid
 = 
	`˝u_to_À32
(
NVME_FEAT_HOST_MEM_BUF
);

1894 
c
.
„©uªs
.
dw‹d11
 = 
	`˝u_to_À32
(
bôs
);

1895 
c
.
„©uªs
.
dw‹d12
 = 
	`˝u_to_À32
(
dev
->
ho°_mem_size
 >>

1896 
	`ûog2
(
dev
->
˘æ
.
∑ge_size
));

1897 
c
.
„©uªs
.
dw‹d13
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
dma_addr
));

1898 
c
.
„©uªs
.
dw‹d14
 = 
	`˝u_to_À32
(
	`uµî_32_bôs
(
dma_addr
));

1899 
c
.
„©uªs
.
dw‹d15
 = 
	`˝u_to_À32
(
dev
->
ƒ_ho°_mem_descs
);

1901 
ªt
 = 
	`nvme_submô_sync_cmd
(
dev
->
˘æ
.
admö_q
, &
c
, 
NULL
, 0);

1902 i‡(
ªt
) {

1903 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

1905 
ªt
, 
bôs
);

1907  
ªt
;

1908 
	}
}

1910 
	$nvme_‰ì_ho°_mem
(
nvme_dev
 *
dev
)

1912 
i
;

1914 
i
 = 0; i < 
dev
->
ƒ_ho°_mem_descs
; i++) {

1915 
nvme_ho°_mem_buf_desc
 *
desc
 = &
dev
->
ho°_mem_descs
[
i
];

1916 
size_t
 
size
 = 
	`À32_to_˝u
(
desc
->sizeË* 
dev
->
˘æ
.
∑ge_size
;

1918 
	`dma_‰ì_©ås
(
dev
->dev, 
size
, dev->
ho°_mem_desc_bufs
[
i
],

1919 
	`À64_to_˝u
(
desc
->
addr
),

1920 
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
);

1923 
	`k‰ì
(
dev
->
ho°_mem_desc_bufs
);

1924 
dev
->
ho°_mem_desc_bufs
 = 
NULL
;

1925 
	`dma_‰ì_cohîít
(
dev
->dev,

1926 
dev
->
ƒ_ho°_mem_descs
 * (*dev->
ho°_mem_descs
),

1927 
dev
->
ho°_mem_descs
, dev->
ho°_mem_descs_dma
);

1928 
dev
->
ho°_mem_descs
 = 
NULL
;

1929 
dev
->
ƒ_ho°_mem_descs
 = 0;

1930 
	}
}

1932 
	$__nvme_Æloc_ho°_mem
(
nvme_dev
 *
dev
, 
u64
 
¥e„ºed
,

1933 
u32
 
chunk_size
)

1935 
nvme_ho°_mem_buf_desc
 *
descs
;

1936 
u32
 
max_íåõs
, 
Àn
;

1937 
dma_addr_t
 
descs_dma
;

1938 
i
 = 0;

1939 **
bufs
;

1940 
u64
 
size
, 
tmp
;

1942 
tmp
 = (
¥e„ºed
 + 
chunk_size
 - 1);

1943 
	`do_div
(
tmp
, 
chunk_size
);

1944 
max_íåõs
 = 
tmp
;

1946 i‡(
dev
->
˘æ
.
hmmaxd
 && dev->˘æ.hmmaxd < 
max_íåõs
)

1947 
max_íåõs
 = 
dev
->
˘æ
.
hmmaxd
;

1949 
descs
 = 
	`dma_Æloc_cohîít
(
dev
->dev, 
max_íåõs
 * (*descs),

1950 &
descs_dma
, 
GFP_KERNEL
);

1951 i‡(!
descs
)

1952 
out
;

1954 
bufs
 = 
	`kˇŒoc
(
max_íåõs
, (*bufs), 
GFP_KERNEL
);

1955 i‡(!
bufs
)

1956 
out_‰ì_descs
;

1958 
size
 = 0; sizê< 
¥e„ºed
 && 
i
 < 
max_íåõs
; sizê+
Àn
) {

1959 
dma_addr_t
 
dma_addr
;

1961 
Àn
 = 
	`mö_t
(
u64
, 
chunk_size
, 
¥e„ºed
 - 
size
);

1962 
bufs
[
i
] = 
	`dma_Æloc_©ås
(
dev
->dev, 
Àn
, &
dma_addr
, 
GFP_KERNEL
,

1963 
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
);

1964 i‡(!
bufs
[
i
])

1967 
descs
[
i
].
addr
 = 
	`˝u_to_À64
(
dma_addr
);

1968 
descs
[
i
].
size
 = 
	`˝u_to_À32
(
Àn
 / 
dev
->
˘æ
.
∑ge_size
);

1969 
i
++;

1972 i‡(!
size
)

1973 
out_‰ì_bufs
;

1975 
dev
->
ƒ_ho°_mem_descs
 = 
i
;

1976 
dev
->
ho°_mem_size
 = 
size
;

1977 
dev
->
ho°_mem_descs
 = 
descs
;

1978 
dev
->
ho°_mem_descs_dma
 = 
descs_dma
;

1979 
dev
->
ho°_mem_desc_bufs
 = 
bufs
;

1982 
out_‰ì_bufs
:

1983 --
i
 >= 0) {

1984 
size_t
 
size
 = 
	`À32_to_˝u
(
descs
[
i
].sizeË* 
dev
->
˘æ
.
∑ge_size
;

1986 
	`dma_‰ì_©ås
(
dev
->dev, 
size
, 
bufs
[
i
],

1987 
	`À64_to_˝u
(
descs
[
i
].
addr
),

1988 
DMA_ATTR_NO_KERNEL_MAPPING
 | 
DMA_ATTR_NO_WARN
);

1991 
	`k‰ì
(
bufs
);

1992 
out_‰ì_descs
:

1993 
	`dma_‰ì_cohîít
(
dev
->dev, 
max_íåõs
 * (*
descs
), descs,

1994 
descs_dma
);

1995 
out
:

1996 
dev
->
ho°_mem_descs
 = 
NULL
;

1997  -
ENOMEM
;

1998 
	}
}

2000 
	$nvme_Æloc_ho°_mem
(
nvme_dev
 *
dev
, 
u64
 
mö
, u64 
¥e„ºed
)

2002 
u32
 
chunk_size
;

2005 
chunk_size
 = 
	`mö_t
(
u64
, 
¥e„ºed
, 
PAGE_SIZE
 * 
MAX_ORDER_NR_PAGES
);

2006 
chunk_size
 >
	`max_t
(
u32
, 
dev
->
˘æ
.
hmmöds
 * 4096, 
PAGE_SIZE
 * 2);

2007 
chunk_size
 /= 2) {

2008 i‡(!
	`__nvme_Æloc_ho°_mem
(
dev
, 
¥e„ºed
, 
chunk_size
)) {

2009 i‡(!
mö
 || 
dev
->
ho°_mem_size
 >= min)

2011 
	`nvme_‰ì_ho°_mem
(
dev
);

2015  -
ENOMEM
;

2016 
	}
}

2018 
	$nvme_£tup_ho°_mem
(
nvme_dev
 *
dev
)

2020 
u64
 
max
 = (u64)
max_ho°_mem_size_mb
 * 
SZ_1M
;

2021 
u64
 
¥e„ºed
 = (u64)
dev
->
˘æ
.
hm¥e
 * 4096;

2022 
u64
 
mö
 = (u64)
dev
->
˘æ
.
hmmö
 * 4096;

2023 
u32
 
íabÀ_bôs
 = 
NVME_HOST_MEM_ENABLE
;

2024 
ªt
;

2026 
¥e„ºed
 = 
	`mö
’ª„ºed, 
max
);

2027 i‡(
mö
 > 
max
) {

2028 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2030 
mö
 >> 
	`ûog2
(
SZ_1M
), 
max_ho°_mem_size_mb
);

2031 
	`nvme_‰ì_ho°_mem
(
dev
);

2038 i‡(
dev
->
ho°_mem_descs
) {

2039 i‡(
dev
->
ho°_mem_size
 >
mö
)

2040 
íabÀ_bôs
 |
NVME_HOST_MEM_RETURN
;

2042 
	`nvme_‰ì_ho°_mem
(
dev
);

2045 i‡(!
dev
->
ho°_mem_descs
) {

2046 i‡(
	`nvme_Æloc_ho°_mem
(
dev
, 
mö
, 
¥e„ºed
)) {

2047 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2052 
	`dev_öfo
(
dev
->
˘æ
.
devi˚
,

2054 
dev
->
ho°_mem_size
 >> 
	`ûog2
(
SZ_1M
));

2057 
ªt
 = 
	`nvme_£t_ho°_mem
(
dev
, 
íabÀ_bôs
);

2058 i‡(
ªt
)

2059 
	`nvme_‰ì_ho°_mem
(
dev
);

2060  
ªt
;

2061 
	}
}

2067 
	$nvme_ˇlc_úq_£ts
(
úq_afföôy
 *
affd
, 
ƒúqs
)

2069 
nvme_dev
 *
dev
 = 
affd
->
¥iv
;

2070 
ƒ_ªad_queues
;

2083 i‡(!
ƒúqs
) {

2084 
ƒúqs
 = 1;

2085 
ƒ_ªad_queues
 = 0;

2086 } i‡(
ƒúqs
 =1 || !
wrôe_queues
) {

2087 
ƒ_ªad_queues
 = 0;

2088 } i‡(
wrôe_queues
 >
ƒúqs
) {

2089 
ƒ_ªad_queues
 = 1;

2091 
ƒ_ªad_queues
 = 
ƒúqs
 - 
wrôe_queues
;

2094 
dev
->
io_queues
[
HCTX_TYPE_DEFAULT
] = 
ƒúqs
 - 
ƒ_ªad_queues
;

2095 
affd
->
£t_size
[
HCTX_TYPE_DEFAULT
] = 
ƒúqs
 - 
ƒ_ªad_queues
;

2096 
dev
->
io_queues
[
HCTX_TYPE_READ
] = 
ƒ_ªad_queues
;

2097 
affd
->
£t_size
[
HCTX_TYPE_READ
] = 
ƒ_ªad_queues
;

2098 
affd
->
ƒ_£ts
 = 
ƒ_ªad_queues
 ? 2 : 1;

2099 
	}
}

2101 
	$nvme_£tup_úqs
(
nvme_dev
 *
dev
, 
ƒ_io_queues
)

2103 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2104 
úq_afföôy
 
affd
 = {

2105 .
¥e_ve˘‹s
 = 1,

2106 .
ˇlc_£ts
 = 
nvme_ˇlc_úq_£ts
,

2107 .
¥iv
 = 
dev
,

2109 
úq_queues
, 
this_p_queues
;

2115 
this_p_queues
 = 
pﬁl_queues
;

2116 i‡(
this_p_queues
 >
ƒ_io_queues
) {

2117 
this_p_queues
 = 
ƒ_io_queues
 - 1;

2118 
úq_queues
 = 1;

2120 
úq_queues
 = 
ƒ_io_queues
 - 
this_p_queues
 + 1;

2122 
dev
->
io_queues
[
HCTX_TYPE_POLL
] = 
this_p_queues
;

2125 
dev
->
io_queues
[
HCTX_TYPE_DEFAULT
] = 1;

2126 
dev
->
io_queues
[
HCTX_TYPE_READ
] = 0;

2128  
	`pci_Æloc_úq_ve˘‹s_afföôy
(
pdev
, 1, 
úq_queues
,

2129 
PCI_IRQ_ALL_TYPES
 | 
PCI_IRQ_AFFINITY
, &
affd
);

2130 
	}
}

2132 
	$nvme_dißbÀ_io_queues
(
nvme_dev
 *
dev
)

2134 i‡(
	`__nvme_dißbÀ_io_queues
(
dev
, 
nvme_admö_dñëe_sq
))

2135 
	`__nvme_dißbÀ_io_queues
(
dev
, 
nvme_admö_dñëe_cq
);

2136 
	}
}

2138 
	$nvme_£tup_io_queues
(
nvme_dev
 *
dev
)

2140 
nvme_queue
 *
admöq
 = &
dev
->
queues
[0];

2141 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2142 
ªsu…
, 
ƒ_io_queues
;

2143 
size
;

2145 
ƒ_io_queues
 = 
	`max_io_queues
();

2146 
ªsu…
 = 
	`nvme_£t_queue_cou¡
(&
dev
->
˘æ
, &
ƒ_io_queues
);

2147 i‡(
ªsu…
 < 0)

2148  
ªsu…
;

2150 i‡(
ƒ_io_queues
 == 0)

2153 
	`˛ór_bô
(
NVMEQ_ENABLED
, &
admöq
->
Êags
);

2155 i‡(
dev
->
cmb_u£_sqes
) {

2156 
ªsu…
 = 
	`nvme_cmb_qdïth
(
dev
, 
ƒ_io_queues
,

2157 (
nvme_comm™d
));

2158 i‡(
ªsu…
 > 0)

2159 
dev
->
q_dïth
 = 
ªsu…
;

2161 
dev
->
cmb_u£_sqes
 = 
Ál£
;

2165 
size
 = 
	`db_b¨_size
(
dev
, 
ƒ_io_queues
);

2166 
ªsu…
 = 
	`nvme_ªm≠_b¨
(
dev
, 
size
);

2167 i‡(!
ªsu…
)

2169 i‡(!--
ƒ_io_queues
)

2170  -
ENOMEM
;

2172 
admöq
->
q_db
 = 
dev
->
dbs
;

2174 
ªåy
:

2176 
	`pci_‰ì_úq
(
pdev
, 0, 
admöq
);

2182 
	`pci_‰ì_úq_ve˘‹s
(
pdev
);

2184 
ªsu…
 = 
	`nvme_£tup_úqs
(
dev
, 
ƒ_io_queues
);

2185 i‡(
ªsu…
 <= 0)

2186  -
EIO
;

2188 
dev
->
num_vecs
 = 
ªsu…
;

2189 
ªsu…
 = 
	`max
(result - 1, 1);

2190 
dev
->
max_qid
 = 
ªsu…
 + dev->
io_queues
[
HCTX_TYPE_POLL
];

2198 
ªsu…
 = 
	`queue_ªque°_úq
(
admöq
);

2199 i‡(
ªsu…
) {

2200 
admöq
->
cq_ve˘‹
 = -1;

2201  
ªsu…
;

2203 
	`£t_bô
(
NVMEQ_ENABLED
, &
admöq
->
Êags
);

2205 
ªsu…
 = 
	`nvme_¸óã_io_queues
(
dev
);

2206 i‡(
ªsu…
 || 
dev
->
⁄löe_queues
 < 2)

2207  
ªsu…
;

2209 i‡(
dev
->
⁄löe_queues
 - 1 < dev->
max_qid
) {

2210 
ƒ_io_queues
 = 
dev
->
⁄löe_queues
 - 1;

2211 
	`nvme_dißbÀ_io_queues
(
dev
);

2212 
	`nvme_su•íd_io_queues
(
dev
);

2213 
ªåy
;

2215 
	`dev_öfo
(
dev
->
˘æ
.
devi˚
, "%d/%d/%d default/read/poll queues\n",

2216 
dev
->
io_queues
[
HCTX_TYPE_DEFAULT
],

2217 
dev
->
io_queues
[
HCTX_TYPE_READ
],

2218 
dev
->
io_queues
[
HCTX_TYPE_POLL
]);

2220 
	}
}

2222 
	$nvme_dñ_queue_íd
(
ªque°
 *
ªq
, 
blk_°©us_t
 
îr‹
)

2224 
nvme_queue
 *
nvmeq
 = 
ªq
->
íd_io_d©a
;

2226 
	`blk_mq_‰ì_ªque°
(
ªq
);

2227 
	`com∂ëe
(&
nvmeq
->
dñëe_d⁄e
);

2228 
	}
}

2230 
	$nvme_dñ_cq_íd
(
ªque°
 *
ªq
, 
blk_°©us_t
 
îr‹
)

2232 
nvme_queue
 *
nvmeq
 = 
ªq
->
íd_io_d©a
;

2234 i‡(
îr‹
)

2235 
	`£t_bô
(
NVMEQ_DELETE_ERROR
, &
nvmeq
->
Êags
);

2237 
	`nvme_dñ_queue_íd
(
ªq
, 
îr‹
);

2238 
	}
}

2240 
	$nvme_dñëe_queue
(
nvme_queue
 *
nvmeq
, 
u8
 
›code
)

2242 
ªque°_queue
 *
q
 = 
nvmeq
->
dev
->
˘æ
.
admö_q
;

2243 
ªque°
 *
ªq
;

2244 
nvme_comm™d
 
cmd
;

2246 
	`mem£t
(&
cmd
, 0, (cmd));

2247 
cmd
.
dñëe_queue
.
›code
 = opcode;

2248 
cmd
.
dñëe_queue
.
qid
 = 
	`˝u_to_À16
(
nvmeq
->qid);

2250 
ªq
 = 
	`nvme_Æloc_ªque°
(
q
, &
cmd
, 
BLK_MQ_REQ_NOWAIT
, 
NVME_QID_ANY
);

2251 i‡(
	`IS_ERR
(
ªq
))

2252  
	`PTR_ERR
(
ªq
);

2254 
ªq
->
timeout
 = 
ADMIN_TIMEOUT
;

2255 
ªq
->
íd_io_d©a
 = 
nvmeq
;

2257 
	`öô_com∂ëi⁄
(&
nvmeq
->
dñëe_d⁄e
);

2258 
	`blk_execuã_rq_nowaô
(
q
, 
NULL
, 
ªq
, 
Ál£
,

2259 
›code
 =
nvme_admö_dñëe_cq
 ?

2260 
nvme_dñ_cq_íd
 : 
nvme_dñ_queue_íd
);

2262 
	}
}

2264 
boﬁ
 
	$__nvme_dißbÀ_io_queues
(
nvme_dev
 *
dev
, 
u8
 
›code
)

2266 
ƒ_queues
 = 
dev
->
⁄löe_queues
 - 1, 
£¡
 = 0;

2267 
timeout
;

2269 
ªåy
:

2270 
timeout
 = 
ADMIN_TIMEOUT
;

2271 
ƒ_queues
 > 0) {

2272 i‡(
	`nvme_dñëe_queue
(&
dev
->
queues
[
ƒ_queues
], 
›code
))

2274 
ƒ_queues
--;

2275 
£¡
++;

2277 
£¡
) {

2278 
nvme_queue
 *
nvmeq
 = &
dev
->
queues
[
ƒ_queues
 + 
£¡
];

2280 
timeout
 = 
	`waô_f‹_com∂ëi⁄_io_timeout
(&
nvmeq
->
dñëe_d⁄e
,

2281 
timeout
);

2282 i‡(
timeout
 == 0)

2283  
Ál£
;

2286 i‡(
›code
 =
nvme_admö_dñëe_cq
 &&

2287 !
	`ã°_bô
(
NVMEQ_DELETE_ERROR
, &
nvmeq
->
Êags
))

2288 
	`nvme_pﬁl_úqdißbÀ
(
nvmeq
, -1);

2290 
£¡
--;

2291 i‡(
ƒ_queues
)

2292 
ªåy
;

2294  
åue
;

2295 
	}
}

2300 
	$nvme_dev_add
(
nvme_dev
 *
dev
)

2302 
ªt
;

2304 i‡(!
dev
->
˘æ
.
èg£t
) {

2305 
dev
->
èg£t
.
›s
 = &
nvme_mq_›s
;

2306 
dev
->
èg£t
.
ƒ_hw_queues
 = dev->
⁄löe_queues
 - 1;

2307 
dev
->
èg£t
.
ƒ_m≠s
 = 2;

2308 i‡(
dev
->
io_queues
[
HCTX_TYPE_POLL
])

2309 
dev
->
èg£t
.
ƒ_m≠s
++;

2310 
dev
->
èg£t
.
timeout
 = 
NVME_IO_TIMEOUT
;

2311 
dev
->
èg£t
.
numa_node
 = 
	`dev_to_node
(dev->dev);

2312 
dev
->
èg£t
.
queue_dïth
 =

2313 
	`mö_t
(, 
dev
->
q_dïth
, 
BLK_MQ_MAX_DEPTH
) - 1;

2314 
dev
->
èg£t
.
cmd_size
 = 
	`nvme_pci_cmd_size
(dev, 
Ál£
);

2315 i‡((
dev
->
˘æ
.
sgls
 & ((1 << 0Ë| (1 << 1))Ë&& 
sgl_thªshﬁd
) {

2316 
dev
->
èg£t
.
cmd_size
 = 
	`max
(dev->tagset.cmd_size,

2317 
	`nvme_pci_cmd_size
(
dev
, 
åue
));

2319 
dev
->
èg£t
.
Êags
 = 
BLK_MQ_F_SHOULD_MERGE
;

2320 
dev
->
èg£t
.
drivî_d©a
 = dev;

2322 
ªt
 = 
	`blk_mq_Æloc_èg_£t
(&
dev
->
èg£t
);

2323 i‡(
ªt
) {

2324 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2325 "IO queue†èg£àÆloˇti⁄ faûed %d\n", 
ªt
);

2326  
ªt
;

2328 
dev
->
˘æ
.
èg£t
 = &dev->tagset;

2330 
	`nvme_dbbuf_£t
(
dev
);

2332 
	`blk_mq_upd©e_ƒ_hw_queues
(&
dev
->
èg£t
, dev->
⁄löe_queues
 - 1);

2335 
	`nvme_‰ì_queues
(
dev
, dev->
⁄löe_queues
);

2339 
	}
}

2341 
	$nvme_pci_íabÀ
(
nvme_dev
 *
dev
)

2343 
ªsu…
 = -
ENOMEM
;

2344 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2346 i‡(
	`pci_íabÀ_devi˚_mem
(
pdev
))

2347  
ªsu…
;

2349 
	`pci_£t_ma°î
(
pdev
);

2351 i‡(
	`dma_£t_mask_™d_cohîít
(
dev
->dev, 
	`DMA_BIT_MASK
(64)) &&

2352 
	`dma_£t_mask_™d_cohîít
(
dev
->dev, 
	`DMA_BIT_MASK
(32)))

2353 
dißbÀ
;

2355 i‡(
	`ªadl
(
dev
->
b¨
 + 
NVME_REG_CSTS
) == -1) {

2356 
ªsu…
 = -
ENODEV
;

2357 
dißbÀ
;

2365 
ªsu…
 = 
	`pci_Æloc_úq_ve˘‹s
(
pdev
, 1, 1, 
PCI_IRQ_ALL_TYPES
);

2366 i‡(
ªsu…
 < 0)

2367  
ªsu…
;

2369 
dev
->
˘æ
.
ˇp
 = 
	`lo_hi_ªadq
(dev->
b¨
 + 
NVME_REG_CAP
);

2371 
dev
->
q_dïth
 = 
	`mö_t
(, 
	`NVME_CAP_MQES
(dev->
˘æ
.
ˇp
) + 1,

2372 
io_queue_dïth
);

2373 
dev
->
db_°ride
 = 1 << 
	`NVME_CAP_STRIDE
(dev->
˘æ
.
ˇp
);

2374 
dev
->
dbs
 = dev->
b¨
 + 4096;

2380 i‡(
pdev
->
víd‹
 =
PCI_VENDOR_ID_APPLE
 &&Ödev->
devi˚
 == 0x2001) {

2381 
dev
->
q_dïth
 = 2;

2382 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
, "detected Apple NVMe controller, "

2384 
dev
->
q_dïth
);

2385 } i‡(
pdev
->
víd‹
 =
PCI_VENDOR_ID_SAMSUNG
 &&

2386 (
pdev
->
devi˚
 == 0xa821 ||Ödev->device == 0xa822) &&

2387 
	`NVME_CAP_MQES
(
dev
->
˘æ
.
ˇp
) == 0) {

2388 
dev
->
q_dïth
 = 64;

2389 
	`dev_îr
(
dev
->
˘æ
.
devi˚
, "detected PM1725 NVMe controller, "

2390 "£àqueuêdïth=%u\n", 
dev
->
q_dïth
);

2393 
	`nvme_m≠_cmb
(
dev
);

2395 
	`pci_íabÀ_pcõ_îr‹_ªp‹tög
(
pdev
);

2396 
	`pci_ßve_°©e
(
pdev
);

2399 
dißbÀ
:

2400 
	`pci_dißbÀ_devi˚
(
pdev
);

2401  
ªsu…
;

2402 
	}
}

2404 
	$nvme_dev_unm≠
(
nvme_dev
 *
dev
)

2406 i‡(
dev
->
b¨
)

2407 
	`iounm≠
(
dev
->
b¨
);

2408 
	`pci_ªÀa£_mem_ªgi⁄s
(
	`to_pci_dev
(
dev
->dev));

2409 
	}
}

2411 
	$nvme_pci_dißbÀ
(
nvme_dev
 *
dev
)

2413 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2415 
	`pci_‰ì_úq_ve˘‹s
(
pdev
);

2417 i‡(
	`pci_is_íabÀd
(
pdev
)) {

2418 
	`pci_dißbÀ_pcõ_îr‹_ªp‹tög
(
pdev
);

2419 
	`pci_dißbÀ_devi˚
(
pdev
);

2421 
	}
}

2423 
	$nvme_dev_dißbÀ
(
nvme_dev
 *
dev
, 
boﬁ
 
shutdown
)

2425 
boﬁ
 
dód
 = 
åue
, 
‰ìze
 = 
Ál£
;

2426 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2428 
	`muãx_lock
(&
dev
->
shutdown_lock
);

2429 i‡(
	`pci_is_íabÀd
(
pdev
)) {

2430 
u32
 
c°s
 = 
	`ªadl
(
dev
->
b¨
 + 
NVME_REG_CSTS
);

2432 i‡(
dev
->
˘æ
.
°©e
 =
NVME_CTRL_LIVE
 ||

2433 
dev
->
˘æ
.
°©e
 =
NVME_CTRL_RESETTING
) {

2434 
‰ìze
 = 
åue
;

2435 
	`nvme_°¨t_‰ìze
(&
dev
->
˘æ
);

2437 
dód
 = !!((
c°s
 & 
NVME_CSTS_CFS
Ë|| !(c°†& 
NVME_CSTS_RDY
) ||

2438 
pdev
->
îr‹_°©e
 !
pci_ch™√l_io_n‹mÆ
);

2445 i‡(!
dód
 && 
shutdown
 && 
‰ìze
)

2446 
	`nvme_waô_‰ìze_timeout
(&
dev
->
˘æ
, 
NVME_IO_TIMEOUT
);

2448 
	`nvme_°›_queues
(&
dev
->
˘æ
);

2450 i‡(!
dód
 && 
dev
->
˘æ
.
queue_cou¡
 > 0) {

2451 
	`nvme_dißbÀ_io_queues
(
dev
);

2452 
	`nvme_dißbÀ_admö_queue
(
dev
, 
shutdown
);

2454 
	`nvme_su•íd_io_queues
(
dev
);

2455 
	`nvme_su•íd_queue
(&
dev
->
queues
[0]);

2456 
	`nvme_pci_dißbÀ
(
dev
);

2458 
	`blk_mq_èg£t_busy_ôî
(&
dev
->
èg£t
, 
nvme_ˇn˚l_ªque°
, &dev->
˘æ
);

2459 
	`blk_mq_èg£t_busy_ôî
(&
dev
->
admö_èg£t
, 
nvme_ˇn˚l_ªque°
, &dev->
˘æ
);

2466 i‡(
shutdown
) {

2467 
	`nvme_°¨t_queues
(&
dev
->
˘æ
);

2468 i‡(
dev
->
˘æ
.
admö_q
 && !
	`blk_queue_dyög
(dev->ctrl.admin_q))

2469 
	`blk_mq_unquõs˚_queue
(
dev
->
˘æ
.
admö_q
);

2471 
	`muãx_u∆ock
(&
dev
->
shutdown_lock
);

2472 
	}
}

2474 
	$nvme_£tup_¥p_poﬁs
(
nvme_dev
 *
dev
)

2476 
dev
->
¥p_∑ge_poﬁ
 = 
	`dma_poﬁ_¸óã
("prpÜistÖage", dev->dev,

2477 
PAGE_SIZE
, PAGE_SIZE, 0);

2478 i‡(!
dev
->
¥p_∑ge_poﬁ
)

2479  -
ENOMEM
;

2482 
dev
->
¥p_smÆl_poﬁ
 = 
	`dma_poﬁ_¸óã
("prpÜist 256", dev->dev,

2484 i‡(!
dev
->
¥p_smÆl_poﬁ
) {

2485 
	`dma_poﬁ_de°roy
(
dev
->
¥p_∑ge_poﬁ
);

2486  -
ENOMEM
;

2489 
	}
}

2491 
	$nvme_ªÀa£_¥p_poﬁs
(
nvme_dev
 *
dev
)

2493 
	`dma_poﬁ_de°roy
(
dev
->
¥p_∑ge_poﬁ
);

2494 
	`dma_poﬁ_de°roy
(
dev
->
¥p_smÆl_poﬁ
);

2495 
	}
}

2497 
	$nvme_pci_‰ì_˘æ
(
nvme_˘æ
 *
˘æ
)

2499 
nvme_dev
 *
dev
 = 
	`to_nvme_dev
(
˘æ
);

2501 
	`nvme_dbbuf_dma_‰ì
(
dev
);

2502 
	`put_devi˚
(
dev
->dev);

2503 i‡(
dev
->
èg£t
.
ègs
)

2504 
	`blk_mq_‰ì_èg_£t
(&
dev
->
èg£t
);

2505 i‡(
dev
->
˘æ
.
admö_q
)

2506 
	`blk_put_queue
(
dev
->
˘æ
.
admö_q
);

2507 
	`k‰ì
(
dev
->
queues
);

2508 
	`‰ì_›Æ_dev
(
dev
->
˘æ
.
›Æ_dev
);

2509 
	`mempoﬁ_de°roy
(
dev
->
iod_mempoﬁ
);

2510 
	`k‰ì
(
dev
);

2511 
	}
}

2513 
	$nvme_ªmove_dód_˘æ
(
nvme_dev
 *
dev
, 
°©us
)

2515 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
, "Removögá·îÖrobêÁûuª sètus: %d\n", 
°©us
);

2517 
	`nvme_gë_˘æ
(&
dev
->
˘æ
);

2518 
	`nvme_dev_dißbÀ
(
dev
, 
Ál£
);

2519 
	`nvme_kûl_queues
(&
dev
->
˘æ
);

2520 i‡(!
	`queue_w‹k
(
nvme_wq
, &
dev
->
ªmove_w‹k
))

2521 
	`nvme_put_˘æ
(&
dev
->
˘æ
);

2522 
	}
}

2524 
	$nvme_ª£t_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2526 
nvme_dev
 *
dev
 =

2527 
	`c⁄èöî_of
(
w‹k
, 
nvme_dev
, 
˘æ
.
ª£t_w‹k
);

2528 
boﬁ
 
was_su•íd
 = !!(
dev
->
˘æ
.
˘æ_c⁄fig
 & 
NVME_CC_SHN_NORMAL
);

2529 
ªsu…
 = -
ENODEV
;

2530 
nvme_˘æ_°©e
 
√w_°©e
 = 
NVME_CTRL_LIVE
;

2532 i‡(
	`WARN_ON
(
dev
->
˘æ
.
°©e
 !
NVME_CTRL_RESETTING
))

2533 
out
;

2539 i‡(
dev
->
˘æ
.
˘æ_c⁄fig
 & 
NVME_CC_ENABLE
)

2540 
	`nvme_dev_dißbÀ
(
dev
, 
Ál£
);

2542 
	`muãx_lock
(&
dev
->
shutdown_lock
);

2543 
ªsu…
 = 
	`nvme_pci_íabÀ
(
dev
);

2544 i‡(
ªsu…
)

2545 
out_u∆ock
;

2547 
ªsu…
 = 
	`nvme_pci_c⁄figuª_admö_queue
(
dev
);

2548 i‡(
ªsu…
)

2549 
out_u∆ock
;

2551 
ªsu…
 = 
	`nvme_Æloc_admö_ègs
(
dev
);

2552 i‡(
ªsu…
)

2553 
out_u∆ock
;

2559 
dev
->
˘æ
.
max_hw_£˘‹s
 = 
NVME_MAX_KB_SZ
 << 1;

2560 
dev
->
˘æ
.
max_£gmíts
 = 
NVME_MAX_SEGS
;

2561 
	`muãx_u∆ock
(&
dev
->
shutdown_lock
);

2567 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
dev
->
˘æ
, 
NVME_CTRL_CONNECTING
)) {

2568 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2570 
out
;

2573 
ªsu…
 = 
	`nvme_öô_idítify
(&
dev
->
˘æ
);

2574 i‡(
ªsu…
)

2575 
out
;

2577 i‡(
dev
->
˘æ
.
ﬂcs
 & 
NVME_CTRL_OACS_SEC_SUPP
) {

2578 i‡(!
dev
->
˘æ
.
›Æ_dev
)

2579 
dev
->
˘æ
.
›Æ_dev
 =

2580 
	`öô_›Æ_dev
(&
dev
->
˘æ
, &
nvme_£c_submô
);

2581 i‡(
was_su•íd
)

2582 
	`›Æ_u∆ock_‰om_su•íd
(
dev
->
˘æ
.
›Æ_dev
);

2584 
	`‰ì_›Æ_dev
(
dev
->
˘æ
.
›Æ_dev
);

2585 
dev
->
˘æ
.
›Æ_dev
 = 
NULL
;

2588 i‡(
dev
->
˘æ
.
ﬂcs
 & 
NVME_CTRL_OACS_DBBUF_SUPP
) {

2589 
ªsu…
 = 
	`nvme_dbbuf_dma_Æloc
(
dev
);

2590 i‡(
ªsu…
)

2591 
	`dev_w¨n
(
dev
->dev,

2595 i‡(
dev
->
˘æ
.
hm¥e
) {

2596 
ªsu…
 = 
	`nvme_£tup_ho°_mem
(
dev
);

2597 i‡(
ªsu…
 < 0)

2598 
out
;

2601 
ªsu…
 = 
	`nvme_£tup_io_queues
(
dev
);

2602 i‡(
ªsu…
)

2603 
out
;

2609 i‡(
dev
->
⁄löe_queues
 < 2) {

2610 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
, "IO queuesÇot created\n");

2611 
	`nvme_kûl_queues
(&
dev
->
˘æ
);

2612 
	`nvme_ªmove_«me•a˚s
(&
dev
->
˘æ
);

2613 
√w_°©e
 = 
NVME_CTRL_ADMIN_ONLY
;

2615 
	`nvme_°¨t_queues
(&
dev
->
˘æ
);

2616 
	`nvme_waô_‰ìze
(&
dev
->
˘æ
);

2618 i‡(
	`nvme_dev_add
(
dev
))

2619 
√w_°©e
 = 
NVME_CTRL_ADMIN_ONLY
;

2620 
	`nvme_un‰ìze
(&
dev
->
˘æ
);

2627 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
dev
->
˘æ
, 
√w_°©e
)) {

2628 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2629 "ÁûedÅÿm¨k c⁄åﬁÀ∏°©ê%d\n", 
√w_°©e
);

2630 
out
;

2633 
	`nvme_°¨t_˘æ
(&
dev
->
˘æ
);

2636 
out_u∆ock
:

2637 
	`muãx_u∆ock
(&
dev
->
shutdown_lock
);

2638 
out
:

2639 
	`nvme_ªmove_dód_˘æ
(
dev
, 
ªsu…
);

2640 
	}
}

2642 
	$nvme_ªmove_dód_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2644 
nvme_dev
 *
dev
 = 
	`c⁄èöî_of
(
w‹k
, nvme_dev, 
ªmove_w‹k
);

2645 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2647 i‡(
	`pci_gë_drvd©a
(
pdev
))

2648 
	`devi˚_ªÀa£_drivî
(&
pdev
->
dev
);

2649 
	`nvme_put_˘æ
(&
dev
->
˘æ
);

2650 
	}
}

2652 
	$nvme_pci_ªg_ªad32
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, u32 *
vÆ
)

2654 *
vÆ
 = 
	`ªadl
(
	`to_nvme_dev
(
˘æ
)->
b¨
 + 
off
);

2656 
	}
}

2658 
	$nvme_pci_ªg_wrôe32
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, u32 
vÆ
)

2660 
	`wrôñ
(
vÆ
, 
	`to_nvme_dev
(
˘æ
)->
b¨
 + 
off
);

2662 
	}
}

2664 
	$nvme_pci_ªg_ªad64
(
nvme_˘æ
 *
˘æ
, 
u32
 
off
, 
u64
 *
vÆ
)

2666 *
vÆ
 = 
	`ªadq
(
	`to_nvme_dev
(
˘æ
)->
b¨
 + 
off
);

2668 
	}
}

2670 
	$nvme_pci_gë_addªss
(
nvme_˘æ
 *
˘æ
, *
buf
, 
size
)

2672 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
	`to_nvme_dev
(
˘æ
)->
dev
);

2674  
	`¢¥ötf
(
buf
, 
size
, "%s", 
	`dev_«me
(&
pdev
->
dev
));

2675 
	}
}

2677 c⁄° 
nvme_˘æ_›s
 
	gnvme_pci_˘æ_›s
 = {

2678 .
«me
 = "pcie",

2679 .
	gmoduÀ
 = 
THIS_MODULE
,

2680 .
	gÊags
 = 
NVME_F_METADATA_SUPPORTED
 |

2681 
NVME_F_PCI_P2PDMA
,

2682 .
	gªg_ªad32
 = 
nvme_pci_ªg_ªad32
,

2683 .
	gªg_wrôe32
 = 
nvme_pci_ªg_wrôe32
,

2684 .
	gªg_ªad64
 = 
nvme_pci_ªg_ªad64
,

2685 .
	g‰ì_˘æ
 = 
nvme_pci_‰ì_˘æ
,

2686 .
	gsubmô_async_evít
 = 
nvme_pci_submô_async_evít
,

2687 .
	ggë_addªss
 = 
nvme_pci_gë_addªss
,

2690 
	$nvme_dev_m≠
(
nvme_dev
 *
dev
)

2692 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
->dev);

2694 i‡(
	`pci_ªque°_mem_ªgi⁄s
(
pdev
, "nvme"))

2695  -
ENODEV
;

2697 i‡(
	`nvme_ªm≠_b¨
(
dev
, 
NVME_REG_DBS
 + 4096))

2698 
ªÀa£
;

2701 
ªÀa£
:

2702 
	`pci_ªÀa£_mem_ªgi⁄s
(
pdev
);

2703  -
ENODEV
;

2704 
	}
}

2706 
	$check_víd‹_combö©i⁄_bug
(
pci_dev
 *
pdev
)

2708 i‡(
pdev
->
víd‹
 =0x144d &&Ödev->
devi˚
 == 0xa802) {

2717 i‡(
	`dmi_m©ch
(
DMI_SYS_VENDOR
, "Dell Inc.") &&

2718 (
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "XPS 15 9550") ||

2719 
	`dmi_m©ch
(
DMI_PRODUCT_NAME
, "Precision 5510")))

2720  
NVME_QUIRK_NO_DEEPEST_PS
;

2721 } i‡(
pdev
->
víd‹
 =0x144d &&Ödev->
devi˚
 == 0xa804) {

2728 i‡(
	`dmi_m©ch
(
DMI_BOARD_VENDOR
, "ASUSTeK COMPUTER INC.") &&

2729 (
	`dmi_m©ch
(
DMI_BOARD_NAME
, "PRIME B350M-A") ||

2730 
	`dmi_m©ch
(
DMI_BOARD_NAME
, "PRIME Z370-A")))

2731  
NVME_QUIRK_NO_APST
;

2735 
	}
}

2737 
	$nvme_async_¥obe
(*
d©a
, 
async_cookõ_t
 
cookõ
)

2739 
nvme_dev
 *
dev
 = 
d©a
;

2741 
	`nvme_ª£t_˘æ_sync
(&
dev
->
˘æ
);

2742 
	`Êush_w‹k
(&
dev
->
˘æ
.
sˇn_w‹k
);

2743 
	`nvme_put_˘æ
(&
dev
->
˘æ
);

2744 
	}
}

2746 
	$nvme_¥obe
(
pci_dev
 *
pdev
, c⁄° 
pci_devi˚_id
 *
id
)

2748 
node
, 
ªsu…
 = -
ENOMEM
;

2749 
nvme_dev
 *
dev
;

2750 
quúks
 = 
id
->
drivî_d©a
;

2751 
size_t
 
Æloc_size
;

2753 
node
 = 
	`dev_to_node
(&
pdev
->
dev
);

2754 i‡(
node
 =
NUMA_NO_NODE
)

2755 
	`£t_dev_node
(&
pdev
->
dev
, 
fú°_mem‹y_node
);

2757 
dev
 = 
	`kzÆloc_node
((*dev), 
GFP_KERNEL
, 
node
);

2758 i‡(!
dev
)

2759  -
ENOMEM
;

2761 
dev
->
queues
 = 
	`kˇŒoc_node
(
	`max_queue_cou¡
(), (
nvme_queue
),

2762 
GFP_KERNEL
, 
node
);

2763 i‡(!
dev
->
queues
)

2764 
‰ì
;

2766 
dev
->dev = 
	`gë_devi˚
(&
pdev
->dev);

2767 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2769 
ªsu…
 = 
	`nvme_dev_m≠
(
dev
);

2770 i‡(
ªsu…
)

2771 
put_pci
;

2773 
	`INIT_WORK
(&
dev
->
˘æ
.
ª£t_w‹k
, 
nvme_ª£t_w‹k
);

2774 
	`INIT_WORK
(&
dev
->
ªmove_w‹k
, 
nvme_ªmove_dód_˘æ_w‹k
);

2775 
	`muãx_öô
(&
dev
->
shutdown_lock
);

2777 
ªsu…
 = 
	`nvme_£tup_¥p_poﬁs
(
dev
);

2778 i‡(
ªsu…
)

2779 
unm≠
;

2781 
quúks
 |
	`check_víd‹_combö©i⁄_bug
(
pdev
);

2787 
Æloc_size
 = 
	`nvme_pci_iod_Æloc_size
(
dev
, 
NVME_MAX_KB_SZ
,

2788 
NVME_MAX_SEGS
, 
åue
);

2789 
	`WARN_ON_ONCE
(
Æloc_size
 > 
PAGE_SIZE
);

2791 
dev
->
iod_mempoﬁ
 = 
	`mempoﬁ_¸óã_node
(1, 
mempoﬁ_kmÆloc
,

2792 
mempoﬁ_k‰ì
,

2793 (*Ë
Æloc_size
,

2794 
GFP_KERNEL
, 
node
);

2795 i‡(!
dev
->
iod_mempoﬁ
) {

2796 
ªsu…
 = -
ENOMEM
;

2797 
ªÀa£_poﬁs
;

2800 
ªsu…
 = 
	`nvme_öô_˘æ
(&
dev
->
˘æ
, &
pdev
->dev, &
nvme_pci_˘æ_›s
,

2801 
quúks
);

2802 i‡(
ªsu…
)

2803 
ªÀa£_mempoﬁ
;

2805 
	`dev_öfo
(
dev
->
˘æ
.
devi˚
, "pcòfun˘i⁄ %s\n", 
	`dev_«me
(&
pdev
->dev));

2807 
	`nvme_gë_˘æ
(&
dev
->
˘æ
);

2808 
	`async_scheduÀ
(
nvme_async_¥obe
, 
dev
);

2812 
ªÀa£_mempoﬁ
:

2813 
	`mempoﬁ_de°roy
(
dev
->
iod_mempoﬁ
);

2814 
ªÀa£_poﬁs
:

2815 
	`nvme_ªÀa£_¥p_poﬁs
(
dev
);

2816 
unm≠
:

2817 
	`nvme_dev_unm≠
(
dev
);

2818 
put_pci
:

2819 
	`put_devi˚
(
dev
->dev);

2820 
‰ì
:

2821 
	`k‰ì
(
dev
->
queues
);

2822 
	`k‰ì
(
dev
);

2823  
ªsu…
;

2824 
	}
}

2826 
	$nvme_ª£t_¥ï¨e
(
pci_dev
 *
pdev
)

2828 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2829 
	`nvme_dev_dißbÀ
(
dev
, 
Ál£
);

2830 
	}
}

2832 
	$nvme_ª£t_d⁄e
(
pci_dev
 *
pdev
)

2834 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2835 
	`nvme_ª£t_˘æ_sync
(&
dev
->
˘æ
);

2836 
	}
}

2838 
	$nvme_shutdown
(
pci_dev
 *
pdev
)

2840 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2841 
	`nvme_dev_dißbÀ
(
dev
, 
åue
);

2842 
	}
}

2849 
	$nvme_ªmove
(
pci_dev
 *
pdev
)

2851 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2853 
	`nvme_ch™ge_˘æ_°©e
(&
dev
->
˘æ
, 
NVME_CTRL_DELETING
);

2854 
	`pci_£t_drvd©a
(
pdev
, 
NULL
);

2856 i‡(!
	`pci_devi˚_is_¥e£¡
(
pdev
)) {

2857 
	`nvme_ch™ge_˘æ_°©e
(&
dev
->
˘æ
, 
NVME_CTRL_DEAD
);

2858 
	`nvme_dev_dißbÀ
(
dev
, 
åue
);

2859 
	`nvme_dev_ªmove_admö
(
dev
);

2862 
	`Êush_w‹k
(&
dev
->
˘æ
.
ª£t_w‹k
);

2863 
	`nvme_°›_˘æ
(&
dev
->
˘æ
);

2864 
	`nvme_ªmove_«me•a˚s
(&
dev
->
˘æ
);

2865 
	`nvme_dev_dißbÀ
(
dev
, 
åue
);

2866 
	`nvme_ªÀa£_cmb
(
dev
);

2867 
	`nvme_‰ì_ho°_mem
(
dev
);

2868 
	`nvme_dev_ªmove_admö
(
dev
);

2869 
	`nvme_‰ì_queues
(
dev
, 0);

2870 
	`nvme_unöô_˘æ
(&
dev
->
˘æ
);

2871 
	`nvme_ªÀa£_¥p_poﬁs
(
dev
);

2872 
	`nvme_dev_unm≠
(
dev
);

2873 
	`nvme_put_˘æ
(&
dev
->
˘æ
);

2874 
	}
}

2876 #ifde‡
CONFIG_PM_SLEEP


2877 
	$nvme_su•íd
(
devi˚
 *
dev
)

2879 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2880 
nvme_dev
 *
ndev
 = 
	`pci_gë_drvd©a
(
pdev
);

2882 
	`nvme_dev_dißbÀ
(
ndev
, 
åue
);

2884 
	}
}

2886 
	$nvme_ªsume
(
devi˚
 *
dev
)

2888 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
dev
);

2889 
nvme_dev
 *
ndev
 = 
	`pci_gë_drvd©a
(
pdev
);

2891 
	`nvme_ª£t_˘æ
(&
ndev
->
˘æ
);

2893 
	}
}

2896 
SIMPLE_DEV_PM_OPS
(
nvme_dev_pm_›s
, 
nvme_su•íd
, 
nvme_ªsume
);

2898 
pci_îs_ªsu…_t
 
	$nvme_îr‹_dëe˘ed
(
pci_dev
 *
pdev
,

2899 
pci_ch™√l_°©e_t
 
°©e
)

2901 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2908 
°©e
) {

2909 
pci_ch™√l_io_n‹mÆ
:

2910  
PCI_ERS_RESULT_CAN_RECOVER
;

2911 
pci_ch™√l_io_‰ozí
:

2912 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2914 
	`nvme_dev_dißbÀ
(
dev
, 
Ál£
);

2915  
PCI_ERS_RESULT_NEED_RESET
;

2916 
pci_ch™√l_io_≥rm_Áûuª
:

2917 
	`dev_w¨n
(
dev
->
˘æ
.
devi˚
,

2919  
PCI_ERS_RESULT_DISCONNECT
;

2921  
PCI_ERS_RESULT_NEED_RESET
;

2922 
	}
}

2924 
pci_îs_ªsu…_t
 
	$nvme_¶Ÿ_ª£t
(
pci_dev
 *
pdev
)

2926 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2928 
	`dev_öfo
(
dev
->
˘æ
.
devi˚
, "restartáfter slotÑeset\n");

2929 
	`pci_ª°‹e_°©e
(
pdev
);

2930 
	`nvme_ª£t_˘æ
(&
dev
->
˘æ
);

2931  
PCI_ERS_RESULT_RECOVERED
;

2932 
	}
}

2934 
	$nvme_îr‹_ªsume
(
pci_dev
 *
pdev
)

2936 
nvme_dev
 *
dev
 = 
	`pci_gë_drvd©a
(
pdev
);

2938 
	`Êush_w‹k
(&
dev
->
˘æ
.
ª£t_w‹k
);

2939 
	}
}

2941 c⁄° 
pci_îr‹_h™dÀrs
 
	gnvme_îr_h™dÀr
 = {

2942 .
îr‹_dëe˘ed
 = 
nvme_îr‹_dëe˘ed
,

2943 .
	g¶Ÿ_ª£t
 = 
nvme_¶Ÿ_ª£t
,

2944 .
	gªsume
 = 
nvme_îr‹_ªsume
,

2945 .
	gª£t_¥ï¨e
 = 
nvme_ª£t_¥ï¨e
,

2946 .
	gª£t_d⁄e
 = 
nvme_ª£t_d⁄e
,

2949 c⁄° 
pci_devi˚_id
 
	gnvme_id_èbÀ
[] = {

2950 { 
PCI_VDEVICE
(
INTEL
, 0x0953),

2951 .
drivî_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2952 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2953 { 
PCI_VDEVICE
(
INTEL
, 0x0a53),

2954 .
	gdrivî_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2955 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2956 { 
PCI_VDEVICE
(
INTEL
, 0x0a54),

2957 .
	gdrivî_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2958 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2959 { 
PCI_VDEVICE
(
INTEL
, 0x0a55),

2960 .
	gdrivî_d©a
 = 
NVME_QUIRK_STRIPE_SIZE
 |

2961 
NVME_QUIRK_DEALLOCATE_ZEROES
, },

2962 { 
PCI_VDEVICE
(
INTEL
, 0xf1a5),

2963 .
	gdrivî_d©a
 = 
NVME_QUIRK_NO_DEEPEST_PS
 |

2964 
NVME_QUIRK_MEDIUM_PRIO_SQ
 },

2965 { 
PCI_VDEVICE
(
INTEL
, 0xf1a6),

2966 .
	gdrivî_d©a
 = 
NVME_QUIRK_IGNORE_DEV_SUBNQN
, },

2967 { 
PCI_VDEVICE
(
INTEL
, 0x5845),

2968 .
	gdrivî_d©a
 = 
NVME_QUIRK_IDENTIFY_CNS
 |

2969 
NVME_QUIRK_DISABLE_WRITE_ZEROES
, },

2970 { 
PCI_DEVICE
(0x1bb1, 0x0100),

2971 .
	gdrivî_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2972 { 
PCI_DEVICE
(0x1c58, 0x0003),

2973 .
	gdrivî_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2974 { 
PCI_DEVICE
(0x1c58, 0x0023),

2975 .
	gdrivî_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2976 { 
PCI_DEVICE
(0x1c5f, 0x0540),

2977 .
	gdrivî_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2978 { 
PCI_DEVICE
(0x144d, 0xa821),

2979 .
	gdrivî_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2980 { 
PCI_DEVICE
(0x144d, 0xa822),

2981 .
	gdrivî_d©a
 = 
NVME_QUIRK_DELAY_BEFORE_CHK_RDY
, },

2982 { 
PCI_DEVICE
(0x1d1d, 0x1f1f),

2983 .
	gdrivî_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

2984 { 
PCI_DEVICE
(0x1d1d, 0x2807),

2985 .
	gdrivî_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

2986 { 
PCI_DEVICE
(0x1d1d, 0x2601),

2987 .
	gdrivî_d©a
 = 
NVME_QUIRK_LIGHTNVM
, },

2988 { 
PCI_DEVICE_CLASS
(
PCI_CLASS_STORAGE_EXPRESS
, 0xffffff) },

2989 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2001) },

2990 { 
PCI_DEVICE
(
PCI_VENDOR_ID_APPLE
, 0x2003) },

2993 
MODULE_DEVICE_TABLE
(
pci
, 
nvme_id_èbÀ
);

2995 
pci_drivî
 
	gnvme_drivî
 = {

2996 .
«me
 = "nvme",

2997 .
	gid_èbÀ
 = 
nvme_id_èbÀ
,

2998 .
	g¥obe
 = 
nvme_¥obe
,

2999 .
	gªmove
 = 
nvme_ªmove
,

3000 .
	gshutdown
 = 
nvme_shutdown
,

3001 .
	gdrivî
 = {

3002 .
pm
 = &
nvme_dev_pm_›s
,

3004 .
	g§iov_c⁄figuª
 = 
pci_§iov_c⁄figuª_sim∂e
,

3005 .
	gîr_h™dÀr
 = &
nvme_îr_h™dÀr
,

3008 
__öô
 
	$nvme_öô
()

3011 
	`•ö_lock_öô
(&
rb_lock
);

3013 
	`BUILD_BUG_ON
(
IRQ_AFFINITY_MAX_SETS
 < 2);

3014  
	`pci_ªgi°î_drivî
(&
nvme_drivî
);

3015 
	}
}

3017 
__exô
 
	$nvme_exô
()

3019 
	`pci_uƒegi°î_drivî
(&
nvme_drivî
);

3020 
	`Êush_w‹kqueue
(
nvme_wq
);

3021 
	`_nvme_check_size
();

3022 
	}
}

3024 
MODULE_AUTHOR
("Matthew Wilcox <willy@linux.intel.com>");

3025 
MODULE_LICENSE
("GPL");

3026 
MODULE_VERSION
("1.0");

3027 
moduÀ_öô
(
nvme_öô
);

3028 
moduÀ_exô
(
nvme_exô
);

	@rdma.c

6 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

7 
	~<löux/moduÀ.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/¶ab.h
>

10 
	~<rdma/mr_poﬁ.h
>

11 
	~<löux/îr.h
>

12 
	~<löux/°rög.h
>

13 
	~<löux/©omic.h
>

14 
	~<löux/blk-mq.h
>

15 
	~<löux/blk-mq-rdma.h
>

16 
	~<löux/ty≥s.h
>

17 
	~<löux/li°.h
>

18 
	~<löux/muãx.h
>

19 
	~<löux/sˇâîli°.h
>

20 
	~<löux/nvme.h
>

21 
	~<asm/u«lig√d.h
>

23 
	~<rdma/ib_vîbs.h
>

24 
	~<rdma/rdma_cm.h
>

25 
	~<löux/nvme-rdma.h
>

27 
	~"nvme.h
"

28 
	~"Ábrics.h
"

31 
	#NVME_RDMA_CONNECT_TIMEOUT_MS
 3000

	)

33 
	#NVME_RDMA_MAX_SEGMENTS
 256

	)

35 
	#NVME_RDMA_MAX_INLINE_SEGMENTS
 4

	)

37 
	snvme_rdma_devi˚
 {

38 
ib_devi˚
 *
	mdev
;

39 
ib_pd
 *
	mpd
;

40 
kªf
 
	mªf
;

41 
li°_hód
 
	míåy
;

42 
	mnum_ölöe_£gmíts
;

45 
	snvme_rdma_qe
 {

46 
ib_cqe
 
	mcqe
;

47 *
	md©a
;

48 
u64
 
	mdma
;

51 
	gnvme_rdma_queue
;

52 
	snvme_rdma_ªque°
 {

53 
nvme_ªque°
 
	mªq
;

54 
ib_mr
 *
	mmr
;

55 
nvme_rdma_qe
 
	msqe
;

56 
nvme_ªsu…
 
	mªsu…
;

57 
__À16
 
	m°©us
;

58 
ªfcou¡_t
 
	mªf
;

59 
ib_sge
 
	msge
[1 + 
NVME_RDMA_MAX_INLINE_SEGMENTS
];

60 
u32
 
	mnum_sge
;

61 
	m√¡s
;

62 
ib_ªg_wr
 
	mªg_wr
;

63 
ib_cqe
 
	mªg_cqe
;

64 
nvme_rdma_queue
 *
	mqueue
;

65 
sg_èbÀ
 
	msg_èbÀ
;

66 
sˇâîli°
 
	mfú°_sgl
[];

69 
	envme_rdma_queue_Êags
 {

70 
	mNVME_RDMA_Q_ALLOCATED
 = 0,

71 
	mNVME_RDMA_Q_LIVE
 = 1,

72 
	mNVME_RDMA_Q_TR_READY
 = 2,

75 
	snvme_rdma_queue
 {

76 
nvme_rdma_qe
 *
	mr•_rög
;

77 
	mqueue_size
;

78 
size_t
 
	mcmnd_ˇpsuÀ_Àn
;

79 
nvme_rdma_˘æ
 *
	m˘æ
;

80 
nvme_rdma_devi˚
 *
	mdevi˚
;

81 
ib_cq
 *
	mib_cq
;

82 
ib_qp
 *
	mqp
;

84 
	mÊags
;

85 
rdma_cm_id
 *
	mcm_id
;

86 
	mcm_îr‹
;

87 
com∂ëi⁄
 
	mcm_d⁄e
;

90 
	snvme_rdma_˘æ
 {

92 
nvme_rdma_queue
 *
	mqueues
;

95 
blk_mq_èg_£t
 
	mèg_£t
;

96 
w‹k_°ru˘
 
	mîr_w‹k
;

98 
nvme_rdma_qe
 
	masync_evít_sqe
;

100 
dñayed_w‹k
 
	mªc⁄√˘_w‹k
;

102 
li°_hód
 
	mli°
;

104 
blk_mq_èg_£t
 
	madmö_èg_£t
;

105 
nvme_rdma_devi˚
 *
	mdevi˚
;

107 
u32
 
	mmax_‰_∑ges
;

109 
sockaddr_°‹age
 
	maddr
;

110 
sockaddr_°‹age
 
	m§c_addr
;

112 
nvme_˘æ
 
	m˘æ
;

113 
boﬁ
 
	mu£_ölöe_d©a
;

114 
u32
 
	mio_queues
[
HCTX_MAX_TYPES
];

117 
ölöe
 
nvme_rdma_˘æ
 *
	$to_rdma_˘æ
(
nvme_˘æ
 *
˘æ
)

119  
	`c⁄èöî_of
(
˘æ
, 
nvme_rdma_˘æ
, ctrl);

120 
	}
}

122 
LIST_HEAD
(
devi˚_li°
);

123 
DEFINE_MUTEX
(
devi˚_li°_muãx
);

125 
LIST_HEAD
(
nvme_rdma_˘æ_li°
);

126 
DEFINE_MUTEX
(
nvme_rdma_˘æ_muãx
);

133 
boﬁ
 
	gªgi°î_Æways
 = 
åue
;

134 
moduÀ_∑øm
(
ªgi°î_Æways
, 
boﬁ
, 0444);

135 
MODULE_PARM_DESC
(
ªgi°î_Æways
,

138 
nvme_rdma_cm_h™dÀr
(
rdma_cm_id
 *
cm_id
,

139 
rdma_cm_evít
 *
evít
);

140 
nvme_rdma_ªcv_d⁄e
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
);

142 c⁄° 
blk_mq_›s
 
	gnvme_rdma_mq_›s
;

143 c⁄° 
blk_mq_›s
 
	gnvme_rdma_admö_mq_›s
;

146 
ölöe
 
	$put_u«lig√d_À24
(
u32
 
vÆ
, 
u8
 *
p
)

148 *
p
++ = 
vÆ
;

149 *
p
++ = 
vÆ
 >> 8;

150 *
p
++ = 
vÆ
 >> 16;

151 
	}
}

153 
ölöe
 
	$nvme_rdma_queue_idx
(
nvme_rdma_queue
 *
queue
)

155  
queue
 - queue->
˘æ
->
queues
;

156 
	}
}

158 
boﬁ
 
	$nvme_rdma_pﬁl_queue
(
nvme_rdma_queue
 *
queue
)

160  
	`nvme_rdma_queue_idx
(
queue
) >

161 
queue
->
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
] +

162 
queue
->
˘æ
->
io_queues
[
HCTX_TYPE_READ
];

163 
	}
}

165 
ölöe
 
size_t
 
	$nvme_rdma_ölöe_d©a_size
(
nvme_rdma_queue
 *
queue
)

167  
queue
->
cmnd_ˇpsuÀ_Àn
 - (
nvme_comm™d
);

168 
	}
}

170 
	$nvme_rdma_‰ì_qe
(
ib_devi˚
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

171 
size_t
 
ˇpsuÀ_size
, 
dma_d©a_dúe˘i⁄
 
dú
)

173 
	`ib_dma_unm≠_sögÀ
(
ibdev
, 
qe
->
dma
, 
ˇpsuÀ_size
, 
dú
);

174 
	`k‰ì
(
qe
->
d©a
);

175 
	}
}

177 
	$nvme_rdma_Æloc_qe
(
ib_devi˚
 *
ibdev
, 
nvme_rdma_qe
 *
qe
,

178 
size_t
 
ˇpsuÀ_size
, 
dma_d©a_dúe˘i⁄
 
dú
)

180 
qe
->
d©a
 = 
	`kzÆloc
(
ˇpsuÀ_size
, 
GFP_KERNEL
);

181 i‡(!
qe
->
d©a
)

182  -
ENOMEM
;

184 
qe
->
dma
 = 
	`ib_dma_m≠_sögÀ
(
ibdev
, qe->
d©a
, 
ˇpsuÀ_size
, 
dú
);

185 i‡(
	`ib_dma_m≠pög_îr‹
(
ibdev
, 
qe
->
dma
)) {

186 
	`k‰ì
(
qe
->
d©a
);

187 
qe
->
d©a
 = 
NULL
;

188  -
ENOMEM
;

192 
	}
}

194 
	$nvme_rdma_‰ì_rög
(
ib_devi˚
 *
ibdev
,

195 
nvme_rdma_qe
 *
rög
, 
size_t
 
ib_queue_size
,

196 
size_t
 
ˇpsuÀ_size
, 
dma_d©a_dúe˘i⁄
 
dú
)

198 
i
;

200 
i
 = 0; i < 
ib_queue_size
; i++)

201 
	`nvme_rdma_‰ì_qe
(
ibdev
, &
rög
[
i
], 
ˇpsuÀ_size
, 
dú
);

202 
	`k‰ì
(
rög
);

203 
	}
}

205 
nvme_rdma_qe
 *
	$nvme_rdma_Æloc_rög
(
ib_devi˚
 *
ibdev
,

206 
size_t
 
ib_queue_size
, size_à
ˇpsuÀ_size
,

207 
dma_d©a_dúe˘i⁄
 
dú
)

209 
nvme_rdma_qe
 *
rög
;

210 
i
;

212 
rög
 = 
	`kˇŒoc
(
ib_queue_size
, (
nvme_rdma_qe
), 
GFP_KERNEL
);

213 i‡(!
rög
)

214  
NULL
;

216 
i
 = 0; i < 
ib_queue_size
; i++) {

217 i‡(
	`nvme_rdma_Æloc_qe
(
ibdev
, &
rög
[
i
], 
ˇpsuÀ_size
, 
dú
))

218 
out_‰ì_rög
;

221  
rög
;

223 
out_‰ì_rög
:

224 
	`nvme_rdma_‰ì_rög
(
ibdev
, 
rög
, 
i
, 
ˇpsuÀ_size
, 
dú
);

225  
NULL
;

226 
	}
}

228 
	$nvme_rdma_qp_evít
(
ib_evít
 *
evít
, *
c⁄ãxt
)

230 
	`¥_debug
("QPÉvent %s (%d)\n",

231 
	`ib_evít_msg
(
evít
->event),Évent->event);

233 
	}
}

235 
	$nvme_rdma_waô_f‹_cm
(
nvme_rdma_queue
 *
queue
)

237 
ªt
;

239 
ªt
 = 
	`waô_f‹_com∂ëi⁄_öãºu±ibÀ_timeout
(&
queue
->
cm_d⁄e
,

240 
	`m£cs_to_jiffõs
(
NVME_RDMA_CONNECT_TIMEOUT_MS
) + 1);

241 i‡(
ªt
 < 0)

242  
ªt
;

243 i‡(
ªt
 == 0)

244  -
ETIMEDOUT
;

245 
	`WARN_ON_ONCE
(
queue
->
cm_îr‹
 > 0);

246  
queue
->
cm_îr‹
;

247 
	}
}

249 
	$nvme_rdma_¸óã_qp
(
nvme_rdma_queue
 *
queue
, c⁄° 
Á˘‹
)

251 
nvme_rdma_devi˚
 *
dev
 = 
queue
->
devi˚
;

252 
ib_qp_öô_©å
 
öô_©å
;

253 
ªt
;

255 
	`mem£t
(&
öô_©å
, 0, (init_attr));

256 
öô_©å
.
evít_h™dÀr
 = 
nvme_rdma_qp_evít
;

258 
öô_©å
.
ˇp
.
max_£nd_wr
 = 
Á˘‹
 * 
queue
->
queue_size
 + 1;

260 
öô_©å
.
ˇp
.
max_ªcv_wr
 = 
queue
->
queue_size
 + 1;

261 
öô_©å
.
ˇp
.
max_ªcv_sge
 = 1;

262 
öô_©å
.
ˇp
.
max_£nd_sge
 = 1 + 
dev
->
num_ölöe_£gmíts
;

263 
öô_©å
.
sq_sig_ty≥
 = 
IB_SIGNAL_REQ_WR
;

264 
öô_©å
.
qp_ty≥
 = 
IB_QPT_RC
;

265 
öô_©å
.
£nd_cq
 = 
queue
->
ib_cq
;

266 
öô_©å
.
ªcv_cq
 = 
queue
->
ib_cq
;

268 
ªt
 = 
	`rdma_¸óã_qp
(
queue
->
cm_id
, 
dev
->
pd
, &
öô_©å
);

270 
queue
->
qp
 = queue->
cm_id
->qp;

271  
ªt
;

272 
	}
}

274 
	$nvme_rdma_exô_ªque°
(
blk_mq_èg_£t
 *
£t
,

275 
ªque°
 *
rq
, 
h˘x_idx
)

277 
nvme_rdma_˘æ
 *
˘æ
 = 
£t
->
drivî_d©a
;

278 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

279 
queue_idx
 = (
£t
 =&
˘æ
->
èg_£t
Ë? 
h˘x_idx
 + 1 : 0;

280 
nvme_rdma_queue
 *
queue
 = &
˘æ
->
queues
[
queue_idx
];

281 
nvme_rdma_devi˚
 *
dev
 = 
queue
->
devi˚
;

283 
	`nvme_rdma_‰ì_qe
(
dev
->dev, &
ªq
->
sqe
, (
nvme_comm™d
),

284 
DMA_TO_DEVICE
);

285 
	}
}

287 
	$nvme_rdma_öô_ªque°
(
blk_mq_èg_£t
 *
£t
,

288 
ªque°
 *
rq
, 
h˘x_idx
,

289 
numa_node
)

291 
nvme_rdma_˘æ
 *
˘æ
 = 
£t
->
drivî_d©a
;

292 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

293 
queue_idx
 = (
£t
 =&
˘æ
->
èg_£t
Ë? 
h˘x_idx
 + 1 : 0;

294 
nvme_rdma_queue
 *
queue
 = &
˘æ
->
queues
[
queue_idx
];

295 
nvme_rdma_devi˚
 *
dev
 = 
queue
->
devi˚
;

296 
ib_devi˚
 *
ibdev
 = 
dev
->dev;

297 
ªt
;

299 
	`nvme_ªq
(
rq
)->
˘æ
 = &ctrl->ctrl;

300 
ªt
 = 
	`nvme_rdma_Æloc_qe
(
ibdev
, &
ªq
->
sqe
, (
nvme_comm™d
),

301 
DMA_TO_DEVICE
);

302 i‡(
ªt
)

303  
ªt
;

305 
ªq
->
queue
 = queue;

308 
	}
}

310 
	$nvme_rdma_öô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

311 
h˘x_idx
)

313 
nvme_rdma_˘æ
 *
˘æ
 = 
d©a
;

314 
nvme_rdma_queue
 *
queue
 = &
˘æ
->
queues
[
h˘x_idx
 + 1];

316 
	`BUG_ON
(
h˘x_idx
 >
˘æ
->˘æ.
queue_cou¡
);

318 
h˘x
->
drivî_d©a
 = 
queue
;

320 
	}
}

322 
	$nvme_rdma_öô_admö_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

323 
h˘x_idx
)

325 
nvme_rdma_˘æ
 *
˘æ
 = 
d©a
;

326 
nvme_rdma_queue
 *
queue
 = &
˘æ
->
queues
[0];

328 
	`BUG_ON
(
h˘x_idx
 != 0);

330 
h˘x
->
drivî_d©a
 = 
queue
;

332 
	}
}

334 
	$nvme_rdma_‰ì_dev
(
kªf
 *
ªf
)

336 
nvme_rdma_devi˚
 *
ndev
 =

337 
	`c⁄èöî_of
(
ªf
, 
nvme_rdma_devi˚
,Ñef);

339 
	`muãx_lock
(&
devi˚_li°_muãx
);

340 
	`li°_dñ
(&
ndev
->
íåy
);

341 
	`muãx_u∆ock
(&
devi˚_li°_muãx
);

343 
	`ib_dóŒoc_pd
(
ndev
->
pd
);

344 
	`k‰ì
(
ndev
);

345 
	}
}

347 
	$nvme_rdma_dev_put
(
nvme_rdma_devi˚
 *
dev
)

349 
	`kªf_put
(&
dev
->
ªf
, 
nvme_rdma_‰ì_dev
);

350 
	}
}

352 
	$nvme_rdma_dev_gë
(
nvme_rdma_devi˚
 *
dev
)

354  
	`kªf_gë_u∆ess_zîo
(&
dev
->
ªf
);

355 
	}
}

357 
nvme_rdma_devi˚
 *

358 
	$nvme_rdma_föd_gë_devi˚
(
rdma_cm_id
 *
cm_id
)

360 
nvme_rdma_devi˚
 *
ndev
;

362 
	`muãx_lock
(&
devi˚_li°_muãx
);

363 
	`li°_f‹_óch_íåy
(
ndev
, &
devi˚_li°
, 
íåy
) {

364 i‡(
ndev
->
dev
->
node_guid
 =
cm_id
->
devi˚
->node_guid &&

365 
	`nvme_rdma_dev_gë
(
ndev
))

366 
out_u∆ock
;

369 
ndev
 = 
	`kzÆloc
((*ndev), 
GFP_KERNEL
);

370 i‡(!
ndev
)

371 
out_îr
;

373 
ndev
->
dev
 = 
cm_id
->
devi˚
;

374 
	`kªf_öô
(&
ndev
->
ªf
);

376 
ndev
->
pd
 = 
	`ib_Æloc_pd
“dev->
dev
,

377 
ªgi°î_Æways
 ? 0 : 
IB_PD_UNSAFE_GLOBAL_RKEY
);

378 i‡(
	`IS_ERR
(
ndev
->
pd
))

379 
out_‰ì_dev
;

381 i‡(!(
ndev
->
dev
->
©ås
.
devi˚_ˇp_Êags
 &

382 
IB_DEVICE_MEM_MGT_EXTENSIONS
)) {

383 
	`dev_îr
(&
ndev
->
dev
->dev,

385 
out_‰ì_pd
;

388 
ndev
->
num_ölöe_£gmíts
 = 
	`mö
(
NVME_RDMA_MAX_INLINE_SEGMENTS
,

389 
ndev
->
dev
->
©ås
.
max_£nd_sge
 - 1);

390 
	`li°_add
(&
ndev
->
íåy
, &
devi˚_li°
);

391 
out_u∆ock
:

392 
	`muãx_u∆ock
(&
devi˚_li°_muãx
);

393  
ndev
;

395 
out_‰ì_pd
:

396 
	`ib_dóŒoc_pd
(
ndev
->
pd
);

397 
out_‰ì_dev
:

398 
	`k‰ì
(
ndev
);

399 
out_îr
:

400 
	`muãx_u∆ock
(&
devi˚_li°_muãx
);

401  
NULL
;

402 
	}
}

404 
	$nvme_rdma_de°roy_queue_ib
(
nvme_rdma_queue
 *
queue
)

406 
nvme_rdma_devi˚
 *
dev
;

407 
ib_devi˚
 *
ibdev
;

409 i‡(!
	`ã°_™d_˛ór_bô
(
NVME_RDMA_Q_TR_READY
, &
queue
->
Êags
))

412 
dev
 = 
queue
->
devi˚
;

413 
ibdev
 = 
dev
->dev;

415 
	`ib_mr_poﬁ_de°roy
(
queue
->
qp
, &queue->qp->
rdma_mrs
);

422 
	`ib_de°roy_qp
(
queue
->
qp
);

423 
	`ib_‰ì_cq
(
queue
->
ib_cq
);

425 
	`nvme_rdma_‰ì_rög
(
ibdev
, 
queue
->
r•_rög
, queue->
queue_size
,

426 (
nvme_com∂ëi⁄
), 
DMA_FROM_DEVICE
);

428 
	`nvme_rdma_dev_put
(
dev
);

429 
	}
}

431 
	$nvme_rdma_gë_max_‰_∑ges
(
ib_devi˚
 *
ibdev
)

433  
	`mö_t
(
u32
, 
NVME_RDMA_MAX_SEGMENTS
,

434 
ibdev
->
©ås
.
max_Á°_ªg_∑ge_li°_Àn
);

435 
	}
}

437 
	$nvme_rdma_¸óã_queue_ib
(
nvme_rdma_queue
 *
queue
)

439 
ib_devi˚
 *
ibdev
;

440 c⁄° 
£nd_wr_Á˘‹
 = 3;

441 c⁄° 
cq_Á˘‹
 = 
£nd_wr_Á˘‹
 + 1;

442 
comp_ve˘‹
, 
idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

443 
ib_pﬁl_c⁄ãxt
 
pﬁl_˘x
;

444 
ªt
;

446 
queue
->
devi˚
 = 
	`nvme_rdma_föd_gë_devi˚
(queue->
cm_id
);

447 i‡(!
queue
->
devi˚
) {

448 
	`dev_îr
(
queue
->
cm_id
->
devi˚
->
dev
.
∑ª¡
,

450  -
ECONNREFUSED
;

452 
ibdev
 = 
queue
->
devi˚
->
dev
;

458 
comp_ve˘‹
 = 
idx
 == 0 ? idx : idx - 1;

461 i‡(
	`nvme_rdma_pﬁl_queue
(
queue
))

462 
pﬁl_˘x
 = 
IB_POLL_DIRECT
;

464 
pﬁl_˘x
 = 
IB_POLL_SOFTIRQ
;

467 
queue
->
ib_cq
 = 
	`ib_Æloc_cq
(
ibdev
, queue,

468 
cq_Á˘‹
 * 
queue
->
queue_size
 + 1,

469 
comp_ve˘‹
, 
pﬁl_˘x
);

470 i‡(
	`IS_ERR
(
queue
->
ib_cq
)) {

471 
ªt
 = 
	`PTR_ERR
(
queue
->
ib_cq
);

472 
out_put_dev
;

475 
ªt
 = 
	`nvme_rdma_¸óã_qp
(
queue
, 
£nd_wr_Á˘‹
);

476 i‡(
ªt
)

477 
out_de°roy_ib_cq
;

479 
queue
->
r•_rög
 = 
	`nvme_rdma_Æloc_rög
(
ibdev
, queue->
queue_size
,

480 (
nvme_com∂ëi⁄
), 
DMA_FROM_DEVICE
);

481 i‡(!
queue
->
r•_rög
) {

482 
ªt
 = -
ENOMEM
;

483 
out_de°roy_qp
;

486 
ªt
 = 
	`ib_mr_poﬁ_öô
(
queue
->
qp
, &queue->qp->
rdma_mrs
,

487 
queue
->
queue_size
,

488 
IB_MR_TYPE_MEM_REG
,

489 
	`nvme_rdma_gë_max_‰_∑ges
(
ibdev
));

490 i‡(
ªt
) {

491 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

493 
queue
->
queue_size
, 
idx
);

494 
out_de°roy_rög
;

497 
	`£t_bô
(
NVME_RDMA_Q_TR_READY
, &
queue
->
Êags
);

501 
out_de°roy_rög
:

502 
	`nvme_rdma_‰ì_rög
(
ibdev
, 
queue
->
r•_rög
, queue->
queue_size
,

503 (
nvme_com∂ëi⁄
), 
DMA_FROM_DEVICE
);

504 
out_de°roy_qp
:

505 
	`rdma_de°roy_qp
(
queue
->
cm_id
);

506 
out_de°roy_ib_cq
:

507 
	`ib_‰ì_cq
(
queue
->
ib_cq
);

508 
out_put_dev
:

509 
	`nvme_rdma_dev_put
(
queue
->
devi˚
);

510  
ªt
;

511 
	}
}

513 
	$nvme_rdma_Æloc_queue
(
nvme_rdma_˘æ
 *
˘æ
,

514 
idx
, 
size_t
 
queue_size
)

516 
nvme_rdma_queue
 *
queue
;

517 
sockaddr
 *
§c_addr
 = 
NULL
;

518 
ªt
;

520 
queue
 = &
˘æ
->
queues
[
idx
];

521 
queue
->
˘æ
 = ctrl;

522 
	`öô_com∂ëi⁄
(&
queue
->
cm_d⁄e
);

524 i‡(
idx
 > 0)

525 
queue
->
cmnd_ˇpsuÀ_Àn
 = 
˘æ
->˘æ.
ioccsz
 * 16;

527 
queue
->
cmnd_ˇpsuÀ_Àn
 = (
nvme_comm™d
);

529 
queue
->
queue_size
 = queue_size;

531 
queue
->
cm_id
 = 
	`rdma_¸óã_id
(&
öô_√t
, 
nvme_rdma_cm_h™dÀr
, queue,

532 
RDMA_PS_TCP
, 
IB_QPT_RC
);

533 i‡(
	`IS_ERR
(
queue
->
cm_id
)) {

534 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

535 "ÁûedÅÿ¸óã CM ID: %ld\n", 
	`PTR_ERR
(
queue
->
cm_id
));

536  
	`PTR_ERR
(
queue
->
cm_id
);

539 i‡(
˘æ
->˘æ.
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
)

540 
§c_addr
 = (
sockaddr
 *)&
˘æ
->src_addr;

542 
queue
->
cm_îr‹
 = -
ETIMEDOUT
;

543 
ªt
 = 
	`rdma_ªsﬁve_addr
(
queue
->
cm_id
, 
§c_addr
,

544 (
sockaddr
 *)&
˘æ
->
addr
,

545 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

546 i‡(
ªt
) {

547 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

548 "rdma_ªsﬁve_add∏Áûed (%d).\n", 
ªt
);

549 
out_de°roy_cm_id
;

552 
ªt
 = 
	`nvme_rdma_waô_f‹_cm
(
queue
);

553 i‡(
ªt
) {

554 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

555 "rdm®c⁄√˘i⁄É°ablishmíàÁûed (%d)\n", 
ªt
);

556 
out_de°roy_cm_id
;

559 
	`£t_bô
(
NVME_RDMA_Q_ALLOCATED
, &
queue
->
Êags
);

563 
out_de°roy_cm_id
:

564 
	`rdma_de°roy_id
(
queue
->
cm_id
);

565 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

566  
ªt
;

567 
	}
}

569 
	$nvme_rdma_°›_queue
(
nvme_rdma_queue
 *
queue
)

571 i‡(!
	`ã°_™d_˛ór_bô
(
NVME_RDMA_Q_LIVE
, &
queue
->
Êags
))

574 
	`rdma_disc⁄√˘
(
queue
->
cm_id
);

575 
	`ib_døö_qp
(
queue
->
qp
);

576 
	}
}

578 
	$nvme_rdma_‰ì_queue
(
nvme_rdma_queue
 *
queue
)

580 i‡(!
	`ã°_™d_˛ór_bô
(
NVME_RDMA_Q_ALLOCATED
, &
queue
->
Êags
))

583 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

584 
	`rdma_de°roy_id
(
queue
->
cm_id
);

585 
	}
}

587 
	$nvme_rdma_‰ì_io_queues
(
nvme_rdma_˘æ
 *
˘æ
)

589 
i
;

591 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++)

592 
	`nvme_rdma_‰ì_queue
(&
˘æ
->
queues
[
i
]);

593 
	}
}

595 
	$nvme_rdma_°›_io_queues
(
nvme_rdma_˘æ
 *
˘æ
)

597 
i
;

599 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++)

600 
	`nvme_rdma_°›_queue
(&
˘æ
->
queues
[
i
]);

601 
	}
}

603 
	$nvme_rdma_°¨t_queue
(
nvme_rdma_˘æ
 *
˘æ
, 
idx
)

605 
nvme_rdma_queue
 *
queue
 = &
˘æ
->
queues
[
idx
];

606 
boﬁ
 
pﬁl
 = 
	`nvme_rdma_pﬁl_queue
(
queue
);

607 
ªt
;

609 i‡(
idx
)

610 
ªt
 = 
	`nvmf_c⁄√˘_io_queue
(&
˘æ
->˘æ, 
idx
, 
pﬁl
);

612 
ªt
 = 
	`nvmf_c⁄√˘_admö_queue
(&
˘æ
->ctrl);

614 i‡(!
ªt
)

615 
	`£t_bô
(
NVME_RDMA_Q_LIVE
, &
queue
->
Êags
);

617 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

618 "ÁûedÅÿc⁄√˘ queue: %dÑë=%d\n", 
idx
, 
ªt
);

619  
ªt
;

620 
	}
}

622 
	$nvme_rdma_°¨t_io_queues
(
nvme_rdma_˘æ
 *
˘æ
)

624 
i
, 
ªt
 = 0;

626 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++) {

627 
ªt
 = 
	`nvme_rdma_°¨t_queue
(
˘æ
, 
i
);

628 i‡(
ªt
)

629 
out_°›_queues
;

634 
out_°›_queues
:

635 
i
--; i >= 1; i--)

636 
	`nvme_rdma_°›_queue
(&
˘æ
->
queues
[
i
]);

637  
ªt
;

638 
	}
}

640 
	$nvme_rdma_Æloc_io_queues
(
nvme_rdma_˘æ
 *
˘æ
)

642 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->ctrl.opts;

643 
ib_devi˚
 *
ibdev
 = 
˘æ
->
devi˚
->
dev
;

644 
ƒ_io_queues
, 
ƒ_deÁu…_queues
;

645 
ƒ_ªad_queues
, 
ƒ_pﬁl_queues
;

646 
i
, 
ªt
;

648 
ƒ_ªad_queues
 = 
	`mö_t
(, 
ibdev
->
num_comp_ve˘‹s
,

649 
	`mö
(
›ts
->
ƒ_io_queues
, 
	`num_⁄löe_˝us
()));

650 
ƒ_deÁu…_queues
 = 
	`mö_t
(, 
ibdev
->
num_comp_ve˘‹s
,

651 
	`mö
(
›ts
->
ƒ_wrôe_queues
, 
	`num_⁄löe_˝us
()));

652 
ƒ_pﬁl_queues
 = 
	`mö
(
›ts
->ƒ_pﬁl_queues, 
	`num_⁄löe_˝us
());

653 
ƒ_io_queues
 = 
ƒ_ªad_queues
 + 
ƒ_deÁu…_queues
 + 
ƒ_pﬁl_queues
;

655 
ªt
 = 
	`nvme_£t_queue_cou¡
(&
˘æ
->˘æ, &
ƒ_io_queues
);

656 i‡(
ªt
)

657  
ªt
;

659 
˘æ
->˘æ.
queue_cou¡
 = 
ƒ_io_queues
 + 1;

660 i‡(
˘æ
->˘æ.
queue_cou¡
 < 2)

663 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

664 "¸ótög %d I/O queues.\n", 
ƒ_io_queues
);

666 i‡(
›ts
->
ƒ_wrôe_queues
 && 
ƒ_ªad_queues
 < 
ƒ_io_queues
) {

672 
˘æ
->
io_queues
[
HCTX_TYPE_READ
] = 
ƒ_ªad_queues
;

673 
ƒ_io_queues
 -
˘æ
->
io_queues
[
HCTX_TYPE_READ
];

674 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
] =

675 
	`mö
(
ƒ_deÁu…_queues
, 
ƒ_io_queues
);

676 
ƒ_io_queues
 -
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

683 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
] =

684 
	`mö
(
ƒ_ªad_queues
, 
ƒ_io_queues
);

685 
ƒ_io_queues
 -
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

688 i‡(
›ts
->
ƒ_pﬁl_queues
 && 
ƒ_io_queues
) {

690 
˘æ
->
io_queues
[
HCTX_TYPE_POLL
] =

691 
	`mö
(
ƒ_pﬁl_queues
, 
ƒ_io_queues
);

694 
i
 = 1; i < 
˘æ
->˘æ.
queue_cou¡
; i++) {

695 
ªt
 = 
	`nvme_rdma_Æloc_queue
(
˘æ
, 
i
,

696 
˘æ
->˘æ.
sqsize
 + 1);

697 i‡(
ªt
)

698 
out_‰ì_queues
;

703 
out_‰ì_queues
:

704 
i
--; i >= 1; i--)

705 
	`nvme_rdma_‰ì_queue
(&
˘æ
->
queues
[
i
]);

707  
ªt
;

708 
	}
}

710 
	$nvme_rdma_‰ì_èg£t
(
nvme_˘æ
 *
n˘æ
,

711 
blk_mq_èg_£t
 *
£t
)

713 
nvme_rdma_˘æ
 *
˘æ
 = 
	`to_rdma_˘æ
(
n˘æ
);

715 
	`blk_mq_‰ì_èg_£t
(
£t
);

716 
	`nvme_rdma_dev_put
(
˘æ
->
devi˚
);

717 
	}
}

719 
blk_mq_èg_£t
 *
	$nvme_rdma_Æloc_èg£t
(
nvme_˘æ
 *
n˘æ
,

720 
boﬁ
 
admö
)

722 
nvme_rdma_˘æ
 *
˘æ
 = 
	`to_rdma_˘æ
(
n˘æ
);

723 
blk_mq_èg_£t
 *
£t
;

724 
ªt
;

726 i‡(
admö
) {

727 
£t
 = &
˘æ
->
admö_èg_£t
;

728 
	`mem£t
(
£t
, 0, (*set));

729 
£t
->
›s
 = &
nvme_rdma_admö_mq_›s
;

730 
£t
->
queue_dïth
 = 
NVME_AQ_MQ_TAG_DEPTH
;

731 
£t
->
ª£rved_ègs
 = 2;

732 
£t
->
numa_node
 = 
n˘æ
->numa_node;

733 
£t
->
cmd_size
 = (
nvme_rdma_ªque°
) +

734 
SG_CHUNK_SIZE
 * (
sˇâîli°
);

735 
£t
->
drivî_d©a
 = 
˘æ
;

736 
£t
->
ƒ_hw_queues
 = 1;

737 
£t
->
timeout
 = 
ADMIN_TIMEOUT
;

738 
£t
->
Êags
 = 
BLK_MQ_F_NO_SCHED
;

740 
£t
 = &
˘æ
->
èg_£t
;

741 
	`mem£t
(
£t
, 0, (*set));

742 
£t
->
›s
 = &
nvme_rdma_mq_›s
;

743 
£t
->
queue_dïth
 = 
n˘æ
->
sqsize
 + 1;

744 
£t
->
ª£rved_ègs
 = 1;

745 
£t
->
numa_node
 = 
n˘æ
->numa_node;

746 
£t
->
Êags
 = 
BLK_MQ_F_SHOULD_MERGE
;

747 
£t
->
cmd_size
 = (
nvme_rdma_ªque°
) +

748 
SG_CHUNK_SIZE
 * (
sˇâîli°
);

749 
£t
->
drivî_d©a
 = 
˘æ
;

750 
£t
->
ƒ_hw_queues
 = 
n˘æ
->
queue_cou¡
 - 1;

751 
£t
->
timeout
 = 
NVME_IO_TIMEOUT
;

752 
£t
->
ƒ_m≠s
 = 
n˘æ
->
›ts
->
ƒ_pﬁl_queues
 ? 
HCTX_MAX_TYPES
 : 2;

755 
ªt
 = 
	`blk_mq_Æloc_èg_£t
(
£t
);

756 i‡(
ªt
)

757 
out
;

763 
ªt
 = 
	`nvme_rdma_dev_gë
(
˘æ
->
devi˚
);

764 i‡(!
ªt
) {

765 
ªt
 = -
EINVAL
;

766 
out_‰ì_èg£t
;

769  
£t
;

771 
out_‰ì_èg£t
:

772 
	`blk_mq_‰ì_èg_£t
(
£t
);

773 
out
:

774  
	`ERR_PTR
(
ªt
);

775 
	}
}

777 
	$nvme_rdma_de°roy_admö_queue
(
nvme_rdma_˘æ
 *
˘æ
,

778 
boﬁ
 
ªmove
)

780 i‡(
ªmove
) {

781 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
admö_q
);

782 
	`nvme_rdma_‰ì_èg£t
(&
˘æ
->˘æ, cål->˘æ.
admö_èg£t
);

784 i‡(
˘æ
->
async_evít_sqe
.
d©a
) {

785 
	`nvme_rdma_‰ì_qe
(
˘æ
->
devi˚
->
dev
, &˘æ->
async_evít_sqe
,

786 (
nvme_comm™d
), 
DMA_TO_DEVICE
);

787 
˘æ
->
async_evít_sqe
.
d©a
 = 
NULL
;

789 
	`nvme_rdma_‰ì_queue
(&
˘æ
->
queues
[0]);

790 
	}
}

792 
	$nvme_rdma_c⁄figuª_admö_queue
(
nvme_rdma_˘æ
 *
˘æ
,

793 
boﬁ
 
√w
)

795 
îr‹
;

797 
îr‹
 = 
	`nvme_rdma_Æloc_queue
(
˘æ
, 0, 
NVME_AQ_DEPTH
);

798 i‡(
îr‹
)

799  
îr‹
;

801 
˘æ
->
devi˚
 = cål->
queues
[0].device;

802 
˘æ
->˘æ.
numa_node
 = 
	`dev_to_node
(˘æ->
devi˚
->
dev
->
dma_devi˚
);

804 
˘æ
->
max_‰_∑ges
 = 
	`nvme_rdma_gë_max_‰_∑ges
(˘æ->
devi˚
->
dev
);

806 
îr‹
 = 
	`nvme_rdma_Æloc_qe
(
˘æ
->
devi˚
->
dev
, &˘æ->
async_evít_sqe
,

807 (
nvme_comm™d
), 
DMA_TO_DEVICE
);

808 i‡(
îr‹
)

809 
out_‰ì_queue
;

811 i‡(
√w
) {

812 
˘æ
->˘æ.
admö_èg£t
 = 
	`nvme_rdma_Æloc_èg£t
(&˘æ->˘æ, 
åue
);

813 i‡(
	`IS_ERR
(
˘æ
->˘æ.
admö_èg£t
)) {

814 
îr‹
 = 
	`PTR_ERR
(
˘æ
->˘æ.
admö_èg£t
);

815 
out_‰ì_async_qe
;

818 
˘æ
->˘æ.
admö_q
 = 
	`blk_mq_öô_queue
(&˘æ->
admö_èg_£t
);

819 i‡(
	`IS_ERR
(
˘æ
->˘æ.
admö_q
)) {

820 
îr‹
 = 
	`PTR_ERR
(
˘æ
->˘æ.
admö_q
);

821 
out_‰ì_èg£t
;

825 
îr‹
 = 
	`nvme_rdma_°¨t_queue
(
˘æ
, 0);

826 i‡(
îr‹
)

827 
out_˛ónup_queue
;

829 
îr‹
 = 
˘æ
->˘æ.
›s
->
	`ªg_ªad64
(&˘æ->˘æ, 
NVME_REG_CAP
,

830 &
˘æ
->˘æ.
ˇp
);

831 i‡(
îr‹
) {

832 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

834 
out_°›_queue
;

837 
˘æ
->˘æ.
sqsize
 =

838 
	`mö_t
(, 
	`NVME_CAP_MQES
(
˘æ
->˘æ.
ˇp
), cål->˘æ.
sqsize
);

840 
îr‹
 = 
	`nvme_íabÀ_˘æ
(&
˘æ
->˘æ, cål->˘æ.
ˇp
);

841 i‡(
îr‹
)

842 
out_°›_queue
;

844 
˘æ
->˘æ.
max_hw_£˘‹s
 =

845 (
˘æ
->
max_‰_∑ges
 - 1Ë<< (
	`ûog2
(
SZ_4K
) - 9);

847 
îr‹
 = 
	`nvme_öô_idítify
(&
˘æ
->ctrl);

848 i‡(
îr‹
)

849 
out_°›_queue
;

853 
out_°›_queue
:

854 
	`nvme_rdma_°›_queue
(&
˘æ
->
queues
[0]);

855 
out_˛ónup_queue
:

856 i‡(
√w
)

857 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
admö_q
);

858 
out_‰ì_èg£t
:

859 i‡(
√w
)

860 
	`nvme_rdma_‰ì_èg£t
(&
˘æ
->˘æ, cål->˘æ.
admö_èg£t
);

861 
out_‰ì_async_qe
:

862 
	`nvme_rdma_‰ì_qe
(
˘æ
->
devi˚
->
dev
, &˘æ->
async_evít_sqe
,

863 (
nvme_comm™d
), 
DMA_TO_DEVICE
);

864 
˘æ
->
async_evít_sqe
.
d©a
 = 
NULL
;

865 
out_‰ì_queue
:

866 
	`nvme_rdma_‰ì_queue
(&
˘æ
->
queues
[0]);

867  
îr‹
;

868 
	}
}

870 
	$nvme_rdma_de°roy_io_queues
(
nvme_rdma_˘æ
 *
˘æ
,

871 
boﬁ
 
ªmove
)

873 i‡(
ªmove
) {

874 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
c⁄√˘_q
);

875 
	`nvme_rdma_‰ì_èg£t
(&
˘æ
->˘æ, cål->˘æ.
èg£t
);

877 
	`nvme_rdma_‰ì_io_queues
(
˘æ
);

878 
	}
}

880 
	$nvme_rdma_c⁄figuª_io_queues
(
nvme_rdma_˘æ
 *
˘æ
, 
boﬁ
 
√w
)

882 
ªt
;

884 
ªt
 = 
	`nvme_rdma_Æloc_io_queues
(
˘æ
);

885 i‡(
ªt
)

886  
ªt
;

888 i‡(
√w
) {

889 
˘æ
->˘æ.
èg£t
 = 
	`nvme_rdma_Æloc_èg£t
(&˘æ->˘æ, 
Ál£
);

890 i‡(
	`IS_ERR
(
˘æ
->˘æ.
èg£t
)) {

891 
ªt
 = 
	`PTR_ERR
(
˘æ
->˘æ.
èg£t
);

892 
out_‰ì_io_queues
;

895 
˘æ
->˘æ.
c⁄√˘_q
 = 
	`blk_mq_öô_queue
(&˘æ->
èg_£t
);

896 i‡(
	`IS_ERR
(
˘æ
->˘æ.
c⁄√˘_q
)) {

897 
ªt
 = 
	`PTR_ERR
(
˘æ
->˘æ.
c⁄√˘_q
);

898 
out_‰ì_èg_£t
;

901 
	`blk_mq_upd©e_ƒ_hw_queues
(&
˘æ
->
èg_£t
,

902 
˘æ
->˘æ.
queue_cou¡
 - 1);

905 
ªt
 = 
	`nvme_rdma_°¨t_io_queues
(
˘æ
);

906 i‡(
ªt
)

907 
out_˛ónup_c⁄√˘_q
;

911 
out_˛ónup_c⁄√˘_q
:

912 i‡(
√w
)

913 
	`blk_˛ónup_queue
(
˘æ
->˘æ.
c⁄√˘_q
);

914 
out_‰ì_èg_£t
:

915 i‡(
√w
)

916 
	`nvme_rdma_‰ì_èg£t
(&
˘æ
->˘æ, cål->˘æ.
èg£t
);

917 
out_‰ì_io_queues
:

918 
	`nvme_rdma_‰ì_io_queues
(
˘æ
);

919  
ªt
;

920 
	}
}

922 
	$nvme_rdma_ã¨down_admö_queue
(
nvme_rdma_˘æ
 *
˘æ
,

923 
boﬁ
 
ªmove
)

925 
	`blk_mq_quõs˚_queue
(
˘æ
->˘æ.
admö_q
);

926 
	`nvme_rdma_°›_queue
(&
˘æ
->
queues
[0]);

927 i‡(
˘æ
->˘æ.
admö_èg£t
)

928 
	`blk_mq_èg£t_busy_ôî
(
˘æ
->˘æ.
admö_èg£t
,

929 
nvme_ˇn˚l_ªque°
, &
˘æ
->ctrl);

930 
	`blk_mq_unquõs˚_queue
(
˘æ
->˘æ.
admö_q
);

931 
	`nvme_rdma_de°roy_admö_queue
(
˘æ
, 
ªmove
);

932 
	}
}

934 
	$nvme_rdma_ã¨down_io_queues
(
nvme_rdma_˘æ
 *
˘æ
,

935 
boﬁ
 
ªmove
)

937 i‡(
˘æ
->˘æ.
queue_cou¡
 > 1) {

938 
	`nvme_°›_queues
(&
˘æ
->ctrl);

939 
	`nvme_rdma_°›_io_queues
(
˘æ
);

940 i‡(
˘æ
->˘æ.
èg£t
)

941 
	`blk_mq_èg£t_busy_ôî
(
˘æ
->˘æ.
èg£t
,

942 
nvme_ˇn˚l_ªque°
, &
˘æ
->ctrl);

943 i‡(
ªmove
)

944 
	`nvme_°¨t_queues
(&
˘æ
->ctrl);

945 
	`nvme_rdma_de°roy_io_queues
(
˘æ
, 
ªmove
);

947 
	}
}

949 
	$nvme_rdma_‰ì_˘æ
(
nvme_˘æ
 *
n˘æ
)

951 
nvme_rdma_˘æ
 *
˘æ
 = 
	`to_rdma_˘æ
(
n˘æ
);

953 i‡(
	`li°_em±y
(&
˘æ
->
li°
))

954 
‰ì_˘æ
;

956 
	`muãx_lock
(&
nvme_rdma_˘æ_muãx
);

957 
	`li°_dñ
(&
˘æ
->
li°
);

958 
	`muãx_u∆ock
(&
nvme_rdma_˘æ_muãx
);

960 
	`nvmf_‰ì_›ti⁄s
(
n˘æ
->
›ts
);

961 
‰ì_˘æ
:

962 
	`k‰ì
(
˘æ
->
queues
);

963 
	`k‰ì
(
˘æ
);

964 
	}
}

966 
	$nvme_rdma_ªc⁄√˘_‹_ªmove
(
nvme_rdma_˘æ
 *
˘æ
)

969 i‡(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_CONNECTING
) {

970 
	`WARN_ON_ONCE
(
˘æ
->˘æ.
°©e
 =
NVME_CTRL_NEW
 ||

971 
˘æ
->˘æ.
°©e
 =
NVME_CTRL_LIVE
);

975 i‡(
	`nvmf_should_ªc⁄√˘
(&
˘æ
->ctrl)) {

976 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
, "Reconnecting in %d seconds...\n",

977 
˘æ
->˘æ.
›ts
->
ªc⁄√˘_dñay
);

978 
	`queue_dñayed_w‹k
(
nvme_wq
, &
˘æ
->
ªc⁄√˘_w‹k
,

979 
˘æ
->˘æ.
›ts
->
ªc⁄√˘_dñay
 * 
HZ
);

981 
	`nvme_dñëe_˘æ
(&
˘æ
->ctrl);

983 
	}
}

985 
	$nvme_rdma_£tup_˘æ
(
nvme_rdma_˘æ
 *
˘æ
, 
boﬁ
 
√w
)

987 
ªt
 = -
EINVAL
;

988 
boﬁ
 
ch™ged
;

990 
ªt
 = 
	`nvme_rdma_c⁄figuª_admö_queue
(
˘æ
, 
√w
);

991 i‡(
ªt
)

992  
ªt
;

994 i‡(
˘æ
->˘æ.
icdoff
) {

995 
	`dev_îr
(
˘æ
->˘æ.
devi˚
, "icdoff isÇot supported!\n");

996 
de°roy_admö
;

999 i‡(!(
˘æ
->˘æ.
sgls
 & (1 << 2))) {

1000 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1002 
de°roy_admö
;

1005 i‡(
˘æ
->˘æ.
›ts
->
queue_size
 > cål->˘æ.
sqsize
 + 1) {

1006 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

1008 
˘æ
->˘æ.
›ts
->
queue_size
, cål->˘æ.
sqsize
 + 1);

1011 i‡(
˘æ
->˘æ.
sqsize
 + 1 > cål->˘æ.
maxcmd
) {

1012 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

1014 
˘æ
->˘æ.
sqsize
 + 1, cål->˘æ.
maxcmd
);

1015 
˘æ
->˘æ.
sqsize
 = cål->˘æ.
maxcmd
 - 1;

1018 i‡(
˘æ
->˘æ.
sgls
 & (1 << 20))

1019 
˘æ
->
u£_ölöe_d©a
 = 
åue
;

1021 i‡(
˘æ
->˘æ.
queue_cou¡
 > 1) {

1022 
ªt
 = 
	`nvme_rdma_c⁄figuª_io_queues
(
˘æ
, 
√w
);

1023 i‡(
ªt
)

1024 
de°roy_admö
;

1027 
ch™ged
 = 
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_LIVE
);

1028 i‡(!
ch™ged
) {

1030 
	`WARN_ON_ONCE
(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_DELETING
);

1031 
ªt
 = -
EINVAL
;

1032 
de°roy_io
;

1035 
	`nvme_°¨t_˘æ
(&
˘æ
->ctrl);

1038 
de°roy_io
:

1039 i‡(
˘æ
->˘æ.
queue_cou¡
 > 1)

1040 
	`nvme_rdma_de°roy_io_queues
(
˘æ
, 
√w
);

1041 
de°roy_admö
:

1042 
	`nvme_rdma_°›_queue
(&
˘æ
->
queues
[0]);

1043 
	`nvme_rdma_de°roy_admö_queue
(
˘æ
, 
√w
);

1044  
ªt
;

1045 
	}
}

1047 
	$nvme_rdma_ªc⁄√˘_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1049 
nvme_rdma_˘æ
 *
˘æ
 = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w‹k
),

1050 
nvme_rdma_˘æ
, 
ªc⁄√˘_w‹k
);

1052 ++
˘æ
->˘æ.
ƒ_ªc⁄√˘s
;

1054 i‡(
	`nvme_rdma_£tup_˘æ
(
˘æ
, 
Ál£
))

1055 
ªqueue
;

1057 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
, "SuccessfullyÑeconnected (%dáttempts)\n",

1058 
˘æ
->˘æ.
ƒ_ªc⁄√˘s
);

1060 
˘æ
->˘æ.
ƒ_ªc⁄√˘s
 = 0;

1064 
ªqueue
:

1065 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
, "FailedÑeconnectáttempt %d\n",

1066 
˘æ
->˘æ.
ƒ_ªc⁄√˘s
);

1067 
	`nvme_rdma_ªc⁄√˘_‹_ªmove
(
˘æ
);

1068 
	}
}

1070 
	$nvme_rdma_îr‹_ªcovîy_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1072 
nvme_rdma_˘æ
 *
˘æ
 = 
	`c⁄èöî_of
(
w‹k
,

1073 
nvme_rdma_˘æ
, 
îr_w‹k
);

1075 
	`nvme_°›_kìp_Æive
(&
˘æ
->ctrl);

1076 
	`nvme_rdma_ã¨down_io_queues
(
˘æ
, 
Ál£
);

1077 
	`nvme_°¨t_queues
(&
˘æ
->ctrl);

1078 
	`nvme_rdma_ã¨down_admö_queue
(
˘æ
, 
Ál£
);

1080 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_CONNECTING
)) {

1082 
	`WARN_ON_ONCE
(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_DELETING
);

1086 
	`nvme_rdma_ªc⁄√˘_‹_ªmove
(
˘æ
);

1087 
	}
}

1089 
	$nvme_rdma_îr‹_ªcovîy
(
nvme_rdma_˘æ
 *
˘æ
)

1091 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_RESETTING
))

1094 
	`queue_w‹k
(
nvme_wq
, &
˘æ
->
îr_w‹k
);

1095 
	}
}

1097 
	$nvme_rdma_wr_îr‹
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
,

1098 c⁄° *
›
)

1100 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_c⁄ãxt
;

1101 
nvme_rdma_˘æ
 *
˘æ
 = 
queue
->ctrl;

1103 i‡(
˘æ
->˘æ.
°©e
 =
NVME_CTRL_LIVE
)

1104 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

1106 
›
, 
wc
->
wr_cqe
,

1107 
	`ib_wc_°©us_msg
(
wc
->
°©us
), wc->status);

1108 
	`nvme_rdma_îr‹_ªcovîy
(
˘æ
);

1109 
	}
}

1111 
	$nvme_rdma_memªg_d⁄e
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1113 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
))

1114 
	`nvme_rdma_wr_îr‹
(
cq
, 
wc
, "MEMREG");

1115 
	}
}

1117 
	$nvme_rdma_öv_rkey_d⁄e
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1119 
nvme_rdma_ªque°
 *
ªq
 =

1120 
	`c⁄èöî_of
(
wc
->
wr_cqe
, 
nvme_rdma_ªque°
, 
ªg_cqe
);

1121 
ªque°
 *
rq
 = 
	`blk_mq_rq_‰om_pdu
(
ªq
);

1123 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

1124 
	`nvme_rdma_wr_îr‹
(
cq
, 
wc
, "LOCAL_INV");

1128 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ªq
->
ªf
))

1129 
	`nvme_íd_ªque°
(
rq
, 
ªq
->
°©us
,Ñeq->
ªsu…
);

1131 
	}
}

1133 
	$nvme_rdma_öv_rkey
(
nvme_rdma_queue
 *
queue
,

1134 
nvme_rdma_ªque°
 *
ªq
)

1136 
ib_£nd_wr
 
wr
 = {

1137 .
›code
 = 
IB_WR_LOCAL_INV
,

1138 .
√xt
 = 
NULL
,

1139 .
num_sge
 = 0,

1140 .
£nd_Êags
 = 
IB_SEND_SIGNALED
,

1141 .
ex
.
övÆid©e_rkey
 = 
ªq
->
mr
->
rkey
,

1144 
ªq
->
ªg_cqe
.
d⁄e
 = 
nvme_rdma_öv_rkey_d⁄e
;

1145 
wr
.
wr_cqe
 = &
ªq
->
ªg_cqe
;

1147  
	`ib_po°_£nd
(
queue
->
qp
, &
wr
, 
NULL
);

1148 
	}
}

1150 
	$nvme_rdma_unm≠_d©a
(
nvme_rdma_queue
 *
queue
,

1151 
ªque°
 *
rq
)

1153 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1154 
nvme_rdma_devi˚
 *
dev
 = 
queue
->
devi˚
;

1155 
ib_devi˚
 *
ibdev
 = 
dev
->dev;

1157 i‡(!
	`blk_rq_ƒ_phys_£gmíts
(
rq
))

1160 i‡(
ªq
->
mr
) {

1161 
	`ib_mr_poﬁ_put
(
queue
->
qp
, &queue->qp->
rdma_mrs
, 
ªq
->
mr
);

1162 
ªq
->
mr
 = 
NULL
;

1165 
	`ib_dma_unm≠_sg
(
ibdev
, 
ªq
->
sg_èbÀ
.
sgl
,

1166 
ªq
->
√¡s
, 
	`rq_d©a_dú
(
rq
) ==

1167 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1169 
	`nvme_˛ónup_cmd
(
rq
);

1170 
	`sg_‰ì_èbÀ_chaöed
(&
ªq
->
sg_èbÀ
, 
åue
);

1171 
	}
}

1173 
	$nvme_rdma_£t_sg_nuŒ
(
nvme_comm™d
 *
c
)

1175 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
ksgl
;

1177 
sg
->
addr
 = 0;

1178 
	`put_u«lig√d_À24
(0, 
sg
->
Àngth
);

1179 
	`put_u«lig√d_À32
(0, 
sg
->
key
);

1180 
sg
->
ty≥
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

1182 
	}
}

1184 
	$nvme_rdma_m≠_sg_ölöe
(
nvme_rdma_queue
 *
queue
,

1185 
nvme_rdma_ªque°
 *
ªq
, 
nvme_comm™d
 *
c
,

1186 
cou¡
)

1188 
nvme_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
sgl
;

1189 
sˇâîli°
 *
sgl
 = 
ªq
->
sg_èbÀ
.sgl;

1190 
ib_sge
 *
sge
 = &
ªq
->sge[1];

1191 
u32
 
Àn
 = 0;

1192 
i
;

1194 
i
 = 0; i < 
cou¡
; i++, 
sgl
++, 
sge
++) {

1195 
sge
->
addr
 = 
	`sg_dma_addªss
(
sgl
);

1196 
sge
->
Àngth
 = 
	`sg_dma_Àn
(
sgl
);

1197 
sge
->
lkey
 = 
queue
->
devi˚
->
pd
->
loˇl_dma_lkey
;

1198 
Àn
 +
sge
->
Àngth
;

1201 
sg
->
addr
 = 
	`˝u_to_À64
(
queue
->
˘æ
->˘æ.
icdoff
);

1202 
sg
->
Àngth
 = 
	`˝u_to_À32
(
Àn
);

1203 
sg
->
ty≥
 = (
NVME_SGL_FMT_DATA_DESC
 << 4Ë| 
NVME_SGL_FMT_OFFSET
;

1205 
ªq
->
num_sge
 +
cou¡
;

1207 
	}
}

1209 
	$nvme_rdma_m≠_sg_sögÀ
(
nvme_rdma_queue
 *
queue
,

1210 
nvme_rdma_ªque°
 *
ªq
, 
nvme_comm™d
 *
c
)

1212 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
ksgl
;

1214 
sg
->
addr
 = 
	`˝u_to_À64
(
	`sg_dma_addªss
(
ªq
->
sg_èbÀ
.
sgl
));

1215 
	`put_u«lig√d_À24
(
	`sg_dma_Àn
(
ªq
->
sg_èbÀ
.
sgl
), 
sg
->
Àngth
);

1216 
	`put_u«lig√d_À32
(
queue
->
devi˚
->
pd
->
unß„_globÆ_rkey
, 
sg
->
key
);

1217 
sg
->
ty≥
 = 
NVME_KEY_SGL_FMT_DATA_DESC
 << 4;

1219 
	}
}

1221 
	$nvme_rdma_m≠_sg_‰
(
nvme_rdma_queue
 *
queue
,

1222 
nvme_rdma_ªque°
 *
ªq
, 
nvme_comm™d
 *
c
,

1223 
cou¡
)

1225 
nvme_keyed_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
ksgl
;

1226 
ƒ
;

1228 
ªq
->
mr
 = 
	`ib_mr_poﬁ_gë
(
queue
->
qp
, &queue->qp->
rdma_mrs
);

1229 i‡(
	`WARN_ON_ONCE
(!
ªq
->
mr
))

1230  -
EAGAIN
;

1236 
ƒ
 = 
	`ib_m≠_mr_sg
(
ªq
->
mr
,Ñeq->
sg_èbÀ
.
sgl
, 
cou¡
, 
NULL
, 
SZ_4K
);

1237 i‡(
	`u∆ikñy
(
ƒ
 < 
cou¡
)) {

1238 
	`ib_mr_poﬁ_put
(
queue
->
qp
, &queue->qp->
rdma_mrs
, 
ªq
->
mr
);

1239 
ªq
->
mr
 = 
NULL
;

1240 i‡(
ƒ
 < 0)

1241  
ƒ
;

1242  -
EINVAL
;

1245 
	`ib_upd©e_Á°_ªg_key
(
ªq
->
mr
, 
	`ib_öc_rkey
‘eq->mr->
rkey
));

1247 
ªq
->
ªg_cqe
.
d⁄e
 = 
nvme_rdma_memªg_d⁄e
;

1248 
	`mem£t
(&
ªq
->
ªg_wr
, 0, (req->reg_wr));

1249 
ªq
->
ªg_wr
.
wr
.
›code
 = 
IB_WR_REG_MR
;

1250 
ªq
->
ªg_wr
.
wr
.
wr_cqe
 = &ªq->
ªg_cqe
;

1251 
ªq
->
ªg_wr
.
wr
.
num_sge
 = 0;

1252 
ªq
->
ªg_wr
.
mr
 =Ñeq->mr;

1253 
ªq
->
ªg_wr
.
key
 =Ñeq->
mr
->
rkey
;

1254 
ªq
->
ªg_wr
.
ac˚ss
 = 
IB_ACCESS_LOCAL_WRITE
 |

1255 
IB_ACCESS_REMOTE_READ
 |

1256 
IB_ACCESS_REMOTE_WRITE
;

1258 
sg
->
addr
 = 
	`˝u_to_À64
(
ªq
->
mr
->
iova
);

1259 
	`put_u«lig√d_À24
(
ªq
->
mr
->
Àngth
, 
sg
->length);

1260 
	`put_u«lig√d_À32
(
ªq
->
mr
->
rkey
, 
sg
->
key
);

1261 
sg
->
ty≥
 = (
NVME_KEY_SGL_FMT_DATA_DESC
 << 4) |

1262 
NVME_SGL_FMT_INVALIDATE
;

1265 
	}
}

1267 
	$nvme_rdma_m≠_d©a
(
nvme_rdma_queue
 *
queue
,

1268 
ªque°
 *
rq
, 
nvme_comm™d
 *
c
)

1270 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1271 
nvme_rdma_devi˚
 *
dev
 = 
queue
->
devi˚
;

1272 
ib_devi˚
 *
ibdev
 = 
dev
->dev;

1273 
cou¡
, 
ªt
;

1275 
ªq
->
num_sge
 = 1;

1276 
	`ªfcou¡_£t
(&
ªq
->
ªf
, 2);

1278 
c
->
comm⁄
.
Êags
 |
NVME_CMD_SGL_METABUF
;

1280 i‡(!
	`blk_rq_ƒ_phys_£gmíts
(
rq
))

1281  
	`nvme_rdma_£t_sg_nuŒ
(
c
);

1283 
ªq
->
sg_èbÀ
.
sgl
 =Ñeq->
fú°_sgl
;

1284 
ªt
 = 
	`sg_Æloc_èbÀ_chaöed
(&
ªq
->
sg_èbÀ
,

1285 
	`blk_rq_ƒ_phys_£gmíts
(
rq
), 
ªq
->
sg_èbÀ
.
sgl
);

1286 i‡(
ªt
)

1287  -
ENOMEM
;

1289 
ªq
->
√¡s
 = 
	`blk_rq_m≠_sg
(
rq
->
q
,Ñq,Ñeq->
sg_èbÀ
.
sgl
);

1291 
cou¡
 = 
	`ib_dma_m≠_sg
(
ibdev
, 
ªq
->
sg_èbÀ
.
sgl
,Ñeq->
√¡s
,

1292 
	`rq_d©a_dú
(
rq
Ë=
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1293 i‡(
	`u∆ikñy
(
cou¡
 <= 0)) {

1294 
ªt
 = -
EIO
;

1295 
out_‰ì_èbÀ
;

1298 i‡(
cou¡
 <
dev
->
num_ölöe_£gmíts
) {

1299 i‡(
	`rq_d©a_dú
(
rq
Ë=
WRITE
 && 
	`nvme_rdma_queue_idx
(
queue
) &&

1300 
queue
->
˘æ
->
u£_ölöe_d©a
 &&

1301 
	`blk_rq_∑ylﬂd_byãs
(
rq
) <=

1302 
	`nvme_rdma_ölöe_d©a_size
(
queue
)) {

1303 
ªt
 = 
	`nvme_rdma_m≠_sg_ölöe
(
queue
, 
ªq
, 
c
, 
cou¡
);

1304 
out
;

1307 i‡(
cou¡
 =1 && 
dev
->
pd
->
Êags
 & 
IB_PD_UNSAFE_GLOBAL_RKEY
) {

1308 
ªt
 = 
	`nvme_rdma_m≠_sg_sögÀ
(
queue
, 
ªq
, 
c
);

1309 
out
;

1313 
ªt
 = 
	`nvme_rdma_m≠_sg_‰
(
queue
, 
ªq
, 
c
, 
cou¡
);

1314 
out
:

1315 i‡(
	`u∆ikñy
(
ªt
))

1316 
out_unm≠_sg
;

1320 
out_unm≠_sg
:

1321 
	`ib_dma_unm≠_sg
(
ibdev
, 
ªq
->
sg_èbÀ
.
sgl
,

1322 
ªq
->
√¡s
, 
	`rq_d©a_dú
(
rq
) ==

1323 
WRITE
 ? 
DMA_TO_DEVICE
 : 
DMA_FROM_DEVICE
);

1324 
out_‰ì_èbÀ
:

1325 
	`sg_‰ì_èbÀ_chaöed
(&
ªq
->
sg_èbÀ
, 
åue
);

1326  
ªt
;

1327 
	}
}

1329 
	$nvme_rdma_£nd_d⁄e
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1331 
nvme_rdma_qe
 *
qe
 =

1332 
	`c⁄èöî_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1333 
nvme_rdma_ªque°
 *
ªq
 =

1334 
	`c⁄èöî_of
(
qe
, 
nvme_rdma_ªque°
, 
sqe
);

1335 
ªque°
 *
rq
 = 
	`blk_mq_rq_‰om_pdu
(
ªq
);

1337 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

1338 
	`nvme_rdma_wr_îr‹
(
cq
, 
wc
, "SEND");

1342 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ªq
->
ªf
))

1343 
	`nvme_íd_ªque°
(
rq
, 
ªq
->
°©us
,Ñeq->
ªsu…
);

1344 
	}
}

1346 
	$nvme_rdma_po°_£nd
(
nvme_rdma_queue
 *
queue
,

1347 
nvme_rdma_qe
 *
qe
, 
ib_sge
 *
sge
, 
u32
 
num_sge
,

1348 
ib_£nd_wr
 *
fú°
)

1350 
ib_£nd_wr
 
wr
;

1351 
ªt
;

1353 
sge
->
addr
 = 
qe
->
dma
;

1354 
sge
->
Àngth
 = (
nvme_comm™d
),

1355 
sge
->
lkey
 = 
queue
->
devi˚
->
pd
->
loˇl_dma_lkey
;

1357 
wr
.
√xt
 = 
NULL
;

1358 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1359 
wr
.
sg_li°
 = 
sge
;

1360 
wr
.
num_sge
 =Çum_sge;

1361 
wr
.
›code
 = 
IB_WR_SEND
;

1362 
wr
.
£nd_Êags
 = 
IB_SEND_SIGNALED
;

1364 i‡(
fú°
)

1365 
fú°
->
√xt
 = &
wr
;

1367 
fú°
 = &
wr
;

1369 
ªt
 = 
	`ib_po°_£nd
(
queue
->
qp
, 
fú°
, 
NULL
);

1370 i‡(
	`u∆ikñy
(
ªt
)) {

1371 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1372 "%†Áûed wôhÉº‹ codê%d\n", 
__func__
, 
ªt
);

1374  
ªt
;

1375 
	}
}

1377 
	$nvme_rdma_po°_ªcv
(
nvme_rdma_queue
 *
queue
,

1378 
nvme_rdma_qe
 *
qe
)

1380 
ib_ªcv_wr
 
wr
;

1381 
ib_sge
 
li°
;

1382 
ªt
;

1384 
li°
.
addr
 = 
qe
->
dma
;

1385 
li°
.
Àngth
 = (
nvme_com∂ëi⁄
);

1386 
li°
.
lkey
 = 
queue
->
devi˚
->
pd
->
loˇl_dma_lkey
;

1388 
qe
->
cqe
.
d⁄e
 = 
nvme_rdma_ªcv_d⁄e
;

1390 
wr
.
√xt
 = 
NULL
;

1391 
wr
.
wr_cqe
 = &
qe
->
cqe
;

1392 
wr
.
sg_li°
 = &
li°
;

1393 
wr
.
num_sge
 = 1;

1395 
ªt
 = 
	`ib_po°_ªcv
(
queue
->
qp
, &
wr
, 
NULL
);

1396 i‡(
	`u∆ikñy
(
ªt
)) {

1397 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1398 "%†Áûed wôhÉº‹ codê%d\n", 
__func__
, 
ªt
);

1400  
ªt
;

1401 
	}
}

1403 
blk_mq_ègs
 *
	$nvme_rdma_èg£t
(
nvme_rdma_queue
 *
queue
)

1405 
u32
 
queue_idx
 = 
	`nvme_rdma_queue_idx
(
queue
);

1407 i‡(
queue_idx
 == 0)

1408  
queue
->
˘æ
->
admö_èg_£t
.
ègs
[
queue_idx
];

1409  
queue
->
˘æ
->
èg_£t
.
ègs
[
queue_idx
 - 1];

1410 
	}
}

1412 
	$nvme_rdma_async_d⁄e
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1414 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
))

1415 
	`nvme_rdma_wr_îr‹
(
cq
, 
wc
, "ASYNC");

1416 
	}
}

1418 
	$nvme_rdma_submô_async_evít
(
nvme_˘æ
 *
¨g
)

1420 
nvme_rdma_˘æ
 *
˘æ
 = 
	`to_rdma_˘æ
(
¨g
);

1421 
nvme_rdma_queue
 *
queue
 = &
˘æ
->
queues
[0];

1422 
ib_devi˚
 *
dev
 = 
queue
->
devi˚
->dev;

1423 
nvme_rdma_qe
 *
sqe
 = &
˘æ
->
async_evít_sqe
;

1424 
nvme_comm™d
 *
cmd
 = 
sqe
->
d©a
;

1425 
ib_sge
 
sge
;

1426 
ªt
;

1428 
	`ib_dma_sync_sögÀ_f‹_˝u
(
dev
, 
sqe
->
dma
, (*
cmd
), 
DMA_TO_DEVICE
);

1430 
	`mem£t
(
cmd
, 0, (*cmd));

1431 
cmd
->
comm⁄
.
›code
 = 
nvme_admö_async_evít
;

1432 
cmd
->
comm⁄
.
comm™d_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1433 
cmd
->
comm⁄
.
Êags
 |
NVME_CMD_SGL_METABUF
;

1434 
	`nvme_rdma_£t_sg_nuŒ
(
cmd
);

1436 
sqe
->
cqe
.
d⁄e
 = 
nvme_rdma_async_d⁄e
;

1438 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
dev
, 
sqe
->
dma
, (*
cmd
),

1439 
DMA_TO_DEVICE
);

1441 
ªt
 = 
	`nvme_rdma_po°_£nd
(
queue
, 
sqe
, &
sge
, 1, 
NULL
);

1442 
	`WARN_ON_ONCE
(
ªt
);

1443 
	}
}

1445 
	$nvme_rdma_¥o˚ss_nvme_r•
(
nvme_rdma_queue
 *
queue
,

1446 
nvme_com∂ëi⁄
 *
cqe
, 
ib_wc
 *
wc
)

1448 
ªque°
 *
rq
;

1449 
nvme_rdma_ªque°
 *
ªq
;

1451 
rq
 = 
	`blk_mq_èg_to_rq
(
	`nvme_rdma_èg£t
(
queue
), 
cqe
->
comm™d_id
);

1452 i‡(!
rq
) {

1453 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1455 
cqe
->
comm™d_id
, 
queue
->
qp
->
qp_num
);

1456 
	`nvme_rdma_îr‹_ªcovîy
(
queue
->
˘æ
);

1459 
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1461 
ªq
->
°©us
 = 
cqe
->status;

1462 
ªq
->
ªsu…
 = 
cqe
->result;

1464 i‡(
wc
->
wc_Êags
 & 
IB_WC_WITH_INVALIDATE
) {

1465 i‡(
	`u∆ikñy
(
wc
->
ex
.
övÆid©e_rkey
 !
ªq
->
mr
->
rkey
)) {

1466 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1468 
ªq
->
mr
->
rkey
);

1469 
	`nvme_rdma_îr‹_ªcovîy
(
queue
->
˘æ
);

1471 } i‡(
ªq
->
mr
) {

1472 
ªt
;

1474 
ªt
 = 
	`nvme_rdma_öv_rkey
(
queue
, 
ªq
);

1475 i‡(
	`u∆ikñy
(
ªt
 < 0)) {

1476 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1478 
ªq
->
mr
->
rkey
, 
ªt
);

1479 
	`nvme_rdma_îr‹_ªcovîy
(
queue
->
˘æ
);

1485 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ªq
->
ªf
))

1486 
	`nvme_íd_ªque°
(
rq
, 
ªq
->
°©us
,Ñeq->
ªsu…
);

1487 
	}
}

1489 
	$nvme_rdma_ªcv_d⁄e
(
ib_cq
 *
cq
, 
ib_wc
 *
wc
)

1491 
nvme_rdma_qe
 *
qe
 =

1492 
	`c⁄èöî_of
(
wc
->
wr_cqe
, 
nvme_rdma_qe
, 
cqe
);

1493 
nvme_rdma_queue
 *
queue
 = 
cq
->
cq_c⁄ãxt
;

1494 
ib_devi˚
 *
ibdev
 = 
queue
->
devi˚
->
dev
;

1495 
nvme_com∂ëi⁄
 *
cqe
 = 
qe
->
d©a
;

1496 c⁄° 
size_t
 
Àn
 = (
nvme_com∂ëi⁄
);

1498 i‡(
	`u∆ikñy
(
wc
->
°©us
 !
IB_WC_SUCCESS
)) {

1499 
	`nvme_rdma_wr_îr‹
(
cq
, 
wc
, "RECV");

1503 
	`ib_dma_sync_sögÀ_f‹_˝u
(
ibdev
, 
qe
->
dma
, 
Àn
, 
DMA_FROM_DEVICE
);

1510 i‡(
	`u∆ikñy
(
	`nvme_rdma_queue_idx
(
queue
) == 0 &&

1511 
cqe
->
comm™d_id
 >
NVME_AQ_BLK_MQ_DEPTH
))

1512 
	`nvme_com∂ëe_async_evít
(&
queue
->
˘æ
->˘æ, 
cqe
->
°©us
,

1513 &
cqe
->
ªsu…
);

1515 
	`nvme_rdma_¥o˚ss_nvme_r•
(
queue
, 
cqe
, 
wc
);

1516 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
ibdev
, 
qe
->
dma
, 
Àn
, 
DMA_FROM_DEVICE
);

1518 
	`nvme_rdma_po°_ªcv
(
queue
, 
qe
);

1519 
	}
}

1521 
	$nvme_rdma_c⁄n_e°ablished
(
nvme_rdma_queue
 *
queue
)

1523 
ªt
, 
i
;

1525 
i
 = 0; i < 
queue
->
queue_size
; i++) {

1526 
ªt
 = 
	`nvme_rdma_po°_ªcv
(
queue
, &queue->
r•_rög
[
i
]);

1527 i‡(
ªt
)

1528 
out_de°roy_queue_ib
;

1533 
out_de°roy_queue_ib
:

1534 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

1535  
ªt
;

1536 
	}
}

1538 
	$nvme_rdma_c⁄n_ªje˘ed
(
nvme_rdma_queue
 *
queue
,

1539 
rdma_cm_evít
 *
ev
)

1541 
rdma_cm_id
 *
cm_id
 = 
queue
->cm_id;

1542 
°©us
 = 
ev
->status;

1543 c⁄° *
ªj_msg
;

1544 c⁄° 
nvme_rdma_cm_ªj
 *
ªj_d©a
;

1545 
u8
 
ªj_d©a_Àn
;

1547 
ªj_msg
 = 
	`rdma_ªje˘_msg
(
cm_id
, 
°©us
);

1548 
ªj_d©a
 = 
	`rdma_c⁄sumî_ªje˘_d©a
(
cm_id
, 
ev
, &
ªj_d©a_Àn
);

1550 i‡(
ªj_d©a
 && 
ªj_d©a_Àn
 >(
u16
)) {

1551 
u16
 
°s
 = 
	`À16_to_˝u
(
ªj_d©a
->sts);

1553 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1555 
°©us
, 
ªj_msg
, 
°s
, 
	`nvme_rdma_cm_msg
(sts));

1557 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1558 "C⁄√˘Ñeje˘ed: sètu†%d (%s).\n", 
°©us
, 
ªj_msg
);

1561  -
ECONNRESET
;

1562 
	}
}

1564 
	$nvme_rdma_addr_ªsﬁved
(
nvme_rdma_queue
 *
queue
)

1566 
ªt
;

1568 
ªt
 = 
	`nvme_rdma_¸óã_queue_ib
(
queue
);

1569 i‡(
ªt
)

1570  
ªt
;

1572 
ªt
 = 
	`rdma_ªsﬁve_rouã
(
queue
->
cm_id
, 
NVME_RDMA_CONNECT_TIMEOUT_MS
);

1573 i‡(
ªt
) {

1574 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1576 
queue
->
cm_îr‹
);

1577 
out_de°roy_queue
;

1582 
out_de°roy_queue
:

1583 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

1584  
ªt
;

1585 
	}
}

1587 
	$nvme_rdma_rouã_ªsﬁved
(
nvme_rdma_queue
 *
queue
)

1589 
nvme_rdma_˘æ
 *
˘æ
 = 
queue
->ctrl;

1590 
rdma_c⁄n_∑øm
 
∑øm
 = { };

1591 
nvme_rdma_cm_ªq
 
¥iv
 = { };

1592 
ªt
;

1594 
∑øm
.
qp_num
 = 
queue
->
qp
->qp_num;

1595 
∑øm
.
Êow_c⁄åﬁ
 = 1;

1597 
∑øm
.
ª•⁄dî_ªsour˚s
 = 
queue
->
devi˚
->
dev
->
©ås
.
max_qp_rd_©om
;

1599 
∑øm
.
ªåy_cou¡
 = 7;

1600 
∑øm
.
∫r_ªåy_cou¡
 = 7;

1601 
∑øm
.
¥iv©e_d©a
 = &
¥iv
;

1602 
∑øm
.
¥iv©e_d©a_Àn
 = (
¥iv
);

1604 
¥iv
.
ªcfmt
 = 
	`˝u_to_À16
(
NVME_RDMA_CM_FMT_1_0
);

1605 
¥iv
.
qid
 = 
	`˝u_to_À16
(
	`nvme_rdma_queue_idx
(
queue
));

1610 i‡(
¥iv
.
qid
 == 0) {

1611 
¥iv
.
hrqsize
 = 
	`˝u_to_À16
(
NVME_AQ_DEPTH
);

1612 
¥iv
.
hsqsize
 = 
	`˝u_to_À16
(
NVME_AQ_DEPTH
 - 1);

1619 
¥iv
.
hrqsize
 = 
	`˝u_to_À16
(
queue
->
queue_size
);

1620 
¥iv
.
hsqsize
 = 
	`˝u_to_À16
(
queue
->
˘æ
->˘æ.
sqsize
);

1623 
ªt
 = 
	`rdma_c⁄√˘
(
queue
->
cm_id
, &
∑øm
);

1624 i‡(
ªt
) {

1625 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1626 "rdma_c⁄√˘ faûed (%d).\n", 
ªt
);

1627 
out_de°roy_queue_ib
;

1632 
out_de°roy_queue_ib
:

1633 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

1634  
ªt
;

1635 
	}
}

1637 
	$nvme_rdma_cm_h™dÀr
(
rdma_cm_id
 *
cm_id
,

1638 
rdma_cm_evít
 *
ev
)

1640 
nvme_rdma_queue
 *
queue
 = 
cm_id
->
c⁄ãxt
;

1641 
cm_îr‹
 = 0;

1643 
	`dev_dbg
(
queue
->
˘æ
->˘æ.
devi˚
, "%s (%d): status %d id %p\n",

1644 
	`rdma_evít_msg
(
ev
->
evít
),Év->event,

1645 
ev
->
°©us
, 
cm_id
);

1647 
ev
->
evít
) {

1648 
RDMA_CM_EVENT_ADDR_RESOLVED
:

1649 
cm_îr‹
 = 
	`nvme_rdma_addr_ªsﬁved
(
queue
);

1651 
RDMA_CM_EVENT_ROUTE_RESOLVED
:

1652 
cm_îr‹
 = 
	`nvme_rdma_rouã_ªsﬁved
(
queue
);

1654 
RDMA_CM_EVENT_ESTABLISHED
:

1655 
queue
->
cm_îr‹
 = 
	`nvme_rdma_c⁄n_e°ablished
(queue);

1657 
	`com∂ëe
(&
queue
->
cm_d⁄e
);

1659 
RDMA_CM_EVENT_REJECTED
:

1660 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

1661 
cm_îr‹
 = 
	`nvme_rdma_c⁄n_ªje˘ed
(
queue
, 
ev
);

1663 
RDMA_CM_EVENT_ROUTE_ERROR
:

1664 
RDMA_CM_EVENT_CONNECT_ERROR
:

1665 
RDMA_CM_EVENT_UNREACHABLE
:

1666 
	`nvme_rdma_de°roy_queue_ib
(
queue
);

1668 
RDMA_CM_EVENT_ADDR_ERROR
:

1669 
	`dev_dbg
(
queue
->
˘æ
->˘æ.
devi˚
,

1670 "CMÉº‹Évíà%d\n", 
ev
->
evít
);

1671 
cm_îr‹
 = -
ECONNRESET
;

1673 
RDMA_CM_EVENT_DISCONNECTED
:

1674 
RDMA_CM_EVENT_ADDR_CHANGE
:

1675 
RDMA_CM_EVENT_TIMEWAIT_EXIT
:

1676 
	`dev_dbg
(
queue
->
˘æ
->˘æ.
devi˚
,

1678 
	`nvme_rdma_îr‹_ªcovîy
(
queue
->
˘æ
);

1680 
RDMA_CM_EVENT_DEVICE_REMOVAL
:

1684 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1685 "U√x≥˘ed RDMA CMÉvíà(%d)\n", 
ev
->
evít
);

1686 
	`nvme_rdma_îr‹_ªcovîy
(
queue
->
˘æ
);

1690 i‡(
cm_îr‹
) {

1691 
queue
->
cm_îr‹
 = cm_error;

1692 
	`com∂ëe
(&
queue
->
cm_d⁄e
);

1696 
	}
}

1698 
blk_eh_timî_ªtu∫


1699 
	$nvme_rdma_timeout
(
ªque°
 *
rq
, 
boﬁ
 
ª£rved
)

1701 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1702 
nvme_rdma_queue
 *
queue
 = 
ªq
->queue;

1703 
nvme_rdma_˘æ
 *
˘æ
 = 
queue
->ctrl;

1705 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
, "I/O %d QID %dÅimeout\n",

1706 
rq
->
èg
, 
	`nvme_rdma_queue_idx
(
queue
));

1708 i‡(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_LIVE
) {

1714 
	`Êush_w‹k
(&
˘æ
->
îr_w‹k
);

1715 
	`nvme_rdma_ã¨down_io_queues
(
˘æ
, 
Ál£
);

1716 
	`nvme_rdma_ã¨down_admö_queue
(
˘æ
, 
Ál£
);

1717  
BLK_EH_DONE
;

1720 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
, "startingÉrrorÑecovery\n");

1721 
	`nvme_rdma_îr‹_ªcovîy
(
˘æ
);

1723  
BLK_EH_RESET_TIMER
;

1724 
	}
}

1726 
blk_°©us_t
 
	$nvme_rdma_queue_rq
(
blk_mq_hw_˘x
 *
h˘x
,

1727 c⁄° 
blk_mq_queue_d©a
 *
bd
)

1729 
nvme_ns
 *
ns
 = 
h˘x
->
queue
->
queued©a
;

1730 
nvme_rdma_queue
 *
queue
 = 
h˘x
->
drivî_d©a
;

1731 
ªque°
 *
rq
 = 
bd
->rq;

1732 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1733 
nvme_rdma_qe
 *
sqe
 = &
ªq
->sqe;

1734 
nvme_comm™d
 *
c
 = 
sqe
->
d©a
;

1735 
ib_devi˚
 *
dev
;

1736 
boﬁ
 
queue_ªady
 = 
	`ã°_bô
(
NVME_RDMA_Q_LIVE
, &
queue
->
Êags
);

1737 
blk_°©us_t
 
ªt
;

1738 
îr
;

1740 
	`WARN_ON_ONCE
(
rq
->
èg
 < 0);

1742 i‡(!
	`nvmf_check_ªady
(&
queue
->
˘æ
->˘æ, 
rq
, 
queue_ªady
))

1743  
	`nvmf_Áû_n⁄ªady_comm™d
(&
queue
->
˘æ
->˘æ, 
rq
);

1745 
dev
 = 
queue
->
devi˚
->dev;

1746 
	`ib_dma_sync_sögÀ_f‹_˝u
(
dev
, 
sqe
->
dma
,

1747 (
nvme_comm™d
), 
DMA_TO_DEVICE
);

1749 
ªt
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, 
c
);

1750 i‡(
ªt
)

1751  
ªt
;

1753 
	`blk_mq_°¨t_ªque°
(
rq
);

1755 
îr
 = 
	`nvme_rdma_m≠_d©a
(
queue
, 
rq
, 
c
);

1756 i‡(
	`u∆ikñy
(
îr
 < 0)) {

1757 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1758 "FaûedÅÿm≠ d©®(%d)\n", 
îr
);

1759 
	`nvme_˛ónup_cmd
(
rq
);

1760 
îr
;

1763 
sqe
->
cqe
.
d⁄e
 = 
nvme_rdma_£nd_d⁄e
;

1765 
	`ib_dma_sync_sögÀ_f‹_devi˚
(
dev
, 
sqe
->
dma
,

1766 (
nvme_comm™d
), 
DMA_TO_DEVICE
);

1768 
îr
 = 
	`nvme_rdma_po°_£nd
(
queue
, 
sqe
, 
ªq
->
sge
,Ñeq->
num_sge
,

1769 
ªq
->
mr
 ? &ªq->
ªg_wr
.
wr
 : 
NULL
);

1770 i‡(
	`u∆ikñy
(
îr
)) {

1771 
	`nvme_rdma_unm≠_d©a
(
queue
, 
rq
);

1772 
îr
;

1775  
BLK_STS_OK
;

1776 
îr
:

1777 i‡(
îr
 =-
ENOMEM
 ||Éº =-
EAGAIN
)

1778  
BLK_STS_RESOURCE
;

1779  
BLK_STS_IOERR
;

1780 
	}
}

1782 
	$nvme_rdma_pﬁl
(
blk_mq_hw_˘x
 *
h˘x
)

1784 
nvme_rdma_queue
 *
queue
 = 
h˘x
->
drivî_d©a
;

1786  
	`ib_¥o˚ss_cq_dúe˘
(
queue
->
ib_cq
, -1);

1787 
	}
}

1789 
	$nvme_rdma_com∂ëe_rq
(
ªque°
 *
rq
)

1791 
nvme_rdma_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

1793 
	`nvme_rdma_unm≠_d©a
(
ªq
->
queue
, 
rq
);

1794 
	`nvme_com∂ëe_rq
(
rq
);

1795 
	}
}

1797 
	$nvme_rdma_m≠_queues
(
blk_mq_èg_£t
 *
£t
)

1799 
nvme_rdma_˘æ
 *
˘æ
 = 
£t
->
drivî_d©a
;

1800 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->ctrl.opts;

1802 i‡(
›ts
->
ƒ_wrôe_queues
 && 
˘æ
->
io_queues
[
HCTX_TYPE_READ
]) {

1804 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
ƒ_queues
 =

1805 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

1806 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
queue_off£t
 = 0;

1807 
£t
->
m≠
[
HCTX_TYPE_READ
].
ƒ_queues
 =

1808 
˘æ
->
io_queues
[
HCTX_TYPE_READ
];

1809 
£t
->
m≠
[
HCTX_TYPE_READ
].
queue_off£t
 =

1810 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

1813 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
ƒ_queues
 =

1814 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

1815 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
queue_off£t
 = 0;

1816 
£t
->
m≠
[
HCTX_TYPE_READ
].
ƒ_queues
 =

1817 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

1818 
£t
->
m≠
[
HCTX_TYPE_READ
].
queue_off£t
 = 0;

1820 
	`blk_mq_rdma_m≠_queues
(&
£t
->
m≠
[
HCTX_TYPE_DEFAULT
],

1821 
˘æ
->
devi˚
->
dev
, 0);

1822 
	`blk_mq_rdma_m≠_queues
(&
£t
->
m≠
[
HCTX_TYPE_READ
],

1823 
˘æ
->
devi˚
->
dev
, 0);

1825 i‡(
›ts
->
ƒ_pﬁl_queues
 && 
˘æ
->
io_queues
[
HCTX_TYPE_POLL
]) {

1827 
£t
->
m≠
[
HCTX_TYPE_POLL
].
ƒ_queues
 =

1828 
˘æ
->
io_queues
[
HCTX_TYPE_POLL
];

1829 
£t
->
m≠
[
HCTX_TYPE_POLL
].
queue_off£t
 =

1830 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
] +

1831 
˘æ
->
io_queues
[
HCTX_TYPE_READ
];

1832 
	`blk_mq_m≠_queues
(&
£t
->
m≠
[
HCTX_TYPE_POLL
]);

1835 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

1837 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
],

1838 
˘æ
->
io_queues
[
HCTX_TYPE_READ
],

1839 
˘æ
->
io_queues
[
HCTX_TYPE_POLL
]);

1842 
	}
}

1844 c⁄° 
blk_mq_›s
 
	gnvme_rdma_mq_›s
 = {

1845 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1846 .
	gcom∂ëe
 = 
nvme_rdma_com∂ëe_rq
,

1847 .
	göô_ªque°
 = 
nvme_rdma_öô_ªque°
,

1848 .
	gexô_ªque°
 = 
nvme_rdma_exô_ªque°
,

1849 .
	göô_h˘x
 = 
nvme_rdma_öô_h˘x
,

1850 .
	gtimeout
 = 
nvme_rdma_timeout
,

1851 .
	gm≠_queues
 = 
nvme_rdma_m≠_queues
,

1852 .
	gpﬁl
 = 
nvme_rdma_pﬁl
,

1855 c⁄° 
blk_mq_›s
 
	gnvme_rdma_admö_mq_›s
 = {

1856 .
queue_rq
 = 
nvme_rdma_queue_rq
,

1857 .
	gcom∂ëe
 = 
nvme_rdma_com∂ëe_rq
,

1858 .
	göô_ªque°
 = 
nvme_rdma_öô_ªque°
,

1859 .
	gexô_ªque°
 = 
nvme_rdma_exô_ªque°
,

1860 .
	göô_h˘x
 = 
nvme_rdma_öô_admö_h˘x
,

1861 .
	gtimeout
 = 
nvme_rdma_timeout
,

1864 
	$nvme_rdma_shutdown_˘æ
(
nvme_rdma_˘æ
 *
˘æ
, 
boﬁ
 
shutdown
)

1866 
	`ˇn˚l_w‹k_sync
(&
˘æ
->
îr_w‹k
);

1867 
	`ˇn˚l_dñayed_w‹k_sync
(&
˘æ
->
ªc⁄√˘_w‹k
);

1869 
	`nvme_rdma_ã¨down_io_queues
(
˘æ
, 
shutdown
);

1870 i‡(
shutdown
)

1871 
	`nvme_shutdown_˘æ
(&
˘æ
->ctrl);

1873 
	`nvme_dißbÀ_˘æ
(&
˘æ
->˘æ, cål->˘æ.
ˇp
);

1874 
	`nvme_rdma_ã¨down_admö_queue
(
˘æ
, 
shutdown
);

1875 
	}
}

1877 
	$nvme_rdma_dñëe_˘æ
(
nvme_˘æ
 *
˘æ
)

1879 
	`nvme_rdma_shutdown_˘æ
(
	`to_rdma_˘æ
(
˘æ
), 
åue
);

1880 
	}
}

1882 
	$nvme_rdma_ª£t_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1884 
nvme_rdma_˘æ
 *
˘æ
 =

1885 
	`c⁄èöî_of
(
w‹k
, 
nvme_rdma_˘æ
, 
˘æ
.
ª£t_w‹k
);

1887 
	`nvme_°›_˘æ
(&
˘æ
->ctrl);

1888 
	`nvme_rdma_shutdown_˘æ
(
˘æ
, 
Ál£
);

1890 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_CONNECTING
)) {

1892 
	`WARN_ON_ONCE
(1);

1896 i‡(
	`nvme_rdma_£tup_˘æ
(
˘æ
, 
Ál£
))

1897 
out_Áû
;

1901 
out_Áû
:

1902 ++
˘æ
->˘æ.
ƒ_ªc⁄√˘s
;

1903 
	`nvme_rdma_ªc⁄√˘_‹_ªmove
(
˘æ
);

1904 
	}
}

1906 c⁄° 
nvme_˘æ_›s
 
	gnvme_rdma_˘æ_›s
 = {

1907 .
«me
 = "rdma",

1908 .
	gmoduÀ
 = 
THIS_MODULE
,

1909 .
	gÊags
 = 
NVME_F_FABRICS
,

1910 .
	gªg_ªad32
 = 
nvmf_ªg_ªad32
,

1911 .
	gªg_ªad64
 = 
nvmf_ªg_ªad64
,

1912 .
	gªg_wrôe32
 = 
nvmf_ªg_wrôe32
,

1913 .
	g‰ì_˘æ
 = 
nvme_rdma_‰ì_˘æ
,

1914 .
	gsubmô_async_evít
 = 
nvme_rdma_submô_async_evít
,

1915 .
	gdñëe_˘æ
 = 
nvme_rdma_dñëe_˘æ
,

1916 .
	ggë_addªss
 = 
nvmf_gë_addªss
,

1931 
boﬁ


1932 
	$nvme_rdma_exi°ög_c⁄åﬁÀr
(
nvmf_˘æ_›ti⁄s
 *
›ts
)

1934 
nvme_rdma_˘æ
 *
˘æ
;

1935 
boﬁ
 
found
 = 
Ál£
;

1937 
	`muãx_lock
(&
nvme_rdma_˘æ_muãx
);

1938 
	`li°_f‹_óch_íåy
(
˘æ
, &
nvme_rdma_˘æ_li°
, 
li°
) {

1939 
found
 = 
	`nvmf_ù_›ti⁄s_m©ch
(&
˘æ
->˘æ, 
›ts
);

1940 i‡(
found
)

1943 
	`muãx_u∆ock
(&
nvme_rdma_˘æ_muãx
);

1945  
found
;

1946 
	}
}

1948 
nvme_˘æ
 *
	$nvme_rdma_¸óã_˘æ
(
devi˚
 *
dev
,

1949 
nvmf_˘æ_›ti⁄s
 *
›ts
)

1951 
nvme_rdma_˘æ
 *
˘æ
;

1952 
ªt
;

1953 
boﬁ
 
ch™ged
;

1955 
˘æ
 = 
	`kzÆloc
((*˘æ), 
GFP_KERNEL
);

1956 i‡(!
˘æ
)

1957  
	`ERR_PTR
(-
ENOMEM
);

1958 
˘æ
->˘æ.
›ts
 = opts;

1959 
	`INIT_LIST_HEAD
(&
˘æ
->
li°
);

1961 i‡(!(
›ts
->
mask
 & 
NVMF_OPT_TRSVCID
)) {

1962 
›ts
->
åsvcid
 =

1963 
	`k°rdup
(
	`__°rögify
(
NVME_RDMA_IP_PORT
), 
GFP_KERNEL
);

1964 i‡(!
›ts
->
åsvcid
) {

1965 
ªt
 = -
ENOMEM
;

1966 
out_‰ì_˘æ
;

1968 
›ts
->
mask
 |
NVMF_OPT_TRSVCID
;

1971 
ªt
 = 
	`öë_±⁄_wôh_sc›e
(&
öô_√t
, 
AF_UNSPEC
,

1972 
›ts
->
åaddr
, o±s->
åsvcid
, &
˘æ
->
addr
);

1973 i‡(
ªt
) {

1974 
	`¥_îr
("malformedáddressÖassed: %s:%s\n",

1975 
›ts
->
åaddr
, o±s->
åsvcid
);

1976 
out_‰ì_˘æ
;

1979 i‡(
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

1980 
ªt
 = 
	`öë_±⁄_wôh_sc›e
(&
öô_√t
, 
AF_UNSPEC
,

1981 
›ts
->
ho°_åaddr
, 
NULL
, &
˘æ
->
§c_addr
);

1982 i‡(
ªt
) {

1983 
	`¥_îr
("malformed srcáddressÖassed: %s\n",

1984 
›ts
->
ho°_åaddr
);

1985 
out_‰ì_˘æ
;

1989 i‡(!
›ts
->
du∂iˇã_c⁄√˘
 && 
	`nvme_rdma_exi°ög_c⁄åﬁÀr
(opts)) {

1990 
ªt
 = -
EALREADY
;

1991 
out_‰ì_˘æ
;

1994 
	`INIT_DELAYED_WORK
(&
˘æ
->
ªc⁄√˘_w‹k
,

1995 
nvme_rdma_ªc⁄√˘_˘æ_w‹k
);

1996 
	`INIT_WORK
(&
˘æ
->
îr_w‹k
, 
nvme_rdma_îr‹_ªcovîy_w‹k
);

1997 
	`INIT_WORK
(&
˘æ
->˘æ.
ª£t_w‹k
, 
nvme_rdma_ª£t_˘æ_w‹k
);

1999 
˘æ
->˘æ.
queue_cou¡
 = 
›ts
->
ƒ_io_queues
 + o±s->
ƒ_wrôe_queues
 +

2000 
›ts
->
ƒ_pﬁl_queues
 + 1;

2001 
˘æ
->˘æ.
sqsize
 = 
›ts
->
queue_size
 - 1;

2002 
˘æ
->˘æ.
k©o
 = 
›ts
->kato;

2004 
ªt
 = -
ENOMEM
;

2005 
˘æ
->
queues
 = 
	`kˇŒoc
(˘æ->˘æ.
queue_cou¡
, (*ctrl->queues),

2006 
GFP_KERNEL
);

2007 i‡(!
˘æ
->
queues
)

2008 
out_‰ì_˘æ
;

2010 
ªt
 = 
	`nvme_öô_˘æ
(&
˘æ
->˘æ, 
dev
, &
nvme_rdma_˘æ_›s
,

2012 i‡(
ªt
)

2013 
out_k‰ì_queues
;

2015 
ch™ged
 = 
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_CONNECTING
);

2016 
	`WARN_ON_ONCE
(!
ch™ged
);

2018 
ªt
 = 
	`nvme_rdma_£tup_˘æ
(
˘æ
, 
åue
);

2019 i‡(
ªt
)

2020 
out_unöô_˘æ
;

2022 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
, "new ctrl: NQN \"%s\",áddr %pISpcs\n",

2023 
˘æ
->˘æ.
›ts
->
subsy¢qn
, &˘æ->
addr
);

2025 
	`nvme_gë_˘æ
(&
˘æ
->ctrl);

2027 
	`muãx_lock
(&
nvme_rdma_˘æ_muãx
);

2028 
	`li°_add_èû
(&
˘æ
->
li°
, &
nvme_rdma_˘æ_li°
);

2029 
	`muãx_u∆ock
(&
nvme_rdma_˘æ_muãx
);

2031  &
˘æ
->ctrl;

2033 
out_unöô_˘æ
:

2034 
	`nvme_unöô_˘æ
(&
˘æ
->ctrl);

2035 
	`nvme_put_˘æ
(&
˘æ
->ctrl);

2036 i‡(
ªt
 > 0)

2037 
ªt
 = -
EIO
;

2038  
	`ERR_PTR
(
ªt
);

2039 
out_k‰ì_queues
:

2040 
	`k‰ì
(
˘æ
->
queues
);

2041 
out_‰ì_˘æ
:

2042 
	`k‰ì
(
˘æ
);

2043  
	`ERR_PTR
(
ªt
);

2044 
	}
}

2046 
nvmf_å™•‹t_›s
 
	gnvme_rdma_å™•‹t
 = {

2047 .
«me
 = "rdma",

2048 .
	gmoduÀ
 = 
THIS_MODULE
,

2049 .
	gªquúed_›ts
 = 
NVMF_OPT_TRADDR
,

2050 .
	gÆlowed_›ts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
 |

2051 
NVMF_OPT_HOST_TRADDR
 | 
NVMF_OPT_CTRL_LOSS_TMO
 |

2052 
NVMF_OPT_NR_WRITE_QUEUES
 | 
NVMF_OPT_NR_POLL_QUEUES
,

2053 .
	g¸óã_˘æ
 = 
nvme_rdma_¸óã_˘æ
,

2056 
	$nvme_rdma_ªmove_⁄e
(
ib_devi˚
 *ib_devi˚, *
˛õ¡_d©a
)

2058 
nvme_rdma_˘æ
 *
˘æ
;

2059 
nvme_rdma_devi˚
 *
ndev
;

2060 
boﬁ
 
found
 = 
Ál£
;

2062 
	`muãx_lock
(&
devi˚_li°_muãx
);

2063 
	`li°_f‹_óch_íåy
(
ndev
, &
devi˚_li°
, 
íåy
) {

2064 i‡(
ndev
->
dev
 =
ib_devi˚
) {

2065 
found
 = 
åue
;

2069 
	`muãx_u∆ock
(&
devi˚_li°_muãx
);

2071 i‡(!
found
)

2075 
	`muãx_lock
(&
nvme_rdma_˘æ_muãx
);

2076 
	`li°_f‹_óch_íåy
(
˘æ
, &
nvme_rdma_˘æ_li°
, 
li°
) {

2077 i‡(
˘æ
->
devi˚
->
dev
 !
ib_devi˚
)

2079 
	`nvme_dñëe_˘æ
(&
˘æ
->ctrl);

2081 
	`muãx_u∆ock
(&
nvme_rdma_˘æ_muãx
);

2083 
	`Êush_w‹kqueue
(
nvme_dñëe_wq
);

2084 
	}
}

2086 
ib_˛õ¡
 
	gnvme_rdma_ib_˛õ¡
 = {

2087 .
«me
 = "nvme_rdma",

2088 .
	gªmove
 = 
nvme_rdma_ªmove_⁄e


2091 
__öô
 
	$nvme_rdma_öô_moduÀ
()

2093 
ªt
;

2095 
ªt
 = 
	`ib_ªgi°î_˛õ¡
(&
nvme_rdma_ib_˛õ¡
);

2096 i‡(
ªt
)

2097  
ªt
;

2099 
ªt
 = 
	`nvmf_ªgi°î_å™•‹t
(&
nvme_rdma_å™•‹t
);

2100 i‡(
ªt
)

2101 
îr_uƒeg_˛õ¡
;

2105 
îr_uƒeg_˛õ¡
:

2106 
	`ib_uƒegi°î_˛õ¡
(&
nvme_rdma_ib_˛õ¡
);

2107  
ªt
;

2108 
	}
}

2110 
__exô
 
	$nvme_rdma_˛ónup_moduÀ
()

2112 
	`nvmf_uƒegi°î_å™•‹t
(&
nvme_rdma_å™•‹t
);

2113 
	`ib_uƒegi°î_˛õ¡
(&
nvme_rdma_ib_˛õ¡
);

2114 
	}
}

2116 
moduÀ_öô
(
nvme_rdma_öô_moduÀ
);

2117 
moduÀ_exô
(
nvme_rdma_˛ónup_moduÀ
);

2119 
MODULE_LICENSE
("GPL v2");

	@tcp.c

6 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

7 
	~<löux/moduÀ.h
>

8 
	~<löux/öô.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/îr.h
>

11 
	~<löux/nvme-t˝.h
>

12 
	~<√t/sock.h
>

13 
	~<√t/t˝.h
>

14 
	~<löux/blk-mq.h
>

15 
	~<¸y±o/hash.h
>

17 
	~"nvme.h
"

18 
	~"Ábrics.h
"

20 
	gnvme_t˝_queue
;

22 
	envme_t˝_£nd_°©e
 {

23 
	mNVME_TCP_SEND_CMD_PDU
 = 0,

24 
	mNVME_TCP_SEND_H2C_PDU
,

25 
	mNVME_TCP_SEND_DATA
,

26 
	mNVME_TCP_SEND_DDGST
,

29 
	snvme_t˝_ªque°
 {

30 
nvme_ªque°
 
	mªq
;

31 *
	mpdu
;

32 
nvme_t˝_queue
 *
	mqueue
;

33 
u32
 
	md©a_Àn
;

34 
u32
 
	mpdu_Àn
;

35 
u32
 
	mpdu_£¡
;

36 
u16
 
	mâag
;

37 
li°_hód
 
	míåy
;

38 
__À32
 
	mddg°
;

40 
bio
 *
	mcuº_bio
;

41 
iov_ôî
 
	môî
;

44 
size_t
 
	moff£t
;

45 
size_t
 
	md©a_£¡
;

46 
nvme_t˝_£nd_°©e
 
	m°©e
;

49 
	envme_t˝_queue_Êags
 {

50 
	mNVME_TCP_Q_ALLOCATED
 = 0,

51 
	mNVME_TCP_Q_LIVE
 = 1,

54 
	envme_t˝_ªcv_°©e
 {

55 
	mNVME_TCP_RECV_PDU
 = 0,

56 
	mNVME_TCP_RECV_DATA
,

57 
	mNVME_TCP_RECV_DDGST
,

60 
	gnvme_t˝_˘æ
;

61 
	snvme_t˝_queue
 {

62 
sockë
 *
	msock
;

63 
w‹k_°ru˘
 
	mio_w‹k
;

64 
	mio_˝u
;

66 
•ölock_t
 
	mlock
;

67 
li°_hód
 
	m£nd_li°
;

70 *
	mpdu
;

71 
	mpdu_ªmaöög
;

72 
	mpdu_off£t
;

73 
size_t
 
	md©a_ªmaöög
;

74 
size_t
 
	mddg°_ªmaöög
;

77 
nvme_t˝_ªque°
 *
	mªque°
;

79 
	mqueue_size
;

80 
size_t
 
	mcmnd_ˇpsuÀ_Àn
;

81 
nvme_t˝_˘æ
 *
	m˘æ
;

82 
	mÊags
;

83 
boﬁ
 
	mrd_íabÀd
;

85 
boﬁ
 
	mhdr_dige°
;

86 
boﬁ
 
	md©a_dige°
;

87 
ahash_ªque°
 *
	mrcv_hash
;

88 
ahash_ªque°
 *
	m¢d_hash
;

89 
__À32
 
	mexp_ddg°
;

90 
__À32
 
	mªcv_ddg°
;

92 
∑ge_‰ag_ˇche
 
	mpf_ˇche
;

94 (*
	m°©e_ch™ge
)(
	msock
 *);

95 (*
	md©a_ªady
)(
	msock
 *);

96 (*
	mwrôe_•a˚
)(
	msock
 *);

99 
	snvme_t˝_˘æ
 {

101 
nvme_t˝_queue
 *
	mqueues
;

102 
blk_mq_èg_£t
 
	mèg_£t
;

105 
li°_hód
 
	mli°
;

106 
blk_mq_èg_£t
 
	madmö_èg_£t
;

107 
sockaddr_°‹age
 
	maddr
;

108 
sockaddr_°‹age
 
	m§c_addr
;

109 
nvme_˘æ
 
	m˘æ
;

111 
w‹k_°ru˘
 
	mîr_w‹k
;

112 
dñayed_w‹k
 
	mc⁄√˘_w‹k
;

113 
nvme_t˝_ªque°
 
	masync_ªq
;

114 
u32
 
	mio_queues
[
HCTX_MAX_TYPES
];

117 
LIST_HEAD
(
nvme_t˝_˘æ_li°
);

118 
DEFINE_MUTEX
(
nvme_t˝_˘æ_muãx
);

119 
w‹kqueue_°ru˘
 *
	gnvme_t˝_wq
;

120 
blk_mq_›s
 
	gnvme_t˝_mq_›s
;

121 
blk_mq_›s
 
	gnvme_t˝_admö_mq_›s
;

123 
ölöe
 
nvme_t˝_˘æ
 *
	$to_t˝_˘æ
(
nvme_˘æ
 *
˘æ
)

125  
	`c⁄èöî_of
(
˘æ
, 
nvme_t˝_˘æ
, ctrl);

126 
	}
}

128 
ölöe
 
	$nvme_t˝_queue_id
(
nvme_t˝_queue
 *
queue
)

130  
queue
 - queue->
˘æ
->
queues
;

131 
	}
}

133 
ölöe
 
blk_mq_ègs
 *
	$nvme_t˝_èg£t
(
nvme_t˝_queue
 *
queue
)

135 
u32
 
queue_idx
 = 
	`nvme_t˝_queue_id
(
queue
);

137 i‡(
queue_idx
 == 0)

138  
queue
->
˘æ
->
admö_èg_£t
.
ègs
[
queue_idx
];

139  
queue
->
˘æ
->
èg_£t
.
ègs
[
queue_idx
 - 1];

140 
	}
}

142 
ölöe
 
u8
 
	$nvme_t˝_hdg°_Àn
(
nvme_t˝_queue
 *
queue
)

144  
queue
->
hdr_dige°
 ? 
NVME_TCP_DIGEST_LENGTH
 : 0;

145 
	}
}

147 
ölöe
 
u8
 
	$nvme_t˝_ddg°_Àn
(
nvme_t˝_queue
 *
queue
)

149  
queue
->
d©a_dige°
 ? 
NVME_TCP_DIGEST_LENGTH
 : 0;

150 
	}
}

152 
ölöe
 
size_t
 
	$nvme_t˝_ölöe_d©a_size
(
nvme_t˝_queue
 *
queue
)

154  
queue
->
cmnd_ˇpsuÀ_Àn
 - (
nvme_comm™d
);

155 
	}
}

157 
ölöe
 
boﬁ
 
	$nvme_t˝_async_ªq
(
nvme_t˝_ªque°
 *
ªq
)

159  
ªq
 =&ªq->
queue
->
˘æ
->
async_ªq
;

160 
	}
}

162 
ölöe
 
boﬁ
 
	$nvme_t˝_has_ölöe_d©a
(
nvme_t˝_ªque°
 *
ªq
)

164 
ªque°
 *
rq
;

165 
byãs
;

167 i‡(
	`u∆ikñy
(
	`nvme_t˝_async_ªq
(
ªq
)))

168  
Ál£
;

170 
rq
 = 
	`blk_mq_rq_‰om_pdu
(
ªq
);

171 
byãs
 = 
	`blk_rq_∑ylﬂd_byãs
(
rq
);

173  
	`rq_d©a_dú
(
rq
Ë=
WRITE
 && 
byãs
 &&

174 
byãs
 <
	`nvme_t˝_ölöe_d©a_size
(
ªq
->
queue
);

175 
	}
}

177 
ölöe
 
∑ge
 *
	$nvme_t˝_ªq_cur_∑ge
(
nvme_t˝_ªque°
 *
ªq
)

179  
ªq
->
ôî
.
bvec
->
bv_∑ge
;

180 
	}
}

182 
ölöe
 
size_t
 
	$nvme_t˝_ªq_cur_off£t
(
nvme_t˝_ªque°
 *
ªq
)

184  
ªq
->
ôî
.
bvec
->
bv_off£t
 +Ñeq->ôî.
iov_off£t
;

185 
	}
}

187 
ölöe
 
size_t
 
	$nvme_t˝_ªq_cur_Àngth
(
nvme_t˝_ªque°
 *
ªq
)

189  
	`mö_t
(
size_t
, 
ªq
->
ôî
.
bvec
->
bv_Àn
 -Ñeq->ôî.
iov_off£t
,

190 
ªq
->
pdu_Àn
 -Ñeq->
pdu_£¡
);

191 
	}
}

193 
ölöe
 
size_t
 
	$nvme_t˝_ªq_off£t
(
nvme_t˝_ªque°
 *
ªq
)

195  
ªq
->
ôî
.
iov_off£t
;

196 
	}
}

198 
ölöe
 
size_t
 
	$nvme_t˝_pdu_d©a_À·
(
nvme_t˝_ªque°
 *
ªq
)

200  
	`rq_d©a_dú
(
	`blk_mq_rq_‰om_pdu
(
ªq
)Ë=
WRITE
 ?

201 
ªq
->
pdu_Àn
 -Ñeq->
pdu_£¡
 : 0;

202 
	}
}

204 
ölöe
 
size_t
 
	$nvme_t˝_pdu_œ°_£nd
(
nvme_t˝_ªque°
 *
ªq
,

205 
Àn
)

207  
	`nvme_t˝_pdu_d©a_À·
(
ªq
Ë<
Àn
;

208 
	}
}

210 
	$nvme_t˝_öô_ôî
(
nvme_t˝_ªque°
 *
ªq
,

211 
dú
)

213 
ªque°
 *
rq
 = 
	`blk_mq_rq_‰om_pdu
(
ªq
);

214 
bio_vec
 *
vec
;

215 
size
;

216 
n£gs
;

217 
size_t
 
off£t
;

219 i‡(
rq
->
rq_Êags
 & 
RQF_SPECIAL_PAYLOAD
) {

220 
vec
 = &
rq
->
•ecül_vec
;

221 
n£gs
 = 1;

222 
size
 = 
	`blk_rq_∑ylﬂd_byãs
(
rq
);

223 
off£t
 = 0;

225 
bio
 *biÿ
ªq
->
cuº_bio
;

227 
vec
 = 
	`__bvec_ôî_bvec
(
bio
->
bi_io_vec
, bio->
bi_ôî
);

228 
n£gs
 = 
	`bio_£gmíts
(
bio
);

229 
size
 = 
bio
->
bi_ôî
.
bi_size
;

230 
off£t
 = 
bio
->
bi_ôî
.
bi_bvec_d⁄e
;

233 
	`iov_ôî_bvec
(&
ªq
->
ôî
, 
dú
, 
vec
, 
n£gs
, 
size
);

234 
ªq
->
ôî
.
iov_off£t
 = 
off£t
;

235 
	}
}

237 
ölöe
 
	$nvme_t˝_adv™˚_ªq
(
nvme_t˝_ªque°
 *
ªq
,

238 
Àn
)

240 
ªq
->
d©a_£¡
 +
Àn
;

241 
ªq
->
pdu_£¡
 +
Àn
;

242 
	`iov_ôî_adv™˚
(&
ªq
->
ôî
, 
Àn
);

243 i‡(!
	`iov_ôî_cou¡
(&
ªq
->
ôî
) &&

244 
ªq
->
d©a_£¡
 <Ñeq->
d©a_Àn
) {

245 
ªq
->
cuº_bio
 =Ñeq->cuº_bio->
bi_√xt
;

246 
	`nvme_t˝_öô_ôî
(
ªq
, 
WRITE
);

248 
	}
}

250 
ölöe
 
	$nvme_t˝_queue_ªque°
(
nvme_t˝_ªque°
 *
ªq
)

252 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

254 
	`•ö_lock
(&
queue
->
lock
);

255 
	`li°_add_èû
(&
ªq
->
íåy
, &
queue
->
£nd_li°
);

256 
	`•ö_u∆ock
(&
queue
->
lock
);

258 
	`queue_w‹k_⁄
(
queue
->
io_˝u
, 
nvme_t˝_wq
, &queue->
io_w‹k
);

259 
	}
}

261 
ölöe
 
nvme_t˝_ªque°
 *

262 
	$nvme_t˝_„tch_ªque°
(
nvme_t˝_queue
 *
queue
)

264 
nvme_t˝_ªque°
 *
ªq
;

266 
	`•ö_lock
(&
queue
->
lock
);

267 
ªq
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
queue
->
£nd_li°
,

268 
nvme_t˝_ªque°
, 
íåy
);

269 i‡(
ªq
)

270 
	`li°_dñ
(&
ªq
->
íåy
);

271 
	`•ö_u∆ock
(&
queue
->
lock
);

273  
ªq
;

274 
	}
}

276 
ölöe
 
	$nvme_t˝_ddg°_föÆ
(
ahash_ªque°
 *
hash
,

277 
__À32
 *
dg°
)

279 
	`ahash_ªque°_£t_¸y±
(
hash
, 
NULL
, (
u8
 *)
dg°
, 0);

280 
	`¸y±o_ahash_föÆ
(
hash
);

281 
	}
}

283 
ölöe
 
	$nvme_t˝_ddg°_upd©e
(
ahash_ªque°
 *
hash
,

284 
∑ge
 *∑ge, 
off_t
 
off
, 
size_t
 
Àn
)

286 
sˇâîli°
 
sg
;

288 
	`sg_öô_m¨kî
(&
sg
, 1);

289 
	`sg_£t_∑ge
(&
sg
, 
∑ge
, 
Àn
, 
off
);

290 
	`ahash_ªque°_£t_¸y±
(
hash
, &
sg
, 
NULL
, 
Àn
);

291 
	`¸y±o_ahash_upd©e
(
hash
);

292 
	}
}

294 
ölöe
 
	$nvme_t˝_hdg°
(
ahash_ªque°
 *
hash
,

295 *
pdu
, 
size_t
 
Àn
)

297 
sˇâîli°
 
sg
;

299 
	`sg_öô_⁄e
(&
sg
, 
pdu
, 
Àn
);

300 
	`ahash_ªque°_£t_¸y±
(
hash
, &
sg
, 
pdu
 + 
Àn
,Üen);

301 
	`¸y±o_ahash_dige°
(
hash
);

302 
	}
}

304 
	$nvme_t˝_vîify_hdg°
(
nvme_t˝_queue
 *
queue
,

305 *
pdu
, 
size_t
 
pdu_Àn
)

307 
nvme_t˝_hdr
 *
hdr
 = 
pdu
;

308 
__À32
 
ªcv_dige°
;

309 
__À32
 
exp_dige°
;

311 i‡(
	`u∆ikñy
(!(
hdr
->
Êags
 & 
NVME_TCP_F_HDGST
))) {

312 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

314 
	`nvme_t˝_queue_id
(
queue
));

315  -
EPROTO
;

318 
ªcv_dige°
 = *(
__À32
 *)(
pdu
 + 
hdr
->
hÀn
);

319 
	`nvme_t˝_hdg°
(
queue
->
rcv_hash
, 
pdu
, 
pdu_Àn
);

320 
exp_dige°
 = *(
__À32
 *)(
pdu
 + 
hdr
->
hÀn
);

321 i‡(
ªcv_dige°
 !
exp_dige°
) {

322 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

324 
	`À32_to_˝u
(
ªcv_dige°
),Üe32_to_˝u(
exp_dige°
));

325  -
EIO
;

329 
	}
}

331 
	$nvme_t˝_check_ddg°
(
nvme_t˝_queue
 *
queue
, *
pdu
)

333 
nvme_t˝_hdr
 *
hdr
 = 
pdu
;

334 
u8
 
dige°_Àn
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

335 
u32
 
Àn
;

337 
Àn
 = 
	`À32_to_˝u
(
hdr
->
∂í
Ë- hdr->
hÀn
 -

338 ((
hdr
->
Êags
 & 
NVME_TCP_F_HDGST
Ë? 
dige°_Àn
 : 0);

340 i‡(
	`u∆ikñy
(
Àn
 && !(
hdr
->
Êags
 & 
NVME_TCP_F_DDGST
))) {

341 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

343 
	`nvme_t˝_queue_id
(
queue
));

344  -
EPROTO
;

346 
	`¸y±o_ahash_öô
(
queue
->
rcv_hash
);

349 
	}
}

351 
	$nvme_t˝_exô_ªque°
(
blk_mq_èg_£t
 *
£t
,

352 
ªque°
 *
rq
, 
h˘x_idx
)

354 
nvme_t˝_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

356 
	`∑ge_‰ag_‰ì
(
ªq
->
pdu
);

357 
	}
}

359 
	$nvme_t˝_öô_ªque°
(
blk_mq_èg_£t
 *
£t
,

360 
ªque°
 *
rq
, 
h˘x_idx
,

361 
numa_node
)

363 
nvme_t˝_˘æ
 *
˘æ
 = 
£t
->
drivî_d©a
;

364 
nvme_t˝_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

365 
queue_idx
 = (
£t
 =&
˘æ
->
èg_£t
Ë? 
h˘x_idx
 + 1 : 0;

366 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[
queue_idx
];

367 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

369 
ªq
->
pdu
 = 
	`∑ge_‰ag_Æloc
(&
queue
->
pf_ˇche
,

370 (
nvme_t˝_cmd_pdu
Ë+ 
hdg°
,

371 
GFP_KERNEL
 | 
__GFP_ZERO
);

372 i‡(!
ªq
->
pdu
)

373  -
ENOMEM
;

375 
ªq
->
queue
 = queue;

376 
	`nvme_ªq
(
rq
)->
˘æ
 = &ctrl->ctrl;

379 
	}
}

381 
	$nvme_t˝_öô_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

382 
h˘x_idx
)

384 
nvme_t˝_˘æ
 *
˘æ
 = 
d©a
;

385 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[
h˘x_idx
 + 1];

387 
h˘x
->
drivî_d©a
 = 
queue
;

389 
	}
}

391 
	$nvme_t˝_öô_admö_h˘x
(
blk_mq_hw_˘x
 *
h˘x
, *
d©a
,

392 
h˘x_idx
)

394 
nvme_t˝_˘æ
 *
˘æ
 = 
d©a
;

395 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[0];

397 
h˘x
->
drivî_d©a
 = 
queue
;

399 
	}
}

401 
nvme_t˝_ªcv_°©e


402 
	$nvme_t˝_ªcv_°©e
(
nvme_t˝_queue
 *
queue
)

404  (
queue
->
pdu_ªmaöög
Ë? 
NVME_TCP_RECV_PDU
 :

405 (
queue
->
ddg°_ªmaöög
Ë? 
NVME_TCP_RECV_DDGST
 :

406 
NVME_TCP_RECV_DATA
;

407 
	}
}

409 
	$nvme_t˝_öô_ªcv_˘x
(
nvme_t˝_queue
 *
queue
)

411 
queue
->
pdu_ªmaöög
 = (
nvme_t˝_r•_pdu
) +

412 
	`nvme_t˝_hdg°_Àn
(
queue
);

413 
queue
->
pdu_off£t
 = 0;

414 
queue
->
d©a_ªmaöög
 = -1;

415 
queue
->
ddg°_ªmaöög
 = 0;

416 
	}
}

418 
	$nvme_t˝_îr‹_ªcovîy
(
nvme_˘æ
 *
˘æ
)

420 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_RESETTING
))

423 
	`queue_w‹k
(
nvme_wq
, &
	`to_t˝_˘æ
(
˘æ
)->
îr_w‹k
);

424 
	}
}

426 
	$nvme_t˝_¥o˚ss_nvme_cqe
(
nvme_t˝_queue
 *
queue
,

427 
nvme_com∂ëi⁄
 *
cqe
)

429 
ªque°
 *
rq
;

431 
rq
 = 
	`blk_mq_èg_to_rq
(
	`nvme_t˝_èg£t
(
queue
), 
cqe
->
comm™d_id
);

432 i‡(!
rq
) {

433 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

435 
	`nvme_t˝_queue_id
(
queue
), 
cqe
->
comm™d_id
);

436 
	`nvme_t˝_îr‹_ªcovîy
(&
queue
->
˘æ
->ctrl);

437  -
EINVAL
;

440 
	`nvme_íd_ªque°
(
rq
, 
cqe
->
°©us
, cqe->
ªsu…
);

443 
	}
}

445 
	$nvme_t˝_h™dÀ_c2h_d©a
(
nvme_t˝_queue
 *
queue
,

446 
nvme_t˝_d©a_pdu
 *
pdu
)

448 
ªque°
 *
rq
;

450 
rq
 = 
	`blk_mq_èg_to_rq
(
	`nvme_t˝_èg£t
(
queue
), 
pdu
->
comm™d_id
);

451 i‡(!
rq
) {

452 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

454 
	`nvme_t˝_queue_id
(
queue
), 
pdu
->
comm™d_id
);

455  -
ENOENT
;

458 i‡(!
	`blk_rq_∑ylﬂd_byãs
(
rq
)) {

459 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

461 
	`nvme_t˝_queue_id
(
queue
), 
rq
->
èg
);

462  -
EIO
;

465 
queue
->
d©a_ªmaöög
 = 
	`À32_to_˝u
(
pdu
->
d©a_Àngth
);

467 i‡(
pdu
->
hdr
.
Êags
 & 
NVME_TCP_F_DATA_SUCCESS
 &&

468 
	`u∆ikñy
(!(
pdu
->
hdr
.
Êags
 & 
NVME_TCP_F_DATA_LAST
))) {

469 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

471 
	`nvme_t˝_queue_id
(
queue
), 
rq
->
èg
);

472 
	`nvme_t˝_îr‹_ªcovîy
(&
queue
->
˘æ
->ctrl);

473  -
EPROTO
;

477 
	}
}

479 
	$nvme_t˝_h™dÀ_comp
(
nvme_t˝_queue
 *
queue
,

480 
nvme_t˝_r•_pdu
 *
pdu
)

482 
nvme_com∂ëi⁄
 *
cqe
 = &
pdu
->cqe;

483 
ªt
 = 0;

491 i‡(
	`u∆ikñy
(
	`nvme_t˝_queue_id
(
queue
) == 0 &&

492 
cqe
->
comm™d_id
 >
NVME_AQ_BLK_MQ_DEPTH
))

493 
	`nvme_com∂ëe_async_evít
(&
queue
->
˘æ
->˘æ, 
cqe
->
°©us
,

494 &
cqe
->
ªsu…
);

496 
ªt
 = 
	`nvme_t˝_¥o˚ss_nvme_cqe
(
queue
, 
cqe
);

498  
ªt
;

499 
	}
}

501 
	$nvme_t˝_£tup_h2c_d©a_pdu
(
nvme_t˝_ªque°
 *
ªq
,

502 
nvme_t˝_r2t_pdu
 *
pdu
)

504 
nvme_t˝_d©a_pdu
 *
d©a
 = 
ªq
->
pdu
;

505 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

506 
ªque°
 *
rq
 = 
	`blk_mq_rq_‰om_pdu
(
ªq
);

507 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

508 
u8
 
ddg°
 = 
	`nvme_t˝_ddg°_Àn
(
queue
);

510 
ªq
->
pdu_Àn
 = 
	`À32_to_˝u
(
pdu
->
r2t_Àngth
);

511 
ªq
->
pdu_£¡
 = 0;

513 i‡(
	`u∆ikñy
(
ªq
->
d©a_£¡
 +Ñeq->
pdu_Àn
 >Ñeq->
d©a_Àn
)) {

514 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

516 
rq
->
èg
, 
ªq
->
pdu_Àn
,Ñeq->
d©a_Àn
,

517 
ªq
->
d©a_£¡
);

518  -
EPROTO
;

521 i‡(
	`u∆ikñy
(
	`À32_to_˝u
(
pdu
->
r2t_off£t
Ë< 
ªq
->
d©a_£¡
)) {

522 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

524 
rq
->
èg
, 
	`À32_to_˝u
(
pdu
->
r2t_off£t
),

525 
ªq
->
d©a_£¡
);

526  -
EPROTO
;

529 
	`mem£t
(
d©a
, 0, (*data));

530 
d©a
->
hdr
.
ty≥
 = 
nvme_t˝_h2c_d©a
;

531 
d©a
->
hdr
.
Êags
 = 
NVME_TCP_F_DATA_LAST
;

532 i‡(
queue
->
hdr_dige°
)

533 
d©a
->
hdr
.
Êags
 |
NVME_TCP_F_HDGST
;

534 i‡(
queue
->
d©a_dige°
)

535 
d©a
->
hdr
.
Êags
 |
NVME_TCP_F_DDGST
;

536 
d©a
->
hdr
.
hÀn
 = (*data);

537 
d©a
->
hdr
.
pdo
 = d©a->hdr.
hÀn
 + 
hdg°
;

538 
d©a
->
hdr
.
∂í
 =

539 
	`˝u_to_À32
(
d©a
->
hdr
.
hÀn
 + 
hdg°
 + 
ªq
->
pdu_Àn
 + 
ddg°
);

540 
d©a
->
âag
 = 
pdu
->ttag;

541 
d©a
->
comm™d_id
 = 
rq
->
èg
;

542 
d©a
->
d©a_off£t
 = 
	`˝u_to_À32
(
ªq
->
d©a_£¡
);

543 
d©a
->
d©a_Àngth
 = 
	`˝u_to_À32
(
ªq
->
pdu_Àn
);

545 
	}
}

547 
	$nvme_t˝_h™dÀ_r2t
(
nvme_t˝_queue
 *
queue
,

548 
nvme_t˝_r2t_pdu
 *
pdu
)

550 
nvme_t˝_ªque°
 *
ªq
;

551 
ªque°
 *
rq
;

552 
ªt
;

554 
rq
 = 
	`blk_mq_èg_to_rq
(
	`nvme_t˝_èg£t
(
queue
), 
pdu
->
comm™d_id
);

555 i‡(!
rq
) {

556 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

558 
	`nvme_t˝_queue_id
(
queue
), 
pdu
->
comm™d_id
);

559  -
ENOENT
;

561 
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

563 
ªt
 = 
	`nvme_t˝_£tup_h2c_d©a_pdu
(
ªq
, 
pdu
);

564 i‡(
	`u∆ikñy
(
ªt
))

565  
ªt
;

567 
ªq
->
°©e
 = 
NVME_TCP_SEND_H2C_PDU
;

568 
ªq
->
off£t
 = 0;

570 
	`nvme_t˝_queue_ªque°
(
ªq
);

573 
	}
}

575 
	$nvme_t˝_ªcv_pdu
(
nvme_t˝_queue
 *
queue
, 
sk_buff
 *
skb
,

576 *
off£t
, 
size_t
 *
Àn
)

578 
nvme_t˝_hdr
 *
hdr
;

579 *
pdu
 = 
queue
->pdu;

580 
size_t
 
rcv_Àn
 = 
	`mö_t
(size_t, *
Àn
, 
queue
->
pdu_ªmaöög
);

581 
ªt
;

583 
ªt
 = 
	`skb_c›y_bôs
(
skb
, *
off£t
,

584 &
pdu
[
queue
->
pdu_off£t
], 
rcv_Àn
);

585 i‡(
	`u∆ikñy
(
ªt
))

586  
ªt
;

588 
queue
->
pdu_ªmaöög
 -
rcv_Àn
;

589 
queue
->
pdu_off£t
 +
rcv_Àn
;

590 *
off£t
 +
rcv_Àn
;

591 *
Àn
 -
rcv_Àn
;

592 i‡(
queue
->
pdu_ªmaöög
)

595 
hdr
 = 
queue
->
pdu
;

596 i‡(
queue
->
hdr_dige°
) {

597 
ªt
 = 
	`nvme_t˝_vîify_hdg°
(
queue
, queue->
pdu
, 
hdr
->
hÀn
);

598 i‡(
	`u∆ikñy
(
ªt
))

599  
ªt
;

603 i‡(
queue
->
d©a_dige°
) {

604 
ªt
 = 
	`nvme_t˝_check_ddg°
(
queue
, queue->
pdu
);

605 i‡(
	`u∆ikñy
(
ªt
))

606  
ªt
;

609 
hdr
->
ty≥
) {

610 
nvme_t˝_c2h_d©a
:

611 
ªt
 = 
	`nvme_t˝_h™dÀ_c2h_d©a
(
queue
, (*)queue->
pdu
);

613 
nvme_t˝_r•
:

614 
	`nvme_t˝_öô_ªcv_˘x
(
queue
);

615 
ªt
 = 
	`nvme_t˝_h™dÀ_comp
(
queue
, (*)queue->
pdu
);

617 
nvme_t˝_r2t
:

618 
	`nvme_t˝_öô_ªcv_˘x
(
queue
);

619 
ªt
 = 
	`nvme_t˝_h™dÀ_r2t
(
queue
, (*)queue->
pdu
);

622 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

623 "unsuµ‹ãdÖduÅy≥ (%d)\n", 
hdr
->
ty≥
);

624  -
EINVAL
;

627  
ªt
;

628 
	}
}

630 
ölöe
 
	$nvme_t˝_íd_ªque°
(
ªque°
 *
rq
, 
u16
 
°©us
)

632 
nvme_ªsu…
 
ªs
 = {};

634 
	`nvme_íd_ªque°
(
rq
, 
	`˝u_to_À16
(
°©us
 << 1), 
ªs
);

635 
	}
}

637 
	$nvme_t˝_ªcv_d©a
(
nvme_t˝_queue
 *
queue
, 
sk_buff
 *
skb
,

638 *
off£t
, 
size_t
 *
Àn
)

640 
nvme_t˝_d©a_pdu
 *
pdu
 = (*)
queue
->pdu;

641 
nvme_t˝_ªque°
 *
ªq
;

642 
ªque°
 *
rq
;

644 
rq
 = 
	`blk_mq_èg_to_rq
(
	`nvme_t˝_èg£t
(
queue
), 
pdu
->
comm™d_id
);

645 i‡(!
rq
) {

646 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

648 
	`nvme_t˝_queue_id
(
queue
), 
pdu
->
comm™d_id
);

649  -
ENOENT
;

651 
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

653 
åue
) {

654 
ªcv_Àn
, 
ªt
;

656 
ªcv_Àn
 = 
	`mö_t
(
size_t
, *
Àn
, 
queue
->
d©a_ªmaöög
);

657 i‡(!
ªcv_Àn
)

660 i‡(!
	`iov_ôî_cou¡
(&
ªq
->
ôî
)) {

661 
ªq
->
cuº_bio
 =Ñeq->cuº_bio->
bi_√xt
;

667 i‡(!
ªq
->
cuº_bio
) {

668 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

670 
	`nvme_t˝_queue_id
(
queue
), 
rq
->
èg
);

671 
	`nvme_t˝_öô_ªcv_˘x
(
queue
);

672  -
EIO
;

674 
	`nvme_t˝_öô_ôî
(
ªq
, 
READ
);

678 
ªcv_Àn
 = 
	`mö_t
(
size_t
,Ñecv_len,

679 
	`iov_ôî_cou¡
(&
ªq
->
ôî
));

681 i‡(
queue
->
d©a_dige°
)

682 
ªt
 = 
	`skb_c›y_™d_hash_d©agøm_ôî
(
skb
, *
off£t
,

683 &
ªq
->
ôî
, 
ªcv_Àn
, 
queue
->
rcv_hash
);

685 
ªt
 = 
	`skb_c›y_d©agøm_ôî
(
skb
, *
off£t
,

686 &
ªq
->
ôî
, 
ªcv_Àn
);

687 i‡(
ªt
) {

688 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

690 
	`nvme_t˝_queue_id
(
queue
), 
rq
->
èg
);

691  
ªt
;

694 *
Àn
 -
ªcv_Àn
;

695 *
off£t
 +
ªcv_Àn
;

696 
queue
->
d©a_ªmaöög
 -
ªcv_Àn
;

699 i‡(!
queue
->
d©a_ªmaöög
) {

700 i‡(
queue
->
d©a_dige°
) {

701 
	`nvme_t˝_ddg°_föÆ
(
queue
->
rcv_hash
, &queue->
exp_ddg°
);

702 
queue
->
ddg°_ªmaöög
 = 
NVME_TCP_DIGEST_LENGTH
;

704 i‡(
pdu
->
hdr
.
Êags
 & 
NVME_TCP_F_DATA_SUCCESS
)

705 
	`nvme_t˝_íd_ªque°
(
rq
, 
NVME_SC_SUCCESS
);

706 
	`nvme_t˝_öô_ªcv_˘x
(
queue
);

711 
	}
}

713 
	$nvme_t˝_ªcv_ddg°
(
nvme_t˝_queue
 *
queue
,

714 
sk_buff
 *
skb
, *
off£t
, 
size_t
 *
Àn
)

716 
nvme_t˝_d©a_pdu
 *
pdu
 = (*)
queue
->pdu;

717 *
ddg°
 = (*)&
queue
->
ªcv_ddg°
;

718 
size_t
 
ªcv_Àn
 = 
	`mö_t
(size_t, *
Àn
, 
queue
->
ddg°_ªmaöög
);

719 
off_t
 
off
 = 
NVME_TCP_DIGEST_LENGTH
 - 
queue
->
ddg°_ªmaöög
;

720 
ªt
;

722 
ªt
 = 
	`skb_c›y_bôs
(
skb
, *
off£t
, &
ddg°
[
off
], 
ªcv_Àn
);

723 i‡(
	`u∆ikñy
(
ªt
))

724  
ªt
;

726 
queue
->
ddg°_ªmaöög
 -
ªcv_Àn
;

727 *
off£t
 +
ªcv_Àn
;

728 *
Àn
 -
ªcv_Àn
;

729 i‡(
queue
->
ddg°_ªmaöög
)

732 i‡(
queue
->
ªcv_ddg°
 !queue->
exp_ddg°
) {

733 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

735 
	`À32_to_˝u
(
queue
->
ªcv_ddg°
),

736 
	`À32_to_˝u
(
queue
->
exp_ddg°
));

737  -
EIO
;

740 i‡(
pdu
->
hdr
.
Êags
 & 
NVME_TCP_F_DATA_SUCCESS
) {

741 
ªque°
 *
rq
 = 
	`blk_mq_èg_to_rq
(
	`nvme_t˝_èg£t
(
queue
),

742 
pdu
->
comm™d_id
);

744 
	`nvme_t˝_íd_ªque°
(
rq
, 
NVME_SC_SUCCESS
);

747 
	`nvme_t˝_öô_ªcv_˘x
(
queue
);

749 
	}
}

751 
	$nvme_t˝_ªcv_skb
(
ªad_des¸ùt‹_t
 *
desc
, 
sk_buff
 *
skb
,

752 
off£t
, 
size_t
 
Àn
)

754 
nvme_t˝_queue
 *
queue
 = 
desc
->
¨g
.
d©a
;

755 
size_t
 
c⁄sumed
 = 
Àn
;

756 
ªsu…
;

758 
Àn
) {

759 
	`nvme_t˝_ªcv_°©e
(
queue
)) {

760 
NVME_TCP_RECV_PDU
:

761 
ªsu…
 = 
	`nvme_t˝_ªcv_pdu
(
queue
, 
skb
, &
off£t
, &
Àn
);

763 
NVME_TCP_RECV_DATA
:

764 
ªsu…
 = 
	`nvme_t˝_ªcv_d©a
(
queue
, 
skb
, &
off£t
, &
Àn
);

766 
NVME_TCP_RECV_DDGST
:

767 
ªsu…
 = 
	`nvme_t˝_ªcv_ddg°
(
queue
, 
skb
, &
off£t
, &
Àn
);

770 
ªsu…
 = -
EFAULT
;

772 i‡(
ªsu…
) {

773 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

774 "ª˚ivêÁûed: %d\n", 
ªsu…
);

775 
queue
->
rd_íabÀd
 = 
Ál£
;

776 
	`nvme_t˝_îr‹_ªcovîy
(&
queue
->
˘æ
->ctrl);

777  
ªsu…
;

781  
c⁄sumed
;

782 
	}
}

784 
	$nvme_t˝_d©a_ªady
(
sock
 *
sk
)

786 
nvme_t˝_queue
 *
queue
;

788 
	`ªad_lock
(&
sk
->
sk_ˇŒback_lock
);

789 
queue
 = 
sk
->
sk_u£r_d©a
;

790 i‡(
	`likñy
(
queue
 && queue->
rd_íabÀd
))

791 
	`queue_w‹k_⁄
(
queue
->
io_˝u
, 
nvme_t˝_wq
, &queue->
io_w‹k
);

792 
	`ªad_u∆ock
(&
sk
->
sk_ˇŒback_lock
);

793 
	}
}

795 
	$nvme_t˝_wrôe_•a˚
(
sock
 *
sk
)

797 
nvme_t˝_queue
 *
queue
;

799 
	`ªad_lock_bh
(&
sk
->
sk_ˇŒback_lock
);

800 
queue
 = 
sk
->
sk_u£r_d©a
;

801 i‡(
	`likñy
(
queue
 && 
	`sk_°ªam_is_wrôóbÀ
(
sk
))) {

802 
	`˛ór_bô
(
SOCK_NOSPACE
, &
sk
->
sk_sockë
->
Êags
);

803 
	`queue_w‹k_⁄
(
queue
->
io_˝u
, 
nvme_t˝_wq
, &queue->
io_w‹k
);

805 
	`ªad_u∆ock_bh
(&
sk
->
sk_ˇŒback_lock
);

806 
	}
}

808 
	$nvme_t˝_°©e_ch™ge
(
sock
 *
sk
)

810 
nvme_t˝_queue
 *
queue
;

812 
	`ªad_lock
(&
sk
->
sk_ˇŒback_lock
);

813 
queue
 = 
sk
->
sk_u£r_d©a
;

814 i‡(!
queue
)

815 
d⁄e
;

817 
sk
->
sk_°©e
) {

818 
TCP_CLOSE
:

819 
TCP_CLOSE_WAIT
:

820 
TCP_LAST_ACK
:

821 
TCP_FIN_WAIT1
:

822 
TCP_FIN_WAIT2
:

824 
	`nvme_t˝_îr‹_ªcovîy
(&
queue
->
˘æ
->ctrl);

827 
	`dev_öfo
(
queue
->
˘æ
->˘æ.
devi˚
,

829 
	`nvme_t˝_queue_id
(
queue
), 
sk
->
sk_°©e
);

832 
queue
->
	`°©e_ch™ge
(
sk
);

833 
d⁄e
:

834 
	`ªad_u∆ock
(&
sk
->
sk_ˇŒback_lock
);

835 
	}
}

837 
ölöe
 
	$nvme_t˝_d⁄e_£nd_ªq
(
nvme_t˝_queue
 *
queue
)

839 
queue
->
ªque°
 = 
NULL
;

840 
	}
}

842 
	$nvme_t˝_Áû_ªque°
(
nvme_t˝_ªque°
 *
ªq
)

844 
	`nvme_t˝_íd_ªque°
(
	`blk_mq_rq_‰om_pdu
(
ªq
), 
NVME_SC_DATA_XFER_ERROR
);

845 
	}
}

847 
	$nvme_t˝_åy_£nd_d©a
(
nvme_t˝_ªque°
 *
ªq
)

849 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

851 
åue
) {

852 
∑ge
 *∑gê
	`nvme_t˝_ªq_cur_∑ge
(
ªq
);

853 
size_t
 
off£t
 = 
	`nvme_t˝_ªq_cur_off£t
(
ªq
);

854 
size_t
 
Àn
 = 
	`nvme_t˝_ªq_cur_Àngth
(
ªq
);

855 
boﬁ
 
œ°
 = 
	`nvme_t˝_pdu_œ°_£nd
(
ªq
, 
Àn
);

856 
ªt
, 
Êags
 = 
MSG_DONTWAIT
;

858 i‡(
œ°
 && !
queue
->
d©a_dige°
)

859 
Êags
 |
MSG_EOR
;

861 
Êags
 |
MSG_MORE
;

863 
ªt
 = 
	`kî√l_£nd∑ge
(
queue
->
sock
, 
∑ge
, 
off£t
, 
Àn
, 
Êags
);

864 i‡(
ªt
 <= 0)

865  
ªt
;

867 
	`nvme_t˝_adv™˚_ªq
(
ªq
, 
ªt
);

868 i‡(
queue
->
d©a_dige°
)

869 
	`nvme_t˝_ddg°_upd©e
(
queue
->
¢d_hash
, 
∑ge
,

870 
off£t
, 
ªt
);

873 i‡(
œ°
 && 
ªt
 =
Àn
) {

874 i‡(
queue
->
d©a_dige°
) {

875 
	`nvme_t˝_ddg°_föÆ
(
queue
->
¢d_hash
,

876 &
ªq
->
ddg°
);

877 
ªq
->
°©e
 = 
NVME_TCP_SEND_DDGST
;

878 
ªq
->
off£t
 = 0;

880 
	`nvme_t˝_d⁄e_£nd_ªq
(
queue
);

885  -
EAGAIN
;

886 
	}
}

888 
	$nvme_t˝_åy_£nd_cmd_pdu
(
nvme_t˝_ªque°
 *
ªq
)

890 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

891 
nvme_t˝_cmd_pdu
 *
pdu
 = 
ªq
->pdu;

892 
boﬁ
 
ölöe_d©a
 = 
	`nvme_t˝_has_ölöe_d©a
(
ªq
);

893 
Êags
 = 
MSG_DONTWAIT
 | (
ölöe_d©a
 ? 
MSG_MORE
 : 
MSG_EOR
);

894 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

895 
Àn
 = (*
pdu
Ë+ 
hdg°
 - 
ªq
->
off£t
;

896 
ªt
;

898 i‡(
queue
->
hdr_dige°
 && !
ªq
->
off£t
)

899 
	`nvme_t˝_hdg°
(
queue
->
¢d_hash
, 
pdu
, (*pdu));

901 
ªt
 = 
	`kî√l_£nd∑ge
(
queue
->
sock
, 
	`vút_to_∑ge
(
pdu
),

902 
	`off£t_ö_∑ge
(
pdu
Ë+ 
ªq
->
off£t
, 
Àn
, 
Êags
);

903 i‡(
	`u∆ikñy
(
ªt
 <= 0))

904  
ªt
;

906 
Àn
 -
ªt
;

907 i‡(!
Àn
) {

908 i‡(
ölöe_d©a
) {

909 
ªq
->
°©e
 = 
NVME_TCP_SEND_DATA
;

910 i‡(
queue
->
d©a_dige°
)

911 
	`¸y±o_ahash_öô
(
queue
->
¢d_hash
);

912 
	`nvme_t˝_öô_ôî
(
ªq
, 
WRITE
);

914 
	`nvme_t˝_d⁄e_£nd_ªq
(
queue
);

918 
ªq
->
off£t
 +
ªt
;

920  -
EAGAIN
;

921 
	}
}

923 
	$nvme_t˝_åy_£nd_d©a_pdu
(
nvme_t˝_ªque°
 *
ªq
)

925 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

926 
nvme_t˝_d©a_pdu
 *
pdu
 = 
ªq
->pdu;

927 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

928 
Àn
 = (*
pdu
Ë- 
ªq
->
off£t
 + 
hdg°
;

929 
ªt
;

931 i‡(
queue
->
hdr_dige°
 && !
ªq
->
off£t
)

932 
	`nvme_t˝_hdg°
(
queue
->
¢d_hash
, 
pdu
, (*pdu));

934 
ªt
 = 
	`kî√l_£nd∑ge
(
queue
->
sock
, 
	`vút_to_∑ge
(
pdu
),

935 
	`off£t_ö_∑ge
(
pdu
Ë+ 
ªq
->
off£t
, 
Àn
,

936 
MSG_DONTWAIT
 | 
MSG_MORE
);

937 i‡(
	`u∆ikñy
(
ªt
 <= 0))

938  
ªt
;

940 
Àn
 -
ªt
;

941 i‡(!
Àn
) {

942 
ªq
->
°©e
 = 
NVME_TCP_SEND_DATA
;

943 i‡(
queue
->
d©a_dige°
)

944 
	`¸y±o_ahash_öô
(
queue
->
¢d_hash
);

945 i‡(!
ªq
->
d©a_£¡
)

946 
	`nvme_t˝_öô_ôî
(
ªq
, 
WRITE
);

949 
ªq
->
off£t
 +
ªt
;

951  -
EAGAIN
;

952 
	}
}

954 
	$nvme_t˝_åy_£nd_ddg°
(
nvme_t˝_ªque°
 *
ªq
)

956 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

957 
ªt
;

958 
msghdr
 
msg
 = { .
msg_Êags
 = 
MSG_DONTWAIT
 | 
MSG_EOR
 };

959 
kvec
 
iov
 = {

960 .
iov_ba£
 = &
ªq
->
ddg°
 +Ñeq->
off£t
,

961 .
iov_Àn
 = 
NVME_TCP_DIGEST_LENGTH
 - 
ªq
->
off£t


964 
ªt
 = 
	`kî√l_£ndmsg
(
queue
->
sock
, &
msg
, &
iov
, 1, iov.
iov_Àn
);

965 i‡(
	`u∆ikñy
(
ªt
 <= 0))

966  
ªt
;

968 i‡(
ªq
->
off£t
 + 
ªt
 =
NVME_TCP_DIGEST_LENGTH
) {

969 
	`nvme_t˝_d⁄e_£nd_ªq
(
queue
);

973 
ªq
->
off£t
 +
ªt
;

974  -
EAGAIN
;

975 
	}
}

977 
	$nvme_t˝_åy_£nd
(
nvme_t˝_queue
 *
queue
)

979 
nvme_t˝_ªque°
 *
ªq
;

980 
ªt
 = 1;

982 i‡(!
queue
->
ªque°
) {

983 
queue
->
ªque°
 = 
	`nvme_t˝_„tch_ªque°
(queue);

984 i‡(!
queue
->
ªque°
)

987 
ªq
 = 
queue
->
ªque°
;

989 i‡(
ªq
->
°©e
 =
NVME_TCP_SEND_CMD_PDU
) {

990 
ªt
 = 
	`nvme_t˝_åy_£nd_cmd_pdu
(
ªq
);

991 i‡(
ªt
 <= 0)

992 
d⁄e
;

993 i‡(!
	`nvme_t˝_has_ölöe_d©a
(
ªq
))

994  
ªt
;

997 i‡(
ªq
->
°©e
 =
NVME_TCP_SEND_H2C_PDU
) {

998 
ªt
 = 
	`nvme_t˝_åy_£nd_d©a_pdu
(
ªq
);

999 i‡(
ªt
 <= 0)

1000 
d⁄e
;

1003 i‡(
ªq
->
°©e
 =
NVME_TCP_SEND_DATA
) {

1004 
ªt
 = 
	`nvme_t˝_åy_£nd_d©a
(
ªq
);

1005 i‡(
ªt
 <= 0)

1006 
d⁄e
;

1009 i‡(
ªq
->
°©e
 =
NVME_TCP_SEND_DDGST
)

1010 
ªt
 = 
	`nvme_t˝_åy_£nd_ddg°
(
ªq
);

1011 
d⁄e
:

1012 i‡(
ªt
 =-
EAGAIN
)

1013 
ªt
 = 0;

1014  
ªt
;

1015 
	}
}

1017 
	$nvme_t˝_åy_ªcv
(
nvme_t˝_queue
 *
queue
)

1019 
sock
 *
sk
 = 
queue
->sock->sk;

1020 
ªad_des¸ùt‹_t
 
rd_desc
;

1021 
c⁄sumed
;

1023 
rd_desc
.
¨g
.
d©a
 = 
queue
;

1024 
rd_desc
.
cou¡
 = 1;

1025 
	`lock_sock
(
sk
);

1026 
c⁄sumed
 = 
	`t˝_ªad_sock
(
sk
, &
rd_desc
, 
nvme_t˝_ªcv_skb
);

1027 
	`ªÀa£_sock
(
sk
);

1028  
c⁄sumed
;

1029 
	}
}

1031 
	$nvme_t˝_io_w‹k
(
w‹k_°ru˘
 *
w
)

1033 
nvme_t˝_queue
 *
queue
 =

1034 
	`c⁄èöî_of
(
w
, 
nvme_t˝_queue
, 
io_w‹k
);

1035 
°¨t
 = 
jiffõs
 + 
	`m£cs_to_jiffõs
(1);

1038 
boﬁ
 
≥ndög
 = 
Ál£
;

1039 
ªsu…
;

1041 
ªsu…
 = 
	`nvme_t˝_åy_£nd
(
queue
);

1042 i‡(
ªsu…
 > 0) {

1043 
≥ndög
 = 
åue
;

1044 } i‡(
	`u∆ikñy
(
ªsu…
 < 0)) {

1045 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

1046 "ÁûedÅÿ£ndÑeque° %d\n", 
ªsu…
);

1047 i‡(
ªsu…
 !-
EPIPE
)

1048 
	`nvme_t˝_Áû_ªque°
(
queue
->
ªque°
);

1049 
	`nvme_t˝_d⁄e_£nd_ªq
(
queue
);

1053 
ªsu…
 = 
	`nvme_t˝_åy_ªcv
(
queue
);

1054 i‡(
ªsu…
 > 0)

1055 
≥ndög
 = 
åue
;

1057 i‡(!
≥ndög
)

1060 } 
	`time_a·î
(
jiffõs
, 
°¨t
));

1062 
	`queue_w‹k_⁄
(
queue
->
io_˝u
, 
nvme_t˝_wq
, &queue->
io_w‹k
);

1063 
	}
}

1065 
	$nvme_t˝_‰ì_¸y±o
(
nvme_t˝_queue
 *
queue
)

1067 
¸y±o_ahash
 *
tfm
 = 
	`¸y±o_ahash_ªqtfm
(
queue
->
rcv_hash
);

1069 
	`ahash_ªque°_‰ì
(
queue
->
rcv_hash
);

1070 
	`ahash_ªque°_‰ì
(
queue
->
¢d_hash
);

1071 
	`¸y±o_‰ì_ahash
(
tfm
);

1072 
	}
}

1074 
	$nvme_t˝_Æloc_¸y±o
(
nvme_t˝_queue
 *
queue
)

1076 
¸y±o_ahash
 *
tfm
;

1078 
tfm
 = 
	`¸y±o_Æloc_ahash
("¸c32c", 0, 
CRYPTO_ALG_ASYNC
);

1079 i‡(
	`IS_ERR
(
tfm
))

1080  
	`PTR_ERR
(
tfm
);

1082 
queue
->
¢d_hash
 = 
	`ahash_ªque°_Æloc
(
tfm
, 
GFP_KERNEL
);

1083 i‡(!
queue
->
¢d_hash
)

1084 
‰ì_tfm
;

1085 
	`ahash_ªque°_£t_ˇŒback
(
queue
->
¢d_hash
, 0, 
NULL
, NULL);

1087 
queue
->
rcv_hash
 = 
	`ahash_ªque°_Æloc
(
tfm
, 
GFP_KERNEL
);

1088 i‡(!
queue
->
rcv_hash
)

1089 
‰ì_¢d_hash
;

1090 
	`ahash_ªque°_£t_ˇŒback
(
queue
->
rcv_hash
, 0, 
NULL
, NULL);

1093 
‰ì_¢d_hash
:

1094 
	`ahash_ªque°_‰ì
(
queue
->
¢d_hash
);

1095 
‰ì_tfm
:

1096 
	`¸y±o_‰ì_ahash
(
tfm
);

1097  -
ENOMEM
;

1098 
	}
}

1100 
	$nvme_t˝_‰ì_async_ªq
(
nvme_t˝_˘æ
 *
˘æ
)

1102 
nvme_t˝_ªque°
 *
async
 = &
˘æ
->
async_ªq
;

1104 
	`∑ge_‰ag_‰ì
(
async
->
pdu
);

1105 
	}
}

1107 
	$nvme_t˝_Æloc_async_ªq
(
nvme_t˝_˘æ
 *
˘æ
)

1109 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[0];

1110 
nvme_t˝_ªque°
 *
async
 = &
˘æ
->
async_ªq
;

1111 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

1113 
async
->
pdu
 = 
	`∑ge_‰ag_Æloc
(&
queue
->
pf_ˇche
,

1114 (
nvme_t˝_cmd_pdu
Ë+ 
hdg°
,

1115 
GFP_KERNEL
 | 
__GFP_ZERO
);

1116 i‡(!
async
->
pdu
)

1117  -
ENOMEM
;

1119 
async
->
queue
 = &
˘æ
->
queues
[0];

1121 
	}
}

1123 
	$nvme_t˝_‰ì_queue
(
nvme_˘æ
 *
n˘æ
, 
qid
)

1125 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1126 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[
qid
];

1128 i‡(!
	`ã°_™d_˛ór_bô
(
NVME_TCP_Q_ALLOCATED
, &
queue
->
Êags
))

1131 i‡(
queue
->
hdr_dige°
 || queue->
d©a_dige°
)

1132 
	`nvme_t˝_‰ì_¸y±o
(
queue
);

1134 
	`sock_ªÀa£
(
queue
->
sock
);

1135 
	`k‰ì
(
queue
->
pdu
);

1136 
	}
}

1138 
	$nvme_t˝_öô_c⁄√˘i⁄
(
nvme_t˝_queue
 *
queue
)

1140 
nvme_t˝_i¸eq_pdu
 *
i¸eq
;

1141 
nvme_t˝_i¸e•_pdu
 *
i¸e•
;

1142 
msghdr
 
msg
 = {};

1143 
kvec
 
iov
;

1144 
boﬁ
 
˘æ_hdg°
, 
˘æ_ddg°
;

1145 
ªt
;

1147 
i¸eq
 = 
	`kzÆloc
((*i¸eq), 
GFP_KERNEL
);

1148 i‡(!
i¸eq
)

1149  -
ENOMEM
;

1151 
i¸e•
 = 
	`kzÆloc
((*i¸e•), 
GFP_KERNEL
);

1152 i‡(!
i¸e•
) {

1153 
ªt
 = -
ENOMEM
;

1154 
‰ì_i¸eq
;

1157 
i¸eq
->
hdr
.
ty≥
 = 
nvme_t˝_i¸eq
;

1158 
i¸eq
->
hdr
.
hÀn
 = (*icreq);

1159 
i¸eq
->
hdr
.
pdo
 = 0;

1160 
i¸eq
->
hdr
.
∂í
 = 
	`˝u_to_À32
(i¸eq->hdr.
hÀn
);

1161 
i¸eq
->
pfv
 = 
	`˝u_to_À16
(
NVME_TCP_PFV_1_0
);

1162 
i¸eq
->
maxr2t
 = 0;

1163 
i¸eq
->
hpda
 = 0;

1164 i‡(
queue
->
hdr_dige°
)

1165 
i¸eq
->
dige°
 |
NVME_TCP_HDR_DIGEST_ENABLE
;

1166 i‡(
queue
->
d©a_dige°
)

1167 
i¸eq
->
dige°
 |
NVME_TCP_DATA_DIGEST_ENABLE
;

1169 
iov
.
iov_ba£
 = 
i¸eq
;

1170 
iov
.
iov_Àn
 = (*
i¸eq
);

1171 
ªt
 = 
	`kî√l_£ndmsg
(
queue
->
sock
, &
msg
, &
iov
, 1, iov.
iov_Àn
);

1172 i‡(
ªt
 < 0)

1173 
‰ì_i¸e•
;

1175 
	`mem£t
(&
msg
, 0, (msg));

1176 
iov
.
iov_ba£
 = 
i¸e•
;

1177 
iov
.
iov_Àn
 = (*
i¸e•
);

1178 
ªt
 = 
	`kî√l_ªcvmsg
(
queue
->
sock
, &
msg
, &
iov
, 1,

1179 
iov
.
iov_Àn
, 
msg
.
msg_Êags
);

1180 i‡(
ªt
 < 0)

1181 
‰ì_i¸e•
;

1183 
ªt
 = -
EINVAL
;

1184 i‡(
i¸e•
->
hdr
.
ty≥
 !
nvme_t˝_i¸e•
) {

1185 
	`¥_îr
("queue %d: badÅypeÑeturned %d\n",

1186 
	`nvme_t˝_queue_id
(
queue
), 
i¸e•
->
hdr
.
ty≥
);

1187 
‰ì_i¸e•
;

1190 i‡(
	`À32_to_˝u
(
i¸e•
->
hdr
.
∂í
) != (*icresp)) {

1191 
	`¥_îr
("queue %d: badÖduÜengthÑeturned %d\n",

1192 
	`nvme_t˝_queue_id
(
queue
), 
i¸e•
->
hdr
.
∂í
);

1193 
‰ì_i¸e•
;

1196 i‡(
i¸e•
->
pfv
 !
NVME_TCP_PFV_1_0
) {

1197 
	`¥_îr
("queue %d: badÖfvÑeturned %d\n",

1198 
	`nvme_t˝_queue_id
(
queue
), 
i¸e•
->
pfv
);

1199 
‰ì_i¸e•
;

1202 
˘æ_ddg°
 = !!(
i¸e•
->
dige°
 & 
NVME_TCP_DATA_DIGEST_ENABLE
);

1203 i‡((
queue
->
d©a_dige°
 && !
˘æ_ddg°
) ||

1204 (!
queue
->
d©a_dige°
 && 
˘æ_ddg°
)) {

1205 
	`¥_îr
("queue %d: data digest mismatch host: %s ctrl: %s\n",

1206 
	`nvme_t˝_queue_id
(
queue
),

1207 
queue
->
d©a_dige°
 ? "enabled" : "disabled",

1208 
˘æ_ddg°
 ? "enabled" : "disabled");

1209 
‰ì_i¸e•
;

1212 
˘æ_hdg°
 = !!(
i¸e•
->
dige°
 & 
NVME_TCP_HDR_DIGEST_ENABLE
);

1213 i‡((
queue
->
hdr_dige°
 && !
˘æ_hdg°
) ||

1214 (!
queue
->
hdr_dige°
 && 
˘æ_hdg°
)) {

1215 
	`¥_îr
("queue %d: header digest mismatch host: %s ctrl: %s\n",

1216 
	`nvme_t˝_queue_id
(
queue
),

1217 
queue
->
hdr_dige°
 ? "enabled" : "disabled",

1218 
˘æ_hdg°
 ? "enabled" : "disabled");

1219 
‰ì_i¸e•
;

1222 i‡(
i¸e•
->
˝da
 != 0) {

1223 
	`¥_îr
("queue %d: unsupported cpdaÑeturned %d\n",

1224 
	`nvme_t˝_queue_id
(
queue
), 
i¸e•
->
˝da
);

1225 
‰ì_i¸e•
;

1228 
ªt
 = 0;

1229 
‰ì_i¸e•
:

1230 
	`k‰ì
(
i¸e•
);

1231 
‰ì_i¸eq
:

1232 
	`k‰ì
(
i¸eq
);

1233  
ªt
;

1234 
	}
}

1236 
	$nvme_t˝_Æloc_queue
(
nvme_˘æ
 *
n˘æ
,

1237 
qid
, 
size_t
 
queue_size
)

1239 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1240 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[
qid
];

1241 
lögî
 
sﬁ
 = { .
l_⁄off
 = 1, .
l_lögî
 = 0 };

1242 
ªt
, 
›t
, 
rcv_pdu_size
, 
n
;

1244 
queue
->
˘æ
 = ctrl;

1245 
	`INIT_LIST_HEAD
(&
queue
->
£nd_li°
);

1246 
	`•ö_lock_öô
(&
queue
->
lock
);

1247 
	`INIT_WORK
(&
queue
->
io_w‹k
, 
nvme_t˝_io_w‹k
);

1248 
queue
->
queue_size
 = queue_size;

1250 i‡(
qid
 > 0)

1251 
queue
->
cmnd_ˇpsuÀ_Àn
 = 
˘æ
->˘æ.
ioccsz
 * 16;

1253 
queue
->
cmnd_ˇpsuÀ_Àn
 = (
nvme_comm™d
) +

1254 
NVME_TCP_ADMIN_CCSZ
;

1256 
ªt
 = 
	`sock_¸óã
(
˘æ
->
addr
.
ss_Ámûy
, 
SOCK_STREAM
,

1257 
IPPROTO_TCP
, &
queue
->
sock
);

1258 i‡(
ªt
) {

1259 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1260 "ÁûedÅÿ¸óã sockë: %d\n", 
ªt
);

1261  
ªt
;

1265 
›t
 = 1;

1266 
ªt
 = 
	`kî√l_£tsock›t
(
queue
->
sock
, 
IPPROTO_TCP
, 
TCP_SYNCNT
,

1267 (*)&
›t
, (opt));

1268 i‡(
ªt
) {

1269 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1270 "ÁûedÅÿ£àTCP_SYNCNT sock o± %d\n", 
ªt
);

1271 
îr_sock
;

1275 
›t
 = 1;

1276 
ªt
 = 
	`kî√l_£tsock›t
(
queue
->
sock
, 
IPPROTO_TCP
,

1277 
TCP_NODELAY
, (*)&
›t
, (opt));

1278 i‡(
ªt
) {

1279 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1280 "ÁûedÅÿ£àTCP_NODELAY sock o± %d\n", 
ªt
);

1281 
îr_sock
;

1289 
ªt
 = 
	`kî√l_£tsock›t
(
queue
->
sock
, 
SOL_SOCKET
, 
SO_LINGER
,

1290 (*)&
sﬁ
, (sol));

1291 i‡(
ªt
) {

1292 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1293 "ÁûedÅÿ£àSO_LINGER sock o± %d\n", 
ªt
);

1294 
îr_sock
;

1297 
queue
->
sock
->
sk
->
sk_Æloˇti⁄
 = 
GFP_ATOMIC
;

1298 i‡(!
qid
)

1299 
n
 = 0;

1301 
n
 = (
qid
 - 1Ë% 
	`num_⁄löe_˝us
();

1302 
queue
->
io_˝u
 = 
	`˝umask_√xt_wøp
(
n
 - 1, 
˝u_⁄löe_mask
, -1, 
Ál£
);

1303 
queue
->
ªque°
 = 
NULL
;

1304 
queue
->
d©a_ªmaöög
 = 0;

1305 
queue
->
ddg°_ªmaöög
 = 0;

1306 
queue
->
pdu_ªmaöög
 = 0;

1307 
queue
->
pdu_off£t
 = 0;

1308 
	`sk_£t_memÆloc
(
queue
->
sock
->
sk
);

1310 i‡(
˘æ
->˘æ.
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

1311 
ªt
 = 
	`kî√l_böd
(
queue
->
sock
, (
sockaddr
 *)&
˘æ
->
§c_addr
,

1312 (
˘æ
->
§c_addr
));

1313 i‡(
ªt
) {

1314 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1316 
qid
, 
ªt
);

1317 
îr_sock
;

1321 
queue
->
hdr_dige°
 = 
n˘æ
->
›ts
->hdr_digest;

1322 
queue
->
d©a_dige°
 = 
n˘æ
->
›ts
->data_digest;

1323 i‡(
queue
->
hdr_dige°
 || queue->
d©a_dige°
) {

1324 
ªt
 = 
	`nvme_t˝_Æloc_¸y±o
(
queue
);

1325 i‡(
ªt
) {

1326 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1327 "ÁûedÅÿÆloˇã queuê%d cry±o\n", 
qid
);

1328 
îr_sock
;

1332 
rcv_pdu_size
 = (
nvme_t˝_r•_pdu
) +

1333 
	`nvme_t˝_hdg°_Àn
(
queue
);

1334 
queue
->
pdu
 = 
	`kmÆloc
(
rcv_pdu_size
, 
GFP_KERNEL
);

1335 i‡(!
queue
->
pdu
) {

1336 
ªt
 = -
ENOMEM
;

1337 
îr_¸y±o
;

1340 
	`dev_dbg
(
˘æ
->˘æ.
devi˚
, "connecting queue %d\n",

1341 
	`nvme_t˝_queue_id
(
queue
));

1343 
ªt
 = 
	`kî√l_c⁄√˘
(
queue
->
sock
, (
sockaddr
 *)&
˘æ
->
addr
,

1344 (
˘æ
->
addr
), 0);

1345 i‡(
ªt
) {

1346 
	`dev_îr
(
˘æ
->˘æ.
devi˚
,

1347 "ÁûedÅÿc⁄√˘ sockë: %d\n", 
ªt
);

1348 
îr_rcv_pdu
;

1351 
ªt
 = 
	`nvme_t˝_öô_c⁄√˘i⁄
(
queue
);

1352 i‡(
ªt
)

1353 
îr_öô_c⁄√˘
;

1355 
queue
->
rd_íabÀd
 = 
åue
;

1356 
	`£t_bô
(
NVME_TCP_Q_ALLOCATED
, &
queue
->
Êags
);

1357 
	`nvme_t˝_öô_ªcv_˘x
(
queue
);

1359 
	`wrôe_lock_bh
(&
queue
->
sock
->
sk
->
sk_ˇŒback_lock
);

1360 
queue
->
sock
->
sk
->
sk_u£r_d©a
 = queue;

1361 
queue
->
°©e_ch™ge
 = queue->
sock
->
sk
->
sk_°©e_ch™ge
;

1362 
queue
->
d©a_ªady
 = queue->
sock
->
sk
->
sk_d©a_ªady
;

1363 
queue
->
wrôe_•a˚
 = queue->
sock
->
sk
->
sk_wrôe_•a˚
;

1364 
queue
->
sock
->
sk
->
sk_d©a_ªady
 = 
nvme_t˝_d©a_ªady
;

1365 
queue
->
sock
->
sk
->
sk_°©e_ch™ge
 = 
nvme_t˝_°©e_ch™ge
;

1366 
queue
->
sock
->
sk
->
sk_wrôe_•a˚
 = 
nvme_t˝_wrôe_•a˚
;

1367 
	`wrôe_u∆ock_bh
(&
queue
->
sock
->
sk
->
sk_ˇŒback_lock
);

1371 
îr_öô_c⁄√˘
:

1372 
	`kî√l_sock_shutdown
(
queue
->
sock
, 
SHUT_RDWR
);

1373 
îr_rcv_pdu
:

1374 
	`k‰ì
(
queue
->
pdu
);

1375 
îr_¸y±o
:

1376 i‡(
queue
->
hdr_dige°
 || queue->
d©a_dige°
)

1377 
	`nvme_t˝_‰ì_¸y±o
(
queue
);

1378 
îr_sock
:

1379 
	`sock_ªÀa£
(
queue
->
sock
);

1380 
queue
->
sock
 = 
NULL
;

1381  
ªt
;

1382 
	}
}

1384 
	$nvme_t˝_ª°‹e_sock_ˇŒs
(
nvme_t˝_queue
 *
queue
)

1386 
sockë
 *
sock
 = 
queue
->sock;

1388 
	`wrôe_lock_bh
(&
sock
->
sk
->
sk_ˇŒback_lock
);

1389 
sock
->
sk
->
sk_u£r_d©a
 = 
NULL
;

1390 
sock
->
sk
->
sk_d©a_ªady
 = 
queue
->
d©a_ªady
;

1391 
sock
->
sk
->
sk_°©e_ch™ge
 = 
queue
->
°©e_ch™ge
;

1392 
sock
->
sk
->
sk_wrôe_•a˚
 = 
queue
->
wrôe_•a˚
;

1393 
	`wrôe_u∆ock_bh
(&
sock
->
sk
->
sk_ˇŒback_lock
);

1394 
	}
}

1396 
	$__nvme_t˝_°›_queue
(
nvme_t˝_queue
 *
queue
)

1398 
	`kî√l_sock_shutdown
(
queue
->
sock
, 
SHUT_RDWR
);

1399 
	`nvme_t˝_ª°‹e_sock_ˇŒs
(
queue
);

1400 
	`ˇn˚l_w‹k_sync
(&
queue
->
io_w‹k
);

1401 
	}
}

1403 
	$nvme_t˝_°›_queue
(
nvme_˘æ
 *
n˘æ
, 
qid
)

1405 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1406 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[
qid
];

1408 i‡(!
	`ã°_™d_˛ór_bô
(
NVME_TCP_Q_LIVE
, &
queue
->
Êags
))

1411 
	`__nvme_t˝_°›_queue
(
queue
);

1412 
	}
}

1414 
	$nvme_t˝_°¨t_queue
(
nvme_˘æ
 *
n˘æ
, 
idx
)

1416 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1417 
ªt
;

1419 i‡(
idx
)

1420 
ªt
 = 
	`nvmf_c⁄√˘_io_queue
(
n˘æ
, 
idx
, 
Ál£
);

1422 
ªt
 = 
	`nvmf_c⁄√˘_admö_queue
(
n˘æ
);

1424 i‡(!
ªt
) {

1425 
	`£t_bô
(
NVME_TCP_Q_LIVE
, &
˘æ
->
queues
[
idx
].
Êags
);

1427 i‡(
	`ã°_bô
(
NVME_TCP_Q_ALLOCATED
, &
˘æ
->
queues
[
idx
].
Êags
))

1428 
	`__nvme_t˝_°›_queue
(&
˘æ
->
queues
[
idx
]);

1429 
	`dev_îr
(
n˘æ
->
devi˚
,

1430 "ÁûedÅÿc⁄√˘ queue: %dÑë=%d\n", 
idx
, 
ªt
);

1432  
ªt
;

1433 
	}
}

1435 
blk_mq_èg_£t
 *
	$nvme_t˝_Æloc_èg£t
(
nvme_˘æ
 *
n˘æ
,

1436 
boﬁ
 
admö
)

1438 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1439 
blk_mq_èg_£t
 *
£t
;

1440 
ªt
;

1442 i‡(
admö
) {

1443 
£t
 = &
˘æ
->
admö_èg_£t
;

1444 
	`mem£t
(
£t
, 0, (*set));

1445 
£t
->
›s
 = &
nvme_t˝_admö_mq_›s
;

1446 
£t
->
queue_dïth
 = 
NVME_AQ_MQ_TAG_DEPTH
;

1447 
£t
->
ª£rved_ègs
 = 2;

1448 
£t
->
numa_node
 = 
NUMA_NO_NODE
;

1449 
£t
->
cmd_size
 = (
nvme_t˝_ªque°
);

1450 
£t
->
drivî_d©a
 = 
˘æ
;

1451 
£t
->
ƒ_hw_queues
 = 1;

1452 
£t
->
timeout
 = 
ADMIN_TIMEOUT
;

1454 
£t
 = &
˘æ
->
èg_£t
;

1455 
	`mem£t
(
£t
, 0, (*set));

1456 
£t
->
›s
 = &
nvme_t˝_mq_›s
;

1457 
£t
->
queue_dïth
 = 
n˘æ
->
sqsize
 + 1;

1458 
£t
->
ª£rved_ègs
 = 1;

1459 
£t
->
numa_node
 = 
NUMA_NO_NODE
;

1460 
£t
->
Êags
 = 
BLK_MQ_F_SHOULD_MERGE
;

1461 
£t
->
cmd_size
 = (
nvme_t˝_ªque°
);

1462 
£t
->
drivî_d©a
 = 
˘æ
;

1463 
£t
->
ƒ_hw_queues
 = 
n˘æ
->
queue_cou¡
 - 1;

1464 
£t
->
timeout
 = 
NVME_IO_TIMEOUT
;

1465 
£t
->
ƒ_m≠s
 = 2 ;

1468 
ªt
 = 
	`blk_mq_Æloc_èg_£t
(
£t
);

1469 i‡(
ªt
)

1470  
	`ERR_PTR
(
ªt
);

1472  
£t
;

1473 
	}
}

1475 
	$nvme_t˝_‰ì_admö_queue
(
nvme_˘æ
 *
˘æ
)

1477 i‡(
	`to_t˝_˘æ
(
˘æ
)->
async_ªq
.
pdu
) {

1478 
	`nvme_t˝_‰ì_async_ªq
(
	`to_t˝_˘æ
(
˘æ
));

1479 
	`to_t˝_˘æ
(
˘æ
)->
async_ªq
.
pdu
 = 
NULL
;

1482 
	`nvme_t˝_‰ì_queue
(
˘æ
, 0);

1483 
	}
}

1485 
	$nvme_t˝_‰ì_io_queues
(
nvme_˘æ
 *
˘æ
)

1487 
i
;

1489 
i
 = 1; i < 
˘æ
->
queue_cou¡
; i++)

1490 
	`nvme_t˝_‰ì_queue
(
˘æ
, 
i
);

1491 
	}
}

1493 
	$nvme_t˝_°›_io_queues
(
nvme_˘æ
 *
˘æ
)

1495 
i
;

1497 
i
 = 1; i < 
˘æ
->
queue_cou¡
; i++)

1498 
	`nvme_t˝_°›_queue
(
˘æ
, 
i
);

1499 
	}
}

1501 
	$nvme_t˝_°¨t_io_queues
(
nvme_˘æ
 *
˘æ
)

1503 
i
, 
ªt
 = 0;

1505 
i
 = 1; i < 
˘æ
->
queue_cou¡
; i++) {

1506 
ªt
 = 
	`nvme_t˝_°¨t_queue
(
˘æ
, 
i
);

1507 i‡(
ªt
)

1508 
out_°›_queues
;

1513 
out_°›_queues
:

1514 
i
--; i >= 1; i--)

1515 
	`nvme_t˝_°›_queue
(
˘æ
, 
i
);

1516  
ªt
;

1517 
	}
}

1519 
	$nvme_t˝_Æloc_admö_queue
(
nvme_˘æ
 *
˘æ
)

1521 
ªt
;

1523 
ªt
 = 
	`nvme_t˝_Æloc_queue
(
˘æ
, 0, 
NVME_AQ_DEPTH
);

1524 i‡(
ªt
)

1525  
ªt
;

1527 
ªt
 = 
	`nvme_t˝_Æloc_async_ªq
(
	`to_t˝_˘æ
(
˘æ
));

1528 i‡(
ªt
)

1529 
out_‰ì_queue
;

1533 
out_‰ì_queue
:

1534 
	`nvme_t˝_‰ì_queue
(
˘æ
, 0);

1535  
ªt
;

1536 
	}
}

1538 
	$__nvme_t˝_Æloc_io_queues
(
nvme_˘æ
 *
˘æ
)

1540 
i
, 
ªt
;

1542 
i
 = 1; i < 
˘æ
->
queue_cou¡
; i++) {

1543 
ªt
 = 
	`nvme_t˝_Æloc_queue
(
˘æ
, 
i
,

1544 
˘æ
->
sqsize
 + 1);

1545 i‡(
ªt
)

1546 
out_‰ì_queues
;

1551 
out_‰ì_queues
:

1552 
i
--; i >= 1; i--)

1553 
	`nvme_t˝_‰ì_queue
(
˘æ
, 
i
);

1555  
ªt
;

1556 
	}
}

1558 
	$nvme_t˝_ƒ_io_queues
(
nvme_˘æ
 *
˘æ
)

1560 
ƒ_io_queues
;

1562 
ƒ_io_queues
 = 
	`mö
(
˘æ
->
›ts
->ƒ_io_queues, 
	`num_⁄löe_˝us
());

1563 
ƒ_io_queues
 +
	`mö
(
˘æ
->
›ts
->
ƒ_wrôe_queues
, 
	`num_⁄löe_˝us
());

1565  
ƒ_io_queues
;

1566 
	}
}

1568 
	$nvme_t˝_£t_io_queues
(
nvme_˘æ
 *
n˘æ
,

1569 
ƒ_io_queues
)

1571 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1572 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
n˘æ
->opts;

1574 i‡(
›ts
->
ƒ_wrôe_queues
 && o±s->
ƒ_io_queues
 <Çr_io_queues) {

1580 
˘æ
->
io_queues
[
HCTX_TYPE_READ
] = 
›ts
->
ƒ_io_queues
;

1581 
ƒ_io_queues
 -
˘æ
->
io_queues
[
HCTX_TYPE_READ
];

1582 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
] =

1583 
	`mö
(
›ts
->
ƒ_wrôe_queues
, 
ƒ_io_queues
);

1584 
ƒ_io_queues
 -
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

1591 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
] =

1592 
	`mö
(
›ts
->
ƒ_io_queues
,Çr_io_queues);

1593 
ƒ_io_queues
 -
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

1595 
	}
}

1597 
	$nvme_t˝_Æloc_io_queues
(
nvme_˘æ
 *
˘æ
)

1599 
ƒ_io_queues
;

1600 
ªt
;

1602 
ƒ_io_queues
 = 
	`nvme_t˝_ƒ_io_queues
(
˘æ
);

1603 
ªt
 = 
	`nvme_£t_queue_cou¡
(
˘æ
, &
ƒ_io_queues
);

1604 i‡(
ªt
)

1605  
ªt
;

1607 
˘æ
->
queue_cou¡
 = 
ƒ_io_queues
 + 1;

1608 i‡(
˘æ
->
queue_cou¡
 < 2)

1611 
	`dev_öfo
(
˘æ
->
devi˚
,

1612 "¸ótög %d I/O queues.\n", 
ƒ_io_queues
);

1614 
	`nvme_t˝_£t_io_queues
(
˘æ
, 
ƒ_io_queues
);

1616  
	`__nvme_t˝_Æloc_io_queues
(
˘æ
);

1617 
	}
}

1619 
	$nvme_t˝_de°roy_io_queues
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
ªmove
)

1621 
	`nvme_t˝_°›_io_queues
(
˘æ
);

1622 i‡(
ªmove
) {

1623 
	`blk_˛ónup_queue
(
˘æ
->
c⁄√˘_q
);

1624 
	`blk_mq_‰ì_èg_£t
(
˘æ
->
èg£t
);

1626 
	`nvme_t˝_‰ì_io_queues
(
˘æ
);

1627 
	}
}

1629 
	$nvme_t˝_c⁄figuª_io_queues
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
√w
)

1631 
ªt
;

1633 
ªt
 = 
	`nvme_t˝_Æloc_io_queues
(
˘æ
);

1634 i‡(
ªt
)

1635  
ªt
;

1637 i‡(
√w
) {

1638 
˘æ
->
èg£t
 = 
	`nvme_t˝_Æloc_èg£t
(˘æ, 
Ál£
);

1639 i‡(
	`IS_ERR
(
˘æ
->
èg£t
)) {

1640 
ªt
 = 
	`PTR_ERR
(
˘æ
->
èg£t
);

1641 
out_‰ì_io_queues
;

1644 
˘æ
->
c⁄√˘_q
 = 
	`blk_mq_öô_queue
(˘æ->
èg£t
);

1645 i‡(
	`IS_ERR
(
˘æ
->
c⁄√˘_q
)) {

1646 
ªt
 = 
	`PTR_ERR
(
˘æ
->
c⁄√˘_q
);

1647 
out_‰ì_èg_£t
;

1650 
	`blk_mq_upd©e_ƒ_hw_queues
(
˘æ
->
èg£t
,

1651 
˘æ
->
queue_cou¡
 - 1);

1654 
ªt
 = 
	`nvme_t˝_°¨t_io_queues
(
˘æ
);

1655 i‡(
ªt
)

1656 
out_˛ónup_c⁄√˘_q
;

1660 
out_˛ónup_c⁄√˘_q
:

1661 i‡(
√w
)

1662 
	`blk_˛ónup_queue
(
˘æ
->
c⁄√˘_q
);

1663 
out_‰ì_èg_£t
:

1664 i‡(
√w
)

1665 
	`blk_mq_‰ì_èg_£t
(
˘æ
->
èg£t
);

1666 
out_‰ì_io_queues
:

1667 
	`nvme_t˝_‰ì_io_queues
(
˘æ
);

1668  
ªt
;

1669 
	}
}

1671 
	$nvme_t˝_de°roy_admö_queue
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
ªmove
)

1673 
	`nvme_t˝_°›_queue
(
˘æ
, 0);

1674 i‡(
ªmove
) {

1675 
	`blk_˛ónup_queue
(
˘æ
->
admö_q
);

1676 
	`blk_mq_‰ì_èg_£t
(
˘æ
->
admö_èg£t
);

1678 
	`nvme_t˝_‰ì_admö_queue
(
˘æ
);

1679 
	}
}

1681 
	$nvme_t˝_c⁄figuª_admö_queue
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
√w
)

1683 
îr‹
;

1685 
îr‹
 = 
	`nvme_t˝_Æloc_admö_queue
(
˘æ
);

1686 i‡(
îr‹
)

1687  
îr‹
;

1689 i‡(
√w
) {

1690 
˘æ
->
admö_èg£t
 = 
	`nvme_t˝_Æloc_èg£t
(˘æ, 
åue
);

1691 i‡(
	`IS_ERR
(
˘æ
->
admö_èg£t
)) {

1692 
îr‹
 = 
	`PTR_ERR
(
˘æ
->
admö_èg£t
);

1693 
out_‰ì_queue
;

1696 
˘æ
->
admö_q
 = 
	`blk_mq_öô_queue
(˘æ->
admö_èg£t
);

1697 i‡(
	`IS_ERR
(
˘æ
->
admö_q
)) {

1698 
îr‹
 = 
	`PTR_ERR
(
˘æ
->
admö_q
);

1699 
out_‰ì_èg£t
;

1703 
îr‹
 = 
	`nvme_t˝_°¨t_queue
(
˘æ
, 0);

1704 i‡(
îr‹
)

1705 
out_˛ónup_queue
;

1707 
îr‹
 = 
˘æ
->
›s
->
	`ªg_ªad64
(˘æ, 
NVME_REG_CAP
, &˘æ->
ˇp
);

1708 i‡(
îr‹
) {

1709 
	`dev_îr
(
˘æ
->
devi˚
,

1711 
out_°›_queue
;

1714 
˘æ
->
sqsize
 = 
	`mö_t
(, 
	`NVME_CAP_MQES
(˘æ->
ˇp
), ctrl->sqsize);

1716 
îr‹
 = 
	`nvme_íabÀ_˘æ
(
˘æ
, cål->
ˇp
);

1717 i‡(
îr‹
)

1718 
out_°›_queue
;

1720 
îr‹
 = 
	`nvme_öô_idítify
(
˘æ
);

1721 i‡(
îr‹
)

1722 
out_°›_queue
;

1726 
out_°›_queue
:

1727 
	`nvme_t˝_°›_queue
(
˘æ
, 0);

1728 
out_˛ónup_queue
:

1729 i‡(
√w
)

1730 
	`blk_˛ónup_queue
(
˘æ
->
admö_q
);

1731 
out_‰ì_èg£t
:

1732 i‡(
√w
)

1733 
	`blk_mq_‰ì_èg_£t
(
˘æ
->
admö_èg£t
);

1734 
out_‰ì_queue
:

1735 
	`nvme_t˝_‰ì_admö_queue
(
˘æ
);

1736  
îr‹
;

1737 
	}
}

1739 
	$nvme_t˝_ã¨down_admö_queue
(
nvme_˘æ
 *
˘æ
,

1740 
boﬁ
 
ªmove
)

1742 
	`blk_mq_quõs˚_queue
(
˘æ
->
admö_q
);

1743 
	`nvme_t˝_°›_queue
(
˘æ
, 0);

1744 i‡(
˘æ
->
admö_èg£t
)

1745 
	`blk_mq_èg£t_busy_ôî
(
˘æ
->
admö_èg£t
,

1746 
nvme_ˇn˚l_ªque°
, 
˘æ
);

1747 
	`blk_mq_unquõs˚_queue
(
˘æ
->
admö_q
);

1748 
	`nvme_t˝_de°roy_admö_queue
(
˘æ
, 
ªmove
);

1749 
	}
}

1751 
	$nvme_t˝_ã¨down_io_queues
(
nvme_˘æ
 *
˘æ
,

1752 
boﬁ
 
ªmove
)

1754 i‡(
˘æ
->
queue_cou¡
 <= 1)

1756 
	`nvme_°›_queues
(
˘æ
);

1757 
	`nvme_t˝_°›_io_queues
(
˘æ
);

1758 i‡(
˘æ
->
èg£t
)

1759 
	`blk_mq_èg£t_busy_ôî
(
˘æ
->
èg£t
,

1760 
nvme_ˇn˚l_ªque°
, 
˘æ
);

1761 i‡(
ªmove
)

1762 
	`nvme_°¨t_queues
(
˘æ
);

1763 
	`nvme_t˝_de°roy_io_queues
(
˘æ
, 
ªmove
);

1764 
	}
}

1766 
	$nvme_t˝_ªc⁄√˘_‹_ªmove
(
nvme_˘æ
 *
˘æ
)

1769 i‡(
˘æ
->
°©e
 !
NVME_CTRL_CONNECTING
) {

1770 
	`WARN_ON_ONCE
(
˘æ
->
°©e
 =
NVME_CTRL_NEW
 ||

1771 
˘æ
->
°©e
 =
NVME_CTRL_LIVE
);

1775 i‡(
	`nvmf_should_ªc⁄√˘
(
˘æ
)) {

1776 
	`dev_öfo
(
˘æ
->
devi˚
, "Reconnecting in %d seconds...\n",

1777 
˘æ
->
›ts
->
ªc⁄√˘_dñay
);

1778 
	`queue_dñayed_w‹k
(
nvme_wq
, &
	`to_t˝_˘æ
(
˘æ
)->
c⁄√˘_w‹k
,

1779 
˘æ
->
›ts
->
ªc⁄√˘_dñay
 * 
HZ
);

1781 
	`dev_öfo
(
˘æ
->
devi˚
, "Removing controller...\n");

1782 
	`nvme_dñëe_˘æ
(
˘æ
);

1784 
	}
}

1786 
	$nvme_t˝_£tup_˘æ
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
√w
)

1788 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->opts;

1789 
ªt
 = -
EINVAL
;

1791 
ªt
 = 
	`nvme_t˝_c⁄figuª_admö_queue
(
˘æ
, 
√w
);

1792 i‡(
ªt
)

1793  
ªt
;

1795 i‡(
˘æ
->
icdoff
) {

1796 
	`dev_îr
(
˘æ
->
devi˚
, "icdoff isÇot supported!\n");

1797 
de°roy_admö
;

1800 i‡(
›ts
->
queue_size
 > 
˘æ
->
sqsize
 + 1)

1801 
	`dev_w¨n
(
˘æ
->
devi˚
,

1803 
›ts
->
queue_size
, 
˘æ
->
sqsize
 + 1);

1805 i‡(
˘æ
->
sqsize
 + 1 > cål->
maxcmd
) {

1806 
	`dev_w¨n
(
˘æ
->
devi˚
,

1808 
˘æ
->
sqsize
 + 1, cål->
maxcmd
);

1809 
˘æ
->
sqsize
 = cål->
maxcmd
 - 1;

1812 i‡(
˘æ
->
queue_cou¡
 > 1) {

1813 
ªt
 = 
	`nvme_t˝_c⁄figuª_io_queues
(
˘æ
, 
√w
);

1814 i‡(
ªt
)

1815 
de°roy_admö
;

1818 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_LIVE
)) {

1820 
	`WARN_ON_ONCE
(
˘æ
->
°©e
 !
NVME_CTRL_DELETING
);

1821 
ªt
 = -
EINVAL
;

1822 
de°roy_io
;

1825 
	`nvme_°¨t_˘æ
(
˘æ
);

1828 
de°roy_io
:

1829 i‡(
˘æ
->
queue_cou¡
 > 1)

1830 
	`nvme_t˝_de°roy_io_queues
(
˘æ
, 
√w
);

1831 
de°roy_admö
:

1832 
	`nvme_t˝_°›_queue
(
˘æ
, 0);

1833 
	`nvme_t˝_de°roy_admö_queue
(
˘æ
, 
√w
);

1834  
ªt
;

1835 
	}
}

1837 
	$nvme_t˝_ªc⁄√˘_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1839 
nvme_t˝_˘æ
 *
t˝_˘æ
 = 
	`c⁄èöî_of
(
	`to_dñayed_w‹k
(
w‹k
),

1840 
nvme_t˝_˘æ
, 
c⁄√˘_w‹k
);

1841 
nvme_˘æ
 *
˘æ
 = &
t˝_˘æ
->ctrl;

1843 ++
˘æ
->
ƒ_ªc⁄√˘s
;

1845 i‡(
	`nvme_t˝_£tup_˘æ
(
˘æ
, 
Ál£
))

1846 
ªqueue
;

1848 
	`dev_öfo
(
˘æ
->
devi˚
, "SuccessfullyÑeconnected (%dáttempt)\n",

1849 
˘æ
->
ƒ_ªc⁄√˘s
);

1851 
˘æ
->
ƒ_ªc⁄√˘s
 = 0;

1855 
ªqueue
:

1856 
	`dev_öfo
(
˘æ
->
devi˚
, "FailedÑeconnectáttempt %d\n",

1857 
˘æ
->
ƒ_ªc⁄√˘s
);

1858 
	`nvme_t˝_ªc⁄√˘_‹_ªmove
(
˘æ
);

1859 
	}
}

1861 
	$nvme_t˝_îr‹_ªcovîy_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1863 
nvme_t˝_˘æ
 *
t˝_˘æ
 = 
	`c⁄èöî_of
(
w‹k
,

1864 
nvme_t˝_˘æ
, 
îr_w‹k
);

1865 
nvme_˘æ
 *
˘æ
 = &
t˝_˘æ
->ctrl;

1867 
	`nvme_°›_kìp_Æive
(
˘æ
);

1868 
	`nvme_t˝_ã¨down_io_queues
(
˘æ
, 
Ál£
);

1870 
	`nvme_°¨t_queues
(
˘æ
);

1871 
	`nvme_t˝_ã¨down_admö_queue
(
˘æ
, 
Ál£
);

1873 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_CONNECTING
)) {

1875 
	`WARN_ON_ONCE
(
˘æ
->
°©e
 !
NVME_CTRL_DELETING
);

1879 
	`nvme_t˝_ªc⁄√˘_‹_ªmove
(
˘æ
);

1880 
	}
}

1882 
	$nvme_t˝_ã¨down_˘æ
(
nvme_˘æ
 *
˘æ
, 
boﬁ
 
shutdown
)

1884 
	`ˇn˚l_w‹k_sync
(&
	`to_t˝_˘æ
(
˘æ
)->
îr_w‹k
);

1885 
	`ˇn˚l_dñayed_w‹k_sync
(&
	`to_t˝_˘æ
(
˘æ
)->
c⁄√˘_w‹k
);

1887 
	`nvme_t˝_ã¨down_io_queues
(
˘æ
, 
shutdown
);

1888 i‡(
shutdown
)

1889 
	`nvme_shutdown_˘æ
(
˘æ
);

1891 
	`nvme_dißbÀ_˘æ
(
˘æ
, cål->
ˇp
);

1892 
	`nvme_t˝_ã¨down_admö_queue
(
˘æ
, 
shutdown
);

1893 
	}
}

1895 
	$nvme_t˝_dñëe_˘æ
(
nvme_˘æ
 *
˘æ
)

1897 
	`nvme_t˝_ã¨down_˘æ
(
˘æ
, 
åue
);

1898 
	}
}

1900 
	$nvme_ª£t_˘æ_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1902 
nvme_˘æ
 *
˘æ
 =

1903 
	`c⁄èöî_of
(
w‹k
, 
nvme_˘æ
, 
ª£t_w‹k
);

1905 
	`nvme_°›_˘æ
(
˘æ
);

1906 
	`nvme_t˝_ã¨down_˘æ
(
˘æ
, 
Ál£
);

1908 i‡(!
	`nvme_ch™ge_˘æ_°©e
(
˘æ
, 
NVME_CTRL_CONNECTING
)) {

1910 
	`WARN_ON_ONCE
(
˘æ
->
°©e
 !
NVME_CTRL_DELETING
);

1914 i‡(
	`nvme_t˝_£tup_˘æ
(
˘æ
, 
Ál£
))

1915 
out_Áû
;

1919 
out_Áû
:

1920 ++
˘æ
->
ƒ_ªc⁄√˘s
;

1921 
	`nvme_t˝_ªc⁄√˘_‹_ªmove
(
˘æ
);

1922 
	}
}

1924 
	$nvme_t˝_‰ì_˘æ
(
nvme_˘æ
 *
n˘æ
)

1926 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
n˘æ
);

1928 i‡(
	`li°_em±y
(&
˘æ
->
li°
))

1929 
‰ì_˘æ
;

1931 
	`muãx_lock
(&
nvme_t˝_˘æ_muãx
);

1932 
	`li°_dñ
(&
˘æ
->
li°
);

1933 
	`muãx_u∆ock
(&
nvme_t˝_˘æ_muãx
);

1935 
	`nvmf_‰ì_›ti⁄s
(
n˘æ
->
›ts
);

1936 
‰ì_˘æ
:

1937 
	`k‰ì
(
˘æ
->
queues
);

1938 
	`k‰ì
(
˘æ
);

1939 
	}
}

1941 
	$nvme_t˝_£t_sg_nuŒ
(
nvme_comm™d
 *
c
)

1943 
nvme_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
sgl
;

1945 
sg
->
addr
 = 0;

1946 
sg
->
Àngth
 = 0;

1947 
sg
->
ty≥
 = (
NVME_TRANSPORT_SGL_DATA_DESC
 << 4) |

1948 
NVME_SGL_FMT_TRANSPORT_A
;

1949 
	}
}

1951 
	$nvme_t˝_£t_sg_ölöe
(
nvme_t˝_queue
 *
queue
,

1952 
nvme_comm™d
 *
c
, 
u32
 
d©a_Àn
)

1954 
nvme_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
sgl
;

1956 
sg
->
addr
 = 
	`˝u_to_À64
(
queue
->
˘æ
->˘æ.
icdoff
);

1957 
sg
->
Àngth
 = 
	`˝u_to_À32
(
d©a_Àn
);

1958 
sg
->
ty≥
 = (
NVME_SGL_FMT_DATA_DESC
 << 4Ë| 
NVME_SGL_FMT_OFFSET
;

1959 
	}
}

1961 
	$nvme_t˝_£t_sg_ho°_d©a
(
nvme_comm™d
 *
c
,

1962 
u32
 
d©a_Àn
)

1964 
nvme_sgl_desc
 *
sg
 = &
c
->
comm⁄
.
d±r
.
sgl
;

1966 
sg
->
addr
 = 0;

1967 
sg
->
Àngth
 = 
	`˝u_to_À32
(
d©a_Àn
);

1968 
sg
->
ty≥
 = (
NVME_TRANSPORT_SGL_DATA_DESC
 << 4) |

1969 
NVME_SGL_FMT_TRANSPORT_A
;

1970 
	}
}

1972 
	$nvme_t˝_submô_async_evít
(
nvme_˘æ
 *
¨g
)

1974 
nvme_t˝_˘æ
 *
˘æ
 = 
	`to_t˝_˘æ
(
¨g
);

1975 
nvme_t˝_queue
 *
queue
 = &
˘æ
->
queues
[0];

1976 
nvme_t˝_cmd_pdu
 *
pdu
 = 
˘æ
->
async_ªq
.pdu;

1977 
nvme_comm™d
 *
cmd
 = &
pdu
->cmd;

1978 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
);

1980 
	`mem£t
(
pdu
, 0, (*pdu));

1981 
pdu
->
hdr
.
ty≥
 = 
nvme_t˝_cmd
;

1982 i‡(
queue
->
hdr_dige°
)

1983 
pdu
->
hdr
.
Êags
 |
NVME_TCP_F_HDGST
;

1984 
pdu
->
hdr
.
hÀn
 = (*pdu);

1985 
pdu
->
hdr
.
∂í
 = 
	`˝u_to_À32
’du->hdr.
hÀn
 + 
hdg°
);

1987 
cmd
->
comm⁄
.
›code
 = 
nvme_admö_async_evít
;

1988 
cmd
->
comm⁄
.
comm™d_id
 = 
NVME_AQ_BLK_MQ_DEPTH
;

1989 
cmd
->
comm⁄
.
Êags
 |
NVME_CMD_SGL_METABUF
;

1990 
	`nvme_t˝_£t_sg_nuŒ
(
cmd
);

1992 
˘æ
->
async_ªq
.
°©e
 = 
NVME_TCP_SEND_CMD_PDU
;

1993 
˘æ
->
async_ªq
.
off£t
 = 0;

1994 
˘æ
->
async_ªq
.
cuº_bio
 = 
NULL
;

1995 
˘æ
->
async_ªq
.
d©a_Àn
 = 0;

1997 
	`nvme_t˝_queue_ªque°
(&
˘æ
->
async_ªq
);

1998 
	}
}

2000 
blk_eh_timî_ªtu∫


2001 
	$nvme_t˝_timeout
(
ªque°
 *
rq
, 
boﬁ
 
ª£rved
)

2003 
nvme_t˝_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2004 
nvme_t˝_˘æ
 *
˘æ
 = 
ªq
->
queue
->ctrl;

2005 
nvme_t˝_cmd_pdu
 *
pdu
 = 
ªq
->pdu;

2007 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
,

2009 
	`nvme_t˝_queue_id
(
ªq
->
queue
), 
rq
->
èg
, 
pdu
->
hdr
.
ty≥
);

2011 i‡(
˘æ
->˘æ.
°©e
 !
NVME_CTRL_LIVE
) {

2017 
	`Êush_w‹k
(&
˘æ
->
îr_w‹k
);

2018 
	`nvme_t˝_ã¨down_io_queues
(&
˘æ
->˘æ, 
Ál£
);

2019 
	`nvme_t˝_ã¨down_admö_queue
(&
˘æ
->˘æ, 
Ál£
);

2020  
BLK_EH_DONE
;

2023 
	`dev_w¨n
(
˘æ
->˘æ.
devi˚
, "startingÉrrorÑecovery\n");

2024 
	`nvme_t˝_îr‹_ªcovîy
(&
˘æ
->ctrl);

2026  
BLK_EH_RESET_TIMER
;

2027 
	}
}

2029 
blk_°©us_t
 
	$nvme_t˝_m≠_d©a
(
nvme_t˝_queue
 *
queue
,

2030 
ªque°
 *
rq
)

2032 
nvme_t˝_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2033 
nvme_t˝_cmd_pdu
 *
pdu
 = 
ªq
->pdu;

2034 
nvme_comm™d
 *
c
 = &
pdu
->
cmd
;

2036 
c
->
comm⁄
.
Êags
 |
NVME_CMD_SGL_METABUF
;

2038 i‡(
	`rq_d©a_dú
(
rq
Ë=
WRITE
 && 
ªq
->
d©a_Àn
 &&

2039 
ªq
->
d©a_Àn
 <
	`nvme_t˝_ölöe_d©a_size
(
queue
))

2040 
	`nvme_t˝_£t_sg_ölöe
(
queue
, 
c
, 
ªq
->
d©a_Àn
);

2042 
	`nvme_t˝_£t_sg_ho°_d©a
(
c
, 
ªq
->
d©a_Àn
);

2045 
	}
}

2047 
blk_°©us_t
 
	$nvme_t˝_£tup_cmd_pdu
(
nvme_ns
 *
ns
,

2048 
ªque°
 *
rq
)

2050 
nvme_t˝_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2051 
nvme_t˝_cmd_pdu
 *
pdu
 = 
ªq
->pdu;

2052 
nvme_t˝_queue
 *
queue
 = 
ªq
->queue;

2053 
u8
 
hdg°
 = 
	`nvme_t˝_hdg°_Àn
(
queue
), 
ddg°
 = 0;

2054 
blk_°©us_t
 
ªt
;

2056 
ªt
 = 
	`nvme_£tup_cmd
(
ns
, 
rq
, &
pdu
->
cmd
);

2057 i‡(
ªt
)

2058  
ªt
;

2060 
ªq
->
°©e
 = 
NVME_TCP_SEND_CMD_PDU
;

2061 
ªq
->
off£t
 = 0;

2062 
ªq
->
d©a_£¡
 = 0;

2063 
ªq
->
pdu_Àn
 = 0;

2064 
ªq
->
pdu_£¡
 = 0;

2065 
ªq
->
d©a_Àn
 = 
	`blk_rq_∑ylﬂd_byãs
(
rq
);

2066 
ªq
->
cuº_bio
 = 
rq
->
bio
;

2068 i‡(
	`rq_d©a_dú
(
rq
Ë=
WRITE
 &&

2069 
ªq
->
d©a_Àn
 <
	`nvme_t˝_ölöe_d©a_size
(
queue
))

2070 
ªq
->
pdu_Àn
 =Ñeq->
d©a_Àn
;

2071 i‡(
ªq
->
cuº_bio
)

2072 
	`nvme_t˝_öô_ôî
(
ªq
, 
READ
);

2074 
pdu
->
hdr
.
ty≥
 = 
nvme_t˝_cmd
;

2075 
pdu
->
hdr
.
Êags
 = 0;

2076 i‡(
queue
->
hdr_dige°
)

2077 
pdu
->
hdr
.
Êags
 |
NVME_TCP_F_HDGST
;

2078 i‡(
queue
->
d©a_dige°
 && 
ªq
->
pdu_Àn
) {

2079 
pdu
->
hdr
.
Êags
 |
NVME_TCP_F_DDGST
;

2080 
ddg°
 = 
	`nvme_t˝_ddg°_Àn
(
queue
);

2082 
pdu
->
hdr
.
hÀn
 = (*pdu);

2083 
pdu
->
hdr
.
pdo
 = 
ªq
->
pdu_Àn
 ?Ödu->hdr.
hÀn
 + 
hdg°
 : 0;

2084 
pdu
->
hdr
.
∂í
 =

2085 
	`˝u_to_À32
(
pdu
->
hdr
.
hÀn
 + 
hdg°
 + 
ªq
->
pdu_Àn
 + 
ddg°
);

2087 
ªt
 = 
	`nvme_t˝_m≠_d©a
(
queue
, 
rq
);

2088 i‡(
	`u∆ikñy
(
ªt
)) {

2089 
	`dev_îr
(
queue
->
˘æ
->˘æ.
devi˚
,

2090 "FaûedÅÿm≠ d©®(%d)\n", 
ªt
);

2091  
ªt
;

2095 
	}
}

2097 
blk_°©us_t
 
	$nvme_t˝_queue_rq
(
blk_mq_hw_˘x
 *
h˘x
,

2098 c⁄° 
blk_mq_queue_d©a
 *
bd
)

2100 
nvme_ns
 *
ns
 = 
h˘x
->
queue
->
queued©a
;

2101 
nvme_t˝_queue
 *
queue
 = 
h˘x
->
drivî_d©a
;

2102 
ªque°
 *
rq
 = 
bd
->rq;

2103 
nvme_t˝_ªque°
 *
ªq
 = 
	`blk_mq_rq_to_pdu
(
rq
);

2104 
boﬁ
 
queue_ªady
 = 
	`ã°_bô
(
NVME_TCP_Q_LIVE
, &
queue
->
Êags
);

2105 
blk_°©us_t
 
ªt
;

2107 i‡(!
	`nvmf_check_ªady
(&
queue
->
˘æ
->˘æ, 
rq
, 
queue_ªady
))

2108  
	`nvmf_Áû_n⁄ªady_comm™d
(&
queue
->
˘æ
->˘æ, 
rq
);

2110 
ªt
 = 
	`nvme_t˝_£tup_cmd_pdu
(
ns
, 
rq
);

2111 i‡(
	`u∆ikñy
(
ªt
))

2112  
ªt
;

2114 
	`blk_mq_°¨t_ªque°
(
rq
);

2116 
	`nvme_t˝_queue_ªque°
(
ªq
);

2118  
BLK_STS_OK
;

2119 
	}
}

2121 
	$nvme_t˝_m≠_queues
(
blk_mq_èg_£t
 *
£t
)

2123 
nvme_t˝_˘æ
 *
˘æ
 = 
£t
->
drivî_d©a
;

2124 
nvmf_˘æ_›ti⁄s
 *
›ts
 = 
˘æ
->ctrl.opts;

2126 i‡(
›ts
->
ƒ_wrôe_queues
 && 
˘æ
->
io_queues
[
HCTX_TYPE_READ
]) {

2128 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
ƒ_queues
 =

2129 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

2130 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
queue_off£t
 = 0;

2131 
£t
->
m≠
[
HCTX_TYPE_READ
].
ƒ_queues
 =

2132 
˘æ
->
io_queues
[
HCTX_TYPE_READ
];

2133 
£t
->
m≠
[
HCTX_TYPE_READ
].
queue_off£t
 =

2134 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

2137 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
ƒ_queues
 =

2138 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

2139 
£t
->
m≠
[
HCTX_TYPE_DEFAULT
].
queue_off£t
 = 0;

2140 
£t
->
m≠
[
HCTX_TYPE_READ
].
ƒ_queues
 =

2141 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
];

2142 
£t
->
m≠
[
HCTX_TYPE_READ
].
queue_off£t
 = 0;

2144 
	`blk_mq_m≠_queues
(&
£t
->
m≠
[
HCTX_TYPE_DEFAULT
]);

2145 
	`blk_mq_m≠_queues
(&
£t
->
m≠
[
HCTX_TYPE_READ
]);

2147 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
,

2149 
˘æ
->
io_queues
[
HCTX_TYPE_DEFAULT
],

2150 
˘æ
->
io_queues
[
HCTX_TYPE_READ
]);

2153 
	}
}

2155 
blk_mq_›s
 
	gnvme_t˝_mq_›s
 = {

2156 .
queue_rq
 = 
nvme_t˝_queue_rq
,

2157 .
	gcom∂ëe
 = 
nvme_com∂ëe_rq
,

2158 .
	göô_ªque°
 = 
nvme_t˝_öô_ªque°
,

2159 .
	gexô_ªque°
 = 
nvme_t˝_exô_ªque°
,

2160 .
	göô_h˘x
 = 
nvme_t˝_öô_h˘x
,

2161 .
	gtimeout
 = 
nvme_t˝_timeout
,

2162 .
	gm≠_queues
 = 
nvme_t˝_m≠_queues
,

2165 
blk_mq_›s
 
	gnvme_t˝_admö_mq_›s
 = {

2166 .
queue_rq
 = 
nvme_t˝_queue_rq
,

2167 .
	gcom∂ëe
 = 
nvme_com∂ëe_rq
,

2168 .
	göô_ªque°
 = 
nvme_t˝_öô_ªque°
,

2169 .
	gexô_ªque°
 = 
nvme_t˝_exô_ªque°
,

2170 .
	göô_h˘x
 = 
nvme_t˝_öô_admö_h˘x
,

2171 .
	gtimeout
 = 
nvme_t˝_timeout
,

2174 c⁄° 
nvme_˘æ_›s
 
	gnvme_t˝_˘æ_›s
 = {

2175 .
«me
 = "tcp",

2176 .
	gmoduÀ
 = 
THIS_MODULE
,

2177 .
	gÊags
 = 
NVME_F_FABRICS
,

2178 .
	gªg_ªad32
 = 
nvmf_ªg_ªad32
,

2179 .
	gªg_ªad64
 = 
nvmf_ªg_ªad64
,

2180 .
	gªg_wrôe32
 = 
nvmf_ªg_wrôe32
,

2181 .
	g‰ì_˘æ
 = 
nvme_t˝_‰ì_˘æ
,

2182 .
	gsubmô_async_evít
 = 
nvme_t˝_submô_async_evít
,

2183 .
	gdñëe_˘æ
 = 
nvme_t˝_dñëe_˘æ
,

2184 .
	ggë_addªss
 = 
nvmf_gë_addªss
,

2187 
boﬁ


2188 
	$nvme_t˝_exi°ög_c⁄åﬁÀr
(
nvmf_˘æ_›ti⁄s
 *
›ts
)

2190 
nvme_t˝_˘æ
 *
˘æ
;

2191 
boﬁ
 
found
 = 
Ál£
;

2193 
	`muãx_lock
(&
nvme_t˝_˘æ_muãx
);

2194 
	`li°_f‹_óch_íåy
(
˘æ
, &
nvme_t˝_˘æ_li°
, 
li°
) {

2195 
found
 = 
	`nvmf_ù_›ti⁄s_m©ch
(&
˘æ
->˘æ, 
›ts
);

2196 i‡(
found
)

2199 
	`muãx_u∆ock
(&
nvme_t˝_˘æ_muãx
);

2201  
found
;

2202 
	}
}

2204 
nvme_˘æ
 *
	$nvme_t˝_¸óã_˘æ
(
devi˚
 *
dev
,

2205 
nvmf_˘æ_›ti⁄s
 *
›ts
)

2207 
nvme_t˝_˘æ
 *
˘æ
;

2208 
ªt
;

2210 
˘æ
 = 
	`kzÆloc
((*˘æ), 
GFP_KERNEL
);

2211 i‡(!
˘æ
)

2212  
	`ERR_PTR
(-
ENOMEM
);

2214 
	`INIT_LIST_HEAD
(&
˘æ
->
li°
);

2215 
˘æ
->˘æ.
›ts
 = opts;

2216 
˘æ
->˘æ.
queue_cou¡
 = 
›ts
->
ƒ_io_queues
 + o±s->
ƒ_wrôe_queues
 + 1;

2217 
˘æ
->˘æ.
sqsize
 = 
›ts
->
queue_size
 - 1;

2218 
˘æ
->˘æ.
k©o
 = 
›ts
->kato;

2220 
	`INIT_DELAYED_WORK
(&
˘æ
->
c⁄√˘_w‹k
,

2221 
nvme_t˝_ªc⁄√˘_˘æ_w‹k
);

2222 
	`INIT_WORK
(&
˘æ
->
îr_w‹k
, 
nvme_t˝_îr‹_ªcovîy_w‹k
);

2223 
	`INIT_WORK
(&
˘æ
->˘æ.
ª£t_w‹k
, 
nvme_ª£t_˘æ_w‹k
);

2225 i‡(!(
›ts
->
mask
 & 
NVMF_OPT_TRSVCID
)) {

2226 
›ts
->
åsvcid
 =

2227 
	`k°rdup
(
	`__°rögify
(
NVME_TCP_DISC_PORT
), 
GFP_KERNEL
);

2228 i‡(!
›ts
->
åsvcid
) {

2229 
ªt
 = -
ENOMEM
;

2230 
out_‰ì_˘æ
;

2232 
›ts
->
mask
 |
NVMF_OPT_TRSVCID
;

2235 
ªt
 = 
	`öë_±⁄_wôh_sc›e
(&
öô_√t
, 
AF_UNSPEC
,

2236 
›ts
->
åaddr
, o±s->
åsvcid
, &
˘æ
->
addr
);

2237 i‡(
ªt
) {

2238 
	`¥_îr
("malformedáddressÖassed: %s:%s\n",

2239 
›ts
->
åaddr
, o±s->
åsvcid
);

2240 
out_‰ì_˘æ
;

2243 i‡(
›ts
->
mask
 & 
NVMF_OPT_HOST_TRADDR
) {

2244 
ªt
 = 
	`öë_±⁄_wôh_sc›e
(&
öô_√t
, 
AF_UNSPEC
,

2245 
›ts
->
ho°_åaddr
, 
NULL
, &
˘æ
->
§c_addr
);

2246 i‡(
ªt
) {

2247 
	`¥_îr
("malformed srcáddressÖassed: %s\n",

2248 
›ts
->
ho°_åaddr
);

2249 
out_‰ì_˘æ
;

2253 i‡(!
›ts
->
du∂iˇã_c⁄√˘
 && 
	`nvme_t˝_exi°ög_c⁄åﬁÀr
(opts)) {

2254 
ªt
 = -
EALREADY
;

2255 
out_‰ì_˘æ
;

2258 
˘æ
->
queues
 = 
	`kˇŒoc
(˘æ->˘æ.
queue_cou¡
, (*ctrl->queues),

2259 
GFP_KERNEL
);

2260 i‡(!
˘æ
->
queues
) {

2261 
ªt
 = -
ENOMEM
;

2262 
out_‰ì_˘æ
;

2265 
ªt
 = 
	`nvme_öô_˘æ
(&
˘æ
->˘æ, 
dev
, &
nvme_t˝_˘æ_›s
, 0);

2266 i‡(
ªt
)

2267 
out_k‰ì_queues
;

2269 i‡(!
	`nvme_ch™ge_˘æ_°©e
(&
˘æ
->˘æ, 
NVME_CTRL_CONNECTING
)) {

2270 
	`WARN_ON_ONCE
(1);

2271 
ªt
 = -
EINTR
;

2272 
out_unöô_˘æ
;

2275 
ªt
 = 
	`nvme_t˝_£tup_˘æ
(&
˘æ
->˘æ, 
åue
);

2276 i‡(
ªt
)

2277 
out_unöô_˘æ
;

2279 
	`dev_öfo
(
˘æ
->˘æ.
devi˚
, "new ctrl: NQN \"%s\",áddr %pISp\n",

2280 
˘æ
->˘æ.
›ts
->
subsy¢qn
, &˘æ->
addr
);

2282 
	`nvme_gë_˘æ
(&
˘æ
->ctrl);

2284 
	`muãx_lock
(&
nvme_t˝_˘æ_muãx
);

2285 
	`li°_add_èû
(&
˘æ
->
li°
, &
nvme_t˝_˘æ_li°
);

2286 
	`muãx_u∆ock
(&
nvme_t˝_˘æ_muãx
);

2288  &
˘æ
->ctrl;

2290 
out_unöô_˘æ
:

2291 
	`nvme_unöô_˘æ
(&
˘æ
->ctrl);

2292 
	`nvme_put_˘æ
(&
˘æ
->ctrl);

2293 i‡(
ªt
 > 0)

2294 
ªt
 = -
EIO
;

2295  
	`ERR_PTR
(
ªt
);

2296 
out_k‰ì_queues
:

2297 
	`k‰ì
(
˘æ
->
queues
);

2298 
out_‰ì_˘æ
:

2299 
	`k‰ì
(
˘æ
);

2300  
	`ERR_PTR
(
ªt
);

2301 
	}
}

2303 
nvmf_å™•‹t_›s
 
	gnvme_t˝_å™•‹t
 = {

2304 .
«me
 = "tcp",

2305 .
	gmoduÀ
 = 
THIS_MODULE
,

2306 .
	gªquúed_›ts
 = 
NVMF_OPT_TRADDR
,

2307 .
	gÆlowed_›ts
 = 
NVMF_OPT_TRSVCID
 | 
NVMF_OPT_RECONNECT_DELAY
 |

2308 
NVMF_OPT_HOST_TRADDR
 | 
NVMF_OPT_CTRL_LOSS_TMO
 |

2309 
NVMF_OPT_HDR_DIGEST
 | 
NVMF_OPT_DATA_DIGEST
 |

2310 
NVMF_OPT_NR_WRITE_QUEUES
,

2311 .
	g¸óã_˘æ
 = 
nvme_t˝_¸óã_˘æ
,

2314 
__öô
 
	$nvme_t˝_öô_moduÀ
()

2316 
nvme_t˝_wq
 = 
	`Æloc_w‹kqueue
("nvme_tcp_wq",

2317 
WQ_MEM_RECLAIM
 | 
WQ_HIGHPRI
, 0);

2318 i‡(!
nvme_t˝_wq
)

2319  -
ENOMEM
;

2321 
	`nvmf_ªgi°î_å™•‹t
(&
nvme_t˝_å™•‹t
);

2323 
	}
}

2325 
__exô
 
	$nvme_t˝_˛ónup_moduÀ
()

2327 
nvme_t˝_˘æ
 *
˘æ
;

2329 
	`nvmf_uƒegi°î_å™•‹t
(&
nvme_t˝_å™•‹t
);

2331 
	`muãx_lock
(&
nvme_t˝_˘æ_muãx
);

2332 
	`li°_f‹_óch_íåy
(
˘æ
, &
nvme_t˝_˘æ_li°
, 
li°
)

2333 
	`nvme_dñëe_˘æ
(&
˘æ
->ctrl);

2334 
	`muãx_u∆ock
(&
nvme_t˝_˘æ_muãx
);

2335 
	`Êush_w‹kqueue
(
nvme_dñëe_wq
);

2337 
	`de°roy_w‹kqueue
(
nvme_t˝_wq
);

2338 
	}
}

2340 
moduÀ_öô
(
nvme_t˝_öô_moduÀ
);

2341 
moduÀ_exô
(
nvme_t˝_˛ónup_moduÀ
);

2343 
MODULE_LICENSE
("GPL v2");

	@trace.c

7 
	~<asm/u«lig√d.h
>

8 
	~"åa˚.h
"

10 c⁄° *
	$nvme_åa˚_¸óã_sq
(
åa˚_£q
 *
p
, 
u8
 *
cdw10
)

12 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

13 
u16
 
sqid
 = 
	`gë_u«lig√d_À16
(
cdw10
);

14 
u16
 
qsize
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 2);

15 
u16
 
sq_Êags
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 4);

16 
u16
 
cqid
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 6);

19 
	`åa˚_£q_¥ötf
(
p
, "sqid=%u, qsize=%u, sq_flags=0x%x, cqid=%u",

20 
sqid
, 
qsize
, 
sq_Êags
, 
cqid
);

21 
	`åa˚_£q_putc
(
p
, 0);

23  
ªt
;

24 
	}
}

26 c⁄° *
	$nvme_åa˚_¸óã_cq
(
åa˚_£q
 *
p
, 
u8
 *
cdw10
)

28 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

29 
u16
 
cqid
 = 
	`gë_u«lig√d_À16
(
cdw10
);

30 
u16
 
qsize
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 2);

31 
u16
 
cq_Êags
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 4);

32 
u16
 
úq_ve˘‹
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 6);

34 
	`åa˚_£q_¥ötf
(
p
, "cqid=%u, qsize=%u, cq_flags=0x%x, irq_vector=%u",

35 
cqid
, 
qsize
, 
cq_Êags
, 
úq_ve˘‹
);

36 
	`åa˚_£q_putc
(
p
, 0);

38  
ªt
;

39 
	}
}

41 c⁄° *
	$nvme_åa˚_admö_idítify
(
åa˚_£q
 *
p
, 
u8
 *
cdw10
)

43 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

44 
u8
 
˙s
 = 
cdw10
[0];

45 
u16
 
˘æid
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 2);

47 
	`åa˚_£q_¥ötf
(
p
, "˙s=%u, cålid=%u", 
˙s
, 
˘æid
);

48 
	`åa˚_£q_putc
(
p
, 0);

50  
ªt
;

51 
	}
}

53 c⁄° *
	$nvme_åa˚_admö_gë_„©uªs
(
åa˚_£q
 *
p
,

54 
u8
 *
cdw10
)

56 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

57 
u8
 
fid
 = 
cdw10
[0];

58 
u8
 
£l
 = 
cdw10
[1] & 0x7;

59 
u32
 
cdw11
 = 
	`gë_u«lig√d_À32
(
cdw10
 + 4);

61 
	`åa˚_£q_¥ötf
(
p
, "fid=0x%x sñ=0x%x cdw11=0x%x", 
fid
, 
£l
, 
cdw11
);

62 
	`åa˚_£q_putc
(
p
, 0);

64  
ªt
;

65 
	}
}

67 c⁄° *
	$nvme_åa˚_ªad_wrôe
(
åa˚_£q
 *
p
, 
u8
 *
cdw10
)

69 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

70 
u64
 
¶ba
 = 
	`gë_u«lig√d_À64
(
cdw10
);

71 
u16
 
Àngth
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 8);

72 
u16
 
c⁄åﬁ
 = 
	`gë_u«lig√d_À16
(
cdw10
 + 10);

73 
u32
 
dsmgmt
 = 
	`gë_u«lig√d_À32
(
cdw10
 + 12);

74 
u32
 
ª·ag
 = 
	`gë_u«lig√d_À32
(
cdw10
 + 16);

76 
	`åa˚_£q_¥ötf
(
p
,

78 
¶ba
, 
Àngth
, 
c⁄åﬁ
, 
dsmgmt
, 
ª·ag
);

79 
	`åa˚_£q_putc
(
p
, 0);

81  
ªt
;

82 
	}
}

84 c⁄° *
	$nvme_åa˚_dsm
(
åa˚_£q
 *
p
, 
u8
 *
cdw10
)

86 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

88 
	`åa˚_£q_¥ötf
(
p
, "nr=%u,áttributes=%u",

89 
	`gë_u«lig√d_À32
(
cdw10
),

90 
	`gë_u«lig√d_À32
(
cdw10
 + 4));

91 
	`åa˚_£q_putc
(
p
, 0);

93  
ªt
;

94 
	}
}

96 c⁄° *
	$nvme_åa˚_comm⁄
(
åa˚_£q
 *
p
, 
u8
 *
cdw10
)

98 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

100 
	`åa˚_£q_¥ötf
(
p
, "cdw10=%*ph", 24, 
cdw10
);

101 
	`åa˚_£q_putc
(
p
, 0);

103  
ªt
;

104 
	}
}

106 c⁄° *
	$nvme_åa˚_∑r£_admö_cmd
(
åa˚_£q
 *
p
,

107 
u8
 
›code
, u8 *
cdw10
)

109 
›code
) {

110 
nvme_admö_¸óã_sq
:

111  
	`nvme_åa˚_¸óã_sq
(
p
, 
cdw10
);

112 
nvme_admö_¸óã_cq
:

113  
	`nvme_åa˚_¸óã_cq
(
p
, 
cdw10
);

114 
nvme_admö_idítify
:

115  
	`nvme_åa˚_admö_idítify
(
p
, 
cdw10
);

116 
nvme_admö_gë_„©uªs
:

117  
	`nvme_åa˚_admö_gë_„©uªs
(
p
, 
cdw10
);

119  
	`nvme_åa˚_comm⁄
(
p
, 
cdw10
);

121 
	}
}

123 c⁄° *
	$nvme_åa˚_∑r£_nvm_cmd
(
åa˚_£q
 *
p
,

124 
u8
 
›code
, u8 *
cdw10
)

126 
›code
) {

127 
nvme_cmd_ªad
:

128 
nvme_cmd_wrôe
:

129 
nvme_cmd_wrôe_zî€s
:

130  
	`nvme_åa˚_ªad_wrôe
(
p
, 
cdw10
);

131 
nvme_cmd_dsm
:

132  
	`nvme_åa˚_dsm
(
p
, 
cdw10
);

134  
	`nvme_åa˚_comm⁄
(
p
, 
cdw10
);

136 
	}
}

138 c⁄° *
	$nvme_åa˚_disk_«me
(
åa˚_£q
 *
p
, *
«me
)

140 c⁄° *
ªt
 = 
	`åa˚_£q_buf„r_±r
(
p
);

142 i‡(*
«me
)

143 
	`åa˚_£q_¥ötf
(
p
, "disk=%s, ", 
«me
);

144 
	`åa˚_£q_putc
(
p
, 0);

146  
ªt
;

147 
	}
}

148 
EXPORT_SYMBOL_GPL
(
nvme_åa˚_disk_«me
);

150 
EXPORT_TRACEPOINT_SYMBOL_GPL
(
nvme_sq
);

	@trace.h

7 #unde‡
TRACE_SYSTEM


8 
	#TRACE_SYSTEM
 
nvme


	)

10 #i‡!
deföed
(
_TRACE_NVME_H
Ë|| deföed(
TRACE_HEADER_MULTI_READ
)

11 
	#_TRACE_NVME_H


	)

13 
	~<löux/nvme.h
>

14 
	~<löux/åa˚poöt.h
>

15 
	~<löux/åa˚_£q.h
>

17 
	~"nvme.h
"

19 
	#nvme_admö_›code_«me
(
›code
Ë{ opcode, #›codê}

	)

20 
	#show_admö_›code_«me
(
vÆ
) \

21 
	`__¥öt_symbﬁic
(
vÆ
, \

22 
	`nvme_admö_›code_«me
(
nvme_admö_dñëe_sq
), \

23 
	`nvme_admö_›code_«me
(
nvme_admö_¸óã_sq
), \

24 
	`nvme_admö_›code_«me
(
nvme_admö_gë_log_∑ge
), \

25 
	`nvme_admö_›code_«me
(
nvme_admö_dñëe_cq
), \

26 
	`nvme_admö_›code_«me
(
nvme_admö_¸óã_cq
), \

27 
	`nvme_admö_›code_«me
(
nvme_admö_idítify
), \

28 
	`nvme_admö_›code_«me
(
nvme_admö_ab‹t_cmd
), \

29 
	`nvme_admö_›code_«me
(
nvme_admö_£t_„©uªs
), \

30 
	`nvme_admö_›code_«me
(
nvme_admö_gë_„©uªs
), \

31 
	`nvme_admö_›code_«me
(
nvme_admö_async_evít
), \

32 
	`nvme_admö_›code_«me
(
nvme_admö_ns_mgmt
), \

33 
	`nvme_admö_›code_«me
(
nvme_admö_a˘iv©e_fw
), \

34 
	`nvme_admö_›code_«me
(
nvme_admö_dow∆ﬂd_fw
), \

35 
	`nvme_admö_›code_«me
(
nvme_admö_ns_©èch
), \

36 
	`nvme_admö_›code_«me
(
nvme_admö_kìp_Æive
), \

37 
	`nvme_admö_›code_«me
(
nvme_admö_dúe˘ive_£nd
), \

38 
	`nvme_admö_›code_«me
(
nvme_admö_dúe˘ive_ªcv
), \

39 
	`nvme_admö_›code_«me
(
nvme_admö_dbbuf
), \

40 
	`nvme_admö_›code_«me
(
nvme_admö_f‹m©_nvm
), \

41 
	`nvme_admö_›code_«me
(
nvme_admö_£curôy_£nd
), \

42 
	`nvme_admö_›code_«me
(
nvme_admö_£curôy_ªcv
), \

43 
	`nvme_admö_›code_«me
(
nvme_admö_ßnôize_nvm
))

	)

45 
	#nvme_›code_«me
(
›code
Ë{ opcode, #›codê}

	)

46 
	#show_nvm_›code_«me
(
vÆ
) \

47 
	`__¥öt_symbﬁic
(
vÆ
, \

48 
	`nvme_›code_«me
(
nvme_cmd_Êush
), \

49 
	`nvme_›code_«me
(
nvme_cmd_wrôe
), \

50 
	`nvme_›code_«me
(
nvme_cmd_ªad
), \

51 
	`nvme_›code_«me
(
nvme_cmd_wrôe_unc‹
), \

52 
	`nvme_›code_«me
(
nvme_cmd_com∑ª
), \

53 
	`nvme_›code_«me
(
nvme_cmd_wrôe_zî€s
), \

54 
	`nvme_›code_«me
(
nvme_cmd_dsm
), \

55 
	`nvme_›code_«me
(
nvme_cmd_ªsv_ªgi°î
), \

56 
	`nvme_›code_«me
(
nvme_cmd_ªsv_ªp‹t
), \

57 
	`nvme_›code_«me
(
nvme_cmd_ªsv_acquúe
), \

58 
	`nvme_›code_«me
(
nvme_cmd_ªsv_ªÀa£
))

	)

60 
	#show_›code_«me
(
qid
, 
›code
) \

61 (
qid
 ? 
	`show_nvm_›code_«me
(
›code
Ë: 
	`show_admö_›code_«me
(›code))

	)

63 c⁄° *
nvme_åa˚_∑r£_admö_cmd
(
åa˚_£q
 *
p
, 
u8
 
›code
,

64 
u8
 *
cdw10
);

65 c⁄° *
nvme_åa˚_∑r£_nvm_cmd
(
åa˚_£q
 *
p
, 
u8
 
›code
,

66 
u8
 *
cdw10
);

68 
	#∑r£_nvme_cmd
(
qid
, 
›code
, 
cdw10
) \

69 (
qid
 ? \

70 
	`nvme_åa˚_∑r£_nvm_cmd
(
p
, 
›code
, 
cdw10
) : \

71 
	`nvme_åa˚_∑r£_admö_cmd
(
p
, 
›code
, 
cdw10
))

	)

73 c⁄° *
nvme_åa˚_disk_«me
(
åa˚_£q
 *
p
, *
«me
);

74 
	#__¥öt_disk_«me
(
«me
) \

75 
	`nvme_åa˚_disk_«me
(
p
, 
«me
)

	)

77 #i‚de‡
TRACE_HEADER_MULTI_READ


78 
ölöe
 
	$__assign_disk_«me
(*
«me
, 
gídisk
 *
disk
)

80 i‡(
disk
)

81 
	`mem˝y
(
«me
, 
disk
->
disk_«me
, 
DISK_NAME_LEN
);

83 
	`mem£t
(
«me
, 0, 
DISK_NAME_LEN
);

84 
	}
}

87 
TRACE_EVENT
(
nvme_£tup_cmd
,

88 
TP_PROTO
(
ªque°
 *
ªq
, 
nvme_comm™d
 *
cmd
),

89 
TP_ARGS
(
ªq
, 
cmd
),

90 
TP_STRUCT__íåy
(

91 
	$__¨øy
(, 
disk
, 
DISK_NAME_LEN
)

92 
	$__fõld
(, 
˘æ_id
)

93 
	$__fõld
(, 
qid
)

94 
	$__fõld
(
u8
, 
›code
)

95 
	$__fõld
(
u8
, 
Êags
)

96 
	$__fõld
(
u16
, 
cid
)

97 
	$__fõld
(
u32
, 
nsid
)

98 
	$__fõld
(
u64
, 
mëad©a
)

99 
	`__¨øy
(
u8
, 
cdw10
, 24)

101 
	`TP_Á°_assign
(

102 
__íåy
->
˘æ_id
 = 
	`nvme_ªq
(
ªq
)->
˘æ
->
ö°™˚
;

103 
__íåy
->
qid
 = 
	`nvme_ªq_qid
(
ªq
);

104 
__íåy
->
›code
 = 
cmd
->
comm⁄
.opcode;

105 
__íåy
->
Êags
 = 
cmd
->
comm⁄
.flags;

106 
__íåy
->
cid
 = 
cmd
->
comm⁄
.
comm™d_id
;

107 
__íåy
->
nsid
 = 
	`À32_to_˝u
(
cmd
->
comm⁄
.nsid);

108 
__íåy
->
mëad©a
 = 
	`À64_to_˝u
(
cmd
->
comm⁄
.metadata);

109 
	`__assign_disk_«me
(
__íåy
->
disk
, 
ªq
->
rq_disk
);

110 
	`mem˝y
(
__íåy
->
cdw10
, &
cmd
->
comm⁄
.cdw10,

111 (
__íåy
->
cdw10
));

113 
	`TP_¥ötk
("nvme%d: %sqid=%d, cmdid=%u,Çsid=%u, flags=0x%x, meta=0x%llx, cmd=(%s %s)",

114 
__íåy
->
˘æ_id
, 
	`__¥öt_disk_«me
(__íåy->
disk
),

115 
__íåy
->
qid
, __íåy->
cid
, __íåy->
nsid
,

116 
__íåy
->
Êags
, __íåy->
mëad©a
,

117 
	`show_›code_«me
(
__íåy
->
qid
, __íåy->
›code
),

118 
	`∑r£_nvme_cmd
(
__íåy
->
qid
, __íåy->
›code
, __íåy->
cdw10
))

121 
	`TRACE_EVENT
(
nvme_com∂ëe_rq
,

122 
	`TP_PROTO
(
ªque°
 *
ªq
),

123 
	`TP_ARGS
(
ªq
),

124 
	`TP_STRUCT__íåy
(

125 
	$__¨øy
(, 
disk
, 
DISK_NAME_LEN
)

126 
	$__fõld
(, 
˘æ_id
)

127 
	$__fõld
(, 
qid
)

128 
	$__fõld
(, 
cid
)

129 
	$__fõld
(
u64
, 
ªsu…
)

130 
	$__fõld
(
u8
, 
ªåõs
)

131 
	$__fõld
(
u8
, 
Êags
)

132 
	`__fõld
(
u16
, 
°©us
)

134 
	`TP_Á°_assign
(

135 
__íåy
->
˘æ_id
 = 
	`nvme_ªq
(
ªq
)->
˘æ
->
ö°™˚
;

136 
__íåy
->
qid
 = 
	`nvme_ªq_qid
(
ªq
);

137 
__íåy
->
cid
 = 
ªq
->
èg
;

138 
__íåy
->
ªsu…
 = 
	`À64_to_˝u
(
	`nvme_ªq
(
ªq
)->ªsu….
u64
);

139 
__íåy
->
ªåõs
 = 
	`nvme_ªq
(
ªq
)->retries;

140 
__íåy
->
Êags
 = 
	`nvme_ªq
(
ªq
)->flags;

141 
__íåy
->
°©us
 = 
	`nvme_ªq
(
ªq
)->status;

142 
	`__assign_disk_«me
(
__íåy
->
disk
, 
ªq
->
rq_disk
);

144 
	`TP_¥ötk
("nvme%d: %sqid=%d, cmdid=%u,Ñes=%llu,Ñetries=%u, flags=0x%x, status=%u",

145 
__íåy
->
˘æ_id
, 
	`__¥öt_disk_«me
(__íåy->
disk
),

146 
__íåy
->
qid
, __íåy->
cid
, __íåy->
ªsu…
,

147 
__íåy
->
ªåõs
, __íåy->
Êags
, __íåy->
°©us
)

151 
	#´r_«me
(
´r
Ë{áî, #´∏
	}

	)
}

153 
TRACE_EVENT
(
nvme_async_evít
,

154 
TP_PROTO
(
nvme_˘æ
 *
˘æ
, 
u32
 
ªsu…
),

155 
TP_ARGS
(
˘æ
, 
ªsu…
),

156 
TP_STRUCT__íåy
(

157 
	$__fõld
(, 
˘æ_id
)

158 
	`__fõld
(
u32
, 
ªsu…
)

160 
	`TP_Á°_assign
(

161 
__íåy
->
˘æ_id
 = 
˘æ
->
ö°™˚
;

162 
__íåy
->
ªsu…
 =Ñesult;

164 
	`TP_¥ötk
("nvme%d: NVME_AEN=%#08x [%s]",

165 
__íåy
->
˘æ_id
, __íåy->
ªsu…
,

166 
	`__¥öt_symbﬁic
(
__íåy
->
ªsu…
,

167 
	`´r_«me
(
NVME_AER_NOTICE_NS_CHANGED
),

168 
	`´r_«me
(
NVME_AER_NOTICE_ANA
),

169 
	`´r_«me
(
NVME_AER_NOTICE_FW_ACT_STARTING
),

170 
	`´r_«me
(
NVME_AER_ERROR
),

171 
	`´r_«me
(
NVME_AER_SMART
),

172 
	`´r_«me
(
NVME_AER_CSS
),

173 
	`´r_«me
(
NVME_AER_VS
))

177 #unde‡
´r_«me


179 
	`TRACE_EVENT
(
nvme_sq
,

180 
	`TP_PROTO
(
ªque°
 *
ªq
, 
__À16
 
sq_hód
, 
sq_èû
),

181 
	`TP_ARGS
(
ªq
, 
sq_hód
, 
sq_èû
),

182 
	`TP_STRUCT__íåy
(

183 
	$__fõld
(, 
˘æ_id
)

184 
	$__¨øy
(, 
disk
, 
DISK_NAME_LEN
)

185 
	$__fõld
(, 
qid
)

186 
	$__fõld
(
u16
, 
sq_hód
)

187 
	`__fõld
(
u16
, 
sq_èû
)

189 
	`TP_Á°_assign
(

190 
__íåy
->
˘æ_id
 = 
	`nvme_ªq
(
ªq
)->
˘æ
->
ö°™˚
;

191 
	`__assign_disk_«me
(
__íåy
->
disk
, 
ªq
->
rq_disk
);

192 
__íåy
->
qid
 = 
	`nvme_ªq_qid
(
ªq
);

193 
__íåy
->
sq_hód
 = 
	`À16_to_˝u
(sq_head);

194 
__íåy
->
sq_èû
 = sq_tail;

196 
	`TP_¥ötk
("nvme%d: %sqid=%d, head=%u,Åail=%u",

197 
__íåy
->
˘æ_id
, 
	`__¥öt_disk_«me
(__íåy->
disk
),

198 
__íåy
->
qid
, __íåy->
sq_hód
, __íåy->
sq_èû


204 #unde‡
TRACE_INCLUDE_PATH


205 
	#TRACE_INCLUDE_PATH
 .

	)

206 #unde‡
TRACE_INCLUDE_FILE


207 
	#TRACE_INCLUDE_FILE
 
åa˚


	)

210 
	~<åa˚/deföe_åa˚.h
>

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/hdreg.h

1 #i‚de‡
_LINUX_HDREG_H


2 
	#_LINUX_HDREG_H


	)

4 
	~<löux/ty≥s.h
>

10 
	#HDIO_DRIVE_CMD_HDR_SIZE
 (4 * (
__u8
))

	)

11 
	#HDIO_DRIVE_HOB_HDR_SIZE
 (8 * (
__u8
))

	)

12 
	#HDIO_DRIVE_TASK_HDR_SIZE
 (8 * (
__u8
))

	)

14 
	#IDE_DRIVE_TASK_NO_DATA
 0

	)

15 
	#IDE_DRIVE_TASK_INVALID
 -1

	)

16 
	#IDE_DRIVE_TASK_SET_XFER
 1

	)

17 
	#IDE_DRIVE_TASK_IN
 2

	)

18 
	#IDE_DRIVE_TASK_OUT
 3

	)

19 
	#IDE_DRIVE_TASK_RAW_WRITE
 4

	)

24 
	#IDE_TASKFILE_STD_IN_FLAGS
 0xFE

	)

25 
	#IDE_HOB_STD_IN_FLAGS
 0x3C

	)

26 
	#IDE_TASKFILE_STD_OUT_FLAGS
 0xFE

	)

27 
	#IDE_HOB_STD_OUT_FLAGS
 0x3C

	)

29 
	tèsk_i‹eg_t
;

30 
	tßè_i‹eg_t
;

32 
	uide_ªg_vÆid_s
 {

33 
	mÆl
 : 16;

35 
	md©a
 : 1;

36 
	mîr‹_„©uª
 : 1;

37 
	m£˘‹
 : 1;

38 
	mn£˘‹
 : 1;

39 
	mlcyl
 : 1;

40 
	mhcyl
 : 1;

41 
	m£À˘
 : 1;

42 
	m°©us_comm™d
 : 1;

44 
	md©a_hob
 : 1;

45 
	mîr‹_„©uª_hob
 : 1;

46 
	m£˘‹_hob
 : 1;

47 
	mn£˘‹_hob
 : 1;

48 
	mlcyl_hob
 : 1;

49 
	mhcyl_hob
 : 1;

50 
	m£À˘_hob
 : 1;

51 
	mc⁄åﬁ_hob
 : 1;

52 } 
	mb
;

53 } 
	tide_ªg_vÆid_t
;

55 
	side_èsk_ªque°_s
 {

56 
__u8
 
	mio_p‹ts
[8];

57 
__u8
 
	mhob_p‹ts
[8];

58 
ide_ªg_vÆid_t
 
	mout_Êags
;

59 
ide_ªg_vÆid_t
 
	mö_Êags
;

60 
	md©a_pha£
;

61 
	mªq_cmd
;

62 
	mout_size
;

63 
	mö_size
;

64 } 
	tide_èsk_ªque°_t
;

66 
	side_io˘l_ªque°_s
 {

67 
ide_èsk_ªque°_t
 *
	mèsk_ªque°
;

68 *
	mout_buf„r
;

69 *
	mö_buf„r
;

70 } 
	tide_io˘l_ªque°_t
;

72 
	shd_drive_cmd_hdr
 {

73 
__u8
 
	mcomm™d
;

74 
__u8
 
	m£˘‹_numbî
;

75 
__u8
 
	m„©uª
;

76 
__u8
 
	m£˘‹_cou¡
;

79 
	shd_drive_èsk_hdr
 {

80 
__u8
 
	md©a
;

81 
__u8
 
	m„©uª
;

82 
__u8
 
	m£˘‹_cou¡
;

83 
__u8
 
	m£˘‹_numbî
;

84 
__u8
 
	mlow_cylödî
;

85 
__u8
 
	mhigh_cylödî
;

86 
__u8
 
	mdevi˚_hód
;

87 
__u8
 
	mcomm™d
;

88 } 
	tèsk_°ru˘_t
;

90 
	shd_drive_hob_hdr
 {

91 
__u8
 
	md©a
;

92 
__u8
 
	m„©uª
;

93 
__u8
 
	m£˘‹_cou¡
;

94 
__u8
 
	m£˘‹_numbî
;

95 
__u8
 
	mlow_cylödî
;

96 
__u8
 
	mhigh_cylödî
;

97 
__u8
 
	mdevi˚_hód
;

98 
__u8
 
	mc⁄åﬁ
;

99 } 
	thob_°ru˘_t
;

101 
	#TASKFILE_NO_DATA
 0x0000

	)

103 
	#TASKFILE_IN
 0x0001

	)

104 
	#TASKFILE_MULTI_IN
 0x0002

	)

106 
	#TASKFILE_OUT
 0x0004

	)

107 
	#TASKFILE_MULTI_OUT
 0x0008

	)

108 
	#TASKFILE_IN_OUT
 0x0010

	)

110 
	#TASKFILE_IN_DMA
 0x0020

	)

111 
	#TASKFILE_OUT_DMA
 0x0040

	)

112 
	#TASKFILE_IN_DMAQ
 0x0080

	)

113 
	#TASKFILE_OUT_DMAQ
 0x0100

	)

115 
	#TASKFILE_P_IN
 0x0200

	)

116 
	#TASKFILE_P_OUT
 0x0400

	)

117 
	#TASKFILE_P_IN_DMA
 0x0800

	)

118 
	#TASKFILE_P_OUT_DMA
 0x1000

	)

119 
	#TASKFILE_P_IN_DMAQ
 0x2000

	)

120 
	#TASKFILE_P_OUT_DMAQ
 0x4000

	)

121 
	#TASKFILE_48
 0x8000

	)

122 
	#TASKFILE_INVALID
 0x7fff

	)

125 
	#WIN_NOP
 0x00

	)

129 
	#CFA_REQ_EXT_ERROR_CODE
 0x03

	)

133 
	#WIN_SRST
 0x08

	)

134 
	#WIN_DEVICE_RESET
 0x08

	)

138 
	#WIN_RECAL
 0x10

	)

139 
	#WIN_RESTORE
 
WIN_RECAL


	)

143 
	#WIN_READ
 0x20

	)

144 
	#WIN_READ_ONCE
 0x21

	)

145 
	#WIN_READ_LONG
 0x22

	)

146 
	#WIN_READ_LONG_ONCE
 0x23

	)

147 
	#WIN_READ_EXT
 0x24

	)

148 
	#WIN_READDMA_EXT
 0x25

	)

149 
	#WIN_READDMA_QUEUED_EXT
 0x26

	)

150 
	#WIN_READ_NATIVE_MAX_EXT
 0x27

	)

154 
	#WIN_MULTREAD_EXT
 0x29

	)

158 
	#WIN_WRITE
 0x30

	)

159 
	#WIN_WRITE_ONCE
 0x31

	)

160 
	#WIN_WRITE_LONG
 0x32

	)

161 
	#WIN_WRITE_LONG_ONCE
 0x33

	)

162 
	#WIN_WRITE_EXT
 0x34

	)

163 
	#WIN_WRITEDMA_EXT
 0x35

	)

164 
	#WIN_WRITEDMA_QUEUED_EXT
 0x36

	)

165 
	#WIN_SET_MAX_EXT
 0x37

	)

166 
	#CFA_WRITE_SECT_WO_ERASE
 0x38

	)

167 
	#WIN_MULTWRITE_EXT
 0x39

	)

171 
	#WIN_WRITE_VERIFY
 0x3C

	)

175 
	#WIN_VERIFY
 0x40

	)

176 
	#WIN_VERIFY_ONCE
 0x41

	)

177 
	#WIN_VERIFY_EXT
 0x42

	)

181 
	#WIN_FORMAT
 0x50

	)

185 
	#WIN_INIT
 0x60

	)

189 
	#WIN_SEEK
 0x70

	)

191 
	#CFA_TRANSLATE_SECTOR
 0x87

	)

192 
	#WIN_DIAGNOSE
 0x90

	)

193 
	#WIN_SPECIFY
 0x91

	)

194 
	#WIN_DOWNLOAD_MICROCODE
 0x92

	)

195 
	#WIN_STANDBYNOW2
 0x94

	)

196 
	#WIN_STANDBY2
 0x96

	)

197 
	#WIN_SETIDLE2
 0x97

	)

198 
	#WIN_CHECKPOWERMODE2
 0x98

	)

199 
	#WIN_SLEEPNOW2
 0x99

	)

203 
	#WIN_PACKETCMD
 0xA0

	)

204 
	#WIN_PIDENTIFY
 0xA1

	)

205 
	#WIN_QUEUED_SERVICE
 0xA2

	)

206 
	#WIN_SMART
 0xB0

	)

207 
	#CFA_ERASE_SECTORS
 0xC0

	)

208 
	#WIN_MULTREAD
 0xC4

	)

209 
	#WIN_MULTWRITE
 0xC5

	)

210 
	#WIN_SETMULT
 0xC6

	)

211 
	#WIN_READDMA_QUEUED
 0xC7

	)

212 
	#WIN_READDMA
 0xC8

	)

213 
	#WIN_READDMA_ONCE
 0xC9

	)

214 
	#WIN_WRITEDMA
 0xCA

	)

215 
	#WIN_WRITEDMA_ONCE
 0xCB

	)

216 
	#WIN_WRITEDMA_QUEUED
 0xCC

	)

217 
	#CFA_WRITE_MULTI_WO_ERASE
 0xCD

	)

218 
	#WIN_GETMEDIASTATUS
 0xDA

	)

219 
	#WIN_ACKMEDIACHANGE
 0xDB

	)

220 
	#WIN_POSTBOOT
 0xDC

	)

221 
	#WIN_PREBOOT
 0xDD

	)

222 
	#WIN_DOORLOCK
 0xDE

	)

223 
	#WIN_DOORUNLOCK
 0xDF

	)

224 
	#WIN_STANDBYNOW1
 0xE0

	)

225 
	#WIN_IDLEIMMEDIATE
 0xE1

	)

226 
	#WIN_STANDBY
 0xE2

	)

227 
	#WIN_SETIDLE1
 0xE3

	)

228 
	#WIN_READ_BUFFER
 0xE4

	)

229 
	#WIN_CHECKPOWERMODE1
 0xE5

	)

230 
	#WIN_SLEEPNOW1
 0xE6

	)

231 
	#WIN_FLUSH_CACHE
 0xE7

	)

232 
	#WIN_WRITE_BUFFER
 0xE8

	)

233 
	#WIN_WRITE_SAME
 0xE9

	)

235 
	#WIN_FLUSH_CACHE_EXT
 0xEA

	)

236 
	#WIN_IDENTIFY
 0xEC

	)

237 
	#WIN_MEDIAEJECT
 0xED

	)

238 
	#WIN_IDENTIFY_DMA
 0xEE

	)

239 
	#WIN_SETFEATURES
 0xEF

	)

240 
	#EXABYTE_ENABLE_NEST
 0xF0

	)

241 
	#WIN_SECURITY_SET_PASS
 0xF1

	)

242 
	#WIN_SECURITY_UNLOCK
 0xF2

	)

243 
	#WIN_SECURITY_ERASE_PREPARE
 0xF3

	)

244 
	#WIN_SECURITY_ERASE_UNIT
 0xF4

	)

245 
	#WIN_SECURITY_FREEZE_LOCK
 0xF5

	)

246 
	#WIN_SECURITY_DISABLE
 0xF6

	)

247 
	#WIN_READ_NATIVE_MAX
 0xF8

	)

248 
	#WIN_SET_MAX
 0xF9

	)

249 
	#DISABLE_SEAGATE
 0xFB

	)

253 
	#SMART_READ_VALUES
 0xD0

	)

254 
	#SMART_READ_THRESHOLDS
 0xD1

	)

255 
	#SMART_AUTOSAVE
 0xD2

	)

256 
	#SMART_SAVE
 0xD3

	)

257 
	#SMART_IMMEDIATE_OFFLINE
 0xD4

	)

258 
	#SMART_READ_LOG_SECTOR
 0xD5

	)

259 
	#SMART_WRITE_LOG_SECTOR
 0xD6

	)

260 
	#SMART_WRITE_THRESHOLDS
 0xD7

	)

261 
	#SMART_ENABLE
 0xD8

	)

262 
	#SMART_DISABLE
 0xD9

	)

263 
	#SMART_STATUS
 0xDA

	)

264 
	#SMART_AUTO_OFFLINE
 0xDB

	)

268 
	#SMART_LCYL_PASS
 0x4F

	)

269 
	#SMART_HCYL_PASS
 0xC2

	)

272 
	#SETFEATURES_EN_8BIT
 0x01

	)

273 
	#SETFEATURES_EN_WCACHE
 0x02

	)

274 
	#SETFEATURES_DIS_DEFECT
 0x04

	)

275 
	#SETFEATURES_EN_APM
 0x05

	)

276 
	#SETFEATURES_EN_SAME_R
 0x22

	)

277 
	#SETFEATURES_DIS_MSN
 0x31

	)

278 
	#SETFEATURES_DIS_RETRY
 0x33

	)

279 
	#SETFEATURES_EN_AAM
 0x42

	)

280 
	#SETFEATURES_RW_LONG
 0x44

	)

281 
	#SETFEATURES_SET_CACHE
 0x54

	)

282 
	#SETFEATURES_DIS_RLA
 0x55

	)

283 
	#SETFEATURES_EN_RI
 0x5D

	)

284 
	#SETFEATURES_EN_SI
 0x5E

	)

285 
	#SETFEATURES_DIS_RPOD
 0x66

	)

286 
	#SETFEATURES_DIS_ECC
 0x77

	)

287 
	#SETFEATURES_DIS_8BIT
 0x81

	)

288 
	#SETFEATURES_DIS_WCACHE
 0x82

	)

289 
	#SETFEATURES_EN_DEFECT
 0x84

	)

290 
	#SETFEATURES_DIS_APM
 0x85

	)

291 
	#SETFEATURES_EN_ECC
 0x88

	)

292 
	#SETFEATURES_EN_MSN
 0x95

	)

293 
	#SETFEATURES_EN_RETRY
 0x99

	)

294 
	#SETFEATURES_EN_RLA
 0xAA

	)

295 
	#SETFEATURES_PREFETCH
 0xAB

	)

296 
	#SETFEATURES_EN_REST
 0xAC

	)

297 
	#SETFEATURES_4B_RW_LONG
 0xBB

	)

298 
	#SETFEATURES_DIS_AAM
 0xC2

	)

299 
	#SETFEATURES_EN_RPOD
 0xCC

	)

300 
	#SETFEATURES_DIS_RI
 0xDD

	)

301 
	#SETFEATURES_EN_SAME_M
 0xDD

	)

302 
	#SETFEATURES_DIS_SI
 0xDE

	)

306 
	#SECURITY_SET_PASSWORD
 0xBA

	)

307 
	#SECURITY_UNLOCK
 0xBB

	)

308 
	#SECURITY_ERASE_PREPARE
 0xBC

	)

309 
	#SECURITY_ERASE_UNIT
 0xBD

	)

310 
	#SECURITY_FREEZE_LOCK
 0xBE

	)

311 
	#SECURITY_DISABLE_PASSWORD
 0xBF

	)

313 
	shd_geomëry
 {

314 
	mhóds
;

315 
	m£˘‹s
;

316 
	mcylödîs
;

317 
	m°¨t
;

321 
	#HDIO_GETGEO
 0x0301

	)

322 
	#HDIO_GET_UNMASKINTR
 0x0302

	)

323 
	#HDIO_GET_MULTCOUNT
 0x0304

	)

324 
	#HDIO_GET_QDMA
 0x0305

	)

326 
	#HDIO_SET_XFER
 0x0306

	)

328 
	#HDIO_OBSOLETE_IDENTITY
 0x0307

	)

329 
	#HDIO_GET_KEEPSETTINGS
 0x0308

	)

330 
	#HDIO_GET_32BIT
 0x0309

	)

331 
	#HDIO_GET_NOWERR
 0x030®

	)

332 
	#HDIO_GET_DMA
 0x030b

	)

333 
	#HDIO_GET_NICE
 0x030¯

	)

334 
	#HDIO_GET_IDENTITY
 0x030d

	)

335 
	#HDIO_GET_WCACHE
 0x030ê

	)

336 
	#HDIO_GET_ACOUSTIC
 0x030‡

	)

337 
	#HDIO_GET_ADDRESS
 0x0310

	)

339 
	#HDIO_GET_BUSSTATE
 0x031®

	)

340 
	#HDIO_TRISTATE_HWIF
 0x031b

	)

341 
	#HDIO_DRIVE_RESET
 0x031¯

	)

342 
	#HDIO_DRIVE_TASKFILE
 0x031d

	)

343 
	#HDIO_DRIVE_TASK
 0x031ê

	)

344 
	#HDIO_DRIVE_CMD
 0x031‡

	)

345 
	#HDIO_DRIVE_CMD_AEB
 
HDIO_DRIVE_TASK


	)

348 
	#HDIO_SET_MULTCOUNT
 0x0321

	)

349 
	#HDIO_SET_UNMASKINTR
 0x0322

	)

350 
	#HDIO_SET_KEEPSETTINGS
 0x0323

	)

351 
	#HDIO_SET_32BIT
 0x0324

	)

352 
	#HDIO_SET_NOWERR
 0x0325

	)

353 
	#HDIO_SET_DMA
 0x0326

	)

354 
	#HDIO_SET_PIO_MODE
 0x0327

	)

355 
	#HDIO_SCAN_HWIF
 0x0328

	)

356 
	#HDIO_UNREGISTER_HWIF
 0x032®

	)

357 
	#HDIO_SET_NICE
 0x0329

	)

358 
	#HDIO_SET_WCACHE
 0x032b

	)

359 
	#HDIO_SET_ACOUSTIC
 0x032¯

	)

360 
	#HDIO_SET_BUSSTATE
 0x032d

	)

361 
	#HDIO_SET_QDMA
 0x032ê

	)

362 
	#HDIO_SET_ADDRESS
 0x032‡

	)

366 
	mBUSSTATE_OFF
 = 0,

367 
	mBUSSTATE_ON
,

368 
	mBUSSTATE_TRISTATE


377 
	#__NEW_HD_DRIVE_ID


	)

385 
	shd_driveid
 {

386 
	mc⁄fig
;

387 
	mcyls
;

388 
	mª£rved2
;

389 
	mhóds
;

390 
	måack_byãs
;

391 
	m£˘‹_byãs
;

392 
	m£˘‹s
;

393 
	mvíd‹0
;

394 
	mvíd‹1
;

395 
	mvíd‹2
;

396 
	m£rül_no
[20];

397 
	mbuf_ty≥
;

398 
	mbuf_size
;

401 
	mecc_byãs
;

402 
	mfw_ªv
[8];

403 
	mmodñ
[40];

404 
	mmax_mu…£˘
;

405 
	mvíd‹3
;

406 
	mdw‹d_io
;

407 
	mvíd‹4
;

408 
	mˇ∑bûôy
;

414 
	mª£rved50
;

415 
	mvíd‹5
;

416 
	mtPIO
;

417 
	mvíd‹6
;

418 
	mtDMA
;

419 
	mfõld_vÆid
;

424 
	mcur_cyls
;

425 
	mcur_hóds
;

426 
	mcur_£˘‹s
;

427 
	mcur_ˇ∑côy0
;

428 
	mcur_ˇ∑côy1
;

429 
	mmu…£˘
;

430 
	mmu…£˘_vÆid
;

431 
	mlba_ˇ∑côy
;

432 
	mdma_1w‹d
;

433 
	mdma_mw‹d
;

434 
	meide_pio_modes
;

435 
	meide_dma_mö
;

436 
	meide_dma_time
;

437 
	meide_pio
;

438 
	meide_pio_i‹dy
;

439 
	mw‹ds69_70
[2];

442 
	mw‹ds71_74
[4];

445 
	mqueue_dïth
;

449 
	mw‹ds76_79
[4];

450 
	mmaj‹_ªv_num
;

451 
	mmö‹_ªv_num
;

452 
	mcomm™d_£t_1
;

470 
	mcomm™d_£t_2
;

488 
	mcfs£
;

500 
	mcfs_íabÀ_1
;

519 
	mcfs_íabÀ_2
;

538 
	mcsf_deÁu…
;

550 
	mdma_u…ø
;

551 
	må£uc
;

552 
	måsEuc
;

553 
	mCurAPMvÆues
;

554 
	mm¥c
;

555 
	mhw_c⁄fig
;

573 
	macou°ic
;

577 
	mm§qs
;

578 
	msx„π
;

579 
	mßl
;

580 
	m•g
;

581 
	mlba_ˇ∑côy_2
;

582 
	mw‹ds104_125
[22];

583 
	mœ°_lun
;

584 
	mw‹d127
;

592 
	mdlf
;

604 
	mcsfo
;

612 
	mw‹ds130_155
[26];

613 
	mw‹d156
;

614 
	mw‹ds157_159
[3];

615 
	mcÁ_powî
;

622 
	mw‹ds161_175
[15];

623 
	mw‹ds176_205
[30];

624 
	mw‹ds206_254
[49];

625 
	möãgrôy_w‹d
;

636 
	#IDE_NICE_DSC_OVERLAP
 (0Ë

	)

637 
	#IDE_NICE_ATAPI_OVERLAP
 (1Ë

	)

638 
	#IDE_NICE_1
 (3Ë

	)

639 
	#IDE_NICE_0
 (2Ë

	)

640 
	#IDE_NICE_2
 (4Ë

	)

	@/usr/include/linux/in.h

18 #i‚de‡
_LINUX_IN_H


19 
	#_LINUX_IN_H


	)

21 
	~<löux/ty≥s.h
>

22 
	~<löux/libc-com∑t.h
>

23 
	~<löux/sockë.h
>

25 #i‡
__UAPI_DEF_IN_IPPROTO


28 
	mIPPROTO_IP
 = 0,

29 
	#IPPROTO_IP
 
IPPROTO_IP


	)

30 
	mIPPROTO_ICMP
 = 1,

31 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

32 
	mIPPROTO_IGMP
 = 2,

33 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

34 
	mIPPROTO_IPIP
 = 4,

35 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

36 
	mIPPROTO_TCP
 = 6,

37 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

38 
	mIPPROTO_EGP
 = 8,

39 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

40 
	mIPPROTO_PUP
 = 12,

41 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

42 
	mIPPROTO_UDP
 = 17,

43 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

44 
	mIPPROTO_IDP
 = 22,

45 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

46 
	mIPPROTO_TP
 = 29,

47 
	#IPPROTO_TP
 
IPPROTO_TP


	)

48 
	mIPPROTO_DCCP
 = 33,

49 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

50 
	mIPPROTO_IPV6
 = 41,

51 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

52 
	mIPPROTO_RSVP
 = 46,

53 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

54 
	mIPPROTO_GRE
 = 47,

55 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

56 
	mIPPROTO_ESP
 = 50,

57 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

58 
	mIPPROTO_AH
 = 51,

59 
	#IPPROTO_AH
 
IPPROTO_AH


	)

60 
	mIPPROTO_MTP
 = 92,

61 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

62 
	mIPPROTO_BEETPH
 = 94,

63 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

64 
	mIPPROTO_ENCAP
 = 98,

65 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

66 
	mIPPROTO_PIM
 = 103,

67 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

68 
	mIPPROTO_COMP
 = 108,

69 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

70 
	mIPPROTO_SCTP
 = 132,

71 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

72 
	mIPPROTO_UDPLITE
 = 136,

73 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

74 
	mIPPROTO_MPLS
 = 137,

75 
	#IPPROTO_MPLS
 
IPPROTO_MPLS


	)

76 
	mIPPROTO_RAW
 = 255,

77 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

78 
	mIPPROTO_MAX


82 #i‡
__UAPI_DEF_IN_ADDR


84 
	sö_addr
 {

85 
__be32
 
	ms_addr
;

89 
	#IP_TOS
 1

	)

90 
	#IP_TTL
 2

	)

91 
	#IP_HDRINCL
 3

	)

92 
	#IP_OPTIONS
 4

	)

93 
	#IP_ROUTER_ALERT
 5

	)

94 
	#IP_RECVOPTS
 6

	)

95 
	#IP_RETOPTS
 7

	)

96 
	#IP_PKTINFO
 8

	)

97 
	#IP_PKTOPTIONS
 9

	)

98 
	#IP_MTU_DISCOVER
 10

	)

99 
	#IP_RECVERR
 11

	)

100 
	#IP_RECVTTL
 12

	)

101 
	#IP_RECVTOS
 13

	)

102 
	#IP_MTU
 14

	)

103 
	#IP_FREEBIND
 15

	)

104 
	#IP_IPSEC_POLICY
 16

	)

105 
	#IP_XFRM_POLICY
 17

	)

106 
	#IP_PASSSEC
 18

	)

107 
	#IP_TRANSPARENT
 19

	)

110 
	#IP_RECVRETOPTS
 
IP_RETOPTS


	)

113 
	#IP_ORIGDSTADDR
 20

	)

114 
	#IP_RECVORIGDSTADDR
 
IP_ORIGDSTADDR


	)

116 
	#IP_MINTTL
 21

	)

117 
	#IP_NODEFRAG
 22

	)

118 
	#IP_CHECKSUM
 23

	)

119 
	#IP_BIND_ADDRESS_NO_PORT
 24

	)

122 
	#IP_PMTUDISC_DONT
 0

	)

123 
	#IP_PMTUDISC_WANT
 1

	)

124 
	#IP_PMTUDISC_DO
 2

	)

125 
	#IP_PMTUDISC_PROBE
 3

	)

130 
	#IP_PMTUDISC_INTERFACE
 4

	)

134 
	#IP_PMTUDISC_OMIT
 5

	)

136 
	#IP_MULTICAST_IF
 32

	)

137 
	#IP_MULTICAST_TTL
 33

	)

138 
	#IP_MULTICAST_LOOP
 34

	)

139 
	#IP_ADD_MEMBERSHIP
 35

	)

140 
	#IP_DROP_MEMBERSHIP
 36

	)

141 
	#IP_UNBLOCK_SOURCE
 37

	)

142 
	#IP_BLOCK_SOURCE
 38

	)

143 
	#IP_ADD_SOURCE_MEMBERSHIP
 39

	)

144 
	#IP_DROP_SOURCE_MEMBERSHIP
 40

	)

145 
	#IP_MSFILTER
 41

	)

146 
	#MCAST_JOIN_GROUP
 42

	)

147 
	#MCAST_BLOCK_SOURCE
 43

	)

148 
	#MCAST_UNBLOCK_SOURCE
 44

	)

149 
	#MCAST_LEAVE_GROUP
 45

	)

150 
	#MCAST_JOIN_SOURCE_GROUP
 46

	)

151 
	#MCAST_LEAVE_SOURCE_GROUP
 47

	)

152 
	#MCAST_MSFILTER
 48

	)

153 
	#IP_MULTICAST_ALL
 49

	)

154 
	#IP_UNICAST_IF
 50

	)

156 
	#MCAST_EXCLUDE
 0

	)

157 
	#MCAST_INCLUDE
 1

	)

160 
	#IP_DEFAULT_MULTICAST_TTL
 1

	)

161 
	#IP_DEFAULT_MULTICAST_LOOP
 1

	)

165 #i‡
__UAPI_DEF_IP_MREQ


166 
	sù_mªq
 {

167 
ö_addr
 
	mimr_mu…üddr
;

168 
ö_addr
 
	mimr_öãrÁ˚
;

171 
	sù_mªqn
 {

172 
ö_addr
 
	mimr_mu…üddr
;

173 
ö_addr
 
	mimr_addªss
;

174 
	mimr_ifödex
;

177 
	sù_mªq_sour˚
 {

178 
__be32
 
	mimr_mu…üddr
;

179 
__be32
 
	mimr_öãrÁ˚
;

180 
__be32
 
	mimr_sour˚addr
;

183 
	sù_msfûãr
 {

184 
__be32
 
	mimsf_mu…üddr
;

185 
__be32
 
	mimsf_öãrÁ˚
;

186 
__u32
 
	mimsf_fmode
;

187 
__u32
 
	mimsf_num§c
;

188 
__be32
 
	mimsf_¶i°
[1];

191 
	#IP_MSFILTER_SIZE
(
num§c
) \

192 ((
ù_msfûãr
Ë- (
__u32
) \

193 + (
num§c
Ë* (
__u32
))

	)

195 
	sgroup_ªq
 {

196 
__u32
 
	mgr_öãrÁ˚
;

197 
__kî√l_sockaddr_°‹age
 
	mgr_group
;

200 
	sgroup_sour˚_ªq
 {

201 
__u32
 
	mg§_öãrÁ˚
;

202 
__kî√l_sockaddr_°‹age
 
	mg§_group
;

203 
__kî√l_sockaddr_°‹age
 
	mg§_sour˚
;

206 
	sgroup_fûãr
 {

207 
__u32
 
	mgf_öãrÁ˚
;

208 
__kî√l_sockaddr_°‹age
 
	mgf_group
;

209 
__u32
 
	mgf_fmode
;

210 
__u32
 
	mgf_num§c
;

211 
__kî√l_sockaddr_°‹age
 
	mgf_¶i°
[1];

214 
	#GROUP_FILTER_SIZE
(
num§c
) \

215 ((
group_fûãr
Ë- (
__kî√l_sockaddr_°‹age
) \

216 + (
num§c
Ë* (
__kî√l_sockaddr_°‹age
))

	)

219 #i‡
__UAPI_DEF_IN_PKTINFO


220 
	sö_pktöfo
 {

221 
	mùi_ifödex
;

222 
ö_addr
 
	mùi_•ec_d°
;

223 
ö_addr
 
	mùi_addr
;

228 #i‡ 
__UAPI_DEF_SOCKADDR_IN


229 
	#__SOCK_SIZE__
 16

	)

230 
	ssockaddr_ö
 {

231 
__kî√l_ß_Ámûy_t
 
	msö_Ámûy
;

232 
__be16
 
	msö_p‹t
;

233 
ö_addr
 
	msö_addr
;

236 
	m__∑d
[
__SOCK_SIZE__
 - () -

237 (Ë- (
ö_addr
)];

239 
	#sö_zîo
 
__∑d


	)

242 #i‡
__UAPI_DEF_IN_CLASS


248 
	#IN_CLASSA
(
a
Ë((((Ë◊)Ë& 0x80000000Ë=0)

	)

249 
	#IN_CLASSA_NET
 0xff000000

	)

250 
	#IN_CLASSA_NSHIFT
 24

	)

251 
	#IN_CLASSA_HOST
 (0xfffffff‡& ~
IN_CLASSA_NET
)

	)

252 
	#IN_CLASSA_MAX
 128

	)

254 
	#IN_CLASSB
(
a
Ë((((Ë◊)Ë& 0xc0000000Ë=0x80000000)

	)

255 
	#IN_CLASSB_NET
 0xffff0000

	)

256 
	#IN_CLASSB_NSHIFT
 16

	)

257 
	#IN_CLASSB_HOST
 (0xfffffff‡& ~
IN_CLASSB_NET
)

	)

258 
	#IN_CLASSB_MAX
 65536

	)

260 
	#IN_CLASSC
(
a
Ë((((Ë◊)Ë& 0xe0000000Ë=0xc0000000)

	)

261 
	#IN_CLASSC_NET
 0xffffff00

	)

262 
	#IN_CLASSC_NSHIFT
 8

	)

263 
	#IN_CLASSC_HOST
 (0xfffffff‡& ~
IN_CLASSC_NET
)

	)

265 
	#IN_CLASSD
(
a
Ë((((Ë◊)Ë& 0xf0000000Ë=0xe0000000)

	)

266 
	#IN_MULTICAST
(
a
Ë
	`IN_CLASSD
◊)

	)

267 
	#IN_MULTICAST_NET
 0xF0000000

	)

269 
	#IN_EXPERIMENTAL
(
a
Ë((((Ë◊)Ë& 0xf0000000Ë=0xf0000000)

	)

270 
	#IN_BADCLASS
(
a
Ë
	`IN_EXPERIMENTAL
(◊))

	)

273 
	#INADDR_ANY
 ((Ë0x00000000)

	)

276 
	#INADDR_BROADCAST
 ((Ë0xffffffff)

	)

279 
	#INADDR_NONE
 ((Ë0xffffffff)

	)

282 
	#IN_LOOPBACKNET
 127

	)

285 
	#INADDR_LOOPBACK
 0x7f000001

	)

286 
	#IN_LOOPBACK
(
a
Ë((((Ë◊)Ë& 0xff000000Ë=0x7f000000)

	)

289 
	#INADDR_UNSPEC_GROUP
 0xe0000000U

	)

290 
	#INADDR_ALLHOSTS_GROUP
 0xe0000001U

	)

291 
	#INADDR_ALLRTRS_GROUP
 0xe0000002U

	)

292 
	#INADDR_MAX_LOCAL_GROUP
 0xe00000ffU

	)

296 
	~<asm/byã‹dî.h
>

	@/usr/include/linux/kernel.h

1 #i‚de‡
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<löux/sysöfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

	@/usr/include/linux/nvme_ioctl.h

15 #i‚de‡
_LINUX_NVME_IOCTL_H


16 
	#_LINUX_NVME_IOCTL_H


	)

18 
	~<löux/ty≥s.h
>

20 
	snvme_u£r_io
 {

21 
__u8
 
	m›code
;

22 
__u8
 
	mÊags
;

23 
__u16
 
	mc⁄åﬁ
;

24 
__u16
 
	mnblocks
;

25 
__u16
 
	mrsvd
;

26 
__u64
 
	mmëad©a
;

27 
__u64
 
	maddr
;

28 
__u64
 
	m¶ba
;

29 
__u32
 
	mdsmgmt
;

30 
__u32
 
	mª·ag
;

31 
__u16
 
	m≠±ag
;

32 
__u16
 
	m≠pmask
;

35 
	snvme_∑s°hru_cmd
 {

36 
__u8
 
	m›code
;

37 
__u8
 
	mÊags
;

38 
__u16
 
	mrsvd1
;

39 
__u32
 
	mnsid
;

40 
__u32
 
	mcdw2
;

41 
__u32
 
	mcdw3
;

42 
__u64
 
	mmëad©a
;

43 
__u64
 
	maddr
;

44 
__u32
 
	mmëad©a_Àn
;

45 
__u32
 
	md©a_Àn
;

46 
__u32
 
	mcdw10
;

47 
__u32
 
	mcdw11
;

48 
__u32
 
	mcdw12
;

49 
__u32
 
	mcdw13
;

50 
__u32
 
	mcdw14
;

51 
__u32
 
	mcdw15
;

52 
__u32
 
	mtimeout_ms
;

53 
__u32
 
	mªsu…
;

56 
	#nvme_admö_cmd
 
nvme_∑s°hru_cmd


	)

58 
	#NVME_IOCTL_ID
 
	`_IO
('N', 0x40)

	)

59 
	#NVME_IOCTL_ADMIN_CMD
 
	`_IOWR
('N', 0x41, 
nvme_admö_cmd
)

	)

60 
	#NVME_IOCTL_SUBMIT_IO
 
	`_IOW
('N', 0x42, 
nvme_u£r_io
)

	)

61 
	#NVME_IOCTL_IO_CMD
 
	`_IOWR
('N', 0x43, 
nvme_∑s°hru_cmd
)

	)

62 
	#NVME_IOCTL_RESET
 
	`_IO
('N', 0x44)

	)

63 
	#NVME_IOCTL_SUBSYS_RESET
 
	`_IO
('N', 0x45)

	)

	@/usr/include/linux/pci.h

17 #i‚de‡
LINUX_PCI_H


18 
	#LINUX_PCI_H


	)

20 
	~<löux/pci_ªgs.h
>

30 
	#PCI_DEVFN
(
¶Ÿ
, 
func
Ë((((¶ŸË& 0x1fË<< 3Ë| ((funcË& 0x07))

	)

31 
	#PCI_SLOT
(
dev‚
Ë(((dev‚Ë>> 3Ë& 0x1f)

	)

32 
	#PCI_FUNC
(
dev‚
Ë((dev‚Ë& 0x07)

	)

35 
	#PCIIOC_BASE
 ('P' << 24 | 'C' << 16 | 'I' << 8)

	)

36 
	#PCIIOC_CONTROLLER
 (
PCIIOC_BASE
 | 0x00Ë

	)

37 
	#PCIIOC_MMAP_IS_IO
 (
PCIIOC_BASE
 | 0x01Ë

	)

38 
	#PCIIOC_MMAP_IS_MEM
 (
PCIIOC_BASE
 | 0x02Ë

	)

39 
	#PCIIOC_WRITE_COMBINE
 (
PCIIOC_BASE
 | 0x03Ë

	)

	@/usr/include/linux/ptrace.h

1 #i‚de‡
_LINUX_PTRACE_H


2 
	#_LINUX_PTRACE_H


	)

8 
	~<löux/ty≥s.h
>

10 
	#PTRACE_TRACEME
 0

	)

11 
	#PTRACE_PEEKTEXT
 1

	)

12 
	#PTRACE_PEEKDATA
 2

	)

13 
	#PTRACE_PEEKUSR
 3

	)

14 
	#PTRACE_POKETEXT
 4

	)

15 
	#PTRACE_POKEDATA
 5

	)

16 
	#PTRACE_POKEUSR
 6

	)

17 
	#PTRACE_CONT
 7

	)

18 
	#PTRACE_KILL
 8

	)

19 
	#PTRACE_SINGLESTEP
 9

	)

21 
	#PTRACE_ATTACH
 16

	)

22 
	#PTRACE_DETACH
 17

	)

24 
	#PTRACE_SYSCALL
 24

	)

27 
	#PTRACE_SETOPTIONS
 0x4200

	)

28 
	#PTRACE_GETEVENTMSG
 0x4201

	)

29 
	#PTRACE_GETSIGINFO
 0x4202

	)

30 
	#PTRACE_SETSIGINFO
 0x4203

	)

49 
	#PTRACE_GETREGSET
 0x4204

	)

50 
	#PTRACE_SETREGSET
 0x4205

	)

52 
	#PTRACE_SEIZE
 0x4206

	)

53 
	#PTRACE_INTERRUPT
 0x4207

	)

54 
	#PTRACE_LISTEN
 0x4208

	)

56 
	#PTRACE_PEEKSIGINFO
 0x4209

	)

58 
	s±ø˚_≥eksigöfo_¨gs
 {

59 
__u64
 
	moff
;

60 
__u32
 
	mÊags
;

61 
__s32
 
	mƒ
;

64 
	#PTRACE_GETSIGMASK
 0x420a

	)

65 
	#PTRACE_SETSIGMASK
 0x420b

	)

67 
	#PTRACE_SECCOMP_GET_FILTER
 0x420c

	)

70 
	#PTRACE_PEEKSIGINFO_SHARED
 (1 << 0)

	)

73 
	#PTRACE_EVENT_FORK
 1

	)

74 
	#PTRACE_EVENT_VFORK
 2

	)

75 
	#PTRACE_EVENT_CLONE
 3

	)

76 
	#PTRACE_EVENT_EXEC
 4

	)

77 
	#PTRACE_EVENT_VFORK_DONE
 5

	)

78 
	#PTRACE_EVENT_EXIT
 6

	)

79 
	#PTRACE_EVENT_SECCOMP
 7

	)

81 
	#PTRACE_EVENT_STOP
 128

	)

84 
	#PTRACE_O_TRACESYSGOOD
 1

	)

85 
	#PTRACE_O_TRACEFORK
 (1 << 
PTRACE_EVENT_FORK
)

	)

86 
	#PTRACE_O_TRACEVFORK
 (1 << 
PTRACE_EVENT_VFORK
)

	)

87 
	#PTRACE_O_TRACECLONE
 (1 << 
PTRACE_EVENT_CLONE
)

	)

88 
	#PTRACE_O_TRACEEXEC
 (1 << 
PTRACE_EVENT_EXEC
)

	)

89 
	#PTRACE_O_TRACEVFORKDONE
 (1 << 
PTRACE_EVENT_VFORK_DONE
)

	)

90 
	#PTRACE_O_TRACEEXIT
 (1 << 
PTRACE_EVENT_EXIT
)

	)

91 
	#PTRACE_O_TRACESECCOMP
 (1 << 
PTRACE_EVENT_SECCOMP
)

	)

94 
	#PTRACE_O_EXITKILL
 (1 << 20)

	)

95 
	#PTRACE_O_SUSPEND_SECCOMP
 (1 << 21)

	)

97 
	#PTRACE_O_MASK
 (\

98 0x000000f‡| 
PTRACE_O_EXITKILL
 | 
PTRACE_O_SUSPEND_SECCOMP
)

	)

100 
	~<asm/±ø˚.h
>

	@/usr/include/linux/string.h

1 #i‚de‡
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<°rög.h
>

	@/usr/include/linux/types.h

1 #i‚de‡
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty≥s.h
>

6 #i‚de‡
__ASSEMBLY__


8 
	~<löux/posix_ty≥s.h
>

16 #ifde‡
__CHECKER__


17 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

19 
	#__bôwi£__


	)

21 #ifde‡
__CHECK_ENDIAN__


22 
	#__bôwi£
 
__bôwi£__


	)

24 
	#__bôwi£


	)

27 
__u16
 
	t__bôwi£
 
	t__À16
;

28 
__u16
 
	t__bôwi£
 
	t__be16
;

29 
__u32
 
	t__bôwi£
 
	t__À32
;

30 
__u32
 
	t__bôwi£
 
	t__be32
;

31 
__u64
 
	t__bôwi£
 
	t__À64
;

32 
__u64
 
	t__bôwi£
 
	t__be64
;

34 
__u16
 
	t__bôwi£
 
	t__sum16
;

35 
__u32
 
	t__bôwi£
 
	t__wsum
;

46 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

48 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/libc-compat.h

48 #i‚de‡
_LIBC_COMPAT_H


49 
	#_LIBC_COMPAT_H


	)

52 #i‡
deföed
(
__GLIBC__
)

55 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

60 
	#__UAPI_DEF_IF_IFCONF
 0

	)

61 
	#__UAPI_DEF_IF_IFMAP
 0

	)

62 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

63 
	#__UAPI_DEF_IF_IFREQ
 0

	)

65 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

67 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


68 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

77 
	#__UAPI_DEF_IF_IFCONF
 1

	)

78 
	#__UAPI_DEF_IF_IFMAP
 1

	)

79 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

80 
	#__UAPI_DEF_IF_IFREQ
 1

	)

82 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

84 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

89 #i‡
deföed
(
_NETINET_IN_H
)

93 
	#__UAPI_DEF_IN_ADDR
 0

	)

94 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

95 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

96 
	#__UAPI_DEF_IP_MREQ
 0

	)

97 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

98 
	#__UAPI_DEF_IN_CLASS
 0

	)

100 
	#__UAPI_DEF_IN6_ADDR
 0

	)

105 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

106 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

108 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

110 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

111 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

112 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

113 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

114 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

115 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

122 
	#__UAPI_DEF_IN_ADDR
 1

	)

123 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

124 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

125 
	#__UAPI_DEF_IP_MREQ
 1

	)

126 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

127 
	#__UAPI_DEF_IN_CLASS
 1

	)

129 
	#__UAPI_DEF_IN6_ADDR
 1

	)

132 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

133 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

134 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

135 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

136 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

137 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

138 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

143 #i‡
deföed
(
_SYS_XATTR_H
)

144 
	#__UAPI_DEF_XATTR
 0

	)

146 
	#__UAPI_DEF_XATTR
 1

	)

155 
	#__UAPI_DEF_IF_IFCONF
 1

	)

156 
	#__UAPI_DEF_IF_IFMAP
 1

	)

157 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

158 
	#__UAPI_DEF_IF_IFREQ
 1

	)

160 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

162 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

165 
	#__UAPI_DEF_IN_ADDR
 1

	)

166 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

167 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

168 
	#__UAPI_DEF_IP_MREQ
 1

	)

169 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

170 
	#__UAPI_DEF_IN_CLASS
 1

	)

173 
	#__UAPI_DEF_IN6_ADDR
 1

	)

174 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

175 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

176 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

177 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

178 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

179 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

180 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

183 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/pci_regs.h

22 #i‚de‡
LINUX_PCI_REGS_H


23 
	#LINUX_PCI_REGS_H


	)

29 
	#PCI_STD_HEADER_SIZEOF
 64

	)

30 
	#PCI_VENDOR_ID
 0x00

	)

31 
	#PCI_DEVICE_ID
 0x02

	)

32 
	#PCI_COMMAND
 0x04

	)

33 
	#PCI_COMMAND_IO
 0x1

	)

34 
	#PCI_COMMAND_MEMORY
 0x2

	)

35 
	#PCI_COMMAND_MASTER
 0x4

	)

36 
	#PCI_COMMAND_SPECIAL
 0x8

	)

37 
	#PCI_COMMAND_INVALIDATE
 0x10

	)

38 
	#PCI_COMMAND_VGA_PALETTE
 0x20

	)

39 
	#PCI_COMMAND_PARITY
 0x40

	)

40 
	#PCI_COMMAND_WAIT
 0x80

	)

41 
	#PCI_COMMAND_SERR
 0x100

	)

42 
	#PCI_COMMAND_FAST_BACK
 0x200

	)

43 
	#PCI_COMMAND_INTX_DISABLE
 0x400

	)

45 
	#PCI_STATUS
 0x06

	)

46 
	#PCI_STATUS_INTERRUPT
 0x08

	)

47 
	#PCI_STATUS_CAP_LIST
 0x10

	)

48 
	#PCI_STATUS_66MHZ
 0x20

	)

49 
	#PCI_STATUS_UDF
 0x40

	)

50 
	#PCI_STATUS_FAST_BACK
 0x80

	)

51 
	#PCI_STATUS_PARITY
 0x100

	)

52 
	#PCI_STATUS_DEVSEL_MASK
 0x600

	)

53 
	#PCI_STATUS_DEVSEL_FAST
 0x000

	)

54 
	#PCI_STATUS_DEVSEL_MEDIUM
 0x200

	)

55 
	#PCI_STATUS_DEVSEL_SLOW
 0x400

	)

56 
	#PCI_STATUS_SIG_TARGET_ABORT
 0x800

	)

57 
	#PCI_STATUS_REC_TARGET_ABORT
 0x1000

	)

58 
	#PCI_STATUS_REC_MASTER_ABORT
 0x2000

	)

59 
	#PCI_STATUS_SIG_SYSTEM_ERROR
 0x4000

	)

60 
	#PCI_STATUS_DETECTED_PARITY
 0x8000

	)

62 
	#PCI_CLASS_REVISION
 0x08

	)

63 
	#PCI_REVISION_ID
 0x08

	)

64 
	#PCI_CLASS_PROG
 0x09

	)

65 
	#PCI_CLASS_DEVICE
 0x0®

	)

67 
	#PCI_CACHE_LINE_SIZE
 0x0¯

	)

68 
	#PCI_LATENCY_TIMER
 0x0d

	)

69 
	#PCI_HEADER_TYPE
 0x0ê

	)

70 
	#PCI_HEADER_TYPE_NORMAL
 0

	)

71 
	#PCI_HEADER_TYPE_BRIDGE
 1

	)

72 
	#PCI_HEADER_TYPE_CARDBUS
 2

	)

74 
	#PCI_BIST
 0x0‡

	)

75 
	#PCI_BIST_CODE_MASK
 0x0‡

	)

76 
	#PCI_BIST_START
 0x40

	)

77 
	#PCI_BIST_CAPABLE
 0x80

	)

85 
	#PCI_BASE_ADDRESS_0
 0x10

	)

86 
	#PCI_BASE_ADDRESS_1
 0x14

	)

87 
	#PCI_BASE_ADDRESS_2
 0x18

	)

88 
	#PCI_BASE_ADDRESS_3
 0x1¯

	)

89 
	#PCI_BASE_ADDRESS_4
 0x20

	)

90 
	#PCI_BASE_ADDRESS_5
 0x24

	)

91 
	#PCI_BASE_ADDRESS_SPACE
 0x01

	)

92 
	#PCI_BASE_ADDRESS_SPACE_IO
 0x01

	)

93 
	#PCI_BASE_ADDRESS_SPACE_MEMORY
 0x00

	)

94 
	#PCI_BASE_ADDRESS_MEM_TYPE_MASK
 0x06

	)

95 
	#PCI_BASE_ADDRESS_MEM_TYPE_32
 0x00

	)

96 
	#PCI_BASE_ADDRESS_MEM_TYPE_1M
 0x02

	)

97 
	#PCI_BASE_ADDRESS_MEM_TYPE_64
 0x04

	)

98 
	#PCI_BASE_ADDRESS_MEM_PREFETCH
 0x08

	)

99 
	#PCI_BASE_ADDRESS_MEM_MASK
 (~0x0fUL)

	)

100 
	#PCI_BASE_ADDRESS_IO_MASK
 (~0x03UL)

	)

104 
	#PCI_CARDBUS_CIS
 0x28

	)

105 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2c

	)

106 
	#PCI_SUBSYSTEM_ID
 0x2e

	)

107 
	#PCI_ROM_ADDRESS
 0x30

	)

108 
	#PCI_ROM_ADDRESS_ENABLE
 0x01

	)

109 
	#PCI_ROM_ADDRESS_MASK
 (~0x7ffU)

	)

111 
	#PCI_CAPABILITY_LIST
 0x34

	)

114 
	#PCI_INTERRUPT_LINE
 0x3¯

	)

115 
	#PCI_INTERRUPT_PIN
 0x3d

	)

116 
	#PCI_MIN_GNT
 0x3ê

	)

117 
	#PCI_MAX_LAT
 0x3‡

	)

120 
	#PCI_PRIMARY_BUS
 0x18

	)

121 
	#PCI_SECONDARY_BUS
 0x19

	)

122 
	#PCI_SUBORDINATE_BUS
 0x1®

	)

123 
	#PCI_SEC_LATENCY_TIMER
 0x1b

	)

124 
	#PCI_IO_BASE
 0x1¯

	)

125 
	#PCI_IO_LIMIT
 0x1d

	)

126 
	#PCI_IO_RANGE_TYPE_MASK
 0x0fUL

	)

127 
	#PCI_IO_RANGE_TYPE_16
 0x00

	)

128 
	#PCI_IO_RANGE_TYPE_32
 0x01

	)

129 
	#PCI_IO_RANGE_MASK
 (~0x0fULË

	)

130 
	#PCI_IO_1K_RANGE_MASK
 (~0x03ULË

	)

131 
	#PCI_SEC_STATUS
 0x1ê

	)

132 
	#PCI_MEMORY_BASE
 0x20

	)

133 
	#PCI_MEMORY_LIMIT
 0x22

	)

134 
	#PCI_MEMORY_RANGE_TYPE_MASK
 0x0fUL

	)

135 
	#PCI_MEMORY_RANGE_MASK
 (~0x0fUL)

	)

136 
	#PCI_PREF_MEMORY_BASE
 0x24

	)

137 
	#PCI_PREF_MEMORY_LIMIT
 0x26

	)

138 
	#PCI_PREF_RANGE_TYPE_MASK
 0x0fUL

	)

139 
	#PCI_PREF_RANGE_TYPE_32
 0x00

	)

140 
	#PCI_PREF_RANGE_TYPE_64
 0x01

	)

141 
	#PCI_PREF_RANGE_MASK
 (~0x0fUL)

	)

142 
	#PCI_PREF_BASE_UPPER32
 0x28

	)

143 
	#PCI_PREF_LIMIT_UPPER32
 0x2c

	)

144 
	#PCI_IO_BASE_UPPER16
 0x30

	)

145 
	#PCI_IO_LIMIT_UPPER16
 0x32

	)

148 
	#PCI_ROM_ADDRESS1
 0x38

	)

150 
	#PCI_BRIDGE_CONTROL
 0x3e

	)

151 
	#PCI_BRIDGE_CTL_PARITY
 0x01

	)

152 
	#PCI_BRIDGE_CTL_SERR
 0x02

	)

153 
	#PCI_BRIDGE_CTL_ISA
 0x04

	)

154 
	#PCI_BRIDGE_CTL_VGA
 0x08

	)

155 
	#PCI_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

156 
	#PCI_BRIDGE_CTL_BUS_RESET
 0x40

	)

157 
	#PCI_BRIDGE_CTL_FAST_BACK
 0x80

	)

160 
	#PCI_CB_CAPABILITY_LIST
 0x14

	)

162 
	#PCI_CB_SEC_STATUS
 0x16

	)

163 
	#PCI_CB_PRIMARY_BUS
 0x18

	)

164 
	#PCI_CB_CARD_BUS
 0x19

	)

165 
	#PCI_CB_SUBORDINATE_BUS
 0x1®

	)

166 
	#PCI_CB_LATENCY_TIMER
 0x1b

	)

167 
	#PCI_CB_MEMORY_BASE_0
 0x1c

	)

168 
	#PCI_CB_MEMORY_LIMIT_0
 0x20

	)

169 
	#PCI_CB_MEMORY_BASE_1
 0x24

	)

170 
	#PCI_CB_MEMORY_LIMIT_1
 0x28

	)

171 
	#PCI_CB_IO_BASE_0
 0x2c

	)

172 
	#PCI_CB_IO_BASE_0_HI
 0x2e

	)

173 
	#PCI_CB_IO_LIMIT_0
 0x30

	)

174 
	#PCI_CB_IO_LIMIT_0_HI
 0x32

	)

175 
	#PCI_CB_IO_BASE_1
 0x34

	)

176 
	#PCI_CB_IO_BASE_1_HI
 0x36

	)

177 
	#PCI_CB_IO_LIMIT_1
 0x38

	)

178 
	#PCI_CB_IO_LIMIT_1_HI
 0x3a

	)

179 
	#PCI_CB_IO_RANGE_MASK
 (~0x03UL)

	)

181 
	#PCI_CB_BRIDGE_CONTROL
 0x3e

	)

182 
	#PCI_CB_BRIDGE_CTL_PARITY
 0x01

	)

183 
	#PCI_CB_BRIDGE_CTL_SERR
 0x02

	)

184 
	#PCI_CB_BRIDGE_CTL_ISA
 0x04

	)

185 
	#PCI_CB_BRIDGE_CTL_VGA
 0x08

	)

186 
	#PCI_CB_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

187 
	#PCI_CB_BRIDGE_CTL_CB_RESET
 0x40

	)

188 
	#PCI_CB_BRIDGE_CTL_16BIT_INT
 0x80

	)

189 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM0
 0x100

	)

190 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM1
 0x200

	)

191 
	#PCI_CB_BRIDGE_CTL_POST_WRITES
 0x400

	)

192 
	#PCI_CB_SUBSYSTEM_VENDOR_ID
 0x40

	)

193 
	#PCI_CB_SUBSYSTEM_ID
 0x42

	)

194 
	#PCI_CB_LEGACY_MODE_BASE
 0x44

	)

199 
	#PCI_CAP_LIST_ID
 0

	)

200 
	#PCI_CAP_ID_PM
 0x01

	)

201 
	#PCI_CAP_ID_AGP
 0x02

	)

202 
	#PCI_CAP_ID_VPD
 0x03

	)

203 
	#PCI_CAP_ID_SLOTID
 0x04

	)

204 
	#PCI_CAP_ID_MSI
 0x05

	)

205 
	#PCI_CAP_ID_CHSWP
 0x06

	)

206 
	#PCI_CAP_ID_PCIX
 0x07

	)

207 
	#PCI_CAP_ID_HT
 0x08

	)

208 
	#PCI_CAP_ID_VNDR
 0x09

	)

209 
	#PCI_CAP_ID_DBG
 0x0A

	)

210 
	#PCI_CAP_ID_CCRC
 0x0B

	)

211 
	#PCI_CAP_ID_SHPC
 0x0C

	)

212 
	#PCI_CAP_ID_SSVID
 0x0D

	)

213 
	#PCI_CAP_ID_AGP3
 0x0E

	)

214 
	#PCI_CAP_ID_SECDEV
 0x0F

	)

215 
	#PCI_CAP_ID_EXP
 0x10

	)

216 
	#PCI_CAP_ID_MSIX
 0x11

	)

217 
	#PCI_CAP_ID_SATA
 0x12

	)

218 
	#PCI_CAP_ID_AF
 0x13

	)

219 
	#PCI_CAP_ID_EA
 0x14

	)

220 
	#PCI_CAP_ID_MAX
 
PCI_CAP_ID_EA


	)

221 
	#PCI_CAP_LIST_NEXT
 1

	)

222 
	#PCI_CAP_FLAGS
 2

	)

223 
	#PCI_CAP_SIZEOF
 4

	)

227 
	#PCI_PM_PMC
 2

	)

228 
	#PCI_PM_CAP_VER_MASK
 0x0007

	)

229 
	#PCI_PM_CAP_PME_CLOCK
 0x0008

	)

230 
	#PCI_PM_CAP_RESERVED
 0x0010

	)

231 
	#PCI_PM_CAP_DSI
 0x0020

	)

232 
	#PCI_PM_CAP_AUX_POWER
 0x01C0

	)

233 
	#PCI_PM_CAP_D1
 0x0200

	)

234 
	#PCI_PM_CAP_D2
 0x0400

	)

235 
	#PCI_PM_CAP_PME
 0x0800

	)

236 
	#PCI_PM_CAP_PME_MASK
 0xF800

	)

237 
	#PCI_PM_CAP_PME_D0
 0x0800

	)

238 
	#PCI_PM_CAP_PME_D1
 0x1000

	)

239 
	#PCI_PM_CAP_PME_D2
 0x2000

	)

240 
	#PCI_PM_CAP_PME_D3
 0x4000

	)

241 
	#PCI_PM_CAP_PME_D3cﬁd
 0x8000

	)

242 
	#PCI_PM_CAP_PME_SHIFT
 11

	)

243 
	#PCI_PM_CTRL
 4

	)

244 
	#PCI_PM_CTRL_STATE_MASK
 0x0003

	)

245 
	#PCI_PM_CTRL_NO_SOFT_RESET
 0x0008

	)

246 
	#PCI_PM_CTRL_PME_ENABLE
 0x0100

	)

247 
	#PCI_PM_CTRL_DATA_SEL_MASK
 0x1e00

	)

248 
	#PCI_PM_CTRL_DATA_SCALE_MASK
 0x6000

	)

249 
	#PCI_PM_CTRL_PME_STATUS
 0x8000

	)

250 
	#PCI_PM_PPB_EXTENSIONS
 6

	)

251 
	#PCI_PM_PPB_B2_B3
 0x40

	)

252 
	#PCI_PM_BPCC_ENABLE
 0x80

	)

253 
	#PCI_PM_DATA_REGISTER
 7

	)

254 
	#PCI_PM_SIZEOF
 8

	)

258 
	#PCI_AGP_VERSION
 2

	)

259 
	#PCI_AGP_RFU
 3

	)

260 
	#PCI_AGP_STATUS
 4

	)

261 
	#PCI_AGP_STATUS_RQ_MASK
 0xff000000

	)

262 
	#PCI_AGP_STATUS_SBA
 0x0200

	)

263 
	#PCI_AGP_STATUS_64BIT
 0x0020

	)

264 
	#PCI_AGP_STATUS_FW
 0x0010

	)

265 
	#PCI_AGP_STATUS_RATE4
 0x0004

	)

266 
	#PCI_AGP_STATUS_RATE2
 0x0002

	)

267 
	#PCI_AGP_STATUS_RATE1
 0x0001

	)

268 
	#PCI_AGP_COMMAND
 8

	)

269 
	#PCI_AGP_COMMAND_RQ_MASK
 0xff000000

	)

270 
	#PCI_AGP_COMMAND_SBA
 0x0200

	)

271 
	#PCI_AGP_COMMAND_AGP
 0x0100

	)

272 
	#PCI_AGP_COMMAND_64BIT
 0x0020

	)

273 
	#PCI_AGP_COMMAND_FW
 0x0010

	)

274 
	#PCI_AGP_COMMAND_RATE4
 0x0004

	)

275 
	#PCI_AGP_COMMAND_RATE2
 0x0002

	)

276 
	#PCI_AGP_COMMAND_RATE1
 0x0001

	)

277 
	#PCI_AGP_SIZEOF
 12

	)

281 
	#PCI_VPD_ADDR
 2

	)

282 
	#PCI_VPD_ADDR_MASK
 0x7ff‡

	)

283 
	#PCI_VPD_ADDR_F
 0x8000

	)

284 
	#PCI_VPD_DATA
 4

	)

285 
	#PCI_CAP_VPD_SIZEOF
 8

	)

289 
	#PCI_SID_ESR
 2

	)

290 
	#PCI_SID_ESR_NSLOTS
 0x1‡

	)

291 
	#PCI_SID_ESR_FIC
 0x20

	)

292 
	#PCI_SID_CHASSIS_NR
 3

	)

296 
	#PCI_MSI_FLAGS
 2

	)

297 
	#PCI_MSI_FLAGS_ENABLE
 0x0001

	)

298 
	#PCI_MSI_FLAGS_QMASK
 0x000ê

	)

299 
	#PCI_MSI_FLAGS_QSIZE
 0x0070

	)

300 
	#PCI_MSI_FLAGS_64BIT
 0x0080

	)

301 
	#PCI_MSI_FLAGS_MASKBIT
 0x0100

	)

302 
	#PCI_MSI_RFU
 3

	)

303 
	#PCI_MSI_ADDRESS_LO
 4

	)

304 
	#PCI_MSI_ADDRESS_HI
 8

	)

305 
	#PCI_MSI_DATA_32
 8

	)

306 
	#PCI_MSI_MASK_32
 12

	)

307 
	#PCI_MSI_PENDING_32
 16

	)

308 
	#PCI_MSI_DATA_64
 12

	)

309 
	#PCI_MSI_MASK_64
 16

	)

310 
	#PCI_MSI_PENDING_64
 20

	)

313 
	#PCI_MSIX_FLAGS
 2

	)

314 
	#PCI_MSIX_FLAGS_QSIZE
 0x07FF

	)

315 
	#PCI_MSIX_FLAGS_MASKALL
 0x4000

	)

316 
	#PCI_MSIX_FLAGS_ENABLE
 0x8000

	)

317 
	#PCI_MSIX_TABLE
 4

	)

318 
	#PCI_MSIX_TABLE_BIR
 0x00000007

	)

319 
	#PCI_MSIX_TABLE_OFFSET
 0xfffffff8

	)

320 
	#PCI_MSIX_PBA
 8

	)

321 
	#PCI_MSIX_PBA_BIR
 0x00000007

	)

322 
	#PCI_MSIX_PBA_OFFSET
 0xfffffff8

	)

323 
	#PCI_MSIX_FLAGS_BIRMASK
 
PCI_MSIX_PBA_BIR


	)

324 
	#PCI_CAP_MSIX_SIZEOF
 12

	)

327 
	#PCI_MSIX_ENTRY_SIZE
 16

	)

328 
	#PCI_MSIX_ENTRY_LOWER_ADDR
 0

	)

329 
	#PCI_MSIX_ENTRY_UPPER_ADDR
 4

	)

330 
	#PCI_MSIX_ENTRY_DATA
 8

	)

331 
	#PCI_MSIX_ENTRY_VECTOR_CTRL
 12

	)

332 
	#PCI_MSIX_ENTRY_CTRL_MASKBIT
 1

	)

336 
	#PCI_CHSWP_CSR
 2

	)

337 
	#PCI_CHSWP_DHA
 0x01

	)

338 
	#PCI_CHSWP_EIM
 0x02

	)

339 
	#PCI_CHSWP_PIE
 0x04

	)

340 
	#PCI_CHSWP_LOO
 0x08

	)

341 
	#PCI_CHSWP_PI
 0x30

	)

342 
	#PCI_CHSWP_EXT
 0x40

	)

343 
	#PCI_CHSWP_INS
 0x80

	)

347 
	#PCI_AF_LENGTH
 2

	)

348 
	#PCI_AF_CAP
 3

	)

349 
	#PCI_AF_CAP_TP
 0x01

	)

350 
	#PCI_AF_CAP_FLR
 0x02

	)

351 
	#PCI_AF_CTRL
 4

	)

352 
	#PCI_AF_CTRL_FLR
 0x01

	)

353 
	#PCI_AF_STATUS
 5

	)

354 
	#PCI_AF_STATUS_TP
 0x01

	)

355 
	#PCI_CAP_AF_SIZEOF
 6

	)

359 
	#PCI_EA_NUM_ENT
 2

	)

360 
	#PCI_EA_NUM_ENT_MASK
 0x3‡

	)

361 
	#PCI_EA_FIRST_ENT
 4

	)

362 
	#PCI_EA_FIRST_ENT_BRIDGE
 8

	)

363 
	#PCI_EA_ES
 0x00000007

	)

364 
	#PCI_EA_BEI
 0x000000f0

	)

366 
	#PCI_EA_BEI_BAR0
 0

	)

367 
	#PCI_EA_BEI_BAR5
 5

	)

368 
	#PCI_EA_BEI_BRIDGE
 6

	)

369 
	#PCI_EA_BEI_ENI
 7

	)

370 
	#PCI_EA_BEI_ROM
 8

	)

372 
	#PCI_EA_BEI_VF_BAR0
 9

	)

373 
	#PCI_EA_BEI_VF_BAR5
 14

	)

374 
	#PCI_EA_BEI_RESERVED
 15

	)

375 
	#PCI_EA_PP
 0x0000ff00

	)

376 
	#PCI_EA_SP
 0x00ff0000

	)

377 
	#PCI_EA_P_MEM
 0x00

	)

378 
	#PCI_EA_P_MEM_PREFETCH
 0x01

	)

379 
	#PCI_EA_P_IO
 0x02

	)

380 
	#PCI_EA_P_VF_MEM_PREFETCH
 0x03

	)

381 
	#PCI_EA_P_VF_MEM
 0x04

	)

382 
	#PCI_EA_P_BRIDGE_MEM
 0x05

	)

383 
	#PCI_EA_P_BRIDGE_MEM_PREFETCH
 0x06

	)

384 
	#PCI_EA_P_BRIDGE_IO
 0x07

	)

386 
	#PCI_EA_P_MEM_RESERVED
 0xfd

	)

387 
	#PCI_EA_P_IO_RESERVED
 0x„

	)

388 
	#PCI_EA_P_UNAVAILABLE
 0xf‡

	)

389 
	#PCI_EA_WRITABLE
 0x40000000

	)

390 
	#PCI_EA_ENABLE
 0x80000000

	)

391 
	#PCI_EA_BASE
 4

	)

392 
	#PCI_EA_MAX_OFFSET
 8

	)

394 
	#PCI_EA_IS_64
 0x00000002

	)

395 
	#PCI_EA_FIELD_MASK
 0xfffffff¯

	)

399 
	#PCI_X_CMD
 2

	)

400 
	#PCI_X_CMD_DPERR_E
 0x0001

	)

401 
	#PCI_X_CMD_ERO
 0x0002

	)

402 
	#PCI_X_CMD_READ_512
 0x0000

	)

403 
	#PCI_X_CMD_READ_1K
 0x0004

	)

404 
	#PCI_X_CMD_READ_2K
 0x0008

	)

405 
	#PCI_X_CMD_READ_4K
 0x000¯

	)

406 
	#PCI_X_CMD_MAX_READ
 0x000¯

	)

408 
	#PCI_X_CMD_SPLIT_1
 0x0000

	)

409 
	#PCI_X_CMD_SPLIT_2
 0x0010

	)

410 
	#PCI_X_CMD_SPLIT_3
 0x0020

	)

411 
	#PCI_X_CMD_SPLIT_4
 0x0030

	)

412 
	#PCI_X_CMD_SPLIT_8
 0x0040

	)

413 
	#PCI_X_CMD_SPLIT_12
 0x0050

	)

414 
	#PCI_X_CMD_SPLIT_16
 0x0060

	)

415 
	#PCI_X_CMD_SPLIT_32
 0x0070

	)

416 
	#PCI_X_CMD_MAX_SPLIT
 0x0070

	)

417 
	#PCI_X_CMD_VERSION
(
x
Ë(((xË>> 12Ë& 3Ë

	)

418 
	#PCI_X_STATUS
 4

	)

419 
	#PCI_X_STATUS_DEVFN
 0x000000f‡

	)

420 
	#PCI_X_STATUS_BUS
 0x0000ff00

	)

421 
	#PCI_X_STATUS_64BIT
 0x00010000

	)

422 
	#PCI_X_STATUS_133MHZ
 0x00020000

	)

423 
	#PCI_X_STATUS_SPL_DISC
 0x00040000

	)

424 
	#PCI_X_STATUS_UNX_SPL
 0x00080000

	)

425 
	#PCI_X_STATUS_COMPLEX
 0x00100000

	)

426 
	#PCI_X_STATUS_MAX_READ
 0x00600000

	)

427 
	#PCI_X_STATUS_MAX_SPLIT
 0x03800000

	)

428 
	#PCI_X_STATUS_MAX_CUM
 0x1c000000

	)

429 
	#PCI_X_STATUS_SPL_ERR
 0x20000000

	)

430 
	#PCI_X_STATUS_266MHZ
 0x40000000

	)

431 
	#PCI_X_STATUS_533MHZ
 0x80000000

	)

432 
	#PCI_X_ECC_CSR
 8

	)

433 
	#PCI_CAP_PCIX_SIZEOF_V0
 8

	)

434 
	#PCI_CAP_PCIX_SIZEOF_V1
 24

	)

435 
	#PCI_CAP_PCIX_SIZEOF_V2
 
PCI_CAP_PCIX_SIZEOF_V1


	)

439 
	#PCI_X_BRIDGE_SSTATUS
 2

	)

440 
	#PCI_X_SSTATUS_64BIT
 0x0001

	)

441 
	#PCI_X_SSTATUS_133MHZ
 0x0002

	)

442 
	#PCI_X_SSTATUS_FREQ
 0x03c0

	)

443 
	#PCI_X_SSTATUS_VERS
 0x3000

	)

444 
	#PCI_X_SSTATUS_V1
 0x1000

	)

445 
	#PCI_X_SSTATUS_V2
 0x2000

	)

446 
	#PCI_X_SSTATUS_266MHZ
 0x4000

	)

447 
	#PCI_X_SSTATUS_533MHZ
 0x8000

	)

448 
	#PCI_X_BRIDGE_STATUS
 4

	)

452 
	#PCI_SSVID_VENDOR_ID
 4

	)

453 
	#PCI_SSVID_DEVICE_ID
 6

	)

457 
	#PCI_EXP_FLAGS
 2

	)

458 
	#PCI_EXP_FLAGS_VERS
 0x000‡

	)

459 
	#PCI_EXP_FLAGS_TYPE
 0x00f0

	)

460 
	#PCI_EXP_TYPE_ENDPOINT
 0x0

	)

461 
	#PCI_EXP_TYPE_LEG_END
 0x1

	)

462 
	#PCI_EXP_TYPE_ROOT_PORT
 0x4

	)

463 
	#PCI_EXP_TYPE_UPSTREAM
 0x5

	)

464 
	#PCI_EXP_TYPE_DOWNSTREAM
 0x6

	)

465 
	#PCI_EXP_TYPE_PCI_BRIDGE
 0x7

	)

466 
	#PCI_EXP_TYPE_PCIE_BRIDGE
 0x8

	)

467 
	#PCI_EXP_TYPE_RC_END
 0x9

	)

468 
	#PCI_EXP_TYPE_RC_EC
 0x®

	)

469 
	#PCI_EXP_FLAGS_SLOT
 0x0100

	)

470 
	#PCI_EXP_FLAGS_IRQ
 0x3e00

	)

471 
	#PCI_EXP_DEVCAP
 4

	)

472 
	#PCI_EXP_DEVCAP_PAYLOAD
 0x00000007

	)

473 
	#PCI_EXP_DEVCAP_PHANTOM
 0x00000018

	)

474 
	#PCI_EXP_DEVCAP_EXT_TAG
 0x00000020

	)

475 
	#PCI_EXP_DEVCAP_L0S
 0x000001c0

	)

476 
	#PCI_EXP_DEVCAP_L1
 0x00000e00

	)

477 
	#PCI_EXP_DEVCAP_ATN_BUT
 0x00001000

	)

478 
	#PCI_EXP_DEVCAP_ATN_IND
 0x00002000

	)

479 
	#PCI_EXP_DEVCAP_PWR_IND
 0x00004000

	)

480 
	#PCI_EXP_DEVCAP_RBER
 0x00008000

	)

481 
	#PCI_EXP_DEVCAP_PWR_VAL
 0x03fc0000

	)

482 
	#PCI_EXP_DEVCAP_PWR_SCL
 0x0c000000

	)

483 
	#PCI_EXP_DEVCAP_FLR
 0x10000000

	)

484 
	#PCI_EXP_DEVCTL
 8

	)

485 
	#PCI_EXP_DEVCTL_CERE
 0x0001

	)

486 
	#PCI_EXP_DEVCTL_NFERE
 0x0002

	)

487 
	#PCI_EXP_DEVCTL_FERE
 0x0004

	)

488 
	#PCI_EXP_DEVCTL_URRE
 0x0008

	)

489 
	#PCI_EXP_DEVCTL_RELAX_EN
 0x0010

	)

490 
	#PCI_EXP_DEVCTL_PAYLOAD
 0x00e0

	)

491 
	#PCI_EXP_DEVCTL_EXT_TAG
 0x0100

	)

492 
	#PCI_EXP_DEVCTL_PHANTOM
 0x0200

	)

493 
	#PCI_EXP_DEVCTL_AUX_PME
 0x0400

	)

494 
	#PCI_EXP_DEVCTL_NOSNOOP_EN
 0x0800

	)

495 
	#PCI_EXP_DEVCTL_READRQ
 0x7000

	)

496 
	#PCI_EXP_DEVCTL_READRQ_128B
 0x0000

	)

497 
	#PCI_EXP_DEVCTL_READRQ_256B
 0x1000

	)

498 
	#PCI_EXP_DEVCTL_READRQ_512B
 0x2000

	)

499 
	#PCI_EXP_DEVCTL_READRQ_1024B
 0x3000

	)

500 
	#PCI_EXP_DEVCTL_BCR_FLR
 0x8000

	)

501 
	#PCI_EXP_DEVSTA
 10

	)

502 
	#PCI_EXP_DEVSTA_CED
 0x0001

	)

503 
	#PCI_EXP_DEVSTA_NFED
 0x0002

	)

504 
	#PCI_EXP_DEVSTA_FED
 0x0004

	)

505 
	#PCI_EXP_DEVSTA_URD
 0x0008

	)

506 
	#PCI_EXP_DEVSTA_AUXPD
 0x0010

	)

507 
	#PCI_EXP_DEVSTA_TRPND
 0x0020

	)

508 
	#PCI_EXP_LNKCAP
 12

	)

509 
	#PCI_EXP_LNKCAP_SLS
 0x0000000‡

	)

510 
	#PCI_EXP_LNKCAP_SLS_2_5GB
 0x00000001

	)

511 
	#PCI_EXP_LNKCAP_SLS_5_0GB
 0x00000002

	)

512 
	#PCI_EXP_LNKCAP_MLW
 0x000003f0

	)

513 
	#PCI_EXP_LNKCAP_ASPMS
 0x00000c00

	)

514 
	#PCI_EXP_LNKCAP_L0SEL
 0x00007000

	)

515 
	#PCI_EXP_LNKCAP_L1EL
 0x00038000

	)

516 
	#PCI_EXP_LNKCAP_CLKPM
 0x00040000

	)

517 
	#PCI_EXP_LNKCAP_SDERC
 0x00080000

	)

518 
	#PCI_EXP_LNKCAP_DLLLARC
 0x00100000

	)

519 
	#PCI_EXP_LNKCAP_LBNC
 0x00200000

	)

520 
	#PCI_EXP_LNKCAP_PN
 0xff000000

	)

521 
	#PCI_EXP_LNKCTL
 16

	)

522 
	#PCI_EXP_LNKCTL_ASPMC
 0x0003

	)

523 
	#PCI_EXP_LNKCTL_ASPM_L0S
 0x0001

	)

524 
	#PCI_EXP_LNKCTL_ASPM_L1
 0x0002

	)

525 
	#PCI_EXP_LNKCTL_RCB
 0x0008

	)

526 
	#PCI_EXP_LNKCTL_LD
 0x0010

	)

527 
	#PCI_EXP_LNKCTL_RL
 0x0020

	)

528 
	#PCI_EXP_LNKCTL_CCC
 0x0040

	)

529 
	#PCI_EXP_LNKCTL_ES
 0x0080

	)

530 
	#PCI_EXP_LNKCTL_CLKREQ_EN
 0x0100

	)

531 
	#PCI_EXP_LNKCTL_HAWD
 0x0200

	)

532 
	#PCI_EXP_LNKCTL_LBMIE
 0x0400

	)

533 
	#PCI_EXP_LNKCTL_LABIE
 0x0800

	)

534 
	#PCI_EXP_LNKSTA
 18

	)

535 
	#PCI_EXP_LNKSTA_CLS
 0x000‡

	)

536 
	#PCI_EXP_LNKSTA_CLS_2_5GB
 0x0001

	)

537 
	#PCI_EXP_LNKSTA_CLS_5_0GB
 0x0002

	)

538 
	#PCI_EXP_LNKSTA_CLS_8_0GB
 0x0003

	)

539 
	#PCI_EXP_LNKSTA_NLW
 0x03f0

	)

540 
	#PCI_EXP_LNKSTA_NLW_X1
 0x0010

	)

541 
	#PCI_EXP_LNKSTA_NLW_X2
 0x0020

	)

542 
	#PCI_EXP_LNKSTA_NLW_X4
 0x0040

	)

543 
	#PCI_EXP_LNKSTA_NLW_X8
 0x0080

	)

544 
	#PCI_EXP_LNKSTA_NLW_SHIFT
 4

	)

545 
	#PCI_EXP_LNKSTA_LT
 0x0800

	)

546 
	#PCI_EXP_LNKSTA_SLC
 0x1000

	)

547 
	#PCI_EXP_LNKSTA_DLLLA
 0x2000

	)

548 
	#PCI_EXP_LNKSTA_LBMS
 0x4000

	)

549 
	#PCI_EXP_LNKSTA_LABS
 0x8000

	)

550 
	#PCI_CAP_EXP_ENDPOINT_SIZEOF_V1
 20

	)

551 
	#PCI_EXP_SLTCAP
 20

	)

552 
	#PCI_EXP_SLTCAP_ABP
 0x00000001

	)

553 
	#PCI_EXP_SLTCAP_PCP
 0x00000002

	)

554 
	#PCI_EXP_SLTCAP_MRLSP
 0x00000004

	)

555 
	#PCI_EXP_SLTCAP_AIP
 0x00000008

	)

556 
	#PCI_EXP_SLTCAP_PIP
 0x00000010

	)

557 
	#PCI_EXP_SLTCAP_HPS
 0x00000020

	)

558 
	#PCI_EXP_SLTCAP_HPC
 0x00000040

	)

559 
	#PCI_EXP_SLTCAP_SPLV
 0x00007f80

	)

560 
	#PCI_EXP_SLTCAP_SPLS
 0x00018000

	)

561 
	#PCI_EXP_SLTCAP_EIP
 0x00020000

	)

562 
	#PCI_EXP_SLTCAP_NCCS
 0x00040000

	)

563 
	#PCI_EXP_SLTCAP_PSN
 0xfff80000

	)

564 
	#PCI_EXP_SLTCTL
 24

	)

565 
	#PCI_EXP_SLTCTL_ABPE
 0x0001

	)

566 
	#PCI_EXP_SLTCTL_PFDE
 0x0002

	)

567 
	#PCI_EXP_SLTCTL_MRLSCE
 0x0004

	)

568 
	#PCI_EXP_SLTCTL_PDCE
 0x0008

	)

569 
	#PCI_EXP_SLTCTL_CCIE
 0x0010

	)

570 
	#PCI_EXP_SLTCTL_HPIE
 0x0020

	)

571 
	#PCI_EXP_SLTCTL_AIC
 0x00c0

	)

572 
	#PCI_EXP_SLTCTL_ATTN_IND_ON
 0x0040

	)

573 
	#PCI_EXP_SLTCTL_ATTN_IND_BLINK
 0x0080

	)

574 
	#PCI_EXP_SLTCTL_ATTN_IND_OFF
 0x00c0

	)

575 
	#PCI_EXP_SLTCTL_PIC
 0x0300

	)

576 
	#PCI_EXP_SLTCTL_PWR_IND_ON
 0x0100

	)

577 
	#PCI_EXP_SLTCTL_PWR_IND_BLINK
 0x0200

	)

578 
	#PCI_EXP_SLTCTL_PWR_IND_OFF
 0x0300

	)

579 
	#PCI_EXP_SLTCTL_PCC
 0x0400

	)

580 
	#PCI_EXP_SLTCTL_PWR_ON
 0x0000

	)

581 
	#PCI_EXP_SLTCTL_PWR_OFF
 0x0400

	)

582 
	#PCI_EXP_SLTCTL_EIC
 0x0800

	)

583 
	#PCI_EXP_SLTCTL_DLLSCE
 0x1000

	)

584 
	#PCI_EXP_SLTSTA
 26

	)

585 
	#PCI_EXP_SLTSTA_ABP
 0x0001

	)

586 
	#PCI_EXP_SLTSTA_PFD
 0x0002

	)

587 
	#PCI_EXP_SLTSTA_MRLSC
 0x0004

	)

588 
	#PCI_EXP_SLTSTA_PDC
 0x0008

	)

589 
	#PCI_EXP_SLTSTA_CC
 0x0010

	)

590 
	#PCI_EXP_SLTSTA_MRLSS
 0x0020

	)

591 
	#PCI_EXP_SLTSTA_PDS
 0x0040

	)

592 
	#PCI_EXP_SLTSTA_EIS
 0x0080

	)

593 
	#PCI_EXP_SLTSTA_DLLSC
 0x0100

	)

594 
	#PCI_EXP_RTCTL
 28

	)

595 
	#PCI_EXP_RTCTL_SECEE
 0x0001

	)

596 
	#PCI_EXP_RTCTL_SENFEE
 0x0002

	)

597 
	#PCI_EXP_RTCTL_SEFEE
 0x0004

	)

598 
	#PCI_EXP_RTCTL_PMEIE
 0x0008

	)

599 
	#PCI_EXP_RTCTL_CRSSVE
 0x0010

	)

600 
	#PCI_EXP_RTCAP
 30

	)

601 
	#PCI_EXP_RTCAP_CRSVIS
 0x0001

	)

602 
	#PCI_EXP_RTSTA
 32

	)

603 
	#PCI_EXP_RTSTA_PME
 0x00010000

	)

604 
	#PCI_EXP_RTSTA_PENDING
 0x00020000

	)

613 
	#PCI_EXP_DEVCAP2
 36

	)

614 
	#PCI_EXP_DEVCAP2_ARI
 0x00000020

	)

615 
	#PCI_EXP_DEVCAP2_LTR
 0x00000800

	)

616 
	#PCI_EXP_DEVCAP2_OBFF_MASK
 0x000c0000

	)

617 
	#PCI_EXP_DEVCAP2_OBFF_MSG
 0x00040000

	)

618 
	#PCI_EXP_DEVCAP2_OBFF_WAKE
 0x00080000

	)

619 
	#PCI_EXP_DEVCTL2
 40

	)

620 
	#PCI_EXP_DEVCTL2_COMP_TIMEOUT
 0x000‡

	)

621 
	#PCI_EXP_DEVCTL2_ARI
 0x0020

	)

622 
	#PCI_EXP_DEVCTL2_IDO_REQ_EN
 0x0100

	)

623 
	#PCI_EXP_DEVCTL2_IDO_CMP_EN
 0x0200

	)

624 
	#PCI_EXP_DEVCTL2_LTR_EN
 0x0400

	)

625 
	#PCI_EXP_DEVCTL2_OBFF_MSGA_EN
 0x2000

	)

626 
	#PCI_EXP_DEVCTL2_OBFF_MSGB_EN
 0x4000

	)

627 
	#PCI_EXP_DEVCTL2_OBFF_WAKE_EN
 0x6000

	)

628 
	#PCI_EXP_DEVSTA2
 42

	)

629 
	#PCI_CAP_EXP_ENDPOINT_SIZEOF_V2
 44

	)

630 
	#PCI_EXP_LNKCAP2
 44

	)

631 
	#PCI_EXP_LNKCAP2_SLS_2_5GB
 0x00000002

	)

632 
	#PCI_EXP_LNKCAP2_SLS_5_0GB
 0x00000004

	)

633 
	#PCI_EXP_LNKCAP2_SLS_8_0GB
 0x00000008

	)

634 
	#PCI_EXP_LNKCAP2_CROSSLINK
 0x00000100

	)

635 
	#PCI_EXP_LNKCTL2
 48

	)

636 
	#PCI_EXP_LNKSTA2
 50

	)

637 
	#PCI_EXP_SLTCAP2
 52

	)

638 
	#PCI_EXP_SLTCTL2
 56

	)

639 
	#PCI_EXP_SLTSTA2
 58

	)

642 
	#PCI_EXT_CAP_ID
(
hódî
Ë(hódî & 0x0000ffff)

	)

643 
	#PCI_EXT_CAP_VER
(
hódî
Ë((hódî >> 16Ë& 0xf)

	)

644 
	#PCI_EXT_CAP_NEXT
(
hódî
Ë((hódî >> 20Ë& 0xffc)

	)

646 
	#PCI_EXT_CAP_ID_ERR
 0x01

	)

647 
	#PCI_EXT_CAP_ID_VC
 0x02

	)

648 
	#PCI_EXT_CAP_ID_DSN
 0x03

	)

649 
	#PCI_EXT_CAP_ID_PWR
 0x04

	)

650 
	#PCI_EXT_CAP_ID_RCLD
 0x05

	)

651 
	#PCI_EXT_CAP_ID_RCILC
 0x06

	)

652 
	#PCI_EXT_CAP_ID_RCEC
 0x07

	)

653 
	#PCI_EXT_CAP_ID_MFVC
 0x08

	)

654 
	#PCI_EXT_CAP_ID_VC9
 0x09

	)

655 
	#PCI_EXT_CAP_ID_RCRB
 0x0A

	)

656 
	#PCI_EXT_CAP_ID_VNDR
 0x0B

	)

657 
	#PCI_EXT_CAP_ID_CAC
 0x0C

	)

658 
	#PCI_EXT_CAP_ID_ACS
 0x0D

	)

659 
	#PCI_EXT_CAP_ID_ARI
 0x0E

	)

660 
	#PCI_EXT_CAP_ID_ATS
 0x0F

	)

661 
	#PCI_EXT_CAP_ID_SRIOV
 0x10

	)

662 
	#PCI_EXT_CAP_ID_MRIOV
 0x11

	)

663 
	#PCI_EXT_CAP_ID_MCAST
 0x12

	)

664 
	#PCI_EXT_CAP_ID_PRI
 0x13

	)

665 
	#PCI_EXT_CAP_ID_AMD_XXX
 0x14

	)

666 
	#PCI_EXT_CAP_ID_REBAR
 0x15

	)

667 
	#PCI_EXT_CAP_ID_DPA
 0x16

	)

668 
	#PCI_EXT_CAP_ID_TPH
 0x17

	)

669 
	#PCI_EXT_CAP_ID_LTR
 0x18

	)

670 
	#PCI_EXT_CAP_ID_SECPCI
 0x19

	)

671 
	#PCI_EXT_CAP_ID_PMUX
 0x1A

	)

672 
	#PCI_EXT_CAP_ID_PASID
 0x1B

	)

673 
	#PCI_EXT_CAP_ID_MAX
 
PCI_EXT_CAP_ID_PASID


	)

675 
	#PCI_EXT_CAP_DSN_SIZEOF
 12

	)

676 
	#PCI_EXT_CAP_MCAST_ENDPOINT_SIZEOF
 40

	)

679 
	#PCI_ERR_UNCOR_STATUS
 4

	)

680 
	#PCI_ERR_UNC_UND
 0x00000001

	)

681 
	#PCI_ERR_UNC_DLP
 0x00000010

	)

682 
	#PCI_ERR_UNC_SURPDN
 0x00000020

	)

683 
	#PCI_ERR_UNC_POISON_TLP
 0x00001000

	)

684 
	#PCI_ERR_UNC_FCP
 0x00002000

	)

685 
	#PCI_ERR_UNC_COMP_TIME
 0x00004000

	)

686 
	#PCI_ERR_UNC_COMP_ABORT
 0x00008000

	)

687 
	#PCI_ERR_UNC_UNX_COMP
 0x00010000

	)

688 
	#PCI_ERR_UNC_RX_OVER
 0x00020000

	)

689 
	#PCI_ERR_UNC_MALF_TLP
 0x00040000

	)

690 
	#PCI_ERR_UNC_ECRC
 0x00080000

	)

691 
	#PCI_ERR_UNC_UNSUP
 0x00100000

	)

692 
	#PCI_ERR_UNC_ACSV
 0x00200000

	)

693 
	#PCI_ERR_UNC_INTN
 0x00400000

	)

694 
	#PCI_ERR_UNC_MCBTLP
 0x00800000

	)

695 
	#PCI_ERR_UNC_ATOMEG
 0x01000000

	)

696 
	#PCI_ERR_UNC_TLPPRE
 0x02000000

	)

697 
	#PCI_ERR_UNCOR_MASK
 8

	)

699 
	#PCI_ERR_UNCOR_SEVER
 12

	)

701 
	#PCI_ERR_COR_STATUS
 16

	)

702 
	#PCI_ERR_COR_RCVR
 0x00000001

	)

703 
	#PCI_ERR_COR_BAD_TLP
 0x00000040

	)

704 
	#PCI_ERR_COR_BAD_DLLP
 0x00000080

	)

705 
	#PCI_ERR_COR_REP_ROLL
 0x00000100

	)

706 
	#PCI_ERR_COR_REP_TIMER
 0x00001000

	)

707 
	#PCI_ERR_COR_ADV_NFAT
 0x00002000

	)

708 
	#PCI_ERR_COR_INTERNAL
 0x00004000

	)

709 
	#PCI_ERR_COR_LOG_OVER
 0x00008000

	)

710 
	#PCI_ERR_COR_MASK
 20

	)

712 
	#PCI_ERR_CAP
 24

	)

713 
	#PCI_ERR_CAP_FEP
(
x
Ë((xË& 31Ë

	)

714 
	#PCI_ERR_CAP_ECRC_GENC
 0x00000020

	)

715 
	#PCI_ERR_CAP_ECRC_GENE
 0x00000040

	)

716 
	#PCI_ERR_CAP_ECRC_CHKC
 0x00000080

	)

717 
	#PCI_ERR_CAP_ECRC_CHKE
 0x00000100

	)

718 
	#PCI_ERR_HEADER_LOG
 28

	)

719 
	#PCI_ERR_ROOT_COMMAND
 44

	)

721 
	#PCI_ERR_ROOT_CMD_COR_EN
 0x00000001

	)

723 
	#PCI_ERR_ROOT_CMD_NONFATAL_EN
 0x00000002

	)

725 
	#PCI_ERR_ROOT_CMD_FATAL_EN
 0x00000004

	)

726 
	#PCI_ERR_ROOT_STATUS
 48

	)

727 
	#PCI_ERR_ROOT_COR_RCV
 0x00000001

	)

729 
	#PCI_ERR_ROOT_MULTI_COR_RCV
 0x00000002

	)

731 
	#PCI_ERR_ROOT_UNCOR_RCV
 0x00000004

	)

733 
	#PCI_ERR_ROOT_MULTI_UNCOR_RCV
 0x00000008

	)

734 
	#PCI_ERR_ROOT_FIRST_FATAL
 0x00000010

	)

735 
	#PCI_ERR_ROOT_NONFATAL_RCV
 0x00000020

	)

736 
	#PCI_ERR_ROOT_FATAL_RCV
 0x00000040

	)

737 
	#PCI_ERR_ROOT_ERR_SRC
 52

	)

740 
	#PCI_VC_PORT_CAP1
 4

	)

741 
	#PCI_VC_CAP1_EVCC
 0x00000007

	)

742 
	#PCI_VC_CAP1_LPEVCC
 0x00000070

	)

743 
	#PCI_VC_CAP1_ARB_SIZE
 0x00000c00

	)

744 
	#PCI_VC_PORT_CAP2
 8

	)

745 
	#PCI_VC_CAP2_32_PHASE
 0x00000002

	)

746 
	#PCI_VC_CAP2_64_PHASE
 0x00000004

	)

747 
	#PCI_VC_CAP2_128_PHASE
 0x00000008

	)

748 
	#PCI_VC_CAP2_ARB_OFF
 0xff000000

	)

749 
	#PCI_VC_PORT_CTRL
 12

	)

750 
	#PCI_VC_PORT_CTRL_LOAD_TABLE
 0x00000001

	)

751 
	#PCI_VC_PORT_STATUS
 14

	)

752 
	#PCI_VC_PORT_STATUS_TABLE
 0x00000001

	)

753 
	#PCI_VC_RES_CAP
 16

	)

754 
	#PCI_VC_RES_CAP_32_PHASE
 0x00000002

	)

755 
	#PCI_VC_RES_CAP_64_PHASE
 0x00000004

	)

756 
	#PCI_VC_RES_CAP_128_PHASE
 0x00000008

	)

757 
	#PCI_VC_RES_CAP_128_PHASE_TB
 0x00000010

	)

758 
	#PCI_VC_RES_CAP_256_PHASE
 0x00000020

	)

759 
	#PCI_VC_RES_CAP_ARB_OFF
 0xff000000

	)

760 
	#PCI_VC_RES_CTRL
 20

	)

761 
	#PCI_VC_RES_CTRL_LOAD_TABLE
 0x00010000

	)

762 
	#PCI_VC_RES_CTRL_ARB_SELECT
 0x000e0000

	)

763 
	#PCI_VC_RES_CTRL_ID
 0x07000000

	)

764 
	#PCI_VC_RES_CTRL_ENABLE
 0x80000000

	)

765 
	#PCI_VC_RES_STATUS
 26

	)

766 
	#PCI_VC_RES_STATUS_TABLE
 0x00000001

	)

767 
	#PCI_VC_RES_STATUS_NEGO
 0x00000002

	)

768 
	#PCI_CAP_VC_BASE_SIZEOF
 0x10

	)

769 
	#PCI_CAP_VC_PER_VC_SIZEOF
 0x0C

	)

772 
	#PCI_PWR_DSR
 4

	)

773 
	#PCI_PWR_DATA
 8

	)

774 
	#PCI_PWR_DATA_BASE
(
x
Ë((xË& 0xffË

	)

775 
	#PCI_PWR_DATA_SCALE
(
x
Ë(((xË>> 8Ë& 3Ë

	)

776 
	#PCI_PWR_DATA_PM_SUB
(
x
Ë(((xË>> 10Ë& 7Ë

	)

777 
	#PCI_PWR_DATA_PM_STATE
(
x
Ë(((xË>> 13Ë& 3Ë

	)

778 
	#PCI_PWR_DATA_TYPE
(
x
Ë(((xË>> 15Ë& 7Ë

	)

779 
	#PCI_PWR_DATA_RAIL
(
x
Ë(((xË>> 18Ë& 7Ë

	)

780 
	#PCI_PWR_CAP
 12

	)

781 
	#PCI_PWR_CAP_BUDGET
(
x
Ë((xË& 1Ë

	)

782 
	#PCI_EXT_CAP_PWR_SIZEOF
 16

	)

785 
	#PCI_VNDR_HEADER
 4

	)

786 
	#PCI_VNDR_HEADER_ID
(
x
Ë((xË& 0xffff)

	)

787 
	#PCI_VNDR_HEADER_REV
(
x
Ë(((xË>> 16Ë& 0xf)

	)

788 
	#PCI_VNDR_HEADER_LEN
(
x
Ë(((xË>> 20Ë& 0xfff)

	)

798 
	#HT_3BIT_CAP_MASK
 0xE0

	)

799 
	#HT_CAPTYPE_SLAVE
 0x00

	)

800 
	#HT_CAPTYPE_HOST
 0x20

	)

802 
	#HT_5BIT_CAP_MASK
 0xF8

	)

803 
	#HT_CAPTYPE_IRQ
 0x80

	)

804 
	#HT_CAPTYPE_REMAPPING_40
 0xA0

	)

805 
	#HT_CAPTYPE_REMAPPING_64
 0xA2

	)

806 
	#HT_CAPTYPE_UNITID_CLUMP
 0x90

	)

807 
	#HT_CAPTYPE_EXTCONF
 0x98

	)

808 
	#HT_CAPTYPE_MSI_MAPPING
 0xA8

	)

809 
	#HT_MSI_FLAGS
 0x02

	)

810 
	#HT_MSI_FLAGS_ENABLE
 0x1

	)

811 
	#HT_MSI_FLAGS_FIXED
 0x2

	)

812 
	#HT_MSI_FIXED_ADDR
 0x00000000FEE00000ULL

	)

813 
	#HT_MSI_ADDR_LO
 0x04

	)

814 
	#HT_MSI_ADDR_LO_MASK
 0xFFF00000

	)

815 
	#HT_MSI_ADDR_HI
 0x08

	)

816 
	#HT_CAPTYPE_DIRECT_ROUTE
 0xB0

	)

817 
	#HT_CAPTYPE_VCSET
 0xB8

	)

818 
	#HT_CAPTYPE_ERROR_RETRY
 0xC0

	)

819 
	#HT_CAPTYPE_GEN3
 0xD0

	)

820 
	#HT_CAPTYPE_PM
 0xE0

	)

821 
	#HT_CAP_SIZEOF_LONG
 28

	)

822 
	#HT_CAP_SIZEOF_SHORT
 24

	)

825 
	#PCI_ARI_CAP
 0x04

	)

826 
	#PCI_ARI_CAP_MFVC
 0x0001

	)

827 
	#PCI_ARI_CAP_ACS
 0x0002

	)

828 
	#PCI_ARI_CAP_NFN
(
x
Ë(((xË>> 8Ë& 0xffË

	)

829 
	#PCI_ARI_CTRL
 0x06

	)

830 
	#PCI_ARI_CTRL_MFVC
 0x0001

	)

831 
	#PCI_ARI_CTRL_ACS
 0x0002

	)

832 
	#PCI_ARI_CTRL_FG
(
x
Ë(((xË>> 4Ë& 7Ë

	)

833 
	#PCI_EXT_CAP_ARI_SIZEOF
 8

	)

836 
	#PCI_ATS_CAP
 0x04

	)

837 
	#PCI_ATS_CAP_QDEP
(
x
Ë((xË& 0x1fË

	)

838 
	#PCI_ATS_MAX_QDEP
 32

	)

839 
	#PCI_ATS_CTRL
 0x06

	)

840 
	#PCI_ATS_CTRL_ENABLE
 0x8000

	)

841 
	#PCI_ATS_CTRL_STU
(
x
Ë((xË& 0x1fË

	)

842 
	#PCI_ATS_MIN_STU
 12

	)

843 
	#PCI_EXT_CAP_ATS_SIZEOF
 8

	)

846 
	#PCI_PRI_CTRL
 0x04

	)

847 
	#PCI_PRI_CTRL_ENABLE
 0x01

	)

848 
	#PCI_PRI_CTRL_RESET
 0x02

	)

849 
	#PCI_PRI_STATUS
 0x06

	)

850 
	#PCI_PRI_STATUS_RF
 0x001

	)

851 
	#PCI_PRI_STATUS_UPRGI
 0x002

	)

852 
	#PCI_PRI_STATUS_STOPPED
 0x100

	)

853 
	#PCI_PRI_MAX_REQ
 0x08

	)

854 
	#PCI_PRI_ALLOC_REQ
 0x0¯

	)

855 
	#PCI_EXT_CAP_PRI_SIZEOF
 16

	)

858 
	#PCI_PASID_CAP
 0x04

	)

859 
	#PCI_PASID_CAP_EXEC
 0x02

	)

860 
	#PCI_PASID_CAP_PRIV
 0x04

	)

861 
	#PCI_PASID_CTRL
 0x06

	)

862 
	#PCI_PASID_CTRL_ENABLE
 0x01

	)

863 
	#PCI_PASID_CTRL_EXEC
 0x02

	)

864 
	#PCI_PASID_CTRL_PRIV
 0x04

	)

865 
	#PCI_EXT_CAP_PASID_SIZEOF
 8

	)

868 
	#PCI_SRIOV_CAP
 0x04

	)

869 
	#PCI_SRIOV_CAP_VFM
 0x01

	)

870 
	#PCI_SRIOV_CAP_INTR
(
x
Ë((xË>> 21Ë

	)

871 
	#PCI_SRIOV_CTRL
 0x08

	)

872 
	#PCI_SRIOV_CTRL_VFE
 0x01

	)

873 
	#PCI_SRIOV_CTRL_VFM
 0x02

	)

874 
	#PCI_SRIOV_CTRL_INTR
 0x04

	)

875 
	#PCI_SRIOV_CTRL_MSE
 0x08

	)

876 
	#PCI_SRIOV_CTRL_ARI
 0x10

	)

877 
	#PCI_SRIOV_STATUS
 0x0®

	)

878 
	#PCI_SRIOV_STATUS_VFM
 0x01

	)

879 
	#PCI_SRIOV_INITIAL_VF
 0x0¯

	)

880 
	#PCI_SRIOV_TOTAL_VF
 0x0ê

	)

881 
	#PCI_SRIOV_NUM_VF
 0x10

	)

882 
	#PCI_SRIOV_FUNC_LINK
 0x12

	)

883 
	#PCI_SRIOV_VF_OFFSET
 0x14

	)

884 
	#PCI_SRIOV_VF_STRIDE
 0x16

	)

885 
	#PCI_SRIOV_VF_DID
 0x1®

	)

886 
	#PCI_SRIOV_SUP_PGSIZE
 0x1¯

	)

887 
	#PCI_SRIOV_SYS_PGSIZE
 0x20

	)

888 
	#PCI_SRIOV_BAR
 0x24

	)

889 
	#PCI_SRIOV_NUM_BARS
 6

	)

890 
	#PCI_SRIOV_VFM
 0x3¯

	)

891 
	#PCI_SRIOV_VFM_BIR
(
x
Ë((xË& 7Ë

	)

892 
	#PCI_SRIOV_VFM_OFFSET
(
x
Ë((xË& ~7Ë

	)

893 
	#PCI_SRIOV_VFM_UA
 0x0

	)

894 
	#PCI_SRIOV_VFM_MI
 0x1

	)

895 
	#PCI_SRIOV_VFM_MO
 0x2

	)

896 
	#PCI_SRIOV_VFM_AV
 0x3

	)

897 
	#PCI_EXT_CAP_SRIOV_SIZEOF
 64

	)

899 
	#PCI_LTR_MAX_SNOOP_LAT
 0x4

	)

900 
	#PCI_LTR_MAX_NOSNOOP_LAT
 0x6

	)

901 
	#PCI_LTR_VALUE_MASK
 0x000003ff

	)

902 
	#PCI_LTR_SCALE_MASK
 0x00001c00

	)

903 
	#PCI_LTR_SCALE_SHIFT
 10

	)

904 
	#PCI_EXT_CAP_LTR_SIZEOF
 8

	)

907 
	#PCI_ACS_CAP
 0x04

	)

908 
	#PCI_ACS_SV
 0x01

	)

909 
	#PCI_ACS_TB
 0x02

	)

910 
	#PCI_ACS_RR
 0x04

	)

911 
	#PCI_ACS_CR
 0x08

	)

912 
	#PCI_ACS_UF
 0x10

	)

913 
	#PCI_ACS_EC
 0x20

	)

914 
	#PCI_ACS_DT
 0x40

	)

915 
	#PCI_ACS_EGRESS_BITS
 0x05

	)

916 
	#PCI_ACS_CTRL
 0x06

	)

917 
	#PCI_ACS_EGRESS_CTL_V
 0x08

	)

919 
	#PCI_VSEC_HDR
 4

	)

920 
	#PCI_VSEC_HDR_LEN_SHIFT
 20

	)

923 
	#PCI_SATA_REGS
 4

	)

924 
	#PCI_SATA_REGS_MASK
 0xF

	)

925 
	#PCI_SATA_REGS_INLINE
 0xF

	)

926 
	#PCI_SATA_SIZEOF_SHORT
 8

	)

927 
	#PCI_SATA_SIZEOF_LONG
 16

	)

930 
	#PCI_REBAR_CTRL
 8

	)

931 
	#PCI_REBAR_CTRL_NBAR_MASK
 (7 << 5Ë

	)

932 
	#PCI_REBAR_CTRL_NBAR_SHIFT
 5

	)

935 
	#PCI_DPA_CAP
 4

	)

936 
	#PCI_DPA_CAP_SUBSTATE_MASK
 0x1F

	)

937 
	#PCI_DPA_BASE_SIZEOF
 16

	)

940 
	#PCI_TPH_CAP
 4

	)

941 
	#PCI_TPH_CAP_LOC_MASK
 0x600

	)

942 
	#PCI_TPH_LOC_NONE
 0x000

	)

943 
	#PCI_TPH_LOC_CAP
 0x200

	)

944 
	#PCI_TPH_LOC_MSIX
 0x400

	)

945 
	#PCI_TPH_CAP_ST_MASK
 0x07FF0000

	)

946 
	#PCI_TPH_CAP_ST_SHIFT
 16

	)

947 
	#PCI_TPH_BASE_SIZEOF
 12

	)

	@/usr/include/linux/posix_types.h

1 #i‚de‡
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<löux/°ddef.h
>

21 #unde‡
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__kî√l_fd_£t
;

29 (*
	t__kî√l_sigh™dÀr_t
)();

32 
	t__kî√l_key_t
;

33 
	t__kî√l_mqd_t
;

35 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/socket.h

1 #i‚de‡
_LINUX_SOCKET_H


2 
	#_LINUX_SOCKET_H


	)

7 
	#_K_SS_MAXSIZE
 128

	)

8 
	#_K_SS_ALIGNSIZE
 (
	`__Æignof__
 (
sockaddr
 *))

	)

11 
	t__kî√l_ß_Ámûy_t
;

13 
	s__kî√l_sockaddr_°‹age
 {

14 
__kî√l_ß_Ámûy_t
 
	mss_Ámûy
;

16 
	m__d©a
[
_K_SS_MAXSIZE
 - ()];

19 } 
__©åibuã__
 ((
Æig√d
(
_K_SS_ALIGNSIZE
)));

	@/usr/include/linux/sysinfo.h

1 #i‚de‡
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<löux/ty≥s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysöfo
 {

8 
__kî√l_l⁄g_t
 
	mu±ime
;

9 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

10 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

11 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

12 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

13 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

14 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

15 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

16 
__u16
 
	m¥ocs
;

17 
__u16
 
	m∑d
;

18 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

19 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

20 
__u32
 
	mmem_unô
;

21 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

35 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

43 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

46 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

47 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

65 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

69 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

74 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

77 #ifde‡
__OPTIMIZE__


78 
__exã∫_Æways_ölöe
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


81  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

84 
__exã∫_Æways_ölöe
 const *

85 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


87  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifde‡
__USE_GNU


100 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

103 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

106 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

107 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

114 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

117 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

126 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

128 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

129 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

136 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

137 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

143 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

150 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

151 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

152 
__THROW
 
	`__n⁄nuŒ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifde‡
__USE_XOPEN2K8


159 
	~<xloˇÀ.h
>

162 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

163 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

165 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

166 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

169 #i‡
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8


171 *
	$°rdup
 (c⁄° *
__s
)

172 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

178 #i‡
deföed
 
__USE_XOPEN2K8


179 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

180 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


185 
	#°rdu∑
(
s
) \

186 (
__exãnsi⁄__
 \

188 c⁄° *
__ﬁd
 = (
s
); \

189 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

190 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

191 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

192 
	}
}))

	)

195 
	#°∫du∑
(
s
, 
n
) \

196 (
__exãnsi⁄__
 \

198 c⁄° *
__ﬁd
 = (
s
); \

199 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

200 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

201 
__√w
[
__Àn
] = '\0'; \

202 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
°rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

213 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

216 #ifde‡
__OPTIMIZE__


217 
__exã∫_Æways_ölöe
 *

218 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


220  
__buûtö_°rchr
 (
__s
, 
__c
);

223 
__exã∫_Æways_ölöe
 const *

224 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


226  
__buûtö_°rchr
 (
__s
, 
__c
);

231 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

232 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`°ºchr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

243 #ifde‡
__OPTIMIZE__


244 
__exã∫_Æways_ölöe
 *

245 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


247  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

250 
__exã∫_Æways_ölöe
 const *

251 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


253  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

259 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifde‡
__USE_GNU


266 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

269 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

272 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

273 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

281 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

284 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

285 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

287 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

291 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

293 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

295 #ifde‡
__OPTIMIZE__


296 
__exã∫_Æways_ölöe
 *

297 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


299  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

302 
__exã∫_Æways_ölöe
 const *

303 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


305  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

308 
	}
}

310 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

311 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

314 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

318 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

320 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

322 #ifde‡
__OPTIMIZE__


323 
__exã∫_Æways_ölöe
 *

324 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


326  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

329 
__exã∫_Æways_ölöe
 const *

330 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


332  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

335 
	}
}

337 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

338 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

343 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

350 c⁄° *
__ª°ri˘
 
__dñim
,

351 **
__ª°ri˘
 
__ßve_±r
)

352 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

353 #ifde‡
__USE_POSIX


354 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

355 **
__ª°ri˘
 
__ßve_±r
)

356 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

359 #ifde‡
__USE_GNU


361 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

363 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

364 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

365 c⁄° *
__√edÀ
)

366 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

368 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

369 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 #ifde‡
__USE_GNU


377 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

378 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

379 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

383 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

384 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

385 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

386 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

387 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

388 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$°æí
 (c⁄° *
__s
)

395 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

402 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifde‡
__USE_XOPEN2K


418 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


421 #ifde‡
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

423 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

424 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

426 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

427 
__THROW
 
	`__n⁄nuŒ
 ((2));

428 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

433 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

434 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

438 #ifde‡
__USE_XOPEN2K8


440 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

446 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

448 #ifde‡
__USE_MISC


450 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

454 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

457 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

461 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`ödex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

466 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

469 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__exã∫_Æways_ölöe
 *

471 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


473  
	`__buûtö_ödex
 (
__s
, 
__c
);

476 
__exã∫_Æways_ölöe
 const *

477 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


479  
	`__buûtö_ödex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$ödex
 (c⁄° *
__s
, 
__c
)

485 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

489 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`rödex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

494 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

497 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__exã∫_Æways_ölöe
 *

499 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


501  
	`__buûtö_rödex
 (
__s
, 
__c
);

504 
__exã∫_Æways_ölöe
 const *

505 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


507  
	`__buûtö_rödex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$rödex
 (c⁄° *
__s
, 
__c
)

513 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

518 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

522 #ifdef 
__USE_GNU


523 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

524 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

525 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

529 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

530 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

533 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

541 
__loˇÀ_t
 
__loc
)

542 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

544 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

545 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

546 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

553 c⁄° *
__ª°ri˘
 
__dñim
)

554 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

562 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

563 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

564 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

565 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

569 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

570 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

571 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

572 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

573 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

574 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

580 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

583 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

586 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

588 #i‚de‡
ba£«me


593 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£«me
 (*
__fûíame
)

595 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

596 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

597 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

599 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

605 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

606 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

607 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


627 
	~<bôs/°rög.h
>

630 
	~<bôs/°rög2.h
>

633 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


635 
	~<bôs/°rög3.h
>

639 #i‡
deföed
 
__USE_GNU
 && deföed 
__OPTIMIZE__
 \

640 && 
deföed
 
__exã∫_Æways_ölöe
 && 
	$__GNUC_PREREQ
 (3,2)

641 #i‡!
deföed
 
_FORCE_INLINES
 && !deföed 
_HAVE_STRING_ARCH_memp˝y


643 #unde‡
memp˝y


644 #unde‡
__memp˝y


645 
	#memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

646 
	#__memp˝y
(
de°
, 
§c
, 
n
Ë
	`__memp˝y_ölöe
 (de°, src,Ç)

	)

648 
__exã∫_Æways_ölöe
 *

649 
	$__memp˝y_ölöe
 (*
__ª°ri˘
 
__de°
,

650 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

652  (*Ë
	`mem˝y
 (
__de°
, 
__§c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #unde‡
__USE_ISOC11


98 #unde‡
__USE_ISOC99


99 #unde‡
__USE_ISOC95


100 #unde‡
__USE_ISOCXX11


101 #unde‡
__USE_POSIX


102 #unde‡
__USE_POSIX2


103 #unde‡
__USE_POSIX199309


104 #unde‡
__USE_POSIX199506


105 #unde‡
__USE_XOPEN


106 #unde‡
__USE_XOPEN_EXTENDED


107 #unde‡
__USE_UNIX98


108 #unde‡
__USE_XOPEN2K


109 #unde‡
__USE_XOPEN2KXSI


110 #unde‡
__USE_XOPEN2K8


111 #unde‡
__USE_XOPEN2K8XSI


112 #unde‡
__USE_LARGEFILE


113 #unde‡
__USE_LARGEFILE64


114 #unde‡
__USE_FILE_OFFSET64


115 #unde‡
__USE_MISC


116 #unde‡
__USE_ATFILE


117 #unde‡
__USE_GNU


118 #unde‡
__USE_REENTRANT


119 #unde‡
__USE_FORTIFY_LEVEL


120 #unde‡
__KERNEL_STRICT_NAMES


124 #i‚de‡
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

137 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

146 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

147 && !
deföed
 
	g_DEFAULT_SOURCE


152 #unde‡
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifde‡
_GNU_SOURCE


158 #unde‡
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #unde‡
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #unde‡
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #unde‡
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #unde‡
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #unde‡
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #unde‡
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #unde‡
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #unde‡
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #unde‡
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

183 || (!
deföed
 
	g__STRICT_ANSI__
 \

184 && !
deföed
 
	g_ISOC99_SOURCE
 \

185 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

186 && !
deföed
 
	g_XOPEN_SOURCE
))

187 #unde‡
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #i‡(
deföed
 
_ISOC11_SOURCE
 \

193 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

199 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

205 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

214 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifde‡
_DEFAULT_SOURCE


222 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #unde‡
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #unde‡
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #i‡((!
deföed
 
__STRICT_ANSI__
 \

231 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #i‡(
deföed
 
_POSIX_SOURCE
 \

247 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
deföed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #unde‡
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #unde‡
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #unde‡
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #unde‡
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

286 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #unde‡
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #unde‡
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifde‡
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifde‡
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifde‡
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #i‡
deföed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #i‡
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<°dc-¥edef.h
>

353 #unde‡
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

362 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

365 #i‚de‡
__ASSEMBLER__


366 #i‚de‡
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

381 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

382 && 
deföed
 
	g__exã∫_ölöe


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/°ubs.h
>

	@/usr/include/linux/stddef.h

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
34
662
core.c
fabrics.c
fabrics.h
fault_inject.c
fc.c
lightnvm.c
multipath.c
nvme-core.mod.c
nvme.h
nvme.mod.c
pci.c
rdma.c
tcp.c
trace.c
trace.h
/usr/include/linux/errno.h
/usr/include/linux/hdreg.h
/usr/include/linux/in.h
/usr/include/linux/kernel.h
/usr/include/linux/nvme_ioctl.h
/usr/include/linux/pci.h
/usr/include/linux/ptrace.h
/usr/include/linux/string.h
/usr/include/linux/types.h
/usr/include/linux/libc-compat.h
/usr/include/linux/pci_regs.h
/usr/include/linux/posix_types.h
/usr/include/linux/socket.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/features.h
/usr/include/linux/stddef.h
/usr/include/xlocale.h
/usr/include/stdc-predef.h
